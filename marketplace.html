<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>South Traders</title>
  
  <!-- Material Design CSS -->
  <link href="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { 
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; 
      color-scheme: dark;
      --mdc-theme-primary: #4CAF50;
      --mdc-theme-secondary: #2a2a33;
      --mdc-theme-surface: #1e1e24;
      --mdc-theme-background: #0f0f10;
      --mdc-theme-on-primary: #ffffff;
      --mdc-theme-on-secondary: #ffffff;
      --mdc-theme-on-surface: #f1f1f1;
      --mdc-theme-on-background: #f1f1f1;
    }
    
    /* Material Design custom overrides for better visibility */
    .mdc-tab {
      color: #d0d0d0 !important; /* Color más claro para tabs no seleccionados */
      background-color: #1b1b1f !important;
      border-radius: 6px 6px 0 0 !important;
      border: 1px solid #2a2a2a !important;
      border-bottom: none !important;
      margin-right: 4px !important;
    }
    
    .mdc-tab--active {
      color: #ffffff !important; /* Color para tab seleccionado */
      background-color: #23232a !important;
      font-weight: 600 !important;
    }
    
    .mdc-tab:hover:not(.mdc-tab--active) {
      color: #e8e8e8 !important; /* Color en hover para mejor visibilidad */
      background-color: #2a2a2f !important;
    }
    
    .mdc-tab-indicator__content--underline {
      border-color: #4CAF50 !important;
      border-width: 3px !important;
    }
    
    /* Fix for all text elements that might appear black */
    .mdc-tab__text-label,
    .mdc-button__label,
    .mdc-floating-label,
    .mdc-text-field__input,
    .mdc-form-field > label,
    .mdc-checkbox ~ label,
    span, p, div, h1, h2, h3, h4, h5, h6 {
      color: inherit !important;
    }
    
    /* Specific overrides for Material components */
    .mdc-tab__text-label {
      color: inherit !important;
    }
    
    .mdc-button__label {
      color: inherit !important;
    }
    
    /* Text field improvements */
    .mdc-text-field--outlined {
      background-color: #1b1b1f !important;
      box-shadow: none !important; /* Eliminar cualquier sombra por defecto */
    }
    
    .mdc-text-field--outlined .mdc-notched-outline__leading,
    .mdc-text-field--outlined .mdc-notched-outline__notch,
    .mdc-text-field--outlined .mdc-notched-outline__trailing {
      border-color: #3a3a44 !important;
    }
    
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__leading,
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__notch,
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__trailing {
      border-color: #4CAF50 !important;
    }
    
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__leading,
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__notch,
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__trailing {
      border-color: #4CAF50 !important;
      border-width: 2px !important;
    }
    
    .mdc-text-field__input {
      color: #f1f1f1 !important;
    }
    
    .mdc-floating-label {
      color: #d0d0d0 !important; /* Gris más claro */
    }
    
    .mdc-text-field--focused .mdc-floating-label {
      color: #4CAF50 !important;
    }
    
    /* Button improvements */
    .mdc-button {
      color: #f1f1f1 !important;
    }
    
    .mdc-button--raised {
      background-color: #4CAF50 !important;
      color: #ffffff !important;
    }
    
    .mdc-button--outlined {
      border-color: #3a3a44 !important;
      color: #f1f1f1 !important;
    }
    
    .mdc-button--outlined:hover {
      background-color: #2a2a33 !important;
      border-color: #4CAF50 !important;
    }
    
    /* Checkbox improvements */
    .mdc-checkbox__native-control:enabled:checked ~ .mdc-checkbox__background {
      background-color: #4CAF50 !important;
      border-color: #4CAF50 !important;
    }
    
    .mdc-checkbox__background {
      border-color: #3a3a44 !important;
    }
    
    .mdc-form-field > label {
      color: #f1f1f1 !important;
    }
    
    /* General text color fixes */
    .status {
      color: #d0d0d0 !important;
    }
    
    /* Toolbar spacing fix */
    .toolbar {
      align-items: center !important;
      gap: 12px !important;
    }
    
    /* Search field specific styling - match button size */
    .toolbar .search-field {
      width: 160px !important; /* Ancho similar a botones */
      height: 36px !important; /* Misma altura que botones MDC */
      box-shadow: none !important; /* Eliminar sombra */
      background: transparent !important; /* Fondo transparente */
      margin: 0 !important; /* Eliminar márgenes extra */
      align-self: center !important; /* Centrar verticalmente */
    }

    .toolbar .search-field .mdc-text-field__input {
      height: 34px !important; /* Ajustar altura del input para coincidir */
      padding-top: 8px !important;
      padding-bottom: 8px !important;
      box-shadow: none !important; /* Eliminar sombra del input */
      background: transparent !important; /* Fondo transparente */
      line-height: 18px !important; /* Centrar texto verticalmente */
    }

    .toolbar .search-field .mdc-notched-outline__leading,
    .toolbar .search-field .mdc-notched-outline__notch,
    .toolbar .search-field .mdc-notched-outline__trailing {
      height: 36px !important; /* Misma altura que el contenedor */
      box-shadow: none !important; /* Eliminar sombra del borde */
    }
    
    .toolbar .search-field .mdc-floating-label {
      top: 50% !important;
      transform: translateY(-50%) !important;
    }
    
    .toolbar .search-field .mdc-floating-label--float-above {
      transform: translateY(-106%) scale(0.75) !important;
    }
    
    /* Remove any elevation/shadow from text field */
    .toolbar .search-field::before,
    .toolbar .search-field::after {
      display: none !important;
    }
    
    .toolbar .search-field .mdc-text-field__ripple {
      display: none !important;
    }
    
    /* Additional shadow removal for all Material Design states */
    .toolbar .search-field,
    .toolbar .search-field.mdc-text-field--focused,
    .toolbar .search-field.mdc-text-field--outlined,
    .toolbar .search-field.mdc-text-field--outlined.mdc-text-field--focused {
      box-shadow: none !important;
      -webkit-box-shadow: none !important;
      -moz-box-shadow: none !important;
      background: #1b1b1f !important; /* Fondo sólido en lugar de transparente */
    }
    
    /* Prevent any black text */
    * {
      color: inherit;
    }
    
    /* Ensure all Material Design components inherit proper colors */
    .mdc-tab *, 
    .mdc-button *, 
    .mdc-text-field *, 
    .mdc-checkbox *,
    .mdc-form-field * {
      color: inherit !important;
    }
    
    body { margin: 0; padding: 0; background: #0f0f10; color: #f1f1f1; width: 100%; max-width: 100%; overflow-x: hidden; }
    header { padding: 16px; border-bottom: 1px solid #2a2a2a; background: #121214; display: flex; align-items: center; justify-content: center; gap: 12px; position: relative; }
    .header-logo { height: auto; max-width: 150px; width: 100%; object-fit: contain; position: absolute; left: 16px; }
    h1 { margin: 0; font-size: 20px; color: #fafafa; }
    .header-stats {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .header-stat-card {
      text-align: center;
      padding: 12px 20px;
      background: #15151a;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
      min-width: 120px;
    }

    .header-stat-number {
      font-size: 1.8em;
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 4px;
    }

    .header-stat-label {
      font-size: 0.85em;
      color: #b5b5b5;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    .container { padding: 16px; width: 100%; box-sizing: border-box; }
    .tabs { display: flex; gap: 8px; border-bottom: 1px solid #2a2a2a; margin-bottom: 12px; }
    .tab { padding: 8px 12px; cursor: pointer; border: 1px solid #2a2a2a; border-bottom: none; border-radius: 6px 6px 0 0; background: #1b1b1f; color: #e6e6e6; }
    .tab.active { background: #23232a; font-weight: 600; color: #ffffff; }
    .toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; position: relative; flex-wrap: wrap; width: 100%; box-sizing: border-box; }
    .toolbar button { padding: 6px 10px; cursor: pointer; background: #2a2a33; color: #f0f0f0; border: 1px solid #3a3a44; border-radius: 4px; }
    .status { font-size: 12px; color: #b5b5b5; }
    table { width: 100%; border-collapse: collapse; color: #f0f0f0; table-layout: fixed; }
    th, td { padding: 8px; border-bottom: 1px solid #2a2a2a; text-align: left; }
    th { background: #1e1e24; position: sticky; top: 0; color: #ffffff; }
    .right { text-align: right; }
    .error { color: #ff6b6b; font-size: 13px; }
    .hidden { display: none; }
    tr:nth-child(even) td { background: #15151a; }
    tr:nth-child(odd) td { background: #101015; }
    .zero-value {
      color: #ff6b6b !important;
      font-weight: 500;
    }
    th.sortable {
      cursor: pointer;
    }
    th.sortable:hover {
      background-color: #2a2a33;
    }
    .toolbar input[type="text"] {
      padding: 6px 10px;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      background: #1b1b1f;
      color: #f0f0f0;
    }
    #buyNowBtn {
      background-color: #f44336; /* Red */
      color: white;
      border-radius: 4px;
      padding: 6px 10px;
    }
    #buyNowBtn:hover {
      background-color: #da190b;
    }
    #exportBtn {
      background-color: #4CAF50; /* Green */
      color: white;
      border: 1px solid #4CAF50;
    }
    #exportBtn:hover {
      background-color: #45a049;
    }
    .buy-input {
      width: 40px; /* Adjust as needed */
      text-align: center;
    }
    #columnFilterDropdown {
      background-color: #1b1b1f;
      border: 1px solid #2a2a2a;
      padding: 10px;
      z-index: 100;
      margin-top: 8px; /* Added to position below the button */
      display: none;
      flex-direction: column;
      gap: 5px;
      border-radius: 4px;
    }
    #columnFilterDropdown:not(.hidden) {
      display: flex;
    }
    #columnFilterDropdown label {
      color: #f0f0f0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #columnFilterDropdown input[type="checkbox"] {
      accent-color: #2a2a33;
    }
    .cart-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 4px;
      border: 1px solid #3a3a44;
      background: #2a2a33;
      color: #f1f1f1;
      cursor: pointer;
    }
    .cart-btn:hover {
      background: #34343c;
    }
    .cart-badge {
      display: inline-block;
      min-width: 18px;
      padding: 0 6px;
      margin-left: 8px;
      border-radius: 10px;
      background: #4CAF50;
      color: white;
      font-size: 12px;
      text-align: center;
    }
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      display: none; /* Changed from flex to none */
      align-items: center;
      justify-content: center;
    }
    .modal:not(.hidden) {
      display: flex;
    }
    .modal-content {
      background-color: #1e1e24;
      margin: auto;
      padding: 20px;
      border: 1px solid #2a2a2a;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      border-radius: 8px;
      position: relative;
      color: #f1f1f1;
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        max-width: 95%;
        padding: 15px;
        max-height: 95vh;
      }
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 20px;
      cursor: pointer;
    }
    .close-button:hover,
    .close-button:focus {
      color: #f1f1f1;
      text-decoration: none;
      cursor: pointer;
    }
    #modalSummaryContent {
      margin-top: 20px;
      white-space: pre-wrap; /* Preserve newlines */
      font-family: monospace;
    }
    .modal-total {
      margin-top: 20px;
      font-weight: bold;
      font-size: 1.2em;
      text-align: right;
    }

    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }
      h1 {
        font-size: 18px;
      }
      .container {
        padding: 8px;
      }
      .header {
        padding: 12px;
      }
      .tab {
        padding: 6px 8px;
      }
      .toolbar {
        flex-wrap: wrap;
      }
      th, td {
        padding: 4px;
        font-size: 12px;
      }

      /* Tabs verticales en móviles */
      .mdc-tab-bar {
        max-width: 200px !important;
      }

      .mdc-tab-scroller__scroll-area {
        overflow-x: hidden !important;
      }

      .mdc-tab-scroller__scroll-content {
        display: flex !important;
        flex-direction: column !important;
        gap: 8px !important;
        align-items: flex-start !important;
      }

      .mdc-tab {
        border-radius: 6px !important;
        margin-right: 0 !important;
        width: 200px !important;
        min-width: 200px !important;
        justify-content: flex-start !important;
        text-align: left !important;
        border-bottom: 1px solid #2a2a2a !important;
      }

      .mdc-tab__content {
        justify-content: flex-start !important;
      }

      .mdc-tab-indicator__content--underline {
        border-left-width: 3px !important;
        border-bottom-width: 0 !important;
      }

      .mdc-tab-indicator {
        height: 100% !important;
        width: 3px !important;
        left: 0 !important;
        right: auto !important;
      }
    }

    /* === HAMBURGER MENU === */
    .hamburger-btn {
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      z-index: 1001 !important;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #4CAF50, #45a049) !important;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex !important;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    .hamburger-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }
    
    .hamburger-line {
      width: 20px;
      height: 2px;
      background: white !important;
      border-radius: 1px;
      transition: all 0.3s ease;
      display: block !important;
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(1) {
      transform: rotate(45deg) translate(6px, 6px);
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(2) {
      opacity: 0;
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }
    
    /* === SLIDE MENU === */
    .slide-menu {
      position: fixed !important;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      z-index: 1000 !important;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }
    
    .slide-menu.active {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    
    .slide-menu-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
    }
    
    .slide-menu-content {
      position: absolute;
      top: 0;
      right: 0;
      width: 400px;
      height: 100%;
      background: #1e1e24;
      border-left: 1px solid #3a3a3f;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    
    .slide-menu.active .slide-menu-content {
      transform: translateX(0);
    }
    
    .slide-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #3a3a3f;
    }
    
    .slide-menu-header h3 {
      margin: 0;
      color: #4CAF50;
      font-size: 20px;
    }
    
    .close-menu-btn {
      background: none;
      border: none;
      color: #b5b5b5;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      transition: color 0.3s ease;
    }
    
    .close-menu-btn:hover {
      color: #f1f1f1;
    }
    
    /* === MENU TABS === */
    .menu-sections {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 0;
    }
    
    .menu-btn {
      width: 100%;
      padding: 16px 20px;
      border: none;
      background: #2a2a33;
      color: #f0f0f0;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      margin-bottom: 8px;
      border-radius: 6px;
    }
    
    .menu-btn:hover {
      background: #4CAF50;
      color: white;
      transform: translateX(4px);
    }

    .menu-logout-btn {
      background: #f44336 !important;
      color: white !important;
    }

    .menu-logout-btn:hover {
      background: #d32f2f !important;
    }


    .menu-footer {
      margin-top: auto;
      border-top: 1px solid #3a3a44;
      padding-top: 16px;
    }

    .menu-version {
      text-align: center;
      color: #b5b5b5;
      font-size: 14px;
      cursor: pointer;
      padding: 8px;
      transition: color 0.2s ease;
    }

    .menu-version:hover {
      color: #4CAF50;
    }
    
    
    /* === CONFIG SECTION === */
    .menu-content h4 {
      color: #4CAF50;
      margin: 20px 0 15px 0;
      font-size: 16px;
      border-bottom: 1px solid #3a3a3f;
      padding-bottom: 8px;
    }
    
    .config-group {
      margin-bottom: 20px;
    }
    
    .config-group label {
      display: block;
      color: #f1f1f1;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .config-group input,
    .config-group select {
      width: 100%;
      padding: 12px;
      background: #2a2a2f;
      border: 1px solid #3a3a3f;
      border-radius: 6px;
      color: #f1f1f1;
      font-size: 14px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    
    .config-group input:focus,
    .config-group select:focus {
      outline: none;
      border-color: #4CAF50;
    }
    
    .config-group small {
      color: #b5b5b5;
      font-size: 12px;
      margin-top: 4px;
      display: block;
    }
    
    .refresh-input-group {
      display: flex;
      gap: 10px;
    }
    
    .refresh-input-group input {
      flex: 1;
    }
    
    .refresh-input-group select {
      flex: 1;
    }
    
    .config-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 30px;
    }
    
    .save-config-btn,
    .reset-config-btn,
    .refresh-stats-btn,
    .clear-stats-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .save-config-btn {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
    }
    
    .save-config-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    
    .reset-config-btn {
      background: #6c757d;
      color: white;
    }
    
    .reset-config-btn:hover {
      background: #5a6268;
    }
    
    /* === STATS SECTION === */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .stat-item {
      background: #2a2a2f;
      padding: 15px;
      border-radius: 6px;
      border-left: 3px solid #4CAF50;
    }
    
    .stat-label {
      color: #b5b5b5;
      font-size: 12px;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      color: #f1f1f1;
      font-size: 18px;
      font-weight: 600;
    }
    
    .stats-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .refresh-stats-btn {
      background: linear-gradient(135deg, #2196F3, #1976D2);
      color: white;
    }
    
    .refresh-stats-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }
    
    .clear-stats-btn {
      background: #dc3545;
      color: white;
    }
    
    .clear-stats-btn:hover {
      background: #c82333;
    }

    /* Profile Modal Styles */
    .profile-form {
      max-width: 500px;
      margin: 0 auto;
    }

    .profile-section {
      margin-bottom: 30px;
    }

    .profile-section h3 {
      color: #4CAF50;
      margin-bottom: 20px;
      font-size: 18px;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 8px;
    }

    .profile-field {
      margin-bottom: 20px;
    }

    .profile-field label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 14px;
    }

    .profile-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .profile-input:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .profile-textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    .profile-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 30px 0 20px 0;
    }

    .profile-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .profile-save-btn {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
    }

    .profile-save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .profile-clear-btn {
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
    }

    .profile-clear-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
    }

    .profile-info {
      background: #2a2a32;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
      margin-top: 20px;
    }

    .profile-info p {
      margin: 8px 0;
      color: #e0e0e0;
    }

    .profile-info small {
      color: #999;
      font-style: italic;
    }

    .btn-icon {
      font-size: 16px;
    }

    /* Responsive Profile */
    @media (max-width: 768px) {
      .profile-form {
        padding: 0 10px;
      }

      .profile-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .profile-btn {
        justify-content: center;
      }
    }

    /* Historial Modal Styles */
    .historial-content {
      max-height: 60vh;
      overflow-y: auto;
    }

    /* Clientes Modal Styles */
    .clientes-header {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .import-excel-btn, .export-excel-btn, .add-client-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .import-excel-btn {
      background: #2196F3;
      color: white;
    }

    .import-excel-btn:hover {
      background: #1976D2;
    }

    .export-excel-btn {
      background: #4CAF50;
      color: white;
    }

    .export-excel-btn:hover {
      background: #45a049;
    }

    .add-client-btn {
      background: #FF9800;
      color: white;
    }

    .add-client-btn:hover {
      background: #F57C00;
    }

    .clientes-content {
      margin-top: 16px;
    }

    .clientes-table-container {
      max-height: 60vh;
      overflow: auto;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
    }

    /* Scrollbar styling for clientes table */
    .clientes-table-container::-webkit-scrollbar {
      width: 14px;
      height: 14px;
    }

    .clientes-table-container::-webkit-scrollbar-track {
      background: #1e1e24;
      border-radius: 6px;
    }

    .clientes-table-container::-webkit-scrollbar-thumb {
      background: #4CAF50;
      border-radius: 6px;
      border: 2px solid #1e1e24;
    }

    .clientes-table-container::-webkit-scrollbar-thumb:hover {
      background: #45a049;
    }

    /* Firefox scrollbar */
    .clientes-table-container {
      scrollbar-width: auto;
      scrollbar-color: #4CAF50 #1e1e24;
    }

    .clientes-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .clientes-table th {
      position: sticky;
      top: 0;
      background: #2a2a33;
      color: #f1f1f1;
      padding: 10px 8px;
      text-align: left;
      border-bottom: 2px solid #4CAF50;
      font-weight: 600;
      white-space: nowrap;
      z-index: 10;
    }

    .clientes-table td {
      padding: 8px;
      border-bottom: 1px solid #2a2a2a;
      color: #f1f1f1;
    }

    .clientes-table tr:hover {
      background: #2a2a33;
    }

    .clientes-table tr:nth-child(even) {
      background: #1b1b1f;
    }

    .edit-client-btn, .delete-client-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      margin-right: 4px;
    }

    .edit-client-btn {
      background: #2196F3;
      color: white;
    }

    .edit-client-btn:hover {
      background: #1976D2;
    }

    .delete-client-btn {
      background: #F44336;
      color: white;
    }

    .delete-client-btn:hover {
      background: #D32F2F;
    }

    @media (max-width: 768px) {
      .clientes-table {
        font-size: 11px;
      }

      .clientes-table th,
      .clientes-table td {
        padding: 6px 4px;
      }
    }

    .historial-header {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: flex-end;
    }

    .clear-historial-btn,
    .export-historial-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .clear-historial-btn {
      background: #f44336;
      color: white;
    }

    .clear-historial-btn:hover {
      background: #d32f2f;
    }

    .export-historial-btn {
      background: #4CAF50;
      color: white;
    }

    .export-historial-btn:hover {
      background: #45a049;
    }

    .historial-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .no-historial {
      text-align: center;
      padding: 40px 20px;
      color: #b5b5b5;
    }

    .no-historial p {
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .no-historial small {
      font-size: 12px;
      color: #888;
    }

    .historial-item {
      background: #2a2a33;
      padding: 8px 12px;
      border-radius: 6px;
      border-left: 3px solid #4CAF50;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 8px;
    }

    .historial-item:hover {
      background: #3a3a44;
      transform: translateX(2px);
    }

    .historial-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .historial-date {
      font-size: 12px;
      color: #b5b5b5;
    }

    .historial-method {
      font-size: 13px;
      font-weight: 600;
      color: #4CAF50;
    }

    .historial-summary {
      font-size: 13px;
      color: #f1f1f1;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .historial-user {
      font-size: 11px;
      color: #9e9e9e;
      margin-bottom: 4px;
    }

    .historial-items-preview {
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid #3a3a44;
      color: #b5b5b5;
      font-size: 11px;
      display: none; /* Hide by default (minimized) */
    }

    .historial-item.expanded .historial-items-preview {
      display: block;
    }

    .historial-items-preview small {
      margin-right: 6px;
    }

    @media (max-width: 768px) {
      .historial-item {
        padding: 6px 10px;
      }

      .historial-summary {
        font-size: 12px;
      }

      .historial-date, .historial-method {
        font-size: 11px;
      }
    }

    .historial-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .historial-date {
      font-size: 12px;
      color: #b5b5b5;
    }

    .historial-method {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      background: #4CAF50;
      color: white;
    }

    .historial-summary {
      font-size: 14px;
      color: #f0f0f0;
    }

    .historial-user {
      font-size: 12px;
      color: #4CAF50;
      margin-top: 4px;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .slide-menu-content {
        width: 100%;
        max-width: 350px;
      }
    }

    /* === TOAST NOTIFICATION === */
    .toast-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-80px);
      z-index: 2000;
      padding: 16px 24px;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border-radius: 8px;
      font-weight: 500;
      box-shadow: 0 8px 32px rgba(76, 175, 80, 0.3);
      opacity: 0;
      transition: all 0.3s ease;
      font-size: 14px;
      max-width: 300px;
      text-align: center;
    }

    .toast-notification.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast-notification.error {
      background: linear-gradient(135deg, #f44336, #d32f2f);
      box-shadow: 0 8px 32px rgba(244, 67, 54, 0.3);
    }

    /* Quantity input styling */
    .qty-input {
      width: 60px !important;
      text-align: center !important;
      padding: 4px 8px !important;
      border: 1px solid #3a3a44 !important;
      border-radius: 4px !important;
      background: #1b1b1f !important;
      color: #f0f0f0 !important;
      font-size: 14px !important;
      font-family: inherit !important;
      transition: border-color 0.2s ease !important;
    }

    .qty-input:focus {
      outline: none !important;
      border-color: #4CAF50 !important;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2) !important;
    }

    .qty-input:hover {
      border-color: #4a4a54 !important;
    }

    /* Remove number input spinners */
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none !important;
      margin: 0 !important;
    }

    .qty-input[type=number] {
      -moz-appearance: textfield !important;
    }

    /* Logistics Modal Styles */
    .logistics-content {
      max-height: 70vh;
      overflow-y: auto;
    }

    .logistics-section {
      margin-bottom: 24px;
      padding: 16px;
      background: #15151a;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
    }

    .logistics-section h4 {
      margin: 0 0 12px 0;
      color: #4CAF50;
      font-size: 16px;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 8px;
    }

    .logistics-orders {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .no-orders {
      color: #b5b5b5;
      font-style: italic;
      text-align: center;
      padding: 20px;
      margin: 0;
    }

    /* Photo Upload Styles */
    .photo-upload-content {
      text-align: center;
      padding: 20px;
    }

    .upload-options {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin: 24px 0;
    }

    .upload-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
    }

    .camera-btn {
      background: #4CAF50;
      color: white;
    }

    .camera-btn:hover {
      background: #45a049;
      transform: translateY(-2px);
    }

    .file-btn {
      background: #2196F3;
      color: white;
    }

    .file-btn:hover {
      background: #1976D2;
      transform: translateY(-2px);
    }

    .photo-preview {
      margin-top: 20px;
      text-align: center;
    }

    .photo-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      border: 2px solid #ddd;
      margin-bottom: 16px;
    }

    .photo-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .upload-confirm-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .upload-confirm-btn:hover {
      background: #45a049;
    }

    .upload-cancel-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .upload-cancel-btn:hover {
      background: #d32f2f;
    }

    .upload-progress {
      margin-top: 20px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: #4CAF50;
      width: 0%;
      transition: width 0.3s ease;
      animation: pulse 1.5s ease-in-out infinite alternate;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      100% { opacity: 1; }
    }

    /* Photo View Styles */
    .photo-view-content {
      text-align: center;
      padding: 20px;
    }

    .photo-view-content img {
      max-width: 100%;
      max-height: 500px;
      border-radius: 8px;
      border: 2px solid #ddd;
      margin-bottom: 16px;
    }

    .photo-info {
      background: #15151a;
      padding: 12px;
      border-radius: 6px;
      color: #b5b5b5;
    }

    .photo-info p {
      margin: 4px 0;
    }

    .order-item {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .order-id {
      font-weight: bold;
      color: #4CAF50;
    }

    .order-actions {
      display: flex;
      gap: 8px;
    }

    .move-order-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .move-order-btn:hover {
      background: #1976D2;
    }

    .view-photo-btn {
      background: #FF9800;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      min-width: auto;
      height: 24px;
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }

    .view-photo-btn:hover {
      background: #F57C00;
    }

    .delivered-status {
      color: #4CAF50;
      font-size: 12px;
      font-weight: bold;
      margin-right: 8px;
    }

    .closed-status {
      color: #9E9E9E;
      font-size: 12px;
      font-weight: bold;
    }

    .cancelled-status {
      color: #F44336;
      font-size: 12px;
      font-weight: bold;
    }

    .current-status {
      color: #2196F3;
      font-size: 12px;
      font-weight: bold;
    }

    /* Order Details Modal */
    .order-details-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      overflow-y: auto;
    }

    .order-details-modal-content {
      background-color: #1e1e24;
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 700px;
      border: 2px solid #4CAF50;
      position: relative;
    }

    .order-details-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 20px;
    }

    .order-details-close:hover,
    .order-details-close:focus {
      color: #f1f1f1;
    }

    .order-details-header {
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }

    .order-details-title {
      font-size: 24px;
      color: #4CAF50;
      font-weight: 600;
      margin: 0;
    }

    .order-details-section {
      margin-bottom: 20px;
    }

    .order-details-section h3 {
      color: #4CAF50;
      font-size: 16px;
      margin-bottom: 10px;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 5px;
    }

    .order-details-info {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .order-details-label {
      color: #b5b5b5;
      font-weight: 500;
    }

    .order-details-value {
      color: #f1f1f1;
    }

    .order-items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .order-items-table th {
      background: #2a2a33;
      color: #ffffff;
      padding: 10px;
      text-align: left;
      font-size: 14px;
    }

    .order-items-table td {
      padding: 10px;
      border-bottom: 1px solid #2a2a2a;
      color: #f1f1f1;
    }

    .order-items-table tr:last-child td {
      border-bottom: none;
    }

    .order-total {
      text-align: right;
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #4CAF50;
    }

    .order-item {
      cursor: pointer;
      transition: transform 0.2s;
    }

    .order-item:hover {
      transform: translateX(5px);
      background: #34343c;
    }

    .cancel-order-btn {
      background: #F44336;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 4px;
    }

    .cancel-order-btn:hover {
      background: #D32F2F;
    }

    .order-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2a2a33;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #4CAF50;
    }

    .order-info {
      flex: 1;
    }

    .order-number {
      font-weight: 600;
      color: #4CAF50;
      margin-bottom: 4px;
    }

    .order-details {
      font-size: 12px;
      color: #b5b5b5;
    }

    .move-order-btn {
      background: #4CAF50;
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
      margin-left: 12px;
    }

    .move-order-btn:hover {
      background: #45a049;
      transform: translateY(2px);
    }

    .move-order-btn:disabled {
      background: #3a3a44;
      cursor: not-allowed;
      transform: none;
    }

    .move-order-btn-up {
      background: #FF9800;
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
      margin-left: 12px;
    }

    .move-order-btn-up:hover {
      background: #F57C00;
      transform: translateY(-2px);
    }

    .move-order-btn-photo {
      background: #9C27B0;
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
      margin-left: 12px;
    }

    .move-order-btn-photo:hover {
      background: #7B1FA2;
      transform: scale(1.1);
    }

    /* Sortable table headers */
    .sortable-header {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 20px !important;
    }

    .sortable-header:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .sort-arrow {
      position: absolute;
      right: 5px;
      opacity: 0.5;
      font-size: 12px;
    }

    .sortable-header.sort-asc .sort-arrow::after {
      content: ' ↑';
      opacity: 1;
      color: #00BCD4;
    }

    .sortable-header.sort-desc .sort-arrow::after {
      content: ' ↓';
      opacity: 1;
      color: #00BCD4;
    }

    /* Editable quantity input in modal */
    .editable-quantity {
      width: 60px;
      padding: 4px 8px;
      border: 1px solid #444;
      background: #2a2a34;
      color: white;
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
    }

    .editable-quantity:focus {
      outline: none;
      border-color: #00BCD4;
    }

    /* Logout button specific styling */
    #logoutBtn {
      background-color: #f44336 !important;
    }

    #logoutBtn:hover {
      background-color: #d32f2f !important;
    }

    /* Ocultar logo en dispositivos móviles */
    @media (max-width: 768px) {
      .header-logo {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" class="header-logo">
    <div class="header-stats" id="headerStats">
      <div class="header-stat-card" id="headerTotalProducts">
        <div class="header-stat-number">0</div>
        <div class="header-stat-label">PRODUCTOS</div>
      </div>
      <div class="header-stat-card" id="headerStockTeorico">
        <div class="header-stat-number">0</div>
        <div class="header-stat-label">STOCK</div>
      </div>
      <div class="header-stat-card" id="headerStockTransito">
        <div class="header-stat-number">0</div>
        <div class="header-stat-label">TRÁNSITO</div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="mdc-tab-bar" role="tablist" id="tabs">
      <div class="mdc-tab-scroller">
        <div class="mdc-tab-scroller__scroll-area">
          <div class="mdc-tab-scroller__scroll-content">
            <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true" tabindex="0" data-segment="all">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">All</span>
              </span>
              <span class="mdc-tab-indicator mdc-tab-indicator--active">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-segment="iphone">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Iphone</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-segment="macbooks">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Macbooks</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-segment="samsung">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Samsung</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="toolbar">
      <button class="mdc-button mdc-button--raised" id="exportBtn">
        <span class="mdc-button__ripple"></span>
        <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
        <span class="mdc-button__label">Export to Excel</span>
      </button>
      <button class="mdc-button mdc-button--outlined" id="filterBtn">
        <span class="mdc-button__ripple"></span>
        <i class="material-icons mdc-button__icon" aria-hidden="true">filter_list</i>
        <span class="mdc-button__label">Filter</span>
      </button>
      <div class="mdc-text-field mdc-text-field--outlined search-field">
        <input class="mdc-text-field__input" type="text" id="searchBox" aria-describedby="search-helper-text">
        <div class="mdc-notched-outline">
          <div class="mdc-notched-outline__leading"></div>
          <div class="mdc-notched-outline__notch">
            <label for="searchBox" class="mdc-floating-label">Search model...</label>
          </div>
          <div class="mdc-notched-outline__trailing"></div>
        </div>
      </div>
      <div class="mdc-form-field">
        <div class="mdc-checkbox">
          <input type="checkbox" class="mdc-checkbox__native-control" id="autoToggle" checked>
          <div class="mdc-checkbox__background">
            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
              <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
            </svg>
            <div class="mdc-checkbox__mixedmark"></div>
          </div>
          <div class="mdc-checkbox__ripple"></div>
        </div>
        <label for="autoToggle">Auto-refresh 90s</label>
      </div>
      <span class="status" id="statusText"></span>
      <div style="flex: 1;"></div> <!-- Spacer -->
    </div>

    <div id="columnFilterDropdown" class="hidden">
      <label><input type="checkbox" data-column="articulo" checked> Artículo</label>
      <label><input type="checkbox" data-column="description" checked> Descripción</label>
      <label><input type="checkbox" data-column="grupo"> Grupo</label>
      <label><input type="checkbox" data-column="stock"> Stock</label>
      <label><input type="checkbox" data-column="disponible" checked> Disponible</label>
      <label><input type="checkbox" data-column="fechaActualizacion"> Fecha Ult. Actualización</label>
      <label><input type="checkbox" data-column="ordenVenta"> En Orden de Venta</label>
      <label><input type="checkbox" data-column="ordenCompra"> En Orden de Compra</label>
      <label><input type="checkbox" data-column="stockTeorico" checked> Stock</label>
      <label><input type="checkbox" data-column="teorico"> Stock</label>
      <label><input type="checkbox" data-column="transito"> Tránsito</label>
      <label><input type="checkbox" data-column="costoContable"> Costo Contable</label>
      <label><input type="checkbox" data-column="totalCostoContable"> Total Costo Contable</label>
      <label><input type="checkbox" data-column="monedaCostoContable"> Moneda de Costo Contable</label>
      <label><input type="checkbox" data-column="costoContableUnidadAlternativa"> Costo Contable Unidad Alternativa</label>
      <label><input type="checkbox" data-column="price"> Price</label>

      <hr style="border-color: #3a3a44; margin: 8px 0;">
      <label><input type="checkbox" id="hideZeroValues"> Mostrar solo productos con stock disponible</label>
      <label><input type="checkbox" id="hideZeroStockAndTransit" checked> Ocultar productos sin stock ni tránsito</label>
      <label><input type="checkbox" id="showAllProducts"> Show all products (including zero stock)</label>
    </div>

    <div id="errorBox" class="error hidden"></div>

    <!-- Add to Cart button (top only) -->
    <div style="text-align: right; margin-bottom: 12px;">
      <button class="mdc-button mdc-button--raised" id="addToCartBtn" style="background-color: #f44336 !important;">
        <span class="mdc-button__ripple"></span>
        <i class="material-icons mdc-button__icon" aria-hidden="true">shopping_cart</i>
        <span class="mdc-button__label">Add to Cart</span>
      </button>
    </div>

    <div style="overflow: auto; max-height: 70vh; border: 1px solid #eee; border-radius: 6px; width: 100%;">
      <table>
        <thead></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div id="buyModal" class="modal hidden">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>Selected Products Summary</h2>
    <div id="modalSummaryContent"></div>
    <div class="modal-total">Total: <span id="modalTotalPrice"></span></div>
  </div>
</div>

  <script src="main.js"></script>
  <!-- Hamburger Menu Button -->
  <button class="hamburger-btn" id="hamburgerBtn">
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
  </button>

  <!-- Slide-in Menu -->
  <div class="slide-menu" id="slideMenu">
    <div class="slide-menu-overlay" id="slideMenuOverlay"></div>
    <div class="slide-menu-content">
      <div class="slide-menu-header">
        <h3>Menu</h3>
        <button class="close-menu-btn" id="closeMenuBtn">&times;</button>
      </div>
      
      <div class="menu-sections">
        <button class="menu-btn" id="profileModalBtn">
          PROFILE
        </button>
        <button class="menu-btn" id="historialModalBtn">
          HISTORIAL
        </button>
        <button class="menu-btn" id="logisticsModalBtn">
          SEGUIMIENTO
        </button>
        <button class="menu-btn" id="adminBtn" style="display: none;">
          ADMIN
        </button>
      </div>

      <div class="menu-footer">
        <button class="menu-btn menu-logout-btn" id="menuLogoutBtn">
          LOGOUT
        </button>
        <div class="menu-version" id="menuVersionBtn">
          v0.25
        </div>
      </div>
      
    </div>
  </div>

  <!-- CONFIG Modal -->
  <div id="configModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>🔧 Configuración</h2>
      
      <div class="menu-content" id="configContent">
        <h4>📞 Configuración de Contactos</h4>
        
        <div class="config-group">
          <label for="whatsappInput">WhatsApp (con código de país)</label>
          <input type="tel" id="whatsappInput" placeholder="Ej: 5491123456789" maxlength="15">
          <small>Sin +, espacios o guiones</small>
        </div>
        
        <div class="config-group">
          <label for="emailInput">Email para Pedidos</label>
          <input type="email" id="emailInput" placeholder="ventas@empresa.com">
        </div>
        
        <div class="config-group">
          <label for="companyInput">Nombre de Empresa</label>
          <input type="text" id="companyInput" placeholder="Mi Empresa">
        </div>
        
        <h4>🔄 Configuración de Refresco</h4>
        
        <div class="config-group">
          <label for="refreshTime">Tiempo de Auto-refresco</label>
          <div class="refresh-input-group">
            <input type="number" id="refreshValue" min="1" max="999" value="30">
            <select id="refreshUnit">
              <option value="seconds">Segundos</option>
              <option value="minutes">Minutos</option>
              <option value="hours">Horas</option>
            </select>
          </div>
        </div>
        
        <div class="config-actions">
          <button class="save-config-btn" id="saveConfigBtn">💾 Guardar Configuración</button>
          <button class="reset-config-btn" id="resetConfigBtn">🔄 Restaurar</button>
        </div>
      </div>
      
      <!-- STATS Section -->
      <div class="menu-content" id="statsContent" style="display: none;">
        <h4>📈 Estadísticas del Sistema</h4>
        
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">Último refresco</div>
            <div class="stat-value" id="lastRefreshStat">-</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">Total productos cargados</div>
            <div class="stat-value" id="totalProductsStat">0</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">Items en carrito</div>
            <div class="stat-value" id="cartItemsStat">0</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">Valor total carrito</div>
            <div class="stat-value" id="cartValueStat">$0</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">Tiempo de refresco</div>
            <div class="stat-value" id="refreshTimeStat">90s</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">Configuración guardada</div>
            <div class="stat-value" id="configSavedStat">❌</div>
          </div>
        </div>
        
        <div class="stats-actions">
          <button class="refresh-stats-btn" id="refreshStatsBtn">🔄 Actualizar Stats</button>
          <button class="clear-stats-btn" id="clearStatsBtn">🗑️ Limpiar Datos</button>
        </div>
      </div>
    </div>
  </div>

  <!-- STATS Modal -->
  <div id="statsModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>📊 Estadísticas</h2>
      
      <div class="stats-grid">
        <!-- Advanced Analytics -->
        <div class="stat-item">
          <div class="stat-label">Item más comprado</div>
          <div class="stat-value" id="mostPurchasedItemStat">-</div>
        </div>

        <div class="stat-item">
          <div class="stat-label">Mes con más ventas</div>
          <div class="stat-value" id="bestSalesMonthStat">-</div>
        </div>

        <div class="stat-item">
          <div class="stat-label">Item con más cambios de stock</div>
          <div class="stat-value" id="mostStockChangesStat">-</div>
        </div>

        <!-- User Analytics -->
        <div class="stat-item">
          <div class="stat-label">Usuarios registrados</div>
          <div class="stat-value" id="totalUsersStat">-</div>
        </div>

        <div class="stat-item">
          <div class="stat-label">Usuario más activo</div>
          <div class="stat-value" id="mostActiveUserStat">-</div>
        </div>
      </div>
      
      <div class="stats-actions">
        <button class="refresh-stats-btn" id="refreshStatsBtn">🔄 Actualizar Stats</button>
      </div>
    </div>
  </div>

  <!-- PROFILE Modal -->
  <div id="profileModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>👤 Mi Perfil</h2>

      <div class="profile-form">
        <div class="profile-section">
          <h3>Información Personal</h3>

          <div class="profile-field">
            <label for="profileName">Nombre Completo</label>
            <input type="text" id="profileName" class="profile-input" placeholder="Ingresa tu nombre completo">
          </div>

          <div class="profile-field">
            <label for="profileAddress">Dirección</label>
            <textarea id="profileAddress" class="profile-input profile-textarea" placeholder="Ingresa tu dirección completa" rows="3"></textarea>
          </div>

          <div class="profile-field">
            <label for="profilePhone">Teléfono Principal</label>
            <input type="tel" id="profilePhone" class="profile-input" placeholder="+54 11 1234-5678">
          </div>

          <div class="profile-field">
            <label for="profileContactPhone">Teléfono de Contacto</label>
            <input type="tel" id="profileContactPhone" class="profile-input" placeholder="+54 11 8765-4321">
          </div>
        </div>

        <div class="profile-actions">
          <button class="profile-btn profile-save-btn" id="saveProfileBtn">
            <span class="btn-icon">💾</span>
            Guardar Perfil
          </button>
          <button class="profile-btn profile-clear-btn" id="clearProfileBtn">
            <span class="btn-icon">🗑️</span>
            Limpiar Datos
          </button>
        </div>

        <div class="profile-info">
          <p><strong>📧 Usuario:</strong> <span id="profileUserEmail">-</span></p>
          <p><small>Los datos del perfil se guardan automáticamente en tu cuenta.</small></p>
        </div>
      </div>
    </div>
  </div>

  <!-- HISTORIAL Modal -->
  <div id="historialModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>📋 Historial de Pedidos</h2>
      
      <div class="historial-content">
        <div class="historial-header">
          <button class="export-historial-btn" id="exportHistorialBtn">📤 Exportar</button>
        </div>
        
        <div class="historial-list" id="historialList">
          <div class="no-historial">
            <p>📝 No hay pedidos en el historial</p>
            <small>Los pedidos enviados por WhatsApp/Email aparecerán aquí</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SEGUIMIENTO Modal -->
  <div id="logisticsModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>📋 Seguimiento de Pedidos</h2>

      <div class="logistics-content">
        <div class="logistics-section">
          <h4>📝 Borrador</h4>
          <div class="logistics-orders" id="borradorOrders">
            <p class="no-orders">No hay pedidos en borrador</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>🔍 En Revisión</h4>
          <div class="logistics-orders" id="revisionOrders">
            <p class="no-orders">No hay pedidos en revisión</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>✅ Aprobada</h4>
          <div class="logistics-orders" id="aprobadaOrders">
            <p class="no-orders">No hay pedidos aprobados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>📦 En Preparación</h4>
          <div class="logistics-orders" id="preparacionOrders">
            <p class="no-orders">No hay pedidos en preparación</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>🚚 Listo para Retiro/Despacho</h4>
          <div class="logistics-orders" id="listoOrders">
            <p class="no-orders">No hay pedidos listos</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>🚛 Despachada</h4>
          <div class="logistics-orders" id="despachadaOrders">
            <p class="no-orders">No hay pedidos despachados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>✅ Entregada</h4>
          <div class="logistics-orders" id="entregadaOrders">
            <p class="no-orders">No hay pedidos entregados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>🔒 Cerrada</h4>
          <div class="logistics-orders" id="cerradaOrders">
            <p class="no-orders">No hay pedidos cerrados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>❌ Cancelada</h4>
          <div class="logistics-orders" id="canceladaOrders">
            <p class="no-orders">No hay pedidos cancelados</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CLIENTES Modal -->
  <div id="clientesModal" class="modal hidden">
    <div class="modal-content" style="max-width: 1200px;">
      <span class="close-button">&times;</span>
      <h2>👥 Gestión de Clientes</h2>

      <div class="clientes-header">
        <button class="import-excel-btn" id="importClientesBtn">📥 Importar Excel</button>
        <button class="export-excel-btn" id="exportClientesBtn">📤 Exportar Excel</button>
        <button class="add-client-btn" id="addClientBtn" onclick="openAddClientModal()">➕ Agregar Cliente</button>
        <input type="file" id="excelFileInput" accept=".xls,.xlsx" style="display: none;">
      </div>

      <div class="clientes-content">
        <div class="clientes-table-container">
          <table class="clientes-table">
            <thead>
              <tr>
                <th>Código</th>
                <th>Nombre</th>
                <th>Nombre Comercial</th>
                <th>Grupo</th>
                <th>Departamento</th>
                <th>Inscripción</th>
                <th>Nro Documento</th>
                <th>Dirección</th>
                <th>Ciudad</th>
                <th>Provincia</th>
                <th>País</th>
                <th>Teléfono</th>
                <th>Email</th>
                <th>Saldo Crédito</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="clientesTableBody">
              <tr>
                <td colspan="15" style="text-align: center; padding: 20px;">
                  Cargando clientes...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- AGREGAR/EDITAR CLIENTE Modal -->
  <div id="addClientModal" class="modal hidden">
    <div class="modal-content" style="max-width: 600px;">
      <span class="close-button">&times;</span>
      <h2 id="clientModalTitle">➕ Agregar Cliente</h2>

      <form id="clientForm" style="display: grid; gap: 15px; margin-top: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Código *</label>
            <input type="text" id="clientCodigo" required style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Grupo</label>
            <input type="text" id="clientGrupo" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Nombre *</label>
          <input type="text" id="clientNombre" required style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Nombre Comercial</label>
          <input type="text" id="clientNombreComercial" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Inscripción</label>
            <input type="text" id="clientInscripcion" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Nro Documento</label>
            <input type="text" id="clientNroDocumento" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Dirección</label>
          <input type="text" id="clientDireccion" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Ciudad</label>
            <input type="text" id="clientCiudad" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Provincia</label>
            <input type="text" id="clientProvincia" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">País</label>
            <input type="text" id="clientPais" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Teléfono</label>
            <input type="text" id="clientTelefono" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Email</label>
            <input type="email" id="clientEmail" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Departamento</label>
            <input type="text" id="clientDepartamento" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Saldo Crédito</label>
            <input type="number" id="clientSaldoCredito" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
          <button type="button" class="cancel-btn" onclick="closeModal('addClientModal')" style="padding: 10px 20px; border: 1px solid #3a3a44; border-radius: 4px; background: #2a2a33; color: #f1f1f1; cursor: pointer;">
            Cancelar
          </button>
          <button type="submit" class="save-btn" style="padding: 10px 20px; border: none; border-radius: 4px; background: #4CAF50; color: white; cursor: pointer; font-weight: 500;">
            Guardar Cliente
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- PHOTO UPLOAD Modal -->
  <div id="photoUploadModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>📸 Confirmar Entrega</h2>

      <div class="photo-upload-content">
        <p>Para marcar el pedido como entregado, por favor suba una foto de confirmación:</p>

        <div class="upload-options">
          <button class="upload-btn camera-btn" id="cameraBtn">
            📷 Tomar Foto
          </button>
          <button class="upload-btn file-btn" id="fileBtn">
            📁 Seleccionar Archivo
          </button>
        </div>

        <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;">
        <input type="file" id="fileInput" accept="image/*" style="display: none;">

        <div id="photoPreview" class="photo-preview" style="display: none;">
          <img id="previewImage" src="" alt="Preview">
          <div class="photo-actions">
            <button class="upload-confirm-btn" id="confirmUploadBtn">✅ Confirmar Entrega</button>
            <button class="upload-cancel-btn" id="cancelUploadBtn">❌ Cancelar</button>
          </div>
        </div>

        <div id="uploadProgress" class="upload-progress" style="display: none;">
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
          <p>Subiendo foto...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- PHOTO VIEW Modal -->
  <div id="photoViewModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>📸 Foto de Entrega</h2>

      <div class="photo-view-content">
        <img id="viewImage" src="" alt="Delivery Photo">
        <div class="photo-info">
          <p id="photoDate"></p>
          <p id="photoOrder"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div id="orderDetailsModal" class="order-details-modal">
    <div class="order-details-modal-content">
      <span class="order-details-close">&times;</span>

      <div class="order-details-header">
        <h2 class="order-details-title" id="orderDetailsTitle">Detalles de la Orden</h2>
      </div>

      <div class="order-details-section">
        <h3>📋 Información General</h3>
        <div class="order-details-info">
          <span class="order-details-label">Número de Orden:</span>
          <span class="order-details-value" id="detailOrderNumber">-</span>
        </div>
        <div class="order-details-info">
          <span class="order-details-label">Cliente:</span>
          <span class="order-details-value" id="detailClientName">-</span>
        </div>
        <div class="order-details-info">
          <span class="order-details-label">Email:</span>
          <span class="order-details-value" id="detailClientEmail">-</span>
        </div>
        <div class="order-details-info">
          <span class="order-details-label">Fecha:</span>
          <span class="order-details-value" id="detailOrderDate">-</span>
        </div>
        <div class="order-details-info">
          <span class="order-details-label">Estado:</span>
          <span class="order-details-value" id="detailOrderState">-</span>
        </div>
        <div class="order-details-info" id="detailAdminCreatedContainer" style="display: none;">
          <span class="order-details-label">Creada por (Admin):</span>
          <span class="order-details-value" id="detailAdminCreated">-</span>
        </div>
      </div>

      <div class="order-details-section">
        <h3>🛒 Productos</h3>
        <table class="order-items-table" id="detailOrderTable">
          <thead>
            <tr>
              <th class="sortable-header" data-sort-column="articulo">Artículo <span class="sort-arrow">↕</span></th>
              <th class="sortable-header" data-sort-column="description">Descripción <span class="sort-arrow">↕</span></th>
              <th class="sortable-header" data-sort-column="quantity" style="text-align: center;">Cantidad <span class="sort-arrow">↕</span></th>
              <th class="sortable-header" data-sort-column="price" style="text-align: right;">Precio Unit. <span class="sort-arrow">↕</span></th>
              <th class="sortable-header" data-sort-column="subtotal" style="text-align: right;">Subtotal <span class="sort-arrow">↕</span></th>
            </tr>
          </thead>
          <tbody id="detailOrderItems">
            <tr>
              <td colspan="5" style="text-align: center;">No hay items</td>
            </tr>
          </tbody>
        </table>
        <div class="order-total">
          <span>TOTAL: </span>
          <span id="detailOrderTotal">$0.00</span>
        </div>
      </div>

      <div class="order-details-section" id="detailSaveOrderContainer" style="display: none;">
        <button class="mdc-button mdc-button--raised" id="detailSaveOrderBtn" style="width: 100%; background-color: #FF9800 !important;">
          <span class="mdc-button__ripple"></span>
          <i class="material-icons mdc-button__icon" aria-hidden="true">save</i>
          <span class="mdc-button__label">Guardar Cambios</span>
        </button>
      </div>

      <div class="order-details-section" id="detailSendWhatsAppContainer" style="display: none;">
        <button class="mdc-button mdc-button--raised" id="detailSendWhatsAppBtn" style="width: 100%; background-color: #25D366 !important;">
          <span class="mdc-button__ripple"></span>
          <i class="material-icons mdc-button__icon" aria-hidden="true">send</i>
          <span class="mdc-button__label">Enviar WhatsApp al Vendedor</span>
        </button>
      </div>

      <div class="order-details-section" id="detailEditOrderContainer" style="display: none;">
        <button class="mdc-button mdc-button--raised" id="detailEditOrderBtn" style="width: 100%; background-color: #4CAF50 !important;">
          <span class="mdc-button__ripple"></span>
          <i class="material-icons mdc-button__icon" aria-hidden="true">shopping_cart</i>
          <span class="mdc-button__label">Seguir Comprando / Editar Orden</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Limpiar consola al cargar la página
    console.clear();
    console.log('🚀 Marketplace cargado - Consola limpiada');
    
    // === FIREBASE STATUS CHECK ===
    function checkFirebaseStatus() {
      console.log('🔥 Verificando estado de Firebase...');
      console.log('🔍 Firebase disponible:', typeof firebase !== 'undefined');
      
      if (typeof firebase !== 'undefined') {
        console.log('🔍 Firebase.app():', !!firebase.app);
        console.log('🔍 Firebase.auth():', !!firebase.auth);
        console.log('🔍 Firebase.firestore():', !!firebase.firestore);
        
        try {
          const currentUser = firebase.auth().currentUser;
          console.log('👤 Usuario actual:', currentUser ? `${currentUser.email} (${currentUser.uid})` : 'No autenticado');
        } catch (error) {
          console.error('❌ Error accediendo a Firebase auth:', error);
        }
      } else {
        console.error('❌ Firebase no está cargado');
      }
    }

    // === HISTORIAL FUNCTIONS ===
    // Cargar historial de pedidos desde Firebase
    async function loadHistorial() {
      const historialList = document.getElementById('historialList');

      if (!historialList) {
        console.warn('⚠️ Elemento historialList no encontrado en marketplace.html');
        return;
      }

      if (!firebase || !firebase.auth().currentUser) {
        historialList.innerHTML = `
          <div class="no-historial">
            <p>🔐 Necesitas estar autenticado</p>
            <small>Inicia sesión para ver el historial de pedidos</small>
          </div>
        `;
        return;
      }

      const currentUser = firebase.auth().currentUser;

      try {
        console.log('📋 Cargando historial desde Firebase en marketplace.html...');
        console.log('👤 Usuario actual:', currentUser.uid, currentUser.email);

        // Verificar si el usuario es admin
        const { collection, query, where, limit, getDocs, doc, getDoc, orderBy } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const userRef = doc(db, 'usuarios', currentUser.uid);
        const userDoc = await getDoc(userRef);
        const isAdmin = userDoc.exists() && userDoc.data().admin === true;

        console.log('👑 Es admin:', isAdmin);

        const pedidosCollection = collection(db, 'pedidos');

        let q;
        if (isAdmin) {
          // Admin ve todas las órdenes
          console.log('👑 Usuario admin - cargando todas las órdenes');
          q = query(
            pedidosCollection,
            orderBy('timestamp', 'desc'),
            limit(100)
          );
        } else {
          // Usuario normal solo ve sus propias órdenes
          console.log('👤 Usuario normal - cargando solo sus órdenes');
          q = query(
            pedidosCollection,
            where('userId', '==', currentUser.uid),
            limit(50)
          );
        }

        const querySnapshot = await getDocs(q);

        console.log('📋 Órdenes encontradas:', querySnapshot.size);

        if (querySnapshot.empty) {
          historialList.innerHTML = `
            <div class="no-historial">
              <p>📝 No hay pedidos en el historial</p>
              <small>Los pedidos confirmados aparecerán aquí</small>
            </div>
          `;
          return;
        }

        const pedidos = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          pedidos.push({
            id: doc.id,
            ...data
          });
        });

        // Ordenar por fecha en JavaScript (más recientes primero)
        pedidos.sort((a, b) => {
          if (a.timestamp && b.timestamp) {
            return b.timestamp - a.timestamp;
          } else if (a.fecha && b.fecha) {
            return b.fecha.toMillis() - a.fecha.toMillis();
          }
          return 0;
        });

        console.log(`✅ Cargados ${pedidos.length} pedidos desde Firebase en marketplace`);

        // Agregar banner para admins
        let adminBanner = '';
        if (isAdmin) {
          adminBanner = `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
              <i class="material-icons" style="color: white;">admin_panel_settings</i>
              <div style="color: white;">
                <strong>Vista Administrador</strong>
                <div style="font-size: 12px; opacity: 0.9;">Mostrando todas las órdenes de todos los usuarios</div>
              </div>
            </div>
          `;
        }

        historialList.innerHTML = adminBanner + pedidos.map(pedido => `
          <div class="historial-item" data-order-id="${pedido.id}">
            <div class="historial-item-header">
              <div class="historial-date">${pedido.fechaLocal}</div>
              <div class="historial-method">${pedido.numeroOrden ? `#${pedido.numeroOrden}` : (pedido.estado || 'Confirmada')}</div>
            </div>
            <div class="historial-summary">${pedido.resumen}</div>
            ${isAdmin && (pedido.userDisplayName || pedido.usuarioEmail || pedido.userEmail) ?
              `<div class="historial-user">👤 ${pedido.userDisplayName || pedido.usuarioEmail || pedido.userEmail}</div>` :
              ''}
            <div class="historial-items-preview">
              ${pedido.items.slice(0, 2).map(item => `<small>${item.description}</small>`).join(' • ')}
              ${pedido.items.length > 2 ? `<small>... +${pedido.items.length - 2} más</small>` : ''}
            </div>
          </div>
        `).join('');

        // Add event listener for historial items
        historialList.addEventListener('click', (e) => {
          const historialItem = e.target.closest('.historial-item');
          if (historialItem) {
            const orderId = historialItem.getAttribute('data-order-id');
            if (orderId) {
              showOrderDetails(orderId);
            }
          }
        });

      } catch (error) {
        console.error('❌ Error cargando historial en marketplace:', error);

        if (historialList) {
          historialList.innerHTML = `
            <div class="no-historial">
              <p>❌ Error cargando historial</p>
              <small>Intenta recargar la página</small>
            </div>
          `;
        }

        // No relanzar el error para evitar romper el flujo
        return;
      }
    }

    // Exportar historial (desde Firebase)
    async function exportHistorial() {
      try {
        let pedidos = [];
        const currentUser = firebase.auth().currentUser;

        // Intentar cargar desde Firebase primero
        if (currentUser && firebase.firestore) {
          console.log('📊 Exportando desde Firebase...');

          const { collection, query, where, getDocs } = firebase.firestoreHelpers;
          const db = firebase.firestore();

          const pedidosCollection = collection(db, 'pedidos');
          const q = query(pedidosCollection, where('userId', '==', currentUser.uid));
          const querySnapshot = await getDocs(q);

          querySnapshot.forEach(doc => {
            const data = doc.data();
            pedidos.push({
              fecha: data.fechaLocal,
              numeroOrden: data.numeroOrden || '',
              estado: data.estado || 'Confirmada',
              resumen: data.resumen,
              total: data.total,
              items: data.cantidadItems,
              usuario: data.userDisplayName || data.userEmail || '',
              empresa: data.empresa || '',
              timestamp: data.timestamp,
              fechaFirestore: data.fecha
            });
          });

          // Ordenar por fecha (más recientes primero)
          pedidos.sort((a, b) => {
            if (a.timestamp && b.timestamp) {
              return b.timestamp - a.timestamp;
            } else if (a.fechaFirestore && b.fechaFirestore) {
              return b.fechaFirestore.toMillis() - a.fechaFirestore.toMillis();
            }
            return 0;
          });
        } else {
          // Fallback a localStorage
          console.log('📊 Exportando desde localStorage...');
          const historialLocal = JSON.parse(localStorage.getItem('pedidosHistorial') || '[]');
          pedidos = historialLocal.map(pedido => ({
            fecha: pedido.fecha,
            numeroOrden: '',
            estado: pedido.metodo || 'Confirmada',
            resumen: pedido.resumen,
            total: '',
            items: '',
            usuario: '',
            empresa: ''
          }));
        }

        if (pedidos.length === 0) {
          alert('📋 No hay pedidos para exportar');
          return;
        }

        // Crear CSV
        const csvContent = 'Fecha,Numero Orden,Estado,Resumen,Total,Items,Usuario,Empresa\\n' +
          pedidos.map(pedido =>
            `"${pedido.fecha}","${pedido.numeroOrden}","${pedido.estado}","${pedido.resumen.replace(/"/g, '""')}","${pedido.total}","${pedido.items}","${pedido.usuario}","${pedido.empresa}"`
          ).join('\\n');

        // Descargar archivo
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `historial_pedidos_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }

        console.log(`✅ Exportados ${pedidos.length} pedidos`);

      } catch (error) {
        console.error('❌ Error exportando historial:', error);
        alert('❌ Error exportando historial. Intenta de nuevo.');
      }
    }

    // === TOAST NOTIFICATIONS ===
    function showToast(message, type = 'success') {
      // Crear elemento toast
      const toast = document.createElement('div');
      toast.className = `toast-notification ${type === 'error' ? 'error' : ''}`;
      toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 18px;">${type === 'error' ? '❌' : '✅'}</span>
          <span>${message}</span>
        </div>
      `;
      
      // Agregar al body
      document.body.appendChild(toast);
      
      // Mostrar con animación
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      // Ocultar y remover después de 3 segundos
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }
    
    // === CONFIGURACIÓN ===
    let APP_CONFIG = {
      whatsappNumber: '',
      email: '',
      companyName: 'Öppen Store',
      refreshTime: 30,
      refreshUnit: 'seconds'
    };

    // Cargar configuración desde Firebase
    async function loadConfig() {
      try {
        if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
          const user = firebase.auth().currentUser;

          // Usar las funciones de Firebase importadas
          const { doc, getDoc } = firebase.firestoreHelpers;
          const configRef = doc(firebase.firestore(), 'configuracion', user.uid);
          const configDoc = await getDoc(configRef);

          if (configDoc.exists()) {
            APP_CONFIG = { ...APP_CONFIG, ...configDoc.data() };
            console.log('✅ Configuración cargada desde Firebase:', APP_CONFIG);
            updateConfigInputs();

            // Mostrar toast informativo
            showToast('Configuración cargada desde la nube', 'success');
          }
        }
      } catch (error) {
        // Silenciar errores de permisos - la configuración es opcional
        if (error.code === 'permission-denied') {
          console.log('ℹ️ No hay configuración personalizada (esto es normal)');
        } else {
          console.error('Error cargando configuración:', error);
        }
      }
    }

    // Guardar configuración en Firebase
    async function saveConfig() {
      try {
        console.log('🔄 Iniciando guardado de configuración...');
        console.log('🔍 Firebase disponible:', typeof firebase !== 'undefined');
        
        if (typeof firebase === 'undefined') {
          console.error('❌ Firebase no está definido');
          return false;
        }
        
        console.log('🔍 Firebase auth disponible:', !!firebase.auth);
        const currentUser = firebase.auth().currentUser;
        console.log('🔍 Usuario actual:', currentUser ? currentUser.email : 'No autenticado');
        
        if (currentUser) {
          console.log('💾 Guardando en Firestore para usuario:', currentUser.uid);
          console.log('📋 Datos a guardar:', APP_CONFIG);
          
          // Usar las funciones de Firebase importadas
          const { doc, setDoc } = firebase.firestoreHelpers;
          const configRef = doc(firebase.firestore(), 'configuracion', currentUser.uid);
          await setDoc(configRef, APP_CONFIG);
          
          console.log('✅ Configuración guardada exitosamente en Firebase');
          return true;
        } else {
          console.error('❌ Usuario no autenticado');
          return false;
        }
      } catch (error) {
        console.error('❌ Error guardando configuración:', error);
        console.error('❌ Error details:', error.message);
        console.error('❌ Error code:', error.code);
        return false;
      }
    }

    // Actualizar inputs con configuración actual
    function updateConfigInputs() {
      const whatsappInput = document.getElementById('whatsappInput');
      const emailInput = document.getElementById('emailInput');
      const companyInput = document.getElementById('companyInput');
      
      if (whatsappInput) whatsappInput.value = APP_CONFIG.whatsappNumber || '';
      if (emailInput) emailInput.value = APP_CONFIG.email || '';
      if (companyInput) companyInput.value = APP_CONFIG.companyName || 'Öppen Store';
    }

    // Guardar configuración desde inputs
    async function saveConfigFromInputs() {
      const whatsappInput = document.getElementById('whatsappInput');
      const emailInput = document.getElementById('emailInput');
      const companyInput = document.getElementById('companyInput');
      
      if (!whatsappInput || !emailInput || !companyInput) {
        console.error('❌ Inputs de configuración no encontrados');
        return;
      }

      const whatsapp = whatsappInput.value.trim();
      const email = emailInput.value.trim();
      const company = companyInput.value.trim();
      
      // Validaciones
      if (whatsapp && !/^\d{10,15}$/.test(whatsapp)) {
        showToast('El número de WhatsApp debe tener entre 10-15 dígitos (solo números)', 'error');
        return;
      }
      
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showToast('Por favor ingresa un email válido', 'error');
        return;
      }
      
      // Actualizar configuración
      APP_CONFIG.whatsappNumber = whatsapp;
      APP_CONFIG.email = email;
      APP_CONFIG.companyName = company || 'Öppen Store';
      
      // Guardar en Firebase
      console.log('🚀 Intentando guardar configuración...');
      const success = await saveConfig();
      
      if (success) {
        // Mostrar toast de éxito
        showToast('¡Configuración guardada correctamente!', 'success');
        
        // Feedback visual adicional en el botón
        const saveBtn = document.getElementById('saveConfigBtn');
        if (saveBtn) {
          const originalText = saveBtn.textContent;
          saveBtn.textContent = '✅ ¡Guardado!';
          saveBtn.style.background = '#28a745';
          
          setTimeout(() => {
            saveBtn.textContent = originalText;
            saveBtn.style.background = '';
          }, 2000);
        }
        
        console.log('✅ Configuración actualizada:', APP_CONFIG);
      } else {
        // Mostrar mensaje de error más específico
        if (typeof firebase === 'undefined') {
          showToast('Firebase no está configurado correctamente', 'error');
        } else if (!firebase.auth().currentUser) {
          showToast('Debe iniciar sesión para guardar la configuración', 'error');
        } else {
          showToast('Error guardando la configuración. Verifique la consola', 'error');
        }
      }
    }
    
    // Variable global para almacenar permisos de admin
    window.isUserAdmin = false;

    // === USER PERMISSIONS CHECK ===
    async function checkUserPermissions(user) {
      try {
        console.log('🔐 Verificando permisos para usuario:', user.email);

        if (typeof firebase !== 'undefined' && firebase.firestoreHelpers) {
          const { doc, getDoc } = firebase.firestoreHelpers;
          const userRef = doc(firebase.firestore(), 'usuarios', user.uid);
          const userDoc = await getDoc(userRef);

          let isAdmin = false;
          if (userDoc.exists()) {
            const userData = userDoc.data();
            isAdmin = userData.admin === true;
            console.log('👤 Usuario encontrado:', userData);
            console.log('🔐 Es admin:', isAdmin);
          } else {
            console.log('⚠️ Usuario no encontrado en Firestore, asumiendo no-admin');
          }

          // Guardar globalmente
          window.isUserAdmin = isAdmin;
          
          // Función para aplicar visibilidad de controles
          const applyControlsVisibility = () => {
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const filterBtn = document.getElementById('filterBtn');
            const columnFilterDropdown = document.getElementById('columnFilterDropdown');
            
            // Elementos del menú
            const configModalBtn = document.getElementById('configModalBtn');
            const statsModalBtn = document.getElementById('statsModalBtn');
            const historialModalBtn = document.getElementById('historialModalBtn');
            const logisticsModalBtn = document.getElementById('logisticsModalBtn');
            const adminBtn = document.getElementById('adminBtn');
            
            console.log('🔍 Elementos encontrados:');
            console.log('- hamburgerBtn:', !!hamburgerBtn);
            console.log('- filterBtn:', !!filterBtn);
            console.log('- columnFilterDropdown:', !!columnFilterDropdown);
            console.log('- configModalBtn:', !!configModalBtn);
            console.log('- statsModalBtn:', !!statsModalBtn);
            console.log('- historialModalBtn:', !!historialModalBtn);
            console.log('- logisticsModalBtn:', !!logisticsModalBtn);
            
            if (!isAdmin) {
              console.log('🚫 Usuario NO-ADMIN: mostrando solo menú con historial');

              // Mostrar menú hamburguesa (pero con opciones limitadas)
              if (hamburgerBtn) {
                hamburgerBtn.style.display = 'block';
                hamburgerBtn.style.visibility = 'visible';
                console.log('✅ Menú hamburguesa visible');
              }

              // Ocultar filtros completamente para no-admin
              if (filterBtn) {
                filterBtn.style.display = 'none !important';
                filterBtn.style.visibility = 'hidden';
                filterBtn.style.pointerEvents = 'none';
                console.log('✅ Botón de filtro ocultado completamente');
              }
              if (columnFilterDropdown) {
                columnFilterDropdown.style.display = 'none !important';
                columnFilterDropdown.style.visibility = 'hidden';
                columnFilterDropdown.style.pointerEvents = 'none';
                columnFilterDropdown.classList.add('hidden');
                console.log('✅ Dropdown de filtros ocultado completamente');
              }

              // Ocultar opciones administrativas del menú (mostrar HISTORIAL y LOGISTICS)
              if (configModalBtn) {
                configModalBtn.style.display = 'none';
                console.log('✅ CONFIG ocultado');
              }
              if (statsModalBtn) {
                statsModalBtn.style.display = 'none';
                console.log('✅ STATS ocultado');
              }
              if (logisticsModalBtn) {
                logisticsModalBtn.style.display = 'block';
                console.log('✅ LOGISTICS visible para usuario no-admin');
              }
              if (historialModalBtn) {
                historialModalBtn.style.display = 'block';
                console.log('✅ HISTORIAL visible para usuario no-admin');
              }
              if (adminBtn) {
                adminBtn.style.display = 'none';
                console.log('🚫 ADMIN ocultado para usuario no-admin');
              }

              
            } else {
              console.log('✅ Usuario ADMIN: mostrando todos los controles');

              // Mostrar todos los controles
              if (hamburgerBtn) {
                hamburgerBtn.style.display = 'block';
                hamburgerBtn.style.visibility = 'visible';
                console.log('✅ Menú hamburguesa visible');
              }
              if (filterBtn) {
                // Restaurar completamente el estado normal para admin
                filterBtn.style.display = '';
                filterBtn.style.visibility = '';
                filterBtn.style.pointerEvents = '';
                console.log('✅ Botón de filtro completamente restaurado y funcional');
              }
              if (columnFilterDropdown) {
                // Para admin, restaurar completamente el estado normal
                columnFilterDropdown.style.display = '';
                columnFilterDropdown.style.visibility = '';
                columnFilterDropdown.style.pointerEvents = '';
                // Asegurar que esté cerrado por defecto pero funcional
                if (!columnFilterDropdown.classList.contains('hidden')) {
                  columnFilterDropdown.classList.add('hidden');
                }
                console.log('✅ Dropdown de filtros completamente restaurado y funcional');
              }

              // Mostrar todas las opciones del menú
              if (configModalBtn) {
                configModalBtn.style.display = 'block';
                console.log('✅ CONFIG visible');
              }
              if (statsModalBtn) {
                statsModalBtn.style.display = 'block';
                console.log('✅ STATS visible');
              }
              if (logisticsModalBtn) {
                logisticsModalBtn.style.display = 'block';
                console.log('✅ LOGISTICS visible');
              }
              if (historialModalBtn) {
                historialModalBtn.style.display = 'block';
                console.log('✅ HISTORIAL visible');
              }
              if (adminBtn) {
                adminBtn.style.display = 'block';
                console.log('✅ ADMIN visible para usuario admin');
              }

            }
          };
          
          // Aplicar inmediatamente
          applyControlsVisibility();
          
          // También aplicar después de un pequeño delay para asegurar que el DOM esté listo
          setTimeout(applyControlsVisibility, 500);
          
          // Para usuarios no-admin, asegurar que los KPIs se muestren con columnas básicas
          if (!isAdmin) {
            setTimeout(() => {
              console.log('🔄 Configurando columnas básicas para usuario no-admin...');
              // Asegurar que al menos algunas columnas estén visibles para generar KPIs
              const basicColumns = ['articulo', 'description', 'ordenVenta', 'stockTeorico'];
              basicColumns.forEach(col => {
                const checkbox = document.querySelector(`input[data-column="${col}"]`);
                if (checkbox && !checkbox.checked) {
                  checkbox.checked = true;
                  console.log(`✅ Activando columna ${col} para usuario no-admin`);
                }
              });
              
              // Forzar actualización de la tabla y KPIs
              if (typeof window.refresh === 'function') {
                console.log('📊 Ejecutando refresh para mostrar KPIs');
                window.refresh();
              }
            }, 1200);
          } else {
            // Para admins, solo hacer refresh
            setTimeout(() => {
              console.log('🔄 Forzando actualización de KPIs para admin...');
              if (typeof window.refresh === 'function') {
                console.log('📊 Ejecutando refresh para mostrar KPIs');
                window.refresh();
              }
            }, 1000);
          }
        }
      } catch (error) {
        console.error('❌ Error verificando permisos de usuario:', error);
        // Por seguridad, mostrar solo historial si hay error
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const filterBtn = document.getElementById('filterBtn');
        const columnFilterDropdown = document.getElementById('columnFilterDropdown');
        const configModalBtn = document.getElementById('configModalBtn');
        const statsModalBtn = document.getElementById('statsModalBtn');
        const logisticsModalBtn = document.getElementById('logisticsModalBtn');
        const historialModalBtn = document.getElementById('historialModalBtn');
        
        // Mostrar menú pero solo con historial
        if (hamburgerBtn) {
          hamburgerBtn.style.display = 'block';
          hamburgerBtn.style.visibility = 'visible';
        }
        
        // Ocultar opciones administrativas (comportamiento no-admin por seguridad)
        if (filterBtn) {
          filterBtn.style.display = 'none !important';
          filterBtn.style.visibility = 'hidden';
          filterBtn.style.pointerEvents = 'none';
        }
        if (columnFilterDropdown) {
          columnFilterDropdown.style.display = 'none !important';
          columnFilterDropdown.style.visibility = 'hidden';
          columnFilterDropdown.style.pointerEvents = 'none';
          columnFilterDropdown.classList.add('hidden');
        }
        if (configModalBtn) configModalBtn.style.display = 'none';
        if (statsModalBtn) statsModalBtn.style.display = 'none';
        
        // Mostrar historial y logistics (opciones básicas)
        if (logisticsModalBtn) logisticsModalBtn.style.display = 'block';
        if (historialModalBtn) historialModalBtn.style.display = 'block';
        
        console.log('🚫 Error en verificación: mostrando historial y logistics por seguridad');
      }
    }

    // === CLIENTES FUNCTIONALITY ===

    async function loadClientes() {
      const tableBody = document.getElementById('clientesTableBody');

      if (!tableBody) {
        console.warn('⚠️ Elemento clientesTableBody no encontrado');
        return;
      }

      if (!firebase || !firebase.firestore) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="15" style="text-align: center; padding: 20px;">
              ❌ Firebase no está disponible
            </td>
          </tr>
        `;
        return;
      }

      try {
        console.log('👥 Cargando clientes desde Firebase...');

        const { collection, getDocs, query, orderBy } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clientesCollection = collection(db, 'clientes');
        const q = query(clientesCollection, orderBy('codigo', 'asc'));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="15" style="text-align: center; padding: 20px;">
                📝 No hay clientes registrados
              </td>
            </tr>
          `;
          return;
        }

        const clientes = [];
        querySnapshot.forEach(doc => {
          clientes.push({
            id: doc.id,
            ...doc.data()
          });
        });

        console.log(`✅ Cargados ${clientes.length} clientes desde Firebase`);

        tableBody.innerHTML = clientes.map(cliente => `
          <tr>
            <td>${cliente.codigo || ''}</td>
            <td>${cliente.nombre || ''}</td>
            <td>${cliente.nombreComercial || ''}</td>
            <td>${cliente.grupo || ''}</td>
            <td>${cliente.departamento || ''}</td>
            <td>${cliente.inscripcion || ''}</td>
            <td>${cliente.nroDocumento || ''}</td>
            <td>${cliente.direccion || ''}</td>
            <td>${cliente.ciudad || ''}</td>
            <td>${cliente.provincia || ''}</td>
            <td>${cliente.pais || ''}</td>
            <td>${cliente.telefono || ''}</td>
            <td>${cliente.email || ''}</td>
            <td style="text-align: right;">${cliente.saldoCredito ? parseFloat(cliente.saldoCredito).toFixed(2) : '0.00'}</td>
            <td>
              <button class="edit-client-btn" onclick="editCliente('${cliente.id}')">✏️</button>
              <button class="delete-client-btn" onclick="deleteCliente('${cliente.id}')">🗑️</button>
            </td>
          </tr>
        `).join('');

      } catch (error) {
        console.error('❌ Error cargando clientes:', error);
        tableBody.innerHTML = `
          <tr>
            <td colspan="15" style="text-align: center; padding: 20px;">
              ❌ Error cargando clientes
            </td>
          </tr>
        `;
      }
    }

    async function importClientes() {
      const fileInput = document.getElementById('excelFileInput');
      fileInput.click();
    }

    async function handleExcelImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!firebase || !firebase.firestore) {
        alert('❌ Firebase no está disponible');
        return;
      }

      try {
        console.log('📥 Importando archivo Excel:', file.name);

        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            console.log('📊 Datos leídos del Excel:', jsonData.length, 'filas');

            const { collection, doc, setDoc } = firebase.firestoreHelpers;
            const db = firebase.firestore();

            let importados = 0;
            let saltados = 0;

            for (const row of jsonData) {
              // Extract and validate codigo (convert to string and trim)
              let codigo = row['Código'] || row['Codigo'] || '';
              if (codigo !== null && codigo !== undefined) {
                codigo = String(codigo).trim();
              }

              // Skip rows without valid codigo
              if (!codigo || codigo === '' || codigo === 'null' || codigo === 'undefined') {
                console.log('⚠️ Saltando fila sin código válido:', row);
                saltados++;
                continue;
              }

              const saldoCredito = row['Saldo Crédito'] || row['Saldo Credito'] || row['SaldoCredito'] || 0;

              const clienteData = {
                codigo: codigo,
                nombre: String(row['Nombre'] || '').trim(),
                nombreComercial: String(row['Nombre Comercial'] || '').trim(),
                grupo: String(row['Grupo de Clientes'] || row['Grupo'] || '').trim(),
                departamento: String(row['Departamento'] || '').trim(),
                inscripcion: String(row['Inscripción'] || row['Inscripcion'] || '').trim(),
                nroDocumento: String(row['Nro Documento'] || '').trim(),
                direccion: String(row['Dirección'] || row['Direccion'] || '').trim(),
                ciudad: String(row['Nombre (Ciudad)'] || row['Ciudad'] || '').trim(),
                provincia: String(row['Provincia'] || '').trim(),
                pais: String(row['País'] || row['Pais'] || '').trim(),
                telefono: String(row['Teléfono'] || row['Telefono'] || '').trim(),
                email: String(row['Email'] || '').trim(),
                saldoCredito: parseFloat(saldoCredito) || 0
              };

              // Use codigo as document ID
              const clienteRef = doc(db, 'clientes', clienteData.codigo);
              await setDoc(clienteRef, clienteData);
              importados++;

              if (importados % 50 === 0) {
                console.log(`📊 Progreso: ${importados} clientes importados...`);
              }
            }

            console.log(`✅ Importación completada: ${importados} clientes importados, ${saltados} filas saltadas`);
            alert(`✅ Importados ${importados} clientes correctamente${saltados > 0 ? `\n⚠️ ${saltados} filas saltadas por falta de código` : ''}`);

            // Reload clientes
            loadClientes();

          } catch (error) {
            console.error('❌ Error procesando Excel:', error);
            alert('❌ Error procesando archivo Excel: ' + error.message);
          }
        };

        reader.readAsArrayBuffer(file);

      } catch (error) {
        console.error('❌ Error importando clientes:', error);
        alert('❌ Error importando clientes: ' + error.message);
      }

      // Reset file input
      event.target.value = '';
    }

    async function exportClientes() {
      if (!firebase || !firebase.firestore) {
        alert('❌ Firebase no está disponible');
        return;
      }

      try {
        console.log('📤 Exportando clientes a Excel...');

        const { collection, getDocs, query, orderBy } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clientesCollection = collection(db, 'clientes');
        const q = query(clientesCollection, orderBy('codigo', 'asc'));
        const querySnapshot = await getDocs(q);

        const clientes = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          clientes.push({
            'Código': data.codigo || '',
            'Nombre': data.nombre || '',
            'Nombre Comercial': data.nombreComercial || '',
            'Grupo de Clientes': data.grupo || '',
            'Departamento': data.departamento || '',
            'Inscripción': data.inscripcion || '',
            'Nro Documento': data.nroDocumento || '',
            'Dirección': data.direccion || '',
            'Nombre (Ciudad)': data.ciudad || '',
            'Provincia': data.provincia || '',
            'País': data.pais || '',
            'Teléfono': data.telefono || '',
            'Email': data.email || '',
            'Saldo Crédito': data.saldoCredito || 0
          });
        });

        if (clientes.length === 0) {
          alert('⚠️ No hay clientes para exportar');
          return;
        }

        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(clientes);
        XLSX.utils.book_append_sheet(wb, ws, 'Clientes');

        // Download file
        const fecha = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `Listado_de_Clientes_${fecha}.xlsx`);

        console.log(`✅ Exportados ${clientes.length} clientes a Excel`);
        alert(`✅ Exportados ${clientes.length} clientes correctamente`);

      } catch (error) {
        console.error('❌ Error exportando clientes:', error);
        alert('❌ Error exportando clientes: ' + error.message);
      }
    }

    let currentEditingClienteId = null;

    function openAddClientModal() {
      // Reset form
      document.getElementById('clientForm').reset();
      document.getElementById('clientModalTitle').textContent = '➕ Agregar Cliente';
      currentEditingClienteId = null;

      // Enable codigo field for new clients
      document.getElementById('clientCodigo').disabled = false;

      openModal('addClientModal');
    }

    async function editCliente(clienteId) {
      if (!firebase || !firebase.firestore) {
        alert('❌ Firebase no está disponible');
        return;
      }

      try {
        const { doc, getDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clienteId);
        const clienteDoc = await getDoc(clienteRef);

        if (!clienteDoc.exists()) {
          alert('❌ Cliente no encontrado');
          return;
        }

        const cliente = clienteDoc.data();

        // Set form title
        document.getElementById('clientModalTitle').textContent = '✏️ Editar Cliente';
        currentEditingClienteId = clienteId;

        // Fill form
        document.getElementById('clientCodigo').value = cliente.codigo || '';
        document.getElementById('clientCodigo').disabled = true; // Don't allow changing codigo
        document.getElementById('clientNombre').value = cliente.nombre || '';
        document.getElementById('clientNombreComercial').value = cliente.nombreComercial || '';
        document.getElementById('clientGrupo').value = cliente.grupo || '';
        document.getElementById('clientDepartamento').value = cliente.departamento || '';
        document.getElementById('clientInscripcion').value = cliente.inscripcion || '';
        document.getElementById('clientNroDocumento').value = cliente.nroDocumento || '';
        document.getElementById('clientDireccion').value = cliente.direccion || '';
        document.getElementById('clientCiudad').value = cliente.ciudad || '';
        document.getElementById('clientProvincia').value = cliente.provincia || '';
        document.getElementById('clientPais').value = cliente.pais || '';
        document.getElementById('clientTelefono').value = cliente.telefono || '';
        document.getElementById('clientEmail').value = cliente.email || '';
        document.getElementById('clientSaldoCredito').value = cliente.saldoCredito || 0;

        openModal('addClientModal');

      } catch (error) {
        console.error('❌ Error cargando cliente:', error);
        alert('❌ Error cargando cliente: ' + error.message);
      }
    }

    async function saveCliente(event) {
      event.preventDefault();

      if (!firebase || !firebase.firestore) {
        alert('❌ Firebase no está disponible');
        return;
      }

      try {
        const saldoCreditoValue = document.getElementById('clientSaldoCredito').value.trim();

        const clienteData = {
          codigo: document.getElementById('clientCodigo').value.trim(),
          nombre: document.getElementById('clientNombre').value.trim(),
          nombreComercial: document.getElementById('clientNombreComercial').value.trim(),
          grupo: document.getElementById('clientGrupo').value.trim(),
          departamento: document.getElementById('clientDepartamento').value.trim(),
          inscripcion: document.getElementById('clientInscripcion').value.trim(),
          nroDocumento: document.getElementById('clientNroDocumento').value.trim(),
          direccion: document.getElementById('clientDireccion').value.trim(),
          ciudad: document.getElementById('clientCiudad').value.trim(),
          provincia: document.getElementById('clientProvincia').value.trim(),
          pais: document.getElementById('clientPais').value.trim(),
          telefono: document.getElementById('clientTelefono').value.trim(),
          email: document.getElementById('clientEmail').value.trim(),
          saldoCredito: saldoCreditoValue ? parseFloat(saldoCreditoValue) : 0
        };

        if (!clienteData.codigo) {
          alert('⚠️ El código es requerido');
          return;
        }

        if (!clienteData.nombre) {
          alert('⚠️ El nombre es requerido');
          return;
        }

        const { doc, setDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clienteData.codigo);
        await setDoc(clienteRef, clienteData);

        console.log(`✅ Cliente ${clienteData.codigo} guardado`);
        alert(currentEditingClienteId ? '✅ Cliente actualizado correctamente' : '✅ Cliente agregado correctamente');

        // Close modal and reload
        closeModal('addClientModal');
        loadClientes();

      } catch (error) {
        console.error('❌ Error guardando cliente:', error);
        alert('❌ Error guardando cliente: ' + error.message);
      }
    }

    window.openAddClientModal = openAddClientModal;
    window.saveCliente = saveCliente;

    async function deleteCliente(clienteId) {
      if (!confirm('⚠️ ¿Estás seguro de eliminar este cliente?')) {
        return;
      }

      if (!firebase || !firebase.firestore) {
        alert('❌ Firebase no está disponible');
        return;
      }

      try {
        const { doc, deleteDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clienteId);
        await deleteDoc(clienteRef);

        console.log(`✅ Cliente ${clienteId} eliminado`);
        alert('✅ Cliente eliminado correctamente');

        // Reload clientes
        loadClientes();

      } catch (error) {
        console.error('❌ Error eliminando cliente:', error);
        alert('❌ Error eliminando cliente: ' + error.message);
      }
    }

    // Expose functions globally
    window.loadClientes = loadClientes;
    window.importClientes = importClientes;
    window.exportClientes = exportClientes;
    window.editCliente = editCliente;
    window.deleteCliente = deleteCliente;

    // === PROFILE FUNCTIONALITY ===
    async function loadUserProfile() {
      try {
        // Show current user email
        const user = firebase.auth().currentUser;
        if (user) {
          document.getElementById('profileUserEmail').textContent = user.email;
        }

        // Load profile data from Firebase usuarios collection
        if (user) {
          const { doc, getDoc } = firebase.firestoreHelpers;
          const db = firebase.firestore();
          const userRef = doc(db, 'usuarios', user.uid);
          const docSnap = await getDoc(userRef);

          if (docSnap.exists()) {
            const userData = docSnap.data();
            document.getElementById('profileName').value = userData.name || userData.displayName || '';
            document.getElementById('profileAddress').value = userData.address || '';
            document.getElementById('profilePhone').value = userData.phone || '';
            document.getElementById('profileContactPhone').value = userData.contactPhone || '';
          } else {
            // Initialize empty profile
            clearProfileFields();
          }
        }
      } catch (error) {
        console.error('❌ Error loading profile:', error);
      }
    }

    async function saveUserProfile() {
      try {
        const user = firebase.auth().currentUser;
        if (!user) {
          alert('Debes estar autenticado para guardar el perfil');
          return;
        }

        const profileData = {
          name: document.getElementById('profileName').value.trim(),
          address: document.getElementById('profileAddress').value.trim(),
          phone: document.getElementById('profilePhone').value.trim(),
          contactPhone: document.getElementById('profileContactPhone').value.trim(),
          updatedAt: new Date()
        };

        // Validation
        if (!profileData.name) {
          alert('El nombre es obligatorio');
          return;
        }

        const { doc, setDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();
        const userRef = doc(db, 'usuarios', user.uid);

        await setDoc(userRef, profileData, { merge: true });

        console.log('✅ Profile saved successfully');
        alert('Perfil guardado exitosamente!');

      } catch (error) {
        console.error('❌ Error saving profile:', error);
        alert('Error guardando el perfil. Inténtalo de nuevo.');
      }
    }

    function clearProfileFields() {
      document.getElementById('profileName').value = '';
      document.getElementById('profileAddress').value = '';
      document.getElementById('profilePhone').value = '';
      document.getElementById('profileContactPhone').value = '';
    }

    function clearUserProfile() {
      if (confirm('¿Estás seguro de que deseas limpiar todos los datos del perfil?')) {
        clearProfileFields();
        console.log('🗑️ Profile fields cleared');
      }
    }

    // === HAMBURGER MENU FUNCTIONALITY (Simplified) ===
    let menuOpen = false;

    function toggleMenu() {
      console.log('🍔 toggleMenu called, current state:', menuOpen);
      const slideMenu = document.getElementById('slideMenu');
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      
      if (!slideMenu || !hamburgerBtn) {
        console.log('❌ Menu elements not found');
        return;
      }
      
      menuOpen = !menuOpen;
      console.log('🍔 New menu state:', menuOpen);
      
      if (menuOpen) {
        slideMenu.classList.add('active');
        hamburgerBtn.classList.add('active');
        console.log('✅ Menu opened');
      } else {
        slideMenu.classList.remove('active');
        hamburgerBtn.classList.remove('active');
        console.log('❌ Menu closed');
      }
    }

    function closeMenu() {
      if (menuOpen) {
        toggleMenu();
      }
    }

    // Funciones para abrir modales
    function openModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
      if (modalId === 'statsModal') {
        updateStats();
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    function closeAllModals() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.add('hidden');
      });
    }

    // Función para actualizar estadísticas en el modal
    function updateStats() {
      // Último refresco
      const lastRefresh = localStorage.getItem('lastRefreshTime');
      const lastRefreshStat = document.getElementById('lastRefreshStat');
      if (lastRefreshStat) {
        lastRefreshStat.textContent = lastRefresh ? 
          new Date(lastRefresh).toLocaleTimeString() : 'Nunca';
      }
      
      // Items en carrito
      const cartData = localStorage.getItem('cart');
      const cartItemsStat = document.getElementById('cartItemsStat');
      if (cartItemsStat) {
        const cart = cartData ? JSON.parse(cartData) : [];
        cartItemsStat.textContent = cart.length;
      }

      // Total productos (desde la tabla actual si está disponible)
      const totalProductsStat = document.getElementById('totalProductsStat');
      if (totalProductsStat) {
        const tbody = document.getElementById('tbody');
        if (tbody) {
          const visibleRows = tbody.querySelectorAll('tr:not([style*="display: none"])');
          totalProductsStat.textContent = visibleRows.length;
        } else {
          totalProductsStat.textContent = '0';
        }
      }
    }

    // Setup cuando cargue la página
    document.addEventListener('DOMContentLoaded', function() {
      console.log('📱 Setting up simple menu');
      
      // Verificar estado de Firebase
      checkFirebaseStatus();
      
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      if (hamburgerBtn) {
        hamburgerBtn.addEventListener('click', toggleMenu);
        console.log('✅ Click handler added');
      }
      
      // Cerrar menú con overlay
      const slideMenuOverlay = document.getElementById('slideMenuOverlay');
      if (slideMenuOverlay) {
        slideMenuOverlay.addEventListener('click', closeMenu);
      }
      
      // Cerrar con botón X
      const closeMenuBtn = document.getElementById('closeMenuBtn');
      if (closeMenuBtn) {
        closeMenuBtn.addEventListener('click', closeMenu);
      }
      
      // Botón guardar configuración
      const saveConfigBtn = document.getElementById('saveConfigBtn');
      if (saveConfigBtn) {
        saveConfigBtn.addEventListener('click', saveConfigFromInputs);
        console.log('✅ Save config handler added');
      }

      // Botones del perfil
      const saveProfileBtn = document.getElementById('saveProfileBtn');
      if (saveProfileBtn) {
        saveProfileBtn.addEventListener('click', saveUserProfile);
        console.log('✅ Save profile handler added');
      }

      const clearProfileBtn = document.getElementById('clearProfileBtn');
      if (clearProfileBtn) {
        clearProfileBtn.addEventListener('click', clearUserProfile);
        console.log('✅ Clear profile handler added');
      }

      // Botones del menú para abrir modales
      const configModalBtn = document.getElementById('configModalBtn');
      if (configModalBtn) {
        configModalBtn.addEventListener('click', function() {
          closeMenu();
          openModal('configModal');
        });
        console.log('✅ Config modal button handler added');
      }

      const statsModalBtn = document.getElementById('statsModalBtn');
      if (statsModalBtn) {
        statsModalBtn.addEventListener('click', function() {
          closeMenu();
          openModal('statsModal');
          // Load advanced statistics when stats modal opens
          setTimeout(() => {
            if (window.updateAdvancedStats) {
              window.updateAdvancedStats();
            } else {
              console.log('⚠️ updateAdvancedStats not available yet, retrying...');
              setTimeout(() => window.updateAdvancedStats && window.updateAdvancedStats(), 500);
            }
          }, 100);
        });
        console.log('✅ Stats modal button handler added');
      }

      const profileModalBtn = document.getElementById('profileModalBtn');
      if (profileModalBtn) {
        profileModalBtn.addEventListener('click', function() {
          closeMenu();
          openModal('profileModal');
          loadUserProfile();
        });
        console.log('✅ Profile modal button handler added');
      }

      const historialModalBtn = document.getElementById('historialModalBtn');
      if (historialModalBtn) {
        historialModalBtn.addEventListener('click', function() {
          closeMenu();
          openModal('historialModal');
          loadHistorial();
        });
        console.log('✅ Historial modal button handler added');
      }

      const clientesModalBtn = document.getElementById('clientesModalBtn');
      if (clientesModalBtn) {
        clientesModalBtn.addEventListener('click', function() {
          closeMenu();
          openModal('clientesModal');
          loadClientes();
        });
        console.log('✅ Clientes modal button handler added');
      }

      // Client form submit handler
      const clientForm = document.getElementById('clientForm');
      if (clientForm) {
        clientForm.addEventListener('submit', saveCliente);
        console.log('✅ Client form submit handler added');
      }

      const logisticsModalBtn = document.getElementById('logisticsModalBtn');
      if (logisticsModalBtn) {
        logisticsModalBtn.addEventListener('click', function() {
          closeMenu();
          openModal('logisticsModal');
          // Load orders when logistics modal opens
          setTimeout(() => {
            if (window.loadLogisticsOrders) {
              window.loadLogisticsOrders();
            } else {
              console.log('⚠️ loadLogisticsOrders not available yet, retrying...');
              setTimeout(() => window.loadLogisticsOrders && window.loadLogisticsOrders(), 500);
            }
          }, 100);
        });
        console.log('✅ Logistics modal button handler added');
      }

      const menuLogoutBtn = document.getElementById('menuLogoutBtn');
      if (menuLogoutBtn) {
        menuLogoutBtn.addEventListener('click', function() {
          closeMenu();
          console.log('🚪 Cerrando sesión desde menu...');

          if (typeof firebase !== 'undefined' && firebase.auth()) {
            // Cerrar sesión en Firebase
            firebase.authHelpers.signOut(firebase.auth()).then(() => {
              console.log('✅ Sesión cerrada en Firebase');

              // Limpiar datos de localStorage
              localStorage.removeItem('userAuthenticated');
              localStorage.removeItem('userEmail');
              localStorage.removeItem('userDisplayName');
              localStorage.removeItem('userPhotoURL');
              localStorage.removeItem('cart');

              console.log('🧹 localStorage limpiado');

              // Redirigir al login
              window.location.href = 'login.html';
            }).catch((error) => {
              console.error('❌ Error cerrando sesión:', error);
              // Redirigir de todas formas
              window.location.href = 'login.html';
            });
          } else {
            // Limpiar localStorage y redirigir
            localStorage.removeItem('userAuthenticated');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userDisplayName');
            localStorage.removeItem('userPhotoURL');
            localStorage.removeItem('cart');
            window.location.href = 'login.html';
          }
        });
        console.log('✅ Menu logout button handler added');
      }

      const menuVersionBtn = document.getElementById('menuVersionBtn');
      if (menuVersionBtn) {
        menuVersionBtn.addEventListener('click', function() {
          closeMenu();
          openModal('changelogModal');
        });
        console.log('✅ Menu version button handler added');
      }

      const adminBtn = document.getElementById('adminBtn');
      if (adminBtn) {
        adminBtn.addEventListener('click', function() {
          closeMenu();
          window.location.href = 'Administration.html';
        });
        console.log('✅ Admin button handler added');
      }


      const exportHistorialBtn = document.getElementById('exportHistorialBtn');
      if (exportHistorialBtn) {
        exportHistorialBtn.addEventListener('click', exportHistorial);
        console.log('✅ Export historial button handler added');
      }

      const importClientesBtn = document.getElementById('importClientesBtn');
      if (importClientesBtn) {
        importClientesBtn.addEventListener('click', importClientes);
        console.log('✅ Import clientes button handler added');
      }

      const exportClientesBtn = document.getElementById('exportClientesBtn');
      if (exportClientesBtn) {
        exportClientesBtn.addEventListener('click', exportClientes);
        console.log('✅ Export clientes button handler added');
      }

      const excelFileInput = document.getElementById('excelFileInput');
      if (excelFileInput) {
        excelFileInput.addEventListener('change', handleExcelImport);
        console.log('✅ Excel file input handler added');
      }

      // Cerrar modales con botón X
      document.querySelectorAll('.close-button').forEach(button => {
        button.addEventListener('click', function() {
          const modal = this.closest('.modal');
          if (modal) {
            modal.classList.add('hidden');
          }
        });
      });

      // Cerrar modales al hacer click fuera
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.classList.add('hidden');
          }
        });
      });

      // Cerrar modales con tecla Escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeAllModals();
        }
      });
      
      // Cerrar con Escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && menuOpen) {
          closeMenu();
        }
      });
      
      // Cargar configuración cuando el usuario se autentique
      if (typeof firebase !== 'undefined' && firebase.auth) {
        // Importar onAuthStateChanged dentro del callback
        setTimeout(() => {
          if (window.firebase && window.firebase.firestoreHelpers) {
            firebase.auth().onAuthStateChanged(async function(user) {
              if (user) {
                console.log('👤 Usuario autenticado, verificando permisos...');
                await checkUserPermissions(user);
                console.log('👤 Usuario autenticado, cargando configuración...');
                loadConfig();

                // Load prices from Firebase for marketplace
                console.log('💰 Cargando precios desde Firebase para marketplace...');
                if (window.loadPricesFromFirebase) {
                  await window.loadPricesFromFirebase();
                  console.log('✅ Precios cargados en marketplace');

                  // Refresh view to show prices
                  if (window.renderRows) {
                    window.renderRows();
                    console.log('🔄 Vista actualizada con precios de Firebase');
                  }
                } else {
                  console.log('⚠️ loadPricesFromFirebase no disponible aún');
                }
              } else {
                // Redirect to login if not authenticated
                console.log('🔒 Usuario no autenticado, redirigiendo a login...');
                window.location.href = 'login.html';
              }
            });
          }
        }, 1000); // Esperar a que Firebase se cargue completamente
      }
      
      // Old logout button removed - now in hamburger menu
      
      console.log('✅ Menu setup complete');
    });
  </script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, orderBy, limit, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    // Firebase Storage removed - using only Firestore for photos

    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCXjSGtVGfQas_cEyjmI0RTaeEl94jdp6g",
      authDomain: "carrito-138c3.firebaseapp.com",
      projectId: "carrito-138c3",
      storageBucket: "carrito-138c3.appspot.com",
      messagingSenderId: "579670725719",
      appId: "1:579670725719:web:carrito138c3"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    console.log('🔥 Firebase inicializado en marketplace.html (solo Auth y Firestore)');

    // Hacer Firebase disponible globalmente
    window.firebase = {
      app: () => app,
      auth: () => auth,
      firestore: () => db,
      // Funciones de Firestore que necesitamos
      firestoreHelpers: {
        doc,
        getDoc,
        setDoc,
        updateDoc,
        collection,
        query,
        where,
        orderBy,
        limit,
        getDocs,
        deleteDoc
      },
      // Storage helpers removed - using only Firestore
      // Funciones de Auth que necesitamos
      authHelpers: {
        signOut
      }
    };
    
    console.log('✅ Firebase disponible globalmente');

    // === HELPER FUNCTIONS ===

    // Formatear números con separadores de miles
    function formatNumber(num) {
      return new Intl.NumberFormat('es-AR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    // Enviar orden al vendedor por WhatsApp
    async function sendOrderToSellerWhatsApp(orderData, orderNumber, clienteNombre) {
      try {
        console.log('📱 [WhatsApp] Iniciando envío...');
        console.log('📱 [WhatsApp] orderData.vendedorId:', orderData.vendedorId);
        console.log('📱 [WhatsApp] orderNumber:', orderNumber);
        console.log('📱 [WhatsApp] clienteNombre:', clienteNombre);

        const { doc, getDoc, collection, query, where, getDocs } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();

        let vendedorData = null;
        let vendedorId = orderData.vendedorId;

        // Si no hay vendedor asignado, buscar a Santiago como vendedor por defecto
        if (!vendedorId) {
          console.log('⚠️ [WhatsApp] No hay vendedor asignado, buscando a Santiago Fernandez...');
          const vendedoresRef = collection(db, 'vendedores');
          const q = query(vendedoresRef, where('email', '==', 'santifn.axp@gmail.com'));
          const querySnapshot = await getDocs(q);

          if (!querySnapshot.empty) {
            const santiagoDoc = querySnapshot.docs[0];
            vendedorId = santiagoDoc.id;
            vendedorData = santiagoDoc.data();
            console.log('✅ [WhatsApp] Santiago Fernandez encontrado como vendedor por defecto:', vendedorId);
          } else {
            console.log('❌ [WhatsApp] No se encontró a Santiago Fernandez (santifn.axp@gmail.com) en la BD');
            return;
          }
        } else {
          console.log('📱 [WhatsApp] Buscando vendedor:', vendedorId);
          const vendedorRef = doc(db, 'vendedores', vendedorId);
          const vendedorDoc = await getDoc(vendedorRef);

          if (!vendedorDoc.exists()) {
            console.log('⚠️ [WhatsApp] Vendedor no encontrado en BD');
            return;
          }

          vendedorData = vendedorDoc.data();
        }

        console.log('📱 [WhatsApp] Vendedor encontrado:', vendedorData.name);
        console.log('📱 [WhatsApp] Teléfonos:', { phone: vendedorData.phone, phone2: vendedorData.phone2 });

        // Obtener ambos teléfonos del vendedor
        const phones = [];
        if (vendedorData.phone || vendedorData.telefono) {
          phones.push((vendedorData.phone || vendedorData.telefono).replace(/\D/g, ''));
        }
        if (vendedorData.phone2) {
          phones.push(vendedorData.phone2.replace(/\D/g, ''));
        }

        console.log('📱 [WhatsApp] Teléfonos procesados:', phones);

        if (phones.length === 0) {
          console.log('⚠️ [WhatsApp] Vendedor sin teléfono válido');
          return;
        }

        // Construir mensaje
        let mensaje = `🔄 *ORDEN MODIFICADA #${orderNumber}*\n\n`;
        mensaje += `👤 *Cliente:* ${clienteNombre}\n`;
        mensaje += `📧 *Email:* ${orderData.clienteEmail || orderData.usuarioEmail}\n`;
        if (orderData.editadaPorNombre) {
          mensaje += `✏️ *Modificada por:* ${orderData.editadaPorNombre}\n`;
        }
        mensaje += `📅 *Fecha:* ${orderData.fechaLocal || new Date().toLocaleString('es-AR')}\n\n`;
        mensaje += `📦 *Productos (${orderData.cantidadItems || orderData.items?.length || 0}):*\n`;

        if (orderData.items && orderData.items.length > 0) {
          orderData.items.forEach((item, index) => {
            mensaje += `${index + 1}. ${item.description || item.articulo}\n`;
            mensaje += `   Cantidad: ${item.quantity} x ${formatNumber(item.price)}\n`;
          });
        }

        mensaje += `\n💰 *TOTAL: ${formatNumber(orderData.total)}*\n\n`;

        // Enviar WhatsApp a todos los teléfonos del vendedor
        console.log('📱 [WhatsApp] Preparando para enviar a', phones.length, 'teléfono(s)');

        phones.forEach((phone, index) => {
          const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(mensaje)}`;
          console.log(`📱 [WhatsApp] URL ${index + 1}:`, whatsappUrl.substring(0, 100) + '...');

          // Pequeño delay entre aperturas para evitar que se bloqueen
          setTimeout(() => {
            console.log(`📱 [WhatsApp] Abriendo ventana ${index + 1}/${phones.length} para ${phone}`);
            window.open(whatsappUrl, '_blank');
            console.log(`✅ [WhatsApp] Ventana ${index + 1}/${phones.length} abierta para ${phone}`);
          }, index * 500);
        });

        console.log(`✅ [WhatsApp] Proceso completado - ${phones.length} teléfono(s)`);

      } catch (error) {
        console.error('❌ Error enviando WhatsApp:', error);
      }
    }

    // === LOGISTICS FUNCTIONALITY ===

    // Load logistics orders from Firebase
    async function loadLogisticsOrders() {
      if (!firebase || !firebase.auth().currentUser) {
        console.log('⚠️ No user authenticated for logistics');
        return;
      }

      try {
        const { collection, query, orderBy, getDocs, updateDoc, doc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const pedidosCollection = collection(db, 'pedidos');
        const q = query(pedidosCollection, orderBy('timestamp', 'desc'));
        const querySnapshot = await getDocs(q);

        const orders = [];
        const updatePromises = [];

        querySnapshot.forEach(docSnapshot => {
          const data = docSnapshot.data();

          // Check if logisticsState exists, if not, set it to 'borrador'
          if (!data.logisticsState) {
            console.log(`🔄 Setting logisticsState to 'borrador' for order ${docSnapshot.id}`);
            const orderRef = doc(db, 'pedidos', docSnapshot.id);
            updatePromises.push(updateDoc(orderRef, { logisticsState: 'borrador' }));
          }

          // Check if timestamp exists, if not, use fecha or create new timestamp
          if (!data.timestamp) {
            console.log(`🔄 Setting timestamp for order ${docSnapshot.id}`);
            const orderRef = doc(db, 'pedidos', docSnapshot.id);
            const timestampValue = data.fecha || new Date();
            updatePromises.push(updateDoc(orderRef, { timestamp: timestampValue }));
          }

          orders.push({
            id: docSnapshot.id,
            ...data,
            logisticsState: data.logisticsState || 'borrador', // Default state
            timestamp: data.timestamp || data.fecha || new Date() // Use fecha as fallback
          });
        });

        // Update orders that don't have logisticsState
        if (updatePromises.length > 0) {
          await Promise.all(updatePromises);
          console.log(`✅ Updated ${updatePromises.length} orders with logisticsState`);
        }

        console.log('📦 Loaded', orders.length, 'logistics orders');

        // Guardar en cache para el modal de detalles
        allOrdersCache = orders;

        displayLogisticsOrders(orders);

      } catch (error) {
        console.error('❌ Error loading logistics orders:', error);
      }
    }

    // Display orders in their respective sections
    function displayLogisticsOrders(orders) {
      const containers = {
        borrador: document.getElementById('borradorOrders'),
        revision: document.getElementById('revisionOrders'),
        aprobada: document.getElementById('aprobadaOrders'),
        preparacion: document.getElementById('preparacionOrders'),
        listo: document.getElementById('listoOrders'),
        despachada: document.getElementById('despachadaOrders'),
        entregada: document.getElementById('entregadaOrders'),
        cerrada: document.getElementById('cerradaOrders'),
        cancelada: document.getElementById('canceladaOrders')
      };

      // Check if all containers exist
      const missingContainers = Object.entries(containers).filter(([key, val]) => !val).map(([key]) => key);
      if (missingContainers.length > 0) {
        console.warn('⚠️ Seguimiento containers not found:', missingContainers);
        return;
      }

      // Define state flow: current state -> next state (null = final state)
      const stateFlow = {
        borrador: 'revision',
        revision: 'aprobada',
        aprobada: 'preparacion',
        preparacion: 'listo',
        listo: 'despachada',
        despachada: 'entregada',
        entregada: 'cerrada',
        cerrada: null,
        cancelada: null
      };

      // Separate orders by state
      const ordersByState = {
        borrador: orders.filter(order => order.logisticsState === 'borrador'),
        revision: orders.filter(order => order.logisticsState === 'revision'),
        aprobada: orders.filter(order => order.logisticsState === 'aprobada'),
        preparacion: orders.filter(order => order.logisticsState === 'preparacion'),
        listo: orders.filter(order => order.logisticsState === 'listo'),
        despachada: orders.filter(order => order.logisticsState === 'despachada'),
        entregada: orders.filter(order => order.logisticsState === 'entregada'),
        cerrada: orders.filter(order => order.logisticsState === 'cerrada'),
        cancelada: orders.filter(order => order.logisticsState === 'cancelada')
      };

      // Display orders in each section
      Object.entries(ordersByState).forEach(([state, stateOrders]) => {
        const container = containers[state];
        const nextState = stateFlow[state];

        if (stateOrders.length > 0) {
          container.innerHTML = stateOrders.map(order => createOrderHTML(order, nextState, state)).join('');
        } else {
          const messages = {
            borrador: 'No hay pedidos en borrador',
            revision: 'No hay pedidos en revisión',
            aprobada: 'No hay pedidos aprobados',
            preparacion: 'No hay pedidos en preparación',
            listo: 'No hay pedidos listos',
            despachada: 'No hay pedidos despachados',
            entregada: 'No hay pedidos entregados',
            cerrada: 'No hay pedidos cerrados',
            cancelada: 'No hay pedidos cancelados'
          };
          container.innerHTML = `<p class="no-orders">${messages[state]}</p>`;
        }
      });

      // Add event listeners to all order items using event delegation
      Object.values(containers).forEach(container => {
        container.addEventListener('click', (e) => {
          const orderItem = e.target.closest('.order-item');
          if (orderItem && !e.target.closest('button')) {
            const orderId = orderItem.getAttribute('data-order-id');
            if (orderId) {
              showOrderDetails(orderId);
            }
          }
        });
      });
    }

    // Create HTML for an order item
    function createOrderHTML(order, nextState, currentState) {
      const isAdmin = window.isUserAdmin || false;
      let buttonHtml = '';

      const stateLabels = {
        borrador: 'Borrador',
        revision: 'En Revisión',
        aprobada: 'Aprobada',
        preparacion: 'En Preparación',
        listo: 'Listo para Retiro/Despacho',
        despachada: 'Despachada',
        entregada: 'Entregada',
        cerrada: 'Cerrada',
        cancelada: 'Cancelada'
      };

      // Define state flows for bidirectional movement
      const stateFlow = {
        borrador: { next: 'revision', prev: null },
        revision: { next: 'aprobada', prev: 'borrador' },
        aprobada: { next: 'preparacion', prev: 'revision' },
        preparacion: { next: 'listo', prev: 'aprobada' },
        listo: { next: 'despachada', prev: 'preparacion' },
        despachada: { next: 'entregada', prev: 'listo' },
        entregada: { next: 'cerrada', prev: 'despachada' },
        cerrada: { next: null, prev: 'entregada' },
        cancelada: { next: null, prev: 'entregada' }
      };

      const currentFlow = stateFlow[currentState];
      const hasNext = currentFlow && currentFlow.next !== null;
      const hasPrev = currentFlow && currentFlow.prev !== null;

      // Solo mostrar botones de cambio de estado si el usuario es admin
      if (isAdmin) {
        // Flecha hacia arriba (volver al estado anterior) - solo permitido en estado "revision"
        if (hasPrev && currentState === 'revision') {
          const prevStateLabel = stateLabels[currentFlow.prev] || currentFlow.prev;
          buttonHtml += `<button class="move-order-btn-up" onclick="moveOrder('${order.id}', '${currentFlow.prev}')" title="Volver a ${prevStateLabel}">↑</button>`;
        }

        // Flecha hacia abajo (avanzar al siguiente estado) y/o botón de foto
        if (hasNext) {
          const nextStateLabel = stateLabels[currentFlow.next] || currentFlow.next;

          // Special handling for despachada -> entregada: show both arrow and photo button
          if (currentFlow.next === 'entregada') {
            // Mostrar flecha abajo para avanzar directamente sin foto
            buttonHtml += `<button class="move-order-btn" onclick="moveOrder('${order.id}', 'entregada')" title="Mover a ${nextStateLabel}">↓</button>`;
            // Mostrar botón de foto para entregar con foto
            buttonHtml += `<button class="move-order-btn-photo" onclick="initiateDelivery('${order.id}')" title="Marcar como Entregado con Foto">📸</button>`;
          } else {
            buttonHtml += `<button class="move-order-btn" onclick="moveOrder('${order.id}', '${currentFlow.next}')" title="Mover a ${nextStateLabel}">↓</button>`;
          }
        }

        // Add cancel button for non-cancelled and non-closed orders
        if (currentState !== 'cancelada' && currentState !== 'cerrada') {
          buttonHtml += `<button class="cancel-order-btn" onclick="moveOrder('${order.id}', 'cancelada')" title="Cancelar pedido">❌</button>`;
        }
      } else {
        // Para usuarios no-admin, mostrar estado actual sin botones
        if (currentState === 'entregada') {
          // Show photo button for entregada state
          const photoViewBtn = order.deliveryPhoto ?
            `<button class="view-photo-btn" onclick="viewDeliveryPhoto('${order.id}')" title="Ver foto de entrega">📸</button>` : '';
          buttonHtml = `<div class="order-actions">
            <span class="delivered-status">✓ Entregada</span>
            ${photoViewBtn}
          </div>`;
        } else if (currentState === 'cerrada') {
          buttonHtml = `<span class="closed-status">🔒 Cerrada</span>`;
        } else if (currentState === 'cancelada') {
          buttonHtml = `<span class="cancelled-status">❌ Cancelada</span>`;
        } else {
          buttonHtml = `<span class="current-status">📋 ${stateLabels[currentState]}</span>`;
        }
      }

      // Agregar indicador de edición si existe
      let orderNumberDisplay = `#${order.numeroOrden || order.id.slice(-6)}`;
      if (order.editadaPor && order.editadaPorNombre) {
        orderNumberDisplay += ` <span style="color: #FF9800; font-size: 0.85em;">(editada por ${order.editadaPorNombre})</span>`;
      }

      return `
        <div class="order-item" data-order-id="${order.id}">
          <div class="order-info">
            <div class="order-number">${orderNumberDisplay}</div>
            <div class="order-details">
              ${order.fechaLocal || 'No date'} • ${order.cantidadItems || order.items?.length || 0} items • $${formatNumber(order.total || 0)}
            </div>
          </div>
          <div class="order-actions" onclick="event.stopPropagation()">
            ${buttonHtml}
          </div>
        </div>
      `;
    }

    // Move order to next state
    async function moveOrder(orderId, nextState) {
      // Verificar que el usuario sea admin
      if (!window.isUserAdmin) {
        alert('⚠️ No tienes permisos para mover órdenes');
        console.log('🚫 Usuario no-admin intentó mover orden');
        return;
      }

      if (!firebase || !firebase.firestore) {
        console.error('❌ Firebase not available');
        return;
      }

      try {
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', orderId);
        await updateDoc(orderRef, {
          logisticsState: nextState,
          lastStateUpdate: new Date()
        });

        console.log(`✅ Order ${orderId} moved to ${nextState}`);

        // Reload orders to reflect changes
        loadLogisticsOrders();

      } catch (error) {
        console.error('❌ Error moving order:', error);
        alert('Error moving order. Please try again.');
      }
    }

    // === ADVANCED ANALYTICS FUNCTIONALITY ===

    // Show order details modal
    let allOrdersCache = [];

    async function showOrderDetails(orderId) {
      try {
        console.log('📋 Mostrando detalles de orden:', orderId);

        // Buscar la orden en el cache
        let order = allOrdersCache.find(o => o.id === orderId);

        // Si no está en cache, buscar en Firebase
        if (!order) {
          const { doc, getDoc } = firebase.firestoreHelpers;
          const db = firebase.firestore();
          const orderRef = doc(db, 'pedidos', orderId);
          const orderDoc = await getDoc(orderRef);

          if (orderDoc.exists()) {
            order = { id: orderDoc.id, ...orderDoc.data() };
          } else {
            alert('Orden no encontrada');
            return;
          }
        }

        // Mapeo de estados
        const stateLabels = {
          borrador: 'Borrador',
          revision: 'En Revisión',
          aprobada: 'Aprobada',
          preparacion: 'En Preparación',
          listo: 'Listo para Retiro/Despacho',
          despachada: 'Despachada',
          entregada: 'Entregada',
          cerrada: 'Cerrada',
          cancelada: 'Cancelada'
        };

        // Llenar información general
        let orderNumberText = `#${order.numeroOrden || order.id.slice(-6)}`;
        if (order.editadaPor && order.editadaPorNombre) {
          orderNumberText += ` <span style="color: #FF9800; font-size: 0.85em;">(editada por ${order.editadaPorNombre})</span>`;
        }
        document.getElementById('detailOrderNumber').innerHTML = orderNumberText;
        document.getElementById('detailClientName').textContent = order.clienteNombre || order.usuarioEmail || '-';
        document.getElementById('detailClientEmail').textContent = order.clienteEmail || order.usuarioEmail || '-';
        document.getElementById('detailOrderDate').textContent = order.fechaLocal || '-';
        document.getElementById('detailOrderState').textContent = stateLabels[order.logisticsState] || order.logisticsState || 'Sin estado';

        // Mostrar si fue creada por admin
        if (order.creadoPorAdmin) {
          document.getElementById('detailAdminCreatedContainer').style.display = 'grid';
          document.getElementById('detailAdminCreated').textContent = order.usuarioEmail || '-';
        } else {
          document.getElementById('detailAdminCreatedContainer').style.display = 'none';
        }

        // Llenar tabla de items con campos editables
        const itemsTableBody = document.getElementById('detailOrderItems');
        itemsTableBody.innerHTML = '';

        // Declarar hasChanges en el scope de la función
        let hasChanges = false;
        const originalItems = order.items ? JSON.parse(JSON.stringify(order.items)) : [];

        if (order.items && order.items.length > 0) {
          order.items.forEach((item, index) => {
            const row = document.createElement('tr');
            row.setAttribute('data-item-index', index);
            row.innerHTML = `
              <td>${item.articulo || '-'}</td>
              <td>${item.description || '-'}</td>
              <td style="text-align: center;">
                <input type="number"
                       class="editable-quantity"
                       value="${item.quantity || 0}"
                       min="0"
                       data-item-index="${index}"
                       data-price="${item.price || 0}">
              </td>
              <td style="text-align: right;">$${(item.price || 0).toFixed(2)}</td>
              <td class="item-subtotal" style="text-align: right;">$${(item.subtotal || 0).toFixed(2)}</td>
            `;
            itemsTableBody.appendChild(row);
          });

          // Agregar event listeners para actualizar subtotales y detectar cambios

          const quantityInputs = itemsTableBody.querySelectorAll('.editable-quantity');
          quantityInputs.forEach(input => {
            input.addEventListener('change', function() {
              const index = parseInt(this.getAttribute('data-item-index'));
              const price = parseFloat(this.getAttribute('data-price'));
              const quantity = parseInt(this.value) || 0;
              const subtotal = price * quantity;

              // Actualizar el item en el array
              order.items[index].quantity = quantity;
              order.items[index].subtotal = subtotal;

              // Actualizar subtotal en la fila
              const row = this.closest('tr');
              const subtotalCell = row.querySelector('.item-subtotal');
              subtotalCell.textContent = `$${subtotal.toFixed(2)}`;

              // Recalcular total
              const newTotal = order.items.reduce((sum, item) => sum + (item.subtotal || 0), 0);
              order.total = newTotal;
              document.getElementById('detailOrderTotal').textContent = `$${newTotal.toFixed(2)}`;

              // Detectar si hubo cambios
              hasChanges = true;
              const saveContainer = document.getElementById('detailSaveOrderContainer');
              if (saveContainer) {
                saveContainer.style.display = 'block';
              }
            });
          });
        } else {
          itemsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay items</td></tr>';
        }

        // Mostrar total
        document.getElementById('detailOrderTotal').textContent = `$${(order.total || 0).toFixed(2)}`;

        // Configurar botón Guardar
        const saveOrderContainer = document.getElementById('detailSaveOrderContainer');
        const saveOrderBtn = document.getElementById('detailSaveOrderBtn');

        // Ocultar botón Guardar inicialmente
        if (saveOrderContainer) {
          saveOrderContainer.style.display = 'none';
        }

        // Remover event listeners previos del botón Guardar
        if (saveOrderBtn) {
          const newSaveBtn = saveOrderBtn.cloneNode(true);
          saveOrderBtn.parentNode.replaceChild(newSaveBtn, saveOrderBtn);

          // Agregar nuevo event listener para Guardar
          newSaveBtn.addEventListener('click', async () => {
            try {
              console.log('💾 Guardando cambios en la orden...');

              const currentUser = firebase.auth().currentUser;
              if (!currentUser) {
                alert('❌ Debes estar autenticado para guardar cambios');
                return;
              }

              // Obtener email y nombre del usuario actual
              const userEmail = currentUser.email;
              let userName = userEmail;

              // Intentar obtener el nombre del vendedor desde Firestore
              try {
                const { doc, getDoc } = firebase.firestoreHelpers;
                const db = firebase.firestore();
                const userRef = doc(db, 'usuarios', currentUser.uid);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                  const userData = userDoc.data();
                  userName = userData.nombre || userData.email || userEmail;
                }
              } catch (e) {
                console.warn('⚠️ No se pudo obtener nombre de usuario:', e);
              }

              // Actualizar orden en Firebase con información de quién editó
              const { doc, updateDoc } = firebase.firestoreHelpers;
              const db = firebase.firestore();
              const orderRef = doc(db, 'pedidos', order.id);

              await updateDoc(orderRef, {
                items: order.items,
                total: order.total,
                editadaPor: currentUser.uid,
                editadaPorEmail: userEmail,
                editadaPorNombre: userName,
                fechaEdicion: new Date().toISOString(),
                fechaEdicionLocal: new Date().toLocaleString('es-AR')
              });

              console.log('✅ Orden guardada exitosamente');

              // Enviar WhatsApp al vendedor (si no hay vendedor, se usa Santiago por defecto)
              console.log('📱 Preparando WhatsApp para vendedor:', order.vendedorId || 'Santiago (por defecto)');
              const updatedOrderData = {
                ...order,
                editadaPorNombre: userName,
                cantidadItems: order.items?.length || 0
              };
              await sendOrderToSellerWhatsApp(updatedOrderData, order.numeroOrden, order.clienteNombre || order.clienteEmail || order.usuarioEmail);

              // Actualizar el número de orden con el indicador de edición
              let orderNumberText = `#${order.numeroOrden || order.id.slice(-6)}`;
              orderNumberText += ` <span style="color: #FF9800; font-size: 0.85em;">(editada por ${userName})</span>`;
              document.getElementById('detailOrderNumber').innerHTML = orderNumberText;

              // Ocultar botón Guardar
              saveOrderContainer.style.display = 'none';
              hasChanges = false;

              // Actualizar cache de órdenes
              const orderIndex = allOrdersCache.findIndex(o => o.id === order.id);
              if (orderIndex !== -1) {
                allOrdersCache[orderIndex] = { ...order, editadaPor: currentUser.uid, editadaPorNombre: userName };
              }

              // Recargar órdenes en seguimiento para reflejar cambios
              if (window.loadLogisticsOrders) {
                await loadLogisticsOrders();
              }

              alert('✅ Cambios guardados exitosamente');
            } catch (error) {
              console.error('❌ Error guardando cambios:', error);
              alert('❌ Error al guardar cambios. Por favor intenta nuevamente.');
            }
          });
        }

        // Mostrar botón "Seguir Comprando" en todos los estados
        const editOrderContainer = document.getElementById('detailEditOrderContainer');
        const editOrderBtn = document.getElementById('detailEditOrderBtn');

        // Siempre mostrar el botón
        editOrderContainer.style.display = 'block';

        // Remover event listeners previos
        const newEditBtn = editOrderBtn.cloneNode(true);
        editOrderBtn.parentNode.replaceChild(newEditBtn, editOrderBtn);

        // Agregar nuevo event listener
        newEditBtn.addEventListener('click', () => {
          editOrderInCart(order);
        });

        // Mostrar botón "Enviar WhatsApp" (siempre visible, usa Santiago si no hay vendedor)
        const whatsAppContainer = document.getElementById('detailSendWhatsAppContainer');
        const whatsAppBtn = document.getElementById('detailSendWhatsAppBtn');

        whatsAppContainer.style.display = 'block';

        // Remover event listeners previos
        const newWhatsAppBtn = whatsAppBtn.cloneNode(true);
        whatsAppBtn.parentNode.replaceChild(newWhatsAppBtn, whatsAppBtn);

        // Agregar event listener para enviar WhatsApp
        newWhatsAppBtn.addEventListener('click', async () => {
          console.log('📱 [Manual] Enviando WhatsApp...');
          const orderData = {
            ...order,
            cantidadItems: order.items?.length || 0
          };
          await sendOrderToSellerWhatsApp(orderData, order.numeroOrden, order.clienteNombre || order.clienteEmail || order.usuarioEmail);
        });

        // Agregar funcionalidad de ordenamiento a las columnas
        const sortableHeaders = document.querySelectorAll('#detailOrderTable .sortable-header');
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        sortableHeaders.forEach(header => {
          header.addEventListener('click', function() {
            const column = this.getAttribute('data-sort-column');

            // Si es la misma columna, cambiar dirección
            if (currentSortColumn === column) {
              currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
              currentSortColumn = column;
              currentSortDirection = 'asc';
            }

            // Remover clases de ordenamiento de todos los headers
            sortableHeaders.forEach(h => {
              h.classList.remove('sort-asc', 'sort-desc');
            });

            // Agregar clase de ordenamiento al header actual
            this.classList.add(`sort-${currentSortDirection}`);

            // Ordenar los items
            order.items.sort((a, b) => {
              let valueA, valueB;

              switch(column) {
                case 'articulo':
                  valueA = (a.articulo || '').toLowerCase();
                  valueB = (b.articulo || '').toLowerCase();
                  break;
                case 'description':
                  valueA = (a.description || '').toLowerCase();
                  valueB = (b.description || '').toLowerCase();
                  break;
                case 'quantity':
                  valueA = a.quantity || 0;
                  valueB = b.quantity || 0;
                  break;
                case 'price':
                  valueA = a.price || 0;
                  valueB = b.price || 0;
                  break;
                case 'subtotal':
                  valueA = a.subtotal || 0;
                  valueB = b.subtotal || 0;
                  break;
                default:
                  return 0;
              }

              if (valueA < valueB) return currentSortDirection === 'asc' ? -1 : 1;
              if (valueA > valueB) return currentSortDirection === 'asc' ? 1 : -1;
              return 0;
            });

            // Volver a renderizar la tabla
            itemsTableBody.innerHTML = '';
            order.items.forEach((item, index) => {
              const row = document.createElement('tr');
              row.setAttribute('data-item-index', index);
              row.innerHTML = `
                <td>${item.articulo || '-'}</td>
                <td>${item.description || '-'}</td>
                <td style="text-align: center;">
                  <input type="number"
                         class="editable-quantity"
                         value="${item.quantity || 0}"
                         min="0"
                         data-item-index="${index}"
                         data-price="${item.price || 0}">
                </td>
                <td style="text-align: right;">$${(item.price || 0).toFixed(2)}</td>
                <td class="item-subtotal" style="text-align: right;">$${(item.subtotal || 0).toFixed(2)}</td>
              `;
              itemsTableBody.appendChild(row);
            });

            // Re-agregar event listeners a los inputs de cantidad
            const quantityInputs = itemsTableBody.querySelectorAll('.editable-quantity');
            quantityInputs.forEach(input => {
              input.addEventListener('change', function() {
                const index = parseInt(this.getAttribute('data-item-index'));
                const price = parseFloat(this.getAttribute('data-price'));
                const quantity = parseInt(this.value) || 0;
                const subtotal = price * quantity;

                order.items[index].quantity = quantity;
                order.items[index].subtotal = subtotal;

                const row = this.closest('tr');
                const subtotalCell = row.querySelector('.item-subtotal');
                subtotalCell.textContent = `$${subtotal.toFixed(2)}`;

                const newTotal = order.items.reduce((sum, item) => sum + (item.subtotal || 0), 0);
                order.total = newTotal;
                document.getElementById('detailOrderTotal').textContent = `$${newTotal.toFixed(2)}`;
              });
            });
          });
        });

        // Mostrar modal
        document.getElementById('orderDetailsModal').style.display = 'block';

        // Inicializar botones MDC después de agregar al DOM
        setTimeout(() => {
          const mdcButtons = document.querySelectorAll('#orderDetailsModal .mdc-button');
          mdcButtons.forEach(button => {
            if (!button._mdcRipple) {
              mdc.ripple.MDCRipple.attachTo(button);
            }
          });
        }, 100);

      } catch (error) {
        console.error('❌ Error mostrando detalles de orden:', error);
        alert('Error al cargar detalles de la orden');
      }
    }

    // Editar orden en marketplace.html (volver a comprar)
    function editOrderInCart(order) {
      try {
        console.log('🛒 Cargando orden en carrito para editar:', order);

        // Guardar orden en localStorage primero
        const cartItems = order.items.map(item => ({
          item: item.articulo,
          description: item.description,
          price: item.price,
          quantity: item.quantity
        }));
        localStorage.setItem('cart', JSON.stringify(cartItems));
        localStorage.setItem('editingOrderId', order.id);
        console.log('💾 Orden guardada en localStorage:', cartItems.length, 'items');

        // Verificar si mappedStockData está disponible
        if (!window.mappedStockData || window.mappedStockData.length === 0) {
          console.log('⚠️ mappedStockData no disponible, recargando página para cargar productos...');

          // Cerrar el modal antes de recargar
          const modal = document.getElementById('orderDetailsModal');
          if (modal) modal.style.display = 'none';

          const logisticsModal = document.getElementById('logisticsModal');
          if (logisticsModal) logisticsModal.classList.add('hidden');

          // Recargar la página - el código de carga del carrito lo manejará
          window.location.reload();
          return;
        }

        // Si mappedStockData está disponible, cargar directamente
        console.log('✅ mappedStockData disponible, cargando productos...');

        // Limpiar selectedItems antes de cargar la orden
        if (window.selectedItems) {
          window.selectedItems.clear();
          console.log('🗑️ selectedItems limpiado');
        }

        // Cargar items directamente en selectedItems
        let loadedCount = 0;
        order.items.forEach(item => {
          console.log(`🔍 Cargando producto: "${item.articulo}" x${item.quantity}`);

          // Buscar el producto en mappedStockData
          const product = window.mappedStockData.find(p =>
            p.articulo === item.articulo ||
            p.articulo.trim() === item.articulo.trim() ||
            p.articulo.toLowerCase() === item.articulo.toLowerCase()
          );

          if (product && window.selectedItems) {
            window.selectedItems.set(item.articulo, {
              product: product,
              quantity: item.quantity
            });
            console.log(`✅ Producto cargado: ${item.articulo} x${item.quantity}`);
            loadedCount++;
          } else {
            console.warn(`⚠️ Producto no encontrado: ${item.articulo}`);
          }
        });

        console.log(`✅ Orden cargada: ${loadedCount}/${order.items.length} productos en selectedItems`);

        // Cerrar modales
        const orderModal = document.getElementById('orderDetailsModal');
        if (orderModal) orderModal.style.display = 'none';

        const logisticsModal = document.getElementById('logisticsModal');
        if (logisticsModal) logisticsModal.classList.add('hidden');

        // Re-renderizar la tabla para mostrar las cantidades
        if (window.renderRows) {
          console.log('🔄 Re-renderizando tabla con productos del carrito...');
          window.renderRows();
        }

        // Actualizar badge del carrito
        if (window.updateCartBadge) {
          window.updateCartBadge();
        }

        console.log('✅ Vista actualizada con productos de la orden');

      } catch (error) {
        console.error('❌ Error cargando orden en carrito:', error);
        alert('Error al cargar la orden en el carrito');
      }
    }

    // Cerrar modal de detalles
    const orderDetailsModal = document.getElementById('orderDetailsModal');
    if (orderDetailsModal) {
      const closeBtn = orderDetailsModal.querySelector('.order-details-close');
      if (closeBtn) {
        closeBtn.onclick = function() {
          orderDetailsModal.style.display = 'none';
        };
      }

      window.onclick = function(event) {
        if (event.target == orderDetailsModal) {
          orderDetailsModal.style.display = 'none';
        }
      };
    }

    // Calculate most purchased item from Firebase orders
    async function getMostPurchasedItem() {
      if (!firebase || !firebase.auth().currentUser) {
        return "No data";
      }

      try {
        const { collection, getDocs } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const pedidosCollection = collection(db, 'pedidos');
        const querySnapshot = await getDocs(pedidosCollection);

        const itemCounts = {};

        querySnapshot.forEach(doc => {
          const data = doc.data();
          if (data.items && Array.isArray(data.items)) {
            data.items.forEach(item => {
              const itemName = item.description || item.articulo || 'Unknown';
              const quantity = parseInt(item.quantity) || 1;
              itemCounts[itemName] = (itemCounts[itemName] || 0) + quantity;
            });
          }
        });

        const sortedItems = Object.entries(itemCounts).sort(([,a], [,b]) => b - a);

        if (sortedItems.length > 0) {
          const [itemName, count] = sortedItems[0];
          return `${itemName} (${count}x)`;
        }

        return "No purchases";
      } catch (error) {
        console.error('❌ Error calculating most purchased item:', error);
        return "Error loading data";
      }
    }

    // Calculate month with most sales from Firebase orders
    async function getBestSalesMonth() {
      if (!firebase || !firebase.auth().currentUser) {
        return "No data";
      }

      try {
        const { collection, getDocs } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const pedidosCollection = collection(db, 'pedidos');
        const querySnapshot = await getDocs(pedidosCollection);

        const monthlySales = {};

        querySnapshot.forEach(doc => {
          const data = doc.data();
          let orderDate = null;

          // Try to get date from different fields
          if (data.timestamp) {
            orderDate = new Date(data.timestamp);
          } else if (data.fecha) {
            orderDate = data.fecha.toDate ? data.fecha.toDate() : new Date(data.fecha);
          } else if (data.fechaLocal) {
            orderDate = new Date(data.fechaLocal);
          }

          if (orderDate && !isNaN(orderDate.getTime())) {
            const monthKey = `${orderDate.getFullYear()}-${String(orderDate.getMonth() + 1).padStart(2, '0')}`;
            const total = parseFloat(data.total) || 0;
            monthlySales[monthKey] = (monthlySales[monthKey] || 0) + total;
          }
        });

        const sortedMonths = Object.entries(monthlySales).sort(([,a], [,b]) => b - a);

        if (sortedMonths.length > 0) {
          const [monthKey, total] = sortedMonths[0];
          const [year, month] = monthKey.split('-');
          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          return `${monthNames[parseInt(month) - 1]} ${year} ($${Math.round(total)})`;
        }

        return "No sales data";
      } catch (error) {
        console.error('❌ Error calculating best sales month:', error);
        return "Error loading data";
      }
    }

    // Calculate item with most stock changes (theoretical stock variations)
    async function getMostStockChangesItem() {
      try {
        // Use the data that's already loaded in the table
        const tableRows = document.querySelectorAll('tbody tr:not(.totals-row)');

        if (tableRows.length === 0) {
          return "No data in table";
        }

        let maxItem = null;
        let maxStock = 0;

        tableRows.forEach(row => {
          // Get the cells from the current row
          const cells = row.querySelectorAll('td');
          if (cells.length === 0) return;

          // Try to find the description and theoretical stock columns
          // Assuming article is first column and stockTeorico is in the table
          let description = '';
          let theoreticalStock = 0;

          // Get description from first visible cell
          if (cells[0]) {
            description = cells[0].textContent.trim();
          }

          // Look for theoretical stock in the visible cells
          cells.forEach(cell => {
            const cellText = cell.textContent.trim();
            const cellValue = parseInt(cellText) || 0;

            // If this looks like a stock value (reasonable range)
            if (cellValue > theoreticalStock && cellValue < 100000) {
              theoreticalStock = cellValue;
            }
          });

          if (theoreticalStock > maxStock && description) {
            maxStock = theoreticalStock;
            maxItem = { description, theoreticalStock };
          }
        });

        if (maxItem && maxStock > 0) {
          return `${maxItem.description} (${maxStock})`;
        }

        // Fallback: try to access global data if table scan didn't work
        if (window.lastData && Array.isArray(window.lastData)) {
          let fallbackMaxItem = null;
          let fallbackMaxStock = 0;

          window.lastData.forEach(item => {
            const theoreticalStock = parseInt(item.stockTeorico) || 0;
            if (theoreticalStock > fallbackMaxStock) {
              fallbackMaxStock = theoreticalStock;
              fallbackMaxItem = item;
            }
          });

          if (fallbackMaxItem) {
            return `${fallbackMaxItem.description || fallbackMaxItem.articulo} (${fallbackMaxStock})`;
          }
        }

        return "No stock data available";
      } catch (error) {
        console.error('❌ Error calculating most stock changes:', error);
        return "Analysis not available";
      }
    }

    // Calculate total registered users from Firebase Auth
    async function getTotalRegisteredUsers() {
      try {
        // Since we can't directly access all users from client-side Firebase Auth,
        // we'll count unique users from orders as a proxy
        if (!firebase || !firebase.auth().currentUser) {
          return "Auth required";
        }

        const { collection, getDocs } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const pedidosCollection = collection(db, 'pedidos');
        const querySnapshot = await getDocs(pedidosCollection);

        const uniqueUsers = new Set();

        querySnapshot.forEach(doc => {
          const data = doc.data();
          // Try different user identifier fields
          if (data.userId) {
            uniqueUsers.add(data.userId);
          } else if (data.userEmail) {
            uniqueUsers.add(data.userEmail);
          } else if (data.usuario) {
            uniqueUsers.add(data.usuario);
          }
        });

        const totalUsers = uniqueUsers.size;
        return totalUsers > 0 ? `${totalUsers} usuarios` : "No user data";

      } catch (error) {
        console.error('❌ Error calculating total users:', error);
        return "Error loading users";
      }
    }

    // Calculate most active user based on order count
    async function getMostActiveUser() {
      try {
        if (!firebase || !firebase.auth().currentUser) {
          return "Auth required";
        }

        const { collection, getDocs } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const pedidosCollection = collection(db, 'pedidos');
        const querySnapshot = await getDocs(pedidosCollection);

        const userActivity = {};

        querySnapshot.forEach(doc => {
          const data = doc.data();
          let userIdentifier = null;

          // Try to get user identifier
          if (data.userEmail) {
            userIdentifier = data.userEmail;
          } else if (data.usuario) {
            userIdentifier = data.usuario;
          } else if (data.userId) {
            userIdentifier = data.userId;
          }

          if (userIdentifier) {
            userActivity[userIdentifier] = (userActivity[userIdentifier] || 0) + 1;
          }
        });

        const sortedUsers = Object.entries(userActivity).sort(([,a], [,b]) => b - a);

        if (sortedUsers.length > 0) {
          const [userIdentifier, orderCount] = sortedUsers[0];
          // Clean up email to show just the name part
          const displayName = userIdentifier.includes('@') ?
            userIdentifier.split('@')[0] : userIdentifier;
          return `${displayName} (${orderCount} pedidos)`;
        }

        return "No activity data";

      } catch (error) {
        console.error('❌ Error calculating most active user:', error);
        return "Error loading activity";
      }
    }

    // Update advanced stats
    async function updateAdvancedStats() {
      console.log('📊 Updating advanced statistics...');

      // Update most purchased item
      const mostPurchasedItem = await getMostPurchasedItem();
      const mostPurchasedStat = document.getElementById('mostPurchasedItemStat');
      if (mostPurchasedStat) {
        mostPurchasedStat.textContent = mostPurchasedItem;
      }

      // Update best sales month
      const bestSalesMonth = await getBestSalesMonth();
      const bestSalesMonthStat = document.getElementById('bestSalesMonthStat');
      if (bestSalesMonthStat) {
        bestSalesMonthStat.textContent = bestSalesMonth;
      }

      // Update most stock changes item
      const mostStockChanges = await getMostStockChangesItem();
      const mostStockChangesStat = document.getElementById('mostStockChangesStat');
      if (mostStockChangesStat) {
        mostStockChangesStat.textContent = mostStockChanges;
      }

      // Update total registered users
      const totalUsers = await getTotalRegisteredUsers();
      const totalUsersStat = document.getElementById('totalUsersStat');
      if (totalUsersStat) {
        totalUsersStat.textContent = totalUsers;
      }

      // Update most active user
      const mostActiveUser = await getMostActiveUser();
      const mostActiveUserStat = document.getElementById('mostActiveUserStat');
      if (mostActiveUserStat) {
        mostActiveUserStat.textContent = mostActiveUser;
      }

      console.log('✅ Advanced statistics updated');
    }

    // Expose advanced stats function globally
    window.updateAdvancedStats = updateAdvancedStats;

    // === PHOTO UPLOAD FUNCTIONALITY ===

    let currentOrderId = null;
    let selectedPhoto = null;

    // Initiate delivery process - opens photo upload modal
    function initiateDelivery(orderId) {
      currentOrderId = orderId;
      openModal('photoUploadModal');
    }

    // Setup photo upload event listeners
    function setupPhotoUpload() {
      const cameraBtn = document.getElementById('cameraBtn');
      const fileBtn = document.getElementById('fileBtn');
      const photoInput = document.getElementById('photoInput');
      const fileInput = document.getElementById('fileInput');
      const previewImage = document.getElementById('previewImage');
      const photoPreview = document.getElementById('photoPreview');
      const confirmBtn = document.getElementById('confirmUploadBtn');
      const cancelBtn = document.getElementById('cancelUploadBtn');

      if (cameraBtn) {
        cameraBtn.addEventListener('click', () => {
          photoInput.click();
        });
      }

      if (fileBtn) {
        fileBtn.addEventListener('click', () => {
          fileInput.click();
        });
      }

      if (photoInput) {
        photoInput.addEventListener('change', handlePhotoSelection);
      }

      if (fileInput) {
        fileInput.addEventListener('change', handlePhotoSelection);
      }

      if (confirmBtn) {
        confirmBtn.addEventListener('click', confirmDelivery);
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', cancelPhotoUpload);
      }
    }

    // Handle photo selection
    function handlePhotoSelection(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('Por favor selecciona un archivo de imagen válido.');
        return;
      }

      selectedPhoto = file;
      const reader = new FileReader();

      reader.onload = (e) => {
        const previewImage = document.getElementById('previewImage');
        const photoPreview = document.getElementById('photoPreview');

        if (previewImage && photoPreview) {
          previewImage.src = e.target.result;
          photoPreview.style.display = 'block';
        }
      };

      reader.readAsDataURL(file);
    }

    // Confirm delivery with photo upload
    async function confirmDelivery() {
      if (!selectedPhoto || !currentOrderId) {
        alert('Error: No se seleccionó foto o pedido.');
        return;
      }

      try {
        // Show upload progress
        const uploadProgress = document.getElementById('uploadProgress');
        const photoPreview = document.getElementById('photoPreview');

        if (uploadProgress && photoPreview) {
          photoPreview.style.display = 'none';
          uploadProgress.style.display = 'block';
        }

        // Upload photo to Firebase Storage
        const photoUrl = await uploadPhotoToFirebase(selectedPhoto, currentOrderId);

        // Update order with photo and delivered status
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', currentOrderId);
        await updateDoc(orderRef, {
          logisticsState: 'delivered',
          deliveryPhoto: photoUrl,
          deliveryDate: new Date(),
          lastStateUpdate: new Date()
        });

        console.log(`✅ Order ${currentOrderId} delivered with photo`);

        // Close modal and reload orders
        closeModal('photoUploadModal');
        resetPhotoUpload();
        loadLogisticsOrders();

      } catch (error) {
        console.error('❌ Error confirming delivery:', error);
        alert('Error al confirmar entrega. Intenta nuevamente.');

        // Hide upload progress on error
        const uploadProgress = document.getElementById('uploadProgress');
        const photoPreview = document.getElementById('photoPreview');

        if (uploadProgress && photoPreview) {
          uploadProgress.style.display = 'none';
          photoPreview.style.display = 'block';
        }
      }
    }

    // Save photo directly to Firestore (avoids CORS issues)
    async function uploadPhotoToFirebase(file, orderId) {
      const currentUser = firebase.auth().currentUser;
      if (!currentUser) {
        throw new Error('Usuario no autenticado');
      }

      console.log('📤 Guardando foto directamente en Firestore...');

      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = async (e) => {
          try {
            const base64 = e.target.result;

            // Compress image if it's too large (optional)
            const compressedBase64 = await compressImage(base64, 0.8, 800);

            // Save photo directly to Firestore
            const { doc, setDoc } = firebase.firestoreHelpers;
            const db = firebase.firestore();

            const photoId = `${currentUser.uid}_${orderId}_${Date.now()}`;
            const photoRef = doc(db, 'delivery-photos', photoId);

            await setDoc(photoRef, {
              orderId: orderId,
              userId: currentUser.uid,
              photoData: compressedBase64,
              uploadDate: new Date(),
              fileName: `${photoId}.jpg`,
              fileSize: file.size,
              fileType: file.type
            });

            console.log('✅ Foto guardada en Firestore:', photoId);
            resolve(`firestore:${photoId}`);
          } catch (error) {
            console.error('❌ Error guardando foto en Firestore:', error);
            reject(new Error(`Error al guardar la foto: ${error.message}`));
          }
        };

        reader.onerror = () => {
          reject(new Error('Error al leer el archivo de imagen'));
        };

        reader.readAsDataURL(file);
      });
    }

    // Compress image to reduce Firestore storage usage
    function compressImage(base64, quality = 0.8, maxWidth = 800) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        img.onload = () => {
          // Calculate new dimensions
          let { width, height } = img;

          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;

          // Draw and compress
          ctx.drawImage(img, 0, 0, width, height);
          const compressedBase64 = canvas.toDataURL('image/jpeg', quality);

          resolve(compressedBase64);
        };

        img.src = base64;
      });
    }

    // Cancel photo upload
    function cancelPhotoUpload() {
      resetPhotoUpload();
      closeModal('photoUploadModal');
    }

    // Reset photo upload state
    function resetPhotoUpload() {
      selectedPhoto = null;
      currentOrderId = null;

      const photoPreview = document.getElementById('photoPreview');
      const uploadProgress = document.getElementById('uploadProgress');
      const previewImage = document.getElementById('previewImage');
      const photoInput = document.getElementById('photoInput');
      const fileInput = document.getElementById('fileInput');

      if (photoPreview) photoPreview.style.display = 'none';
      if (uploadProgress) uploadProgress.style.display = 'none';
      if (previewImage) previewImage.src = '';
      if (photoInput) photoInput.value = '';
      if (fileInput) fileInput.value = '';
    }

    // View delivery photo
    async function viewDeliveryPhoto(orderId) {
      try {
        const { doc, getDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', orderId);
        const orderSnap = await getDoc(orderRef);

        if (!orderSnap.exists()) {
          alert('Pedido no encontrado');
          return;
        }

        const orderData = orderSnap.data();
        if (!orderData.deliveryPhoto) {
          alert('No hay foto de entrega para este pedido');
          return;
        }

        console.log('📖 Cargando foto de entrega...');

        // All photos are now stored in Firestore
        const photoId = orderData.deliveryPhoto.replace('firestore:', '');
        const photoRef = doc(db, 'delivery-photos', photoId);
        const photoSnap = await getDoc(photoRef);

        if (!photoSnap.exists()) {
          alert('Foto no encontrada en la base de datos');
          return;
        }

        const photoData = photoSnap.data();
        const photoSrc = photoData.photoData;

        console.log('✅ Foto cargada desde Firestore');

        // Show photo in modal
        const viewImage = document.getElementById('viewImage');
        const photoDate = document.getElementById('photoDate');
        const photoOrder = document.getElementById('photoOrder');

        if (viewImage) {
          viewImage.src = photoSrc;
          // Add loading state
          viewImage.onload = () => {
            console.log('✅ Foto mostrada en modal');
          };
          viewImage.onerror = () => {
            console.error('❌ Error mostrando foto');
            alert('Error al mostrar la foto');
          };
        }

        if (photoDate) {
          const uploadDate = photoData.uploadDate ? new Date(photoData.uploadDate.toDate()).toLocaleString() : 'No disponible';
          photoDate.textContent = `Fecha de entrega: ${uploadDate}`;
        }

        if (photoOrder) {
          photoOrder.textContent = `Pedido #${orderData.numeroOrden || orderId.slice(-6)}`;
        }

        openModal('photoViewModal');

      } catch (error) {
        console.error('❌ Error viewing photo:', error);
        alert(`Error al cargar la foto: ${error.message}`);
      }
    }

    // Initialize photo upload when page loads
    document.addEventListener('DOMContentLoaded', () => {
      setupPhotoUpload();
    });

    // Expose logistics functions globally
    window.loadLogisticsOrders = loadLogisticsOrders;
    window.moveOrder = moveOrder;
    window.initiateDelivery = initiateDelivery;
    window.viewDeliveryPhoto = viewDeliveryPhoto;

    console.log('✅ Firebase disponible globalmente');
  </script>

  <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
  <script>
    // Initialize Material Design Components
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize all buttons
      const buttons = document.querySelectorAll('.mdc-button');
      buttons.forEach(button => mdc.ripple.MDCRipple.attachTo(button));

      // Setup Add to Cart button
      const addToCartBtn = document.getElementById('addToCartBtn');

      function handleAddToCart() {
        // Check if selectedItems exists and has items
        if (!window.selectedItems || window.selectedItems.size === 0) {
          alert('Por favor selecciona al menos un producto con cantidad mayor a 0');
          return;
        }

        // Filter out items with quantity 0
        const itemsToAdd = [];
        window.selectedItems.forEach(({ product, quantity }, id) => {
          if (quantity > 0) {
            itemsToAdd.push({
              item: product.articulo,
              description: product.description,
              price: product.price,
              quantity
            });
          }
        });

        if (itemsToAdd.length === 0) {
          alert('Por favor selecciona al menos un producto con cantidad mayor a 0');
          return;
        }

        // Save cart to localStorage
        localStorage.setItem('cart', JSON.stringify(itemsToAdd));
        // Limpiar editingOrderId porque estamos creando una orden nueva
        localStorage.removeItem('editingOrderId');
        console.log('Cart saved with', itemsToAdd.length, 'items, redirecting to cart.html');

        // Redirect to cart page
        window.location.href = 'cart.html';
      }

      if (addToCartBtn) {
        addToCartBtn.addEventListener('click', handleAddToCart);
      }

      // Initialize checkboxes
      const checkboxes = document.querySelectorAll('.mdc-checkbox');
      checkboxes.forEach(checkbox => mdc.checkbox.MDCCheckbox.attachTo(checkbox));
      
      // Initialize text fields
      const textFields = document.querySelectorAll('.mdc-text-field');
      textFields.forEach(textField => mdc.textField.MDCTextField.attachTo(textField));
      
      // Initialize tab bar
      const tabBar = document.querySelector('.mdc-tab-bar');
      if (tabBar) {
        const mdcTabBar = mdc.tabBar.MDCTabBar.attachTo(tabBar);

        // Handle tab activation
        mdcTabBar.listen('MDCTabBar:activated', (event) => {
          const tab = tabBar.querySelectorAll('.mdc-tab')[event.detail.index];
          const segment = tab.getAttribute('data-segment');

          // Trigger the existing tab functionality
          if (window.handleTabClick) {
            window.handleTabClick(segment);
          }
        });
      }

      // Load cart from localStorage and populate selectedItems (for "Seguir Comprando" functionality)
      const cartData = localStorage.getItem('cart');
      if (cartData) {
        try {
          const cartItems = JSON.parse(cartData);
          console.log('📦 Cargando carrito desde localStorage:', cartItems.length, 'items');
          console.log('📦 Contenido del carrito:', cartItems);

          // Function to load cart items into selectedItems
          function loadCartIntoSelectedItems() {
            console.log('📊 Total productos disponibles:', window.mappedStockData.length);
            console.log('📊 Primeros 3 productos:', window.mappedStockData.slice(0, 3).map(p => p.articulo));

            // Filter out invalid items (undefined, null, empty)
            const validCartItems = cartItems.filter(item => {
              if (!item.item || item.item === 'undefined' || item.item.trim() === '') {
                console.warn('⚠️ Item inválido en carrito, ignorando:', item);
                return false;
              }
              return true;
            });

            console.log(`📦 Items válidos en carrito: ${validCartItems.length} de ${cartItems.length}`);

            let loadedCount = 0;
            validCartItems.forEach(cartItem => {
              // Find the product in the mapped stock data
              const product = window.mappedStockData.find(p => {
                // Check if both articulo and item exist and are strings
                if (!p.articulo || !cartItem.item) return false;

                const articulo = String(p.articulo);
                const item = String(cartItem.item);

                const match = articulo === item ||
                              articulo.trim() === item.trim() ||
                              articulo.toLowerCase() === item.toLowerCase();
                return match;
              });

              if (product && window.selectedItems) {
                // Add to selectedItems map
                window.selectedItems.set(cartItem.item, {
                  product: product,
                  quantity: cartItem.quantity
                });
                loadedCount++;
              } else {
                console.warn(`⚠️ Producto NO encontrado: "${cartItem.item}"`);

                // Try partial match with safety check
                const partialMatch = window.mappedStockData.find(p =>
                  p.articulo && cartItem.item && (
                    p.articulo.includes(cartItem.item) || cartItem.item.includes(p.articulo)
                  )
                );

                if (partialMatch) {
                  window.selectedItems.set(partialMatch.articulo, {
                    product: partialMatch,
                    quantity: cartItem.quantity
                  });
                  loadedCount++;
                }
              }
            });

            console.log(`✅ Carrito cargado: ${loadedCount} productos válidos`);

            // Forzar re-render de la tabla para mostrar las cantidades
            if (window.renderRows) {
              window.renderRows();
            }

            // Actualizar badge del carrito
            if (window.updateCartBadge) {
              window.updateCartBadge();
            }

            // Limpiar localStorage después de cargar exitosamente
            localStorage.removeItem('cart');
            console.log('✅ Vista actualizada con productos del carrito');
          }

          // Wait for products to be loaded before populating selectedItems
          let attempts = 0;
          const maxAttempts = 100; // 10 seconds max
          const waitForProducts = setInterval(() => {
            attempts++;
            console.log(`⏳ Esperando mappedStockData... intento ${attempts}/${maxAttempts}`);

            if (window.mappedStockData && window.mappedStockData.length > 0) {
              clearInterval(waitForProducts);
              console.log('✅ mappedStockData disponible, cargando carrito...');
              loadCartIntoSelectedItems();
            } else if (attempts >= maxAttempts) {
              clearInterval(waitForProducts);
              console.error('❌ Timeout: mappedStockData nunca se cargó después de 10 segundos');
              console.log('🗑️ Limpiando localStorage del carrito para evitar problemas futuros');
              localStorage.removeItem('cart');
              localStorage.removeItem('editingOrderId');
            }
          }, 100); // Check every 100ms

        } catch (error) {
          console.error('❌ Error cargando carrito desde localStorage:', error);
        }
      } else {
        console.log('ℹ️ No hay carrito en localStorage');
      }
    });
  </script>

  <!-- CHANGELOG Modal -->
  <div id="changelogModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Changelog - Historial de Versiones</h2>
      <div id="changelogContent">
        <div class="version-section">
          <h3>v0.25 - Actual</h3>
          <ul>
            <li>🔒 <strong>Seguridad marketplace:</strong> Requiere autenticación para ver precios</li>
            <li>📱 <strong>Logo oculto en móvil:</strong> Logo South Traders oculto en dispositivos móviles</li>
            <li>⬆️ <strong>Control de estados de órdenes:</strong> Solo órdenes en Revisión pueden retroceder de estado</li>
            <li>👥 <strong>Admisiones mejoradas:</strong> Cliente obligatorio, sin rol Usuario, con selector de lista de precios</li>
            <li>📋 <strong>Clientes duplicados:</strong> Al aprobar usuario se crea registro en clientes con mismo código</li>
            <li>🎨 <strong>UI Admisiones:</strong> Labels descriptivos, mejor contraste, texto visible en selectores</li>
            <li>📄 <strong>PDF en WhatsApp:</strong> Órdenes se envían como PDF adjunto vía Firebase Storage</li>
            <li>🔧 <strong>CORS configurado:</strong> Firebase Storage permite acceso web a PDFs</li>
            <li>⏳ <strong>Loading en órdenes:</strong> Animación durante generación de PDF y envío WhatsApp</li>
            <li>📊 <strong>Columnas marketplace:</strong> Nuevo orden: Artículo, Descripción, Cantidad, Precio, Stock, Tránsito</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.24</h3>
          <ul>
            <li>👥 <strong>Sistema de aprobación de usuarios:</strong> Los admins deben aprobar nuevos registros</li>
            <li>📋 <strong>Sección ADMISIONES:</strong> Nueva sección para gestionar usuarios pendientes de aprobación</li>
            <li>🎭 <strong>Roles de usuario:</strong> Estados pending/usuario/vendedor/admin con permisos diferenciados</li>
            <li>💰 <strong>Columna LISTA en clientes:</strong> Campo para identificar lista de precios asignada</li>
            <li>📊 <strong>Historial mejorado:</strong> Admins ven todas las órdenes (100), usuarios solo las suyas (50)</li>
            <li>👑 <strong>Banner admin en historial:</strong> Indica cuando se visualiza como administrador</li>
            <li>📧 <strong>Email de usuario en órdenes:</strong> Admins ven quién creó cada orden en historial</li>
            <li>✏️ <strong>Edición de perfil para todos:</strong> Usuarios pueden editar su propio nombre, dirección y teléfono</li>
            <li>🔒 <strong>Reglas Firestore actualizadas:</strong> Permisos de auto-edición + control admin</li>
            <li>🗑️ <strong>Herramienta de limpieza:</strong> Tool local para eliminar todas las órdenes (testing)</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.23</h3>
          <ul>
            <li>📱 <strong>WhatsApp multi-teléfono:</strong> Envío automático a ambos teléfonos del vendedor (phone y phone2)</li>
            <li>📞 <strong>Segundo teléfono para vendedores:</strong> Campo phone2 agregado en datos de vendedor</li>
            <li>🔄 <strong>WhatsApp en edición de órdenes:</strong> Notificación automática al modificar órdenes existentes</li>
            <li>🔧 <strong>Fix vendedorId:</strong> Se preserva el vendedor al editar órdenes para correcto envío de WhatsApp</li>
            <li>🗑️ <strong>Limpieza automática editingOrderId:</strong> Se limpia al agregar productos nuevos al carrito</li>
            <li>⚡ <strong>Validación de órdenes:</strong> Si la orden a editar no existe, se limpia automáticamente y se crea una nueva</li>
            <li>📝 <strong>Logs detallados WhatsApp:</strong> Sistema de debugging completo para rastrear envíos</li>
            <li>🔍 <strong>Búsqueda en MASTER:</strong> Buscar órdenes por número, cliente o código con debounce (300ms)</li>
            <li>📊 <strong>Contador de resultados:</strong> Muestra cantidad de órdenes filtradas vs total</li>
            <li>❌ <strong>Botón limpiar búsqueda:</strong> Resetea el filtro y muestra todas las órdenes</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.22</h3>
          <ul>
            <li>📊 <strong>KPIs mejorados:</strong> Ocultar valores en cero para mejor visualización</li>
            <li>🎨 <strong>Interfaz optimizada:</strong> Mejor presentación de métricas</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.21</h3>
          <ul>
            <li>🛒 <strong>Cart.html mejorado:</strong> Cantidades editables directamente en el carrito</li>
            <li>✏️ <strong>Input numérico:</strong> Cambiar cantidades sin recargar página</li>
            <li>✅ <strong>Confirmación directa:</strong> Confirmar orden desde cart.html sin ir a order.html</li>
            <li>🎉 <strong>Modal de éxito:</strong> Mensaje elegante de orden confirmada con número</li>
            <li>📱 <strong>WhatsApp integrado:</strong> Notificación automática al vendedor desde cart.html</li>
            <li>🔧 <strong>Firebase sincronizado:</strong> Configuración correcta entre marketplace y cart</li>
            <li>🚫 <strong>Permisos SEGUIMIENTO:</strong> Usuarios no-admin no pueden mover órdenes</li>
            <li>👁️ <strong>Solo visualización:</strong> No-admin puede ver estados pero no modificarlos</li>
            <li>🔒 <strong>Botones ocultos:</strong> Cambio de estado y cancelación solo para admin</li>
            <li>🗑️ <strong>Historial protegido:</strong> Botón "Limpiar Historial" solo para admin</li>
            <li>⚠️ <strong>Validación doble:</strong> Función moveOrder verifica permisos antes de ejecutar</li>
            <li>🎨 <strong>Estado visual:</strong> Muestra estado actual para usuarios no-admin</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.20</h3>
          <ul>
            <li>📋 <strong>MASTER completamente rediseñado:</strong> Sección sincronizada con SEGUIMIENTO</li>
            <li>🎯 <strong>Misma estructura visual:</strong> 9 estados organizados en secciones</li>
            <li>📊 <strong>10 KPIs actualizados:</strong> Total + cada estado individual con contadores en tiempo real</li>
            <li>🔄 <strong>Botón Actualizar reubicado:</strong> Posicionado arriba de los KPIs</li>
            <li>🗑️ <strong>Función Borrar Todas las Órdenes:</strong> Botón rojo con doble confirmación</li>
            <li>⚠️ <strong>Confirmación obligatoria:</strong> Requiere escribir "BORRAR TODO"</li>
            <li>📱 <strong>Notificación WhatsApp automática:</strong> Cada orden se envía al vendedor</li>
            <li>👥 <strong>Detección de vendedor:</strong> Sistema busca el vendedor del cliente</li>
            <li>💬 <strong>Mensaje formateado:</strong> WhatsApp con detalles completos</li>
            <li>🎯 <strong>Santiago asignado a todos:</strong> 421 clientes actualizados</li>
            <li>🔧 <strong>Bug fixes:</strong> Eliminada declaración duplicada de formatNumber</li>
            <li>🐛 <strong>Correcciones JavaScript:</strong> Funciones de importación/exportación</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.19</h3>
          <ul>
            <li>🔒 <strong>Control de acceso mejorado en Administration:</strong> Usuarios no-admin pueden VER pero NO editar</li>
            <li>📋 <strong>Modo solo lectura:</strong> Campos deshabilitados para usuarios sin permisos admin</li>
            <li>🚫 <strong>Botones ocultos:</strong> "Agregar Orden" y "Guardar" no visibles para no-admin</li>
            <li>🔍 <strong>Búsqueda de clientes:</strong> Campo de búsqueda con filtro en tiempo real por 9 campos</li>
            <li>⚡ <strong>Búsqueda inteligente:</strong> Debounce de 300ms y búsqueda instantánea con Enter</li>
            <li>👥 <strong>Columna Vendedor:</strong> Asignación de vendedores a clientes desde tabla</li>
            <li>📊 <strong>Dropdown dinámico:</strong> Selector de vendedor en cada fila de cliente</li>
            <li>🎯 <strong>Santiago por defecto:</strong> Asignación automática a clientes sin vendedor</li>
            <li>💾 <strong>Actualización instantánea:</strong> Cambios de vendedor guardados en tiempo real en Firebase</li>
            <li>✅ <strong>Confirmación de orden mejorada:</strong> Nuevo mensaje personalizado de orden enviada</li>
            <li>🔧 <strong>Bug fix:</strong> Función updateButtonLabels faltante agregada en order.html</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.18</h3>
          <ul>
            <li>👥 <strong>Módulo CLIENTES completo:</strong> Gestión completa de clientes con 13 campos de información</li>
            <li>➕ <strong>Agregar/Editar clientes:</strong> Formulario completo para crear y modificar clientes</li>
            <li>📥 <strong>Importar desde Excel:</strong> Carga masiva de clientes desde archivos .xls/.xlsx</li>
            <li>📤 <strong>Exportar a Excel:</strong> Descarga del listado completo de clientes</li>
            <li>🗑️ <strong>Eliminar clientes:</strong> Opción para borrar clientes con confirmación</li>
            <li>💾 <strong>Integración Firebase:</strong> Todos los datos guardados en Firestore</li>
            <li>📋 <strong>Seguimiento de Pedidos:</strong> LOGISTICS renombrado a SEGUIMIENTO con 9 estados</li>
            <li>🔄 <strong>Flujo completo:</strong> Borrador → En revisión → Aprobada → En preparación → Listo para retiro/Despacho → Despachada → Entregada → Cerrada → Cancelada</li>
            <li>🎯 <strong>Menú optimizado:</strong> CONFIG y STATS removidos temporalmente</li>
            <li>📱 <strong>Historial compacto:</strong> Órdenes minimizadas y modal responsive</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.16</h3>
          <ul>
            <li>📸 <strong>Sistema de Confirmación Fotográfica de Entregas</strong></li>
            <li>🚚 <strong>Logistics mejorado:</strong> Nombres actualizados a "Pedido en Preparacion", "Pedido en Camino", "Pedido Entregado"</li>
            <li>📱 <strong>Captura de fotos:</strong> Opción para tomar foto desde cámara o seleccionar archivo</li>
            <li>☁️ <strong>Almacenamiento inteligente:</strong> Fotos guardadas directamente en Firestore (evita problemas CORS)</li>
            <li>🗜️ <strong>Compresión automática:</strong> Imágenes optimizadas para reducir espacio de almacenamiento</li>
            <li>👁️ <strong>Visualización de fotos:</strong> Modal para ver fotos de entrega con información detallada</li>
            <li>✅ <strong>Flujo obligatorio:</strong> Foto requerida antes de marcar pedido como entregado</li>
            <li>🎨 <strong>Interfaz optimizada:</strong> Botones de foto compactos que no interfieren con el texto</li>
            <li>📊 <strong>Múltiples pedidos:</strong> Visualización correcta de todos los pedidos entregados</li>
            <li>🔧 <strong>Compatible localhost:</strong> Sistema diseñado para funcionar en desarrollo local</li>
            <li>👤 <strong>PROFILE como primera opción de menú</strong></li>
            <li>🎨 <strong>ADMIN con colores estándar del menú</strong></li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.15</h3>
          <ul>
            <li>⚙️ <strong>Página de Administración completamente funcional</strong></li>
            <li>💰 <strong>Gestión de Precios:</strong> Listado completo de productos con 4 precios editables</li>
            <li>📤 <strong>Importar Precios:</strong> Soporte para archivos CSV y Excel (.xlsx/.xls)</li>
            <li>📥 <strong>Exportar Precios:</strong> Descarga en formato CSV y Excel con formato profesional</li>
            <li>💾 <strong>Guardado Automático:</strong> Los precios se guardan en Firebase instantáneamente</li>
            <li>📋 <strong>Gestión de Órdenes Master:</strong> Sistema completo de seguimiento de órdenes</li>
            <li>🔄 <strong>Estados de Orden:</strong> A Confirmar → En Preparación → En Camino → Entregado</li>
            <li>👥 <strong>Gestión de Vendedores:</strong> Sistema completo de alta, edición y eliminación</li>
            <li>🏢 <strong>Gestión de Clientes:</strong> Administración de clientes con asignación de vendedores</li>
            <li>🎨 <strong>Animaciones de Carga:</strong> Spinners elegantes durante procesos largos</li>
            <li>🔄 <strong>Auto-carga Inteligente:</strong> Datos se cargan automáticamente al cambiar pestañas</li>
            <li>📊 <strong>Estadísticas en Tiempo Real:</strong> Contadores automáticos por cada sección</li>
            <li>🛡️ <strong>Manejo Robusto de Errores:</strong> Validaciones y recuperación automática</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.13</h3>
          <ul>
            <li>🍔 <strong>Botón logout movido al menú hamburger</strong></li>
            <li>🔽 Logout y versión reubicados al fondo del menú hamburger</li>
            <li>📜 Número de versión ahora abre el modal de changelog al hacer clic</li>
            <li>🧹 Removido texto "Totals" de la fila de totales en listado</li>
            <li>🎨 Mejorado diseño del footer del menú con separador visual</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.12</h3>
          <ul>
            <li>🔍 <strong>Filtro de productos con stock 0 corregido</strong></li>
            <li>✅ Agregado checkbox "Hide zero values" en barra superior</li>
            <li>📋 Mostrar todos los productos por defecto (incluyendo stock 0)</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.11</h3>
          <ul>
            <li>🛒 <strong>Sistema de confirmación de órdenes implementado</strong></li>
            <li>📧 Eliminados botones de envío por WhatsApp y Email</li>
            <li>✅ Nuevo botón único "Confirmar Orden" con numeración automática</li>
            <li>🔢 Numeración de órdenes comenzando desde #10000, #10001, etc.</li>
            <li>📋 Historial mejorado con números de orden y información del usuario</li>
            <li>👤 Visualización de quién realizó cada orden en el historial</li>
            <li>🔧 Campo de cantidad editable manualmente en marketplace</li>
            <li>⌨️ Input numérico para ingresar cantidades altas (50, 100, etc.)</li>
            <li>🔄 Compatibilidad mejorada entre Firebase v10 modular y compat SDK</li>
            <li>🗑️ Funciones de limpiar y exportar historial completamente implementadas</li>
            <li>📊 Exportación a CSV con datos completos de órdenes</li>
            <li>🛡️ Manejo de errores robusto para evitar bloqueos de interfaz</li>
            <li>🎯 Flujo simplificado: confirmar → número único → historial → redirect</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.10 - Sistema de Permisos</h3>
          <ul>
            <li>🔐 <strong>Sistema de permisos de usuario implementado</strong></li>
            <li>👤 Verificación automática de permisos admin basada en Firebase</li>
            <li>🚫 Usuarios no-admin: acceso restringido a filtros de columnas</li>
            <li>✅ Usuarios no-admin: acceso permitido a HISTORIAL y LOGISTICS</li>
            <li>🎯 Sistema consistente entre index.html, marketplace.html y order.html</li>
            <li>🔧 Botón LOGISTICS agregado al menú de order.html</li>
            <li>🚚 Modal de logistics completo con 3 secciones funcionales</li>
            <li>🛡️ Manejo de errores con permisos restrictivos por seguridad</li>
            <li>📋 Logging detallado para debugging de permisos</li>
            <li>⚙️ Integración automática con onAuthStateChanged de Firebase</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.9 - Sistema Dinámico de Columnas</h3>
          <ul>
            <li>📊 <strong>Sistema completo de columnas dinámicas implementado</strong></li>
            <li>🔧 Agregadas todas las columnas de la API (15 total) con filtrado</li>
            <li>💾 Persistencia de filtros seleccionados en localStorage</li>
            <li>📈 KPIs dinámicos que se actualizan según columnas visibles</li>
            <li>🎯 Configuración específica de columnas por página (index vs marketplace)</li>
            <li>📐 Columna descripción con ancho doble (30%)</li>
            <li>🏷️ Limpieza de etiquetas KPI (removido "SUMA" y "SUMA EN")</li>
            <li>🚀 Botón Logistics agregado en marketplace (sin iconos)</li>
            <li>⚡ Optimización de compatibilidad JavaScript navegadores antiguos</li>
            <li>🔄 Sistema de mapeo robusto con fallbacks para datos API</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.8 - Menu Administrativo</h3>
          <ul>
            <li>🍔 <strong>Hamburger menu administrativo implementado</strong></li>
            <li>🔐 Sistema de permisos admin basado en Firestore</li>
            <li>⚙️ Panel de configuración con WhatsApp y Email</li>
            <li>💾 Almacenamiento automático en Firebase de configuraciones</li>
            <li>🔔 Sistema de notificaciones toast con animaciones</li>
            <li>📱 Integración automática con formulario de pedidos</li>
            <li>📞 Configuración de contacto persistente entre sesiones</li>
            <li>🚪 Función Logout mejorada y funcional</li>
            <li>📋 Auto-relleno de datos de contacto en order.html</li>
            <li>✨ Interfaz de configuración intuitiva y responsive</li>
            <li>🛠️ Debug mejorado y manejo de errores Firebase</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.7 - Sistema de Pagos Crypto</h3>
          <ul>
            <li>💰 <strong>Sistema de pago crypto implementado</strong></li>
            <li>🔗 Agregado QR code con address USDT (BSC) para pagos</li>
            <li>📝 Campo para hash de transacción con validación</li>
            <li>📋 Función de copia de address al clipboard</li>
            <li>🎯 Validación automática de formato de hash (0x + 66 chars)</li>
            <li>✅ Confirmación y almacenamiento local de transacciones</li>
            <li>🛒 Botón "Seguir Comprando" para volver al marketplace</li>
            <li>🔄 Estados visuales dinámicos en botones de pago</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.6 - Marketplace Mejorado</h3>
          <ul>
            <li>🚪 Botón Logout funcional en marketplace</li>
            <li>🔴 Valores en 0 mostrados en color rojo</li>
            <li>📊 KPIs integrados en marketplace (Total Productos, Stock, Transit)</li>
            <li>🎨 Botones Add to Cart dinámicos (blanco→rojo con cantidad)</li>
            <li>0️⃣ Quantity por defecto en 0 en lugar de 1</li>
            <li>🔧 Lógica mejorada para actualización visual de botones</li>
            <li>🎯 Estilos consistentes entre páginas</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.5</h3>
          <ul>
            <li>✅ Eliminada columna "Stock Teórico"</li>
            <li>✅ Reordenadas columnas: Disponible | En Tránsito</li>
            <li>✅ Agregado sistema de versiones con changelog</li>
            <li>🔧 Optimización de la interfaz</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.4</h3>
          <ul>
            <li>📊 Agregadas estadísticas en tiempo real</li>
            <li>🔍 Mejorado sistema de filtros por columnas</li>
            <li>📱 Optimización responsive</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.3</h3>
          <ul>
            <li>📤 Funcionalidad de exportación a Excel</li>
            <li>🔄 Auto-refresh cada 90 segundos</li>
            <li>🎨 Mejorado tema oscuro</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.2</h3>
          <ul>
            <li>🔐 Sistema de autenticación</li>
            <li>📋 Tabs de categorías (All, iPhone, MacBooks, Samsung)</li>
            <li>🔍 Búsqueda por modelo</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.1</h3>
          <ul>
            <li>🎉 Versión inicial</li>
            <li>📊 Tabla básica de inventario</li>
            <li>🌙 Interfaz con tema oscuro</li>
            <li>📱 Diseño responsive básico</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>
