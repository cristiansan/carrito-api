<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>South Traders</title>
  
  <!-- Material Design CSS -->
  <link href="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { 
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; 
      color-scheme: dark;
      --mdc-theme-primary: #4CAF50;
      --mdc-theme-secondary: #2a2a33;
      --mdc-theme-surface: #1e1e24;
      --mdc-theme-background: #0f0f10;
      --mdc-theme-on-primary: #ffffff;
      --mdc-theme-on-secondary: #ffffff;
      --mdc-theme-on-surface: #f1f1f1;
      --mdc-theme-on-background: #f1f1f1;
    }
    
    /* Material Design custom overrides for better visibility */
    .mdc-tab {
      color: #d0d0d0 !important; /* Color más claro para tabs no seleccionados */
      background-color: #1b1b1f !important;
      border-radius: 6px 6px 0 0 !important;
      border: 1px solid #2a2a2a !important;
      border-bottom: none !important;
      margin-right: 4px !important;
    }
    
    .mdc-tab--active {
      color: #ffffff !important; /* Color para tab seleccionado */
      background-color: #23232a !important;
      font-weight: 600 !important;
    }
    
    .mdc-tab:hover:not(.mdc-tab--active) {
      color: #e8e8e8 !important; /* Color en hover para mejor visibilidad */
      background-color: #2a2a2f !important;
    }
    
    .mdc-tab-indicator__content--underline {
      border-color: #4CAF50 !important;
      border-width: 3px !important;
    }
    
    /* Fix for all text elements that might appear black */
    .mdc-tab__text-label,
    .mdc-button__label,
    .mdc-floating-label,
    .mdc-text-field__input,
    .mdc-form-field > label,
    .mdc-checkbox ~ label,
    span, p, div, h1, h2, h3, h4, h5, h6 {
      color: inherit !important;
    }
    
    /* Specific overrides for Material components */
    .mdc-tab__text-label {
      color: inherit !important;
    }
    
    .mdc-button__label {
      color: inherit !important;
    }
    
    /* Text field improvements */
    .mdc-text-field--outlined {
      background-color: #1b1b1f !important;
      box-shadow: none !important; /* Eliminar cualquier sombra por defecto */
    }
    
    .mdc-text-field--outlined .mdc-notched-outline__leading,
    .mdc-text-field--outlined .mdc-notched-outline__notch,
    .mdc-text-field--outlined .mdc-notched-outline__trailing {
      border-color: #3a3a44 !important;
    }
    
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__leading,
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__notch,
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__trailing {
      border-color: #4CAF50 !important;
    }
    
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__leading,
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__notch,
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__trailing {
      border-color: #4CAF50 !important;
      border-width: 2px !important;
    }
    
    .mdc-text-field__input {
      color: #f1f1f1 !important;
    }
    
    .mdc-floating-label {
      color: #d0d0d0 !important; /* Gris más claro */
    }
    
    .mdc-text-field--focused .mdc-floating-label {
      color: #4CAF50 !important;
    }
    
    /* Button improvements */
    .mdc-button {
      color: #f1f1f1 !important;
    }
    
    .mdc-button--raised {
      background-color: #4CAF50 !important;
      color: #ffffff !important;
    }
    
    .mdc-button--outlined {
      border-color: #3a3a44 !important;
      color: #f1f1f1 !important;
    }
    
    .mdc-button--outlined:hover {
      background-color: #2a2a33 !important;
      border-color: #4CAF50 !important;
    }
    
    /* Checkbox improvements */
    .mdc-checkbox__native-control:enabled:checked ~ .mdc-checkbox__background {
      background-color: #4CAF50 !important;
      border-color: #4CAF50 !important;
    }
    
    .mdc-checkbox__background {
      border-color: #3a3a44 !important;
    }
    
    .mdc-form-field > label {
      color: #f1f1f1 !important;
    }
    
    /* General text color fixes */
    .status {
      color: #d0d0d0 !important;
    }
    
    /* Toolbar spacing fix */
    .toolbar {
      align-items: center !important;
      gap: 12px !important;
    }
    
    /* Search field specific styling - match button size */
    .toolbar .search-field {
      width: 160px !important; /* Ancho similar a botones */
      height: 36px !important; /* Misma altura que botones MDC */
      box-shadow: none !important; /* Eliminar sombra */
      background: transparent !important; /* Fondo transparente */
      margin: 0 !important; /* Eliminar márgenes extra */
      align-self: center !important; /* Centrar verticalmente */
    }

    .toolbar .search-field .mdc-text-field__input {
      height: 34px !important; /* Ajustar altura del input para coincidir */
      padding-top: 8px !important;
      padding-bottom: 8px !important;
      box-shadow: none !important; /* Eliminar sombra del input */
      background: transparent !important; /* Fondo transparente */
      line-height: 18px !important; /* Centrar texto verticalmente */
    }

    .toolbar .search-field .mdc-notched-outline__leading,
    .toolbar .search-field .mdc-notched-outline__notch,
    .toolbar .search-field .mdc-notched-outline__trailing {
      height: 36px !important; /* Misma altura que el contenedor */
      box-shadow: none !important; /* Eliminar sombra del borde */
    }
    
    .toolbar .search-field .mdc-floating-label {
      top: 50% !important;
      transform: translateY(-50%) !important;
    }
    
    .toolbar .search-field .mdc-floating-label--float-above {
      transform: translateY(-106%) scale(0.75) !important;
    }
    
    /* Remove any elevation/shadow from text field */
    .toolbar .search-field::before,
    .toolbar .search-field::after {
      display: none !important;
    }
    
    .toolbar .search-field .mdc-text-field__ripple {
      display: none !important;
    }
    
    /* Additional shadow removal for all Material Design states */
    .toolbar .search-field,
    .toolbar .search-field.mdc-text-field--focused,
    .toolbar .search-field.mdc-text-field--outlined,
    .toolbar .search-field.mdc-text-field--outlined.mdc-text-field--focused {
      box-shadow: none !important;
      -webkit-box-shadow: none !important;
      -moz-box-shadow: none !important;
      background: #1b1b1f !important; /* Fondo sólido en lugar de transparente */
    }
    
    /* Prevent any black text */
    * {
      color: inherit;
    }
    
    /* Ensure all Material Design components inherit proper colors */
    .mdc-tab *, 
    .mdc-button *, 
    .mdc-text-field *, 
    .mdc-checkbox *,
    .mdc-form-field * {
      color: inherit !important;
    }
    
    body { margin: 0; padding: 0; background: #0f0f10; color: #f1f1f1; width: 100%; max-width: 100%; overflow-x: hidden; }
    header { padding: 16px; border-bottom: 1px solid #2a2a2a; background: #121214; display: flex; align-items: center; justify-content: center; gap: 12px; position: relative; }
    .header-logo { height: auto; max-width: 195px; width: 100%; object-fit: contain; position: absolute; left: 80px; }
    h1 { margin: 0; font-size: 20px; color: #fafafa; }

    /* Notifications Bell */
    .notifications-container {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 100;
    }

    .notifications-bell {
      position: relative;
      background: #1b1b1f;
      border: 1px solid #2a2a2a;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .notifications-bell:hover {
      background: #2a2a33;
      border-color: #4CAF50;
      transform: scale(1.05);
    }

    .notifications-bell .material-icons {
      color: #f0f0f0;
      font-size: 24px;
    }

    .notifications-badge {
      position: absolute;
      bottom: -4px;
      right: -4px;
      background: #f44336;
      color: white;
      border-radius: 12px;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: 700;
      min-width: 18px;
      text-align: center;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Notifications Dropdown */
    .notifications-dropdown {
      position: absolute;
      left: 0;
      top: calc(100% + 8px);
      background: #1b1b1f;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      width: 380px;
      max-height: 500px;
      overflow: hidden;
      z-index: 1000;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .notifications-header {
      padding: 16px;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #15151a;
    }

    .notifications-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #f0f0f0;
    }

    .notifications-close {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .notifications-close:hover {
      background: #2a2a33;
      color: #f0f0f0;
    }

    .notifications-list {
      max-height: 440px;
      overflow-y: auto;
    }

    .notification-empty {
      padding: 32px;
      text-align: center;
      color: #888;
      font-size: 14px;
    }

    .notification-item {
      padding: 16px;
      border-bottom: 1px solid #2a2a2a;
      transition: background 0.2s ease;
      cursor: pointer;
    }

    .notification-item:hover {
      background: #15151a;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-item.warning {
      border-left: 3px solid #ff9800;
    }

    .notification-item.error {
      border-left: 3px solid #f44336;
    }

    .notification-item.info {
      border-left: 3px solid #2196F3;
    }

    .notification-item-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }

    .notification-item-icon {
      font-size: 20px;
      margin-top: 2px;
    }

    .notification-item.warning .notification-item-icon {
      color: #ff9800;
    }

    .notification-item.error .notification-item-icon {
      color: #f44336;
    }

    .notification-item.info .notification-item-icon {
      color: #2196F3;
    }

    .notification-item-content {
      flex: 1;
    }

    .notification-item-title {
      font-weight: 600;
      color: #f0f0f0;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .notification-item-message {
      color: #b5b5b5;
      font-size: 13px;
      line-height: 1.4;
    }

    .notification-item-count {
      background: #2a2a33;
      color: #f0f0f0;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .container { padding: 16px; width: 100%; box-sizing: border-box; }
    .tabs { display: flex; gap: 8px; border-bottom: 1px solid #2a2a2a; margin-bottom: 12px; }
    .tab { padding: 8px 12px; cursor: pointer; border: 1px solid #2a2a2a; border-bottom: none; border-radius: 6px 6px 0 0; background: #1b1b1f; color: #e6e6e6; }
    .tab.active { background: #23232a; font-weight: 600; color: #ffffff; }
    .toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; position: relative; flex-wrap: wrap; width: 100%; box-sizing: border-box; }
    .toolbar button { padding: 6px 10px; cursor: pointer; background: #2a2a33; color: #f0f0f0; border: 1px solid #3a3a44; border-radius: 4px; }
    .status { font-size: 12px; color: #b5b5b5; }
    table { min-width: 100%; border-collapse: collapse; color: #f0f0f0; table-layout: auto; }
    th, td { padding: 8px; border-bottom: 1px solid #2a2a2a; text-align: left; white-space: nowrap; }
    th { background: #1e1e24; position: sticky; top: 0; color: #ffffff; z-index: 10; }
    th[data-column="description"], td[data-column="description"] { max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
    .right { text-align: center; }
    .error { color: #ff6b6b; font-size: 13px; }
    .hidden { display: none; }
    tr:nth-child(even) td { background: #15151a; }
    tr:nth-child(odd) td { background: #101015; }
    .zero-value {
      color: #ff6b6b !important;
      font-weight: 500;
    }

    /* Warning for products without price */
    .no-price-warning {
      border-left: 3px solid #ff9800 !important;
      background: rgba(255, 152, 0, 0.05) !important;
    }

    .no-price-warning:hover {
      background: rgba(255, 152, 0, 0.1) !important;
    }

    th.sortable {
      cursor: pointer;
    }
    th.sortable:hover {
      background-color: #2a2a33;
    }
    .toolbar input[type="text"] {
      padding: 6px 10px;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      background: #1b1b1f;
      color: #f0f0f0;
    }
    #buyNowBtn {
      background-color: #f44336; /* Red */
      color: white;
      border-radius: 4px;
      padding: 6px 10px;
    }
    #buyNowBtn:hover {
      background-color: #da190b;
    }
    #exportBtn {
      background-color: #4CAF50; /* Green */
      color: white;
      border: 1px solid #4CAF50;
    }
    #exportBtn:hover {
      background-color: #45a049;
    }
    .buy-input {
      width: 50px;
      max-width: 50px;
      text-align: center;
      padding: 4px 2px;
    }
    #columnFilterDropdown {
      background-color: #1b1b1f;
      border: 1px solid #2a2a2a;
      padding: 10px;
      z-index: 100;
      margin-top: 8px; /* Added to position below the button */
      display: none;
      flex-direction: column;
      gap: 5px;
      border-radius: 4px;
    }
    #columnFilterDropdown:not(.hidden) {
      display: flex;
    }
    #columnFilterDropdown label {
      color: #f0f0f0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #columnFilterDropdown input[type="checkbox"] {
      accent-color: #2a2a33;
    }
    .cart-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 4px;
      border: 1px solid #3a3a44;
      background: #2a2a33;
      color: #f1f1f1;
      cursor: pointer;
    }
    .cart-btn:hover {
      background: #34343c;
    }
    .cart-badge {
      display: inline-block;
      min-width: 18px;
      padding: 0 6px;
      margin-left: 8px;
      border-radius: 10px;
      background: #4CAF50;
      color: white;
      font-size: 12px;
      text-align: center;
    }
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      display: none; /* Changed from flex to none */
      align-items: center;
      justify-content: center;
    }
    .modal:not(.hidden) {
      display: flex;
    }
    .modal-content {
      background-color: #1e1e24;
      margin: auto;
      padding: 20px;
      border: 1px solid #2a2a2a;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      border-radius: 8px;
      position: relative;
      color: #f1f1f1;
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        max-width: 95%;
        padding: 15px;
        max-height: 95vh;
      }
    }
    .close-button {
      color: #aaa;
      float: left;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      left: 20px;
      cursor: pointer;
    }
    .close-button:hover,
    .close-button:focus {
      color: #f1f1f1;
      text-decoration: none;
      cursor: pointer;
    }
    #modalSummaryContent {
      margin-top: 20px;
      white-space: pre-wrap; /* Preserve newlines */
      font-family: monospace;
    }
    .modal-total {
      margin-top: 20px;
      font-weight: bold;
      font-size: 1.2em;
      text-align: right;
    }

    /* Ocultar botones de toggle en desktop */
    .mobile-column-toggles {
      display: none;
    }

    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }
      h1 {
        font-size: 18px;
      }
      .container {
        padding: 8px;
      }
      .header {
        padding: 12px;
        flex-direction: column;
        align-items: stretch;
      }
      .header-logo {
        position: relative;
        left: 0;
        margin: 0 auto 10px auto;
        max-width: 150px;
      }
      .header-stats {
        display: none !important;
      }

      /* Notifications mobile */
      .notifications-container {
        position: relative;
        left: auto;
        right: auto;
        top: auto;
        transform: none;
        margin: 8px auto 0;
        display: flex;
        justify-content: center;
      }

      .notifications-bell {
        width: 44px;
        height: 44px;
      }

      .notifications-dropdown {
        width: calc(100vw - 32px);
        left: 50%;
        right: auto;
        transform: translateX(-50%);
      }

      .tab {
        padding: 6px 8px;
        font-size: 12px;
      }
      .toolbar {
        flex-wrap: wrap;
        gap: 6px;
      }
      .toolbar button {
        font-size: 12px;
        padding: 8px 10px;
      }
      .cart-btn {
        width: 36px;
        height: 36px;
      }
      .slide-menu-content {
        width: 85%;
        max-width: 350px;
      }
      th, td {
        padding: 6px 4px;
        font-size: 11px;
      }
      .buy-input {
        width: 45px;
        max-width: 45px;
        padding: 4px 2px;
        font-size: 12px;
      }

      /* Ocultar columnas en móvil por defecto */
      table thead th:first-child,
      table tbody td:first-child {
        display: none;
      }

      table thead th[data-column="stock"],
      table thead th[data-column="stockTeorico"],
      table thead th[data-column="teorico"],
      table tbody td[data-column="stock"],
      table tbody td[data-column="stockTeorico"],
      table tbody td[data-column="teorico"] {
        display: none;
      }

      table thead th[data-column="transito"],
      table tbody td[data-column="transito"] {
        display: none;
      }

      /* Mostrar columnas cuando están activas */
      table.show-articulo thead th:first-child,
      table.show-articulo tbody td:first-child {
        display: table-cell;
      }

      table.show-stock thead th[data-column="stock"],
      table.show-stock thead th[data-column="stockTeorico"],
      table.show-stock thead th[data-column="teorico"],
      table.show-stock tbody td[data-column="stock"],
      table.show-stock tbody td[data-column="stockTeorico"],
      table.show-stock tbody td[data-column="teorico"] {
        display: table-cell;
      }

      table.show-transito thead th[data-column="transito"],
      table.show-transito tbody td[data-column="transito"] {
        display: table-cell;
      }

      /* Botones de toggle de columnas en móvil - solo en vista tabla */
      .container.table-view-active .mobile-column-toggles {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        padding: 8px;
        background: #1b1b1f;
        border-radius: 6px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .column-toggle-btn {
        padding: 6px 12px;
        border: 1px solid #3a3a44;
        background: #2a2a33;
        color: #f0f0f0;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .column-toggle-btn.active {
        background: #4CAF50;
        border-color: #4CAF50;
      }

      /* Tabs horizontales en móviles - estirar a ancho completo */
      .mdc-tab-bar {
        max-width: 100% !important;
        width: 100% !important;
      }

      .mdc-tab-scroller__scroll-area {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
        scrollbar-width: thin !important;
      }

      .mdc-tab-scroller__scroll-area::-webkit-scrollbar {
        height: 3px !important;
      }

      .mdc-tab-scroller__scroll-area::-webkit-scrollbar-track {
        background: #1b1b1f !important;
      }

      .mdc-tab-scroller__scroll-area::-webkit-scrollbar-thumb {
        background: #4CAF50 !important;
        border-radius: 3px !important;
      }

      .mdc-tab-scroller__scroll-content {
        display: flex !important;
        flex-direction: row !important;
        gap: 0 !important;
        width: auto !important;
      }

      .mdc-tab {
        border-radius: 6px 6px 0 0 !important;
        margin-right: 0 !important;
        flex: 0 0 auto !important;
        width: auto !important;
        min-width: 80px !important;
        padding: 0 16px !important;
        justify-content: center !important;
        text-align: center !important;
        border-bottom: none !important;
      }

      .mdc-tab__content {
        justify-content: center !important;
      }

      .mdc-tab-indicator__content--underline {
        border-left-width: 0 !important;
        border-bottom-width: 3px !important;
      }

      .mdc-tab-indicator {
        height: 3px !important;
        width: 100% !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        top: auto !important;
      }

      /* Segunda fila de tabs - admin */
      .admin-tab-bar {
        margin-top: 8px !important;
      }

      .admin-tab-bar .mdc-tab {
        background: #2a2a33 !important;
        border-radius: 6px 6px 0 0 !important;
      }

      .admin-tab-bar .mdc-tab--active {
        background: #1e1e24 !important;
      }
    }

    /* Extra small devices (phones, less than 480px) */
    @media (max-width: 480px) {
      .header {
        padding: 10px 8px;
      }

      .header-logo {
        max-width: 120px;
      }

      .header-stats {
        display: none !important;
      }

      .container {
        padding: 6px;
      }

      .toolbar {
        gap: 4px;
      }

      .toolbar button {
        padding: 6px 8px;
        font-size: 11px;
      }

      .cart-btn {
        width: 32px;
        height: 32px;
      }

      .hamburger-btn {
        width: 45px;
        height: 45px;
        top: 15px;
        right: 15px;
      }

      .slide-menu-content {
        width: 90%;
      }

      th, td {
        padding: 4px 2px;
        font-size: 10px;
      }

      .buy-input {
        width: 40px;
        max-width: 40px;
        padding: 3px 2px;
      }

      .modal-content {
        width: 98%;
        padding: 10px;
      }

      .column-toggle-btn {
        padding: 4px 8px;
        font-size: 11px;
      }

      .mobile-column-toggles {
        gap: 4px;
        padding: 6px;
      }

      .tab {
        padding: 5px 6px;
        font-size: 11px;
      }
    }

    /* === HAMBURGER MENU === */
    .hamburger-btn {
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      z-index: 1001 !important;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #4CAF50, #45a049) !important;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex !important;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    .hamburger-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }
    
    .hamburger-line {
      width: 20px;
      height: 2px;
      background: white !important;
      border-radius: 1px;
      transition: all 0.3s ease;
      display: block !important;
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(1) {
      transform: rotate(45deg) translate(6px, 6px);
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(2) {
      opacity: 0;
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }

    /* === CHATBOT STYLES REMOVIDOS (ahora en ayuda.html) === */

    /* === SLIDE MENU === */
    .slide-menu {
      position: fixed !important;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      z-index: 1000 !important;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }
    
    .slide-menu.active {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    
    .slide-menu-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
    }
    
    .slide-menu-content {
      position: absolute;
      top: 0;
      right: 0;
      width: 400px;
      height: 100%;
      background: #1e1e24;
      border-left: 1px solid #3a3a3f;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    
    .slide-menu.active .slide-menu-content {
      transform: translateX(0);
    }
    
    .slide-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #3a3a3f;
    }
    
    .slide-menu-header h3 {
      margin: 0;
      color: #4CAF50;
      font-size: 20px;
    }
    
    .close-menu-btn {
      background: none;
      border: none;
      color: #b5b5b5;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      transition: color 0.3s ease;
    }
    
    .close-menu-btn:hover {
      color: #f1f1f1;
    }
    
    /* === MENU TABS === */
    .menu-sections {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 0;
    }
    
    .menu-btn {
      width: 100%;
      padding: 16px 20px;
      border: none;
      background: #2a2a33;
      color: #f0f0f0;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      margin-bottom: 8px;
      border-radius: 6px;
    }
    
    .menu-btn:hover {
      background: #4CAF50;
      color: white;
      transform: translateX(4px);
    }

    .menu-logout-btn {
      background: #f44336 !important;
      color: white !important;
    }

    .menu-logout-btn:hover {
      background: #d32f2f !important;
    }


    .menu-footer {
      margin-top: auto;
      border-top: 1px solid #3a3a44;
      padding-top: 16px;
    }

    .menu-version {
      text-align: center;
      color: #b5b5b5;
      font-size: 14px;
      cursor: pointer;
      padding: 8px;
      transition: color 0.2s ease;
    }

    .menu-version:hover {
      color: #4CAF50;
    }

    /* === CONFIG SUBMENU === */
    .menu-btn-with-submenu {
      display: flex !important;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    .submenu-arrow {
      font-size: 20px;
      transition: transform 0.3s ease;
    }

    .menu-btn-with-submenu.active .submenu-arrow {
      transform: rotate(90deg);
    }

    .config-submenu {
      background: #1e1e26;
      border-left: 3px solid #4CAF50;
      margin-left: 20px;
      margin-bottom: 8px;
      border-radius: 6px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease, margin-bottom 0.3s ease;
    }

    .config-submenu.active {
      max-height: 300px;
    }

    .submenu-btn {
      width: 100%;
      padding: 12px 20px;
      border: none;
      background: transparent;
      color: #d0d0d0;
      cursor: pointer;
      font-weight: 400;
      font-size: 14px;
      transition: all 0.2s ease;
      text-align: left;
      border-bottom: 1px solid #2a2a33;
    }

    .submenu-btn:last-child {
      border-bottom: none;
    }

    .submenu-btn:hover {
      background: #2a2a33;
      color: #4CAF50;
      padding-left: 25px;
    }


    /* === CONFIG SECTION === */
    .menu-content h4 {
      color: #4CAF50;
      margin: 20px 0 15px 0;
      font-size: 16px;
      border-bottom: 1px solid #3a3a3f;
      padding-bottom: 8px;
    }
    
    .config-group {
      margin-bottom: 20px;
    }
    
    .config-group label {
      display: block;
      color: #f1f1f1;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .config-group input,
    .config-group select {
      width: 100%;
      padding: 12px;
      background: #2a2a2f;
      border: 1px solid #3a3a3f;
      border-radius: 6px;
      color: #f1f1f1;
      font-size: 14px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    
    .config-group input:focus,
    .config-group select:focus {
      outline: none;
      border-color: #4CAF50;
    }
    
    .config-group small {
      color: #b5b5b5;
      font-size: 12px;
      margin-top: 4px;
      display: block;
    }
    
    .refresh-input-group {
      display: flex;
      gap: 10px;
    }
    
    .refresh-input-group input {
      flex: 1;
    }
    
    .refresh-input-group select {
      flex: 1;
    }
    
    .config-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 30px;
    }
    
    .save-config-btn,
    .reset-config-btn,
    .refresh-stats-btn,
    .clear-stats-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .save-config-btn {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
    }
    
    .save-config-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    
    .reset-config-btn {
      background: #6c757d;
      color: white;
    }
    
    .reset-config-btn:hover {
      background: #5a6268;
    }
    
    /* Ensure grid is completely hidden when not in use */
    #productsGrid[style*="display: none"],
    #productsGrid.grid-hidden {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
      position: absolute !important;
      z-index: -1 !important;
      pointer-events: none !important;
    }

    /* === STATS SECTION === */
    .stats-grid {
      display: grid !important;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
      gap: 16px !important;
      margin-bottom: 24px !important;
      width: 100% !important;
    }

    #master-content .stats-grid,
    .stats-grid {
      display: grid !important;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
      gap: 16px !important;
    }

    #master-content .stat-item,
    .stat-item {
      text-align: center !important;
      background: #2a2a33 !important;
      padding: 16px !important;
      border-radius: 6px !important;
      border: 1px solid #3a3a44 !important;
      list-style: none !important;
      min-height: 80px !important;
      display: flex !important;
      flex-direction: column !important;
      justify-content: center !important;
      align-items: center !important;
      box-sizing: border-box !important;
    }

    #master-content .stat-number,
    .stat-number {
      display: block !important;
      font-size: 24px !important;
      font-weight: bold !important;
      color: #4CAF50 !important;
      margin-bottom: 4px !important;
      line-height: 1.2 !important;
    }

    #master-content .stat-label,
    .stat-label {
      display: block !important;
      font-size: 12px !important;
      color: #b5b5b5 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
      line-height: 1.4 !important;
      margin: 0 !important;
    }
    
    .stat-value {
      color: #f1f1f1;
      font-size: 18px;
      font-weight: 600;
    }
    
    .stats-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .refresh-stats-btn {
      background: linear-gradient(135deg, #2196F3, #1976D2);
      color: white;
    }
    
    .refresh-stats-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }
    
    .clear-stats-btn {
      background: #dc3545;
      color: white;
    }
    
    .clear-stats-btn:hover {
      background: #c82333;
    }

    /* Profile Modal Styles */
    .profile-form {
      max-width: 500px;
      margin: 0 auto;
    }

    .profile-section {
      margin-bottom: 30px;
    }

    .profile-section h3 {
      color: #4CAF50;
      margin-bottom: 20px;
      font-size: 18px;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 8px;
    }

    .profile-field {
      margin-bottom: 20px;
    }

    .profile-field label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 14px;
    }

    .profile-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .profile-input:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .profile-textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    .profile-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 30px 0 20px 0;
    }

    .profile-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .profile-save-btn {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
    }

    .profile-save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .profile-clear-btn {
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
    }

    .profile-clear-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
    }

    .profile-info {
      background: #2a2a32;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
      margin-top: 20px;
    }

    .profile-info p {
      margin: 8px 0;
      color: #e0e0e0;
    }

    .profile-info small {
      color: #999;
      font-style: italic;
    }

    .btn-icon {
      font-size: 16px;
    }

    /* Responsive Profile */
    @media (max-width: 768px) {
      .profile-form {
        padding: 0 10px;
      }

      .profile-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .profile-btn {
        justify-content: center;
      }
    }

    /* Historial Modal Styles */
    .historial-content {
      max-height: 60vh;
      overflow-y: auto;
    }

    /* Clientes Modal Styles */
    .clientes-header {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .import-excel-btn, .export-excel-btn, .add-client-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .import-excel-btn {
      background: #2196F3;
      color: white;
    }

    .import-excel-btn:hover {
      background: #1976D2;
    }

    .export-excel-btn {
      background: #4CAF50;
      color: white;
    }

    .export-excel-btn:hover {
      background: #45a049;
    }

    .add-client-btn {
      background: #FF9800;
      color: white;
    }

    .add-client-btn:hover {
      background: #F57C00;
    }

    .clientes-content {
      margin-top: 16px;
    }

    .clientes-table-container {
      max-height: 60vh;
      overflow: auto;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
    }

    /* Scrollbar styling for clientes table */
    .clientes-table-container::-webkit-scrollbar {
      width: 14px;
      height: 14px;
    }

    .clientes-table-container::-webkit-scrollbar-track {
      background: #1e1e24;
      border-radius: 6px;
    }

    .clientes-table-container::-webkit-scrollbar-thumb {
      background: #4CAF50;
      border-radius: 6px;
      border: 2px solid #1e1e24;
    }

    .clientes-table-container::-webkit-scrollbar-thumb:hover {
      background: #45a049;
    }

    /* Firefox scrollbar */
    .clientes-table-container {
      scrollbar-width: auto;
      scrollbar-color: #4CAF50 #1e1e24;
    }

    .clientes-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .clientes-table th {
      position: sticky;
      top: 0;
      background: #2a2a33;
      color: #f1f1f1;
      padding: 10px 8px;
      text-align: left;
      border-bottom: 2px solid #4CAF50;
      font-weight: 600;
      white-space: nowrap;
      z-index: 10;
    }

    .clientes-table td {
      padding: 8px;
      border-bottom: 1px solid #2a2a2a;
      color: #f1f1f1;
    }

    .clientes-table tr:hover {
      background: #2a2a33;
    }

    .clientes-table tr:nth-child(even) {
      background: #1b1b1f;
    }

    .edit-client-btn, .delete-client-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      margin-right: 4px;
    }

    .edit-client-btn {
      background: #2196F3;
      color: white;
    }

    .edit-client-btn:hover {
      background: #1976D2;
    }

    .delete-client-btn {
      background: #F44336;
      color: white;
    }

    .delete-client-btn:hover {
      background: #D32F2F;
    }

    @media (max-width: 768px) {
      .clientes-table {
        font-size: 11px;
      }

      .clientes-table th,
      .clientes-table td {
        padding: 6px 4px;
      }
    }

    .historial-header {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: flex-end;
    }

    .clear-historial-btn,
    .export-historial-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .clear-historial-btn {
      background: #f44336;
      color: white;
    }

    .clear-historial-btn:hover {
      background: #d32f2f;
    }

    .export-historial-btn {
      background: #4CAF50;
      color: white;
    }

    .export-historial-btn:hover {
      background: #45a049;
    }

    .historial-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .no-historial {
      text-align: center;
      padding: 40px 20px;
      color: #b5b5b5;
    }

    .no-historial p {
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .no-historial small {
      font-size: 12px;
      color: #888;
    }

    .historial-item {
      background: #2a2a33;
      padding: 8px 12px;
      border-radius: 6px;
      border-left: 3px solid #4CAF50;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 8px;
    }

    .historial-item:hover {
      background: #3a3a44;
      transform: translateX(2px);
    }

    .historial-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .historial-date {
      font-size: 12px;
      color: #b5b5b5;
    }

    .historial-method {
      font-size: 13px;
      font-weight: 600;
      color: #4CAF50;
    }

    .historial-summary {
      font-size: 13px;
      color: #f1f1f1;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .historial-user {
      font-size: 11px;
      color: #9e9e9e;
      margin-bottom: 4px;
    }

    .historial-items-preview {
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid #3a3a44;
      color: #b5b5b5;
      font-size: 11px;
      display: none; /* Hide by default (minimized) */
    }

    .historial-item.expanded .historial-items-preview {
      display: block;
    }

    .historial-items-preview small {
      margin-right: 6px;
    }

    @media (max-width: 768px) {
      .historial-item {
        padding: 6px 10px;
      }

      .historial-summary {
        font-size: 12px;
      }

      .historial-date, .historial-method {
        font-size: 11px;
      }
    }

    .historial-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .historial-date {
      font-size: 12px;
      color: #b5b5b5;
    }

    .historial-method {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      background: #4CAF50;
      color: white;
    }

    .historial-summary {
      font-size: 14px;
      color: #f0f0f0;
    }

    .historial-user {
      font-size: 12px;
      color: #4CAF50;
      margin-top: 4px;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .slide-menu-content {
        width: 100%;
        max-width: 350px;
      }
    }

    /* === TOAST NOTIFICATION === */
    .toast-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-80px);
      z-index: 2000;
      padding: 16px 24px;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border-radius: 8px;
      font-weight: 500;
      box-shadow: 0 8px 32px rgba(76, 175, 80, 0.3);
      opacity: 0;
      transition: all 0.3s ease;
      font-size: 14px;
      max-width: 300px;
      text-align: center;
    }

    .toast-notification.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast-notification.error {
      background: linear-gradient(135deg, #f44336, #d32f2f);
      box-shadow: 0 8px 32px rgba(244, 67, 54, 0.3);
    }

    /* Quantity input styling */
    .qty-input {
      width: 30px !important;
      text-align: center !important;
      padding: 2px 1px !important;
      border: 1px solid #3a3a44 !important;
      border-radius: 4px !important;
      background: #1b1b1f !important;
      color: #f0f0f0 !important;
      font-size: 14px !important;
      font-family: inherit !important;
      transition: border-color 0.2s ease !important;
    }

    .qty-input:focus {
      outline: none !important;
      border-color: #4CAF50 !important;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2) !important;
    }

    .qty-input:hover {
      border-color: #4a4a54 !important;
    }

    /* Remove number input spinners */
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none !important;
      margin: 0 !important;
    }

    .qty-input[type=number] {
      -moz-appearance: textfield !important;
    }

    /* Quantity button styling */
    .qty-btn {
      padding: 4px 8px !important;
      cursor: pointer !important;
      border: none !important;
      border-radius: 4px !important;
      font-weight: bold !important;
      transition: all 0.2s ease !important;
      color: white !important;
    }

    .qty-btn[data-action="increase"] {
      background: #4CAF50 !important;
    }

    .qty-btn[data-action="increase"]:hover {
      background: #45a049 !important;
    }

    .qty-btn[data-action="decrease"] {
      background: #f44336 !important;
    }

    .qty-btn[data-action="decrease"]:hover {
      background: #da190b !important;
    }

    /* Logistics Modal Styles */
    .logistics-content {
      max-height: 70vh;
      overflow-y: auto;
    }

    .logistics-section {
      margin-bottom: 24px;
      padding: 16px;
      background: #15151a;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
    }

    .logistics-section h4 {
      margin: 0 0 12px 0;
      color: #4CAF50;
      font-size: 16px;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 8px;
    }

    .logistics-orders {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .no-orders {
      color: #b5b5b5;
      font-style: italic;
      text-align: center;
      padding: 20px;
      margin: 0;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2a2a33;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #4CAF50;
    }

    .order-info {
      flex: 1;
    }

    .order-number {
      font-weight: 600;
      color: #4CAF50;
      margin-bottom: 4px;
    }

    .order-details {
      font-size: 12px;
      color: #b5b5b5;
    }

    .editable-client, .editable-seller {
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 3px;
      border: 1px solid transparent;
      transition: all 0.2s ease;
      color: #4CAF50;
      font-weight: 500;
    }

    .editable-client:hover, .editable-seller:hover {
      background-color: rgba(76, 175, 80, 0.1);
      border-color: #4CAF50;
      transform: scale(1.02);
    }

    .order-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .move-order-btn {
      background: #4CAF50 !important;
      border: none !important;
      color: white !important;
      padding: 8px 16px !important;
      border-radius: 4px !important;
      cursor: pointer !important;
      font-size: 13px !important;
      transition: all 0.2s ease !important;
      white-space: nowrap !important;
      display: inline-block !important;
      min-width: 120px !important;
      text-align: center !important;
      line-height: 1.4 !important;
    }

    .move-order-btn:hover {
      background: #45a049 !important;
      transform: translateY(-2px) !important;
    }

    .move-order-btn-up {
      background: #FF9800 !important;
      border: none !important;
      color: white !important;
      width: 32px !important;
      height: 32px !important;
      border-radius: 50% !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 16px !important;
      transition: all 0.2s ease !important;
    }

    .move-order-btn-up:hover {
      background: #F57C00 !important;
      transform: translateY(-2px) !important;
    }

    .cancel-order-btn {
      background: #F44336 !important;
      border: none !important;
      color: white !important;
      padding: 6px 12px !important;
      border-radius: 4px !important;
      cursor: pointer !important;
      font-size: 12px !important;
      transition: all 0.2s ease !important;
      white-space: nowrap !important;
      display: inline-block !important;
    }

    .cancel-order-btn:hover {
      background: #d32f2f !important;
    }

    .edit-order-btn {
      background: #FF9800 !important;
      border: none !important;
      color: white !important;
      padding: 6px 12px !important;
      border-radius: 4px !important;
      cursor: pointer !important;
      font-size: 12px !important;
      transition: all 0.2s ease !important;
      white-space: nowrap !important;
      display: inline-block !important;
    }

    .edit-order-btn:hover {
      background: #F57C00 !important;
    }

    .delivered-status {
      color: #4CAF50 !important;
      font-size: 13px !important;
      font-weight: bold !important;
      background: rgba(76, 175, 80, 0.15) !important;
      padding: 6px 12px !important;
      border-radius: 4px !important;
      display: inline-block !important;
      border: 1px solid #4CAF50 !important;
    }

    .closed-status {
      color: #9E9E9E !important;
      font-size: 13px !important;
      font-weight: bold !important;
      background: rgba(158, 158, 158, 0.15) !important;
      padding: 6px 12px !important;
      border-radius: 4px !important;
      display: inline-block !important;
      border: 1px solid #9E9E9E !important;
    }

    .cancelled-status {
      color: #F44336 !important;
      font-size: 13px !important;
      font-weight: bold !important;
      background: rgba(244, 67, 54, 0.15) !important;
      padding: 6px 12px !important;
      border-radius: 4px !important;
      display: inline-block !important;
      border: 1px solid #F44336 !important;
    }


    /* Mobile responsive for order cards */
    @media (max-width: 768px) {
      .order-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .order-info {
        width: 100%;
      }

      .order-actions {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }
    }

    /* Photo Upload Styles */
    .photo-upload-content {
      text-align: center;
      padding: 20px;
    }

    .upload-options {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin: 24px 0;
    }

    .upload-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
    }

    .camera-btn {
      background: #4CAF50;
      color: white;
    }

    .camera-btn:hover {
      background: #45a049;
      transform: translateY(-2px);
    }

    .file-btn {
      background: #2196F3;
      color: white;
    }

    .file-btn:hover {
      background: #1976D2;
      transform: translateY(-2px);
    }

    .photo-preview {
      margin-top: 20px;
      text-align: center;
    }

    .photo-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      border: 2px solid #ddd;
      margin-bottom: 16px;
    }

    .photo-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .upload-confirm-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .upload-confirm-btn:hover {
      background: #45a049;
    }

    .upload-cancel-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .upload-cancel-btn:hover {
      background: #d32f2f;
    }

    .upload-progress {
      margin-top: 20px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: #4CAF50;
      width: 0%;
      transition: width 0.3s ease;
      animation: pulse 1.5s ease-in-out infinite alternate;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      100% { opacity: 1; }
    }

    /* Photo View Styles */
    .photo-view-content {
      text-align: center;
      padding: 20px;
    }

    .photo-view-content img {
      max-width: 100%;
      max-height: 500px;
      border-radius: 8px;
      border: 2px solid #ddd;
      margin-bottom: 16px;
    }

    .photo-info {
      background: #15151a;
      padding: 12px;
      border-radius: 6px;
      color: #b5b5b5;
    }

    .photo-info p {
      margin: 4px 0;
    }

    .order-item {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .order-id {
      font-weight: bold;
      color: #4CAF50;
    }

    .order-actions {
      display: flex;
      gap: 8px;
    }

    .move-order-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .move-order-btn:hover {
      background: #1976D2;
    }

    .view-photo-btn {
      background: #FF9800;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      min-width: auto;
      height: 24px;
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }

    .view-photo-btn:hover {
      background: #F57C00;
    }

    .delivered-status {
      color: #4CAF50;
      font-size: 12px;
      font-weight: bold;
      margin-right: 8px;
    }

    .closed-status {
      color: #9E9E9E;
      font-size: 12px;
      font-weight: bold;
    }

    .cancelled-status {
      color: #F44336;
      font-size: 12px;
      font-weight: bold;
    }

    .current-status {
      color: #2196F3;
      font-size: 12px;
      font-weight: bold;
    }

    /* Order Details Modal */
    .order-details-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      overflow-y: auto;
    }

    .order-details-modal-content {
      background-color: #1e1e24;
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 1000px;
      border: 2px solid #4CAF50;
      position: relative;
    }

    .order-details-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 20px;
    }

    .order-details-close:hover,
    .order-details-close:focus {
      color: #f1f1f1;
    }

    .order-details-header {
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }

    .order-details-title {
      font-size: 24px;
      color: #4CAF50;
      font-weight: 600;
      margin: 0;
    }

    .order-details-section {
      margin-bottom: 20px;
    }

    .order-details-section h3 {
      color: #4CAF50;
      font-size: 16px;
      margin-bottom: 10px;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 5px;
    }

    .order-details-info {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .order-details-label {
      color: #b5b5b5;
      font-weight: 500;
    }

    .order-details-value {
      color: #f1f1f1;
    }

    .order-items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: fixed;
    }

    .order-items-table th {
      background: #2a2a33;
      color: #ffffff;
      padding: 10px;
      text-align: left;
      font-size: 14px;
    }

    /* Column widths */
    .order-items-table th:nth-child(1),
    .order-items-table td:nth-child(1) {
      width: 18%;
    }

    .order-items-table th:nth-child(2),
    .order-items-table td:nth-child(2) {
      width: 40%;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .order-items-table th:nth-child(3),
    .order-items-table td:nth-child(3) {
      width: 12%;
      text-align: center;
    }

    .order-items-table th:nth-child(4),
    .order-items-table td:nth-child(4) {
      width: 15%;
      text-align: right;
    }

    .order-items-table th:nth-child(5),
    .order-items-table td:nth-child(5) {
      width: 15%;
      text-align: right;
    }

    .order-items-table td {
      padding: 10px;
      border-bottom: 1px solid #2a2a2a;
      color: #f1f1f1;
    }

    .order-items-table tr:last-child td {
      border-bottom: none;
    }

    /* Responsive table for mobile */
    @media (max-width: 768px) {
      .order-details-modal-content {
        width: 95%;
        padding: 20px;
      }

      .order-items-table {
        font-size: 11px;
      }

      .order-items-table th,
      .order-items-table td {
        padding: 5px;
      }

      .order-items-table th:nth-child(1),
      .order-items-table td:nth-child(1) {
        width: 20%;
      }

      .order-items-table th:nth-child(2),
      .order-items-table td:nth-child(2) {
        width: 35%;
      }

      .order-items-table th:nth-child(3),
      .order-items-table td:nth-child(3) {
        width: 15%;
      }

      .order-items-table th:nth-child(4),
      .order-items-table td:nth-child(4) {
        width: 15%;
      }

      .order-items-table th:nth-child(5),
      .order-items-table td:nth-child(5) {
        width: 15%;
      }
    }

    .order-total {
      text-align: right;
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #4CAF50;
    }

    .order-item {
      cursor: pointer;
      transition: transform 0.2s;
    }

    .order-item:hover {
      transform: translateX(5px);
      background: #34343c;
    }

    .cancel-order-btn {
      background: #F44336;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 4px;
    }

    .cancel-order-btn:hover {
      background: #D32F2F;
    }

    .order-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2a2a33;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #4CAF50;
    }

    .order-info {
      flex: 1;
    }

    .order-number {
      font-weight: 600;
      color: #4CAF50;
      margin-bottom: 4px;
    }

    .order-details {
      font-size: 12px;
      color: #b5b5b5;
    }

    .move-order-btn {
      background: #4CAF50;
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
      margin-left: 12px;
    }

    .move-order-btn:hover {
      background: #45a049;
      transform: translateY(2px);
    }

    .move-order-btn:disabled {
      background: #3a3a44;
      cursor: not-allowed;
      transform: none;
    }

    .move-order-btn-up {
      background: #FF9800;
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
      margin-left: 12px;
    }

    .move-order-btn-up:hover {
      background: #F57C00;
      transform: translateY(-2px);
    }

    .move-order-btn-photo {
      background: #9C27B0;
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
      margin-left: 12px;
    }

    .move-order-btn-photo:hover {
      background: #7B1FA2;
      transform: scale(1.1);
    }

    /* Sortable table headers */
    .sortable-header {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 20px !important;
    }

    .sortable-header:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .sort-arrow {
      position: absolute;
      right: 5px;
      opacity: 0.5;
      font-size: 12px;
    }

    .sortable-header.sort-asc .sort-arrow::after {
      content: ' ↑';
      opacity: 1;
      color: #00BCD4;
    }

    .sortable-header.sort-desc .sort-arrow::after {
      content: ' ↓';
      opacity: 1;
      color: #00BCD4;
    }

    /* Editable quantity input in modal */
    .editable-quantity {
      width: 60px;
      padding: 4px 8px;
      border: 1px solid #444;
      background: #2a2a34;
      color: white;
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
    }

    .editable-quantity:focus {
      outline: none;
      border-color: #00BCD4;
    }

    /* Logout button specific styling */
    #logoutBtn {
      background-color: #f44336 !important;
    }

    #logoutBtn:hover {
      background-color: #d32f2f !important;
    }

    /* Ocultar logo en dispositivos móviles */
    @media (max-width: 768px) {
      .header-logo {
        display: none;
      }

      /* Reposicionar chatbot cuando logo está oculto */
      .chatbot-btn {
        top: 85px !important;
        left: 20px !important;
      }
    }

    /* ========================================
       VIEW MODE SELECTOR STYLES
       ======================================== */
    .view-mode-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      padding: 8px;
      background: #1b1b1f;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
      flex-wrap: wrap;
    }

    .view-mode-btn {
      background: #23232a;
      border: 1px solid #3a3a44;
      border-radius: 6px;
      padding: 10px 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #d0d0d0;
    }

    .view-mode-btn:hover {
      background: #2a2a2f;
      border-color: #4CAF50;
      color: #ffffff;
      transform: translateY(-1px);
    }

    .view-mode-btn.active {
      background: #4CAF50;
      border-color: #4CAF50;
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }

    .view-mode-btn .material-icons {
      font-size: 24px;
    }

    /* View Container Management */
    .view-container {
      transition: opacity 0.3s ease;
    }

    .view-container:not(.active) {
      display: none;
    }

    /* ========================================
       PRODUCT CARD BASE STYLES
       ======================================== */
    .product-card {
      background: #1e1e24;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 16px;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .product-card:hover {
      border-color: #4CAF50;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
      transform: translateY(-2px);
    }

    .product-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 6px;
      background: #2a2a2a;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 48px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .product-image:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
      z-index: 1;
    }

    .product-image.placeholder {
      background: linear-gradient(135deg, #2a2a2a 0%, #1e1e24 100%);
    }

    .product-title {
      font-size: 16px;
      font-weight: 600;
      color: #f1f1f1;
      margin-bottom: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .product-code {
      font-size: 12px;
      color: #888;
      margin-bottom: 12px;
    }

    .product-description {
      font-size: 14px;
      color: #b0b0b0;
      margin-bottom: 12px;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }

    .product-info {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .product-info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .product-info-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .product-info-value {
      font-size: 16px;
      font-weight: 600;
      color: #f1f1f1;
    }

    .product-price {
      font-size: 24px;
      font-weight: 700;
      color: #4CAF50;
      margin-bottom: 12px;
    }

    .product-quantity-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: auto;
    }

    .product-quantity-controls button {
      background: #2a2a33;
      border: 1px solid #3a3a44;
      color: #f1f1f1;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 18px;
      font-weight: bold;
    }

    .product-quantity-controls button:hover {
      background: #4CAF50;
      border-color: #4CAF50;
    }

    .product-quantity-controls input {
      width: 60px;
      text-align: center;
      padding: 8px;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      background: #1b1b1f;
      color: #f1f1f1;
      font-size: 16px;
    }

    /* ========================================
       LIST VIEW STYLES
       ======================================== */
    .products-grid.list-view {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px;
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
    }

    .products-grid.list-view .product-card {
      flex-direction: row;
      gap: 20px;
      padding: 16px;
      min-height: 140px;
    }

    .products-grid.list-view .product-image {
      width: 120px;
      height: 120px;
      min-width: 120px;
      margin-bottom: 0;
      font-size: 48px;
    }

    .products-grid.list-view .product-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .products-grid.list-view .product-main-info {
      flex: 1;
      min-width: 250px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .products-grid.list-view .product-title {
      font-size: 16px;
      margin-bottom: 0;
      line-height: 1.4;
    }

    .products-grid.list-view .product-code {
      margin-bottom: 0;
      font-size: 13px;
    }

    .products-grid.list-view .product-description {
      display: none;
    }

    .products-grid.list-view .product-info {
      margin-bottom: 0;
      gap: 12px;
    }

    .products-grid.list-view .product-info-item {
      min-width: 90px;
    }

    .products-grid.list-view .product-info-label {
      font-size: 12px;
    }

    .products-grid.list-view .product-info-value {
      font-size: 18px;
    }

    .products-grid.list-view .product-price {
      font-size: 22px;
      margin-bottom: 0;
      min-width: 120px;
      font-weight: 700;
    }

    .products-grid.list-view .product-quantity-controls {
      margin-top: 0;
      min-width: 200px;
    }

    /* ========================================
       GRID VIEW STYLES (Classic Cards - 2 columns)
       ======================================== */
    .products-grid.grid-view {
      display: grid !important;
      grid-template-columns: repeat(2, 1fr) !important;
      gap: 20px;
      padding: 20px;
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
    }

    .products-grid.grid-view .product-card {
      height: 100%;
    }

    .products-grid.grid-view .product-image {
      height: 180px;
    }

    /* ========================================
       LARGE GRID / GALLERY VIEW STYLES (3 columns)
       ======================================== */
    .products-grid.large-grid-view {
      display: grid !important;
      grid-template-columns: repeat(3, 1fr) !important;
      gap: 24px;
      padding: 24px;
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
    }

    .products-grid.large-grid-view .product-card {
      height: 100%;
    }

    .products-grid.large-grid-view .product-image {
      height: 280px;
      font-size: 64px;
    }

    .products-grid.large-grid-view .product-title {
      font-size: 18px;
    }

    .products-grid.large-grid-view .product-description {
      -webkit-line-clamp: 4;
      font-size: 15px;
    }

    .products-grid.large-grid-view .product-price {
      font-size: 28px;
    }

    /* ========================================
       SPLIT CARD LAYOUT STYLES
       ======================================== */
    .products-grid.split-view {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px;
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
    }

    .products-grid.split-view .product-card {
      flex-direction: row;
      gap: 20px;
      padding: 20px;
    }

    .products-grid.split-view .product-image {
      width: 160px;
      height: 160px;
      min-width: 160px;
      margin-bottom: 0;
      font-size: 48px;
    }

    .products-grid.split-view .product-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .products-grid.split-view .product-title {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .products-grid.split-view .product-description {
      -webkit-line-clamp: 4;
      margin-bottom: 16px;
      font-size: 15px;
    }

    .products-grid.split-view .product-info {
      flex-direction: row;
      gap: 16px;
    }

    .products-grid.split-view .product-price {
      font-size: 26px;
    }

    /* ========================================
       MASONRY / PINTEREST-STYLE GRID
       ======================================== */
    .products-grid.masonry-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
      padding: 16px;
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      grid-auto-flow: dense;
    }

    .products-grid.masonry-view .product-card {
      height: fit-content;
    }

    .products-grid.masonry-view .product-card:nth-child(3n+1) .product-image {
      height: 220px;
    }

    .products-grid.masonry-view .product-card:nth-child(3n+2) .product-image {
      height: 160px;
    }

    .products-grid.masonry-view .product-card:nth-child(3n+3) .product-image {
      height: 190px;
    }

    .products-grid.masonry-view .product-description {
      -webkit-line-clamp: 2;
    }

    /* ========================================
       RESPONSIVE DESIGN FOR VIEW MODES
       ======================================== */
    @media (max-width: 768px) {
      .view-mode-selector {
        justify-content: center;
      }

      .view-mode-btn {
        padding: 8px 12px;
      }

      /* List View Mobile - mantener horizontal pero más compacto */
      .products-grid.list-view .product-card {
        flex-direction: row;
        min-height: 150px;
        padding: 16px;
        gap: 16px;
      }

      .products-grid.list-view .product-image {
        width: 110px;
        height: 110px;
        min-width: 110px;
      }

      .products-grid.list-view .product-content {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
        justify-content: space-between;
      }

      .products-grid.list-view .product-main-info {
        min-width: 0;
        width: 100%;
        gap: 6px;
      }

      .products-grid.list-view .product-title {
        font-size: 15px;
        line-height: 1.4;
      }

      .products-grid.list-view .product-code {
        font-size: 12px;
      }

      .products-grid.list-view .product-info {
        flex-direction: row;
        gap: 10px;
      }

      .products-grid.list-view .product-info-item {
        min-width: 65px;
      }

      .products-grid.list-view .product-info-label {
        font-size: 11px;
      }

      .products-grid.list-view .product-info-value {
        font-size: 16px;
      }

      .products-grid.list-view .product-price {
        font-size: 20px;
        min-width: auto;
      }

      .products-grid.list-view .product-quantity-controls {
        width: 100%;
        min-width: 100%;
        justify-content: space-between;
      }

      .products-grid.list-view .product-quantity-controls button {
        padding: 6px 12px;
      }

      .products-grid.list-view .product-quantity-controls input {
        width: 50px;
      }

      /* Grid View Mobile - 2 columns */
      .products-grid.grid-view {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px;
        padding: 12px;
      }

      .products-grid.grid-view .product-image {
        height: 140px;
      }

      .products-grid.grid-view .product-title {
        font-size: 14px;
      }

      .products-grid.grid-view .product-price {
        font-size: 18px;
      }

      /* Large Grid Mobile - 2 columns (3 would be too cramped) */
      .products-grid.large-grid-view {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 16px;
        padding: 16px;
      }

      /* Split View Mobile */
      .products-grid.split-view .product-card {
        flex-direction: column;
      }

      .products-grid.split-view .product-image {
        width: 100%;
        height: 200px;
      }

      /* Masonry Mobile */
      .products-grid.masonry-view {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
        padding: 10px;
      }

      .products-grid.masonry-view .product-card:nth-child(n) .product-image {
        height: 140px;
      }
    }

    @media (max-width: 480px) {
      /* En pantallas muy pequeñas, todas las vistas se convierten en 1 columna */
      .products-grid.grid-view {
        grid-template-columns: 1fr !important;
      }

      .products-grid.large-grid-view {
        grid-template-columns: 1fr !important;
      }

      .products-grid.masonry-view {
        grid-template-columns: 1fr !important;
      }
    }

    /* ========================================
       PRODUCT DETAIL MODAL
       ======================================== */
    .product-detail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    }

    .product-detail-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .product-detail-content {
      background: #1e1e24;
      border-radius: 12px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .product-detail-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #2a2a33;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: #f1f1f1;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .product-detail-close:hover {
      background: #f44336;
      transform: rotate(90deg);
    }

    .product-detail-header {
      display: flex;
      gap: 24px;
      padding: 24px;
      border-bottom: 1px solid #2a2a2a;
    }

    .product-detail-image-container {
      flex-shrink: 0;
      width: 300px;
      height: 300px;
      background: #2a2a2a;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .product-detail-image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-detail-image-container .placeholder {
      font-size: 80px;
      color: #666;
    }

    .product-detail-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .product-detail-title {
      font-size: 24px;
      font-weight: 600;
      color: #f1f1f1;
      line-height: 1.3;
    }

    .product-detail-code {
      font-size: 14px;
      color: #888;
      font-family: monospace;
    }

    .product-detail-price {
      font-size: 36px;
      font-weight: 700;
      color: #4CAF50;
      margin-top: auto;
    }

    .product-detail-specs {
      padding: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      border-bottom: 1px solid #2a2a2a;
    }

    .product-detail-spec {
      background: #23232a;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
    }

    .product-detail-spec-label {
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .product-detail-spec-value {
      font-size: 24px;
      font-weight: 600;
      color: #f1f1f1;
    }

    .product-detail-spec-value.zero {
      color: #f44336;
    }

    .product-detail-spec-value.positive {
      color: #4CAF50;
    }

    .product-detail-actions {
      padding: 24px;
      display: flex;
      gap: 16px;
      align-items: center;
      background: #23232a;
    }

    .product-detail-quantity {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .product-detail-quantity button {
      background: #2a2a33;
      border: 1px solid #3a3a44;
      color: #f1f1f1;
      width: 44px;
      height: 44px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      transition: all 0.2s ease;
    }

    .product-detail-quantity button:hover {
      background: #4CAF50;
      border-color: #4CAF50;
    }

    .product-detail-quantity input {
      width: 80px;
      text-align: center;
      padding: 12px;
      border: 1px solid #3a3a44;
      border-radius: 6px;
      background: #1b1b1f;
      color: #f1f1f1;
      font-size: 18px;
      font-weight: 600;
    }

    .product-detail-add-btn {
      flex: 1;
      background: #4CAF50;
      border: none;
      color: white;
      padding: 14px 24px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .product-detail-add-btn:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    /* Compact Technical Specifications (shown in header) */
    .product-tech-specs-compact {
      margin: 12px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .tech-spec-chip {
      background: #2a2a33;
      border: 1px solid #3a3a44;
      color: #d0d0d0;
      padding: 4px 10px;
      border-radius: 14px;
      font-size: 11px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
    }

    .tech-spec-chip:hover {
      background: #3a3a44;
      border-color: #4CAF50;
      color: #f1f1f1;
    }

    .tech-spec-chip-icon {
      font-size: 13px;
      opacity: 0.8;
    }

    .tech-spec-chip.highlight {
      background: #4CAF50;
      border-color: #4CAF50;
      color: white;
      font-weight: 600;
    }

    /* Technical Specifications Section */
    .product-tech-specs {
      padding: 24px;
      border-top: 1px solid #2a2a2a;
      background: #1a1a20;
    }

    .tech-specs-title {
      font-size: 18px;
      font-weight: 600;
      color: #f1f1f1;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tech-specs-title::before {
      content: "⚡";
      font-size: 20px;
    }

    .tech-specs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }

    .tech-spec-item {
      background: #23232a;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #2a2a2a;
    }

    .tech-spec-item-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .tech-spec-item-value {
      font-size: 14px;
      font-weight: 500;
      color: #f1f1f1;
      line-height: 1.3;
    }

    .tech-spec-features {
      grid-column: 1 / -1;
      background: #23232a;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #2a2a2a;
    }

    .tech-spec-features-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .tech-spec-features-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tech-spec-feature-tag {
      background: #4CAF50;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    /* Mobile responsive for modal */
    @media (max-width: 768px) {
      .product-detail-content {
        max-width: 100%;
        max-height: 100vh;
        border-radius: 0;
      }

      .product-detail-header {
        flex-direction: column;
        padding: 20px;
      }

      .product-detail-image-container {
        width: 100%;
        height: 250px;
      }

      .product-detail-title {
        font-size: 20px;
      }

      .product-tech-specs-compact {
        margin: 10px 0;
        gap: 5px;
      }

      .tech-spec-chip {
        font-size: 10px;
        padding: 3px 8px;
      }

      .product-detail-price {
        font-size: 28px;
      }

      .product-detail-specs {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        padding: 20px;
      }

      .product-detail-actions {
        flex-direction: column;
        padding: 20px;
      }

      .product-detail-quantity {
        width: 100%;
        justify-content: center;
      }

      .product-detail-add-btn {
        width: 100%;
      }

      .tech-specs-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }

      .product-tech-specs {
        padding: 20px;
      }
    }

    @media (max-width: 480px) {
      .product-detail-modal.active {
        padding: 0;
      }

      .product-detail-specs {
        grid-template-columns: 1fr;
      }

      .product-detail-spec-value {
        font-size: 20px;
      }

      .tech-specs-grid {
        grid-template-columns: 1fr;
      }

      .tech-spec-item-value {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" class="header-logo">

    <!-- Notifications Bell -->
    <div class="notifications-container">
      <button class="notifications-bell" id="notificationsBell" title="Notificaciones">
        <span class="material-icons">notifications</span>
        <span class="notifications-badge" id="notificationsBadge" style="display: none;">0</span>
      </button>

      <!-- Notifications Dropdown -->
      <div class="notifications-dropdown" id="notificationsDropdown" style="display: none;">
        <div class="notifications-header">
          <h3>Notificaciones</h3>
          <button class="notifications-close" id="notificationsClose">&times;</button>
        </div>
        <div class="notifications-list" id="notificationsList">
          <div class="notification-empty">No hay notificaciones</div>
        </div>
      </div>
    </div>

  </header>

  <div class="container">
    <!-- Primera fila de tabs: Marketplace segments -->
    <div class="mdc-tab-bar" role="tablist" id="tabs">
      <div class="mdc-tab-scroller">
        <div class="mdc-tab-scroller__scroll-area">
          <div class="mdc-tab-scroller__scroll-content">
            <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true" tabindex="0" data-segment="all">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">All</span>
              </span>
              <span class="mdc-tab-indicator mdc-tab-indicator--active">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-segment="iphone">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Iphone</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-segment="macbooks">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Macbooks</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-segment="samsung">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Samsung</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-segment="accesorios">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Accesorios</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-segment="puregear">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">PureGear</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Segunda fila de tabs: Admin tabs -->
    <div class="mdc-tab-bar admin-tab-bar" role="tablist" id="adminTabs" style="margin-top: 8px;">
      <div class="mdc-tab-scroller">
        <div class="mdc-tab-scroller__scroll-area">
          <div class="mdc-tab-scroller__scroll-content">
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-tab="precios" data-admin-only="true" style="display: none;">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">PRECIOS</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-tab="master" data-admin-only="true" style="display: none;">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">MASTER</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-tab="pausar" data-admin-only="true" style="display: none;">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">PAUSAR</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="toolbar">
      <button class="mdc-button mdc-button--raised" id="exportBtn">
        <span class="mdc-button__ripple"></span>
        <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
        <span class="mdc-button__label">Export to Excel</span>
      </button>
      <button class="mdc-button mdc-button--outlined" id="filterBtn">
        <span class="mdc-button__ripple"></span>
        <i class="material-icons mdc-button__icon" aria-hidden="true">filter_list</i>
        <span class="mdc-button__label">Filter</span>
      </button>
      <div class="mdc-text-field mdc-text-field--outlined search-field">
        <input class="mdc-text-field__input" type="text" id="searchBox" aria-describedby="search-helper-text">
        <div class="mdc-notched-outline">
          <div class="mdc-notched-outline__leading"></div>
          <div class="mdc-notched-outline__notch">
            <label for="searchBox" class="mdc-floating-label">Search model...</label>
          </div>
          <div class="mdc-notched-outline__trailing"></div>
        </div>
      </div>
      <span class="status" id="statusText" style="display: none;"></span>
      <div style="flex: 1;"></div> <!-- Spacer -->
    </div>

    <div id="columnFilterDropdown" class="hidden">
      <label><input type="checkbox" data-column="articulo" checked> Artículo</label>
      <label><input type="checkbox" data-column="description" checked> Descripción</label>
      <label><input type="checkbox" data-column="grupo"> Grupo</label>
      <label><input type="checkbox" data-column="stock"> Stock</label>
      <label><input type="checkbox" data-column="disponible" checked> Disponible</label>
      <label><input type="checkbox" data-column="fechaActualizacion"> Fecha Ult. Actualización</label>
      <label><input type="checkbox" data-column="ordenVenta"> En Orden de Venta</label>
      <label><input type="checkbox" data-column="ordenCompra"> En Orden de Compra</label>
      <label><input type="checkbox" data-column="stockTeorico" checked> Stock</label>
      <label><input type="checkbox" data-column="teorico"> Stock</label>
      <label><input type="checkbox" data-column="transito"> Tránsito</label>
      <label><input type="checkbox" data-column="costoContable"> Costo Contable</label>
      <label><input type="checkbox" data-column="totalCostoContable"> Total Costo Contable</label>
      <label><input type="checkbox" data-column="monedaCostoContable"> Moneda de Costo Contable</label>
      <label><input type="checkbox" data-column="costoContableUnidadAlternativa"> Costo Contable Unidad Alternativa</label>
      <label><input type="checkbox" data-column="price"> Price</label>

      <hr style="border-color: #3a3a44; margin: 8px 0;">
      <label><input type="checkbox" id="hideZeroValues"> Mostrar solo productos con stock disponible</label>
      <label><input type="checkbox" id="hideZeroStockAndTransit" checked> Ocultar productos sin stock ni tránsito</label>
      <label><input type="checkbox" id="showAllProducts"> Show all products (including zero stock)</label>
    </div>

    <div id="errorBox" class="error hidden"></div>

    <!-- Add to Cart button (top only) -->
    <div style="text-align: right; margin-bottom: 12px;">
      <button class="mdc-button mdc-button--raised" id="addToCartBtn" style="background-color: #f44336 !important;">
        <span class="mdc-button__ripple"></span>
        <i class="material-icons mdc-button__icon" aria-hidden="true">shopping_cart</i>
        <span class="mdc-button__label">Add to Cart</span>
      </button>
    </div>

    <!-- View Mode Selector -->
    <div class="view-mode-selector">
      <button class="view-mode-btn active" data-view="table" title="Table View">
        <span class="material-icons">table_rows</span>
      </button>
      <button class="view-mode-btn" data-view="list" title="List View">
        <span class="material-icons">view_list</span>
      </button>
      <button class="view-mode-btn" data-view="grid" title="Grid View (2 columnas)">
        <span class="material-icons">grid_view</span>
      </button>
      <button class="view-mode-btn" data-view="large-grid" title="Large Grid View (3 columnas)">
        <span class="material-icons">view_module</span>
      </button>
    </div>

    <!-- Botones de toggle de columnas para móvil -->
    <div class="mobile-column-toggles">
      <button class="column-toggle-btn" data-toggle="articulo">
        <span>+</span> Artículo
      </button>
      <button class="column-toggle-btn" data-toggle="stock">
        <span>+</span> Stock
      </button>
      <button class="column-toggle-btn" data-toggle="transito">
        <span>+</span> Tránsito
      </button>
    </div>

    <!-- PRECIOS TAB CONTENT (moved from Administration.html) -->
    <div id="precios-content" class="tab-content" style="display: none;">
      <h2>💰 Gestión de Precios</h2>
      <div class="admin-section">
        <div class="prices-header">
          <h3>Lista de Productos y Precios</h3>
          <div class="prices-actions-buttons">
            <button class="mdc-button mdc-button--outlined" id="importPricesBtn">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">upload_file</i>
              <span class="mdc-button__label">Importar Precios</span>
            </button>
            <button class="mdc-button mdc-button--outlined" id="exportCsvBtn">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
              <span class="mdc-button__label">Exportar CSV</span>
            </button>
            <button class="mdc-button mdc-button--outlined" id="exportExcelBtn">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
              <span class="mdc-button__label">Exportar Excel</span>
            </button>
            <button class="mdc-button mdc-button--raised" id="saveAllPricesBtn" style="display: none;">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">save</i>
              <span class="mdc-button__label">Guardar Todos los Precios</span>
            </button>
            <button class="mdc-button mdc-button--outlined" id="loadProductsBtn">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">refresh</i>
              <span class="mdc-button__label">Actualizar Productos</span>
            </button>
          </div>
          <input type="file" id="pricesFileInput" accept=".csv,.xlsx,.xls" style="display: none;">
        </div>

        <div id="productsContainer">
          <div class="loading-products">
            <div class="loading-content">
              <div class="loading-spinner"></div>
              <p>Cargando productos...</p>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- MASTER TAB CONTENT (moved from Administration.html) -->
    <div id="master-content" class="tab-content" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">📋 Seguimiento de Pedidos - Admin</h2>
        <div style="display: flex; gap: 10px;">
          <button class="mdc-button mdc-button--outlined" id="refreshOrdersBtn">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">refresh</i>
            <span class="mdc-button__label">Actualizar</span>
          </button>
          <button class="mdc-button mdc-button--outlined" id="exportOrdersBtn" style="background-color: #4CAF50; color: white;">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
            <span class="mdc-button__label">Exportar Excel</span>
          </button>
        </div>
      </div>

      <!-- Search Box -->
      <div style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; align-items: center; background: #2a2a32; padding: 15px; border-radius: 8px;">
          <i class="material-icons" style="color: #4CAF50;">search</i>
          <input
            type="text"
            id="orderSearchInput"
            placeholder="Buscar por número de orden, número de cliente o nombre de cliente..."
            style="flex: 1; background: #1e1e24; border: 1px solid #3a3a42; color: #fff; padding: 12px; border-radius: 4px; font-size: 14px; outline: none;"
          />
          <button
            id="clearSearchBtn"
            class="mdc-button mdc-button--outlined"
            style="display: none; min-width: auto; padding: 8px 16px;"
          >
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">clear</i>
            <span class="mdc-button__label">Limpiar</span>
          </button>
        </div>
        <div id="searchResultsCount" style="margin-top: 8px; color: #888; font-size: 13px; display: none;"></div>
      </div>

      <div class="stats-grid" style="margin-bottom: 24px;">
        <div class="stat-item">
          <span class="stat-number" id="totalOrders">0</span>
          <span class="stat-label">Total Órdenes</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="borradorOrders">0</span>
          <span class="stat-label">Borrador</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="revisionOrders">0</span>
          <span class="stat-label">En Revisión</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="aprobadaOrders">0</span>
          <span class="stat-label">Aprobadas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="preparacionOrders">0</span>
          <span class="stat-label">En Preparación</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="listoOrders">0</span>
          <span class="stat-label">Listo para Despacho</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="despachadaOrders">0</span>
          <span class="stat-label">Despachadas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="entregadaOrders">0</span>
          <span class="stat-label">Entregadas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="cerradaOrders">0</span>
          <span class="stat-label">Cerradas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="canceladaOrders">0</span>
          <span class="stat-label">Canceladas</span>
        </div>
      </div>

      <div class="logistics-content">
        <div class="logistics-section">
          <h4>📝 Borrador</h4>
          <div class="logistics-orders" id="admin-borradorOrders">
            <p class="no-orders">No hay pedidos en borrador</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>🔍 En Revisión</h4>
          <div class="logistics-orders" id="admin-revisionOrders">
            <p class="no-orders">No hay pedidos en revisión</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>✅ Aprobada</h4>
          <div class="logistics-orders" id="admin-aprobadaOrders">
            <p class="no-orders">No hay pedidos aprobados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>📦 En Preparación</h4>
          <div class="logistics-orders" id="admin-preparacionOrders">
            <p class="no-orders">No hay pedidos en preparación</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>🚚 Listo para Retiro/Despacho</h4>
          <div class="logistics-orders" id="admin-listoOrders">
            <p class="no-orders">No hay pedidos listos</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>🚛 Despachada</h4>
          <div class="logistics-orders" id="admin-despachadaOrders">
            <p class="no-orders">No hay pedidos despachados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>✅ Entregada</h4>
          <div class="logistics-orders" id="admin-entregadaOrders">
            <p class="no-orders">No hay pedidos entregados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>🔒 Cerrada</h4>
          <div class="logistics-orders" id="admin-cerradaOrders">
            <p class="no-orders">No hay pedidos cerrados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>❌ Cancelada</h4>
          <div class="logistics-orders" id="admin-canceladaOrders">
            <p class="no-orders">No hay pedidos cancelados</p>
          </div>
        </div>
      </div>
    </div>

    <!-- PAUSAR TAB CONTENT -->
    <div id="pausar-content" class="tab-content" style="display: none;">
      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; gap: 20px;">
        <h2 style="margin: 0;">⏸️ Control de Precios</h2>
        <p style="text-align: center; color: #888; max-width: 600px;">
          Utiliza este control para pausar o despausar la visualización de precios en el marketplace.
          Cuando los precios están pausados, los usuarios podrán ver los productos pero no los precios.
        </p>

        <div id="pauseStatusIndicator" style="padding: 12px 24px; border-radius: 8px; font-weight: bold; margin: 20px 0;">
          <!-- Status will be updated by JavaScript -->
        </div>

        <button
          class="mdc-button mdc-button--raised"
          id="togglePauseBtn"
          style="padding: 20px 60px; font-size: 18px; background: #FF9800; color: white;">
          <span class="mdc-button__ripple"></span>
          <i class="material-icons mdc-button__icon" aria-hidden="true" id="pauseIcon">pause_circle</i>
          <span class="mdc-button__label" id="pauseBtnLabel">PAUSAR PRECIOS</span>
        </button>

        <!-- Force Sync Button (only for troubleshooting) -->
        <button
          class="mdc-button mdc-button--outlined"
          id="forceSyncPauseBtn"
          style="padding: 12px 30px; font-size: 14px; border: 2px solid #2196F3; color: #2196F3; margin-top: 10px;">
          <span class="mdc-button__ripple"></span>
          <i class="material-icons mdc-button__icon" aria-hidden="true">sync</i>
          <span class="mdc-button__label">Forzar Sincronización</span>
        </button>

        <div style="background: #2a2a32; padding: 20px; border-radius: 8px; margin-top: 20px; max-width: 600px;">
          <h4 style="margin-top: 0; color: #4CAF50;">ℹ️ Información</h4>
          <ul style="color: #ccc; line-height: 1.8;">
            <li><strong>PAUSAR:</strong> Los precios se mostrarán como "x" en todo el marketplace</li>
            <li><strong>DESPAUSAR:</strong> Los precios originales se restaurarán automáticamente</li>
            <li>Los usuarios podrán seguir navegando y añadiendo productos al carrito</li>
            <li>Esta acción afecta a todos los usuarios del marketplace</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Table View Container -->
    <div id="tableViewContainer" class="view-container active" style="overflow: auto; max-height: 70vh; border: 1px solid #eee; border-radius: 6px; width: 100%;">
      <table id="productsTable">
        <thead></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- Products Grid Container (for card-based views) -->
    <div id="productsGrid" class="view-container products-grid" style="display: none;"></div>
  </div>

  <!-- Product Detail Modal -->
  <div id="productDetailModal" class="product-detail-modal">
    <div class="product-detail-content">
      <button class="product-detail-close" id="closeProductDetail">&times;</button>

      <div class="product-detail-header">
        <div class="product-detail-image-container" id="modalProductImageContainer">
          <span class="material-icons placeholder">inventory_2</span>
        </div>
        <div class="product-detail-info">
          <h2 class="product-detail-title" id="modalProductTitle">Título del Producto</h2>
          <div class="product-detail-code" id="modalProductCode">Código: ---</div>
          <!-- Compact Tech Specs -->
          <div id="modalTechSpecsCompact" class="product-tech-specs-compact" style="display: none;"></div>
          <div class="product-detail-price" id="modalProductPrice">$0</div>
        </div>
      </div>

      <div class="product-detail-specs">
        <div class="product-detail-spec">
          <div class="product-detail-spec-label">Stock Disponible</div>
          <div class="product-detail-spec-value" id="modalProductStock">0</div>
        </div>
        <div class="product-detail-spec">
          <div class="product-detail-spec-label">En Tránsito</div>
          <div class="product-detail-spec-value" id="modalProductTransit">0</div>
        </div>
        <div class="product-detail-spec">
          <div class="product-detail-spec-label">Total Disponible</div>
          <div class="product-detail-spec-value" id="modalProductTotal">0</div>
        </div>
      </div>

      <div class="product-detail-actions">
        <div class="product-detail-quantity">
          <button id="modalDecreaseQty">−</button>
          <input type="number" id="modalQuantity" value="0" min="0" max="999">
          <button id="modalIncreaseQty">+</button>
        </div>
        <button class="product-detail-add-btn" id="modalAddToCart">
          <span class="material-icons">shopping_cart</span>
          Agregar al Carrito
        </button>
      </div>
    </div>
  </div>

  <div id="buyModal" class="modal hidden">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>Selected Products Summary</h2>
    <div id="modalSummaryContent"></div>
    <div class="modal-total">Total: <span id="modalTotalPrice"></span></div>
  </div>
</div>

  <!-- Pause Confirmation Modal -->
  <div id="pauseConfirmModal" class="modal hidden">
    <div class="modal-content" style="max-width: 500px;">
      <span class="close-button" id="closePauseModal">&times;</span>
      <div style="text-align: center; padding: 20px;">
        <i class="material-icons" style="font-size: 64px; color: #FF9800; margin-bottom: 20px;">warning</i>
        <h2 style="color: #FF9800; margin-bottom: 16px;">⚠️ Advertencia</h2>
        <p style="font-size: 16px; line-height: 1.6; color: #ccc; margin-bottom: 24px;">
          Estás a punto de <strong>PAUSAR</strong> todos los precios del marketplace.
          Los usuarios podrán ver los productos pero no verán los precios hasta que se despause.
        </p>
        <p style="font-size: 14px; color: #888; margin-bottom: 24px;">
          ¿Estás seguro de que deseas continuar?
        </p>
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button class="mdc-button mdc-button--outlined" id="cancelPauseBtn" style="min-width: 120px;">
            <span class="mdc-button__ripple"></span>
            <span class="mdc-button__label">Cancelar</span>
          </button>
          <button class="mdc-button mdc-button--raised" id="confirmPauseBtn" style="min-width: 120px; background: #FF9800;">
            <span class="mdc-button__ripple"></span>
            <span class="mdc-button__label">Confirmar</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="main.js"></script>
  <!-- Hamburger Menu Button -->
  <button class="hamburger-btn" id="hamburgerBtn">
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
  </button>

  <!-- Chatbot REMOVIDO - ahora solo disponible en ayuda.html -->

  <!-- Slide-in Menu -->
  <div class="slide-menu" id="slideMenu">
    <div class="slide-menu-overlay" id="slideMenuOverlay"></div>
    <div class="slide-menu-content">
      <div class="slide-menu-header">
        <h3>Menu</h3>
        <button class="close-menu-btn" id="closeMenuBtn">&times;</button>
      </div>
      
      <div class="menu-sections">
        <button class="menu-btn" id="historialModalBtn">
          HISTORIAL
        </button>
        <button class="menu-btn" id="logisticsModalBtn" style="display: none;">
          SEGUIMIENTO
        </button>
        <button class="menu-btn menu-btn-with-submenu" id="configBtn" style="display: none;">
          CONFIG
          <span class="submenu-arrow">›</span>
        </button>
        <!-- Submenú de CONFIG -->
        <div class="config-submenu" id="configSubmenu" style="display: none;">
          <button class="submenu-btn" id="configProfileBtn">
            PROFILE
          </button>
          <button class="submenu-btn" id="configAdmisionesBtn">
            ADMISIONES
          </button>
          <button class="submenu-btn" id="configClienteBtn">
            CLIENTES
          </button>
          <button class="submenu-btn" id="configVendedorBtn">
            VENDEDORES
          </button>
        </div>
        <button class="menu-btn" id="estadisticasBtn" style="display: none;">
          ESTADÍSTICAS
        </button>
        <button class="menu-btn" id="ayudaBtn">
          AYUDA
        </button>
      </div>

      <div class="menu-footer">
        <button class="menu-btn menu-logout-btn" id="menuLogoutBtn">
          LOGOUT
        </button>
        <div class="menu-version" id="menuVersionBtn">
          v0.78
        </div>
      </div>
      
    </div>
  </div>

  <!-- CONFIG Modal -->
  <div id="configModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>🔧 Configuración</h2>
      
      <div class="menu-content" id="configContent">
        <h4>📞 Configuración de Contactos</h4>
        
        <div class="config-group">
          <label for="whatsappInput">WhatsApp (con código de país)</label>
          <input type="tel" id="whatsappInput" placeholder="Ej: 5491123456789" maxlength="15">
          <small>Sin +, espacios o guiones</small>
        </div>
        
        <div class="config-group">
          <label for="emailInput">Email para Pedidos</label>
          <input type="email" id="emailInput" placeholder="ventas@empresa.com">
        </div>
        
        <div class="config-group">
          <label for="companyInput">Nombre de Empresa</label>
          <input type="text" id="companyInput" placeholder="Mi Empresa">
        </div>
        
        <h4>🔄 Configuración de Refresco</h4>
        
        <div class="config-group">
          <label for="refreshTime">Tiempo de Auto-refresco</label>
          <div class="refresh-input-group">
            <input type="number" id="refreshValue" min="1" max="999" value="30">
            <select id="refreshUnit">
              <option value="seconds">Segundos</option>
              <option value="minutes">Minutos</option>
              <option value="hours">Horas</option>
            </select>
          </div>
        </div>
        
        <div class="config-actions">
          <button class="save-config-btn" id="saveConfigBtn">💾 Guardar Configuración</button>
          <button class="reset-config-btn" id="resetConfigBtn">🔄 Restaurar</button>
        </div>
      </div>
      
      <!-- STATS Section -->
      <div class="menu-content" id="statsContent" style="display: none;">
        <h4>📈 Estadísticas del Sistema</h4>
        
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">Último refresco</div>
            <div class="stat-value" id="lastRefreshStat">-</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">Total productos cargados</div>
            <div class="stat-value" id="totalProductsStat">0</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">Items en carrito</div>
            <div class="stat-value" id="cartItemsStat">0</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">Valor total carrito</div>
            <div class="stat-value" id="cartValueStat">$0</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">Tiempo de refresco</div>
            <div class="stat-value" id="refreshTimeStat">90s</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">Configuración guardada</div>
            <div class="stat-value" id="configSavedStat">❌</div>
          </div>
        </div>
        
        <div class="stats-actions">
          <button class="refresh-stats-btn" id="refreshStatsBtn">🔄 Actualizar Stats</button>
          <button class="clear-stats-btn" id="clearStatsBtn">🗑️ Limpiar Datos</button>
        </div>
      </div>
    </div>
  </div>

  <!-- STATS Modal -->
  <div id="statsModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>📊 Estadísticas</h2>
      
      <div class="stats-grid">
        <!-- Advanced Analytics -->
        <div class="stat-item">
          <div class="stat-label">Item más comprado</div>
          <div class="stat-value" id="mostPurchasedItemStat">-</div>
        </div>

        <div class="stat-item">
          <div class="stat-label">Mes con más ventas</div>
          <div class="stat-value" id="bestSalesMonthStat">-</div>
        </div>

        <div class="stat-item">
          <div class="stat-label">Item con más cambios de stock</div>
          <div class="stat-value" id="mostStockChangesStat">-</div>
        </div>

        <!-- User Analytics -->
        <div class="stat-item">
          <div class="stat-label">Usuarios registrados</div>
          <div class="stat-value" id="totalUsersStat">-</div>
        </div>

        <div class="stat-item">
          <div class="stat-label">Usuario más activo</div>
          <div class="stat-value" id="mostActiveUserStat">-</div>
        </div>
      </div>
      
      <div class="stats-actions">
        <button class="refresh-stats-btn" id="refreshStatsBtn">🔄 Actualizar Stats</button>
      </div>
    </div>
  </div>

  <!-- PROFILE Modal -->
  <div id="profileModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>👤 Mi Perfil</h2>

      <div class="profile-form">
        <div class="profile-section">
          <h3>Información Personal</h3>

          <div class="profile-field">
            <label for="profileName">Nombre Completo</label>
            <input type="text" id="profileName" class="profile-input" placeholder="Ingresa tu nombre completo">
          </div>

          <div class="profile-field">
            <label for="profileAddress">Dirección</label>
            <textarea id="profileAddress" class="profile-input profile-textarea" placeholder="Ingresa tu dirección completa" rows="3"></textarea>
          </div>

          <div class="profile-field">
            <label for="profilePhone">Teléfono Principal</label>
            <input type="tel" id="profilePhone" class="profile-input" placeholder="+54 11 1234-5678">
          </div>

          <div class="profile-field">
            <label for="profileContactPhone">Teléfono de Contacto</label>
            <input type="tel" id="profileContactPhone" class="profile-input" placeholder="+54 11 8765-4321">
          </div>
        </div>

        <div class="profile-actions">
          <button class="profile-btn profile-save-btn" id="saveProfileBtn">
            <span class="btn-icon">💾</span>
            Guardar Perfil
          </button>
          <button class="profile-btn profile-clear-btn" id="clearProfileBtn">
            <span class="btn-icon">🗑️</span>
            Limpiar Datos
          </button>
        </div>

        <div class="profile-info">
          <p><strong>📧 Usuario:</strong> <span id="profileUserEmail">-</span></p>
          <p><small>Los datos del perfil se guardan automáticamente en tu cuenta.</small></p>
        </div>
      </div>
    </div>
  </div>

  <!-- HISTORIAL Modal -->
  <div id="historialModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>📋 Historial de Pedidos</h2>
      
      <div class="historial-content">
        <div class="historial-header">
          <button class="export-historial-btn" id="exportHistorialBtn">📤 Exportar</button>
        </div>
        
        <div class="historial-list" id="historialList">
          <div class="no-historial">
            <p>📝 No hay pedidos en el historial</p>
            <small>Los pedidos enviados por WhatsApp/Email aparecerán aquí</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SEGUIMIENTO Modal -->
  <div id="logisticsModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>📋 Seguimiento de Pedidos</h2>

      <div class="logistics-content">
        <div class="logistics-section">
          <h4>📝 Borrador</h4>
          <div class="logistics-orders" id="borradorOrders">
            <p class="no-orders">No hay pedidos en borrador</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>🔍 En Revisión</h4>
          <div class="logistics-orders" id="revisionOrders">
            <p class="no-orders">No hay pedidos en revisión</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>✅ Aprobada</h4>
          <div class="logistics-orders" id="aprobadaOrders">
            <p class="no-orders">No hay pedidos aprobados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>📦 En Preparación</h4>
          <div class="logistics-orders" id="preparacionOrders">
            <p class="no-orders">No hay pedidos en preparación</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>🚚 Listo para Retiro/Despacho</h4>
          <div class="logistics-orders" id="listoOrders">
            <p class="no-orders">No hay pedidos listos</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>🚛 Despachada</h4>
          <div class="logistics-orders" id="despachadaOrders">
            <p class="no-orders">No hay pedidos despachados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>✅ Entregada</h4>
          <div class="logistics-orders" id="entregadaOrders">
            <p class="no-orders">No hay pedidos entregados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>🔒 Cerrada</h4>
          <div class="logistics-orders" id="cerradaOrders">
            <p class="no-orders">No hay pedidos cerrados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>❌ Cancelada</h4>
          <div class="logistics-orders" id="canceladaOrders">
            <p class="no-orders">No hay pedidos cancelados</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CLIENTES Modal -->
  <div id="clientesModal" class="modal hidden">
    <div class="modal-content" style="max-width: 1200px;">
      <span class="close-button">&times;</span>
      <h2>👥 Gestión de Clientes</h2>

      <div class="clientes-header">
        <button class="import-excel-btn" id="importClientesBtn">📥 Importar Excel</button>
        <button class="export-excel-btn" id="exportClientesBtn">📤 Exportar Excel</button>
        <button class="add-client-btn" id="addClientBtn" onclick="openAddClientModal()">➕ Agregar Cliente</button>
        <input type="file" id="excelFileInput" accept=".xls,.xlsx" style="display: none;">
      </div>

      <div class="clientes-content">
        <div class="clientes-table-container">
          <table class="clientes-table">
            <thead>
              <tr>
                <th>Código</th>
                <th>Nombre</th>
                <th>Nombre Comercial</th>
                <th>Grupo</th>
                <th>Departamento</th>
                <th>Inscripción</th>
                <th>Nro Documento</th>
                <th>Dirección</th>
                <th>Ciudad</th>
                <th>Provincia</th>
                <th>País</th>
                <th>Teléfono</th>
                <th>Email</th>
                <th>Saldo Crédito</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="clientesTableBody">
              <tr>
                <td colspan="15" style="text-align: center; padding: 20px;">
                  Cargando clientes...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- AGREGAR/EDITAR CLIENTE Modal -->
  <div id="addClientModal" class="modal hidden">
    <div class="modal-content" style="max-width: 600px;">
      <span class="close-button">&times;</span>
      <h2 id="clientModalTitle">➕ Agregar Cliente</h2>

      <form id="clientForm" style="display: grid; gap: 15px; margin-top: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Código *</label>
            <input type="text" id="clientCodigo" required style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Grupo</label>
            <input type="text" id="clientGrupo" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Nombre *</label>
          <input type="text" id="clientNombre" required style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Nombre Comercial</label>
          <input type="text" id="clientNombreComercial" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Inscripción</label>
            <input type="text" id="clientInscripcion" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Nro Documento</label>
            <input type="text" id="clientNroDocumento" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Dirección</label>
          <input type="text" id="clientDireccion" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Ciudad</label>
            <input type="text" id="clientCiudad" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Provincia</label>
            <input type="text" id="clientProvincia" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">País</label>
            <input type="text" id="clientPais" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Teléfono</label>
            <input type="text" id="clientTelefono" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Email</label>
            <input type="email" id="clientEmail" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Departamento</label>
            <input type="text" id="clientDepartamento" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; color: #f1f1f1; font-size: 13px;">Saldo Crédito</label>
            <input type="number" id="clientSaldoCredito" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0;">
          </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
          <button type="button" class="cancel-btn" onclick="closeModal('addClientModal')" style="padding: 10px 20px; border: 1px solid #3a3a44; border-radius: 4px; background: #2a2a33; color: #f1f1f1; cursor: pointer;">
            Cancelar
          </button>
          <button type="submit" class="save-btn" style="padding: 10px 20px; border: none; border-radius: 4px; background: #4CAF50; color: white; cursor: pointer; font-weight: 500;">
            Guardar Cliente
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- PHOTO UPLOAD Modal -->
  <div id="photoUploadModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>📸 Confirmar Entrega</h2>

      <div class="photo-upload-content">
        <p>Para marcar el pedido como entregado, por favor suba una foto de confirmación:</p>

        <div class="upload-options">
          <button class="upload-btn camera-btn" id="cameraBtn">
            📷 Abrir Cámara
          </button>
          <button class="upload-btn file-btn" id="fileBtn">
            📁 Cargar Foto Guardada
          </button>
        </div>

        <input type="file" id="photoInput" accept="image/*" capture style="display: none;">
        <input type="file" id="fileInput" accept="image/*" style="display: none;">

        <div id="photoPreview" class="photo-preview" style="display: none;">
          <img id="previewImage" src="" alt="Preview">
          <div class="photo-actions">
            <button class="upload-confirm-btn" id="confirmUploadBtn">✅ Confirmar Entrega</button>
            <button class="upload-cancel-btn" id="cancelUploadBtn">❌ Cancelar</button>
          </div>
        </div>

        <div id="uploadProgress" class="upload-progress" style="display: none;">
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
          <p>Subiendo foto...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- PHOTO VIEW Modal -->
  <div id="photoViewModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>📸 Foto de Entrega</h2>

      <div class="photo-view-content">
        <img id="viewImage" src="" alt="Delivery Photo">
        <div class="photo-info">
          <p id="photoDate"></p>
          <p id="photoOrder"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div id="orderDetailsModal" class="order-details-modal">
    <div class="order-details-modal-content">
      <span class="order-details-close">&times;</span>

      <div class="order-details-header">
        <h2 class="order-details-title" id="orderDetailsTitle">Detalles de la Orden</h2>
      </div>

      <div class="order-details-section">
        <h3>📋 Información General</h3>
        <div class="order-details-info">
          <span class="order-details-label">Número de Orden:</span>
          <span class="order-details-value" id="detailOrderNumber">-</span>
        </div>
        <div class="order-details-info">
          <span class="order-details-label">Cliente:</span>
          <span class="order-details-value" id="detailClientName">-</span>
        </div>
        <div class="order-details-info">
          <span class="order-details-label">Email:</span>
          <span class="order-details-value" id="detailClientEmail">-</span>
        </div>
        <div class="order-details-info">
          <span class="order-details-label">Fecha:</span>
          <span class="order-details-value" id="detailOrderDate">-</span>
        </div>
        <div class="order-details-info">
          <span class="order-details-label">Estado:</span>
          <span class="order-details-value" id="detailOrderState">-</span>
        </div>
        <div class="order-details-info" id="detailAdminCreatedContainer" style="display: none;">
          <span class="order-details-label">Creada por (Admin):</span>
          <span class="order-details-value" id="detailAdminCreated">-</span>
        </div>
      </div>

      <div class="order-details-section">
        <h3>🛒 Productos</h3>
        <table class="order-items-table" id="detailOrderTable">
          <thead>
            <tr>
              <th class="sortable-header" data-sort-column="articulo">Artículo <span class="sort-arrow">↕</span></th>
              <th class="sortable-header" data-sort-column="description">Descripción <span class="sort-arrow">↕</span></th>
              <th class="sortable-header" data-sort-column="quantity" style="text-align: center;">Cantidad <span class="sort-arrow">↕</span></th>
              <th class="sortable-header" data-sort-column="price" style="text-align: right;">Precio Unit. <span class="sort-arrow">↕</span></th>
              <th class="sortable-header" data-sort-column="subtotal" style="text-align: right;">Subtotal <span class="sort-arrow">↕</span></th>
            </tr>
          </thead>
          <tbody id="detailOrderItems">
            <tr>
              <td colspan="5" style="text-align: center;">No hay items</td>
            </tr>
          </tbody>
        </table>
        <div class="order-total">
          <span>TOTAL: </span>
          <span id="detailOrderTotal">$0.00</span>
        </div>
      </div>

      <!-- Photo and Weight Section -->
      <div class="order-details-section" id="detailPhotoWeightContainer" style="display: none;">
        <h3>📷 Foto y Peso de Preparación</h3>

        <div class="order-details-info" id="detailPhotoContainer" style="display: none;">
          <span class="order-details-label">📸 Foto de Preparación:</span>
          <div class="order-details-value">
            <div class="photo-preview" id="detailPhotoPreview">
              <img id="detailPhotoImg" src="" alt="Foto de preparación" style="max-width: 300px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="openPhotoInNewTab(this.src)">
              <div class="photo-date" id="detailPhotoDate" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
            </div>
          </div>
        </div>

        <div class="order-details-info" id="detailWeightContainer" style="display: none;">
          <span class="order-details-label">⚖️ Peso:</span>
          <span class="order-details-value" id="detailWeight">-</span>
        </div>

        <div class="order-details-info" id="detailNoPhotoWeight" style="display: none;">
          <span class="order-details-value" style="color: #666; font-style: italic;">No se ha cargado foto ni peso para esta orden</span>
        </div>
      </div>

      <div class="order-details-section" id="detailSaveOrderContainer" style="display: none;">
        <button class="mdc-button mdc-button--raised" id="detailSaveOrderBtn" style="width: 100%; background-color: #FF9800 !important;">
          <span class="mdc-button__ripple"></span>
          <i class="material-icons mdc-button__icon" aria-hidden="true">save</i>
          <span class="mdc-button__label">Guardar Cambios</span>
        </button>
      </div>

      <div class="order-details-section" id="detailSendWhatsAppContainer" style="display: none;">
        <button class="mdc-button mdc-button--raised" id="detailSendWhatsAppBtn" style="width: 100%; background-color: #25D366 !important;">
          <span class="mdc-button__ripple"></span>
          <i class="material-icons mdc-button__icon" aria-hidden="true">send</i>
          <span class="mdc-button__label">Enviar WhatsApp al Vendedor</span>
        </button>
      </div>

      <div class="order-details-section" id="detailCopyOppenContainer" style="display: none;">
        <button class="mdc-button mdc-button--raised" id="detailCopyOppenBtn" style="width: 100%; background-color: #2196F3 !important;">
          <span class="mdc-button__ripple"></span>
          <i class="material-icons mdc-button__icon" aria-hidden="true">content_copy</i>
          <span class="mdc-button__label">Copiar a Oppen</span>
        </button>
      </div>

      <div class="order-details-section" id="detailEditOrderContainer" style="display: none;">
        <button class="mdc-button mdc-button--raised" id="detailEditOrderBtn" style="width: 100%; background-color: #4CAF50 !important;">
          <span class="mdc-button__ripple"></span>
          <i class="material-icons mdc-button__icon" aria-hidden="true">shopping_cart</i>
          <span class="mdc-button__label">Seguir Comprando / Editar Orden</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Manual Order Number Modal -->
  <div id="manualOrderNumberModal" class="modal hidden">
    <div class="modal-content" style="max-width: 500px;">
      <span class="close-button" onclick="document.getElementById('manualOrderNumberModal').classList.add('hidden')">&times;</span>
      <h2>📋 Número de Orden Manual</h2>
      <p style="margin-bottom: 20px; color: #b0b0b0;">Ingresa el número de orden manual para aprobar este pedido:</p>

      <div style="margin-bottom: 20px;">
        <input
          type="text"
          id="manualOrderNumber"
          placeholder="Ej: 12345"
          style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 4px; font-size: 16px; background: #2a2a33; color: #f0f0f0;"
          autocomplete="off"
        >
        <p id="manualOrderNumberError" style="color: #f44336; font-size: 12px; margin-top: 8px; display: none;"></p>
      </div>

      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button
          class="mdc-button mdc-button--outlined"
          onclick="document.getElementById('manualOrderNumberModal').classList.add('hidden')"
          style="color: #f0f0f0; border-color: #f0f0f0;">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">Cancelar</span>
        </button>
        <button
          class="mdc-button mdc-button--raised"
          id="confirmManualOrderNumber"
          onclick="window.confirmManualOrderNumber()"
          style="background-color: #4CAF50 !important;">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">Confirmar</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Limpiar consola al cargar la página
    console.clear();
    console.log('🚀 Marketplace cargado - Consola limpiada');
    
    // === FIREBASE STATUS CHECK ===
    function checkFirebaseStatus() {
      console.log('🔥 Verificando estado de Firebase...');
      console.log('🔍 Firebase disponible:', typeof firebase !== 'undefined');
      
      if (typeof firebase !== 'undefined') {
        console.log('🔍 Firebase.app():', !!firebase.app);
        console.log('🔍 Firebase.auth():', !!firebase.auth);
        console.log('🔍 Firebase.firestore():', !!firebase.firestore);
        
        try {
          const currentUser = firebase.auth().currentUser;
          console.log('👤 Usuario actual:', currentUser ? `${currentUser.email} (${currentUser.uid})` : 'No autenticado');
        } catch (error) {
          console.error('❌ Error accediendo a Firebase auth:', error);
        }
      } else {
        console.error('❌ Firebase no está cargado');
      }
    }

    // === HISTORIAL FUNCTIONS ===
    // Cargar historial de pedidos desde Firebase
    async function loadHistorial() {
      const historialList = document.getElementById('historialList');

      if (!historialList) {
        console.warn('⚠️ Elemento historialList no encontrado en marketplace.html');
        return;
      }

      if (!firebase || !firebase.auth().currentUser) {
        historialList.innerHTML = `
          <div class="no-historial">
            <p>🔐 Necesitas estar autenticado</p>
            <small>Inicia sesión para ver el historial de pedidos</small>
          </div>
        `;
        return;
      }

      const currentUser = firebase.auth().currentUser;

      try {
        console.log('📋 Cargando historial desde Firebase en marketplace.html...');
        console.log('👤 Usuario actual:', currentUser.uid, currentUser.email);

        // Verificar si el usuario es admin
        const { collection, query, where, limit, getDocs, doc, getDoc, orderBy } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const userRef = doc(db, 'usuarios', currentUser.uid);
        const userDoc = await getDoc(userRef);
        const isAdmin = userDoc.exists() && userDoc.data().admin === true;

        console.log('👑 Es admin:', isAdmin);

        const pedidosCollection = collection(db, 'pedidos');

        let q;
        if (isAdmin) {
          // Admin ve todas las órdenes
          console.log('👑 Usuario admin - cargando todas las órdenes');
          q = query(
            pedidosCollection,
            orderBy('timestamp', 'desc'),
            limit(100)
          );
        } else {
          // Usuario normal solo ve sus propias órdenes
          console.log('👤 Usuario normal - cargando solo sus órdenes');
          q = query(
            pedidosCollection,
            where('userId', '==', currentUser.uid),
            limit(50)
          );
        }

        const querySnapshot = await getDocs(q);

        console.log('📋 Órdenes encontradas:', querySnapshot.size);

        if (querySnapshot.empty) {
          historialList.innerHTML = `
            <div class="no-historial">
              <p>📝 No hay pedidos en el historial</p>
              <small>Los pedidos confirmados aparecerán aquí</small>
            </div>
          `;
          return;
        }

        const pedidos = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();

          // Generar resumen correcto desde los datos de Firestore
          const clienteNombre = data.clienteNombre || 'Cliente';
          const clienteCodigo = data.clienteCodigo || '';
          const total = data.total || 0;
          const cantidadItems = data.cantidadItems || (data.items ? data.items.length : 0);

          const resumen = `Cliente ${clienteNombre}${clienteCodigo ? ', CODIGO ' + clienteCodigo : ''} • ${cantidadItems} items • $${total.toFixed(2)}`;

          pedidos.push({
            id: doc.id,
            ...data,
            resumen: resumen
          });
        });

        // Ordenar por fecha en JavaScript (más recientes primero)
        pedidos.sort((a, b) => {
          if (a.timestamp && b.timestamp) {
            return b.timestamp - a.timestamp;
          } else if (a.fecha && b.fecha) {
            return b.fecha.toMillis() - a.fecha.toMillis();
          }
          return 0;
        });

        console.log(`✅ Cargados ${pedidos.length} pedidos desde Firebase en marketplace`);

        // Agregar banner para admins
        let adminBanner = '';
        if (isAdmin) {
          adminBanner = `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
              <i class="material-icons" style="color: white;">admin_panel_settings</i>
              <div style="color: white;">
                <strong>Vista Administrador</strong>
                <div style="font-size: 12px; opacity: 0.9;">Mostrando todas las órdenes de todos los usuarios</div>
              </div>
            </div>
          `;
        }

        historialList.innerHTML = adminBanner + pedidos.map(pedido => `
          <div class="historial-item" data-order-id="${pedido.id}">
            <div class="historial-item-header">
              <div class="historial-date">${pedido.fechaLocal}</div>
              <div class="historial-method">${pedido.numeroOrden ? `#${pedido.numeroOrden}` : (pedido.estado || 'Confirmada')}</div>
            </div>
            <div class="historial-summary">${pedido.resumen}</div>
            ${isAdmin && (pedido.userDisplayName || pedido.usuarioEmail || pedido.userEmail) ?
              `<div class="historial-user">👤 ${pedido.userDisplayName || pedido.usuarioEmail || pedido.userEmail}</div>` :
              ''}
            <div class="historial-items-preview">
              ${pedido.items.slice(0, 2).map(item => `<small>${item.description}</small>`).join(' • ')}
              ${pedido.items.length > 2 ? `<small>... +${pedido.items.length - 2} más</small>` : ''}
            </div>
          </div>
        `).join('');

        // Add event listener for historial items
        historialList.addEventListener('click', (e) => {
          const historialItem = e.target.closest('.historial-item');
          if (historialItem) {
            const orderId = historialItem.getAttribute('data-order-id');
            if (orderId) {
              showOrderDetails(orderId);
            }
          }
        });

      } catch (error) {
        console.error('❌ Error cargando historial en marketplace:', error);

        if (historialList) {
          historialList.innerHTML = `
            <div class="no-historial">
              <p>❌ Error cargando historial</p>
              <small>Intenta recargar la página</small>
            </div>
          `;
        }

        // No relanzar el error para evitar romper el flujo
        return;
      }
    }

    // Exportar historial (desde Firebase)
    async function exportHistorial() {
      try {
        let pedidos = [];
        const currentUser = firebase.auth().currentUser;

        // Intentar cargar desde Firebase primero
        if (currentUser && firebase.firestore) {
          console.log('📊 Exportando desde Firebase...');

          const { collection, query, where, getDocs, doc, getDoc, orderBy, limit } = firebase.firestoreHelpers;
          const db = firebase.firestore();

          // Verificar si el usuario es admin
          const userRef = doc(db, 'usuarios', currentUser.uid);
          const userDoc = await getDoc(userRef);
          const isAdmin = userDoc.exists() && userDoc.data().admin === true;

          console.log('👑 Es admin:', isAdmin);

          const pedidosCollection = collection(db, 'pedidos');
          let q;

          if (isAdmin) {
            // Admin exporta todas las órdenes
            console.log('👑 Usuario admin - exportando todas las órdenes');
            q = query(
              pedidosCollection,
              orderBy('timestamp', 'desc'),
              limit(100)
            );
          } else {
            // Usuario normal exporta solo sus órdenes
            console.log('👤 Usuario normal - exportando solo sus órdenes');
            q = query(
              pedidosCollection,
              where('userId', '==', currentUser.uid)
            );
          }

          const querySnapshot = await getDocs(q);

          querySnapshot.forEach(doc => {
            const data = doc.data();

            // Generar resumen correcto para exportación
            const clienteNombre = data.clienteNombre || 'Cliente';
            const clienteCodigo = data.clienteCodigo || '';
            const total = data.total || 0;
            const cantidadItems = data.cantidadItems || (data.items ? data.items.length : 0);
            const resumen = `Cliente ${clienteNombre}${clienteCodigo ? ', CODIGO ' + clienteCodigo : ''} • ${cantidadItems} items • $${total.toFixed(2)}`;

            pedidos.push({
              fecha: data.fechaLocal,
              numeroOrden: data.numeroOrden || '',
              clienteNombre: clienteNombre,
              clienteCodigo: clienteCodigo,
              estado: data.estado || 'Confirmada',
              resumen: resumen,
              total: data.total || 0,
              cantidadItems: data.cantidadItems || (data.items ? data.items.length : 0),
              items: data.items || [], // Array completo de items para exportación
              usuario: data.userDisplayName || data.usuarioEmail || data.userEmail || '',
              empresa: data.empresa || '',
              timestamp: data.timestamp,
              fechaFirestore: data.fecha
            });
          });

          // Ordenar por fecha (más recientes primero)
          pedidos.sort((a, b) => {
            if (a.timestamp && b.timestamp) {
              return b.timestamp - a.timestamp;
            } else if (a.fechaFirestore && b.fechaFirestore) {
              return b.fechaFirestore.toMillis() - a.fechaFirestore.toMillis();
            }
            return 0;
          });
        } else {
          // Fallback a localStorage
          console.log('📊 Exportando desde localStorage...');
          const historialLocal = JSON.parse(localStorage.getItem('pedidosHistorial') || '[]');
          pedidos = historialLocal.map(pedido => ({
            fecha: pedido.fecha,
            numeroOrden: '',
            estado: pedido.metodo || 'Confirmada',
            resumen: pedido.resumen,
            total: '',
            items: '',
            usuario: '',
            empresa: ''
          }));
        }

        if (pedidos.length === 0) {
          alert('📋 No hay pedidos para exportar');
          return;
        }

        console.log(`📊 Preparando exportación de ${pedidos.length} pedidos con detalle de productos...`);

        // Crear array de filas para Excel con detalle de productos
        const excelData = [];

        // Agregar encabezados
        excelData.push([
          'Fecha',
          'Número Orden',
          'Cliente',
          'Código Cliente',
          'Estado',
          'Total Orden',
          'Usuario',
          'Artículo',
          'Descripción',
          'Cantidad',
          'Precio Unit.',
          'Subtotal'
        ]);

        // Agregar datos de cada pedido con sus items
        pedidos.forEach(pedido => {
          const fecha = pedido.fecha || '';
          const numeroOrden = pedido.numeroOrden || '';
          const clienteNombre = pedido.clienteNombre || 'Cliente';
          const clienteCodigo = pedido.clienteCodigo || '';
          const estado = pedido.estado || 'Confirmada';
          const totalOrden = pedido.total || 0;
          const usuario = pedido.usuario || '';

          // Si el pedido tiene items, crear una fila por cada item
          if (pedido.items && Array.isArray(pedido.items) && pedido.items.length > 0) {
            pedido.items.forEach((item, index) => {
              excelData.push([
                index === 0 ? fecha : '', // Solo mostrar en primera fila del pedido
                index === 0 ? numeroOrden : '',
                index === 0 ? clienteNombre : '',
                index === 0 ? clienteCodigo : '',
                index === 0 ? estado : '',
                index === 0 ? totalOrden : '',
                index === 0 ? usuario : '',
                item.articulo || '',
                item.description || '',
                item.quantity || 0,
                item.price || 0,
                item.subtotal || 0
              ]);
            });
          } else {
            // Si no tiene items, agregar solo la fila del pedido
            excelData.push([
              fecha,
              numeroOrden,
              clienteNombre,
              clienteCodigo,
              estado,
              totalOrden,
              usuario,
              '',
              'Sin items',
              0,
              0,
              0
            ]);
          }

          // Agregar fila vacía entre pedidos para separar visualmente
          excelData.push(['', '', '', '', '', '', '', '', '', '', '', '']);
        });

        // Crear workbook y worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);

        // Configurar ancho de columnas
        ws['!cols'] = [
          { wch: 20 }, // Fecha
          { wch: 12 }, // Número Orden
          { wch: 25 }, // Cliente
          { wch: 12 }, // Código Cliente
          { wch: 12 }, // Estado
          { wch: 12 }, // Total Orden
          { wch: 25 }, // Usuario
          { wch: 15 }, // Artículo
          { wch: 40 }, // Descripción
          { wch: 10 }, // Cantidad
          { wch: 12 }, // Precio Unit.
          { wch: 12 }  // Subtotal
        ];

        // Agregar worksheet al workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Pedidos');

        // Generar archivo Excel
        const fileName = `historial_pedidos_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);

        console.log(`✅ Exportados ${pedidos.length} pedidos con detalle de productos a Excel`);

      } catch (error) {
        console.error('❌ Error exportando historial:', error);
        alert('❌ Error exportando historial. Intenta de nuevo.');
      }
    }

    // === TOAST NOTIFICATIONS ===
    function showToast(message, type = 'success') {
      // Crear elemento toast
      const toast = document.createElement('div');
      toast.className = `toast-notification ${type === 'error' ? 'error' : ''}`;
      toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 18px;">${type === 'error' ? '❌' : '✅'}</span>
          <span>${message}</span>
        </div>
      `;
      
      // Agregar al body
      document.body.appendChild(toast);
      
      // Mostrar con animación
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      // Ocultar y remover después de 3 segundos
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }
    
    // === CONFIGURACIÓN ===
    let APP_CONFIG = {
      whatsappNumber: '',
      email: '',
      companyName: 'Öppen Store',
      refreshTime: 30,
      refreshUnit: 'seconds'
    };

    // Cargar configuración desde Firebase
    async function loadConfig() {
      try {
        if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
          const user = firebase.auth().currentUser;

          // Usar las funciones de Firebase importadas
          const { doc, getDoc } = firebase.firestoreHelpers;
          const configRef = doc(firebase.firestore(), 'configuracion', user.uid);
          const configDoc = await getDoc(configRef);

          if (configDoc.exists()) {
            APP_CONFIG = { ...APP_CONFIG, ...configDoc.data() };
            console.log('✅ Configuración cargada desde Firebase:', APP_CONFIG);
            updateConfigInputs();

            // Mostrar toast informativo
            showToast('Configuración cargada desde la nube', 'success');
          }
        }
      } catch (error) {
        // Silenciar errores de permisos - la configuración es opcional
        if (error.code === 'permission-denied') {
          console.log('ℹ️ No hay configuración personalizada (esto es normal)');
        } else {
          console.error('Error cargando configuración:', error);
        }
      }
    }

    // Guardar configuración en Firebase
    async function saveConfig() {
      try {
        console.log('🔄 Iniciando guardado de configuración...');
        console.log('🔍 Firebase disponible:', typeof firebase !== 'undefined');
        
        if (typeof firebase === 'undefined') {
          console.error('❌ Firebase no está definido');
          return false;
        }
        
        console.log('🔍 Firebase auth disponible:', !!firebase.auth);
        const currentUser = firebase.auth().currentUser;
        console.log('🔍 Usuario actual:', currentUser ? currentUser.email : 'No autenticado');
        
        if (currentUser) {
          console.log('💾 Guardando en Firestore para usuario:', currentUser.uid);
          console.log('📋 Datos a guardar:', APP_CONFIG);
          
          // Usar las funciones de Firebase importadas
          const { doc, setDoc } = firebase.firestoreHelpers;
          const configRef = doc(firebase.firestore(), 'configuracion', currentUser.uid);
          await setDoc(configRef, APP_CONFIG);
          
          console.log('✅ Configuración guardada exitosamente en Firebase');
          return true;
        } else {
          console.error('❌ Usuario no autenticado');
          return false;
        }
      } catch (error) {
        console.error('❌ Error guardando configuración:', error);
        console.error('❌ Error details:', error.message);
        console.error('❌ Error code:', error.code);
        return false;
      }
    }

    // Actualizar inputs con configuración actual
    function updateConfigInputs() {
      const whatsappInput = document.getElementById('whatsappInput');
      const emailInput = document.getElementById('emailInput');
      const companyInput = document.getElementById('companyInput');
      
      if (whatsappInput) whatsappInput.value = APP_CONFIG.whatsappNumber || '';
      if (emailInput) emailInput.value = APP_CONFIG.email || '';
      if (companyInput) companyInput.value = APP_CONFIG.companyName || 'Öppen Store';
    }

    // Guardar configuración desde inputs
    async function saveConfigFromInputs() {
      const whatsappInput = document.getElementById('whatsappInput');
      const emailInput = document.getElementById('emailInput');
      const companyInput = document.getElementById('companyInput');
      
      if (!whatsappInput || !emailInput || !companyInput) {
        console.error('❌ Inputs de configuración no encontrados');
        return;
      }

      const whatsapp = whatsappInput.value.trim();
      const email = emailInput.value.trim();
      const company = companyInput.value.trim();
      
      // Validaciones
      if (whatsapp && !/^\d{10,15}$/.test(whatsapp)) {
        showToast('El número de WhatsApp debe tener entre 10-15 dígitos (solo números)', 'error');
        return;
      }
      
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showToast('Por favor ingresa un email válido', 'error');
        return;
      }
      
      // Actualizar configuración
      APP_CONFIG.whatsappNumber = whatsapp;
      APP_CONFIG.email = email;
      APP_CONFIG.companyName = company || 'Öppen Store';
      
      // Guardar en Firebase
      console.log('🚀 Intentando guardar configuración...');
      const success = await saveConfig();
      
      if (success) {
        // Mostrar toast de éxito
        showToast('¡Configuración guardada correctamente!', 'success');
        
        // Feedback visual adicional en el botón
        const saveBtn = document.getElementById('saveConfigBtn');
        if (saveBtn) {
          const originalText = saveBtn.textContent;
          saveBtn.textContent = '✅ ¡Guardado!';
          saveBtn.style.background = '#28a745';
          
          setTimeout(() => {
            saveBtn.textContent = originalText;
            saveBtn.style.background = '';
          }, 2000);
        }
        
        console.log('✅ Configuración actualizada:', APP_CONFIG);
      } else {
        // Mostrar mensaje de error más específico
        if (typeof firebase === 'undefined') {
          showToast('Firebase no está configurado correctamente', 'error');
        } else if (!firebase.auth().currentUser) {
          showToast('Debe iniciar sesión para guardar la configuración', 'error');
        } else {
          showToast('Error guardando la configuración. Verifique la consola', 'error');
        }
      }
    }
    
    // Variable global para almacenar permisos de admin
    window.isUserAdmin = false;

    // Intentar cargar estado de admin desde caché (mientras Firebase carga)
    const cachedIsAdmin = localStorage.getItem('cachedIsAdmin');
    const cachedEmail = localStorage.getItem('cachedAdminEmail');
    if (cachedIsAdmin === 'true' && cachedEmail) {
      window.isUserAdmin = true;
      console.log('⚡ Estado admin cargado desde caché:', cachedEmail);

      // Aplicar controles basándose en el caché (mientras Firebase valida)
      setTimeout(() => {
        if (window.applyControlsVisibility) {
          window.applyControlsVisibility();
          console.log('✅ Controles aplicados desde caché (validación de Firebase en curso)');
        }
      }, 500); // Pequeño delay para asegurar que el DOM esté listo
    }

    // Función global para aplicar visibilidad de controles basada en isUserAdmin
    window.applyControlsVisibility = function() {
      const isAdmin = window.isUserAdmin;
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      const filterBtn = document.getElementById('filterBtn');
      const columnFilterDropdown = document.getElementById('columnFilterDropdown');

      // Elementos del menú
      const configModalBtn = document.getElementById('configModalBtn');
      const statsModalBtn = document.getElementById('statsModalBtn');
      const historialModalBtn = document.getElementById('historialModalBtn');
      const logisticsModalBtn = document.getElementById('logisticsModalBtn');
      const configBtn = document.getElementById('configBtn');
      const configSubmenu = document.getElementById('configSubmenu');
      const estadisticasBtn = document.getElementById('estadisticasBtn');

      console.log('🔍 Aplicando visibilidad de controles (isAdmin:', isAdmin, ')');

      if (!isAdmin) {
        console.log('🚫 Usuario NO-ADMIN: mostrando solo menú con historial');

        // Mostrar menú hamburguesa (pero con opciones limitadas)
        if (hamburgerBtn) {
          hamburgerBtn.style.display = 'block';
          hamburgerBtn.style.visibility = 'visible';
        }

        // Ocultar filtros completamente para no-admin
        if (filterBtn) {
          filterBtn.style.display = 'none !important';
          filterBtn.style.visibility = 'hidden';
          filterBtn.style.pointerEvents = 'none';
        }
        if (columnFilterDropdown) {
          columnFilterDropdown.style.display = 'none !important';
          columnFilterDropdown.style.visibility = 'hidden';
          columnFilterDropdown.style.pointerEvents = 'none';
          columnFilterDropdown.classList.add('hidden');
        }

        // Ocultar opciones administrativas del menú
        if (configModalBtn) configModalBtn.style.display = 'none';
        if (statsModalBtn) statsModalBtn.style.display = 'none';
        if (logisticsModalBtn) logisticsModalBtn.style.display = 'block';
        if (historialModalBtn) historialModalBtn.style.display = 'block';
        if (configBtn) configBtn.style.display = 'none';
        if (configSubmenu) {
          configSubmenu.style.display = 'none';
          configSubmenu.classList.remove('active');
        }
        if (estadisticasBtn) estadisticasBtn.style.display = 'none';

      } else {
        console.log('✅ Usuario ADMIN: mostrando todos los controles');

        // Mostrar todos los controles
        if (hamburgerBtn) {
          hamburgerBtn.style.display = 'block';
          hamburgerBtn.style.visibility = 'visible';
        }
        if (filterBtn) {
          filterBtn.style.display = '';
          filterBtn.style.visibility = '';
          filterBtn.style.pointerEvents = '';
        }
        if (columnFilterDropdown) {
          columnFilterDropdown.style.display = '';
          columnFilterDropdown.style.visibility = '';
          columnFilterDropdown.style.pointerEvents = '';
          if (!columnFilterDropdown.classList.contains('hidden')) {
            columnFilterDropdown.classList.add('hidden');
          }
        }

        // Mostrar todas las opciones del menú
        if (configModalBtn) configModalBtn.style.display = 'block';
        if (statsModalBtn) statsModalBtn.style.display = 'block';
        if (logisticsModalBtn) logisticsModalBtn.style.display = 'none';
        if (historialModalBtn) historialModalBtn.style.display = 'block';
        if (configBtn) configBtn.style.display = 'block';
        if (estadisticasBtn) estadisticasBtn.style.display = 'block';

        // Mostrar tabs de admin
        const adminTabs = document.querySelectorAll('[data-admin-only="true"]');
        adminTabs.forEach(tab => {
          tab.style.display = 'inline-flex';
        });
      }
    };

    // === USER PERMISSIONS CHECK ===
    async function checkUserPermissions(user) {
      try {
        console.log('🔐 Verificando permisos para usuario:', user.email);

        if (typeof firebase !== 'undefined' && firebase.firestoreHelpers) {
          const { doc, getDoc } = firebase.firestoreHelpers;
          const userRef = doc(firebase.firestore(), 'usuarios', user.uid);
          const userDoc = await getDoc(userRef);

          let isAdmin = false;
          if (userDoc.exists()) {
            const userData = userDoc.data();
            isAdmin = userData.admin === true;
            console.log('👤 Usuario encontrado:', userData);
            console.log('🔐 Es admin:', isAdmin);
          } else {
            console.log('⚠️ Usuario no encontrado en Firestore, asumiendo no-admin');
          }

          // Guardar globalmente y en localStorage para caché
          window.isUserAdmin = isAdmin;
          localStorage.setItem('cachedIsAdmin', isAdmin.toString());
          localStorage.setItem('cachedAdminEmail', user.email);
          console.log('💾 Estado admin guardado en caché:', isAdmin);

          // Aplicar visibilidad usando la función global
          window.applyControlsVisibility();

          // También aplicar después de un pequeño delay para asegurar que el DOM esté listo
          setTimeout(() => window.applyControlsVisibility(), 100);
          
          // Para usuarios no-admin, asegurar que los KPIs se muestren con columnas básicas
          if (!isAdmin) {
            setTimeout(() => {
              console.log('🔄 Configurando columnas básicas para usuario no-admin...');
              // Asegurar que al menos algunas columnas estén visibles para generar KPIs
              const basicColumns = ['articulo', 'description', 'ordenVenta', 'stockTeorico'];
              basicColumns.forEach(col => {
                const checkbox = document.querySelector(`input[data-column="${col}"]`);
                if (checkbox && !checkbox.checked) {
                  checkbox.checked = true;
                  console.log(`✅ Activando columna ${col} para usuario no-admin`);
                }
              });
              
              // Forzar actualización de la tabla y KPIs
              if (typeof window.refresh === 'function') {
                console.log('📊 Ejecutando refresh para mostrar KPIs');
                window.refresh();
              }
            }, 1200);
          } else {
            // Para admins, solo hacer refresh
            setTimeout(() => {
              console.log('🔄 Forzando actualización de KPIs para admin...');
              if (typeof window.refresh === 'function') {
                console.log('📊 Ejecutando refresh para mostrar KPIs');
                window.refresh();
              }
            }, 1000);
          }
        }
      } catch (error) {
        console.error('❌ Error verificando permisos de usuario:', error);
        // Por seguridad, mostrar solo historial si hay error
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const filterBtn = document.getElementById('filterBtn');
        const columnFilterDropdown = document.getElementById('columnFilterDropdown');
        const configModalBtn = document.getElementById('configModalBtn');
        const statsModalBtn = document.getElementById('statsModalBtn');
        const logisticsModalBtn = document.getElementById('logisticsModalBtn');
        const historialModalBtn = document.getElementById('historialModalBtn');
        
        // Mostrar menú pero solo con historial
        if (hamburgerBtn) {
          hamburgerBtn.style.display = 'block';
          hamburgerBtn.style.visibility = 'visible';
        }
        
        // Ocultar opciones administrativas (comportamiento no-admin por seguridad)
        if (filterBtn) {
          filterBtn.style.display = 'none !important';
          filterBtn.style.visibility = 'hidden';
          filterBtn.style.pointerEvents = 'none';
        }
        if (columnFilterDropdown) {
          columnFilterDropdown.style.display = 'none !important';
          columnFilterDropdown.style.visibility = 'hidden';
          columnFilterDropdown.style.pointerEvents = 'none';
          columnFilterDropdown.classList.add('hidden');
        }
        if (configModalBtn) configModalBtn.style.display = 'none';
        if (statsModalBtn) statsModalBtn.style.display = 'none';
        
        // Mostrar historial y logistics (opciones básicas)
        if (logisticsModalBtn) logisticsModalBtn.style.display = 'block';
        if (historialModalBtn) historialModalBtn.style.display = 'block';
        
        console.log('🚫 Error en verificación: mostrando historial y logistics por seguridad');
      }
    }

    // === CLIENTES FUNCTIONALITY ===

    async function loadClientes() {
      const tableBody = document.getElementById('clientesTableBody');

      if (!tableBody) {
        console.warn('⚠️ Elemento clientesTableBody no encontrado');
        return;
      }

      if (!firebase || !firebase.firestore) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="15" style="text-align: center; padding: 20px;">
              ❌ Firebase no está disponible
            </td>
          </tr>
        `;
        return;
      }

      try {
        console.log('👥 Cargando clientes desde Firebase...');

        const { collection, getDocs, query, orderBy } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clientesCollection = collection(db, 'clientes');
        const q = query(clientesCollection, orderBy('codigo', 'asc'));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="15" style="text-align: center; padding: 20px;">
                📝 No hay clientes registrados
              </td>
            </tr>
          `;
          return;
        }

        const clientes = [];
        querySnapshot.forEach(doc => {
          clientes.push({
            id: doc.id,
            ...doc.data()
          });
        });

        console.log(`✅ Cargados ${clientes.length} clientes desde Firebase`);

        tableBody.innerHTML = clientes.map(cliente => `
          <tr>
            <td>${cliente.codigo || ''}</td>
            <td>${cliente.nombre || ''}</td>
            <td>${cliente.nombreComercial || ''}</td>
            <td>${cliente.grupo || ''}</td>
            <td>${cliente.departamento || ''}</td>
            <td>${cliente.inscripcion || ''}</td>
            <td>${cliente.nroDocumento || ''}</td>
            <td>${cliente.direccion || ''}</td>
            <td>${cliente.ciudad || ''}</td>
            <td>${cliente.provincia || ''}</td>
            <td>${cliente.pais || ''}</td>
            <td>${cliente.telefono || ''}</td>
            <td>${cliente.email || ''}</td>
            <td style="text-align: right;">${cliente.saldoCredito ? parseFloat(cliente.saldoCredito).toFixed(2) : '0.00'}</td>
            <td>
              <button class="edit-client-btn" onclick="editCliente('${cliente.id}')">✏️</button>
              <button class="delete-client-btn" onclick="deleteCliente('${cliente.id}')">🗑️</button>
            </td>
          </tr>
        `).join('');

      } catch (error) {
        console.error('❌ Error cargando clientes:', error);
        tableBody.innerHTML = `
          <tr>
            <td colspan="15" style="text-align: center; padding: 20px;">
              ❌ Error cargando clientes
            </td>
          </tr>
        `;
      }
    }

    async function importClientes() {
      const fileInput = document.getElementById('excelFileInput');
      fileInput.click();
    }

    async function handleExcelImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!firebase || !firebase.firestore) {
        alert('❌ Firebase no está disponible');
        return;
      }

      try {
        console.log('📥 Importando archivo Excel:', file.name);

        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            console.log('📊 Datos leídos del Excel:', jsonData.length, 'filas');

            const { collection, doc, setDoc } = firebase.firestoreHelpers;
            const db = firebase.firestore();

            let importados = 0;
            let saltados = 0;

            for (const row of jsonData) {
              // Extract and validate codigo (convert to string and trim)
              let codigo = row['Código'] || row['Codigo'] || '';
              if (codigo !== null && codigo !== undefined) {
                codigo = String(codigo).trim();
              }

              // Skip rows without valid codigo
              if (!codigo || codigo === '' || codigo === 'null' || codigo === 'undefined') {
                console.log('⚠️ Saltando fila sin código válido:', row);
                saltados++;
                continue;
              }

              const saldoCredito = row['Saldo Crédito'] || row['Saldo Credito'] || row['SaldoCredito'] || 0;

              const clienteData = {
                codigo: codigo,
                nombre: String(row['Nombre'] || '').trim(),
                nombreComercial: String(row['Nombre Comercial'] || '').trim(),
                grupo: String(row['Grupo de Clientes'] || row['Grupo'] || '').trim(),
                departamento: String(row['Departamento'] || '').trim(),
                inscripcion: String(row['Inscripción'] || row['Inscripcion'] || '').trim(),
                nroDocumento: String(row['Nro Documento'] || '').trim(),
                direccion: String(row['Dirección'] || row['Direccion'] || '').trim(),
                ciudad: String(row['Nombre (Ciudad)'] || row['Ciudad'] || '').trim(),
                provincia: String(row['Provincia'] || '').trim(),
                pais: String(row['País'] || row['Pais'] || '').trim(),
                telefono: String(row['Teléfono'] || row['Telefono'] || '').trim(),
                email: String(row['Email'] || '').trim(),
                saldoCredito: parseFloat(saldoCredito) || 0
              };

              // Use codigo as document ID
              const clienteRef = doc(db, 'clientes', clienteData.codigo);
              await setDoc(clienteRef, clienteData);
              importados++;

              if (importados % 50 === 0) {
                console.log(`📊 Progreso: ${importados} clientes importados...`);
              }
            }

            console.log(`✅ Importación completada: ${importados} clientes importados, ${saltados} filas saltadas`);
            alert(`✅ Importados ${importados} clientes correctamente${saltados > 0 ? `\n⚠️ ${saltados} filas saltadas por falta de código` : ''}`);

            // Reload clientes
            loadClientes();

          } catch (error) {
            console.error('❌ Error procesando Excel:', error);
            alert('❌ Error procesando archivo Excel: ' + error.message);
          }
        };

        reader.readAsArrayBuffer(file);

      } catch (error) {
        console.error('❌ Error importando clientes:', error);
        alert('❌ Error importando clientes: ' + error.message);
      }

      // Reset file input
      event.target.value = '';
    }

    async function exportClientes() {
      if (!firebase || !firebase.firestore) {
        alert('❌ Firebase no está disponible');
        return;
      }

      try {
        console.log('📤 Exportando clientes a Excel...');

        const { collection, getDocs, query, orderBy } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clientesCollection = collection(db, 'clientes');
        const q = query(clientesCollection, orderBy('codigo', 'asc'));
        const querySnapshot = await getDocs(q);

        const clientes = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          clientes.push({
            'Código': data.codigo || '',
            'Nombre': data.nombre || '',
            'Nombre Comercial': data.nombreComercial || '',
            'Grupo de Clientes': data.grupo || '',
            'Departamento': data.departamento || '',
            'Inscripción': data.inscripcion || '',
            'Nro Documento': data.nroDocumento || '',
            'Dirección': data.direccion || '',
            'Nombre (Ciudad)': data.ciudad || '',
            'Provincia': data.provincia || '',
            'País': data.pais || '',
            'Teléfono': data.telefono || '',
            'Email': data.email || '',
            'Saldo Crédito': data.saldoCredito || 0
          });
        });

        if (clientes.length === 0) {
          alert('⚠️ No hay clientes para exportar');
          return;
        }

        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(clientes);
        XLSX.utils.book_append_sheet(wb, ws, 'Clientes');

        // Download file
        const fecha = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `Listado_de_Clientes_${fecha}.xlsx`);

        console.log(`✅ Exportados ${clientes.length} clientes a Excel`);
        alert(`✅ Exportados ${clientes.length} clientes correctamente`);

      } catch (error) {
        console.error('❌ Error exportando clientes:', error);
        alert('❌ Error exportando clientes: ' + error.message);
      }
    }

    let currentEditingClienteId = null;

    function openAddClientModal() {
      // Reset form
      document.getElementById('clientForm').reset();
      document.getElementById('clientModalTitle').textContent = '➕ Agregar Cliente';
      currentEditingClienteId = null;

      // Enable codigo field for new clients
      document.getElementById('clientCodigo').disabled = false;

      openModal('addClientModal');
    }

    async function editCliente(clienteId) {
      if (!firebase || !firebase.firestore) {
        alert('❌ Firebase no está disponible');
        return;
      }

      try {
        const { doc, getDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clienteId);
        const clienteDoc = await getDoc(clienteRef);

        if (!clienteDoc.exists()) {
          alert('❌ Cliente no encontrado');
          return;
        }

        const cliente = clienteDoc.data();

        // Set form title
        document.getElementById('clientModalTitle').textContent = '✏️ Editar Cliente';
        currentEditingClienteId = clienteId;

        // Fill form
        document.getElementById('clientCodigo').value = cliente.codigo || '';
        document.getElementById('clientCodigo').disabled = true; // Don't allow changing codigo
        document.getElementById('clientNombre').value = cliente.nombre || '';
        document.getElementById('clientNombreComercial').value = cliente.nombreComercial || '';
        document.getElementById('clientGrupo').value = cliente.grupo || '';
        document.getElementById('clientDepartamento').value = cliente.departamento || '';
        document.getElementById('clientInscripcion').value = cliente.inscripcion || '';
        document.getElementById('clientNroDocumento').value = cliente.nroDocumento || '';
        document.getElementById('clientDireccion').value = cliente.direccion || '';
        document.getElementById('clientCiudad').value = cliente.ciudad || '';
        document.getElementById('clientProvincia').value = cliente.provincia || '';
        document.getElementById('clientPais').value = cliente.pais || '';
        document.getElementById('clientTelefono').value = cliente.telefono || '';
        document.getElementById('clientEmail').value = cliente.email || '';
        document.getElementById('clientSaldoCredito').value = cliente.saldoCredito || 0;

        openModal('addClientModal');

      } catch (error) {
        console.error('❌ Error cargando cliente:', error);
        alert('❌ Error cargando cliente: ' + error.message);
      }
    }

    async function saveCliente(event) {
      event.preventDefault();

      if (!firebase || !firebase.firestore) {
        alert('❌ Firebase no está disponible');
        return;
      }

      try {
        const saldoCreditoValue = document.getElementById('clientSaldoCredito').value.trim();

        const clienteData = {
          codigo: document.getElementById('clientCodigo').value.trim(),
          nombre: document.getElementById('clientNombre').value.trim(),
          nombreComercial: document.getElementById('clientNombreComercial').value.trim(),
          grupo: document.getElementById('clientGrupo').value.trim(),
          departamento: document.getElementById('clientDepartamento').value.trim(),
          inscripcion: document.getElementById('clientInscripcion').value.trim(),
          nroDocumento: document.getElementById('clientNroDocumento').value.trim(),
          direccion: document.getElementById('clientDireccion').value.trim(),
          ciudad: document.getElementById('clientCiudad').value.trim(),
          provincia: document.getElementById('clientProvincia').value.trim(),
          pais: document.getElementById('clientPais').value.trim(),
          telefono: document.getElementById('clientTelefono').value.trim(),
          email: document.getElementById('clientEmail').value.trim(),
          saldoCredito: saldoCreditoValue ? parseFloat(saldoCreditoValue) : 0
        };

        if (!clienteData.codigo) {
          alert('⚠️ El código es requerido');
          return;
        }

        if (!clienteData.nombre) {
          alert('⚠️ El nombre es requerido');
          return;
        }

        const { doc, setDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clienteData.codigo);
        await setDoc(clienteRef, clienteData);

        console.log(`✅ Cliente ${clienteData.codigo} guardado`);
        alert(currentEditingClienteId ? '✅ Cliente actualizado correctamente' : '✅ Cliente agregado correctamente');

        // Close modal and reload
        closeModal('addClientModal');
        loadClientes();

      } catch (error) {
        console.error('❌ Error guardando cliente:', error);
        alert('❌ Error guardando cliente: ' + error.message);
      }
    }

    window.openAddClientModal = openAddClientModal;
    window.saveCliente = saveCliente;

    async function deleteCliente(clienteId) {
      if (!confirm('⚠️ ¿Estás seguro de eliminar este cliente?')) {
        return;
      }

      if (!firebase || !firebase.firestore) {
        alert('❌ Firebase no está disponible');
        return;
      }

      try {
        const { doc, deleteDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clienteId);
        await deleteDoc(clienteRef);

        console.log(`✅ Cliente ${clienteId} eliminado`);
        alert('✅ Cliente eliminado correctamente');

        // Reload clientes
        loadClientes();

      } catch (error) {
        console.error('❌ Error eliminando cliente:', error);
        alert('❌ Error eliminando cliente: ' + error.message);
      }
    }

    // Expose functions globally
    window.loadClientes = loadClientes;
    window.importClientes = importClientes;
    window.exportClientes = exportClientes;
    window.editCliente = editCliente;
    window.deleteCliente = deleteCliente;

    // === PROFILE FUNCTIONALITY ===
    async function loadUserProfile() {
      try {
        // Show current user email
        const user = firebase.auth().currentUser;
        if (user) {
          document.getElementById('profileUserEmail').textContent = user.email;
        }

        // Load profile data from Firebase usuarios collection
        if (user) {
          const { doc, getDoc } = firebase.firestoreHelpers;
          const db = firebase.firestore();
          const userRef = doc(db, 'usuarios', user.uid);
          const docSnap = await getDoc(userRef);

          if (docSnap.exists()) {
            const userData = docSnap.data();
            document.getElementById('profileName').value = userData.name || userData.displayName || '';
            document.getElementById('profileAddress').value = userData.address || '';
            document.getElementById('profilePhone').value = userData.phone || '';
            document.getElementById('profileContactPhone').value = userData.contactPhone || '';
          } else {
            // Initialize empty profile
            clearProfileFields();
          }
        }
      } catch (error) {
        console.error('❌ Error loading profile:', error);
      }
    }

    async function saveUserProfile() {
      try {
        const user = firebase.auth().currentUser;
        if (!user) {
          alert('Debes estar autenticado para guardar el perfil');
          return;
        }

        const profileData = {
          name: document.getElementById('profileName').value.trim(),
          address: document.getElementById('profileAddress').value.trim(),
          phone: document.getElementById('profilePhone').value.trim(),
          contactPhone: document.getElementById('profileContactPhone').value.trim(),
          updatedAt: new Date()
        };

        // Validation
        if (!profileData.name) {
          alert('El nombre es obligatorio');
          return;
        }

        const { doc, setDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();
        const userRef = doc(db, 'usuarios', user.uid);

        await setDoc(userRef, profileData, { merge: true });

        console.log('✅ Profile saved successfully');
        alert('Perfil guardado exitosamente!');

      } catch (error) {
        console.error('❌ Error saving profile:', error);
        alert('Error guardando el perfil. Inténtalo de nuevo.');
      }
    }

    function clearProfileFields() {
      document.getElementById('profileName').value = '';
      document.getElementById('profileAddress').value = '';
      document.getElementById('profilePhone').value = '';
      document.getElementById('profileContactPhone').value = '';
    }

    function clearUserProfile() {
      if (confirm('¿Estás seguro de que deseas limpiar todos los datos del perfil?')) {
        clearProfileFields();
        console.log('🗑️ Profile fields cleared');
      }
    }

    // === HAMBURGER MENU FUNCTIONALITY (Simplified) ===
    let menuOpen = false;

    function toggleMenu() {
      console.log('🍔 toggleMenu called, current state:', menuOpen);
      const slideMenu = document.getElementById('slideMenu');
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      
      if (!slideMenu || !hamburgerBtn) {
        console.log('❌ Menu elements not found');
        return;
      }
      
      menuOpen = !menuOpen;
      console.log('🍔 New menu state:', menuOpen);
      
      if (menuOpen) {
        slideMenu.classList.add('active');
        hamburgerBtn.classList.add('active');
        console.log('✅ Menu opened');
      } else {
        slideMenu.classList.remove('active');
        hamburgerBtn.classList.remove('active');
        console.log('❌ Menu closed');
      }
    }

    function closeMenu() {
      if (menuOpen) {
        toggleMenu();
      }
    }

    // Funciones para abrir modales
    function openModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
      if (modalId === 'statsModal') {
        updateStats();
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    function closeAllModals() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.add('hidden');
      });
    }

    // Función para actualizar estadísticas en el modal
    function updateStats() {
      // Último refresco
      const lastRefresh = localStorage.getItem('lastRefreshTime');
      const lastRefreshStat = document.getElementById('lastRefreshStat');
      if (lastRefreshStat) {
        lastRefreshStat.textContent = lastRefresh ? 
          new Date(lastRefresh).toLocaleTimeString() : 'Nunca';
      }
      
      // Items en carrito
      const cartData = localStorage.getItem('cart');
      const cartItemsStat = document.getElementById('cartItemsStat');
      if (cartItemsStat) {
        const cart = cartData ? JSON.parse(cartData) : [];
        cartItemsStat.textContent = cart.length;
      }

      // Total productos (desde la tabla actual si está disponible)
      const totalProductsStat = document.getElementById('totalProductsStat');
      if (totalProductsStat) {
        const tbody = document.getElementById('tbody');
        if (tbody) {
          const visibleRows = tbody.querySelectorAll('tr:not([style*="display: none"])');
          totalProductsStat.textContent = visibleRows.length;
        } else {
          totalProductsStat.textContent = '0';
        }
      }
    }

    // Setup cuando cargue la página
    document.addEventListener('DOMContentLoaded', function() {
      console.log('📱 Setting up simple menu');
      
      // Verificar estado de Firebase
      checkFirebaseStatus();
      
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      if (hamburgerBtn) {
        hamburgerBtn.addEventListener('click', toggleMenu);
        console.log('✅ Click handler added');
      }
      
      // Cerrar menú con overlay
      const slideMenuOverlay = document.getElementById('slideMenuOverlay');
      if (slideMenuOverlay) {
        slideMenuOverlay.addEventListener('click', closeMenu);
      }
      
      // Cerrar con botón X
      const closeMenuBtn = document.getElementById('closeMenuBtn');
      if (closeMenuBtn) {
        closeMenuBtn.addEventListener('click', closeMenu);
      }
      
      // Botón guardar configuración
      const saveConfigBtn = document.getElementById('saveConfigBtn');
      if (saveConfigBtn) {
        saveConfigBtn.addEventListener('click', saveConfigFromInputs);
        console.log('✅ Save config handler added');
      }

      // Botones del perfil
      const saveProfileBtn = document.getElementById('saveProfileBtn');
      if (saveProfileBtn) {
        saveProfileBtn.addEventListener('click', saveUserProfile);
        console.log('✅ Save profile handler added');
      }

      const clearProfileBtn = document.getElementById('clearProfileBtn');
      if (clearProfileBtn) {
        clearProfileBtn.addEventListener('click', clearUserProfile);
        console.log('✅ Clear profile handler added');
      }

      // Botones del menú para abrir modales
      const configModalBtn = document.getElementById('configModalBtn');
      if (configModalBtn) {
        configModalBtn.addEventListener('click', function() {
          closeMenu();
          openModal('configModal');
        });
        console.log('✅ Config modal button handler added');
      }

      const statsModalBtn = document.getElementById('statsModalBtn');
      if (statsModalBtn) {
        statsModalBtn.addEventListener('click', function() {
          closeMenu();
          openModal('statsModal');
          // Load advanced statistics when stats modal opens
          setTimeout(() => {
            if (window.updateAdvancedStats) {
              window.updateAdvancedStats();
            } else {
              console.log('⚠️ updateAdvancedStats not available yet, retrying...');
              setTimeout(() => window.updateAdvancedStats && window.updateAdvancedStats(), 500);
            }
          }, 100);
        });
        console.log('✅ Stats modal button handler added');
      }

      const profileModalBtn = document.getElementById('profileModalBtn');
      if (profileModalBtn) {
        profileModalBtn.addEventListener('click', function() {
          closeMenu();
          openModal('profileModal');
          loadUserProfile();
        });
        console.log('✅ Profile modal button handler added');
      }

      const historialModalBtn = document.getElementById('historialModalBtn');
      if (historialModalBtn) {
        historialModalBtn.addEventListener('click', function() {
          closeMenu();
          openModal('historialModal');
          loadHistorial();
        });
        console.log('✅ Historial modal button handler added');
      }

      const clientesModalBtn = document.getElementById('clientesModalBtn');
      if (clientesModalBtn) {
        clientesModalBtn.addEventListener('click', function() {
          closeMenu();
          openModal('clientesModal');
          loadClientes();
        });
        console.log('✅ Clientes modal button handler added');
      }

      // Client form submit handler
      const clientForm = document.getElementById('clientForm');
      if (clientForm) {
        clientForm.addEventListener('submit', saveCliente);
        console.log('✅ Client form submit handler added');
      }

      const logisticsModalBtn = document.getElementById('logisticsModalBtn');
      if (logisticsModalBtn) {
        logisticsModalBtn.addEventListener('click', function() {
          closeMenu();
          openModal('logisticsModal');
          // Load orders when logistics modal opens
          setTimeout(() => {
            if (window.loadLogisticsOrders) {
              window.loadLogisticsOrders();
            } else {
              console.log('⚠️ loadLogisticsOrders not available yet, retrying...');
              setTimeout(() => window.loadLogisticsOrders && window.loadLogisticsOrders(), 500);
            }
          }, 100);
        });
        console.log('✅ Logistics modal button handler added');
      }

      const menuLogoutBtn = document.getElementById('menuLogoutBtn');
      if (menuLogoutBtn) {
        menuLogoutBtn.addEventListener('click', function() {
          closeMenu();
          console.log('🚪 Cerrando sesión desde menu...');

          // Clean up price pause listener
          if (window.pricePauseListener && typeof window.pricePauseListener === 'function') {
            console.log('🧹 Cleaning up price pause listener...');
            window.pricePauseListener();
            window.pricePauseListener = null;
          }

          // Reset global states
          window.pricesPausedGlobal = false;
          window.isUserLoggedIn = false;
          window.isUserAdmin = false;

          // Clear admin cache
          localStorage.removeItem('cachedIsAdmin');
          localStorage.removeItem('cachedAdminEmail');
          console.log('🧹 Global states and admin cache reset');

          if (typeof firebase !== 'undefined' && firebase.auth()) {
            // Cerrar sesión en Firebase
            firebase.authHelpers.signOut(firebase.auth()).then(() => {
              console.log('✅ Sesión cerrada en Firebase');

              // Limpiar datos de localStorage
              localStorage.removeItem('userAuthenticated');
              localStorage.removeItem('userEmail');
              localStorage.removeItem('userDisplayName');
              localStorage.removeItem('userPhotoURL');
              localStorage.removeItem('cart');

              console.log('🧹 localStorage limpiado');

              // Force redirect after a small delay to ensure cleanup
              setTimeout(() => {
                window.location.href = 'login.html';
              }, 100);
            }).catch((error) => {
              console.error('❌ Error cerrando sesión:', error);
              // Limpiar localStorage y redirigir de todas formas
              localStorage.removeItem('userAuthenticated');
              localStorage.removeItem('userEmail');
              localStorage.removeItem('userDisplayName');
              localStorage.removeItem('userPhotoURL');
              localStorage.removeItem('cart');
              window.location.href = 'login.html';
            });
          } else {
            // Limpiar localStorage y redirigir
            localStorage.removeItem('userAuthenticated');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userDisplayName');
            localStorage.removeItem('userPhotoURL');
            localStorage.removeItem('cart');
            window.location.href = 'login.html';
          }
        });
        console.log('✅ Menu logout button handler added');
      }

      const menuVersionBtn = document.getElementById('menuVersionBtn');
      if (menuVersionBtn) {
        menuVersionBtn.addEventListener('click', function() {
          closeMenu();
          openModal('changelogModal');
        });
        console.log('✅ Menu version button handler added');
      }

      const ayudaBtn = document.getElementById('ayudaBtn');
      if (ayudaBtn) {
        ayudaBtn.addEventListener('click', function() {
          closeMenu();
          window.location.href = 'ayuda.html';
        });
        console.log('✅ Ayuda button handler added');
      }

      // CONFIG button - toggle submenu (ADMIN ONLY)
      const configBtn = document.getElementById('configBtn');
      const configSubmenu = document.getElementById('configSubmenu');
      if (configBtn && configSubmenu) {
        configBtn.addEventListener('click', function(e) {
          // Validar permisos de admin
          if (!window.isUserAdmin) {
            console.warn('🚫 Acceso denegado: CONFIG solo para admins');
            return;
          }

          e.stopPropagation();
          const isActive = configSubmenu.classList.contains('active');

          if (isActive) {
            configSubmenu.classList.remove('active');
            configBtn.classList.remove('active');
            configSubmenu.style.display = 'none';
          } else {
            configSubmenu.classList.add('active');
            configBtn.classList.add('active');
            configSubmenu.style.display = 'block';
          }
        });
        console.log('✅ Config button handler added (admin only)');
      }

      // CONFIG submenu options (ADMIN ONLY)
      const configProfileBtn = document.getElementById('configProfileBtn');
      if (configProfileBtn) {
        configProfileBtn.addEventListener('click', function() {
          // Validar permisos de admin
          if (!window.isUserAdmin) {
            console.warn('🚫 Acceso denegado: PROFILE solo para admins');
            return;
          }
          closeMenu();
          openModal('profileModal');
          loadUserProfile();
        });
        console.log('✅ Config Profile button handler added (admin only)');
      }

      const configClienteBtn = document.getElementById('configClienteBtn');
      if (configClienteBtn) {
        configClienteBtn.addEventListener('click', function(e) {
          // Validar permisos de admin
          if (!window.isUserAdmin) {
            console.warn('🚫 Acceso denegado: CLIENTES solo para admins');
            return;
          }
          e.preventDefault();
          e.stopPropagation();
          console.log('🔄 Redirigiendo a CLIENTES...');
          closeMenu();
          // Redirect immediately
          window.location.replace('Administration.html?tab=clientes');
        });
        console.log('✅ Config Cliente button handler added (admin only)');
      }

      const configVendedorBtn = document.getElementById('configVendedorBtn');
      if (configVendedorBtn) {
        configVendedorBtn.addEventListener('click', function(e) {
          // Validar permisos de admin
          if (!window.isUserAdmin) {
            console.warn('🚫 Acceso denegado: VENDEDORES solo para admins');
            return;
          }
          e.preventDefault();
          e.stopPropagation();
          console.log('🔄 Redirigiendo a VENDEDORES...');
          closeMenu();
          // Redirect immediately
          window.location.replace('Administration.html?tab=vendedor');
        });
        console.log('✅ Config Vendedor button handler added');
      }

      const configAdmisionesBtn = document.getElementById('configAdmisionesBtn');
      if (configAdmisionesBtn) {
        configAdmisionesBtn.addEventListener('click', function(e) {
          // Validar permisos de admin
          if (!window.isUserAdmin) {
            console.warn('🚫 Acceso denegado: ADMISIONES solo para admins');
            return;
          }
          e.preventDefault();
          e.stopPropagation();
          console.log('🔄 Redirigiendo a ADMISIONES...');
          closeMenu();
          // Redirect immediately
          window.location.replace('Administration.html?tab=admisiones');
        });
        console.log('✅ Config Admisiones button handler added (admin only)');
      }

      const estadisticasBtn = document.getElementById('estadisticasBtn');
      if (estadisticasBtn) {
        estadisticasBtn.addEventListener('click', function() {
          closeMenu();
          window.location.href = 'estadisticas.html';
        });
        console.log('✅ Estadísticas button handler added');
      }

      const exportHistorialBtn = document.getElementById('exportHistorialBtn');
      if (exportHistorialBtn) {
        exportHistorialBtn.addEventListener('click', exportHistorial);
        console.log('✅ Export historial button handler added');
      }

      const importClientesBtn = document.getElementById('importClientesBtn');
      if (importClientesBtn) {
        importClientesBtn.addEventListener('click', importClientes);
        console.log('✅ Import clientes button handler added');
      }

      const exportClientesBtn = document.getElementById('exportClientesBtn');
      if (exportClientesBtn) {
        exportClientesBtn.addEventListener('click', exportClientes);
        console.log('✅ Export clientes button handler added');
      }

      const excelFileInput = document.getElementById('excelFileInput');
      if (excelFileInput) {
        excelFileInput.addEventListener('change', handleExcelImport);
        console.log('✅ Excel file input handler added');
      }

      // Cerrar modales con botón X
      document.querySelectorAll('.close-button').forEach(button => {
        button.addEventListener('click', function() {
          const modal = this.closest('.modal');
          if (modal) {
            modal.classList.add('hidden');
          }
        });
      });

      // Cerrar modales al hacer click fuera
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.classList.add('hidden');
          }
        });
      });

      // Cerrar modales con tecla Escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeAllModals();
        }
      });
      
      // Cerrar con Escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && menuOpen) {
          closeMenu();
        }
      });
      
      // Cargar configuración cuando el usuario se autentique
      if (typeof firebase !== 'undefined' && firebase.auth) {
        // Ejecutar inmediatamente sin delay
        if (window.firebase && window.firebase.firestoreHelpers) {
          firebase.auth().onAuthStateChanged(async function(user) {
              if (user) {
                console.log('👤 Usuario autenticado, verificando permisos...');

                // IMPORTANTE: Marcar usuario como logueado ANTES de cargar precios
                if (typeof window.isUserLoggedIn !== 'undefined') {
                  window.isUserLoggedIn = true;
                  console.log('✅ Usuario marcado como logueado (window.isUserLoggedIn = true)');
                }

                // Track page visit
                try {
                  const { collection, addDoc, serverTimestamp } = firebase.firestoreHelpers;
                  const db = firebase.firestore();
                  await addDoc(collection(db, 'page_visits'), {
                    page: 'marketplace',
                    pageName: 'Marketplace',
                    userId: user.uid,
                    userEmail: user.email,
                    timestamp: serverTimestamp()
                  });
                  console.log('📊 Page visit tracked: marketplace');
                } catch (error) {
                  console.error('Error tracking page visit:', error);
                }

                await checkUserPermissions(user);
                console.log('👤 Usuario autenticado, cargando configuración...');
                loadConfig();

                // Load prices from Firebase for marketplace
                console.log('💰 Cargando precios desde Firebase para marketplace...');
                if (window.loadPricesFromFirebase) {
                  await window.loadPricesFromFirebase();
                  console.log('✅ Precios cargados en marketplace');

                  // Refresh view to show prices
                  if (window.renderRows) {
                    window.renderRows();
                    console.log('🔄 Vista actualizada con precios de Firebase');
                  }
                } else {
                  console.log('⚠️ loadPricesFromFirebase no disponible aún');
                }
              } else {
                // Usuario no autenticado - marcar como NO logueado
                if (typeof window.isUserLoggedIn !== 'undefined') {
                  window.isUserLoggedIn = false;
                  console.log('🔒 Usuario marcado como NO logueado');
                }

                // Redirect to login if not authenticated
                console.log('🔒 Usuario no autenticado, redirigiendo a login...');
                window.location.href = 'login.html';
              }
            });
          }
      }
      
      // Old logout button removed - now in hamburger menu

      console.log('✅ Menu setup complete');

      // === MOBILE COLUMN TOGGLE FUNCTIONALITY ===
      const table = document.getElementById('productsTable');
      const toggleButtons = document.querySelectorAll('.column-toggle-btn');

      if (table && toggleButtons.length > 0) {
        toggleButtons.forEach(btn => {
          btn.addEventListener('click', function() {
            const column = this.getAttribute('data-toggle');
            const span = this.querySelector('span');

            // Toggle active class on button
            this.classList.toggle('active');

            // Toggle show class on table
            table.classList.toggle(`show-${column}`);

            // Toggle icon between + and -
            if (this.classList.contains('active')) {
              span.textContent = '-';
            } else {
              span.textContent = '+';
            }

            console.log(`🔄 Columna ${column} ${this.classList.contains('active') ? 'visible' : 'oculta'}`);
          });
        });

        console.log('✅ Toggle buttons para columnas móviles inicializados');
      }
    });
  </script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, orderBy, limit, getDocs, deleteDoc, addDoc, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    // Firebase Storage removed - using only Firestore for photos

    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCXjSGtVGfQas_cEyjmI0RTaeEl94jdp6g",
      authDomain: "carrito-138c3.firebaseapp.com",
      projectId: "carrito-138c3",
      storageBucket: "carrito-138c3.firebasestorage.app",
      messagingSenderId: "579670725719",
      appId: "1:579670725719:web:carrito138c3"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    console.log('🔥 Firebase inicializado en marketplace.html (solo Auth y Firestore)');

    // Hacer Firebase disponible globalmente
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebase = {
      app: () => app,
      auth: () => auth,
      firestore: () => db,
      // Funciones de Firestore que necesitamos
      firestoreHelpers: {
        doc,
        getDoc,
        setDoc,
        updateDoc,
        collection,
        query,
        where,
        orderBy,
        limit,
        getDocs,
        deleteDoc,
        addDoc,
        serverTimestamp,
        onSnapshot
      },
      // Storage helpers removed - using only Firestore
      // Funciones de Auth que necesitamos
      authHelpers: {
        signOut
      }
    };
    
    console.log('✅ Firebase disponible globalmente');

    // === CHATBOT ACCESS CONTROL ===
    // Solo mostrar chatbot a usuarios permitidos
    const CHATBOT_ALLOWED_USERS = ['santifn@gmail.com', 'cristiansan@gmail.com'];

    onAuthStateChanged(auth, (user) => {
      const chatbotBtn = document.getElementById('chatbotBtn');

      if (user && CHATBOT_ALLOWED_USERS.includes(user.email)) {
        console.log('✅ Usuario tiene acceso al chatbot:', user.email);
        if (chatbotBtn) {
          chatbotBtn.classList.add('visible');
        }
      } else {
        console.log('⛔ Usuario no tiene acceso al chatbot');
        if (chatbotBtn) {
          chatbotBtn.classList.remove('visible');
        }
      }
    });

    // === HELPER FUNCTIONS ===

    // Formatear números con separadores de miles
    function formatNumber(num) {
      return new Intl.NumberFormat('es-AR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    // Enviar orden al vendedor por WhatsApp
    async function sendOrderToSellerWhatsApp(orderData, orderNumber, clienteNombre) {
      try {
        console.log('📱 [WhatsApp] Iniciando envío...');
        console.log('📱 [WhatsApp] orderData.vendedorId:', orderData.vendedorId);
        console.log('📱 [WhatsApp] orderNumber:', orderNumber);
        console.log('📱 [WhatsApp] clienteNombre:', clienteNombre);

        const { doc, getDoc, collection, query, where, getDocs } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();

        let vendedorData = null;
        let vendedorId = orderData.vendedorId;

        // Si no hay vendedor asignado, buscar a Santiago como vendedor por defecto
        if (!vendedorId) {
          console.log('⚠️ [WhatsApp] No hay vendedor asignado, buscando a Santiago Fernandez...');
          const vendedoresRef = collection(db, 'vendedores');
          const q = query(vendedoresRef, where('email', '==', 'santifn.axp@gmail.com'));
          const querySnapshot = await getDocs(q);

          if (!querySnapshot.empty) {
            const santiagoDoc = querySnapshot.docs[0];
            vendedorId = santiagoDoc.id;
            vendedorData = santiagoDoc.data();
            console.log('✅ [WhatsApp] Santiago Fernandez encontrado como vendedor por defecto:', vendedorId);
          } else {
            console.log('❌ [WhatsApp] No se encontró a Santiago Fernandez (santifn.axp@gmail.com) en la BD');
            return;
          }
        } else {
          console.log('📱 [WhatsApp] Buscando vendedor:', vendedorId);
          const vendedorRef = doc(db, 'vendedores', vendedorId);
          const vendedorDoc = await getDoc(vendedorRef);

          if (!vendedorDoc.exists()) {
            console.log('⚠️ [WhatsApp] Vendedor no encontrado en BD');
            return;
          }

          vendedorData = vendedorDoc.data();
        }

        console.log('📱 [WhatsApp] Vendedor encontrado:', vendedorData.name);
        console.log('📱 [WhatsApp] Teléfonos:', { phone: vendedorData.phone, phone2: vendedorData.phone2 });

        // Obtener ambos teléfonos del vendedor
        const phones = [];
        if (vendedorData.phone || vendedorData.telefono) {
          phones.push((vendedorData.phone || vendedorData.telefono).replace(/\D/g, ''));
        }
        if (vendedorData.phone2) {
          phones.push(vendedorData.phone2.replace(/\D/g, ''));
        }

        console.log('📱 [WhatsApp] Teléfonos procesados:', phones);

        if (phones.length === 0) {
          console.log('⚠️ [WhatsApp] Vendedor sin teléfono válido');
          return;
        }

        // Construir mensaje
        let mensaje = `🔄 *ORDEN MODIFICADA #${orderNumber}*\n\n`;
        mensaje += `👤 *Cliente:* ${clienteNombre}\n`;
        mensaje += `📧 *Email:* ${orderData.clienteEmail || orderData.usuarioEmail}\n`;
        if (orderData.editadaPorNombre) {
          mensaje += `✏️ *Modificada por:* ${orderData.editadaPorNombre}\n`;
        }
        mensaje += `📅 *Fecha:* ${orderData.fechaLocal || new Date().toLocaleString('es-AR')}\n\n`;
        mensaje += `📦 *Productos (${orderData.cantidadItems || orderData.items?.length || 0}):*\n`;

        if (orderData.items && orderData.items.length > 0) {
          orderData.items.forEach((item, index) => {
            mensaje += `${index + 1}. ${item.description || item.articulo}\n`;
            // Show 'x' if prices are paused globally
            const priceDisplay = window.pricesPausedGlobal ? 'x' : formatNumber(item.price);
            mensaje += `   Cantidad: ${item.quantity} x ${priceDisplay}\n`;
          });
        }

        // Show 'x' for total if prices are paused globally
        const totalDisplay = window.pricesPausedGlobal ? 'x' : formatNumber(orderData.total);
        mensaje += `\n💰 *TOTAL: ${totalDisplay}*\n\n`;

        // Enviar WhatsApp a todos los teléfonos del vendedor
        console.log('📱 [WhatsApp] Preparando para enviar a', phones.length, 'teléfono(s)');

        phones.forEach((phone, index) => {
          const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(mensaje)}`;
          console.log(`📱 [WhatsApp] URL ${index + 1}:`, whatsappUrl.substring(0, 100) + '...');

          // Pequeño delay entre aperturas para evitar que se bloqueen
          setTimeout(() => {
            console.log(`📱 [WhatsApp] Abriendo ventana ${index + 1}/${phones.length} para ${phone}`);
            window.open(whatsappUrl, '_blank');
            console.log(`✅ [WhatsApp] Ventana ${index + 1}/${phones.length} abierta para ${phone}`);
          }, index * 500);
        });

        console.log(`✅ [WhatsApp] Proceso completado - ${phones.length} teléfono(s)`);

      } catch (error) {
        console.error('❌ Error enviando WhatsApp:', error);
      }
    }

    // === LOGISTICS FUNCTIONALITY ===

    // Load logistics orders from Firebase
    async function loadLogisticsOrders() {
      if (!firebase || !firebase.auth().currentUser) {
        console.log('⚠️ No user authenticated for logistics');
        return;
      }

      try {
        const { collection, query, orderBy, getDocs, updateDoc, doc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const pedidosCollection = collection(db, 'pedidos');
        const q = query(pedidosCollection, orderBy('timestamp', 'desc'));
        const querySnapshot = await getDocs(q);

        const orders = [];
        const updatePromises = [];

        querySnapshot.forEach(docSnapshot => {
          const data = docSnapshot.data();

          // Check if logisticsState exists, if not, set it to 'borrador'
          if (!data.logisticsState) {
            console.log(`🔄 Setting logisticsState to 'borrador' for order ${docSnapshot.id}`);
            const orderRef = doc(db, 'pedidos', docSnapshot.id);
            updatePromises.push(updateDoc(orderRef, { logisticsState: 'borrador' }));
          }

          // Check if timestamp exists, if not, use fecha or create new timestamp
          if (!data.timestamp) {
            console.log(`🔄 Setting timestamp for order ${docSnapshot.id}`);
            const orderRef = doc(db, 'pedidos', docSnapshot.id);
            const timestampValue = data.fecha || new Date();
            updatePromises.push(updateDoc(orderRef, { timestamp: timestampValue }));
          }

          orders.push({
            id: docSnapshot.id,
            ...data,
            logisticsState: data.logisticsState || 'borrador', // Default state
            timestamp: data.timestamp || data.fecha || new Date() // Use fecha as fallback
          });
        });

        // Update orders that don't have logisticsState
        if (updatePromises.length > 0) {
          await Promise.all(updatePromises);
          console.log(`✅ Updated ${updatePromises.length} orders with logisticsState`);
        }

        console.log('📦 Loaded', orders.length, 'logistics orders');

        // Guardar en cache para el modal de detalles
        allOrdersCache = orders;

        displayLogisticsOrders(orders);

      } catch (error) {
        console.error('❌ Error loading logistics orders:', error);
      }
    }

    // Display orders in their respective sections
    function displayLogisticsOrders(orders) {
      // Check if master-content is visible before rendering
      const masterContent = document.getElementById('master-content');
      if (!masterContent || masterContent.style.display === 'none') {
        console.log('⚠️ MASTER content not visible, skipping render');
        return;
      }

      const containers = {
        borrador: document.getElementById('borradorOrders'),
        revision: document.getElementById('revisionOrders'),
        aprobada: document.getElementById('aprobadaOrders'),
        preparacion: document.getElementById('preparacionOrders'),
        listo: document.getElementById('listoOrders'),
        despachada: document.getElementById('despachadaOrders'),
        entregada: document.getElementById('entregadaOrders'),
        cerrada: document.getElementById('cerradaOrders'),
        cancelada: document.getElementById('canceladaOrders')
      };

      // Check if all containers exist
      const missingContainers = Object.entries(containers).filter(([key, val]) => !val).map(([key]) => key);
      if (missingContainers.length > 0) {
        console.warn('⚠️ Seguimiento containers not found:', missingContainers);
        return;
      }

      // Define state flow: current state -> next state (null = final state)
      const stateFlow = {
        borrador: 'revision',
        revision: 'aprobada',
        aprobada: 'preparacion',
        preparacion: 'listo',
        listo: 'despachada',
        despachada: 'entregada',
        entregada: 'cerrada',
        cerrada: null,
        cancelada: null
      };

      // Separate orders by state
      const ordersByState = {
        borrador: orders.filter(order => order.logisticsState === 'borrador'),
        revision: orders.filter(order => order.logisticsState === 'revision'),
        aprobada: orders.filter(order => order.logisticsState === 'aprobada'),
        preparacion: orders.filter(order => order.logisticsState === 'preparacion'),
        listo: orders.filter(order => order.logisticsState === 'listo'),
        despachada: orders.filter(order => order.logisticsState === 'despachada'),
        entregada: orders.filter(order => order.logisticsState === 'entregada'),
        cerrada: orders.filter(order => order.logisticsState === 'cerrada'),
        cancelada: orders.filter(order => order.logisticsState === 'cancelada')
      };

      // Display orders in each section
      Object.entries(ordersByState).forEach(([state, stateOrders]) => {
        const container = containers[state];
        const nextState = stateFlow[state];

        if (stateOrders.length > 0) {
          container.innerHTML = stateOrders.map(order => createOrderHTML(order, nextState, state)).join('');
        } else {
          const messages = {
            borrador: 'No hay pedidos en borrador',
            revision: 'No hay pedidos en revisión',
            aprobada: 'No hay pedidos aprobados',
            preparacion: 'No hay pedidos en preparación',
            listo: 'No hay pedidos listos',
            despachada: 'No hay pedidos despachados',
            entregada: 'No hay pedidos entregados',
            cerrada: 'No hay pedidos cerrados',
            cancelada: 'No hay pedidos cancelados'
          };
          container.innerHTML = `<p class="no-orders">${messages[state]}</p>`;
        }
      });

      // Add event listeners to all order items using event delegation
      Object.values(containers).forEach(container => {
        container.addEventListener('click', (e) => {
          const orderItem = e.target.closest('.order-item');
          if (orderItem && !e.target.closest('button')) {
            const orderId = orderItem.getAttribute('data-order-id');
            if (orderId) {
              showOrderDetails(orderId);
            }
          }
        });
      });
    }

    // Create HTML for an order item
    function createOrderHTML(order, nextState, currentState) {
      const isAdmin = window.isUserAdmin || false;
      let buttonHtml = '';

      const stateLabels = {
        borrador: 'Borrador',
        revision: 'En Revisión',
        aprobada: 'Aprobada',
        preparacion: 'En Preparación',
        listo: 'Listo para Retiro/Despacho',
        despachada: 'Despachada',
        entregada: 'Entregada',
        cerrada: 'Cerrada',
        cancelada: 'Cancelada'
      };

      // Define state flows for bidirectional movement
      const stateFlow = {
        borrador: { next: 'revision', prev: null },
        revision: { next: 'aprobada', prev: 'borrador' },
        aprobada: { next: 'preparacion', prev: 'revision' },
        preparacion: { next: 'listo', prev: 'aprobada' },
        listo: { next: 'despachada', prev: 'preparacion' },
        despachada: { next: 'entregada', prev: 'listo' },
        entregada: { next: 'cerrada', prev: 'despachada' },
        cerrada: { next: null, prev: 'entregada' },
        cancelada: { next: null, prev: 'entregada' }
      };

      const currentFlow = stateFlow[currentState];
      const hasNext = currentFlow && currentFlow.next !== null;
      const hasPrev = currentFlow && currentFlow.prev !== null;

      // Solo mostrar botones de cambio de estado si el usuario es admin
      if (isAdmin) {
        // Flecha hacia arriba (volver al estado anterior) - solo permitido en estado "revision"
        if (hasPrev && currentState === 'revision') {
          const prevStateLabel = stateLabels[currentFlow.prev] || currentFlow.prev;
          buttonHtml += `<button class="move-order-btn-up" onclick="moveOrder('${order.id}', '${currentFlow.prev}')" title="Volver a ${prevStateLabel}">↑</button>`;
        }

        // Flecha hacia abajo (avanzar al siguiente estado) y/o botón de foto
        if (hasNext) {
          const nextStateLabel = stateLabels[currentFlow.next] || currentFlow.next;

          // Special handling for despachada -> entregada: show both arrow and photo button
          if (currentFlow.next === 'entregada') {
            // Mostrar flecha abajo para avanzar directamente sin foto
            buttonHtml += `<button class="move-order-btn" onclick="moveOrder('${order.id}', 'entregada')" title="Mover a ${nextStateLabel}">↓</button>`;
            // Mostrar botón de foto para entregar con foto
            buttonHtml += `<button class="move-order-btn-photo" onclick="initiateDelivery('${order.id}')" title="Marcar como Entregado con Foto">📸</button>`;
          } else {
            buttonHtml += `<button class="move-order-btn" onclick="moveOrder('${order.id}', '${currentFlow.next}')" title="Mover a ${nextStateLabel}">↓</button>`;
          }
        }

        // Add cancel button for non-cancelled and non-closed orders
        if (currentState !== 'cancelada' && currentState !== 'cerrada') {
          buttonHtml += `<button class="cancel-order-btn" onclick="moveOrder('${order.id}', 'cancelada')" title="Cancelar pedido">❌</button>`;
        }
      } else {
        // Para usuarios no-admin, mostrar estado actual sin botones
        if (currentState === 'entregada') {
          // Show photo button for entregada state
          const photoViewBtn = order.deliveryPhoto ?
            `<button class="view-photo-btn" onclick="viewDeliveryPhoto('${order.id}')" title="Ver foto de entrega">📸</button>` : '';
          buttonHtml = `<div class="order-actions">
            <span class="delivered-status">✓ Entregada</span>
            ${photoViewBtn}
          </div>`;
        } else if (currentState === 'cerrada') {
          buttonHtml = `<span class="closed-status">🔒 Cerrada</span>`;
        } else if (currentState === 'cancelada') {
          buttonHtml = `<span class="cancelled-status">❌ Cancelada</span>`;
        } else {
          buttonHtml = `<span class="current-status">📋 ${stateLabels[currentState]}</span>`;
        }
      }

      // Agregar indicador de edición si existe
      let orderNumberDisplay = `#${order.numeroOrden || order.id.slice(-6)}`;
      if (order.editadaPor && order.editadaPorNombre) {
        orderNumberDisplay += ` <span style="color: #FF9800; font-size: 0.85em;">(editada por ${order.editadaPorNombre})</span>`;
      }

      return `
        <div class="order-item" data-order-id="${order.id}">
          <div class="order-info">
            <div class="order-number">${orderNumberDisplay}</div>
            <div class="order-details">
              ${order.fechaLocal || 'No date'} • ${order.cantidadItems || order.items?.length || 0} items • $${formatNumber(order.total || 0)}
            </div>
          </div>
          <div class="order-actions" onclick="event.stopPropagation()">
            ${buttonHtml}
          </div>
        </div>
      `;
    }

    // Move order to next state
    async function moveOrder(orderId, nextState) {
      // Verificar que el usuario sea admin
      if (!window.isUserAdmin) {
        alert('⚠️ No tienes permisos para mover órdenes');
        console.log('🚫 Usuario no-admin intentó mover orden');
        return;
      }

      if (!firebase || !firebase.firestore) {
        console.error('❌ Firebase not available');
        return;
      }
      // Special case: moving from revision to aprobada requires manual order number
      if (nextState === 'aprobada') {
        const order = window.orders?.find(o => o.id === orderId);
        if (order && order.logisticsState === 'revision') {
          showManualOrderNumberModal(orderId);
          return;
        }
      }


      try {
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', orderId);
        await updateDoc(orderRef, {
          logisticsState: nextState,
          lastStateUpdate: new Date()
        });

        console.log(`✅ Order ${orderId} moved to ${nextState}`);

        // Reload orders to reflect changes
        loadLogisticsOrders();

      } catch (error) {
        console.error('❌ Error moving order:', error);
        alert('Error moving order. Please try again.');
      }
    }

    // === ADVANCED ANALYTICS FUNCTIONALITY ===

    // Show order details modal
    let allOrdersCache = [];

    window.showOrderDetails = async function(orderId) {
      try {
        console.log('📋 Mostrando detalles de orden:', orderId);

        // Buscar la orden en el cache
        let order = allOrdersCache.find(o => o.id === orderId);

        // Si no está en cache, buscar en Firebase
        if (!order) {
          const { doc, getDoc } = firebase.firestoreHelpers;
          const db = firebase.firestore();
          const orderRef = doc(db, 'pedidos', orderId);
          const orderDoc = await getDoc(orderRef);

          if (orderDoc.exists()) {
            order = { id: orderDoc.id, ...orderDoc.data() };
          } else {
            alert('Orden no encontrada');
            return;
          }
        }

        // Mapeo de estados
        const stateLabels = {
          borrador: 'Borrador',
          revision: 'En Revisión',
          aprobada: 'Aprobada',
          preparacion: 'En Preparación',
          listo: 'Listo para Retiro/Despacho',
          despachada: 'Despachada',
          entregada: 'Entregada',
          cerrada: 'Cerrada',
          cancelada: 'Cancelada'
        };

        // Llenar información general
        let orderNumberText = `#${order.numeroOrden || order.id.slice(-6)}`;
        if (order.editadaPor && order.editadaPorNombre) {
          orderNumberText += ` <span style="color: #FF9800; font-size: 0.85em;">(editada por ${order.editadaPorNombre})</span>`;
        }
        document.getElementById('detailOrderNumber').innerHTML = orderNumberText;
        // Formato: Cliente NOMBRE, CODIGO XXX, EMAIL: usuario@email.com
        const emailUsuario = order.creadoPorAdmin ? order.usuarioEmail : (order.clienteEmail || order.usuarioEmail);
        const infoCliente = order.clienteNombre || order.usuarioEmail || '-';
        const codigoCliente = order.clienteCodigo ? `, CODIGO ${order.clienteCodigo}` : '';
        document.getElementById('detailClientName').textContent = `${infoCliente}${codigoCliente}`;
        document.getElementById('detailClientEmail').textContent = emailUsuario || '-';
        document.getElementById('detailOrderDate').textContent = order.fechaLocal || '-';
        document.getElementById('detailOrderState').textContent = stateLabels[order.logisticsState] || order.logisticsState || 'Sin estado';

        // Mostrar si fue creada por admin
        if (order.creadoPorAdmin) {
          document.getElementById('detailAdminCreatedContainer').style.display = 'grid';
          document.getElementById('detailAdminCreated').textContent = order.usuarioEmail || '-';
        } else {
          document.getElementById('detailAdminCreatedContainer').style.display = 'none';
        }

        // Mostrar foto y peso de preparación para todos los usuarios
        console.log('🖼️ [PHOTO DEBUG] Checking photo and weight for order:', orderId);
        console.log('🖼️ [PHOTO DEBUG] fotoPreparacion:', order.fotoPreparacion);
        console.log('🖼️ [PHOTO DEBUG] pesoPreparacion:', order.pesoPreparacion);

        const photoWeightContainer = document.getElementById('detailPhotoWeightContainer');
        const photoContainer = document.getElementById('detailPhotoContainer');
        const weightContainer = document.getElementById('detailWeightContainer');
        const noPhotoWeight = document.getElementById('detailNoPhotoWeight');
        const photoImg = document.getElementById('detailPhotoImg');
        const photoDate = document.getElementById('detailPhotoDate');
        const weightSpan = document.getElementById('detailWeight');

        console.log('🖼️ [PHOTO DEBUG] Modal elements found:', {
          photoWeightContainer: !!photoWeightContainer,
          photoContainer: !!photoContainer,
          photoImg: !!photoImg
        });

        let hasPhotoOrWeight = false;

        // Mostrar foto si existe
        if (order.fotoPreparacion) {
          console.log('🖼️ [PHOTO DEBUG] Photo found, setting up display...');
          photoImg.src = order.fotoPreparacion;

          // Mostrar fecha de actualización si existe
          if (order.fotoPreparacionUpdatedAt) {
            const fecha = new Date(order.fotoPreparacionUpdatedAt.seconds * 1000);
            photoDate.textContent = `Subida el: ${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString()}`;
          } else {
            photoDate.textContent = '';
          }

          photoContainer.style.display = 'grid';
          hasPhotoOrWeight = true;
        } else {
          photoContainer.style.display = 'none';
        }

        // Mostrar peso si existe
        if (order.pesoPreparacion) {
          weightSpan.textContent = `${order.pesoPreparacion} kg`;
          weightContainer.style.display = 'grid';
          hasPhotoOrWeight = true;
        } else {
          weightContainer.style.display = 'none';
        }

        // Mostrar la sección completa si hay foto o peso
        if (hasPhotoOrWeight) {
          photoWeightContainer.style.display = 'block';
          noPhotoWeight.style.display = 'none';
        } else {
          // Mostrar mensaje si no hay foto ni peso
          photoWeightContainer.style.display = 'block';
          noPhotoWeight.style.display = 'block';
        }

        // Llenar tabla de items con campos editables
        const itemsTableBody = document.getElementById('detailOrderItems');
        itemsTableBody.innerHTML = '';

        // Declarar hasChanges en el scope de la función
        let hasChanges = false;
        const originalItems = order.items ? JSON.parse(JSON.stringify(order.items)) : [];

        if (order.items && order.items.length > 0) {
          order.items.forEach((item, index) => {
            const row = document.createElement('tr');
            row.setAttribute('data-item-index', index);
            row.innerHTML = `
              <td>${item.articulo || '-'}</td>
              <td>${item.description || '-'}</td>
              <td style="text-align: center;">
                <input type="number"
                       class="editable-quantity"
                       value="${item.quantity || 0}"
                       min="0"
                       data-item-index="${index}"
                       data-price="${item.price || 0}">
              </td>
              <td style="text-align: right;">$${(item.price || 0).toFixed(2)}</td>
              <td class="item-subtotal" style="text-align: right;">$${(item.subtotal || 0).toFixed(2)}</td>
            `;
            itemsTableBody.appendChild(row);
          });

          // Agregar event listeners para actualizar subtotales y detectar cambios

          const quantityInputs = itemsTableBody.querySelectorAll('.editable-quantity');
          quantityInputs.forEach(input => {
            input.addEventListener('change', function() {
              const index = parseInt(this.getAttribute('data-item-index'));
              const price = parseFloat(this.getAttribute('data-price'));
              const quantity = parseInt(this.value) || 0;
              const subtotal = price * quantity;

              // Actualizar el item en el array
              order.items[index].quantity = quantity;
              order.items[index].subtotal = subtotal;

              // Actualizar subtotal en la fila
              const row = this.closest('tr');
              const subtotalCell = row.querySelector('.item-subtotal');
              subtotalCell.textContent = `$${subtotal.toFixed(2)}`;

              // Recalcular total
              const newTotal = order.items.reduce((sum, item) => sum + (item.subtotal || 0), 0);
              order.total = newTotal;
              document.getElementById('detailOrderTotal').textContent = `$${newTotal.toFixed(2)}`;

              // Detectar si hubo cambios
              hasChanges = true;
              const saveContainer = document.getElementById('detailSaveOrderContainer');
              if (saveContainer) {
                saveContainer.style.display = 'block';
              }
            });
          });
        } else {
          itemsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay items</td></tr>';
        }

        // Mostrar total
        document.getElementById('detailOrderTotal').textContent = `$${(order.total || 0).toFixed(2)}`;

        // Configurar botón Guardar
        const saveOrderContainer = document.getElementById('detailSaveOrderContainer');
        const saveOrderBtn = document.getElementById('detailSaveOrderBtn');

        // Ocultar botón Guardar inicialmente
        if (saveOrderContainer) {
          saveOrderContainer.style.display = 'none';
        }

        // Remover event listeners previos del botón Guardar
        if (saveOrderBtn) {
          const newSaveBtn = saveOrderBtn.cloneNode(true);
          saveOrderBtn.parentNode.replaceChild(newSaveBtn, saveOrderBtn);

          // Agregar nuevo event listener para Guardar
          newSaveBtn.addEventListener('click', async () => {
            try {
              console.log('💾 Guardando cambios en la orden...');

              const currentUser = firebase.auth().currentUser;
              if (!currentUser) {
                alert('❌ Debes estar autenticado para guardar cambios');
                return;
              }

              // Obtener email y nombre del usuario actual
              const userEmail = currentUser.email;
              let userName = userEmail;

              // Intentar obtener el nombre del vendedor desde Firestore
              try {
                const { doc, getDoc } = firebase.firestoreHelpers;
                const db = firebase.firestore();
                const userRef = doc(db, 'usuarios', currentUser.uid);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                  const userData = userDoc.data();
                  userName = userData.nombre || userData.email || userEmail;
                }
              } catch (e) {
                console.warn('⚠️ No se pudo obtener nombre de usuario:', e);
              }

              // Actualizar orden en Firebase con información de quién editó
              const { doc, updateDoc } = firebase.firestoreHelpers;
              const db = firebase.firestore();
              const orderRef = doc(db, 'pedidos', order.id);

              await updateDoc(orderRef, {
                items: order.items,
                total: order.total,
                editadaPor: currentUser.uid,
                editadaPorEmail: userEmail,
                editadaPorNombre: userName,
                fechaEdicion: new Date().toISOString(),
                fechaEdicionLocal: new Date().toLocaleString('es-AR')
              });

              console.log('✅ Orden guardada exitosamente');

              // Enviar WhatsApp al vendedor (si no hay vendedor, se usa Santiago por defecto)
              console.log('📱 Preparando WhatsApp para vendedor:', order.vendedorId || 'Santiago (por defecto)');
              const updatedOrderData = {
                ...order,
                editadaPorNombre: userName,
                cantidadItems: order.items?.length || 0
              };
              await sendOrderToSellerWhatsApp(updatedOrderData, order.numeroOrden, order.clienteNombre || order.clienteEmail || order.usuarioEmail);

              // Actualizar el número de orden con el indicador de edición
              let orderNumberText = `#${order.numeroOrden || order.id.slice(-6)}`;
              orderNumberText += ` <span style="color: #FF9800; font-size: 0.85em;">(editada por ${userName})</span>`;
              document.getElementById('detailOrderNumber').innerHTML = orderNumberText;

              // Ocultar botón Guardar
              saveOrderContainer.style.display = 'none';
              hasChanges = false;

              // Actualizar cache de órdenes
              const orderIndex = allOrdersCache.findIndex(o => o.id === order.id);
              if (orderIndex !== -1) {
                allOrdersCache[orderIndex] = { ...order, editadaPor: currentUser.uid, editadaPorNombre: userName };
              }

              // Recargar órdenes en seguimiento para reflejar cambios
              if (window.loadLogisticsOrders) {
                await loadLogisticsOrders();
              }

              alert('✅ Cambios guardados exitosamente');
            } catch (error) {
              console.error('❌ Error guardando cambios:', error);
              alert('❌ Error al guardar cambios. Por favor intenta nuevamente.');
            }
          });
        }

        // Mostrar botón "Seguir Comprando" en todos los estados
        const editOrderContainer = document.getElementById('detailEditOrderContainer');
        const editOrderBtn = document.getElementById('detailEditOrderBtn');

        // Siempre mostrar el botón
        editOrderContainer.style.display = 'block';

        // Remover event listeners previos
        const newEditBtn = editOrderBtn.cloneNode(true);
        editOrderBtn.parentNode.replaceChild(newEditBtn, editOrderBtn);

        // Agregar nuevo event listener
        newEditBtn.addEventListener('click', () => {
          editOrderInCart(order);
        });

        // Mostrar botón "Enviar WhatsApp" (siempre visible, usa Santiago si no hay vendedor)
        const whatsAppContainer = document.getElementById('detailSendWhatsAppContainer');
        const whatsAppBtn = document.getElementById('detailSendWhatsAppBtn');

        whatsAppContainer.style.display = 'block';

        // Remover event listeners previos
        const newWhatsAppBtn = whatsAppBtn.cloneNode(true);
        whatsAppBtn.parentNode.replaceChild(newWhatsAppBtn, whatsAppBtn);

        // Agregar event listener para enviar WhatsApp
        newWhatsAppBtn.addEventListener('click', async () => {
          console.log('📱 [Manual] Enviando WhatsApp...');
          const orderData = {
            ...order,
            cantidadItems: order.items?.length || 0
          };
          await sendOrderToSellerWhatsApp(orderData, order.numeroOrden, order.clienteNombre || order.clienteEmail || order.usuarioEmail);
        });

        // Agregar funcionalidad de ordenamiento a las columnas
        const sortableHeaders = document.querySelectorAll('#detailOrderTable .sortable-header');
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        sortableHeaders.forEach(header => {
          header.addEventListener('click', function() {
            const column = this.getAttribute('data-sort-column');

            // Si es la misma columna, cambiar dirección
            if (currentSortColumn === column) {
              currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
              currentSortColumn = column;
              currentSortDirection = 'asc';
            }

            // Remover clases de ordenamiento de todos los headers
            sortableHeaders.forEach(h => {
              h.classList.remove('sort-asc', 'sort-desc');
            });

            // Agregar clase de ordenamiento al header actual
            this.classList.add(`sort-${currentSortDirection}`);

            // Ordenar los items
            order.items.sort((a, b) => {
              let valueA, valueB;

              switch(column) {
                case 'articulo':
                  valueA = (a.articulo || '').toLowerCase();
                  valueB = (b.articulo || '').toLowerCase();
                  break;
                case 'description':
                  valueA = (a.description || '').toLowerCase();
                  valueB = (b.description || '').toLowerCase();
                  break;
                case 'quantity':
                  valueA = a.quantity || 0;
                  valueB = b.quantity || 0;
                  break;
                case 'price':
                  valueA = a.price || 0;
                  valueB = b.price || 0;
                  break;
                case 'subtotal':
                  valueA = a.subtotal || 0;
                  valueB = b.subtotal || 0;
                  break;
                default:
                  return 0;
              }

              if (valueA < valueB) return currentSortDirection === 'asc' ? -1 : 1;
              if (valueA > valueB) return currentSortDirection === 'asc' ? 1 : -1;
              return 0;
            });

            // Volver a renderizar la tabla
            itemsTableBody.innerHTML = '';
            order.items.forEach((item, index) => {
              const row = document.createElement('tr');
              row.setAttribute('data-item-index', index);
              row.innerHTML = `
                <td>${item.articulo || '-'}</td>
                <td>${item.description || '-'}</td>
                <td style="text-align: center;">
                  <input type="number"
                         class="editable-quantity"
                         value="${item.quantity || 0}"
                         min="0"
                         data-item-index="${index}"
                         data-price="${item.price || 0}">
                </td>
                <td style="text-align: right;">$${(item.price || 0).toFixed(2)}</td>
                <td class="item-subtotal" style="text-align: right;">$${(item.subtotal || 0).toFixed(2)}</td>
              `;
              itemsTableBody.appendChild(row);
            });

            // Re-agregar event listeners a los inputs de cantidad
            const quantityInputs = itemsTableBody.querySelectorAll('.editable-quantity');
            quantityInputs.forEach(input => {
              input.addEventListener('change', function() {
                const index = parseInt(this.getAttribute('data-item-index'));
                const price = parseFloat(this.getAttribute('data-price'));
                const quantity = parseInt(this.value) || 0;
                const subtotal = price * quantity;

                order.items[index].quantity = quantity;
                order.items[index].subtotal = subtotal;

                const row = this.closest('tr');
                const subtotalCell = row.querySelector('.item-subtotal');
                subtotalCell.textContent = `$${subtotal.toFixed(2)}`;

                const newTotal = order.items.reduce((sum, item) => sum + (item.subtotal || 0), 0);
                order.total = newTotal;
                document.getElementById('detailOrderTotal').textContent = `$${newTotal.toFixed(2)}`;
              });
            });
          });
        });

        // Mostrar modal
        document.getElementById('orderDetailsModal').style.display = 'block';

        // Inicializar botones MDC después de agregar al DOM
        setTimeout(() => {
          const mdcButtons = document.querySelectorAll('#orderDetailsModal .mdc-button');
          mdcButtons.forEach(button => {
            if (!button._mdcRipple) {
              mdc.ripple.MDCRipple.attachTo(button);
            }
          });
        }, 100);

      } catch (error) {
        console.error('❌ Error mostrando detalles de orden:', error);
        alert('Error al cargar detalles de la orden');
      }
    }

    // Editar orden en marketplace.html (volver a comprar)
    function editOrderInCart(order) {
      try {
        console.log('🛒 Cargando orden en carrito para editar:', order);

        // Guardar orden en localStorage primero
        const cartItems = order.items.map(item => ({
          item: item.articulo,
          description: item.description,
          price: item.price,
          quantity: item.quantity
        }));
        localStorage.setItem('cart', JSON.stringify(cartItems));
        localStorage.setItem('editingOrderId', order.id);
        console.log('💾 Orden guardada en localStorage:', cartItems.length, 'items');

        // Verificar si mappedStockData está disponible
        if (!window.mappedStockData || window.mappedStockData.length === 0) {
          console.log('⚠️ mappedStockData no disponible, recargando página para cargar productos...');

          // Cerrar el modal antes de recargar
          const modal = document.getElementById('orderDetailsModal');
          if (modal) modal.style.display = 'none';

          const logisticsModal = document.getElementById('logisticsModal');
          if (logisticsModal) logisticsModal.classList.add('hidden');

          // Recargar la página - el código de carga del carrito lo manejará
          window.location.reload();
          return;
        }

        // Si mappedStockData está disponible, cargar directamente
        console.log('✅ mappedStockData disponible, cargando productos...');

        // Limpiar selectedItems antes de cargar la orden
        if (window.selectedItems) {
          window.selectedItems.clear();
          console.log('🗑️ selectedItems limpiado');
        }

        // Cargar items directamente en selectedItems
        let loadedCount = 0;
        order.items.forEach(item => {
          console.log(`🔍 Cargando producto: "${item.articulo}" x${item.quantity}`);

          // Buscar el producto en mappedStockData
          const product = window.mappedStockData.find(p =>
            p.articulo === item.articulo ||
            p.articulo.trim() === item.articulo.trim() ||
            p.articulo.toLowerCase() === item.articulo.toLowerCase()
          );

          if (product && window.selectedItems) {
            window.selectedItems.set(item.articulo, {
              product: product,
              quantity: item.quantity
            });
            console.log(`✅ Producto cargado: ${item.articulo} x${item.quantity}`);
            loadedCount++;
          } else {
            console.warn(`⚠️ Producto no encontrado: ${item.articulo}`);
          }
        });

        console.log(`✅ Orden cargada: ${loadedCount}/${order.items.length} productos en selectedItems`);

        // Cerrar modales
        const orderModal = document.getElementById('orderDetailsModal');
        if (orderModal) orderModal.style.display = 'none';

        const logisticsModal = document.getElementById('logisticsModal');
        if (logisticsModal) logisticsModal.classList.add('hidden');

        // Re-renderizar la tabla para mostrar las cantidades
        if (window.renderRows) {
          console.log('🔄 Re-renderizando tabla con productos del carrito...');
          window.renderRows();
        }

        // Actualizar badge del carrito
        if (window.updateCartBadge) {
          window.updateCartBadge();
        }

        console.log('✅ Vista actualizada con productos de la orden');

      } catch (error) {
        console.error('❌ Error cargando orden en carrito:', error);
        alert('Error al cargar la orden en el carrito');
      }
    }

    // Cerrar modal de detalles
    const orderDetailsModal = document.getElementById('orderDetailsModal');
    if (orderDetailsModal) {
      const closeBtn = orderDetailsModal.querySelector('.order-details-close');
      if (closeBtn) {
        closeBtn.onclick = function() {
          orderDetailsModal.style.display = 'none';
        };
      }

      window.onclick = function(event) {
        if (event.target == orderDetailsModal) {
          orderDetailsModal.style.display = 'none';
        }
      };
    }

    // Calculate most purchased item from Firebase orders
    async function getMostPurchasedItem() {
      if (!firebase || !firebase.auth().currentUser) {
        return "No data";
      }

      try {
        const { collection, getDocs } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const pedidosCollection = collection(db, 'pedidos');
        const querySnapshot = await getDocs(pedidosCollection);

        const itemCounts = {};

        querySnapshot.forEach(doc => {
          const data = doc.data();
          if (data.items && Array.isArray(data.items)) {
            data.items.forEach(item => {
              const itemName = item.description || item.articulo || 'Unknown';
              const quantity = parseInt(item.quantity) || 1;
              itemCounts[itemName] = (itemCounts[itemName] || 0) + quantity;
            });
          }
        });

        const sortedItems = Object.entries(itemCounts).sort(([,a], [,b]) => b - a);

        if (sortedItems.length > 0) {
          const [itemName, count] = sortedItems[0];
          return `${itemName} (${count}x)`;
        }

        return "No purchases";
      } catch (error) {
        console.error('❌ Error calculating most purchased item:', error);
        return "Error loading data";
      }
    }

    // Calculate month with most sales from Firebase orders
    async function getBestSalesMonth() {
      if (!firebase || !firebase.auth().currentUser) {
        return "No data";
      }

      try {
        const { collection, getDocs } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const pedidosCollection = collection(db, 'pedidos');
        const querySnapshot = await getDocs(pedidosCollection);

        const monthlySales = {};

        querySnapshot.forEach(doc => {
          const data = doc.data();
          let orderDate = null;

          // Try to get date from different fields
          if (data.timestamp) {
            orderDate = new Date(data.timestamp);
          } else if (data.fecha) {
            orderDate = data.fecha.toDate ? data.fecha.toDate() : new Date(data.fecha);
          } else if (data.fechaLocal) {
            orderDate = new Date(data.fechaLocal);
          }

          if (orderDate && !isNaN(orderDate.getTime())) {
            const monthKey = `${orderDate.getFullYear()}-${String(orderDate.getMonth() + 1).padStart(2, '0')}`;
            const total = parseFloat(data.total) || 0;
            monthlySales[monthKey] = (monthlySales[monthKey] || 0) + total;
          }
        });

        const sortedMonths = Object.entries(monthlySales).sort(([,a], [,b]) => b - a);

        if (sortedMonths.length > 0) {
          const [monthKey, total] = sortedMonths[0];
          const [year, month] = monthKey.split('-');
          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          return `${monthNames[parseInt(month) - 1]} ${year} ($${Math.round(total)})`;
        }

        return "No sales data";
      } catch (error) {
        console.error('❌ Error calculating best sales month:', error);
        return "Error loading data";
      }
    }

    // Calculate item with most stock changes (theoretical stock variations)
    async function getMostStockChangesItem() {
      try {
        // Use the data that's already loaded in the table
        const tableRows = document.querySelectorAll('tbody tr:not(.totals-row)');

        if (tableRows.length === 0) {
          return "No data in table";
        }

        let maxItem = null;
        let maxStock = 0;

        tableRows.forEach(row => {
          // Get the cells from the current row
          const cells = row.querySelectorAll('td');
          if (cells.length === 0) return;

          // Try to find the description and theoretical stock columns
          // Assuming article is first column and stockTeorico is in the table
          let description = '';
          let theoreticalStock = 0;

          // Get description from first visible cell
          if (cells[0]) {
            description = cells[0].textContent.trim();
          }

          // Look for theoretical stock in the visible cells
          cells.forEach(cell => {
            const cellText = cell.textContent.trim();
            const cellValue = parseInt(cellText) || 0;

            // If this looks like a stock value (reasonable range)
            if (cellValue > theoreticalStock && cellValue < 100000) {
              theoreticalStock = cellValue;
            }
          });

          if (theoreticalStock > maxStock && description) {
            maxStock = theoreticalStock;
            maxItem = { description, theoreticalStock };
          }
        });

        if (maxItem && maxStock > 0) {
          return `${maxItem.description} (${maxStock})`;
        }

        // Fallback: try to access global data if table scan didn't work
        if (window.lastData && Array.isArray(window.lastData)) {
          let fallbackMaxItem = null;
          let fallbackMaxStock = 0;

          window.lastData.forEach(item => {
            const theoreticalStock = parseInt(item.stockTeorico) || 0;
            if (theoreticalStock > fallbackMaxStock) {
              fallbackMaxStock = theoreticalStock;
              fallbackMaxItem = item;
            }
          });

          if (fallbackMaxItem) {
            return `${fallbackMaxItem.description || fallbackMaxItem.articulo} (${fallbackMaxStock})`;
          }
        }

        return "No stock data available";
      } catch (error) {
        console.error('❌ Error calculating most stock changes:', error);
        return "Analysis not available";
      }
    }

    // Calculate total registered users from Firebase Auth
    async function getTotalRegisteredUsers() {
      try {
        // Since we can't directly access all users from client-side Firebase Auth,
        // we'll count unique users from orders as a proxy
        if (!firebase || !firebase.auth().currentUser) {
          return "Auth required";
        }

        const { collection, getDocs } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const pedidosCollection = collection(db, 'pedidos');
        const querySnapshot = await getDocs(pedidosCollection);

        const uniqueUsers = new Set();

        querySnapshot.forEach(doc => {
          const data = doc.data();
          // Try different user identifier fields
          if (data.userId) {
            uniqueUsers.add(data.userId);
          } else if (data.userEmail) {
            uniqueUsers.add(data.userEmail);
          } else if (data.usuario) {
            uniqueUsers.add(data.usuario);
          }
        });

        const totalUsers = uniqueUsers.size;
        return totalUsers > 0 ? `${totalUsers} usuarios` : "No user data";

      } catch (error) {
        console.error('❌ Error calculating total users:', error);
        return "Error loading users";
      }
    }

    // Calculate most active user based on order count
    async function getMostActiveUser() {
      try {
        if (!firebase || !firebase.auth().currentUser) {
          return "Auth required";
        }

        const { collection, getDocs } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const pedidosCollection = collection(db, 'pedidos');
        const querySnapshot = await getDocs(pedidosCollection);

        const userActivity = {};

        querySnapshot.forEach(doc => {
          const data = doc.data();
          let userIdentifier = null;

          // Try to get user identifier
          if (data.userEmail) {
            userIdentifier = data.userEmail;
          } else if (data.usuario) {
            userIdentifier = data.usuario;
          } else if (data.userId) {
            userIdentifier = data.userId;
          }

          if (userIdentifier) {
            userActivity[userIdentifier] = (userActivity[userIdentifier] || 0) + 1;
          }
        });

        const sortedUsers = Object.entries(userActivity).sort(([,a], [,b]) => b - a);

        if (sortedUsers.length > 0) {
          const [userIdentifier, orderCount] = sortedUsers[0];
          // Clean up email to show just the name part
          const displayName = userIdentifier.includes('@') ?
            userIdentifier.split('@')[0] : userIdentifier;
          return `${displayName} (${orderCount} pedidos)`;
        }

        return "No activity data";

      } catch (error) {
        console.error('❌ Error calculating most active user:', error);
        return "Error loading activity";
      }
    }

    // Update advanced stats
    async function updateAdvancedStats() {
      console.log('📊 Updating advanced statistics...');

      // Update most purchased item
      const mostPurchasedItem = await getMostPurchasedItem();
      const mostPurchasedStat = document.getElementById('mostPurchasedItemStat');
      if (mostPurchasedStat) {
        mostPurchasedStat.textContent = mostPurchasedItem;
      }

      // Update best sales month
      const bestSalesMonth = await getBestSalesMonth();
      const bestSalesMonthStat = document.getElementById('bestSalesMonthStat');
      if (bestSalesMonthStat) {
        bestSalesMonthStat.textContent = bestSalesMonth;
      }

      // Update most stock changes item
      const mostStockChanges = await getMostStockChangesItem();
      const mostStockChangesStat = document.getElementById('mostStockChangesStat');
      if (mostStockChangesStat) {
        mostStockChangesStat.textContent = mostStockChanges;
      }

      // Update total registered users
      const totalUsers = await getTotalRegisteredUsers();
      const totalUsersStat = document.getElementById('totalUsersStat');
      if (totalUsersStat) {
        totalUsersStat.textContent = totalUsers;
      }

      // Update most active user
      const mostActiveUser = await getMostActiveUser();
      const mostActiveUserStat = document.getElementById('mostActiveUserStat');
      if (mostActiveUserStat) {
        mostActiveUserStat.textContent = mostActiveUser;
      }

      console.log('✅ Advanced statistics updated');
    }

    // Expose advanced stats function globally
    window.updateAdvancedStats = updateAdvancedStats;

    // === PHOTO UPLOAD FUNCTIONALITY ===

    let currentOrderId = null;
    let selectedPhoto = null;

    // Initiate delivery process - opens photo upload modal
    function initiateDelivery(orderId) {
      currentOrderId = orderId;
      openModal('photoUploadModal');
    }

    // Setup photo upload event listeners
    function setupPhotoUpload() {
      const cameraBtn = document.getElementById('cameraBtn');
      const fileBtn = document.getElementById('fileBtn');
      const photoInput = document.getElementById('photoInput');
      const fileInput = document.getElementById('fileInput');
      const previewImage = document.getElementById('previewImage');
      const photoPreview = document.getElementById('photoPreview');
      const confirmBtn = document.getElementById('confirmUploadBtn');
      const cancelBtn = document.getElementById('cancelUploadBtn');

      if (cameraBtn) {
        cameraBtn.addEventListener('click', async () => {
          await openCameraCapture();
        });
      }

      if (fileBtn) {
        fileBtn.addEventListener('click', () => {
          fileInput.click();
        });
      }

      if (photoInput) {
        photoInput.addEventListener('change', handlePhotoSelection);
      }

      if (fileInput) {
        fileInput.addEventListener('change', handlePhotoSelection);
      }

      if (confirmBtn) {
        confirmBtn.addEventListener('click', confirmDelivery);
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', cancelPhotoUpload);
      }
    }

    // Open camera capture using getUserMedia API
    let cameraStream = null;
    async function openCameraCapture() {
      try {
        // Check if getUserMedia is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('❌ Tu navegador no soporta acceso directo a la cámara.\n\nUsando el botón "Cargar Foto Guardada" puedes seleccionar una imagen.');
          // Fallback to file input with capture
          photoInput.click();
          return;
        }

        // Request camera access
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }, // Prefer back camera on mobile
          audio: false
        });

        // Create camera modal
        const cameraModal = document.createElement('div');
        cameraModal.id = 'cameraModal';
        cameraModal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.95);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          padding: 20px;
          box-sizing: border-box;
        `;

        const video = document.createElement('video');
        video.id = 'cameraVideo';
        video.autoplay = true;
        video.playsInline = true;
        video.style.cssText = `
          max-width: 100%;
          max-height: 70vh;
          border-radius: 8px;
          margin-bottom: 20px;
        `;
        video.srcObject = cameraStream;

        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
          display: flex;
          gap: 15px;
          flex-wrap: wrap;
          justify-content: center;
        `;

        const captureBtn = document.createElement('button');
        captureBtn.textContent = '📸 Capturar Foto';
        captureBtn.style.cssText = `
          padding: 15px 30px;
          background: #4CAF50;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
        `;

        const cancelCameraBtn = document.createElement('button');
        cancelCameraBtn.textContent = '❌ Cancelar';
        cancelCameraBtn.style.cssText = `
          padding: 15px 30px;
          background: #f44336;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
        `;

        // Capture photo
        captureBtn.addEventListener('click', () => {
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);

          // Convert canvas to blob
          canvas.toBlob((blob) => {
            // Stop camera
            if (cameraStream) {
              cameraStream.getTracks().forEach(track => track.stop());
              cameraStream = null;
            }

            // Remove camera modal
            document.body.removeChild(cameraModal);

            // Create file from blob
            const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
              const previewImage = document.getElementById('previewImage');
              const photoPreview = document.getElementById('photoPreview');

              previewImage.src = e.target.result;
              photoPreview.style.display = 'block';

              // Store file for upload
              selectedPhoto = file;
            };
            reader.readAsDataURL(file);
          }, 'image/jpeg', 0.95);
        });

        // Cancel camera
        cancelCameraBtn.addEventListener('click', () => {
          if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
          }
          document.body.removeChild(cameraModal);
        });

        buttonContainer.appendChild(captureBtn);
        buttonContainer.appendChild(cancelCameraBtn);
        cameraModal.appendChild(video);
        cameraModal.appendChild(buttonContainer);
        document.body.appendChild(cameraModal);

      } catch (error) {
        console.error('Error accessing camera:', error);
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          alert('❌ Permiso de cámara denegado.\n\nPor favor permite el acceso a la cámara en la configuración de tu navegador, o usa "Cargar Foto Guardada".');
        } else if (error.name === 'NotFoundError') {
          alert('❌ No se encontró ninguna cámara en tu dispositivo.\n\nUsa "Cargar Foto Guardada" en su lugar.');
        } else {
          alert('❌ Error al acceder a la cámara: ' + error.message + '\n\nPuedes usar "Cargar Foto Guardada" como alternativa.');
        }
        // Fallback to file input
        photoInput.click();
      }
    }

    // Handle photo selection
    function handlePhotoSelection(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('Por favor selecciona un archivo de imagen válido.');
        return;
      }

      selectedPhoto = file;
      const reader = new FileReader();

      reader.onload = (e) => {
        const previewImage = document.getElementById('previewImage');
        const photoPreview = document.getElementById('photoPreview');

        if (previewImage && photoPreview) {
          previewImage.src = e.target.result;
          photoPreview.style.display = 'block';
        }
      };

      reader.readAsDataURL(file);
    }

    // Confirm delivery with photo upload
    async function confirmDelivery() {
      if (!selectedPhoto || !currentOrderId) {
        alert('Error: No se seleccionó foto o pedido.');
        return;
      }

      try {
        // Show upload progress
        const uploadProgress = document.getElementById('uploadProgress');
        const photoPreview = document.getElementById('photoPreview');

        if (uploadProgress && photoPreview) {
          photoPreview.style.display = 'none';
          uploadProgress.style.display = 'block';
        }

        // Upload photo to Firebase Storage
        const photoUrl = await uploadPhotoToFirebase(selectedPhoto, currentOrderId);

        // Update order with photo and delivered status
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', currentOrderId);
        await updateDoc(orderRef, {
          logisticsState: 'delivered',
          deliveryPhoto: photoUrl,
          deliveryDate: new Date(),
          lastStateUpdate: new Date()
        });

        console.log(`✅ Order ${currentOrderId} delivered with photo`);

        // Close modal and reload orders
        closeModal('photoUploadModal');
        resetPhotoUpload();
        loadLogisticsOrders();

      } catch (error) {
        console.error('❌ Error confirming delivery:', error);
        alert('Error al confirmar entrega. Intenta nuevamente.');

        // Hide upload progress on error
        const uploadProgress = document.getElementById('uploadProgress');
        const photoPreview = document.getElementById('photoPreview');

        if (uploadProgress && photoPreview) {
          uploadProgress.style.display = 'none';
          photoPreview.style.display = 'block';
        }
      }
    }

    // Save photo directly to Firestore (avoids CORS issues)
    async function uploadPhotoToFirebase(file, orderId) {
      const currentUser = firebase.auth().currentUser;
      if (!currentUser) {
        throw new Error('Usuario no autenticado');
      }

      console.log('📤 Guardando foto directamente en Firestore...');

      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = async (e) => {
          try {
            const base64 = e.target.result;

            // Compress image if it's too large (optional)
            const compressedBase64 = await compressImage(base64, 0.8, 800);

            // Save photo directly to Firestore
            const { doc, setDoc } = firebase.firestoreHelpers;
            const db = firebase.firestore();

            const photoId = `${currentUser.uid}_${orderId}_${Date.now()}`;
            const photoRef = doc(db, 'delivery-photos', photoId);

            await setDoc(photoRef, {
              orderId: orderId,
              userId: currentUser.uid,
              photoData: compressedBase64,
              uploadDate: new Date(),
              fileName: `${photoId}.jpg`,
              fileSize: file.size,
              fileType: file.type
            });

            console.log('✅ Foto guardada en Firestore:', photoId);
            resolve(`firestore:${photoId}`);
          } catch (error) {
            console.error('❌ Error guardando foto en Firestore:', error);
            reject(new Error(`Error al guardar la foto: ${error.message}`));
          }
        };

        reader.onerror = () => {
          reject(new Error('Error al leer el archivo de imagen'));
        };

        reader.readAsDataURL(file);
      });
    }

    // Compress image to reduce Firestore storage usage
    function compressImage(base64, quality = 0.8, maxWidth = 800) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        img.onload = () => {
          // Calculate new dimensions
          let { width, height } = img;

          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;

          // Draw and compress
          ctx.drawImage(img, 0, 0, width, height);
          const compressedBase64 = canvas.toDataURL('image/jpeg', quality);

          resolve(compressedBase64);
        };

        img.src = base64;
      });
    }

    // Cancel photo upload
    function cancelPhotoUpload() {
      resetPhotoUpload();
      closeModal('photoUploadModal');
    }

    // Reset photo upload state
    function resetPhotoUpload() {
      selectedPhoto = null;
      currentOrderId = null;

      const photoPreview = document.getElementById('photoPreview');
      const uploadProgress = document.getElementById('uploadProgress');
      const previewImage = document.getElementById('previewImage');
      const photoInput = document.getElementById('photoInput');
      const fileInput = document.getElementById('fileInput');

      if (photoPreview) photoPreview.style.display = 'none';
      if (uploadProgress) uploadProgress.style.display = 'none';
      if (previewImage) previewImage.src = '';
      if (photoInput) photoInput.value = '';
      if (fileInput) fileInput.value = '';
    }

    // View delivery photo
    async function viewDeliveryPhoto(orderId) {
      try {
        const { doc, getDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', orderId);
        const orderSnap = await getDoc(orderRef);

        if (!orderSnap.exists()) {
          alert('Pedido no encontrado');
          return;
        }

        const orderData = orderSnap.data();
        if (!orderData.deliveryPhoto) {
          alert('No hay foto de entrega para este pedido');
          return;
        }

        console.log('📖 Cargando foto de entrega...');

        // All photos are now stored in Firestore
        const photoId = orderData.deliveryPhoto.replace('firestore:', '');
        const photoRef = doc(db, 'delivery-photos', photoId);
        const photoSnap = await getDoc(photoRef);

        if (!photoSnap.exists()) {
          alert('Foto no encontrada en la base de datos');
          return;
        }

        const photoData = photoSnap.data();
        const photoSrc = photoData.photoData;

        console.log('✅ Foto cargada desde Firestore');

        // Show photo in modal
        const viewImage = document.getElementById('viewImage');
        const photoDate = document.getElementById('photoDate');
        const photoOrder = document.getElementById('photoOrder');

        if (viewImage) {
          viewImage.src = photoSrc;
          // Add loading state
          viewImage.onload = () => {
            console.log('✅ Foto mostrada en modal');
          };
          viewImage.onerror = () => {
            console.error('❌ Error mostrando foto');
            alert('Error al mostrar la foto');
          };
        }

        if (photoDate) {
          const uploadDate = photoData.uploadDate ? new Date(photoData.uploadDate.toDate()).toLocaleString() : 'No disponible';
          photoDate.textContent = `Fecha de entrega: ${uploadDate}`;
        }

        if (photoOrder) {
          photoOrder.textContent = `Pedido #${orderData.numeroOrden || orderId.slice(-6)}`;
        }

        openModal('photoViewModal');

      } catch (error) {
        console.error('❌ Error viewing photo:', error);
        alert(`Error al cargar la foto: ${error.message}`);
      }
    }

    // Initialize photo upload when page loads
    document.addEventListener('DOMContentLoaded', () => {
      setupPhotoUpload();
    });

    // Expose logistics functions globally
    window.loadLogisticsOrders = loadLogisticsOrders;
    window.moveOrder = moveOrder;
    window.initiateDelivery = initiateDelivery;
    window.viewDeliveryPhoto = viewDeliveryPhoto;

    console.log('✅ Firebase disponible globalmente');
  </script>

  <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
  <script>
    // Initialize Material Design Components
    // Current view mode (default: table)
    let currentViewMode = localStorage.getItem('viewMode') || 'table';

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize all buttons
      const buttons = document.querySelectorAll('.mdc-button');
      buttons.forEach(button => mdc.ripple.MDCRipple.attachTo(button));

      // Setup Add to Cart button
      const addToCartBtn = document.getElementById('addToCartBtn');

      function handleAddToCart() {
        // Check if selectedItems exists and has items
        if (!window.selectedItems || window.selectedItems.size === 0) {
          alert('Por favor selecciona al menos un producto con cantidad mayor a 0');
          return;
        }

        // Filter out items with quantity 0 and validate prices
        const itemsToAdd = [];
        const itemsWithoutPrice = [];

        window.selectedItems.forEach(({ product, quantity }, id) => {
          if (quantity > 0) {
            // Check if product has a valid price
            if (product.price === null || product.price === undefined || product.price === 0) {
              itemsWithoutPrice.push({
                articulo: product.articulo,
                description: product.description,
                quantity: quantity
              });
            }

            itemsToAdd.push({
              item: product.articulo,
              description: product.description,
              price: product.price,
              quantity
            });
          }
        });

        if (itemsToAdd.length === 0) {
          alert('Por favor selecciona al menos un producto con cantidad mayor a 0');
          return;
        }

        // Alert if there are items without price
        if (itemsWithoutPrice.length > 0) {
          const productList = itemsWithoutPrice.map(item =>
            `• ${item.articulo} - ${item.description} (Cant: ${item.quantity})`
          ).join('\n');

          const proceed = confirm(
            `⚠️ ATENCIÓN: Los siguientes productos NO TIENEN PRECIO asignado:\n\n${productList}\n\n` +
            `Estos productos aparecerán con precio $0 en la orden.\n\n` +
            `¿Deseas continuar de todas formas?`
          );

          if (!proceed) {
            console.log('❌ Usuario canceló creación de orden por productos sin precio');
            return;
          }

          console.warn('⚠️ Usuario confirmó crear orden con productos sin precio:', itemsWithoutPrice);
        }

        // Save cart to localStorage
        localStorage.setItem('cart', JSON.stringify(itemsToAdd));
        // Limpiar editingOrderId porque estamos creando una orden nueva
        localStorage.removeItem('editingOrderId');
        console.log('Cart saved with', itemsToAdd.length, 'items, redirecting to cart.html');

        // Redirect to cart page
        window.location.href = 'cart.html';
      }

      if (addToCartBtn) {
        addToCartBtn.addEventListener('click', handleAddToCart);
      }

      // Initialize checkboxes
      const checkboxes = document.querySelectorAll('.mdc-checkbox');
      checkboxes.forEach(checkbox => mdc.checkbox.MDCCheckbox.attachTo(checkbox));
      
      // Initialize text fields
      const textFields = document.querySelectorAll('.mdc-text-field');
      textFields.forEach(textField => mdc.textField.MDCTextField.attachTo(textField));
      
      // Initialize both tab bars
      const tabBars = document.querySelectorAll('.mdc-tab-bar');
      const mdcTabBars = [];

      tabBars.forEach((tabBar, barIndex) => {
        const mdcTabBar = mdc.tabBar.MDCTabBar.attachTo(tabBar);
        mdcTabBars.push(mdcTabBar);

        // Note: Admin tabs visibility is now handled in applyControlsVisibility()
        // which is called after user permissions are verified

        // Handle tab activation
        mdcTabBar.listen('MDCTabBar:activated', (event) => {
          const tab = tabBar.querySelectorAll('.mdc-tab')[event.detail.index];
          const segment = tab.getAttribute('data-segment');
          const tabId = tab.getAttribute('data-tab');

          // Deactivate tabs in the other tab bar
          tabBars.forEach((otherBar, otherIndex) => {
            if (otherIndex !== barIndex) {
              otherBar.querySelectorAll('.mdc-tab').forEach(t => {
                t.classList.remove('mdc-tab--active');
                t.setAttribute('aria-selected', 'false');
                const indicator = t.querySelector('.mdc-tab-indicator');
                if (indicator) indicator.classList.remove('mdc-tab-indicator--active');
              });
            }
          });

          // Handle admin tabs (PRECIOS, MASTER)
          if (tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
              content.style.display = 'none';
            });

            // Hide marketplace specific containers
            const tableView = document.getElementById('tableViewContainer');
            const gridView = document.getElementById('productsGrid');
            if (tableView) tableView.style.display = 'none';
            if (gridView) gridView.style.display = 'none';

            // Hide view mode selector (table/list/grid buttons)
            const viewModeSelector = document.querySelector('.view-mode-selector');
            if (viewModeSelector) viewModeSelector.style.display = 'none';

            // Hide Add to Cart button
            const addToCartBtn = document.getElementById('addToCartBtn');
            if (addToCartBtn) addToCartBtn.style.display = 'none';

            // Hide filter checkboxes
            const filterCheckboxes = document.getElementById('filterCheckboxes');
            if (filterCheckboxes) filterCheckboxes.style.display = 'none';

            // Hide error box
            const errorBox = document.getElementById('errorBox');
            if (errorBox) errorBox.style.display = 'none';

            // Show the selected admin tab content
            const content = document.getElementById(tabId + '-content');
            if (content) {
              content.style.display = 'block';
              console.log(`📋 Showing admin tab: ${tabId}`);

              // Load tab-specific data
              if (tabId === 'precios' && window.loadProducts) {
                window.loadProducts();
              } else if (tabId === 'master' && window.loadOrders) {
                window.loadOrders();
              }
            }
          }
          // Handle marketplace segment tabs (all, iphone, macbooks, samsung)
          else if (segment) {
            // Hide all admin tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
              content.style.display = 'none';
            });

            // Show marketplace containers based on current view mode
            window.switchView(currentViewMode);

            // Show view mode selector (table/list/grid buttons)
            const viewModeSelector = document.querySelector('.view-mode-selector');
            if (viewModeSelector) viewModeSelector.style.display = 'flex';

            // Show Add to Cart button
            const addToCartBtn = document.getElementById('addToCartBtn');
            if (addToCartBtn) addToCartBtn.style.display = '';

            // Show filter checkboxes
            const filterCheckboxes = document.getElementById('filterCheckboxes');
            if (filterCheckboxes) filterCheckboxes.style.display = '';

            // Error box stays hidden by default
            // (will be shown only when needed)

            // Trigger the existing tab functionality
            if (window.handleTabClick) {
              window.handleTabClick(segment);
            }
          }
        });
      });

      // Load cart from localStorage and populate selectedItems (for "Seguir Comprando" functionality)
      const cartData = localStorage.getItem('cart');
      if (cartData) {
        try {
          const cartItems = JSON.parse(cartData);
          console.log('📦 Cargando carrito desde localStorage:', cartItems.length, 'items');
          console.log('📦 Contenido del carrito:', cartItems);

          // Function to load cart items into selectedItems
          function loadCartIntoSelectedItems() {
            console.log('📊 Total productos disponibles:', window.mappedStockData.length);
            console.log('📊 Primeros 3 productos:', window.mappedStockData.slice(0, 3).map(p => p.articulo));

            // Filter out invalid items (undefined, null, empty)
            const validCartItems = cartItems.filter(item => {
              if (!item.item || item.item === 'undefined' || item.item.trim() === '') {
                console.warn('⚠️ Item inválido en carrito, ignorando:', item);
                return false;
              }
              return true;
            });

            console.log(`📦 Items válidos en carrito: ${validCartItems.length} de ${cartItems.length}`);

            let loadedCount = 0;
            validCartItems.forEach(cartItem => {
              // Find the product in the mapped stock data
              const product = window.mappedStockData.find(p => {
                // Check if both articulo and item exist and are strings
                if (!p.articulo || !cartItem.item) return false;

                const articulo = String(p.articulo);
                const item = String(cartItem.item);

                const match = articulo === item ||
                              articulo.trim() === item.trim() ||
                              articulo.toLowerCase() === item.toLowerCase();
                return match;
              });

              if (product && window.selectedItems) {
                // Add to selectedItems map
                window.selectedItems.set(cartItem.item, {
                  product: product,
                  quantity: cartItem.quantity
                });
                loadedCount++;
              } else {
                console.warn(`⚠️ Producto NO encontrado: "${cartItem.item}"`);

                // Try partial match with safety check
                const partialMatch = window.mappedStockData.find(p =>
                  p.articulo && cartItem.item && (
                    p.articulo.includes(cartItem.item) || cartItem.item.includes(p.articulo)
                  )
                );

                if (partialMatch) {
                  window.selectedItems.set(partialMatch.articulo, {
                    product: partialMatch,
                    quantity: cartItem.quantity
                  });
                  loadedCount++;
                }
              }
            });

            console.log(`✅ Carrito cargado: ${loadedCount} productos válidos`);

            // Forzar re-render de la tabla para mostrar las cantidades
            if (window.renderRows) {
              window.renderRows();
            }

            // Actualizar badge del carrito
            if (window.updateCartBadge) {
              window.updateCartBadge();
            }

            // Limpiar localStorage después de cargar exitosamente
            localStorage.removeItem('cart');
            console.log('✅ Vista actualizada con productos del carrito');
          }

          // Wait for products to be loaded before populating selectedItems
          let attempts = 0;
          const maxAttempts = 100; // 10 seconds max
          const waitForProducts = setInterval(() => {
            attempts++;
            console.log(`⏳ Esperando mappedStockData... intento ${attempts}/${maxAttempts}`);

            if (window.mappedStockData && window.mappedStockData.length > 0) {
              clearInterval(waitForProducts);
              console.log('✅ mappedStockData disponible, cargando carrito...');
              loadCartIntoSelectedItems();
            } else if (attempts >= maxAttempts) {
              clearInterval(waitForProducts);
              console.error('❌ Timeout: mappedStockData nunca se cargó después de 10 segundos');
              console.log('🗑️ Limpiando localStorage del carrito para evitar problemas futuros');
              localStorage.removeItem('cart');
              localStorage.removeItem('editingOrderId');
            }
          }, 100); // Check every 100ms

        } catch (error) {
          console.error('❌ Error cargando carrito desde localStorage:', error);
        }
      } else {
        console.log('ℹ️ No hay carrito en localStorage');
      }
    });
  </script>

  <script>
    // Helper function to open photo in new tab
    window.openPhotoInNewTab = function(photoUrl) {
      if (photoUrl) {
        window.open(photoUrl, '_blank');
      }
    };
  </script>

  <!-- CHANGELOG Modal -->
  <div id="changelogModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Changelog - Historial de Versiones</h2>
      <div id="changelogContent">
        <div class="version-section">
          <h3>v0.78 - Actual</h3>
          <ul>
            <li>✅ <strong>Fix Definitivo Nombres PRECIOS:</strong> Auto-refresh se pausa automáticamente cuando estás en tab PRECIOS</li>
            <li>🛡️ <strong>Protección Total:</strong> Los nombres de columnas personalizados nunca más se sobrescriben</li>
            <li>⏸️ <strong>Refresh Inteligente:</strong> El sistema detecta qué tab estás viendo y ajusta el comportamiento</li>
          </ul>
        </div>
        <div class="version-section">
          <h3>v0.77</h3>
          <ul>
            <li>🐛 <strong>Fix ADMISIONES Vacío:</strong> Resuelto problema donde ADMISIONES no mostraba usuarios pendientes al acceder directamente</li>
            <li>🔄 <strong>Carga Manual de Tabs:</strong> Al acceder con URL ?tab=admisiones ahora se dispara la carga de datos automáticamente</li>
            <li>✅ <strong>Todos los Tabs Afectados:</strong> Fix aplicado también a VENDEDORES, CLIENTES y MASTER para consistencia</li>
          </ul>
        </div>
        <div class="version-section">
          <h3>v0.75</h3>
          <ul>
            <li>⚡ <strong>Fix Retraso en Autenticación:</strong> Resuelto problema donde CONFIG y precios tardaban ~20 segundos en aparecer para admins</li>
            <li>💾 <strong>Caché de Estado Admin:</strong> Estado de admin se guarda en localStorage para aplicar controles instantáneamente</li>
            <li>🚀 <strong>Carga Instantánea:</strong> Controles de admin visibles desde 0.5s mientras Firebase valida en segundo plano</li>
            <li>🧹 <strong>Limpieza Automática:</strong> Caché se limpia automáticamente al hacer logout</li>
            <li>✅ <strong>UX Mejorada:</strong> No más esperas de 20 segundos - experiencia fluida para admins</li>
          </ul>
        </div>
        <div class="version-section">
          <h3>v0.74</h3>
          <ul>
            <li>🐛 <strong>Fix Crítico Carga de Productos:</strong> Resuelto problema donde productos no cargaban al iniciar sesión</li>
            <li>🔧 <strong>Listener Optimizado:</strong> Listener de tiempo real ahora ignora la primera ejecución para evitar recargas innecesarias</li>
            <li>✅ <strong>Inicialización Mejorada:</strong> Productos se cargan correctamente sin interferencias del listener de pausa</li>
          </ul>
        </div>
        <div class="version-section">
          <h3>v0.73</h3>
          <ul>
            <li>🔒 <strong>Fix Seguridad CONFIG:</strong> Menú CONFIG y submenu (PROFILE, ADMISIONES, CLIENTES, VENDEDORES) ahora restringido exclusivamente a usuarios admin</li>
            <li>🛡️ <strong>Validación Múltiple:</strong> Validación de permisos en UI y en event listeners para prevenir accesos no autorizados</li>
            <li>✅ <strong>Visibilidad Controlada:</strong> CONFIG completamente oculto para usuarios no-admin, visible solo para administradores</li>
          </ul>
        </div>
        <div class="version-section">
          <h3>v0.72</h3>
          <ul>
            <li>🔄 <strong>Sincronización en Tiempo Real:</strong> Sistema de pausa de precios ahora se sincroniza automáticamente en tiempo real entre todos los usuarios</li>
            <li>🐛 <strong>Fix Estado Corrupto PAUSAR:</strong> Resuelto problema donde usuarios admin veían precios con "x" permanentemente después de despausar</li>
            <li>🧹 <strong>Logout Mejorado:</strong> Limpieza completa de listeners y estados globales al hacer logout, previniendo estados corruptos</li>
            <li>🔧 <strong>Botón Forzar Sincronización:</strong> Nuevo botón en tab PAUSAR para resolver manualmente problemas de sincronización</li>
            <li>✅ <strong>Prevención Automática:</strong> Listener en tiempo real previene desincronización entre navegador y Firebase</li>
          </ul>
        </div>
        <div class="version-section">
          <h3>v0.71</h3>
          <ul>
            <li>💰 <strong>Fix Columnas PRECIOS:</strong> Corregido bug donde nombres de columnas cambiaban a Cantidad/Stock/Tránsito</li>
            <li>🧹 <strong>PRECIOS Limpieza:</strong> Removido botón +Artículo sin función en sección PRECIOS</li>
            <li>🛡️ <strong>Validación PRECIOS:</strong> Auto-detección y limpieza de nombres corruptos en localStorage</li>
            <li>📝 <strong>Logging Mejorado:</strong> Logs detallados para debugging de cambios en nombres de columnas</li>
            <li>🔒 <strong>Prevención de Sorting:</strong> No se permite ordenar mientras se edita un nombre de columna</li>
          </ul>
        </div>
        <div class="version-section">
          <h3>v0.70</h3>
          <ul>
            <li>✅ <strong>Fix Aprobación de Órdenes en MASTER:</strong> Corregido botón "Confirmar" en modal de número de orden manual - ahora funciona correctamente sin romper el layout</li>
            <li>🔧 <strong>Mejoras de Estabilidad:</strong> Función confirmManualOrderNumber ahora usa window.loadOrders() para recargar correctamente después de aprobar</li>
            <li>🐛 <strong>Fix Sintaxis JavaScript:</strong> Corregido error window.window.isUserAdmin en Administration.html</li>
          </ul>
        </div>
        <div class="version-section">
          <h3>v0.69</h3>
          <ul>
            <li>🌟 <strong>Tab ALL Visible:</strong> El tab "ALL" del marketplace ahora es visible en todos los dispositivos (antes oculto en móviles)</li>
            <li>⏸️ <strong>Nueva Tab PAUSAR:</strong> Admins pueden pausar/despausar precios - cuando están pausados, todos los precios se muestran como "x"</li>
            <li>⚠️ <strong>Modal de Confirmación:</strong> Al pausar precios aparece advertencia confirmando la acción</li>
            <li>✏️ <strong>Nombres de Columnas Editables:</strong> En tab PRECIOS, nombres de columnas (Precio 1, 2, 3, 4) son editables con un clic</li>
            <li>📊 <strong>Columnas con Porcentaje:</strong> Agregadas 2 columnas nuevas con cálculo automático de porcentaje sobre Precio 1</li>
            <li>🔢 <strong>Cálculo en Tiempo Real:</strong> Al cambiar Precio 1 o el porcentaje, las columnas calculadas se actualizan instantáneamente</li>
            <li>🙈 <strong>Timestamp Oculto:</strong> Mensaje "Updated" con timestamp ahora está oculto</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.68</h3>
          <ul>
            <li>🎨 <strong>Paréntesis en Totales:</strong> Valores de totales ahora se muestran entre paréntesis (ej: Stock (2,361) en lugar de Stock 2,361)</li>
            <li>📱 <strong>Órdenes Responsive:</strong> En MASTER tab, botones de órdenes ahora aparecen debajo del texto en móviles para mejor uso del espacio</li>
            <li>🔄 <strong>Auto-refresh Simplificado:</strong> Eliminado checkbox de auto-refresh UI - la funcionalidad sigue activa en segundo plano cada 90s</li>
            <li>🐛 <strong>Fix Error switchView:</strong> Corregido error "switchView is not defined" al cambiar entre tabs de marketplace</li>
            <li>🐛 <strong>Fix Error currentViewMode:</strong> Corregido error "currentViewMode is not defined" al navegar entre segmentos</li>
            <li>🏷️ <strong>Filtros de Segmentos:</strong> ACCESORIOS ahora solo muestra Apple 20W USB-C Power Adapter USA, PUREGEAR temporalmente vacío</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.67</h3>
          <ul>
            <li>✅ <strong>Fix Filtros de Columnas:</strong> Checkboxes de filtro de columnas (ej: En Orden de Compra) ahora funcionan correctamente en marketplace</li>
            <li>🔢 <strong>Formato de Números:</strong> Todas las columnas numéricas (ordenCompra, disponible, stock, etc.) ahora muestran valores formateados correctamente</li>
            <li>📊 <strong>Totales Completos:</strong> Fila de totales en marketplace ahora muestra sumas para todas las columnas numéricas, no solo stock y tránsito</li>
            <li>✅ <strong>Fix Aprobación de Órdenes:</strong> Corregido botón de aprobar en MASTER tab - ahora muestra modal para número de orden manual al aprobar desde revisión</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.66</h3>
          <ul>
            <li>📊 <strong>Dos Filas de Tabs:</strong> Primera fila con segmentos marketplace (ALL, IPHONE, MACBOOKS, SAMSUNG, ACCESORIOS, PUREGEAR), segunda fila con tabs admin (PRECIOS, MASTER)</li>
            <li>🆕 <strong>Nuevos Segmentos:</strong> Agregados tabs ACCESORIOS y PUREGEAR con filtros automáticos por keywords</li>
            <li>↔️ <strong>Tabs con Scroll:</strong> Scroll horizontal en tabs para pantallas pequeñas con scrollbar personalizada</li>
            <li>📐 <strong>Alineación de Totales:</strong> Columnas de totales alineadas correctamente con títulos en listado de productos</li>
            <li>📱 <strong>Botones Móviles:</strong> Botones de columnas móviles (+Artículo, +Stock, +Tránsito) ahora solo visibles en móviles</li>
            <li>📋 <strong>Detalle de Orden Mejorado:</strong> Tabla de items con anchos fijos, descripción con word-break, modal más ancho (1000px)</li>
            <li>🔧 <strong>Fix Botón Copiar a Oppen:</strong> Agregado botón faltante en modal de detalle de orden para admins</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.65</h3>
          <ul>
            <li>📝 <strong>Changelog Actualizado:</strong> Fix de visualización mostrando correctamente la versión actual en el changelog</li>
            <li>✨ <strong>Sincronización de Versión:</strong> Número de versión y changelog ahora totalmente sincronizados</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.64</h3>
          <ul>
            <li>⚙️ <strong>Menú CONFIG:</strong> Nuevo botón CONFIG en menú con submenú desplegable (PROFILE, ADMISIONES, CLIENTES, VENDEDORES)</li>
            <li>📋 <strong>Fila de Totales:</strong> Nueva fila arriba del listado mostrando total de productos, cantidades en carrito, stock y tránsito</li>
            <li>🔄 <strong>Actualización Dinámica:</strong> Total de cantidades se actualiza en tiempo real al agregar productos al carrito</li>
            <li>🗑️ <strong>KPIs Simplificados:</strong> Eliminados 3 KPI grandes del header (ahora integrados en fila de totales)</li>
            <li>🔔 <strong>Badge Notificaciones:</strong> Número de notificaciones movido hacia abajo de la campana para mejor visibilidad</li>
            <li>📑 <strong>Reorden Tabs:</strong> En Administration, ADMISIONES ahora es el primer tab seguido de CLIENTES y VENDEDORES</li>
            <li>⚡ <strong>Carga Mejorada:</strong> Timeouts aumentados a 300ms para mejor carga de tabs desde URL</li>
            <li>🐛 <strong>Fix serverTimestamp:</strong> Error de Firebase solucionado agregando imports faltantes</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.63</h3>
          <ul>
            <li>🔀 <strong>Migración PRECIOS/MASTER:</strong> Tabs movidos de Administration a Marketplace (solo admins)</li>
            <li>👁️ <strong>Vista de Grid:</strong> Fix completo de grid apareciendo debajo de tabla con clase .grid-hidden</li>
            <li>🎨 <strong>Estilos Mejorados:</strong> Botones de orden con colores y tamaños correctos (Listo, En Preparación, Entregada)</li>
            <li>🔧 <strong>Controles Adaptivos:</strong> Botones de vista ocultos automáticamente al mostrar tabs de admin</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.62</h3>
          <ul>
            <li>📊 <strong>Sistema Analytics:</strong> Integración completa con estadísticas detalladas de uso</li>
            <li>📈 <strong>Mejoras Estadísticas:</strong> Visualización mejorada de datos en el dashboard</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.61</h3>
          <ul>
            <li>📱 <strong>Scroll Horizontal Tabla:</strong> Tabla con scroll horizontal para evitar superposición de columnas al activar todas las opciones</li>
            <li>📏 <strong>Columna Descripción:</strong> Ancho reducido con max-width 200px y ellipsis para mejor visualización en móvil</li>
            <li>🖼️ <strong>Vistas Grid/List:</strong> Fix renderizado de productos al cambiar entre Table, Grid, List y Large Grid View</li>
            <li>🔢 <strong>Input Cantidad Compacto:</strong> Reducido a 30px de ancho con padding mínimo para ahorrar espacio</li>
            <li>🎨 <strong>Botones de Cantidad:</strong> Botón + en verde (#4CAF50) y botón - en rojo (#f44336) con hover effects</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.60</h3>
          <ul>
            <li>📋 <strong>Copiar a Oppen:</strong> Nuevo botón en detalles de orden para copiar productos en formato tabular</li>
            <li>🔢 <strong>Formato Oppen:</strong> Exporta CODIGO, DESCRIPCION, CANTIDAD, UNI y PRECIO sin $ para pegar directo</li>
            <li>📊 <strong>Columnas Configurables:</strong> Formato con espacios en blanco para completar en sistema Oppen</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.59</h3>
          <ul>
            <li>🔔 <strong>Sistema de Notificaciones:</strong> Campanita en esquina superior izquierda con badge animado</li>
            <li>👑 <strong>Notificaciones Admin:</strong> Solo administradores ven notificaciones de productos sin precio y usuarios pendientes</li>
            <li>⚠️ <strong>Productos Sin Precio:</strong> Alerta visual con borde naranja en tabla + notificación en campanita</li>
            <li>👥 <strong>Usuarios Pendientes:</strong> Notificación automática para admins cuando hay usuarios esperando aprobación</li>
            <li>🔄 <strong>Auto-actualización:</strong> Notificaciones se actualizan cada 30 segundos automáticamente</li>
            <li>✅ <strong>Validación de Órdenes:</strong> Confirmación antes de crear orden con productos sin precio asignado</li>
            <li>🔗 <strong>Redirección Inteligente:</strong> Click en notificación de usuarios pendientes abre Administration.html</li>
            <li>🎯 <strong>Scroll Automático:</strong> Click en productos sin precio hace scroll al primer producto afectado</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.58</h3>
          <ul>
            <li>🖼️ <strong>Sistema de Imágenes:</strong> Mapeo automático de productos a imágenes mediante product-images.json con 13 imágenes de productos</li>
            <li>📋 <strong>Especificaciones Técnicas:</strong> Chips compactos con emojis (año, procesador, almacenamiento) en modal y tarjetas</li>
            <li>📱 <strong>Adaptador USB-C:</strong> Imagen específica agregada (242KB) con prioridad 20 en mapeo</li>
            <li>🎨 <strong>Vistas de Productos:</strong> 4 modos (Table, List, Grid 2 cols, Large Grid 3 cols) - Split/Masonry eliminados</li>
            <li>📏 <strong>List View Mejorado:</strong> Altura aumentada desktop (140px) y móvil (150px) con imagen 110x110px</li>
            <li>🔲 <strong>Grid Columnas Fijas:</strong> Grid View = 2 columnas, Large Grid View = 3 columnas en desktop</li>
            <li>📊 <strong>Product Specs JSON:</strong> Base de datos de especificaciones técnicas para 30+ modelos (iPhone, MacBook, Samsung)</li>
            <li>✨ <strong>Modal Compacto:</strong> Especificaciones técnicas mostradas como badges debajo del nombre del producto</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.57</h3>
          <ul>
            <li>📱 <strong>Administration Responsive:</strong> Órdenes Master optimizadas para móviles con layout en columna</li>
            <li>🔘 <strong>Botones Reorganizados:</strong> Botones de acción (Preparación, Cancelar, Editar) debajo del texto en móvil</li>
            <li>📊 <strong>KPIs Ocultados Móvil:</strong> Stats-grid (Total Órdenes, Borrador, etc.) ocultos en pantallas pequeñas</li>
            <li>📏 <strong>Input Cantidad Ajustado:</strong> Ancho aumentado de 40px a 50px para mejor visualización</li>
            <li>⚖️ <strong>Precio Centrado:</strong> Columna de precio cambiada de derecha a centro</li>
            <li>🔢 <strong>Ordenamiento Numérico:</strong> Códigos de clientes ordenan correctamente (1, 2, 3 en vez de 1, 10, 100)</li>
            <li>🚫 <strong>Filtro Vendedor Interno:</strong> Email santifn.axp@gmail.com excluido de estadísticas</li>
            <li>🐛 <strong>Fix Toggle Columnas:</strong> Botones +Artículo, +Stock, +Tránsito ahora funcionan en móvil</li>
            <li>📉 <strong>KPIs Header Móvil:</strong> Productos/Stock/Tránsito ocultos en marketplace móvil para más espacio</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.56</h3>
          <ul>
            <li>📱 <strong>Diseño Responsive:</strong> Optimización completa para móviles Android e iPhone en todas las páginas</li>
            <li>📐 <strong>Media Queries:</strong> 2 breakpoints (768px tablets, 480px móviles) para mejor adaptación</li>
            <li>🔤 <strong>Tamaños de Fuente:</strong> Ajustados para legibilidad en pantallas pequeñas con mínimo 16px en inputs (previene zoom iOS)</li>
            <li>👆 <strong>Botones Táctiles:</strong> Tamaños aumentados para facilitar interacción en dispositivos móviles</li>
            <li>📊 <strong>Tablas Responsive:</strong> Columnas colapsables con botones toggle en marketplace móvil</li>
            <li>🍔 <strong>Menús Optimizados:</strong> Menú hamburguesa y modales adaptados para pantallas táctiles</li>
            <li>📧 <strong>Campo Email en Ayuda:</strong> Agregado campo de email obligatorio en formulario de soporte</li>
            <li>📈 <strong>Estadísticas Filtradas:</strong> Email cristiansan@gmail.com excluido de métricas y rankings (desarrollo)</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.55</h3>
          <ul>
            <li>🆕 <strong>Nueva Página de Ayuda:</strong> Creada ayuda.html con formulario de soporte técnico</li>
            <li>📝 <strong>Sistema de Tickets:</strong> Usuarios pueden reportar problemas con nombre, teléfono, descripción y foto adjunta</li>
            <li>📸 <strong>Subida de Fotos:</strong> Vista previa de imágenes antes de enviar, almacenadas en Firebase Storage</li>
            <li>💾 <strong>Guardado en Firebase:</strong> Tickets guardados en colección soporte_tickets con timestamp y status</li>
            <li>🤖 <strong>Chatbot Reubicado:</strong> Chatbot AI movido de marketplace.html a ayuda.html (solo visible para admins)</li>
            <li>🐛 <strong>Logs de Errores Reubicados:</strong> Visor de logs movido de Administration.html a ayuda.html (solo admins)</li>
            <li>📊 <strong>Panel Admin en Ayuda:</strong> 3 botones para admins: Chatbot AI, Estadísticas y Logs de Errores</li>
            <li>🔒 <strong>Control de Acceso:</strong> Todos los componentes admin validados con Firebase auth (solo santifn@gmail.com y cristiansan@gmail.com)</li>
            <li>🗑️ <strong>Limpieza de Código:</strong> Removido HTML, CSS y JS del chatbot de marketplace.html (~500 líneas)</li>
            <li>📋 <strong>Menú Reorganizado:</strong> Botón AYUDA movido al final del menú hamburguesa</li>
            <li>🔐 <strong>Reglas Firebase Actualizadas:</strong> Agregadas reglas para soporte_tickets (create para usuarios, read/update/delete para admins)</li>
            <li>📂 <strong>Storage Rules:</strong> Nueva carpeta /soporte/ en Storage con permisos para imágenes de tickets</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.54</h3>
          <ul>
            <li>🐛 <strong>Fix Error Precios Null:</strong> Solucionado error "Cannot read properties of null (reading 'toFixed')" en cart.html</li>
            <li>✅ <strong>Validación de Datos:</strong> Agregada validación para item.price e item.quantity antes de operaciones matemáticas</li>
            <li>🔒 <strong>Valores Por Defecto:</strong> Usa 0 como valor por defecto cuando price o quantity son null/undefined/NaN</li>
            <li>🎯 <strong>Múltiples Funciones:</strong> Correcciones aplicadas a initCart(), updateItemPrice() y confirmOrder()</li>
            <li>📊 <strong>Cálculos Seguros:</strong> Todos los cálculos de subtotales y totales ahora manejan valores nulos correctamente</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.52.3</h3>
          <ul>
            <li>💰 <strong>Edición de Precios en Modal:</strong> Ahora puedes editar precios directamente en el modal de detalles de orden</li>
            <li>👤 <strong>Cambio de Cliente en Modal:</strong> Nuevo botón "Cambiar Cliente" junto al nombre del cliente</li>
            <li>🔄 <strong>Actualización Automática:</strong> Subtotales y total se recalculan automáticamente al cambiar precio o cantidad</li>
            <li>📝 <strong>Inputs Mejorados:</strong> Precio con step 0.01 para centavos, cantidad y precio con estilo consistente</li>
            <li>💾 <strong>Guardado Inteligente:</strong> Botón "Guardar Cambios" aparece cuando hay modificaciones en precio o cantidad</li>
            <li>🎯 <strong>Event Listeners:</strong> Ambos inputs (precio y cantidad) actualizan subtotal y total dinámicamente</li>
            <li>🌐 <strong>Scope Fix:</strong> Cambiado isUserAdmin a window.isUserAdmin para acceso global</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.52.2</h3>
          <ul>
            <li>🔧 <strong>Fix Botones Master:</strong> Solucionado comportamiento errático de botones en panel Master</li>
            <li>✏️ <strong>Botones Siempre Visibles:</strong> Botón "Editar" y botones de cambio de estado ahora aparecen consistentemente</li>
            <li>🔄 <strong>Re-render Automático:</strong> Órdenes se re-renderizan automáticamente cuando se confirma usuario admin</li>
            <li>⏱️ <strong>Timing Mejorado:</strong> Aumentado delay de tab Master de 100ms a 300ms para sincronización</li>
            <li>📝 <strong>Logging de Tab:</strong> Logs muestran estado de isUserAdmin al cambiar a Master</li>
            <li>🎯 <strong>Race Condition Fix:</strong> Eliminada condición de carrera entre verificación admin y carga de órdenes</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.52.1</h3>
          <ul>
            <li>🐛 <strong>Fix Edición de Precios:</strong> Solucionado problema de edición de precios al editar órdenes desde Master</li>
            <li>📝 <strong>Logging Detallado:</strong> Agregados logs de consola para debugging de edición de precios</li>
            <li>⚡ <strong>Actualización Dinámica:</strong> Cambio de precios ahora actualiza totales sin recargar página (mantiene contexto)</li>
            <li>🔍 <strong>Debug Info:</strong> Logs muestran estado de admin, valores de precio, y event listeners</li>
            <li>✅ <strong>Mejor UX:</strong> Confirmación visual inmediata al cambiar precios</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.52</h3>
          <ul>
            <li>✏️ <strong>Edición Completa desde Master:</strong> Editar órdenes existentes con cambio de cliente y precios</li>
            <li>👤 <strong>Preservación de Cliente:</strong> Al editar orden, se carga automáticamente el cliente asignado</li>
            <li>💰 <strong>Edición de Precios:</strong> Admins pueden modificar precios de items en órdenes editadas</li>
            <li>🔄 <strong>Auto-selección:</strong> Cliente se selecciona automáticamente en dropdown al editar orden</li>
            <li>💾 <strong>Actualización Inteligente:</strong> Confirmar actualiza la orden original en lugar de crear nueva</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.51</h3>
          <ul>
            <li>🎨 <strong>Panel Cliente Mejorado:</strong> Fondo oscuro con texto blanco para mejor visibilidad</li>
            <li>🔧 <strong>Fix Visibility:</strong> Solucionado problema de texto blanco sobre fondo blanco</li>
            <li>✨ <strong>Diseño Consistente:</strong> Panel de cliente con estilo similar a otros componentes admin</li>
            <li>👁️ <strong>Contraste Mejorado:</strong> Color verde (#4CAF50) para títulos con fondo oscuro (#2a2a33)</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.50</h3>
          <ul>
            <li>💰 <strong>Edición de Precios:</strong> Admins pueden editar precios de items en el carrito</li>
            <li>👤 <strong>Cambio de Cliente:</strong> Admins pueden asignar una orden a cualquier cliente</li>
            <li>🔒 <strong>Solo Admins:</strong> Funcionalidad restringida a usuarios administradores</li>
            <li>🎨 <strong>Panel Verde de Cliente:</strong> Indicador visual del cliente seleccionado para la orden</li>
            <li>🔄 <strong>Botón Cambiar Cliente:</strong> Acceso rápido para reasignar órdenes</li>
            <li>📝 <strong>Inputs Numéricos:</strong> Campos de precio con validación y formato decimal</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.49</h3>
          <ul>
            <li>🔧 <strong>Fix Guardado de Logs:</strong> Corregida lógica que causaba guardar 0 logs</li>
            <li>🔒 <strong>Permisos Firebase:</strong> Agregadas reglas de seguridad para permitir actualización de logs por admins</li>
            <li>📝 <strong>Solo Logs Nuevos:</strong> Ahora guarda ÚNICAMENTE logs sin fecha guardada (sin sobrescribir anteriores)</li>
            <li>📋 <strong>Filtro "Actuales":</strong> Renombrado de "Todos" a "Actuales (sin guardar)" - muestra solo logs nuevos pendientes</li>
            <li>👁️ <strong>Auto-Ocultar Logs Guardados:</strong> Después de guardar, automáticamente filtra y muestra solo logs actuales</li>
            <li>📅 <strong>Acceso a Logs Guardados:</strong> Los logs guardados quedan archivados y accesibles por fecha en el filtro</li>
            <li>⚡ <strong>Independiente del Filtro:</strong> El guardado ya no depende del filtro seleccionado</li>
            <li>✅ <strong>Mensajes Mejorados:</strong> Alertas más claras indicando cuántos logs nuevos se guardarán</li>
            <li>🚫 <strong>Prevención de Duplicados:</strong> Evita sobrescribir fechas de guardado anteriores</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.48</h3>
          <ul>
            <li>📊 <strong>Estadísticas de Ventas Mejoradas:</strong> Nuevos gráficos de ventas por mes (últimos 12 meses) y por año</li>
            <li>📱 <strong>Tracking de Dispositivos:</strong> Detección automática de PC, Mac, iPhone, iPad, Android Phone/Tablet en cada login</li>
            <li>🌐 <strong>Tracking de Navegadores:</strong> Detección automática de Chrome, Safari, Firefox, Edge, Opera con versión</li>
            <li>📈 <strong>Gráficos Dispositivos/Browsers:</strong> Visualización tipo doughnut con porcentajes en estadísticas</li>
            <li>🎨 <strong>Layout Top 10 Mejorado:</strong> Vendedores y Usuarios lado a lado (responsive en móvil)</li>
            <li>💾 <strong>Datos en Firebase:</strong> Campos lastDevice, lastOS, lastBrowser, lastBrowserVersion guardados automáticamente</li>
            <li>📊 <strong>Análisis de Audiencia:</strong> Identifica qué dispositivos y navegadores prefieren tus usuarios</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.47</h3>
          <ul>
            <li>🔧 <strong>Fix crítico Timestamp:</strong> Reemplazado Timestamp.fromDate() por serverTimestamp() para evitar error "Can't find variable: Timestamp"</li>
            <li>⚡ <strong>Mejora de confiabilidad:</strong> serverTimestamp() usa el reloj del servidor Firebase (más preciso y confiable)</li>
            <li>✅ <strong>Compatibilidad universal:</strong> Solución que funciona en todos los navegadores sin importar carga de módulos</li>
            <li>💾 <strong>Guardar Logs:</strong> Nuevo botón para guardar snapshot de logs actuales con fecha del día</li>
            <li>📅 <strong>Filtro por fecha:</strong> Los logs guardados aparecen como opciones en el filtro con la fecha de guardado</li>
            <li>🎨 <strong>Mejora visual de logs:</strong> Fondo oscuro (#2a2a2a) con texto blanco para mejor legibilidad</li>
            <li>📋 <strong>Mejor contraste:</strong> Mensajes de consola y stack traces con fondo más oscuro para facilitar lectura</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.46</h3>
          <ul>
            <li>🐛 <strong>Sistema de Logging de Errores:</strong> Registro automático de todos los errores del sistema en Firebase</li>
            <li>📋 <strong>Captura de Consola:</strong> Guarda automáticamente los últimos 50 mensajes de console.log, console.error y console.warn</li>
            <li>👀 <strong>Panel de Administración:</strong> Nueva pestaña "Logs de Errores" en Administration para visualizar errores</li>
            <li>📊 <strong>Detalles Completos:</strong> Cada log incluye mensaje, fecha/hora, usuario, URL, stack trace y mensajes de consola</li>
            <li>🔍 <strong>Filtrado por Tipo:</strong> Filtros para ver errores por categoría (confirmación de orden, verificación de usuario, etc.)</li>
            <li>📥 <strong>Exportación a Excel:</strong> Descarga todos los logs en formato Excel con un click</li>
            <li>⚡ <strong>Captura Automática:</strong> Intercepta errores globales, promesas rechazadas y errores no manejados</li>
            <li>🔧 <strong>Fix Timestamp:</strong> Corregido export de Timestamp en cart.html para prevenir error "Can't find variable"</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.45</h3>
          <ul>
            <li>🔐 <strong>Registro Google mejorado:</strong> Formulario obligatorio al registrarse con Google (nombre, empresa, país, teléfono)</li>
            <li>✅ <strong>Validación de usuarios:</strong> Sistema de verificación de aprobación antes de crear órdenes</li>
            <li>🛒 <strong>Manejo de errores mejorado:</strong> Mensajes detallados y específicos según tipo de error (permisos, conexión, Firebase)</li>
            <li>📋 <strong>Cliente correcto en órdenes:</strong> Muestra nombre del cliente real en lugar del admin que creó la orden</li>
            <li>🔧 <strong>Timestamps de Firestore:</strong> Uso correcto de Timestamp.fromDate() para fechas en órdenes</li>
            <li>🐛 <strong>Validación campos null:</strong> Prevención de undefined en clienteCodigo y vendedorId</li>
            <li>📊 <strong>Priorización clienteNombre:</strong> Sistema prioriza nombre del cliente sobre emails en visualización</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.44</h3>
          <ul>
            <li>🤖 <strong>Chatbot AI Beta:</strong> Asistente virtual inteligente con búsqueda semántica de productos</li>
            <li>🎨 <strong>Diseño personalizado:</strong> Icono de robot con antenitas y etiqueta "AI"</li>
            <li>🔒 <strong>Acceso restringido:</strong> Disponible solo para usuarios autorizados (beta testing)</li>
            <li>💬 <strong>Modal interactivo:</strong> Panel flotante que no interrumpe la navegación</li>
            <li>🧠 <strong>Detección de intenciones:</strong> Entiende consultas sobre stock, precios, recomendaciones y más</li>
            <li>📊 <strong>Algoritmo de valor:</strong> Recomendaciones basadas en relación precio/calidad</li>
            <li>⚡ <strong>Cache inteligente:</strong> Sistema de caché para optimizar rendimiento</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.43</h3>
          <ul>
            <li>📸 <strong>Cámara en vivo:</strong> Acceso directo a la cámara con preview en tiempo real para captura de fotos</li>
            <li>📊 <strong>Estadísticas mejoradas:</strong> Mapeo automático de emails a nombres de clientes (cortizjctech → Trading Next Black USA)</li>
            <li>📈 <strong>LoginCount funcional:</strong> Sistema de contador de logins implementado y actualizado</li>
            <li>🔒 <strong>Permisos Firebase:</strong> Reglas agregadas para colección blockedEmails</li>
            <li>❌ <strong>Botón Cancelar:</strong> Agregado en panel de admisiones para ocultar usuarios sin modificar DB</li>
            <li>🧹 <strong>Rankings optimizados:</strong> Eliminado ranking duplicado de clientes en estadísticas</li>
            <li>👥 <strong>Filtros de usuarios:</strong> Usuarios no aprobados excluidos de rankings</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.42</h3>
          <ul>
            <li>🏢 <strong>Cliente Principal:</strong> Mejorar resolución de nombres de cliente principal</li>
            <li>🔍 <strong>Códigos Base:</strong> Extraer código base de códigos de vendedor (ej: "407_xyz" → "407")</li>
            <li>🐛 <strong>Logging Debug:</strong> Agregar logging detallado para debugging de clientes</li>
            <li>✅ <strong>Display Correcto:</strong> Mostrar cliente principal correcto en lugar de email de vendedor</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.41</h3>
          <ul>
            <li>📱 <strong>Responsive Marketplace:</strong> Optimización completa para móviles con KPIs verticales</li>
            <li>🔘 <strong>Columnas colapsables:</strong> Botones toggle (+/-) para Artículo, Stock y Tránsito en móvil</li>
            <li>📑 <strong>Tabs optimizados:</strong> Tab ALL oculto en móvil, tabs restantes al 100% ancho</li>
            <li>⚙️ <strong>Administration responsive:</strong> Botones verticales y columna Artículo con toggle en móvil</li>
            <li>👥 <strong>Admisiones móvil:</strong> Datos y filtros apilados verticalmente sin superposición</li>
            <li>🔍 <strong>Dropdown buscable:</strong> Selector de clientes con búsqueda en tiempo real en Admisiones</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.40</h3>
          <ul>
            <li>📸 <strong>Foto en Preparación:</strong> Subir foto de la orden cuando está en estado de preparación</li>
            <li>⚖️ <strong>Peso en Preparación:</strong> Agregar peso (kg) a órdenes en preparación</li>
            <li>🎯 <strong>Botones compactos:</strong> Interfaz optimizada con botones similares a Editar/Cancelar</li>
            <li>☁️ <strong>Storage Firebase:</strong> Fotos guardadas en carpeta preparacion/ de Firebase Storage</li>
            <li>📊 <strong>Metadata completa:</strong> Tracking de quién y cuándo actualizó foto/peso</li>
            <li>✅ <strong>Validación mejorada:</strong> Validación de tipo de archivo (solo imágenes) y tamaño máximo (5MB)</li>
            <li>🔄 <strong>Actualización en tiempo real:</strong> Botones muestran estado actual (✓ cuando ya hay foto/peso)</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.39</h3>
          <ul>
            <li>🚫 <strong>Ignorar y bloquear usuarios:</strong> Botón en admisiones para ignorar usuarios permanentemente</li>
            <li>📧 <strong>Bloqueo de emails:</strong> Emails bloqueados almacenados en colección blockedEmails</li>
            <li>✋ <strong>Validación en registro:</strong> Emails bloqueados no pueden crear nuevas cuentas</li>
            <li>⚠️ <strong>Confirmación requerida:</strong> Diálogo de confirmación antes de bloquear usuario</li>
            <li>🎨 <strong>UI mejorada:</strong> Botones de aprobar/ignorar alineados con mismo tamaño</li>
            <li>🔧 <strong>Fix selector clientes:</strong> Eliminados códigos duplicados (solo muestra clientes principales)</li>
            <li>🐛 <strong>Fix Storage CORS:</strong> Corregido storageBucket a firebasestorage.app + CORS configurado</li>
            <li>📱 <strong>WhatsApp mejorado:</strong> Envío de PDFs con enlace clickeable al vendedor</li>
            <li>🔧 <strong>Manejo localhost:</strong> Descarga automática de PDFs en desarrollo local</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.38</h3>
          <ul>
            <li>🚫 <strong>Ignorar y bloquear usuarios:</strong> Sistema completo de bloqueo de emails</li>
            <li>📧 <strong>Validación de bloqueos:</strong> Prevención de registros con emails bloqueados</li>
            <li>🎨 <strong>UI mejorada:</strong> Botones alineados en admisiones</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.37</h3>
          <ul>
            <li>📝 <strong>Registro ampliado:</strong> Formulario con más campos (nombre, empresa, país, celular)</li>
            <li>👤 <strong>Datos completos:</strong> Captura información completa del cliente al registrarse</li>
            <li>💾 <strong>Almacenamiento mejorado:</strong> Nuevos datos guardados en Firestore para aprobación</li>
            <li>✅ <strong>Validación completa:</strong> Todos los campos son obligatorios en el registro</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.36</h3>
          <ul>
            <li>💵 <strong>Fix formato de precio:</strong> Cambio de "$US$" a "$" en PDFs y órdenes</li>
            <li>🌍 <strong>Locale actualizado:</strong> Formato de números cambiado de 'es-AR' a 'en-US'</li>
            <li>✨ <strong>Display mejorado:</strong> Precios ahora muestran "$ 14.50" en lugar de "$US$ 14.50"</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.35</h3>
          <ul>
            <li>➖➕ <strong>Minimizar/Maximizar todas las columnas:</strong> Botones - y + en columna Acciones</li>
            <li>🎯 <strong>Workflow optimizado:</strong> Minimizar todas y luego activar solo las columnas necesarias</li>
            <li>💾 <strong>Preferencias guardadas:</strong> Estado de columnas se mantiene entre sesiones</li>
            <li>✨ <strong>UX mejorada:</strong> Control total sobre visibilidad de columnas</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.34</h3>
          <ul>
            <li>🐛 <strong>Fix ordenamiento CLIENTES:</strong> Corregido bug que impedía cambiar dirección de ordenamiento</li>
            <li>⚡ <strong>Event listeners optimizados:</strong> Configurados una sola vez para evitar duplicación</li>
            <li>✅ <strong>Toggle funcional:</strong> Click en columnas ahora alterna correctamente entre asc/desc</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.33</h3>
          <ul>
            <li>🔼 <strong>Ordenamiento en tabla CLIENTES:</strong> Columnas ordenables con clic en encabezados</li>
            <li>⬆️⬇️ <strong>Ascendente/Descendente:</strong> Toggle entre orden ascendente y descendente</li>
            <li>📊 <strong>Indicadores visuales:</strong> Flechas muestran columna activa y dirección del orden</li>
            <li>🎯 <strong>UX mejorada:</strong> Navegación más eficiente en listado de clientes</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.32</h3>
          <ul>
            <li>👁️ <strong>Vista simplificada usuarios asignados:</strong> Usuarios asignados solo muestran email en tabla CLIENTES</li>
            <li>✏️ <strong>Edición completa:</strong> Modal de edición muestra todos los datos del usuario asignado</li>
            <li>🎯 <strong>UX mejorada:</strong> Evitar duplicación de datos del cliente principal en la tabla</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.31</h3>
          <ul>
            <li>🎨 <strong>Usuarios asignados destacados:</strong> Usuarios asignados a clientes se ven con fondo verde en tabla CLIENTES</li>
            <li>📋 <strong>Info completa en órdenes:</strong> Mostrar Cliente + Código + Email en todas las vistas (SEGUIMIENTO, ADMIN, MASTER)</li>
            <li>📄 <strong>PDFs actualizados:</strong> PDFs de órdenes incluyen código del cliente principal</li>
            <li>📱 <strong>WhatsApp mejorado:</strong> Mensajes muestran cliente principal, código y email del usuario</li>
            <li>🔧 <strong>Campo clienteCodigo:</strong> Agregado a estructura de órdenes para trazabilidad</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.30</h3>
          <ul>
            <li>🏷️ <strong>Fix floating label:</strong> Label "Buscar cliente" desaparece al escribir en Administration.html</li>
            <li>✨ <strong>UX mejorada:</strong> Campo de búsqueda más intuitivo con label animado</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.29</h3>
          <ul>
            <li>🚫 <strong>SEGUIMIENTO oculto para admins:</strong> Admins no ven SEGUIMIENTO en menú (disponible en ADMIN/MASTER)</li>
            <li>🎯 <strong>UX mejorada:</strong> Menú más limpio para administradores</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.28</h3>
          <ul>
            <li>📄 <strong>PDF en edición de órdenes:</strong> Enviar PDF al modificar órdenes desde ADMIN/MASTER</li>
            <li>🔄 <strong>Mecanismo estandarizado:</strong> Mismo sistema de PDF para crear y editar órdenes</li>
            <li>📱 <strong>WhatsApp con PDF:</strong> Vendedores reciben enlace al PDF al modificar órdenes</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.27</h3>
          <ul>
            <li>📧 <strong>Email de bienvenida:</strong> Usuarios reciben email automático al ser aprobados</li>
            <li>🎨 <strong>Email personalizado:</strong> Incluye rol, cliente asignado y botón de acceso al marketplace</li>
            <li>🔒 <strong>Variables de entorno:</strong> Credenciales de email configuradas de forma segura</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.26</h3>
          <ul>
            <li>👤 <strong>Nuevo rol Cliente:</strong> Agregado rol "Cliente" en gestión de admisiones</li>
            <li>🔧 <strong>Fix dropdowns admisiones:</strong> Texto ahora visible en dropdowns (Rol, Lista, Cliente Asignado)</li>
            <li>🎨 <strong>UI profesional:</strong> Estilo gris claro para dropdowns en lugar de debug amarillo</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.25</h3>
          <ul>
            <li>🔒 <strong>Seguridad marketplace:</strong> Requiere autenticación para ver precios</li>
            <li>📱 <strong>Logo oculto en móvil:</strong> Logo South Traders oculto en dispositivos móviles</li>
            <li>⬆️ <strong>Control de estados de órdenes:</strong> Solo órdenes en Revisión pueden retroceder de estado</li>
            <li>👥 <strong>Admisiones mejoradas:</strong> Cliente obligatorio, sin rol Usuario, con selector de lista de precios</li>
            <li>📋 <strong>Clientes duplicados:</strong> Al aprobar usuario se crea registro en clientes con mismo código</li>
            <li>🎨 <strong>UI Admisiones:</strong> Labels descriptivos, mejor contraste, texto visible en selectores</li>
            <li>📄 <strong>PDF en WhatsApp:</strong> Órdenes se envían como PDF adjunto vía Firebase Storage</li>
            <li>🔧 <strong>CORS configurado:</strong> Firebase Storage permite acceso web a PDFs</li>
            <li>⏳ <strong>Loading en órdenes:</strong> Animación durante generación de PDF y envío WhatsApp</li>
            <li>📊 <strong>Columnas marketplace:</strong> Nuevo orden: Artículo, Descripción, Cantidad, Precio, Stock, Tránsito</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.24</h3>
          <ul>
            <li>👥 <strong>Sistema de aprobación de usuarios:</strong> Los admins deben aprobar nuevos registros</li>
            <li>📋 <strong>Sección ADMISIONES:</strong> Nueva sección para gestionar usuarios pendientes de aprobación</li>
            <li>🎭 <strong>Roles de usuario:</strong> Estados pending/usuario/vendedor/admin con permisos diferenciados</li>
            <li>💰 <strong>Columna LISTA en clientes:</strong> Campo para identificar lista de precios asignada</li>
            <li>📊 <strong>Historial mejorado:</strong> Admins ven todas las órdenes (100), usuarios solo las suyas (50)</li>
            <li>👑 <strong>Banner admin en historial:</strong> Indica cuando se visualiza como administrador</li>
            <li>📧 <strong>Email de usuario en órdenes:</strong> Admins ven quién creó cada orden en historial</li>
            <li>✏️ <strong>Edición de perfil para todos:</strong> Usuarios pueden editar su propio nombre, dirección y teléfono</li>
            <li>🔒 <strong>Reglas Firestore actualizadas:</strong> Permisos de auto-edición + control admin</li>
            <li>🗑️ <strong>Herramienta de limpieza:</strong> Tool local para eliminar todas las órdenes (testing)</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.23</h3>
          <ul>
            <li>📱 <strong>WhatsApp multi-teléfono:</strong> Envío automático a ambos teléfonos del vendedor (phone y phone2)</li>
            <li>📞 <strong>Segundo teléfono para vendedores:</strong> Campo phone2 agregado en datos de vendedor</li>
            <li>🔄 <strong>WhatsApp en edición de órdenes:</strong> Notificación automática al modificar órdenes existentes</li>
            <li>🔧 <strong>Fix vendedorId:</strong> Se preserva el vendedor al editar órdenes para correcto envío de WhatsApp</li>
            <li>🗑️ <strong>Limpieza automática editingOrderId:</strong> Se limpia al agregar productos nuevos al carrito</li>
            <li>⚡ <strong>Validación de órdenes:</strong> Si la orden a editar no existe, se limpia automáticamente y se crea una nueva</li>
            <li>📝 <strong>Logs detallados WhatsApp:</strong> Sistema de debugging completo para rastrear envíos</li>
            <li>🔍 <strong>Búsqueda en MASTER:</strong> Buscar órdenes por número, cliente o código con debounce (300ms)</li>
            <li>📊 <strong>Contador de resultados:</strong> Muestra cantidad de órdenes filtradas vs total</li>
            <li>❌ <strong>Botón limpiar búsqueda:</strong> Resetea el filtro y muestra todas las órdenes</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.22</h3>
          <ul>
            <li>📊 <strong>KPIs mejorados:</strong> Ocultar valores en cero para mejor visualización</li>
            <li>🎨 <strong>Interfaz optimizada:</strong> Mejor presentación de métricas</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.21</h3>
          <ul>
            <li>🛒 <strong>Cart.html mejorado:</strong> Cantidades editables directamente en el carrito</li>
            <li>✏️ <strong>Input numérico:</strong> Cambiar cantidades sin recargar página</li>
            <li>✅ <strong>Confirmación directa:</strong> Confirmar orden desde cart.html sin ir a order.html</li>
            <li>🎉 <strong>Modal de éxito:</strong> Mensaje elegante de orden confirmada con número</li>
            <li>📱 <strong>WhatsApp integrado:</strong> Notificación automática al vendedor desde cart.html</li>
            <li>🔧 <strong>Firebase sincronizado:</strong> Configuración correcta entre marketplace y cart</li>
            <li>🚫 <strong>Permisos SEGUIMIENTO:</strong> Usuarios no-admin no pueden mover órdenes</li>
            <li>👁️ <strong>Solo visualización:</strong> No-admin puede ver estados pero no modificarlos</li>
            <li>🔒 <strong>Botones ocultos:</strong> Cambio de estado y cancelación solo para admin</li>
            <li>🗑️ <strong>Historial protegido:</strong> Botón "Limpiar Historial" solo para admin</li>
            <li>⚠️ <strong>Validación doble:</strong> Función moveOrder verifica permisos antes de ejecutar</li>
            <li>🎨 <strong>Estado visual:</strong> Muestra estado actual para usuarios no-admin</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.20</h3>
          <ul>
            <li>📋 <strong>MASTER completamente rediseñado:</strong> Sección sincronizada con SEGUIMIENTO</li>
            <li>🎯 <strong>Misma estructura visual:</strong> 9 estados organizados en secciones</li>
            <li>📊 <strong>10 KPIs actualizados:</strong> Total + cada estado individual con contadores en tiempo real</li>
            <li>🔄 <strong>Botón Actualizar reubicado:</strong> Posicionado arriba de los KPIs</li>
            <li>🗑️ <strong>Función Borrar Todas las Órdenes:</strong> Botón rojo con doble confirmación</li>
            <li>⚠️ <strong>Confirmación obligatoria:</strong> Requiere escribir "BORRAR TODO"</li>
            <li>📱 <strong>Notificación WhatsApp automática:</strong> Cada orden se envía al vendedor</li>
            <li>👥 <strong>Detección de vendedor:</strong> Sistema busca el vendedor del cliente</li>
            <li>💬 <strong>Mensaje formateado:</strong> WhatsApp con detalles completos</li>
            <li>🎯 <strong>Santiago asignado a todos:</strong> 421 clientes actualizados</li>
            <li>🔧 <strong>Bug fixes:</strong> Eliminada declaración duplicada de formatNumber</li>
            <li>🐛 <strong>Correcciones JavaScript:</strong> Funciones de importación/exportación</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.19</h3>
          <ul>
            <li>🔒 <strong>Control de acceso mejorado en Administration:</strong> Usuarios no-admin pueden VER pero NO editar</li>
            <li>📋 <strong>Modo solo lectura:</strong> Campos deshabilitados para usuarios sin permisos admin</li>
            <li>🚫 <strong>Botones ocultos:</strong> "Agregar Orden" y "Guardar" no visibles para no-admin</li>
            <li>🔍 <strong>Búsqueda de clientes:</strong> Campo de búsqueda con filtro en tiempo real por 9 campos</li>
            <li>⚡ <strong>Búsqueda inteligente:</strong> Debounce de 300ms y búsqueda instantánea con Enter</li>
            <li>👥 <strong>Columna Vendedor:</strong> Asignación de vendedores a clientes desde tabla</li>
            <li>📊 <strong>Dropdown dinámico:</strong> Selector de vendedor en cada fila de cliente</li>
            <li>🎯 <strong>Santiago por defecto:</strong> Asignación automática a clientes sin vendedor</li>
            <li>💾 <strong>Actualización instantánea:</strong> Cambios de vendedor guardados en tiempo real en Firebase</li>
            <li>✅ <strong>Confirmación de orden mejorada:</strong> Nuevo mensaje personalizado de orden enviada</li>
            <li>🔧 <strong>Bug fix:</strong> Función updateButtonLabels faltante agregada en order.html</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.18</h3>
          <ul>
            <li>👥 <strong>Módulo CLIENTES completo:</strong> Gestión completa de clientes con 13 campos de información</li>
            <li>➕ <strong>Agregar/Editar clientes:</strong> Formulario completo para crear y modificar clientes</li>
            <li>📥 <strong>Importar desde Excel:</strong> Carga masiva de clientes desde archivos .xls/.xlsx</li>
            <li>📤 <strong>Exportar a Excel:</strong> Descarga del listado completo de clientes</li>
            <li>🗑️ <strong>Eliminar clientes:</strong> Opción para borrar clientes con confirmación</li>
            <li>💾 <strong>Integración Firebase:</strong> Todos los datos guardados en Firestore</li>
            <li>📋 <strong>Seguimiento de Pedidos:</strong> LOGISTICS renombrado a SEGUIMIENTO con 9 estados</li>
            <li>🔄 <strong>Flujo completo:</strong> Borrador → En revisión → Aprobada → En preparación → Listo para retiro/Despacho → Despachada → Entregada → Cerrada → Cancelada</li>
            <li>🎯 <strong>Menú optimizado:</strong> CONFIG y STATS removidos temporalmente</li>
            <li>📱 <strong>Historial compacto:</strong> Órdenes minimizadas y modal responsive</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.16</h3>
          <ul>
            <li>📸 <strong>Sistema de Confirmación Fotográfica de Entregas</strong></li>
            <li>🚚 <strong>Logistics mejorado:</strong> Nombres actualizados a "Pedido en Preparacion", "Pedido en Camino", "Pedido Entregado"</li>
            <li>📱 <strong>Captura de fotos:</strong> Opción para tomar foto desde cámara o seleccionar archivo</li>
            <li>☁️ <strong>Almacenamiento inteligente:</strong> Fotos guardadas directamente en Firestore (evita problemas CORS)</li>
            <li>🗜️ <strong>Compresión automática:</strong> Imágenes optimizadas para reducir espacio de almacenamiento</li>
            <li>👁️ <strong>Visualización de fotos:</strong> Modal para ver fotos de entrega con información detallada</li>
            <li>✅ <strong>Flujo obligatorio:</strong> Foto requerida antes de marcar pedido como entregado</li>
            <li>🎨 <strong>Interfaz optimizada:</strong> Botones de foto compactos que no interfieren con el texto</li>
            <li>📊 <strong>Múltiples pedidos:</strong> Visualización correcta de todos los pedidos entregados</li>
            <li>🔧 <strong>Compatible localhost:</strong> Sistema diseñado para funcionar en desarrollo local</li>
            <li>👤 <strong>PROFILE como primera opción de menú</strong></li>
            <li>🎨 <strong>ADMIN con colores estándar del menú</strong></li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.15</h3>
          <ul>
            <li>⚙️ <strong>Página de Administración completamente funcional</strong></li>
            <li>💰 <strong>Gestión de Precios:</strong> Listado completo de productos con 4 precios editables</li>
            <li>📤 <strong>Importar Precios:</strong> Soporte para archivos CSV y Excel (.xlsx/.xls)</li>
            <li>📥 <strong>Exportar Precios:</strong> Descarga en formato CSV y Excel con formato profesional</li>
            <li>💾 <strong>Guardado Automático:</strong> Los precios se guardan en Firebase instantáneamente</li>
            <li>📋 <strong>Gestión de Órdenes Master:</strong> Sistema completo de seguimiento de órdenes</li>
            <li>🔄 <strong>Estados de Orden:</strong> A Confirmar → En Preparación → En Camino → Entregado</li>
            <li>👥 <strong>Gestión de Vendedores:</strong> Sistema completo de alta, edición y eliminación</li>
            <li>🏢 <strong>Gestión de Clientes:</strong> Administración de clientes con asignación de vendedores</li>
            <li>🎨 <strong>Animaciones de Carga:</strong> Spinners elegantes durante procesos largos</li>
            <li>🔄 <strong>Auto-carga Inteligente:</strong> Datos se cargan automáticamente al cambiar pestañas</li>
            <li>📊 <strong>Estadísticas en Tiempo Real:</strong> Contadores automáticos por cada sección</li>
            <li>🛡️ <strong>Manejo Robusto de Errores:</strong> Validaciones y recuperación automática</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.13</h3>
          <ul>
            <li>🍔 <strong>Botón logout movido al menú hamburger</strong></li>
            <li>🔽 Logout y versión reubicados al fondo del menú hamburger</li>
            <li>📜 Número de versión ahora abre el modal de changelog al hacer clic</li>
            <li>🧹 Removido texto "Totals" de la fila de totales en listado</li>
            <li>🎨 Mejorado diseño del footer del menú con separador visual</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.12</h3>
          <ul>
            <li>🔍 <strong>Filtro de productos con stock 0 corregido</strong></li>
            <li>✅ Agregado checkbox "Hide zero values" en barra superior</li>
            <li>📋 Mostrar todos los productos por defecto (incluyendo stock 0)</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.11</h3>
          <ul>
            <li>🛒 <strong>Sistema de confirmación de órdenes implementado</strong></li>
            <li>📧 Eliminados botones de envío por WhatsApp y Email</li>
            <li>✅ Nuevo botón único "Confirmar Orden" con numeración automática</li>
            <li>🔢 Numeración de órdenes comenzando desde #10000, #10001, etc.</li>
            <li>📋 Historial mejorado con números de orden y información del usuario</li>
            <li>👤 Visualización de quién realizó cada orden en el historial</li>
            <li>🔧 Campo de cantidad editable manualmente en marketplace</li>
            <li>⌨️ Input numérico para ingresar cantidades altas (50, 100, etc.)</li>
            <li>🔄 Compatibilidad mejorada entre Firebase v10 modular y compat SDK</li>
            <li>🗑️ Funciones de limpiar y exportar historial completamente implementadas</li>
            <li>📊 Exportación a CSV con datos completos de órdenes</li>
            <li>🛡️ Manejo de errores robusto para evitar bloqueos de interfaz</li>
            <li>🎯 Flujo simplificado: confirmar → número único → historial → redirect</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.10 - Sistema de Permisos</h3>
          <ul>
            <li>🔐 <strong>Sistema de permisos de usuario implementado</strong></li>
            <li>👤 Verificación automática de permisos admin basada en Firebase</li>
            <li>🚫 Usuarios no-admin: acceso restringido a filtros de columnas</li>
            <li>✅ Usuarios no-admin: acceso permitido a HISTORIAL y LOGISTICS</li>
            <li>🎯 Sistema consistente entre index.html, marketplace.html y order.html</li>
            <li>🔧 Botón LOGISTICS agregado al menú de order.html</li>
            <li>🚚 Modal de logistics completo con 3 secciones funcionales</li>
            <li>🛡️ Manejo de errores con permisos restrictivos por seguridad</li>
            <li>📋 Logging detallado para debugging de permisos</li>
            <li>⚙️ Integración automática con onAuthStateChanged de Firebase</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.9 - Sistema Dinámico de Columnas</h3>
          <ul>
            <li>📊 <strong>Sistema completo de columnas dinámicas implementado</strong></li>
            <li>🔧 Agregadas todas las columnas de la API (15 total) con filtrado</li>
            <li>💾 Persistencia de filtros seleccionados en localStorage</li>
            <li>📈 KPIs dinámicos que se actualizan según columnas visibles</li>
            <li>🎯 Configuración específica de columnas por página (index vs marketplace)</li>
            <li>📐 Columna descripción con ancho doble (30%)</li>
            <li>🏷️ Limpieza de etiquetas KPI (removido "SUMA" y "SUMA EN")</li>
            <li>🚀 Botón Logistics agregado en marketplace (sin iconos)</li>
            <li>⚡ Optimización de compatibilidad JavaScript navegadores antiguos</li>
            <li>🔄 Sistema de mapeo robusto con fallbacks para datos API</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.8 - Menu Administrativo</h3>
          <ul>
            <li>🍔 <strong>Hamburger menu administrativo implementado</strong></li>
            <li>🔐 Sistema de permisos admin basado en Firestore</li>
            <li>⚙️ Panel de configuración con WhatsApp y Email</li>
            <li>💾 Almacenamiento automático en Firebase de configuraciones</li>
            <li>🔔 Sistema de notificaciones toast con animaciones</li>
            <li>📱 Integración automática con formulario de pedidos</li>
            <li>📞 Configuración de contacto persistente entre sesiones</li>
            <li>🚪 Función Logout mejorada y funcional</li>
            <li>📋 Auto-relleno de datos de contacto en order.html</li>
            <li>✨ Interfaz de configuración intuitiva y responsive</li>
            <li>🛠️ Debug mejorado y manejo de errores Firebase</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.7 - Sistema de Pagos Crypto</h3>
          <ul>
            <li>💰 <strong>Sistema de pago crypto implementado</strong></li>
            <li>🔗 Agregado QR code con address USDT (BSC) para pagos</li>
            <li>📝 Campo para hash de transacción con validación</li>
            <li>📋 Función de copia de address al clipboard</li>
            <li>🎯 Validación automática de formato de hash (0x + 66 chars)</li>
            <li>✅ Confirmación y almacenamiento local de transacciones</li>
            <li>🛒 Botón "Seguir Comprando" para volver al marketplace</li>
            <li>🔄 Estados visuales dinámicos en botones de pago</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.6 - Marketplace Mejorado</h3>
          <ul>
            <li>🚪 Botón Logout funcional en marketplace</li>
            <li>🔴 Valores en 0 mostrados en color rojo</li>
            <li>📊 KPIs integrados en marketplace (Total Productos, Stock, Transit)</li>
            <li>🎨 Botones Add to Cart dinámicos (blanco→rojo con cantidad)</li>
            <li>0️⃣ Quantity por defecto en 0 en lugar de 1</li>
            <li>🔧 Lógica mejorada para actualización visual de botones</li>
            <li>🎯 Estilos consistentes entre páginas</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.5</h3>
          <ul>
            <li>✅ Eliminada columna "Stock Teórico"</li>
            <li>✅ Reordenadas columnas: Disponible | En Tránsito</li>
            <li>✅ Agregado sistema de versiones con changelog</li>
            <li>🔧 Optimización de la interfaz</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.4</h3>
          <ul>
            <li>📊 Agregadas estadísticas en tiempo real</li>
            <li>🔍 Mejorado sistema de filtros por columnas</li>
            <li>📱 Optimización responsive</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.3</h3>
          <ul>
            <li>📤 Funcionalidad de exportación a Excel</li>
            <li>🔄 Auto-refresh cada 90 segundos</li>
            <li>🎨 Mejorado tema oscuro</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.2</h3>
          <ul>
            <li>🔐 Sistema de autenticación</li>
            <li>📋 Tabs de categorías (All, iPhone, MacBooks, Samsung)</li>
            <li>🔍 Búsqueda por modelo</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.1</h3>
          <ul>
            <li>🎉 Versión inicial</li>
            <li>📊 Tabla básica de inventario</li>
            <li>🌙 Interfaz con tema oscuro</li>
            <li>📱 Diseño responsive básico</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- View Mode Management Script -->
  <script>
    (function() {
      'use strict';


      // Store filtered products data for re-rendering
      window.currentFilteredProducts = [];

      // Product image mapping
      let productImageMapping = null;

      // Product specifications mapping
      let productSpecsMapping = null;

      // Global price pause state (loaded from Firebase)
      window.pricesPausedGlobal = false;
      window.pricePauseListener = null; // Store listener reference for cleanup

      // Initialize global price pause state from Firebase with real-time listener
      function initPricePauseState() {
        try {
          const { doc, onSnapshot } = firebase.firestoreHelpers;
          const db = firebase.firestore();
          const settingsRef = doc(db, 'settings', 'pricesPaused');
          let isFirstLoad = true;

          // Set up real-time listener to auto-sync pause state
          window.pricePauseListener = onSnapshot(settingsRef,
            (settingsDoc) => {
              const previousState = window.pricesPausedGlobal;

              if (settingsDoc.exists()) {
                window.pricesPausedGlobal = settingsDoc.data().paused === true;
              } else {
                window.pricesPausedGlobal = false;
              }

              console.log('📋 Global price pause state synced:', window.pricesPausedGlobal);

              // Only reload products if state actually changed (and not on first load)
              if (!isFirstLoad && previousState !== window.pricesPausedGlobal) {
                console.log('🔄 Pause state changed - reloading products automatically');
                if (window.loadProducts) {
                  window.loadProducts();
                }
              }

              isFirstLoad = false;
            },
            (error) => {
              console.error('❌ Error in price pause listener:', error);
              window.pricesPausedGlobal = false;
            }
          );

          console.log('✅ Real-time price pause listener initialized');
        } catch (error) {
          console.error('❌ Error setting up price pause listener:', error);
          window.pricesPausedGlobal = false;
        }
      }

      // Load price pause state immediately with real-time sync
      initPricePauseState();

      // Load product image mapping
      async function loadProductImageMapping() {
        try {
          const response = await fetch('product-images.json');
          productImageMapping = await response.json();
          console.log('✅ Product image mapping loaded');
        } catch (error) {
          console.error('❌ Failed to load product image mapping:', error);
          productImageMapping = { patterns: [], default: 'imagenes/default-phone.jpg' };
        }
      }

      // Load product specifications mapping
      async function loadProductSpecsMapping() {
        try {
          const response = await fetch('product-specs.json');
          productSpecsMapping = await response.json();
          console.log('✅ Product specs mapping loaded');
        } catch (error) {
          console.error('❌ Failed to load product specs mapping:', error);
          productSpecsMapping = { specs: [] };
        }
      }

      // Get image for product based on description and code
      function getProductImage(product) {
        if (!productImageMapping) {
          console.log('⚠️ Product image mapping not loaded');
          return 'imagenes/default-phone.jpg';
        }

        const searchText = `${product.description || ''} ${product.articulo || ''}`.toLowerCase();

        // Sort patterns by priority (higher first)
        const sortedPatterns = [...productImageMapping.patterns].sort((a, b) =>
          (b.priority || 0) - (a.priority || 0)
        );

        // Find first matching pattern
        for (const pattern of sortedPatterns) {
          for (const regex of pattern.regex) {
            const regexObj = new RegExp(regex, 'i');
            if (regexObj.test(searchText)) {
              console.log(`✅ Matched "${searchText}" with pattern "${regex}" -> ${pattern.image}`);
              return pattern.image;
            }
          }
        }

        console.log(`ℹ️ No match for "${searchText}", using default`);
        return productImageMapping.default || 'imagenes/default-phone.jpg';
      }

      // Get technical specifications for product
      function getProductSpecs(product) {
        if (!productSpecsMapping || !productSpecsMapping.specs) {
          return null;
        }

        const searchText = `${product.description || ''} ${product.articulo || ''}`.toLowerCase();

        // Find matching specs
        for (const spec of productSpecsMapping.specs) {
          for (const pattern of spec.patterns) {
            const regexObj = new RegExp(pattern, 'i');
            if (regexObj.test(searchText)) {
              console.log(`✅ Found specs for "${searchText}" -> ${spec.name}`);
              return spec;
            }
          }
        }

        console.log(`ℹ️ No specs found for "${searchText}"`);
        return null;
      }

      // Initialize view mode on page load
      function initViewMode() {
        // Set initial active state on buttons
        updateViewButtons();

        // Show the appropriate container
        window.switchView(currentViewMode);

        // Add event listeners to view mode buttons
        const viewButtons = document.querySelectorAll('.view-mode-btn');
        viewButtons.forEach(btn => {
          btn.addEventListener('click', function() {
            const newView = this.getAttribute('data-view');
            currentViewMode = newView;
            localStorage.setItem('viewMode', newView);
            window.switchView(newView);
            updateViewButtons();

            // Re-render products in new view by calling renderRows from main.js
            // This ensures all filters are applied correctly
            console.log('🔄 View changed to:', newView);
            if (typeof window.renderRows === 'function') {
              window.renderRows();
            } else {
              console.warn('⚠️ window.renderRows not available yet');
            }
          });
        });

        console.log('✅ View mode system initialized:', currentViewMode);
      }

      // Update active state on view buttons
      function updateViewButtons() {
        const viewButtons = document.querySelectorAll('.view-mode-btn');
        viewButtons.forEach(btn => {
          if (btn.getAttribute('data-view') === currentViewMode) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      // Switch between view containers
      function switchView(viewMode) {
        const tableContainer = document.getElementById('tableViewContainer');
        const gridContainer = document.getElementById('productsGrid');
        const mobileToggles = document.querySelector('.mobile-column-toggles');
        const container = document.querySelector('.container');

        if (viewMode === 'table') {
          // Show table, hide grid completely
          if (tableContainer) {
            tableContainer.style.display = '';
            tableContainer.classList.add('active');
          }
          if (gridContainer) {
            gridContainer.style.display = 'none';
            gridContainer.classList.remove('active');
            gridContainer.classList.add('grid-hidden'); // Add hidden class for complete hiding
            gridContainer.innerHTML = ''; // Clear grid content when switching to table
          }
          // Add class to container to indicate table view
          if (container) container.classList.add('table-view-active');
        } else {
          // Hide table, show grid
          if (tableContainer) {
            tableContainer.style.display = 'none';
            tableContainer.classList.remove('active');
          }
          if (gridContainer) {
            gridContainer.style.display = '';
            gridContainer.classList.add('active');
            gridContainer.classList.remove('grid-hidden'); // Remove hidden class
            // Apply view-specific class
            gridContainer.className = 'view-container products-grid active';
            gridContainer.classList.add(viewMode + '-view');
          }
          // Remove class from container when not in table view
          if (container) container.classList.remove('table-view-active');
        }
      }
      // Make switchView globally accessible
      window.switchView = switchView;


      // Format number for display
      function formatNumber(num) {
        if (num === null || num === undefined) return '0';
        return Number(num).toLocaleString('en-US');
      }

      // Format specs as plain text
      function formatSpecsAsText(product) {
        const specs = getProductSpecs(product);
        if (!specs) return '';

        let specsText = '';
        const specsArray = [];

        if (specs.year) specsArray.push(specs.year);
        if (specs.storage) specsArray.push(specs.storage);
        if (specs.chip) specsArray.push(specs.chip);
        if (specs.display) specsArray.push(specs.display);
        if (specs.camera) specsArray.push(specs.camera);
        if (specs.battery) specsArray.push(specs.battery);

        if (specsArray.length > 0) {
          specsText = specsArray.join(' • ');
        }

        return specsText;
      }

      // Format specs as compact HTML chips
      function formatSpecsAsChips(product) {
        const specs = getProductSpecs(product);
        if (!specs) return '';

        let specsHTML = '';

        // Year chip (highlighted)
        if (specs.year) {
          specsHTML += `<span class="tech-spec-chip highlight">📅 ${specs.year}</span>`;
        }

        // Chip/Processor
        if (specs.chip) {
          specsHTML += `<span class="tech-spec-chip">⚡ ${specs.chip}</span>`;
        }

        // Storage
        if (specs.storage) {
          specsHTML += `<span class="tech-spec-chip">💾 ${specs.storage}</span>`;
        }

        // Features (first 2 only to keep cards compact)
        if (specs.features && specs.features.length > 0) {
          const maxFeatures = 2;
          specs.features.slice(0, maxFeatures).forEach(feature => {
            specsHTML += `<span class="tech-spec-chip">${feature}</span>`;
          });
        }

        if (specsHTML) {
          return `<div class="product-tech-specs-compact">${specsHTML}</div>`;
        }

        return '';
      }

      // Create product card HTML
      function createProductCard(product, viewMode) {
        const articulo = product.articulo || '';
        const description = product.description || 'Sin descripción';
        const price = product.price;
        const stock = product.teorico || 0;
        const transito = product.transito || 0;
        const quantity = window.selectedItems ? (window.selectedItems.get(articulo)?.quantity || 0) : 0;

        // Get the appropriate image for this product
        const productImage = getProductImage(product);

        // Get specs as compact HTML chips
        const specsChips = formatSpecsAsChips(product);

        // Format price display
        let priceDisplay = '';
        const isPaused = window.pricesPausedGlobal;

        if (isPaused) {
          // Show 'x' when prices are paused GLOBALLY
          priceDisplay = '<span style="color: #888; font-size: 24px; font-weight: bold;">x</span>';
        } else if (price === null || price === undefined) {
          priceDisplay = '<span style="color: #ff9800;">?</span>';
        } else if (Number(price) === 0) {
          priceDisplay = '<span style="color: #f44336;">$' + formatNumber(price) + '</span>';
        } else {
          priceDisplay = '$' + formatNumber(price);
        }

        // Different card structures based on view mode
        if (viewMode === 'list') {
          return `
            <div class="product-card" data-item="${articulo}">
              <img src="${productImage}" alt="${description}" class="product-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div class="product-image placeholder" style="display: none;">
                <span class="material-icons">inventory_2</span>
              </div>
              <div class="product-content">
                <div class="product-main-info">
                  <div class="product-title" title="${description}">${description}</div>
                  <div class="product-code">Código: ${articulo}</div>
                  ${specsChips}
                </div>
                <div class="product-info">
                  <div class="product-info-item">
                    <span class="product-info-label">Stock</span>
                    <span class="product-info-value">${formatNumber(stock)}</span>
                  </div>
                  <div class="product-info-item">
                    <span class="product-info-label">Tránsito</span>
                    <span class="product-info-value">${formatNumber(transito)}</span>
                  </div>
                </div>
                <div class="product-price">${priceDisplay}</div>
                <div class="product-quantity-controls">
                  <button class="qty-btn-card" data-action="decrease" data-item="${articulo}">−</button>
                  <input type="number" class="qty-input-card" data-item="${articulo}" value="${quantity}" min="0" max="999">
                  <button class="qty-btn-card" data-action="increase" data-item="${articulo}">+</button>
                </div>
              </div>
            </div>
          `;
        } else {
          // Default card for grid and large-grid views
          return `
            <div class="product-card" data-item="${articulo}">
              <img src="${productImage}" alt="${description}" class="product-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div class="product-image placeholder" style="display: none;">
                <span class="material-icons">inventory_2</span>
              </div>
              <div class="product-title" title="${description}">${description}</div>
              <div class="product-code">Código: ${articulo}</div>
              ${specsChips}
              <div class="product-description">${description}</div>
              <div class="product-info">
                <div class="product-info-item">
                  <span class="product-info-label">Stock</span>
                  <span class="product-info-value">${formatNumber(stock)}</span>
                </div>
                <div class="product-info-item">
                  <span class="product-info-label">Tránsito</span>
                  <span class="product-info-value">${formatNumber(transito)}</span>
                </div>
              </div>
              <div class="product-price">${priceDisplay}</div>
              <div class="product-quantity-controls">
                <button class="qty-btn-card" data-action="decrease" data-item="${articulo}">−</button>
                <input type="number" class="qty-input-card" data-item="${articulo}" value="${quantity}" min="0" max="999">
                <button class="qty-btn-card" data-action="increase" data-item="${articulo}">+</button>
              </div>
            </div>
          `;
        }
      }

      // Render products in the current view
      function renderProductsInCurrentView(products) {
        const gridContainer = document.getElementById('productsGrid');

        if (currentViewMode === 'table') {
          // Table view is handled by main.js
          // Make sure grid is completely hidden and cleared
          if (gridContainer) {
            gridContainer.style.display = 'none';
            gridContainer.innerHTML = ''; // Clear grid content
            gridContainer.classList.remove('active');
            gridContainer.classList.add('grid-hidden'); // Add hidden class
          }
          return;
        }

        if (!gridContainer) return;

        // Make sure grid is visible for non-table views
        gridContainer.style.display = '';
        gridContainer.classList.add('active');
        gridContainer.classList.remove('grid-hidden'); // Remove hidden class

        // Clear existing content
        gridContainer.innerHTML = '';

        // Store products for later use
        window.currentFilteredProducts = products;

        // Render products as cards
        products.forEach(product => {
          const cardHTML = createProductCard(product, currentViewMode);
          gridContainer.insertAdjacentHTML('beforeend', cardHTML);
        });

        // Attach event listeners to quantity controls
        attachQuantityEventListeners();

        console.log(`✅ Rendered ${products.length} products in ${currentViewMode} view`);
      }

      // Attach event listeners to quantity control buttons
      function attachQuantityEventListeners() {
        const gridContainer = document.getElementById('productsGrid');
        if (!gridContainer) return;

        // Quantity buttons
        gridContainer.querySelectorAll('.qty-btn-card').forEach(btn => {
          btn.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            const itemId = this.getAttribute('data-item');
            const input = gridContainer.querySelector(`.qty-input-card[data-item="${itemId}"]`);

            if (input) {
              let currentValue = parseInt(input.value) || 0;

              if (action === 'increase') {
                currentValue = Math.min(999, currentValue + 1);
              } else if (action === 'decrease') {
                currentValue = Math.max(0, currentValue - 1);
              }

              input.value = currentValue;
              updateSelectedItems(itemId, currentValue);
            }
          });
        });

        // Quantity inputs
        gridContainer.querySelectorAll('.qty-input-card').forEach(input => {
          input.addEventListener('input', function() {
            const itemId = this.getAttribute('data-item');
            let value = parseInt(this.value) || 0;
            value = Math.max(0, Math.min(999, value));
            this.value = value;
            updateSelectedItems(itemId, value);
          });

          input.addEventListener('change', function() {
            const itemId = this.getAttribute('data-item');
            let value = parseInt(this.value) || 0;
            value = Math.max(0, Math.min(999, value));
            this.value = value;
            updateSelectedItems(itemId, value);
          });
        });

        // Product images - click to open detail modal
        gridContainer.querySelectorAll('.product-image').forEach(img => {
          img.style.cursor = 'pointer';
          img.addEventListener('click', function() {
            const productCard = this.closest('.product-card');
            if (productCard) {
              const itemId = productCard.getAttribute('data-item');
              const product = window.currentFilteredProducts.find(p => p.articulo === itemId);
              if (product) {
                openProductDetailModal(product);
              }
            }
          });
        });
      }

      // Update selected items in the global cart
      function updateSelectedItems(itemId, quantity) {
        if (!window.selectedItems || !window.mappedStockData) return;

        const product = window.mappedStockData.find(p => p.articulo === itemId);
        if (!product) return;

        if (quantity > 0) {
          window.selectedItems.set(itemId, { product, quantity });
        } else {
          window.selectedItems.delete(itemId);
        }

        console.log(`Updated cart: ${itemId} = ${quantity}`);

        // Actualizar totales en la tabla si existe la función
        if (typeof window.updateTotalsRow === 'function') {
          window.updateTotalsRow();
        }
      }

      // ========================================
      // PRODUCT DETAIL MODAL FUNCTIONALITY
      // ========================================

      let currentModalProduct = null;

      // Open product detail modal
      function openProductDetailModal(product) {
        currentModalProduct = product;
        const modal = document.getElementById('productDetailModal');

        if (!modal || !product) return;

        // Populate modal with product data
        const productImage = getProductImage(product);
        const articulo = product.articulo || '';
        const description = product.description || 'Sin descripción';
        const price = product.price;
        const stock = product.teorico || 0;
        const transito = product.transito || 0;
        const total = stock + transito;
        const currentQuantity = window.selectedItems ? (window.selectedItems.get(articulo)?.quantity || 0) : 0;

        // Update image
        const imageContainer = document.getElementById('modalProductImageContainer');
        imageContainer.innerHTML = `
          <img src="${productImage}" alt="${description}"
               onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <span class="material-icons placeholder" style="display: none;">inventory_2</span>
        `;

        // Update text content
        document.getElementById('modalProductTitle').textContent = description;
        document.getElementById('modalProductCode').textContent = `Código: ${articulo}`;

        // Update price
        const priceElement = document.getElementById('modalProductPrice');
        const isPaused = window.pricesPausedGlobal;

        if (isPaused) {
          // Show 'x' when prices are paused GLOBALLY
          priceElement.innerHTML = '<span style="color: #888; font-size: 48px; font-weight: bold;">x</span>';
        } else if (price === null || price === undefined) {
          priceElement.innerHTML = '<span style="color: #ff9800;">Precio no disponible</span>';
        } else if (Number(price) === 0) {
          priceElement.innerHTML = '<span style="color: #f44336;">$' + formatNumber(price) + '</span>';
        } else {
          priceElement.textContent = '$' + formatNumber(price);
          priceElement.style.color = '#4CAF50';
        }

        // Update specs
        const stockElement = document.getElementById('modalProductStock');
        stockElement.textContent = formatNumber(stock);
        stockElement.className = 'product-detail-spec-value ' + (stock > 0 ? 'positive' : 'zero');

        const transitElement = document.getElementById('modalProductTransit');
        transitElement.textContent = formatNumber(transito);
        transitElement.className = 'product-detail-spec-value ' + (transito > 0 ? 'positive' : 'zero');

        const totalElement = document.getElementById('modalProductTotal');
        totalElement.textContent = formatNumber(total);
        totalElement.className = 'product-detail-spec-value ' + (total > 0 ? 'positive' : 'zero');

        // Update quantity
        document.getElementById('modalQuantity').value = currentQuantity;

        // Get and display technical specifications in compact format
        const specs = getProductSpecs(product);
        const techSpecsCompact = document.getElementById('modalTechSpecsCompact');

        if (specs && techSpecsCompact) {
          // Build compact specs HTML as chips
          let specsHTML = '';

          // Year chip (highlighted)
          if (specs.year) {
            specsHTML += `<span class="tech-spec-chip highlight">📅 ${specs.year}</span>`;
          }

          // Chip/Processor
          if (specs.chip) {
            specsHTML += `<span class="tech-spec-chip">⚡ ${specs.chip}</span>`;
          }

          // Storage
          if (specs.storage) {
            specsHTML += `<span class="tech-spec-chip">💾 ${specs.storage}</span>`;
          }

          // Display
          if (specs.display) {
            specsHTML += `<span class="tech-spec-chip">📱 ${specs.display}</span>`;
          }

          // Camera
          if (specs.camera) {
            specsHTML += `<span class="tech-spec-chip">📷 ${specs.camera}</span>`;
          }

          // Battery
          if (specs.battery) {
            specsHTML += `<span class="tech-spec-chip">🔋 ${specs.battery}</span>`;
          }

          // Features (first 3 only to keep it compact)
          if (specs.features && specs.features.length > 0) {
            const maxFeatures = 3;
            specs.features.slice(0, maxFeatures).forEach(feature => {
              specsHTML += `<span class="tech-spec-chip">${feature}</span>`;
            });
            if (specs.features.length > maxFeatures) {
              specsHTML += `<span class="tech-spec-chip">+${specs.features.length - maxFeatures} más</span>`;
            }
          }

          techSpecsCompact.innerHTML = specsHTML;
          techSpecsCompact.style.display = 'flex';
        } else {
          if (techSpecsCompact) {
            techSpecsCompact.style.display = 'none';
          }
        }

        // Show modal
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scroll
      }

      // Close product detail modal
      function closeProductDetailModal() {
        const modal = document.getElementById('productDetailModal');
        if (modal) {
          modal.classList.remove('active');
          document.body.style.overflow = ''; // Restore scroll
          currentModalProduct = null;
        }
      }

      // Initialize modal event listeners
      function initModalEventListeners() {
        const modal = document.getElementById('productDetailModal');
        const closeBtn = document.getElementById('closeProductDetail');
        const decreaseBtn = document.getElementById('modalDecreaseQty');
        const increaseBtn = document.getElementById('modalIncreaseQty');
        const quantityInput = document.getElementById('modalQuantity');
        const addToCartBtn = document.getElementById('modalAddToCart');

        // Close button
        if (closeBtn) {
          closeBtn.addEventListener('click', closeProductDetailModal);
        }

        // Click outside to close
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeProductDetailModal();
            }
          });
        }

        // Escape key to close
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && modal && modal.classList.contains('active')) {
            closeProductDetailModal();
          }
        });

        // Quantity controls
        if (decreaseBtn) {
          decreaseBtn.addEventListener('click', () => {
            const input = document.getElementById('modalQuantity');
            if (input) {
              let value = parseInt(input.value) || 0;
              value = Math.max(0, value - 1);
              input.value = value;
            }
          });
        }

        if (increaseBtn) {
          increaseBtn.addEventListener('click', () => {
            const input = document.getElementById('modalQuantity');
            if (input) {
              let value = parseInt(input.value) || 0;
              value = Math.min(999, value + 1);
              input.value = value;
            }
          });
        }

        if (quantityInput) {
          quantityInput.addEventListener('input', (e) => {
            let value = parseInt(e.target.value) || 0;
            value = Math.max(0, Math.min(999, value));
            e.target.value = value;
          });
        }

        // Add to cart button
        if (addToCartBtn) {
          addToCartBtn.addEventListener('click', () => {
            if (!currentModalProduct) return;

            const quantity = parseInt(document.getElementById('modalQuantity').value) || 0;
            const articulo = currentModalProduct.articulo;

            // Update cart
            updateSelectedItems(articulo, quantity);

            // Update all quantity inputs in card views
            const cardInputs = document.querySelectorAll(`.qty-input-card[data-item="${articulo}"]`);
            cardInputs.forEach(input => {
              input.value = quantity;
            });

            // Show feedback
            addToCartBtn.innerHTML = '<span class="material-icons">check_circle</span> Agregado!';
            setTimeout(() => {
              addToCartBtn.innerHTML = '<span class="material-icons">shopping_cart</span> Agregar al Carrito';
            }, 1500);

            console.log(`✅ Added ${quantity} of ${articulo} to cart`);
          });
        }
      }

      // Expose functions globally so main.js can call them
      window.renderProductsInCurrentView = renderProductsInCurrentView;
      window.getCurrentViewMode = function() { return currentViewMode; };

      // Initialize when DOM is ready
      async function init() {
        await Promise.all([
          loadProductImageMapping(),
          loadProductSpecsMapping()
        ]);
        initViewMode();
        initModalEventListeners();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();

    // ========================================
    // NOTIFICATIONS SYSTEM
    // ========================================
    (function() {
      const notificationsBell = document.getElementById('notificationsBell');
      const notificationsBadge = document.getElementById('notificationsBadge');
      const notificationsDropdown = document.getElementById('notificationsDropdown');
      const notificationsClose = document.getElementById('notificationsClose');
      const notificationsList = document.getElementById('notificationsList');

      let notifications = [];

      // Wait for Firebase to be initialized
      function waitForFirebase() {
        return new Promise((resolve) => {
          const checkFirebase = setInterval(() => {
            if (window.firebaseAuth && window.firebaseDb) {
              clearInterval(checkFirebase);
              resolve();
            }
          }, 100);
        });
      }

      // Toggle dropdown
      function toggleNotifications() {
        const isVisible = notificationsDropdown.style.display === 'block';
        notificationsDropdown.style.display = isVisible ? 'none' : 'block';
      }

      // Close dropdown
      function closeNotifications() {
        notificationsDropdown.style.display = 'none';
      }

      // Update notifications
      async function updateNotifications() {
        notifications = [];

        // Wait for Firebase to be initialized
        if (!window.firebaseAuth || !window.firebaseDb) {
          console.log('⏳ Esperando Firebase...');
          await waitForFirebase();
        }

        const auth = window.firebaseAuth;
        const db = window.firebaseDb;

        // Check if user is authenticated
        const user = auth.currentUser;
        if (!user) {
          console.log('ℹ️ No hay usuario autenticado');
          notificationsBadge.style.display = 'none';
          renderNotifications();
          return;
        }

        // Use the global isUserAdmin variable that was already set by checkUserPermissions()
        const isAdmin = window.isUserAdmin;
        console.log('👑 Usuario es admin:', isAdmin, 'Email:', user.email);

        // Only show notifications for admins
        if (!isAdmin) {
          console.log('ℹ️ Usuario no es admin, no se muestran notificaciones');
          // Update badge (hide it)
          notificationsBadge.style.display = 'none';
          renderNotifications();
          return;
        }

        console.log('✅ Usuario es admin, verificando notificaciones...');

        // Check for products without price (only for admins)
        if (window.mappedStockData && window.mappedStockData.length > 0) {
          const productsWithoutPrice = window.mappedStockData.filter(product =>
            product.price === null || product.price === undefined || Number(product.price) === 0
          );

          if (productsWithoutPrice.length > 0) {
            notifications.push({
              type: 'warning',
              icon: 'warning',
              title: 'Productos sin precio',
              message: `${productsWithoutPrice.length} producto(s) no tienen precio asignado`,
              count: productsWithoutPrice.length,
              data: productsWithoutPrice,
              action: 'products-without-price'
            });
            console.log(`⚠️ ${productsWithoutPrice.length} productos sin precio detectados`);
          }
        }

        // Check for pending users (only for admins)
        try {
          // Use Firebase helpers to query usuarios (Spanish collection name)
          const usersRef = window.firebase.firestoreHelpers.collection(db, 'usuarios');
          const querySnapshot = await window.firebase.firestoreHelpers.getDocs(usersRef);

          // Filter on client side to exclude cancelled reviews
          const pendingUsersDocs = [];
          querySnapshot.forEach((doc) => {
            const user = doc.data();
            const isCancelledReview = user.reviewCancelled === true;
            const isPending = user.approved === false || user.role === 'pending';

            if (!isCancelledReview && isPending) {
              pendingUsersDocs.push(doc);
            }
          });

          const pendingUsersCount = pendingUsersDocs.length;

          console.log(`👥 Usuarios pendientes encontrados: ${pendingUsersCount}`);

          if (pendingUsersCount > 0) {
            notifications.push({
              type: 'info',
              icon: 'person_add',
              title: 'Usuarios pendientes de aprobación',
              message: `${pendingUsersCount} usuario(s) esperando admisión`,
              count: pendingUsersCount,
              data: pendingUsersDocs,
              action: 'pending-users'
            });
            console.log(`🔔 Notificación de usuarios pendientes agregada`);
          }
        } catch (error) {
          console.error('❌ Error al verificar usuarios pendientes:', error);
          console.error('Detalles del error:', error.message, error.code);
        }

        // Update badge
        const totalNotifications = notifications.length;
        if (totalNotifications > 0) {
          notificationsBadge.textContent = totalNotifications;
          notificationsBadge.style.display = 'block';
        } else {
          notificationsBadge.style.display = 'none';
        }

        // Render notifications
        renderNotifications();
      }

      // Render notifications list
      function renderNotifications() {
        if (notifications.length === 0) {
          notificationsList.innerHTML = '<div class="notification-empty">No hay notificaciones</div>';
          return;
        }

        let html = '';
        notifications.forEach(notification => {
          html += `
            <div class="notification-item ${notification.type}" onclick="handleNotificationClick('${notification.action}')">
              <div class="notification-item-header">
                <span class="material-icons notification-item-icon">${notification.icon}</span>
                <div class="notification-item-content">
                  <div class="notification-item-title">
                    ${notification.title}
                    <span class="notification-item-count">${notification.count}</span>
                  </div>
                  <div class="notification-item-message">${notification.message}</div>
                </div>
              </div>
            </div>
          `;
        });

        notificationsList.innerHTML = html;
      }

      // Handle notification click
      window.handleNotificationClick = function(action) {
        if (action === 'products-without-price') {
          // Scroll to first product without price in table
          const firstRowWithoutPrice = document.querySelector('.no-price-warning');
          if (firstRowWithoutPrice) {
            firstRowWithoutPrice.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Highlight briefly
            firstRowWithoutPrice.style.background = 'rgba(255, 152, 0, 0.2)';
            setTimeout(() => {
              firstRowWithoutPrice.style.background = '';
            }, 2000);
          }
        } else if (action === 'pending-users') {
          // Redirect to Administration page with admisiones tab active
          console.log('🔄 Redirigiendo a Administration.html (Admisiones) para revisar usuarios pendientes...');
          window.location.href = 'Administration.html?tab=admisiones';
        }
        closeNotifications();
      };

      // Event listeners
      if (notificationsBell) {
        notificationsBell.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleNotifications();
        });
      }

      if (notificationsClose) {
        notificationsClose.addEventListener('click', closeNotifications);
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!notificationsBell?.contains(e.target) && !notificationsDropdown?.contains(e.target)) {
          closeNotifications();
        }
      });

      // Update notifications when stock data changes
      function initNotifications() {
        // Wait for stock data to be loaded
        const checkStockData = setInterval(() => {
          if (window.mappedStockData && window.mappedStockData.length > 0) {
            clearInterval(checkStockData);
            updateNotifications();
            console.log('🔔 Notifications system initialized');

            // Update notifications every 30 seconds for pending users
            setInterval(() => {
              updateNotifications();
              console.log('🔄 Notificaciones actualizadas automáticamente');
            }, 30000); // 30 seconds
          }
        }, 500);

        // Also update when table is re-rendered
        const originalRenderTable = window.renderTable;
        if (originalRenderTable) {
          window.renderTable = function(...args) {
            const result = originalRenderTable.apply(this, args);
            updateNotifications();
            return result;
          };
        }
      }

      // Initialize
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNotifications);
      } else {
        initNotifications();
      }
    })();
  </script>

  <!-- Admin Tabs JavaScript (PRECIOS and MASTER) - Moved from Administration.html -->
  <script>
    // Note: All the functions from Administration.html are already available globally
    // as they are defined in the same scope. The tab switching logic above will call
    // window.loadProducts() and window.loadOrders() when admin tabs are activated.

    // Setup event listeners for PRECIOS tab buttons
    document.addEventListener('DOMContentLoaded', () => {
      // PRECIOS tab event listeners
      const importPricesBtn = document.getElementById('importPricesBtn');
      if (importPricesBtn) {
        importPricesBtn.addEventListener('click', () => {
          if (window.importPrices) {
            window.importPrices();
          }
        });
      }

      const exportCsvBtn = document.getElementById('exportCsvBtn');
      if (exportCsvBtn) {
        exportCsvBtn.addEventListener('click', () => {
          if (window.exportPricesToCSV) {
            window.exportPricesToCSV();
          }
        });
      }

      const exportExcelBtn = document.getElementById('exportExcelBtn');
      if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', () => {
          if (window.exportPricesToExcel) {
            window.exportPricesToExcel();
          }
        });
      }

      const saveAllPricesBtn = document.getElementById('saveAllPricesBtn');
      if (saveAllPricesBtn) {
        saveAllPricesBtn.addEventListener('click', () => {
          if (window.saveAllPrices) {
            window.saveAllPrices();
          }
        });
      }

      const loadProductsBtn = document.getElementById('loadProductsBtn');
      if (loadProductsBtn) {
        loadProductsBtn.addEventListener('click', () => {
          if (window.loadProducts) {
            window.loadProducts();
          }
        });
      }

      const pricesFileInput = document.getElementById('pricesFileInput');
      if (pricesFileInput) {
        pricesFileInput.addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (file && window.processPriceFile) {
            window.processPriceFile(file);
          }
          // Reset file input so the same file can be selected again
          event.target.value = '';
        });
      }

      // MASTER tab event listeners
      const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
      if (refreshOrdersBtn) {
        refreshOrdersBtn.addEventListener('click', () => {
          if (window.loadOrders) {
            window.loadOrders();
          }
        });
      }

      const exportOrdersBtn = document.getElementById('exportOrdersBtn');
      if (exportOrdersBtn) {
        exportOrdersBtn.addEventListener('click', () => {
          if (window.exportOrders) {
            window.exportOrders();
          }
        });
      }

      const orderSearchInput = document.getElementById('orderSearchInput');
      const clearSearchBtn = document.getElementById('clearSearchBtn');

      if (orderSearchInput) {
        orderSearchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.trim();
          if (clearSearchBtn) {
            clearSearchBtn.style.display = searchTerm ? 'inline-flex' : 'none';
          }
          if (window.displayOrders) {
            window.displayOrders(searchTerm);
          }
        });
      }

      if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', () => {
          if (orderSearchInput) {
            orderSearchInput.value = '';
            clearSearchBtn.style.display = 'none';
          }
          if (window.displayOrders) {
            window.displayOrders('');
          }
        });
      }

      console.log('✅ Admin tabs event listeners initialized');

    // === COPIED FUNCTIONS FROM ADMINISTRATION.HTML ===
    // PRECIOS and MASTER tabs functions

    let priceTableSort = {
      column: 'articulo',
      direction: 'asc'
    };

    // Price column names configuration (editable by admins)
    // Lista de nombres inválidos que NO se pueden usar
    const INVALID_COLUMN_NAMES = ['Cantidad', 'Precio', 'Stock', 'Tránsito', 'Transito', 'Articulo', 'Artículo', 'Descripción', 'Descripcion'];

    // Usar un objeto básico protegido con Object.seal
    const _rawInternalNames = {
      precio1: 'Precio 1',
      precio2: 'Precio 2',
      precio3: 'Precio 3',
      precio4: 'Precio 4',
      precio5: '% Col5',
      precio6: '% Col6'
    };

    // Crear un Proxy para el objeto interno también
    let _internalPriceColumnNames = new Proxy(_rawInternalNames, {
      set(target, prop, value) {
        console.log('🔍 INTENTO DE MODIFICAR _internalPriceColumnNames:', {
          propiedad: prop,
          valorAnterior: target[prop],
          valorNuevo: value,
          stackTrace: new Error().stack
        });

        // Validar que el nombre no sea inválido
        if (INVALID_COLUMN_NAMES.includes(value)) {
          console.error('❌ BLOQUEADO EN _internal - Nombre inválido:', value);
          return false;
        }

        // Validar que la propiedad sea válida
        if (!['precio1', 'precio2', 'precio3', 'precio4', 'precio5', 'precio6'].includes(prop)) {
          console.error('❌ BLOQUEADO EN _internal - Propiedad inválida:', prop);
          return false;
        }

        console.log('✅ Modificación autorizada en _internal:', prop, '=', value);
        target[prop] = value;
        return true;
      },
      get(target, prop) {
        const value = target[prop];

        // También proteger en el nivel interno
        if (INVALID_COLUMN_NAMES.includes(value)) {
          console.error('❌ VALOR CORRUPTO EN _internal GET:', {
            propiedad: prop,
            valorCorrupto: value
          });

          const defaults = {
            precio1: 'Precio 1',
            precio2: 'Precio 2',
            precio3: 'Precio 3',
            precio4: 'Precio 4',
            precio5: '% Col5',
            precio6: '% Col6'
          };

          target[prop] = defaults[prop] || `Precio ${prop.replace('precio', '')}`;
          return target[prop];
        }

        return value;
      }
    });

    // Crear un Proxy para priceColumnNames que usa _internalPriceColumnNames
    let priceColumnNames = new Proxy(_internalPriceColumnNames, {
      set(target, prop, value) {
        console.log('🔍 INTENTO DE MODIFICAR priceColumnNames (Proxy público):', {
          propiedad: prop,
          valorAnterior: target[prop],
          valorNuevo: value,
          stackTrace: new Error().stack
        });

        // Validar que el nombre no sea inválido
        if (INVALID_COLUMN_NAMES.includes(value)) {
          console.error('❌ INTENTO DE MODIFICACIÓN BLOQUEADO - Nombre inválido:', {
            propiedad: prop,
            valorInvalido: value,
            stackTrace: new Error().stack
          });
          alert(`⚠️ MODIFICACIÓN BLOQUEADA: Se intentó cambiar "${prop}" a "${value}", que es un nombre reservado del marketplace.`);
          return false; // Rechazar la modificación
        }

        // Validar que la propiedad sea una de las columnas válidas
        if (!['precio1', 'precio2', 'precio3', 'precio4', 'precio5', 'precio6'].includes(prop)) {
          console.error('❌ Intento de modificar propiedad inválida:', prop);
          return false;
        }

        console.log('✅ Modificación autorizada de priceColumnNames:', prop, '=', value);
        target[prop] = value;
        return true;
      },
      get(target, prop) {
        const value = target[prop];

        // ÚLTIMA LÍNEA DE DEFENSA: Si alguien logró corromper el valor, retornar default
        if (INVALID_COLUMN_NAMES.includes(value)) {
          console.error('❌ VALOR CORRUPTO DETECTADO EN GET:', {
            propiedad: prop,
            valorCorrupto: value,
            stackTrace: new Error().stack
          });

          // Retornar valor por defecto según la columna
          const defaults = {
            precio1: 'Precio 1',
            precio2: 'Precio 2',
            precio3: 'Precio 3',
            precio4: 'Precio 4',
            precio5: '% Col5',
            precio6: '% Col6'
          };

          // Restaurar el valor corrupto inmediatamente
          target[prop] = defaults[prop] || `Precio ${prop.replace('precio', '')}`;
          console.log('✅ Valor restaurado automáticamente:', prop, '=', target[prop]);

          // Limpiar localStorage corrupto
          localStorage.removeItem('priceColumnNames');

          return target[prop];
        }

        return value;
      }
    });

    // Congelar las claves para prevenir que se agreguen o eliminen propiedades
    Object.seal(_rawInternalNames);

    // Price column percentages for calculated columns
    let priceColumnPercents = {
      precio5: 0,
      precio6: 0
    };

    // Load column names from localStorage
    function loadPriceColumnNames() {
      console.log('🔄 loadPriceColumnNames() called - INICIO');
      console.log('📋 Estado actual de _internalPriceColumnNames ANTES de cargar:', JSON.stringify(_rawInternalNames));

      const saved = localStorage.getItem('priceColumnNames');
      console.log('📋 Raw localStorage value:', saved);

      if (saved) {
        try {
          const loadedNames = JSON.parse(saved);
          console.log('📋 Intentando cargar desde localStorage:', loadedNames);

          // PRIMERO: Validar TODO antes de aplicar NADA
          let hasInvalidValues = false;
          const validKeys = ['precio1', 'precio2', 'precio3', 'precio4', 'precio5', 'precio6'];

          for (const key in loadedNames) {
            const value = loadedNames[key];
            console.log(`🔍 Validando ${key}: "${value}"`);

            // Validar que la key sea válida
            if (!validKeys.includes(key)) {
              console.error('❌ ¡KEY INVÁLIDA EN LOCALSTORAGE!', { invalidKey: key });
              hasInvalidValues = true;
            }

            // Validar que el valor no sea inválido
            if (INVALID_COLUMN_NAMES.includes(value)) {
              console.error('❌ ¡VALOR INVÁLIDO DETECTADO EN LOCALSTORAGE!', {
                key: key,
                invalidValue: value
              });
              hasInvalidValues = true;
            }
          }

          // Si hay valores inválidos, limpiar TODO y restaurar defaults
          if (hasInvalidValues) {
            console.error('⚠️ Se detectaron valores inválidos en localStorage. Limpiando localStorage y restaurando defaults...');
            localStorage.removeItem('priceColumnNames');

            // Restaurar TODOS los valores a los defaults
            _internalPriceColumnNames.precio1 = 'Precio 1';
            _internalPriceColumnNames.precio2 = 'Precio 2';
            _internalPriceColumnNames.precio3 = 'Precio 3';
            _internalPriceColumnNames.precio4 = 'Precio 4';
            _internalPriceColumnNames.precio5 = '% Col5';
            _internalPriceColumnNames.precio6 = '% Col6';

            console.log('✅ localStorage limpiado y valores restaurados a defaults');
          } else {
            // Solo si TODO es válido, aplicar los valores
            for (const key in loadedNames) {
              if (validKeys.includes(key)) {
                console.log(`✅ Asignando ${key} = "${loadedNames[key]}"`);
                _internalPriceColumnNames[key] = loadedNames[key];
              }
            }
          }

          console.log('📋 Estado FINAL de _internalPriceColumnNames después de cargar:', JSON.stringify(_rawInternalNames));
        } catch (e) {
          console.error('❌ Error parsing localStorage:', e);
        }
      } else {
        console.log('📋 No saved price column names found, usando defaults');
      }

      const savedPercents = localStorage.getItem('priceColumnPercents');
      if (savedPercents) {
        try {
          priceColumnPercents = { ...priceColumnPercents, ...JSON.parse(savedPercents) };
        } catch (e) {
          console.error('Error loading price column percents:', e);
        }
      }

      console.log('🔄 loadPriceColumnNames() - FIN');
    }

    // Save column names to localStorage
    function savePriceColumnNames() {
      console.log('💾 Saving priceColumnNames to localStorage:', _internalPriceColumnNames);

      // Validar que no se estén guardando nombres inválidos
      for (const key in _internalPriceColumnNames) {
        if (INVALID_COLUMN_NAMES.includes(_internalPriceColumnNames[key])) {
          console.error('❌ ¡INTENTO DE GUARDAR NOMBRE INVÁLIDO DETECTADO!', {
            key: key,
            invalidValue: _internalPriceColumnNames[key],
            stackTrace: new Error().stack
          });
          // NO guardar si hay valores inválidos
          return;
        }
      }

      localStorage.setItem('priceColumnNames', JSON.stringify(_internalPriceColumnNames));
    }

    // Save column percents to localStorage
    function savePriceColumnPercents() {
      localStorage.setItem('priceColumnPercents', JSON.stringify(priceColumnPercents));
    }

    // Validate and clean corrupted localStorage values
    function validatePriceColumnNames() {
      let hasInvalidNames = false;

      for (const key in _internalPriceColumnNames) {
        if (INVALID_COLUMN_NAMES.includes(_internalPriceColumnNames[key])) {
          console.warn(`⚠️ Detected invalid column name "${_internalPriceColumnNames[key]}" for ${key}, resetting to default`);
          hasInvalidNames = true;
        }
      }

      if (hasInvalidNames) {
        console.warn('⚠️ Corrupted priceColumnNames detected, clearing localStorage and resetting to defaults');
        localStorage.removeItem('priceColumnNames');
        _internalPriceColumnNames.precio1 = 'Precio 1';
        _internalPriceColumnNames.precio2 = 'Precio 2';
        _internalPriceColumnNames.precio3 = 'Precio 3';
        _internalPriceColumnNames.precio4 = 'Precio 4';
        _internalPriceColumnNames.precio5 = '% Col5';
        _internalPriceColumnNames.precio6 = '% Col6';
        savePriceColumnNames();
        console.log('✅ priceColumnNames reset to defaults:', _internalPriceColumnNames);
      }
    }

    // Load initial configuration
    loadPriceColumnNames();
    validatePriceColumnNames();

    // Interceptar setItem de localStorage para detectar modificaciones
    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
      if (key === 'priceColumnNames') {
        console.warn('⚠️ INTERCEPTADO: Intento de modificar localStorage.priceColumnNames', {
          newValue: value,
          parsedValue: (() => {
            try {
              return JSON.parse(value);
            } catch {
              return 'Error parsing';
            }
          })(),
          stackTrace: new Error().stack
        });

        // Validar que el valor no contenga nombres inválidos
        try {
          const parsed = JSON.parse(value);
          for (const key in parsed) {
            if (INVALID_COLUMN_NAMES.includes(parsed[key])) {
              console.error('❌ BLOQUEADO: Intento de guardar valor inválido en localStorage:', {
                key: key,
                invalidValue: parsed[key]
              });
              alert(`⚠️ BLOQUEADO: Se intentó guardar "${parsed[key]}" en localStorage, que es un nombre reservado.`);
              return; // NO guardar
            }
          }
        } catch (e) {
          console.error('Error validando valor para localStorage:', e);
        }
      }
      originalSetItem.call(localStorage, key, value);
    };

    // Monitorear cambios en localStorage que puedan corromper los nombres
    window.addEventListener('storage', (e) => {
      if (e.key === 'priceColumnNames') {
        console.warn('⚠️ localStorage "priceColumnNames" modificado externamente:', {
          oldValue: e.oldValue,
          newValue: e.newValue,
          url: e.url
        });

        // Recargar y validar
        loadPriceColumnNames();
        validatePriceColumnNames();

        // Si estamos en la tab de PRECIOS, re-renderizar
        const preciosContent = document.getElementById('precios-content');
        if (preciosContent && preciosContent.style.display !== 'none') {
          console.log('🔄 Re-renderizando tabla de precios debido a cambio en localStorage');
          displayProducts();
        }
      }
    });

    // === PRODUCT PRICING FUNCTIONS ===

    // Load products from API (same endpoint as used in main.js)
    async function loadProducts() {
      console.log('🚀 loadProducts called');
      try {
        // Check if we're already loading
        if (window.productsLoading) {
          console.log('⏳ Products already loading, skipping...');
          return;
        }

        window.productsLoading = true;

        if (!window.firebase || !firebase.firestoreHelpers) {
          console.log('⚠️ Firebase not ready for products, waiting...');
          window.productsLoading = false;
          setTimeout(() => {
            console.log('🔄 Retrying loadProducts after Firebase delay');
            loadProducts();
          }, 1000);
          return;
        }

        console.log('📦 Cargando productos desde API...');

        // Show loading state in button
        const loadBtn = document.getElementById('loadProductsBtn');
        const originalLoadText = loadBtn ? loadBtn.querySelector('.mdc-button__label').textContent : '';
        if (loadBtn) {
          loadBtn.querySelector('.mdc-button__label').innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin-right: 8px;"></div>Cargando...';
          loadBtn.disabled = true;
        }

        // Show loading state
        const container = document.getElementById('productsContainer');
        container.innerHTML = `
          <div class="loading-products">
            <div class="loading-content">
              <div class="loading-spinner"></div>
              <p>Cargando productos desde la API...</p>
            </div>
          </div>
        `;

        // Use same API configuration as main.js
        const API_BASE = '/api';
        const AUTH_URL = `${API_BASE}/authenticate`;
        const STOCK_URL = `${API_BASE}/stock`;

        const CREDENTIALS = {
          username: 'Api',
          md5password: 'e10adc3949ba59abbe56e057f20f883e'
        };

        // Authenticate
        const authResp = await fetch(AUTH_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(CREDENTIALS)
        });

        if (!authResp.ok) {
          throw new Error(`Authentication failed (${authResp.status})`);
        }

        const authData = await authResp.json();
        if (!authData.ok || !authData.token) {
          throw new Error('Invalid authentication response');
        }

        // Fetch stock data
        const query = new URLSearchParams({ format: 'JSON', ViewOption: 0 }).toString();
        const stockResp = await fetch(`${STOCK_URL}?${query}`, {
          headers: { Authorization: `Bearer ${authData.token}` }
        });

        if (!stockResp.ok) {
          throw new Error(`Error fetching stock (${stockResp.status})`);
        }

        const stockData = await stockResp.json();
        const products = Array.isArray(stockData) ? stockData : (stockData.data || stockData.list || []);

        // Process and store products with existing prices
        window.products = await processProductsWithPrices(products);

        console.log('✅ Productos cargados:', window.products.length);
        displayProducts();

        // Restore button state
        if (loadBtn) {
          loadBtn.querySelector('.mdc-button__label').textContent = originalLoadText;
          loadBtn.disabled = false;
        }

        // Reset loading flag
        window.productsLoading = false;

      } catch (error) {
        console.error('❌ Error cargando productos:', error);

        // Restore button state on error
        const loadBtn = document.getElementById('loadProductsBtn');
        const originalLoadText = loadBtn ? loadBtn.querySelector('.mdc-button__label').textContent.replace(/.*Cargando.../, 'Actualizar Productos') : 'Actualizar Productos';
        if (loadBtn) {
          loadBtn.querySelector('.mdc-button__label').textContent = originalLoadText;
          loadBtn.disabled = false;
        }

        // Reset loading flag
        window.productsLoading = false;

        document.getElementById('productsContainer').innerHTML = `
          <div class="no-products">
            Error cargando productos: ${error.message}
            <br><br>
            <button class="mdc-button mdc-button--outlined" onclick="loadProducts()">
              <span class="mdc-button__label">Reintentar</span>
            </button>
          </div>
        `;
      }
    }

    // Process products and merge with existing price data from Firebase
    async function processProductsWithPrices(rawProducts) {
      const { collection, getDocs } = firebase.firestoreHelpers;
      const db = firebase.firestore();

      // Load existing prices from Firebase
      const pricesCollection = collection(db, 'precios');
      const pricesSnapshot = await getDocs(pricesCollection);

      const existingPrices = new Map();
      pricesSnapshot.forEach((doc) => {
        const data = doc.data();
        existingPrices.set(data.articulo, {
          id: doc.id,
          precio1: data.precio1 || 0,
          precio2: data.precio2 || 0,
          precio3: data.precio3 || 0,
          precio4: data.precio4 || 0
        });
      });

      // Process and normalize product data
      return rawProducts.map(raw => {
        // Extract articulo and description using same logic as main.js
        const articulo = getFirstExisting(raw, ['Artículo', 'Articulo', 'item', 'Item', 'Codigo', 'Código']) || '';
        const description = getFirstExisting(raw, ['Descripción', 'Descripcion', 'description', 'Description', 'Detalle']) || '';

        // Get existing prices or set defaults
        const prices = existingPrices.get(articulo) || {
          precio1: 0,
          precio2: 0,
          precio3: 0,
          precio4: 0
        };

        return {
          articulo,
          description,
          ...prices,
          modified: false
        };
      }).filter(product => product.articulo && product.description); // Only include products with both fields
    }

    // Helper function from main.js for extracting fields
    function normalizeKey(key) {
      return String(key)
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // quitar acentos
        .replace(/[^a-z0-9]/g, '');
    }

    function getFirstExisting(row, candidateKeys) {
      const normalizedMap = new Map();
      for (const k of Object.keys(row || {})) {
        normalizedMap.set(normalizeKey(k), k);
      }
      for (const c of candidateKeys) {
        const nk = normalizeKey(c);
        if (normalizedMap.has(nk)) {
          const originalKey = normalizedMap.get(nk);
          return row[originalKey];
        }
      }
      return undefined;
    }

    // Display products in pricing table
    function displayProducts() {
      const container = document.getElementById('productsContainer');

      // DEBUG: Log para rastrear cuándo se llama displayProducts
      console.log('🎨 displayProducts() LLAMADO');
      console.log('📋 priceColumnNames actual:', JSON.parse(JSON.stringify(priceColumnNames)));
      console.log('📋 localStorage actual:', localStorage.getItem('priceColumnNames'));

      // Finalize any header being edited before re-rendering (solo dentro de productsContainer)
      const headerBeingEdited = container ? container.querySelector('.products-table .header-text[contenteditable="true"]') : null;
      if (headerBeingEdited) {
        headerBeingEdited.blur(); // This will trigger the save
      }

      // Validar nombres de columnas antes de renderizar para prevenir corrupción
      validatePriceColumnNames();

      if (!window.products || window.products.length === 0) {
        container.innerHTML = `
          <div class="no-products">
            No se encontraron productos.
            <br><br>
            <button class="mdc-button mdc-button--outlined" onclick="loadProducts()">
              <span class="mdc-button__label">Cargar Productos</span>
            </button>
          </div>
        `;
        return;
      }

      // Sort products based on current sort state
      const sortedProducts = [...window.products].sort((a, b) => {
        const col = priceTableSort.column;
        const dir = priceTableSort.direction === 'asc' ? 1 : -1;
        let aVal = a[col];
        let bVal = b[col];

        // Handle null/undefined values - push them to the end
        if (aVal === null || aVal === undefined) return 1;
        if (bVal === null || bVal === undefined) return -1;

        if (typeof aVal === 'string' && typeof bVal === 'string') {
          return aVal.localeCompare(bVal, 'es', { numeric: true, sensitivity: 'base' }) * dir;
        }

        // Numeric comparison
        const aNum = Number(aVal);
        const bNum = Number(bVal);
        return (aNum - bNum) * dir;
      });

      // Helper function to generate sort indicator
      const getSortIndicator = (columnId) => {
        if (priceTableSort.column === columnId) {
          return priceTableSort.direction === 'asc' ? ' ▲' : ' ▼';
        }
        return ' ⇅';
      };

      // Helper function to get sorted class
      const getSortedClass = (columnId) => {
        return priceTableSort.column === columnId ? 'sorted' : '';
      };

      const productsHTML = `
        <div class="price-stats">
          <div class="price-stat">
            Total productos: <span class="price-stat-number">${window.products.length}</span>
          </div>
          <div class="price-stat">
            Con precios: <span class="price-stat-number">${window.products.filter(p => p.precio1 > 0 || p.precio2 > 0 || p.precio3 > 0 || p.precio4 > 0).length}</span>
          </div>
          <div class="price-stat" style="color: #888; font-size: 12px;">
            💡 Clic en nombres de columnas de precios para editar
          </div>
        </div>

        <table class="products-table">
          <thead>
            <tr>
              <th class="sortable ${getSortedClass('articulo')}" data-sort="articulo">Artículo${getSortIndicator('articulo')}</th>
              <th class="sortable ${getSortedClass('description')}" data-sort="description">Descripción${getSortIndicator('description')}</th>
              <th class="sortable editable-header ${getSortedClass('precio1')}" data-sort="precio1" data-column="precio1">
                <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                  <span class="header-text" contenteditable="false" style="cursor: text; border-bottom: 1px dashed #666; padding: 2px 4px;" title="Clic para editar">${priceColumnNames.precio1}</span>
                  <span class="sort-indicator">${getSortIndicator('precio1')}</span>
                </div>
              </th>
              <th class="sortable editable-header ${getSortedClass('precio2')}" data-sort="precio2" data-column="precio2">
                <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                  <span class="header-text" contenteditable="false" style="cursor: text; border-bottom: 1px dashed #666; padding: 2px 4px;" title="Clic para editar">${priceColumnNames.precio2}</span>
                  <span class="sort-indicator">${getSortIndicator('precio2')}</span>
                </div>
              </th>
              <th class="sortable editable-header ${getSortedClass('precio3')}" data-sort="precio3" data-column="precio3">
                <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                  <span class="header-text" contenteditable="false" style="cursor: text; border-bottom: 1px dashed #666; padding: 2px 4px;" title="Clic para editar">${priceColumnNames.precio3}</span>
                  <span class="sort-indicator">${getSortIndicator('precio3')}</span>
                </div>
              </th>
              <th class="sortable editable-header ${getSortedClass('precio4')}" data-sort="precio4" data-column="precio4">
                <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                  <span class="header-text" contenteditable="false" style="cursor: text; border-bottom: 1px dashed #666; padding: 2px 4px;" title="Clic para editar">${priceColumnNames.precio4}</span>
                  <span class="sort-indicator">${getSortIndicator('precio4')}</span>
                </div>
              </th>
              <th class="editable-header" data-column="precio5">
                <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                  <span class="header-text" contenteditable="false" style="cursor: text; border-bottom: 1px dashed #666; padding: 2px 4px;" title="Clic para editar">${priceColumnNames.precio5}</span>
                  <input type="number" class="percent-input" data-column="precio5" value="${priceColumnPercents.precio5}"
                         step="0.1" min="0" max="100" placeholder="%"
                         style="width: 60px; padding: 4px; text-align: center; border: 1px solid #3a3a44; background: #2a2a33; color: #fff; border-radius: 4px;"
                         title="Porcentaje sobre ${priceColumnNames.precio1}">
                </div>
              </th>
              <th class="editable-header" data-column="precio6">
                <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                  <span class="header-text" contenteditable="false" style="cursor: text; border-bottom: 1px dashed #666; padding: 2px 4px;" title="Clic para editar">${priceColumnNames.precio6}</span>
                  <input type="number" class="percent-input" data-column="precio6" value="${priceColumnPercents.precio6}"
                         step="0.1" min="0" max="100" placeholder="%"
                         style="width: 60px; padding: 4px; text-align: center; border: 1px solid #3a3a44; background: #2a2a33; color: #fff; border-radius: 4px;"
                         title="Porcentaje sobre ${priceColumnNames.precio1}">
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            ${sortedProducts.map(product => {
              // Calculate prices with percentage
              const precio5 = product.precio1 * (1 + priceColumnPercents.precio5 / 100);
              const precio6 = product.precio1 * (1 + priceColumnPercents.precio6 / 100);

              return `
              <tr data-articulo="${product.articulo}">
                <td>
                  <span class="product-code">${product.articulo}</span>
                </td>
                <td>
                  <span class="product-description">${product.description}</span>
                </td>
                <td>
                  <input type="number"
                         class="price-input"
                         data-articulo="${product.articulo}"
                         data-price="precio1"
                         value="${product.precio1}"
                         step="0.01"
                         min="0"
                         placeholder="0.00">
                </td>
                <td>
                  <input type="number"
                         class="price-input"
                         data-articulo="${product.articulo}"
                         data-price="precio2"
                         value="${product.precio2}"
                         step="0.01"
                         min="0"
                         placeholder="0.00">
                </td>
                <td>
                  <input type="number"
                         class="price-input"
                         data-articulo="${product.articulo}"
                         data-price="precio3"
                         value="${product.precio3}"
                         step="0.01"
                         min="0"
                         placeholder="0.00">
                </td>
                <td>
                  <input type="number"
                         class="price-input"
                         data-articulo="${product.articulo}"
                         data-price="precio4"
                         value="${product.precio4}"
                         step="0.01"
                         min="0"
                         placeholder="0.00">
                </td>
                <td>
                  <div class="calculated-price" style="padding: 8px; text-align: center; color: #4CAF50; font-weight: bold;">
                    $${precio5.toFixed(2)}
                  </div>
                </td>
                <td>
                  <div class="calculated-price" style="padding: 8px; text-align: center; color: #4CAF50; font-weight: bold;">
                    $${precio6.toFixed(2)}
                  </div>
                </td>
              </tr>
            `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = productsHTML;

      // Show save button
      const saveBtn = document.getElementById('saveAllPricesBtn');
      if (saveBtn) {
        saveBtn.style.display = 'inline-flex';
      }

      // Add event listeners to price inputs
      setupPriceInputListeners();

      // Add event listeners to sortable headers
      setupSortableHeaders();

      // Add event listeners to editable headers
      setupEditableHeaders();

      // Add event listeners to percent inputs
      setupPercentInputListeners();
    }

    // Setup event listeners for sortable table headers
    function setupSortableHeaders() {
      const sortableHeaders = document.querySelectorAll('.products-table th.sortable');
      sortableHeaders.forEach(th => {
        th.addEventListener('click', function(e) {
          // Don't sort if clicking on editable header text
          if (e.target.classList.contains('header-text')) {
            return;
          }

          // Don't sort if any header is currently being edited (solo dentro de productsContainer)
          const preciosContainer = document.getElementById('productsContainer');
          const anyHeaderBeingEdited = preciosContainer ? preciosContainer.querySelector('.products-table .header-text[contenteditable="true"]') : null;
          if (anyHeaderBeingEdited) {
            return;
          }

          // If clicking on sort indicator, allow sorting
          // (sort indicator has class 'sort-indicator')

          const column = this.dataset.sort;

          if (priceTableSort.column === column) {
            // Toggle direction if same column clicked
            priceTableSort.direction = priceTableSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            // Set new column and default to ascending
            priceTableSort.column = column;
            priceTableSort.direction = 'asc';
          }

          // Re-render the table with new sort
          displayProducts();
        });
      });
    }

    // Setup event listeners for price inputs
    function setupPriceInputListeners() {
      const priceInputs = document.querySelectorAll('.price-input');
      priceInputs.forEach(input => {
        input.addEventListener('input', function() {
          const articulo = this.dataset.articulo;
          const priceField = this.dataset.price;
          const value = parseFloat(this.value) || 0;

          // Find and update the product in memory
          const product = window.products.find(p => p.articulo === articulo);
          if (product) {
            product[priceField] = value;
            product.modified = true;
            this.classList.add('modified');

            // If precio1 changed, update calculated prices in same row
            if (priceField === 'precio1') {
              const row = this.closest('tr');
              const precio5 = value * (1 + priceColumnPercents.precio5 / 100);
              const precio6 = value * (1 + priceColumnPercents.precio6 / 100);

              const cells = row.querySelectorAll('td');
              if (cells.length >= 8) {
                const precio5Cell = cells[6].querySelector('.calculated-price');
                const precio6Cell = cells[7].querySelector('.calculated-price');
                if (precio5Cell) precio5Cell.textContent = '$' + precio5.toFixed(2);
                if (precio6Cell) precio6Cell.textContent = '$' + precio6.toFixed(2);
              }
            }
          }
        });

        input.addEventListener('blur', function() {
          // Format the value on blur
          const value = parseFloat(this.value) || 0;
          this.value = value.toFixed(2);
        });
      });
    }

    // Setup event listeners for editable column headers
    function setupEditableHeaders() {
      // IMPORTANTE: Solo buscar headers dentro del contenedor de PRECIOS
      const preciosContainer = document.getElementById('productsContainer');
      if (!preciosContainer) return;

      const editableHeaders = preciosContainer.querySelectorAll('.products-table th.editable-header');
      editableHeaders.forEach(th => {
        const headerText = th.querySelector('.header-text');
        if (!headerText) return;

        // Use click instead of dblclick for better UX
        headerText.addEventListener('click', function(e) {
          e.stopPropagation(); // Prevent sort/other events from firing

          // Check if already editing
          if (headerText.contentEditable === 'true') return;

          const columnId = th.dataset.column;

          // Verificar que el columnId sea válido (precio1-6)
          if (!['precio1', 'precio2', 'precio3', 'precio4', 'precio5', 'precio6'].includes(columnId)) {
            console.warn('⚠️ Invalid columnId for price column:', columnId);
            return;
          }

          const currentName = priceColumnNames[columnId];

          // Make the span editable
          headerText.contentEditable = 'true';
          headerText.style.border = '1px solid #4CAF50';
          headerText.style.borderRadius = '4px';
          headerText.style.background = '#2a2a33';
          headerText.style.outline = 'none';

          // Select all text
          const range = document.createRange();
          range.selectNodeContents(headerText);
          const selection = window.getSelection();
          selection.removeAllRanges();
          selection.addRange(range);

          // Save on blur or Enter
          const saveEdit = () => {
            try {
              // Get the new name and clean it
              let newName = headerText.textContent.trim();

              // Validate the new name
              if (!newName || newName === '') {
                console.warn('Empty column name, keeping original:', currentName);
                newName = currentName;
              }

              // Validar que no sea un nombre inválido (nombres de columnas del marketplace)
              if (INVALID_COLUMN_NAMES.includes(newName)) {
                console.error('❌ Intento de usar nombre inválido:', newName);
                alert(`❌ El nombre "${newName}" no está permitido. Por favor usa un nombre diferente.`);
                headerText.textContent = currentName;
                return;
              }

              // Check if the name actually changed
              if (newName === currentName) {
                console.log('Column name unchanged:', columnId, '=', currentName);
                headerText.textContent = currentName;
              } else {
                console.log('Saving column name change:', columnId, currentName, '->', newName);
                priceColumnNames[columnId] = newName;
                savePriceColumnNames();
                headerText.textContent = newName;
              }
            } catch (error) {
              console.error('Error saving column name for', columnId, ':', error);
              // Reset to original name on error
              headerText.textContent = currentName;
            } finally {
              // Always reset editable state, even if there was an error
              headerText.contentEditable = 'false';
              headerText.style.border = '';
              headerText.style.borderRadius = '';
              headerText.style.background = '';
              headerText.style.borderBottom = '1px dashed #666';
            }
          };

          // Listen for blur (click outside)
          headerText.addEventListener('blur', saveEdit, { once: true });

          // Listen for Enter/Escape
          headerText.addEventListener('keydown', function handleKeydown(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              headerText.blur(); // Trigger save
            } else if (e.key === 'Escape') {
              headerText.textContent = currentName; // Reset text
              headerText.blur();
            }
          }, { once: true });
        });
      });
    }

    // Setup event listeners for percent inputs
    function setupPercentInputListeners() {
      const percentInputs = document.querySelectorAll('.percent-input');
      percentInputs.forEach(input => {
        input.addEventListener('input', function(e) {
          e.stopPropagation(); // Prevent event bubbling

          const columnId = this.dataset.column;
          const value = parseFloat(this.value) || 0;

          // Update the percentage
          priceColumnPercents[columnId] = value;
          savePriceColumnPercents();

          // Re-calculate and update all calculated prices in the table
          updateCalculatedPrices();
        });

        // Prevent sorting when clicking on percent input
        input.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      });
    }

    // Update calculated prices without re-rendering entire table
    function updateCalculatedPrices() {
      const rows = document.querySelectorAll('.products-table tbody tr');
      rows.forEach(row => {
        const articulo = row.dataset.articulo;
        const product = window.products.find(p => p.articulo === articulo);

        if (product) {
          // Calculate new prices
          const precio5 = product.precio1 * (1 + priceColumnPercents.precio5 / 100);
          const precio6 = product.precio1 * (1 + priceColumnPercents.precio6 / 100);

          // Update the displayed values
          const cells = row.querySelectorAll('td');
          if (cells.length >= 8) {
            cells[6].querySelector('.calculated-price').textContent = '$' + precio5.toFixed(2);
            cells[7].querySelector('.calculated-price').textContent = '$' + precio6.toFixed(2);
          }
        }
      });
    }

    // Save all prices to Firebase
    async function saveAllPrices() {
      try {
        if (!window.firebase || !firebase.firestoreHelpers) {
          throw new Error('Firebase not available');
        }

        if (!window.products) {
          throw new Error('No products loaded');
        }

        const { collection, doc, setDoc, updateDoc, addDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();
        const pricesCollection = collection(db, 'precios');

        console.log('💾 Guardando precios...');

        // Show saving indicator
        const saveBtn = document.getElementById('saveAllPricesBtn');
        const originalText = saveBtn.querySelector('.mdc-button__label').textContent;
        saveBtn.querySelector('.mdc-button__label').innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin-right: 8px;"></div>Guardando...';
        saveBtn.disabled = true;

        let savedCount = 0;

        for (const product of window.products) {
          const priceData = {
            articulo: product.articulo,
            description: product.description,
            precio1: product.precio1 || 0,
            precio2: product.precio2 || 0,
            precio3: product.precio3 || 0,
            precio4: product.precio4 || 0,
            updatedAt: new Date()
          };

          if (product.id) {
            // Update existing price record
            const priceRef = doc(db, 'precios', product.id);
            await updateDoc(priceRef, priceData);
          } else {
            // Create new price record
            const docRef = await addDoc(pricesCollection, {
              ...priceData,
              createdAt: new Date()
            });
            product.id = docRef.id;
          }

          product.modified = false;
          savedCount++;
        }

        // Remove modified styling from all inputs
        document.querySelectorAll('.price-input.modified').forEach(input => {
          input.classList.remove('modified');
        });

        console.log(`✅ Precios guardados: ${savedCount} productos`);
        alert(`Precios guardados exitosamente para ${savedCount} productos`);

        // Restore button
        saveBtn.querySelector('.mdc-button__label').textContent = originalText;
        saveBtn.disabled = false;

      } catch (error) {
        console.error('❌ Error guardando precios:', error);
        alert('Error guardando precios. Inténtalo de nuevo.');

        // Restore button
        const saveBtn = document.getElementById('saveAllPricesBtn');
        saveBtn.querySelector('.mdc-button__label').textContent = 'Guardar Todos los Precios';
        saveBtn.disabled = false;
      }
    }

    // Import prices from CSV/Excel file
    async function importPrices() {
      const fileInput = document.getElementById('pricesFileInput');
      fileInput.click();
    }

    // Process imported price file
    async function processPriceFile(file) {
      try {
        console.log('📁 Procesando archivo de precios:', file.name);

        let data;
        const fileName = file.name.toLowerCase();

        if (fileName.endsWith('.csv')) {
          data = await parseCSV(file);
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
          data = await parseExcel(file);
        } else {
          throw new Error('Formato de archivo no soportado. Use CSV (.csv) o Excel (.xlsx, .xls)');
        }

        // Validate and process data
        const processedPrices = validateAndProcessPriceData(data);

        if (processedPrices.length === 0) {
          throw new Error('No se encontraron datos válidos en el archivo');
        }

        // Show preview and confirm import
        const confirmMessage = `¿Desea importar ${processedPrices.length} precios desde el archivo "${file.name}"?\n\nPrimeros 3 registros:\n${processedPrices.slice(0, 3).map(p => `• ${p.articulo}: ${p.description} (Precios: ${p.precio1}, ${p.precio2}, ${p.precio3}, ${p.precio4})`).join('\n')}`;

        if (confirm(confirmMessage)) {
          // Show progress
          const container = document.getElementById('productsContainer');
          container.innerHTML = `
            <div class="loading-products">
              <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>Importando ${processedPrices.length} precios...</p>
              </div>
            </div>
          `;

          await importPriceData(processedPrices);
          alert(`✅ Precios importados exitosamente: ${processedPrices.length} registros`);

          // Reload products to show updated prices (with small delay to ensure Firebase propagation)
          setTimeout(() => {
            if (window.loadProducts) {
              console.log('🔄 Reloading products after import...');
              window.loadProducts();
            }
          }, 500);
        }

      } catch (error) {
        console.error('❌ Error importando precios:', error);
        alert(`Error importando precios: ${error.message}`);
      }
    }

    // Parse CSV file
    function parseCSV(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const text = e.target.result;
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

            const data = [];
            for (let i = 1; i < lines.length; i++) {
              const line = lines[i].trim();
              if (!line) continue;

              const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
              const row = {};
              headers.forEach((header, index) => {
                row[header] = values[index] || '';
              });
              data.push(row);
            }
            resolve(data);
          } catch (error) {
            reject(new Error('Error parsing CSV: ' + error.message));
          }
        };
        reader.onerror = () => reject(new Error('Error reading file'));
        reader.readAsText(file, 'UTF-8');
      });
    }

    // Parse Excel file using SheetJS
    function parseExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            // Check if XLSX library is loaded
            if (typeof XLSX === 'undefined') {
              throw new Error('SheetJS library not loaded. Please refresh the page and try again.');
            }

            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            // Get first worksheet
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            // Convert to JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {
              header: 1, // Use first row as header
              defval: '' // Default value for empty cells
            });

            if (jsonData.length < 2) {
              throw new Error('El archivo Excel debe tener al menos una fila de encabezados y una fila de datos');
            }

            // Convert to same format as CSV parser
            const headers = jsonData[0].map(h => String(h).trim());
            const processedData = [];

            for (let i = 1; i < jsonData.length; i++) {
              const row = jsonData[i];
              const rowObj = {};

              headers.forEach((header, index) => {
                rowObj[header] = row[index] ? String(row[index]).trim() : '';
              });

              // Skip empty rows
              const hasData = Object.values(rowObj).some(value => value && value.trim());
              if (hasData) {
                processedData.push(rowObj);
              }
            }

            console.log(`📊 Excel procesado: ${processedData.length} filas, Columnas: ${headers.join(', ')}`);
            resolve(processedData);

          } catch (error) {
            reject(new Error('Error parsing Excel file: ' + error.message));
          }
        };

        reader.onerror = () => reject(new Error('Error reading Excel file'));
        reader.readAsArrayBuffer(file);
      });
    }

    // Validate and process price data
    function validateAndProcessPriceData(data) {
      const processedPrices = [];

      for (const row of data) {
        // Look for common column names (case insensitive)
        const articulo = findColumnValue(row, ['articulo', 'codigo', 'item', 'article', 'code']);
        const description = findColumnValue(row, ['descripcion', 'description', 'detalle', 'nombre', 'name']);
        const precio1 = parseFloat(findColumnValue(row, ['precio1', 'precio_1', 'price1', 'price_1']) || 0);
        const precio2 = parseFloat(findColumnValue(row, ['precio2', 'precio_2', 'price2', 'price_2']) || 0);
        const precio3 = parseFloat(findColumnValue(row, ['precio3', 'precio_3', 'price3', 'price_3']) || 0);
        const precio4 = parseFloat(findColumnValue(row, ['precio4', 'precio_4', 'price4', 'price_4']) || 0);

        if (articulo && articulo.trim()) {
          processedPrices.push({
            articulo: articulo.trim(),
            description: description ? description.trim() : '',
            precio1,
            precio2,
            precio3,
            precio4
          });
        }
      }

      return processedPrices;
    }

    // Helper function to find column value by different possible names
    function findColumnValue(row, possibleNames) {
      for (const name of possibleNames) {
        for (const key in row) {
          if (key.toLowerCase().includes(name.toLowerCase())) {
            return row[key];
          }
        }
      }
      return null;
    }

    // Import price data to Firebase
    async function importPriceData(pricesData) {
      if (!window.firebase || !firebase.firestoreHelpers) {
        throw new Error('Firebase not available');
      }

      const { collection, doc, setDoc, addDoc, getDocs, query, where } = firebase.firestoreHelpers;
      const db = firebase.firestore();
      const pricesCollection = collection(db, 'precios');

      let importedCount = 0;
      let updatedCount = 0;

      for (const priceData of pricesData) {
        try {
          // Check if price record already exists
          const q = query(pricesCollection, where('articulo', '==', priceData.articulo));
          const existingDocs = await getDocs(q);

          const dataToSave = {
            articulo: priceData.articulo,
            description: priceData.description,
            precio1: priceData.precio1 || 0,
            precio2: priceData.precio2 || 0,
            precio3: priceData.precio3 || 0,
            precio4: priceData.precio4 || 0,
            updatedAt: new Date()
          };

          if (existingDocs.empty) {
            // Create new price record
            await addDoc(pricesCollection, {
              ...dataToSave,
              createdAt: new Date()
            });
            importedCount++;
            console.log(`✅ Created price for: ${priceData.articulo}`);
          } else {
            // Update existing price record
            const existingDoc = existingDocs.docs[0];
            const priceRef = doc(db, 'precios', existingDoc.id);
            await updateDoc(priceRef, dataToSave);
            updatedCount++;
            console.log(`✅ Updated price for: ${priceData.articulo}`);
          }
        } catch (error) {
          console.warn('Error importing price for', priceData.articulo, error);
        }
      }

      console.log(`✅ Importación completada: ${importedCount} nuevos, ${updatedCount} actualizados`);
    }

    // Export prices to CSV
    function exportPricesToCSV() {
      try {
        if (!window.products || window.products.length === 0) {
          alert('No hay productos cargados para exportar');
          return;
        }

        // Prepare CSV data
        const headers = ['Articulo', 'Descripcion', 'Precio1', 'Precio2', 'Precio3', 'Precio4'];
        const csvData = [headers];

        // Add product data
        window.products.forEach(product => {
          csvData.push([
            product.articulo || '',
            product.description || '',
            product.precio1 || 0,
            product.precio2 || 0,
            product.precio3 || 0,
            product.precio4 || 0
          ]);
        });

        // Convert to CSV string
        const csvContent = csvData.map(row =>
          row.map(field => `"${String(field).replace(/"/g, '""')}"`)
             .join(',')
        ).join('\n');

        // Create and download file
        const fileName = `precios_${getCurrentDateString()}.csv`;
        downloadFile(csvContent, fileName, 'text/csv;charset=utf-8;');

        console.log(`✅ CSV exportado: ${window.products.length} productos`);
        alert(`CSV exportado exitosamente: ${window.products.length} productos`);

      } catch (error) {
        console.error('❌ Error exportando CSV:', error);
        alert('Error exportando CSV: ' + error.message);
      }
    }

    // Export prices to Excel
    function exportPricesToExcel() {
      try {
        if (!window.products || window.products.length === 0) {
          alert('No hay productos cargados para exportar');
          return;
        }

        // Check if XLSX library is loaded
        if (typeof XLSX === 'undefined') {
          alert('SheetJS library not loaded. Please refresh the page and try again.');
          return;
        }

        // Prepare Excel data
        const headers = ['Articulo', 'Descripcion', 'Precio1', 'Precio2', 'Precio3', 'Precio4'];
        const excelData = [headers];

        // Add product data
        window.products.forEach(product => {
          excelData.push([
            product.articulo || '',
            product.description || '',
            product.precio1 || 0,
            product.precio2 || 0,
            product.precio3 || 0,
            product.precio4 || 0
          ]);
        });

        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);

        // Set column widths
        ws['!cols'] = [
          { width: 15 }, // Articulo
          { width: 40 }, // Descripcion
          { width: 12 }, // Precio1
          { width: 12 }, // Precio2
          { width: 12 }, // Precio3
          { width: 12 }  // Precio4
        ];

        // Format header row
        const headerStyle = {
          font: { bold: true, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "4CAF50" } },
          alignment: { horizontal: "center", vertical: "center" }
        };

        // Apply header style
        for (let col = 0; col < headers.length; col++) {
          const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
          if (!ws[cellRef]) ws[cellRef] = { t: 's', v: '' };
          ws[cellRef].s = headerStyle;
        }

        // Format price columns as currency
        for (let row = 1; row <= window.products.length; row++) {
          for (let col = 2; col < 6; col++) { // Columns C to F (Precio1-4)
            const cellRef = XLSX.utils.encode_cell({ r: row, c: col });
            if (ws[cellRef]) {
              ws[cellRef].z = '#,##0.00';
              ws[cellRef].t = 'n';
            }
          }
        }

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Precios');

        // Generate and download file
        const fileName = `precios_${getCurrentDateString()}.xlsx`;
        XLSX.writeFile(wb, fileName);

        console.log(`✅ Excel exportado: ${window.products.length} productos`);
        alert(`Excel exportado exitosamente: ${window.products.length} productos`);

      } catch (error) {
        console.error('❌ Error exportando Excel:', error);
        alert('Error exportando Excel: ' + error.message);
      }
    }

    // Helper function to get current date string
    function getCurrentDateString() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      return `${year}${month}${day}_${hours}${minutes}`;
    }

    // Helper function to download file
    function downloadFile(content, fileName, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    // Expose functions globally
    window.loadProducts = loadProducts;
    window.saveAllPrices = saveAllPrices;
    window.importPrices = importPrices;
    window.processPriceFile = processPriceFile;
    window.exportPricesToCSV = exportPricesToCSV;
    window.exportPricesToExcel = exportPricesToExcel;

    // === ORDER MANAGEMENT FUNCTIONS ===

    // Order status options - Sincronizado con SEGUIMIENTO
    const ORDER_STATUS_OPTIONS = [
      { value: 'borrador', label: 'BORRADOR', class: 'status-borrador' },
      { value: 'revision', label: 'EN REVISIÓN', class: 'status-revision' },
      { value: 'aprobada', label: 'APROBADA', class: 'status-aprobada' },
      { value: 'preparacion', label: 'EN PREPARACIÓN', class: 'status-preparacion' },
      { value: 'listo', label: 'LISTO PARA RETIRO/DESPACHO', class: 'status-listo' },
      { value: 'despachada', label: 'DESPACHADA', class: 'status-despachada' },
      { value: 'entregada', label: 'ENTREGADA', class: 'status-entregada' },
      { value: 'cerrada', label: 'CERRADA', class: 'status-cerrada' },
      { value: 'cancelada', label: 'CANCELADA', class: 'status-cancelada' }
    ];

    // Load orders from Firebase
    async function loadOrders() {
      try {
        console.log('🔄 [MASTER] loadOrders() called');

        if (!window.firebase || !firebase.firestoreHelpers) {
          console.log('⚠️ Firebase not ready for orders, waiting...');
          setTimeout(loadOrders, 1000);
          return;
        }

        const { collection, getDocs, orderBy, query, updateDoc, doc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        console.log('📋 [MASTER] Cargando órdenes desde colección "pedidos"...');

        const pedidosCollection = collection(db, 'pedidos');
        const q = query(pedidosCollection, orderBy('timestamp', 'desc'));
        const querySnapshot = await getDocs(q);

        console.log(`📦 [MASTER] Query ejecutada, documentos encontrados: ${querySnapshot.size}`);

        window.orders = [];
        const updatePromises = [];

        querySnapshot.forEach((docSnapshot) => {
          const data = docSnapshot.data();
          console.log(`📄 [MASTER] Procesando orden ${docSnapshot.id}:`, {
            logisticsState: data.logisticsState,
            numeroOrden: data.numeroOrden,
            total: data.total
          });

          // Check if logisticsState exists, if not, set it to 'borrador'
          if (!data.logisticsState) {
            console.log(`🔄 Setting logisticsState to 'borrador' for order ${docSnapshot.id}`);
            const orderRef = doc(db, 'pedidos', docSnapshot.id);
            updatePromises.push(updateDoc(orderRef, { logisticsState: 'borrador' }));
          }

          window.orders.push({
            id: docSnapshot.id,
            ...data,
            logisticsState: data.logisticsState || 'borrador', // Default state
            // Convert timestamp to date string
            fechaLocal: data.fechaLocal || (data.timestamp && data.timestamp.toDate ?
              data.timestamp.toDate().toLocaleDateString('es-AR') : 'No date'),
            fecha: data.fecha && data.fecha.toDate ? data.fecha.toDate().toISOString().split('T')[0] :
                   data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().toISOString().split('T')[0] :
                   (data.fecha || new Date().toISOString().split('T')[0]),
            modified: false
          });
        });

        // Update orders that don't have logisticsState
        if (updatePromises.length > 0) {
          await Promise.all(updatePromises);
          console.log(`✅ Updated ${updatePromises.length} orders with logisticsState`);
        }

        console.log('✅ [MASTER] Órdenes cargadas desde pedidos:', window.orders.length);
        console.log('📊 [MASTER] Desglose por estado:', {
          borrador: window.orders.filter(o => o.logisticsState === 'borrador').length,
          revision: window.orders.filter(o => o.logisticsState === 'revision').length,
          aprobada: window.orders.filter(o => o.logisticsState === 'aprobada').length,
          preparacion: window.orders.filter(o => o.logisticsState === 'preparacion').length,
          listo: window.orders.filter(o => o.logisticsState === 'listo').length,
          despachada: window.orders.filter(o => o.logisticsState === 'despachada').length,
          entregada: window.orders.filter(o => o.logisticsState === 'entregada').length,
          cerrada: window.orders.filter(o => o.logisticsState === 'cerrada').length,
          cancelada: window.orders.filter(o => o.logisticsState === 'cancelada').length
        });

        console.log('🎨 [MASTER] Llamando a displayOrders()...');
        await displayOrders();

        console.log('📊 [MASTER] Llamando a updateOrderStats()...');
        updateOrderStats();

      } catch (error) {
        console.error('❌ [MASTER] Error cargando órdenes:', error);
        const borradorContainer = document.getElementById('admin-borradorOrders');
        if (borradorContainer) {
          borradorContainer.innerHTML = `
            <div class="no-orders">
              Error cargando órdenes: ${error.message}
            </div>
          `;
        }
      }
    }

    // Display orders in their respective sections (same as SEGUIMIENTO)
    async function displayOrders(searchTerm = '') {
      console.log('🎨 [MASTER] displayOrders() called with', window.orders?.length || 0, 'orders', searchTerm ? `(searching: "${searchTerm}")` : '');

      const containers = {
        borrador: document.getElementById('admin-borradorOrders'),
        revision: document.getElementById('admin-revisionOrders'),
        aprobada: document.getElementById('admin-aprobadaOrders'),
        preparacion: document.getElementById('admin-preparacionOrders'),
        listo: document.getElementById('admin-listoOrders'),
        despachada: document.getElementById('admin-despachadaOrders'),
        entregada: document.getElementById('admin-entregadaOrders'),
        cerrada: document.getElementById('admin-cerradaOrders'),
        cancelada: document.getElementById('admin-canceladaOrders')
      };

      // Check if all containers exist
      const missingContainers = Object.entries(containers).filter(([key, val]) => !val).map(([key]) => key);
      if (missingContainers.length > 0) {
        console.error('❌ [MASTER] Admin MASTER containers not found:', missingContainers);
        return;
      }

      console.log('✅ [MASTER] Todos los contenedores encontrados');

      // Define state flow: bidirectional movement with prev and next
      const stateFlow = {
        borrador: { next: 'revision', prev: null },
        revision: { next: 'aprobada', prev: 'borrador' },
        aprobada: { next: 'preparacion', prev: 'revision' },
        preparacion: { next: 'listo', prev: 'aprobada' },
        listo: { next: 'despachada', prev: 'preparacion' },
        despachada: { next: 'entregada', prev: 'listo' },
        entregada: { next: 'cerrada', prev: 'despachada' },
        cerrada: { next: null, prev: 'entregada' },
        cancelada: { next: null, prev: null }
      };

      // Filter orders by search term if provided
      let filteredOrders = window.orders;
      if (searchTerm && searchTerm.trim()) {
        const search = searchTerm.trim().toLowerCase();
        filteredOrders = window.orders.filter(order => {
          // Search by order number (manual or automatic)
          const orderNumber = String(order.manualOrderNumber || order.numeroOrden || '').toLowerCase();
          if (orderNumber.includes(search)) return true;

          // Search by client name
          const clientName = String(order.clienteNombre || '').toLowerCase();
          if (clientName.includes(search)) return true;

          // Search by client email (could contain client number)
          const clientEmail = String(order.clienteEmail || '').toLowerCase();
          if (clientEmail.includes(search)) return true;

          // Search by user email
          const userEmail = String(order.usuarioEmail || '').toLowerCase();
          if (userEmail.includes(search)) return true;

          // Search by client code (assuming it's in clienteData)
          const clientCode = String(order.clienteData?.codigo || order.codigo || '').toLowerCase();
          if (clientCode.includes(search)) return true;

          return false;
        });

        // Update search results count
        const searchResultsCount = document.getElementById('searchResultsCount');
        if (searchResultsCount) {
          searchResultsCount.style.display = 'block';
          searchResultsCount.textContent = `📊 Mostrando ${filteredOrders.length} de ${window.orders.length} órdenes`;
        }

        // Show clear button
        const clearBtn = document.getElementById('clearSearchBtn');
        if (clearBtn) clearBtn.style.display = 'flex';
      } else {
        // Hide search results count and clear button
        const searchResultsCount = document.getElementById('searchResultsCount');
        if (searchResultsCount) searchResultsCount.style.display = 'none';

        const clearBtn = document.getElementById('clearSearchBtn');
        if (clearBtn) clearBtn.style.display = 'none';
      }

      // Separate orders by state
      const ordersByState = {
        borrador: filteredOrders.filter(order => order.logisticsState === 'borrador'),
        revision: filteredOrders.filter(order => order.logisticsState === 'revision'),
        aprobada: filteredOrders.filter(order => order.logisticsState === 'aprobada'),
        preparacion: filteredOrders.filter(order => order.logisticsState === 'preparacion'),
        listo: filteredOrders.filter(order => order.logisticsState === 'listo'),
        despachada: filteredOrders.filter(order => order.logisticsState === 'despachada'),
        entregada: filteredOrders.filter(order => order.logisticsState === 'entregada'),
        cerrada: filteredOrders.filter(order => order.logisticsState === 'cerrada'),
        cancelada: filteredOrders.filter(order => order.logisticsState === 'cancelada')
      };

      console.log('📊 [MASTER] Órdenes por estado:', {
        borrador: ordersByState.borrador.length,
        revision: ordersByState.revision.length,
        aprobada: ordersByState.aprobada.length,
        preparacion: ordersByState.preparacion.length,
        listo: ordersByState.listo.length,
        despachada: ordersByState.despachada.length,
        entregada: ordersByState.entregada.length,
        cerrada: ordersByState.cerrada.length,
        cancelada: ordersByState.cancelada.length
      });

      // Display orders in each section
      for (const [state, stateOrders] of Object.entries(ordersByState)) {
        const container = containers[state];
        const currentFlow = stateFlow[state];

        console.log(`🎨 [MASTER] Renderizando ${stateOrders.length} órdenes para estado "${state}"`);

        if (stateOrders.length > 0) {
          const htmlPromises = stateOrders.map(order => createAdminOrderHTML(order, currentFlow, state));
          const htmlArray = await Promise.all(htmlPromises);
          const html = htmlArray.join('');
          console.log(`📝 [MASTER] HTML generado para ${state}:`, html.substring(0, 100) + '...');
          container.innerHTML = html;
        } else {
          const messages = {
            borrador: 'No hay pedidos en borrador',
            revision: 'No hay pedidos en revisión',
            aprobada: 'No hay pedidos aprobados',
            preparacion: 'No hay pedidos en preparación',
            listo: 'No hay pedidos listos',
            despachada: 'No hay pedidos despachados',
            entregada: 'No hay pedidos entregados',
            cerrada: 'No hay pedidos cerrados',
            cancelada: 'No hay pedidos cancelados'
          };
          container.innerHTML = `<p class="no-orders">${messages[state]}</p>`;
        }
      }

      console.log('✅ [MASTER] displayOrders() completado');
    }

    // Create HTML for an order item (admin version with edit capabilities)
    async function createAdminOrderHTML(order, currentFlow, currentState) {
      const canEdit = window.isUserAdmin;
      const hasNext = currentFlow && currentFlow.next !== null;
      const hasPrev = currentFlow && currentFlow.prev !== null;
      let buttonHtml = '';

      const stateLabels = {
        borrador: 'Borrador',
        revision: 'En Revisión',
        aprobada: 'Aprobada',
        preparacion: 'En Preparación',
        listo: 'Listo para Retiro/Despacho',
        despachada: 'Despachada',
        entregada: 'Entregada',
        cerrada: 'Cerrada',
        cancelada: 'Cancelada'
      };

      // Short labels for buttons (to fit in button space)
      const shortLabels = {
        borrador: 'Borrador',
        revision: 'En Revisión',
        aprobada: 'Aprobada',
        preparacion: 'En Preparación',
        listo: 'Listo',
        despachada: 'Despachada',
        entregada: 'Entregada',
        cerrada: 'Cerrada',
        cancelada: 'Cancelada'
      };

      // Admin can move orders and has additional controls
      if (canEdit) {
        // Flecha hacia arriba (volver al estado anterior) - solo permitido en estado "revision"
        if (hasPrev && currentState === 'revision') {
          const prevStateLabel = stateLabels[currentFlow.prev] || currentFlow.prev;
          buttonHtml += `<button class="move-order-btn-up" onclick="adminMoveOrder('${order.id}', '${currentFlow.prev}')" title="Volver a ${prevStateLabel}">↑</button>`;
        }

        // Flecha hacia abajo (avanzar al siguiente estado)
        if (hasNext) {
          const nextStateLabel = stateLabels[currentFlow.next] || currentFlow.next;
          const shortLabel = shortLabels[currentFlow.next] || currentFlow.next;
          buttonHtml += `
            <button class="move-order-btn" onclick="adminMoveOrder('${order.id}', '${currentFlow.next}')" title="Mover a ${nextStateLabel}">
              ↓ ${shortLabel}
            </button>
          `;
        }

        // Add cancel button for non-cancelled orders
        if (currentState !== 'cancelada' && currentState !== 'cerrada') {
          buttonHtml += `
            <button class="cancel-order-btn" onclick="adminMoveOrder('${order.id}', 'cancelada')" title="Cancelar pedido">
              ❌ Cancelar
            </button>
          `;
        }
      }

      // Final states display
      if (!hasNext && !hasPrev) {
        // Final states (cerrada, cancelada)
        if (currentState === 'entregada') {
          buttonHtml = `<span class="delivered-status">✓ Entregada</span>`;
        } else if (currentState === 'cerrada') {
          buttonHtml = `<span class="closed-status">🔒 Cerrada</span>`;
        } else if (currentState === 'cancelada') {
          buttonHtml = `<span class="cancelled-status">❌ Cancelada</span>`;
        }
      }

      // Add edit button for admin
      if (canEdit) {
        buttonHtml += `
          <button class="edit-order-btn" onclick="adminEditOrder('${order.id}')" title="Editar orden">
            ✏️ Editar
          </button>
        `;
      }

      // Add photo and weight buttons for preparacion state (v0.40)
      let preparacionButtonsHtml = '';
      if (currentState === 'preparacion' && canEdit) {
        const photoUrl = order.fotoPreparacion || '';
        const peso = order.pesoPreparacion || '';

        // Botón de foto: si ya hay foto, muestra ✓ y permite ver o actualizar
        const photoButtonLabel = photoUrl ? '📸 ✓' : '📸 Foto';
        const photoButtonAction = `handleFotoButton('${order.id}', '${photoUrl}')`;

        preparacionButtonsHtml = `
          <input type="file"
                 id="photo-input-${order.id}"
                 accept="image/*"
                 onchange="handlePreparacionPhoto('${order.id}', this)"
                 style="display: none;">
          <input type="file"
                 id="camera-input-${order.id}"
                 accept="image/*"
                 capture
                 onchange="handlePreparacionPhoto('${order.id}', this)"
                 style="display: none;">
          <button class="edit-order-btn"
                  onclick="${photoButtonAction}"
                  title="${photoUrl ? 'Foto subida - Click para ver o actualizar' : 'Subir foto de preparación'}">
            ${photoButtonLabel}
          </button>
          <button class="edit-order-btn"
                  onclick="promptPesoPreparacion('${order.id}', '${peso}')"
                  title="Ingresar peso de preparación">
            ⚖️ ${peso ? peso + ' kg' : 'Peso'}
          </button>
        `;
      }

      // Get cliente principal name and vendedor name
      const clientePrincipal = getClientePrincipalName(order);
      const vendedorName = getVendedorName(order);

      return `
        <div class="order-item" data-order-id="${order.id}" onclick="handleOrderClick('${order.id}')" style="cursor: pointer;" title="Click para ver detalles">
          <div class="order-info">
            <div class="order-number">#${order.manualOrderNumber || order.numeroOrden || order.id.slice(-6)}</div>
            <div class="order-details">
              ${order.fechaLocal || order.fecha || 'No date'} • ${order.cantidadItems || order.items?.length || 0} items • $${formatNumber(order.total || order.montoTotal || 0)}
              <br><strong>Cliente:</strong> <span class="editable-client" onclick="event.stopPropagation(); editOrderClient('${order.id}')" title="Click para editar">${clientePrincipal}</span>
              <br><strong>Vendedor:</strong> <span class="editable-seller" onclick="event.stopPropagation(); editOrderSeller('${order.id}')" title="Click para editar">${vendedorName}</span>
            </div>
          </div>
          <div class="order-actions" onclick="event.stopPropagation();">
            ${preparacionButtonsHtml}
            ${buttonHtml}
          </div>
        </div>
      `;
    }

    // Helper function to get cliente principal name
    function getClientePrincipalName(order) {
      console.log('🔍 [CLIENT DEBUG] Getting client name for order:', order.id);
      console.log('🔍 [CLIENT DEBUG] Order clienteCodigo:', order.clienteCodigo);
      console.log('🔍 [CLIENT DEBUG] Order clienteNombre:', order.clienteNombre);
      console.log('🔍 [CLIENT DEBUG] Order usuarioEmail:', order.usuarioEmail);
      console.log('🔍 [CLIENT DEBUG] Order clienteEmail:', order.clienteEmail);
      console.log('🔍 [CLIENT DEBUG] Order vendedorEmail:', order.vendedorEmail);

      // SPECIAL CASE FIRST: Handle cortizjctech specifically
      if (order.usuarioEmail === 'cortizjctech@gmail.com' || order.clienteEmail === 'cortizjctech@gmail.com') {
        console.log('🔧 [CLIENT DEBUG] *** SPECIAL CASE: cortizjctech detected, returning Trading Next USA Black ***');
        return 'TRADING NEXT USA BLACK (407)';
      }

      if (!window.allClients) {
        console.log('❌ [CLIENT DEBUG] No allClients available');
        // Priorizar clienteNombre sobre emails
        return `⚠️ ${order.clienteNombre || order.clienteEmail || order.usuarioEmail || 'Sin cliente'} (datos no cargados)`;
      }

      console.log('🔍 [CLIENT DEBUG] Available clients:', window.allClients.map(c => ({ codigo: c.codigo, nombre: c.nombre, email: c.email })));

      // Strategy 1: Direct match by clienteCodigo
      if (order.clienteCodigo && window.allClients) {
        const cliente = window.allClients.find(c => c.codigo === order.clienteCodigo);
        if (cliente) {
          console.log('✅ [CLIENT DEBUG] Found by clienteCodigo:', cliente.nombre);
          return `${cliente.nombre} (${cliente.codigo})`;
        }
      }

      // Strategy 2: Extract base code from vendedor codes like "407_rmpNpzeT" -> "407"
      if (order.clienteCodigo && order.clienteCodigo.includes('_')) {
        const baseCode = order.clienteCodigo.split('_')[0];
        console.log('🔍 [CLIENT DEBUG] Extracted base code:', baseCode);

        const cliente = window.allClients.find(c => c.codigo === baseCode);
        if (cliente) {
          console.log('✅ [CLIENT DEBUG] Found by base code:', cliente.nombre);
          return `${cliente.nombre} (${cliente.codigo})`;
        }
      }

      // Strategy 3: Try to find by clienteNombre first (prioritize over emails)
      if (order.clienteNombre && order.clienteNombre !== order.usuarioEmail && order.clienteNombre !== order.clienteEmail && window.allClients) {
        const cliente = window.allClients.find(c =>
          c.nombre.toLowerCase().includes(order.clienteNombre.toLowerCase()) ||
          order.clienteNombre.toLowerCase().includes(c.nombre.toLowerCase())
        );
        if (cliente) {
          console.log('✅ [CLIENT DEBUG] Found by clienteNombre:', cliente.nombre);
          return `${cliente.nombre} (${cliente.codigo})`;
        }
        // Si no se encuentra en allClients pero clienteNombre existe y no es un email, usarlo directamente
        if (!order.clienteNombre.includes('@')) {
          console.log('✅ [CLIENT DEBUG] Using clienteNombre directly:', order.clienteNombre);
          return order.clienteNombre;
        }
      }

      // Strategy 4: Search by clienteEmail (not usuarioEmail - admin might have created for a client)
      if (order.clienteEmail && window.allClients) {
        const emailDomain = order.clienteEmail.split('@')[0];
        const cliente = window.allClients.find(c =>
          c.email && c.email.toLowerCase() === order.clienteEmail.toLowerCase() ||
          c.nombre.toLowerCase().includes(emailDomain.toLowerCase()) ||
          emailDomain.toLowerCase().includes(c.nombre.toLowerCase().split(' ')[0])
        );
        if (cliente) {
          console.log('✅ [CLIENT DEBUG] Found by clienteEmail match:', cliente.nombre);
          return `${cliente.nombre} (${cliente.codigo})`;
        }
      }

      // Final fallback - Priorizar clienteNombre sobre emails
      console.log('❌ [CLIENT DEBUG] No client match found, using fallback');
      return `⚠️ ${order.clienteNombre || order.clienteEmail || order.usuarioEmail || 'Sin cliente'} (click para asignar)`;
    }

    // Helper function to get vendedor name
    function getVendedorName(order) {
      if (order.vendedorId && window.sellers) {
        const vendedor = window.sellers.find(v => v.id === order.vendedorId);
        if (vendedor) {
          return vendedor.name || vendedor.nombre || 'Sin nombre';
        }
      }
      return 'Sin vendedor';
    }

    // Edit order client
    function editOrderClient(orderId) {
      const order = window.orders?.find(o => o.id === orderId);
      if (!order || !window.allClients) return;

      // Create modal for client selection
      const modalHTML = `
        <div id="editClientModal" class="modal">
          <div class="modal-content" style="max-width: 600px;">
            <span class="close-button" onclick="closeEditClientModal()">&times;</span>
            <h2>📋 Cambiar Cliente Principal</h2>
            <p>Orden: <strong>#${order.manualOrderNumber || order.numeroOrden}</strong></p>

            <div style="margin: 20px 0;">
              <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                Cliente Principal:
              </label>
              <select id="clientSelect" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 4px; font-size: 16px;">
                <option value="">-- Seleccionar Cliente --</option>
                ${window.allClients.map(cliente => `
                  <option value="${cliente.codigo}" ${order.clienteCodigo === cliente.codigo ? 'selected' : ''}>
                    ${cliente.nombre} (${cliente.codigo})
                  </option>
                `).join('')}
              </select>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
              <button type="button" class="mdc-button mdc-button--outlined" onclick="closeEditClientModal()">
                <span class="mdc-button__label">Cancelar</span>
              </button>
              <button type="button" class="mdc-button mdc-button--raised" onclick="saveOrderClient('${orderId}')" style="background-color: #4CAF50;">
                <span class="mdc-button__label">✅ Guardar</span>
              </button>
            </div>
          </div>
        </div>
      `;

      // Remove existing modal if any
      const existingModal = document.getElementById('editClientModal');
      if (existingModal) existingModal.remove();

      // Add modal to document
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      document.getElementById('editClientModal').classList.remove('hidden');
    }

    // Edit order seller
    function editOrderSeller(orderId) {
      const order = window.orders?.find(o => o.id === orderId);
      if (!order || !window.sellers) return;

      // Create modal for seller selection
      const modalHTML = `
        <div id="editSellerModal" class="modal">
          <div class="modal-content" style="max-width: 600px;">
            <span class="close-button" onclick="closeEditSellerModal()">&times;</span>
            <h2>👤 Cambiar Vendedor</h2>
            <p>Orden: <strong>#${order.manualOrderNumber || order.numeroOrden}</strong></p>

            <div style="margin: 20px 0;">
              <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                Vendedor:
              </label>
              <select id="sellerSelect" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 4px; font-size: 16px;">
                <option value="">-- Seleccionar Vendedor --</option>
                ${window.sellers.map(vendedor => `
                  <option value="${vendedor.id}" ${order.vendedorId === vendedor.id ? 'selected' : ''}>
                    ${vendedor.name || vendedor.nombre}
                  </option>
                `).join('')}
              </select>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
              <button type="button" class="mdc-button mdc-button--outlined" onclick="closeEditSellerModal()">
                <span class="mdc-button__label">Cancelar</span>
              </button>
              <button type="button" class="mdc-button mdc-button--raised" onclick="saveOrderSeller('${orderId}')" style="background-color: #4CAF50;">
                <span class="mdc-button__label">✅ Guardar</span>
              </button>
            </div>
          </div>
        </div>
      `;

      // Remove existing modal if any
      const existingModal = document.getElementById('editSellerModal');
      if (existingModal) existingModal.remove();

      // Add modal to document
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      document.getElementById('editSellerModal').classList.remove('hidden');
    }

    // Close modals
    function closeEditClientModal() {
      const modal = document.getElementById('editClientModal');
      if (modal) modal.remove();
    }

    function closeEditSellerModal() {
      const modal = document.getElementById('editSellerModal');
      if (modal) modal.remove();
    }

    // Save order client changes
    async function saveOrderClient(orderId) {
      const clientSelect = document.getElementById('clientSelect');
      const selectedClientCode = clientSelect.value;

      if (!selectedClientCode) {
        alert('⚠️ Por favor selecciona un cliente');
        return;
      }

      try {
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        // Find the selected client
        const selectedClient = window.allClients.find(c => c.codigo === selectedClientCode);
        if (!selectedClient) {
          alert('❌ Cliente no encontrado');
          return;
        }

        const orderRef = doc(db, 'pedidos', orderId);
        await updateDoc(orderRef, {
          clienteCodigo: selectedClientCode,
          clienteNombre: selectedClient.nombre,
          clienteUpdatedAt: new Date(),
          clienteUpdatedBy: firebase.auth().currentUser?.uid
        });

        console.log(`✅ Cliente actualizado para orden ${orderId}: ${selectedClient.nombre} (${selectedClientCode})`);

        // Update local order data
        const order = window.orders.find(o => o.id === orderId);
        if (order) {
          order.clienteCodigo = selectedClientCode;
          order.clienteNombre = selectedClient.nombre;
        }

        // Close modal and refresh display
        closeEditClientModal();
        await loadOrders();

        alert(`✅ Cliente actualizado: ${selectedClient.nombre}`);

      } catch (error) {
        console.error('❌ Error updating order client:', error);
        alert('Error al actualizar el cliente: ' + error.message);
      }
    }

    // Save order seller changes
    async function saveOrderSeller(orderId) {
      const sellerSelect = document.getElementById('sellerSelect');
      const selectedSellerId = sellerSelect.value;

      if (!selectedSellerId) {
        alert('⚠️ Por favor selecciona un vendedor');
        return;
      }

      try {
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        // Find the selected seller
        const selectedSeller = window.sellers.find(s => s.id === selectedSellerId);
        if (!selectedSeller) {
          alert('❌ Vendedor no encontrado');
          return;
        }

        const orderRef = doc(db, 'pedidos', orderId);
        await updateDoc(orderRef, {
          vendedorId: selectedSellerId,
          vendedorUpdatedAt: new Date(),
          vendedorUpdatedBy: firebase.auth().currentUser?.uid
        });

        console.log(`✅ Vendedor actualizado para orden ${orderId}: ${selectedSeller.name || selectedSeller.nombre}`);

        // Update local order data
        const order = window.orders.find(o => o.id === orderId);
        if (order) {
          order.vendedorId = selectedSellerId;
        }

        // Close modal and refresh display
        closeEditSellerModal();
        await loadOrders();

        alert(`✅ Vendedor actualizado: ${selectedSeller.name || selectedSeller.nombre}`);

      } catch (error) {
        console.error('❌ Error updating order seller:', error);
        alert('Error al actualizar el vendedor: ' + error.message);
      }
    }

    // Helper function to format numbers
    function formatNumber(num) {
      return Number(num).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Generar PDF de la orden
    async function generateOrderPDF(orderData, orderNumber, clienteNombre) {
      try {
        console.log('📄 [PDF] Generando PDF para orden #', orderNumber);

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Colores
        const primaryColor = [76, 175, 80]; // Verde
        const textColor = [51, 51, 51]; // Gris oscuro
        const lightGray = [240, 240, 240];

        // Header con fondo verde
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 40, 'F');

        // Logo (cargar desde la URL del sitio)
        try {
          const logoUrl = window.location.origin + '/logo.png';
          doc.addImage(logoUrl, 'PNG', 14, 12, 15, 12.5);
        } catch (error) {
          console.warn('⚠️ No se pudo cargar el logo:', error);
        }

        // Título
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont(undefined, 'bold');
        doc.text('ORDEN DE COMPRA', 105, 18, { align: 'center' });

        doc.setFontSize(18);
        doc.text(`#${orderNumber}`, 105, 28, { align: 'center' });

        // Información del cliente
        let yPos = 50;
        doc.setTextColor(...textColor);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('INFORMACIÓN DEL CLIENTE', 14, yPos);

        yPos += 8;
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        // Formato: Cliente NOMBRE, CODIGO XXX
        const clienteTexto = orderData.clienteCodigo ? `${clienteNombre}, CODIGO ${orderData.clienteCodigo}` : clienteNombre;
        doc.text(`Cliente: ${clienteTexto}`, 14, yPos);
        yPos += 6;
        // Mostrar email del usuario que hizo la orden
        const emailUsuario = orderData.creadoPorAdmin ? orderData.usuarioEmail : (orderData.clienteEmail || orderData.usuarioEmail);
        doc.text(`Email: ${emailUsuario}`, 14, yPos);
        yPos += 6;
        doc.text(`Fecha: ${orderData.fechaLocal || orderData.fechaEdicionLocal || new Date().toLocaleString('es-AR')}`, 14, yPos);

        if (orderData.creadoPorAdmin) {
          yPos += 6;
          doc.setTextColor(255, 152, 0); // Naranja
          doc.text(`Creada por: ${orderData.usuarioEmail} (Admin)`, 14, yPos);
          doc.setTextColor(...textColor);
        }

        if (orderData.editadaPorNombre) {
          yPos += 6;
          doc.setTextColor(255, 152, 0); // Naranja
          doc.text(`Modificada por: ${orderData.editadaPorNombre}`, 14, yPos);
          doc.setTextColor(...textColor);
        }

        // Tabla de productos
        yPos += 12;

        const tableData = orderData.items.map((item, index) => {
          // Show 'x' if prices are paused globally
          const priceDisplay = window.pricesPausedGlobal ? 'x' : '$' + formatNumber(item.price);
          const subtotalDisplay = window.pricesPausedGlobal ? 'x' : '$' + formatNumber(item.quantity * item.price);

          return [
            index + 1,
            item.articulo || '',
            item.description || '',
            item.quantity,
            priceDisplay,
            subtotalDisplay
          ];
        });

        doc.autoTable({
          startY: yPos,
          head: [['#', 'Código', 'Descripción', 'Cant.', 'Precio Unit.', 'Subtotal']],
          body: tableData,
          theme: 'grid',
          headStyles: {
            fillColor: primaryColor,
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            halign: 'center'
          },
          columnStyles: {
            0: { halign: 'center', cellWidth: 10 },
            1: { halign: 'left', cellWidth: 25 },
            2: { halign: 'left', cellWidth: 80 },
            3: { halign: 'center', cellWidth: 20 },
            4: { halign: 'right', cellWidth: 30 },
            5: { halign: 'right', cellWidth: 30 }
          },
          styles: {
            fontSize: 9,
            cellPadding: 3
          }
        });

        // Total
        const finalY = doc.lastAutoTable.finalY || yPos;
        yPos = finalY + 10;

        doc.setFillColor(...lightGray);
        doc.rect(125, yPos - 5, 71, 12, 'F');

        doc.setFont(undefined, 'bold');
        doc.setFontSize(14);
        doc.setTextColor(...textColor);
        doc.text('TOTAL:', 130, yPos + 2);
        doc.setFontSize(16);
        doc.setTextColor(...primaryColor);
        // Show 'x' for total if prices are paused globally
        const totalDisplay = window.pricesPausedGlobal ? 'x' : '$' + formatNumber(orderData.total);
        doc.text(totalDisplay, 191, yPos + 2, { align: 'right' });

        // Footer
        doc.setTextColor(150, 150, 150);
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        doc.text('Generado automáticamente por el sistema', 105, 285, { align: 'center' });
        doc.text(new Date().toLocaleString('es-AR'), 105, 290, { align: 'center' });

        console.log('✅ [PDF] PDF generado exitosamente');
        return doc;

      } catch (error) {
        console.error('❌ [PDF] Error generando PDF:', error);
        throw error;
      }
    }

    /**
     * Subir PDF a Firebase Storage y obtener URL de descarga
     * @param {jsPDF} pdfDoc - Documento PDF generado con jsPDF
     * @param {string} orderNumber - Número de orden para nombrar el archivo
     * @returns {Promise<string>} URL de descarga del PDF o placeholder en localhost
     * @version 0.39
     *
     * Funcionalidad:
     * - En localhost: Descarga el PDF directamente (evita CORS)
     * - En producción: Sube el PDF a Firebase Storage y retorna URL pública
     * - Usa bucket: carrito-138c3.firebasestorage.app
     * - CORS configurado para: localhost:3002, stock.south-traders.com, *.vercel.app
     */
    async function uploadOrderPDF(pdfDoc, orderNumber) {
      try {
        // Detectar si estamos en localhost (evita errores CORS en desarrollo)
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        if (isLocalhost) {
          console.log('⚠️ [Storage] Detectado localhost - Descargando PDF localmente (CORS bloqueado)');

          // Descargar PDF directamente al dispositivo del usuario
          pdfDoc.save(`orden-${orderNumber}.pdf`);

          // Retornar URL placeholder para mensaje WhatsApp
          return `[PDF descargado localmente - orden-${orderNumber}.pdf]`;
        }

        console.log('☁️ [Storage] Subiendo PDF a Firebase Storage...');

        const { ref, uploadBytes, getDownloadURL } = window.firebase.storageHelpers;
        const storage = window.firebase.storage();

        // Convertir PDF a blob
        const pdfBlob = pdfDoc.output('blob');

        // Crear referencia en Storage
        const fileName = `orders/orden-${orderNumber}-${Date.now()}.pdf`;
        const storageRef = ref(storage, fileName);

        // Subir archivo
        const snapshot = await uploadBytes(storageRef, pdfBlob, {
          contentType: 'application/pdf'
        });

        console.log('✅ [Storage] PDF subido exitosamente');

        // Obtener URL de descarga
        const downloadURL = await getDownloadURL(snapshot.ref);
        console.log('✅ [Storage] URL de descarga obtenida:', downloadURL);

        return downloadURL;

      } catch (error) {
        console.error('❌ [Storage] Error subiendo PDF:', error);
        throw error;
      }
    }

    // Enviar orden al vendedor por WhatsApp
    async function sendOrderToSellerWhatsApp(orderData, orderNumber, clienteNombre) {
      try {
        console.log('📱 [WhatsApp] Iniciando envío...');
        console.log('📱 [WhatsApp] orderData.vendedorId:', orderData.vendedorId);
        console.log('📱 [WhatsApp] orderNumber:', orderNumber);
        console.log('📱 [WhatsApp] clienteNombre:', clienteNombre);

        const { doc, getDoc, collection, query, where, getDocs } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();

        let vendedorData = null;
        let vendedorId = orderData.vendedorId;

        // Si no hay vendedor asignado, buscar a Santiago como vendedor por defecto
        if (!vendedorId) {
          console.log('⚠️ [WhatsApp] No hay vendedor asignado, buscando a Santiago Fernandez...');
          const vendedoresRef = collection(db, 'vendedores');
          const q = query(vendedoresRef, where('email', '==', 'santifn.axp@gmail.com'));
          const querySnapshot = await getDocs(q);

          if (!querySnapshot.empty) {
            const santiagoDoc = querySnapshot.docs[0];
            vendedorId = santiagoDoc.id;
            vendedorData = santiagoDoc.data();
            console.log('✅ [WhatsApp] Santiago Fernandez encontrado como vendedor por defecto:', vendedorId);
          } else {
            console.log('❌ [WhatsApp] No se encontró a Santiago Fernandez (santifn.axp@gmail.com) en la BD');
            return;
          }
        } else {
          console.log('📱 [WhatsApp] Buscando vendedor:', vendedorId);
          const vendedorRef = doc(db, 'vendedores', vendedorId);
          const vendedorDoc = await getDoc(vendedorRef);

          if (!vendedorDoc.exists()) {
            console.log('⚠️ [WhatsApp] Vendedor no encontrado en BD');
            return;
          }

          vendedorData = vendedorDoc.data();
        }

        console.log('📱 [WhatsApp] Vendedor encontrado:', vendedorData.name);
        console.log('📱 [WhatsApp] Teléfonos:', { phone: vendedorData.phone, phone2: vendedorData.phone2 });

        // Obtener ambos teléfonos del vendedor
        const phones = [];
        if (vendedorData.phone || vendedorData.telefono) {
          phones.push((vendedorData.phone || vendedorData.telefono).replace(/\D/g, ''));
        }
        if (vendedorData.phone2) {
          phones.push(vendedorData.phone2.replace(/\D/g, ''));
        }

        console.log('📱 [WhatsApp] Teléfonos procesados:', phones);

        if (phones.length === 0) {
          console.log('⚠️ [WhatsApp] Vendedor sin teléfono válido');
          return;
        }

        // Generar PDF
        console.log('📄 [WhatsApp] Generando PDF de la orden...');
        const pdfDoc = await generateOrderPDF(orderData, orderNumber, clienteNombre);

        // Subir PDF a Firebase Storage
        console.log('☁️ [WhatsApp] Subiendo PDF a Firebase Storage...');
        const pdfUrl = await uploadOrderPDF(pdfDoc, orderNumber);

        // Detectar si estamos en localhost
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // Construir mensaje con enlace al PDF
        let mensaje = `🔄 *ORDEN MODIFICADA #${orderNumber}*\n\n`;

        if (isLocalhost) {
          mensaje += `⚠️ *MODO DESARROLLO (localhost)*\n`;
          mensaje += `📋 PDF descargado localmente: ${pdfUrl}\n`;
          mensaje += `ℹ️ En producción se enviará el enlace al PDF\n\n`;
        } else {
          mensaje += `📄 *ORDEN COMPLETA EN PDF - CLICK AQUÍ:*\n`;
          mensaje += `${pdfUrl}\n`;
          mensaje += `👆 _Hace clic en el enlace para ver/descargar el PDF completo_\n\n`;
        }
        // Formato: Cliente NOMBRE, CODIGO XXX, EMAIL: usuario@email.com
        const clienteTexto = orderData.clienteCodigo ? `${clienteNombre}, CODIGO ${orderData.clienteCodigo}` : clienteNombre;
        const emailUsuario = orderData.creadoPorAdmin ? orderData.usuarioEmail : (orderData.clienteEmail || orderData.usuarioEmail);
        mensaje += `👤 *Cliente:* ${clienteTexto}\n`;
        mensaje += `📧 *Email:* ${emailUsuario}\n`;
        if (orderData.editadaPorNombre) {
          mensaje += `✏️ *Modificada por:* ${orderData.editadaPorNombre}\n`;
        }
        mensaje += `📅 *Fecha:* ${orderData.fechaLocal || new Date().toLocaleString('es-AR')}\n\n`;
        mensaje += `📦 *Productos:* ${orderData.cantidadItems || orderData.items?.length || 0} items\n`;
        // Show 'x' for total if prices are paused globally
        const totalDisplay = window.pricesPausedGlobal ? 'x' : '$' + formatNumber(orderData.total);
        mensaje += `💰 *TOTAL: ${totalDisplay}*\n\n`;
        mensaje += `✅ Descargá el PDF para ver el detalle completo`;

        // Enviar WhatsApp a todos los teléfonos del vendedor
        console.log('📱 [WhatsApp] Preparando para enviar a', phones.length, 'teléfono(s)');

        phones.forEach((phone, index) => {
          const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(mensaje)}`;
          console.log(`📱 [WhatsApp] URL ${index + 1}:`, whatsappUrl.substring(0, 100) + '...');

          // Pequeño delay entre aperturas para evitar que se bloqueen
          setTimeout(() => {
            console.log(`📱 [WhatsApp] Abriendo ventana ${index + 1}/${phones.length} para ${phone}`);
            window.open(whatsappUrl, '_blank');
            console.log(`✅ [WhatsApp] Ventana ${index + 1}/${phones.length} abierta para ${phone}`);
          }, index * 500);
        });

        console.log(`✅ [WhatsApp] Proceso completado - ${phones.length} teléfono(s)`);

      } catch (error) {
        console.error('❌ Error enviando WhatsApp:', error);
      }
    }

    /**
     * Maneja el click en el botón de foto (v0.42)
     * @param {string} orderId - ID de la orden
     * @param {string} photoUrl - URL de la foto actual (vacío si no hay)
     */
    window.handleFotoButton = function(orderId, photoUrl) {
      if (!photoUrl) {
        // No hay foto, mostrar opciones de galería o cámara
        showPhotoOptionsModal(orderId);
      } else {
        // Ya hay foto, preguntar si quiere ver o actualizar
        const accion = confirm('Ya hay una foto subida.\n\n✅ OK = Subir nueva foto\n❌ Cancelar = Ver foto actual');

        if (accion) {
          // Usuario eligió OK: mostrar opciones para nueva foto
          showPhotoOptionsModal(orderId);
        } else {
          // Usuario eligió Cancelar: ver foto actual
          window.open(photoUrl, '_blank');
        }
      }
    }

    /**
     * Muestra modal con opciones de galería o cámara
     * @param {string} orderId - ID de la orden
     */
    function showPhotoOptionsModal(orderId) {
      // Crear modal con opciones
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;

      const content = document.createElement('div');
      content.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        max-width: 350px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      `;

      content.innerHTML = `
        <h3 style="margin: 0 0 20px 0; color: #333;">📸 Seleccionar Foto</h3>
        <p style="margin: 0 0 25px 0; color: #666;">¿Cómo quieres agregar la foto?</p>
        <div style="display: flex; gap: 15px; flex-direction: column;">
          <button onclick="selectFromGallery('${orderId}'); closePhotoModal()"
                  style="padding: 15px; border: none; background: #4CAF50; color: white; border-radius: 8px; cursor: pointer; font-size: 16px;">
            📁 Cargar Foto Guardada
          </button>
          <button onclick="captureWithCamera('${orderId}'); closePhotoModal()"
                  style="padding: 15px; border: none; background: #2196F3; color: white; border-radius: 8px; cursor: pointer; font-size: 16px;">
            📷 Abrir Cámara
          </button>
          <button onclick="closePhotoModal()"
                  style="padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; cursor: pointer;">
            Cancelar
          </button>
        </div>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);
      modal.photoModal = true;

      // Cerrar modal al hacer click fuera
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closePhotoModal();
        }
      });
    }

    /**
     * Cierra el modal de opciones de foto
     */
    window.closePhotoModal = function() {
      const modal = document.querySelector('[style*="z-index: 10000"]');
      if (modal && modal.photoModal) {
        modal.remove();
      }
    }

    /**
     * Abre galería para seleccionar foto
     * @param {string} orderId - ID de la orden
     */
    window.selectFromGallery = function(orderId) {
      document.getElementById('photo-input-' + orderId).click();
    }

    /**
     * Abre cámara para capturar foto
     * @param {string} orderId - ID de la orden
     */
    window.captureWithCamera = async function(orderId) {
      try {
        // Check if getUserMedia is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('❌ Tu navegador no soporta acceso directo a la cámara.\n\nUsando selector de archivos como alternativa.');
          document.getElementById('camera-input-' + orderId).click();
          return;
        }

        // Request camera access
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }, // Prefer back camera on mobile
          audio: false
        });

        // Create camera modal
        const cameraModal = document.createElement('div');
        cameraModal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.95);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          padding: 20px;
          box-sizing: border-box;
        `;

        const video = document.createElement('video');
        video.autoplay = true;
        video.playsInline = true;
        video.style.cssText = `
          max-width: 100%;
          max-height: 70vh;
          border-radius: 8px;
          margin-bottom: 20px;
        `;
        video.srcObject = stream;

        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
          display: flex;
          gap: 15px;
          flex-wrap: wrap;
          justify-content: center;
        `;

        const captureBtn = document.createElement('button');
        captureBtn.textContent = '📸 Capturar Foto';
        captureBtn.style.cssText = `
          padding: 15px 30px;
          background: #4CAF50;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
        `;

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = '❌ Cancelar';
        cancelBtn.style.cssText = `
          padding: 15px 30px;
          background: #f44336;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
        `;

        // Capture photo
        captureBtn.addEventListener('click', () => {
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);

          // Convert canvas to blob
          canvas.toBlob(async (blob) => {
            // Stop camera
            stream.getTracks().forEach(track => track.stop());
            document.body.removeChild(cameraModal);

            // Create file from blob
            const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });

            // Create a temporary input to trigger handlePreparacionPhoto
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            const input = document.getElementById('camera-input-' + orderId);
            if (input) {
              input.files = dataTransfer.files;
              await handlePreparacionPhoto(orderId, input);
            }
          }, 'image/jpeg', 0.95);
        });

        // Cancel camera
        cancelBtn.addEventListener('click', () => {
          stream.getTracks().forEach(track => track.stop());
          document.body.removeChild(cameraModal);
        });

        buttonContainer.appendChild(captureBtn);
        buttonContainer.appendChild(cancelBtn);
        cameraModal.appendChild(video);
        cameraModal.appendChild(buttonContainer);
        document.body.appendChild(cameraModal);

      } catch (error) {
        console.error('Error accessing camera:', error);
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          alert('❌ Permiso de cámara denegado.\n\nPor favor permite el acceso a la cámara en la configuración de tu navegador.');
        } else if (error.name === 'NotFoundError') {
          alert('❌ No se encontró ninguna cámara en tu dispositivo.');
        } else {
          alert('❌ Error al acceder a la cámara: ' + error.message);
        }
        // Fallback to file input
        document.getElementById('camera-input-' + orderId).click();
      }
    }

    /**
     * Maneja la subida de foto para orden en preparación (v0.40)
     * @param {string} orderId - ID de la orden
     * @param {HTMLInputElement} inputElement - Elemento input[type=file]
     */
    window.handlePreparacionPhoto = async function(orderId, inputElement) {
      if (!window.isUserAdmin) {
        alert('⚠️ No tienes permisos para actualizar fotos');
        return;
      }

      const file = inputElement.files[0];
      if (!file) return;

      // Validar que sea una imagen
      if (!file.type.startsWith('image/')) {
        alert('❌ Por favor selecciona un archivo de imagen válido');
        inputElement.value = '';
        return;
      }

      // Validar tamaño (máximo 5MB)
      const maxSize = 5 * 1024 * 1024; // 5MB
      if (file.size > maxSize) {
        alert('❌ La imagen es muy grande. Máximo 5MB permitido.');
        inputElement.value = '';
        return;
      }

      try {
        console.log('📸 [Preparación] Subiendo foto para orden:', orderId);

        // Mostrar indicador de carga
        const loadingMsg = document.createElement('div');
        loadingMsg.textContent = '⏳ Subiendo foto...';
        loadingMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 15px 20px; border-radius: 4px; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
        document.body.appendChild(loadingMsg);

        const { ref, uploadBytes, getDownloadURL } = window.firebase.storageHelpers;
        const storage = window.firebase.storage();

        // Subir foto a Storage
        const fileName = `preparacion/orden-${orderId}-${Date.now()}.${file.name.split('.').pop()}`;
        const storageRef = ref(storage, fileName);

        const snapshot = await uploadBytes(storageRef, file, {
          contentType: file.type
        });

        const downloadURL = await getDownloadURL(snapshot.ref);

        // Actualizar Firestore
        const { doc, updateDoc, serverTimestamp } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();
        const orderRef = doc(db, 'pedidos', orderId);

        await updateDoc(orderRef, {
          fotoPreparacion: downloadURL,
          fotoPreparacionUpdatedAt: serverTimestamp(),
          fotoPreparacionUpdatedBy: window.firebase.auth().currentUser?.email || 'admin'
        });

        console.log('✅ [Preparación] Foto subida exitosamente:', downloadURL);

        // Remover mensaje de carga
        loadingMsg.textContent = '✅ Foto guardada';
        setTimeout(() => loadingMsg.remove(), 2000);

        // Recargar órdenes para mostrar la foto
        await loadOrders();

      } catch (error) {
        console.error('❌ [Preparación] Error al subir foto:', error);
        alert('❌ Error al subir la foto: ' + error.message);
        inputElement.value = '';

        // Remover mensaje de carga si existe
        const loadingMsg = document.querySelector('div[style*="fixed"]');
        if (loadingMsg) loadingMsg.remove();
      }
    }

    /**
     * Muestra prompt para ingresar peso de preparación (v0.40)
     * @param {string} orderId - ID de la orden
     * @param {string} pesoActual - Peso actual (puede estar vacío)
     */
    window.promptPesoPreparacion = function(orderId, pesoActual) {
      const mensaje = pesoActual
        ? `Peso actual: ${pesoActual} kg\n\nIngresa el nuevo peso en kg (o deja vacío para borrar):`
        : 'Ingresa el peso en kg:';

      const peso = prompt(mensaje, pesoActual || '');

      // Si el usuario cancela, no hacer nada
      if (peso === null) return;

      // Llamar a la función que guarda el peso
      window.handlePreparacionPeso(orderId, peso);
    }

    /**
     * Maneja la actualización del peso para orden en preparación (v0.40)
     * @param {string} orderId - ID de la orden
     * @param {string} peso - Peso en kg
     */
    window.handlePreparacionPeso = async function(orderId, peso) {
      if (!window.isUserAdmin) {
        alert('⚠️ No tienes permisos para actualizar el peso');
        return;
      }

      // Validar que sea un número válido
      const pesoNum = parseFloat(peso);
      if (peso && (isNaN(pesoNum) || pesoNum < 0)) {
        alert('❌ Por favor ingresa un peso válido (número positivo)');
        return;
      }

      try {
        console.log('⚖️ [Preparación] Actualizando peso para orden:', orderId, '→', peso, 'kg');

        const { doc, updateDoc, serverTimestamp } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();
        const orderRef = doc(db, 'pedidos', orderId);

        await updateDoc(orderRef, {
          pesoPreparacion: peso ? pesoNum : null,
          pesoPreparacionUpdatedAt: serverTimestamp(),
          pesoPreparacionUpdatedBy: window.firebase.auth().currentUser?.email || 'admin'
        });

        console.log('✅ [Preparación] Peso actualizado exitosamente');

        // Mostrar confirmación breve
        const successMsg = document.createElement('div');
        successMsg.textContent = '✅ Peso guardado';
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 10px 15px; border-radius: 4px; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 1500);

        // Recargar órdenes para mostrar el peso actualizado
        await loadOrders();

      } catch (error) {
        console.error('❌ [Preparación] Error al actualizar peso:', error);
        alert('❌ Error al guardar el peso: ' + error.message);
      }
    }

    // Admin move order to next state
    async function adminMoveOrder(orderId, nextState) {
      if (!window.isUserAdmin) {
        alert('⚠️ No tienes permisos para cambiar el estado de las órdenes');
        return;
      }

      if (!firebase || !firebase.firestore) {
        console.error('❌ Firebase not available');
        return;
      }

      // Special case: moving from revision to aprobada requires manual order number
      if (nextState === 'aprobada') {
        const order = window.orders?.find(o => o.id === orderId);
        if (order && order.logisticsState === 'revision') {
          showManualOrderNumberModal(orderId);
          return;
        }
      }

      try {
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', orderId);
        await updateDoc(orderRef, {
          logisticsState: nextState,
          lastStateUpdate: new Date()
        });

        console.log(`✅ Order ${orderId} moved to ${nextState}`);

        // Reload orders to reflect changes
        await loadOrders();

      } catch (error) {
        console.error('❌ Error moving order:', error);
        alert('Error al cambiar el estado de la orden');
      }
    }

    // Show manual order number modal
    function showManualOrderNumberModal(orderId) {
      const modal = document.getElementById('manualOrderNumberModal');
      const input = document.getElementById('manualOrderNumber');

      // Clear previous input
      input.value = '';
      input.style.borderColor = '#ddd';

      // Store orderId for later use
      modal.dataset.orderId = orderId;

      // Show modal
      modal.classList.remove('hidden');

      // Focus on input
      setTimeout(() => input.focus(), 100);

      console.log(`📋 Manual order number modal shown for order ${orderId}`);
    }

    // Confirm manual order number and approve order
    async function confirmManualOrderNumber() {
      console.log('🔍 [DEBUG] confirmManualOrderNumber called');

      const modal = document.getElementById('manualOrderNumberModal');
      const input = document.getElementById('manualOrderNumber');
      const errorMsg = document.getElementById('manualOrderNumberError');
      const orderId = modal.dataset.orderId;

      console.log('🔍 [DEBUG] Modal:', modal);
      console.log('🔍 [DEBUG] Input:', input);
      console.log('🔍 [DEBUG] Order ID:', orderId);

      // Validate input
      const manualNumber = input.value.trim();
      console.log('🔍 [DEBUG] Manual Number:', manualNumber);

      if (!manualNumber) {
        input.style.borderColor = '#f44336';
        errorMsg.textContent = 'Por favor ingresa un número de orden';
        errorMsg.style.display = 'block';
        return;
      }

      try {
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', orderId);
        await updateDoc(orderRef, {
          logisticsState: 'aprobada',
          lastStateUpdate: new Date(),
          manualOrderNumber: manualNumber
        });

        console.log(`✅ Order ${orderId} approved with manual number ${manualNumber}`);

        // Hide modal
        modal.classList.add('hidden');

        // Show success message
        alert(`✅ Orden aprobada con número: ${manualNumber}`);

        // Reload orders to reflect changes using the correct function for MASTER tab
        if (window.loadOrders) {
          await window.loadOrders();
        } else {
          console.warn('⚠️ window.loadOrders not available, trying loadLogisticsOrders');
          setTimeout(() => {
            loadLogisticsOrders();
          }, 300);
        }

      } catch (error) {
        console.error('❌ Error approving order:', error);
        errorMsg.textContent = 'Error al aprobar la orden: ' + error.message;
        errorMsg.style.display = 'block';
      }
    }

    // Expose function globally for debugging
    window.confirmManualOrderNumber = confirmManualOrderNumber;
    console.log('✅ [INIT] confirmManualOrderNumber exposed to window');

    // Setup event listeners for manual order number modal
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🔧 [INIT] DOMContentLoaded - Setting up manual order number listeners');

      const confirmBtn = document.getElementById('confirmManualOrderNumber');
      const input = document.getElementById('manualOrderNumber');

      console.log('🔍 [INIT] confirmBtn element:', confirmBtn);
      console.log('🔍 [INIT] input element:', input);

      if (confirmBtn) {
        console.log('✅ [INIT] Attaching click listener to confirm button');
        confirmBtn.addEventListener('click', function(e) {
          console.log('🖱️ [DEBUG] Confirm button clicked!', e);
          confirmManualOrderNumber();
        });
      } else {
        console.error('❌ [INIT] Confirm button NOT found!');
      }

      if (input) {
        console.log('✅ [INIT] Attaching keypress listener to input');
        // Allow Enter key to confirm
        input.addEventListener('keypress', function(e) {
          console.log('⌨️ [DEBUG] Key pressed:', e.key);
          if (e.key === 'Enter') {
            console.log('↩️ [DEBUG] Enter key pressed, calling confirmManualOrderNumber');
            confirmManualOrderNumber();
          }
        });

        // Clear error on input change
        input.addEventListener('input', function() {
          input.style.borderColor = '#ddd';
          const errorMsg = document.getElementById('manualOrderNumberError');
          if (errorMsg) errorMsg.style.display = 'none';
        });
      }
    });

    // Show order details in modal for all users (read-only for non-admins)
    window.showOrderDetails = async function(orderId) {
      try {
        console.log('🔍 [MODAL] Searching for order:', orderId);

        // First try to find in current orders
        let order = window.currentOrders?.find(o => o.id === orderId);

        // If not found in cache, search in Firebase
        if (!order) {
          console.log('⚠️ Order not found in cache, searching in Firebase...');
          const { doc, getDoc } = window.firebase.firestoreHelpers;
          const db = window.firebase.firestore();
          const orderRef = doc(db, 'pedidos', orderId);
          const orderDoc = await getDoc(orderRef);

          if (orderDoc.exists()) {
            order = { id: orderDoc.id, ...orderDoc.data() };
            console.log('✅ Order found in Firebase:', orderId);
          } else {
            console.error('❌ Order not found in Firebase:', orderId);
            alert('Error: Orden no encontrada');
            return;
          }
        }

        console.log('🔍 [MODAL] Showing order details for:', orderId);

        const stateLabels = {
          borrador: 'Borrador',
          revision: 'En Revisión',
          aprobada: 'Aprobada',
          preparacion: 'En Preparación',
          listo: 'Listo para Retiro/Despacho',
          despachada: 'Despachada',
          entregada: 'Entregada',
          cerrada: 'Cerrada',
          cancelada: 'Cancelada'
        };

        // Llenar información general
        let orderNumberText = `#${order.manualOrderNumber || order.numeroOrden || order.id.slice(-6)}`;
        if (order.editadaPor && order.editadaPorNombre) {
          orderNumberText += ` <span style="color: #FF9800; font-size: 0.85em;">(editada por ${order.editadaPorNombre})</span>`;
        }
        document.getElementById('detailOrderNumber').innerHTML = orderNumberText;

        // Formato: Cliente NOMBRE, CODIGO XXX, EMAIL: usuario@email.com
        const emailUsuario = order.creadoPorAdmin ? order.usuarioEmail : (order.clienteEmail || order.usuarioEmail);
        const infoCliente = order.clienteNombre || order.usuarioEmail || '-';
        const codigoCliente = order.clienteCodigo ? `, CODIGO ${order.clienteCodigo}` : '';
        document.getElementById('detailClientName').textContent = `${infoCliente}${codigoCliente}`;
        document.getElementById('detailClientEmail').textContent = emailUsuario || '-';
        document.getElementById('detailOrderDate').textContent = order.fechaLocal || '-';
        document.getElementById('detailOrderState').textContent = stateLabels[order.logisticsState] || order.logisticsState || 'Sin estado';

        // Mostrar si fue creada por admin
        if (order.creadoPorAdmin) {
          document.getElementById('detailAdminCreatedContainer').style.display = 'grid';
          document.getElementById('detailAdminCreated').textContent = order.usuarioEmail || '-';
        } else {
          document.getElementById('detailAdminCreatedContainer').style.display = 'none';
        }

        // Mostrar foto y peso de preparación para todos los usuarios
        const photoWeightContainer = document.getElementById('detailPhotoWeightContainer');
        const photoContainer = document.getElementById('detailPhotoContainer');
        const weightContainer = document.getElementById('detailWeightContainer');
        const noPhotoWeight = document.getElementById('detailNoPhotoWeight');
        const photoImg = document.getElementById('detailPhotoImg');
        const photoDate = document.getElementById('detailPhotoDate');
        const weightSpan = document.getElementById('detailWeight');

        let hasPhotoOrWeight = false;

        // Mostrar foto si existe
        if (order.fotoPreparacion) {
          photoImg.src = order.fotoPreparacion;

          // Mostrar fecha de actualización si existe
          if (order.fotoPreparacionUpdatedAt) {
            const fecha = new Date(order.fotoPreparacionUpdatedAt.seconds * 1000);
            photoDate.textContent = `Subida el: ${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString()}`;
          } else {
            photoDate.textContent = '';
          }

          photoContainer.style.display = 'grid';
          hasPhotoOrWeight = true;
        } else {
          photoContainer.style.display = 'none';
        }

        // Mostrar peso si existe
        if (order.pesoPreparacion) {
          weightSpan.textContent = `${order.pesoPreparacion} kg`;
          weightContainer.style.display = 'grid';
          hasPhotoOrWeight = true;
        } else {
          weightContainer.style.display = 'none';
        }

        // Mostrar la sección completa si hay foto o peso
        if (hasPhotoOrWeight) {
          photoWeightContainer.style.display = 'block';
          noPhotoWeight.style.display = 'none';
        } else {
          // Mostrar mensaje si no hay foto ni peso
          photoWeightContainer.style.display = 'block';
          noPhotoWeight.style.display = 'block';
        }

        // Llenar tabla de items (solo lectura para no-admins)
        const itemsTableBody = document.getElementById('detailOrderItems');
        itemsTableBody.innerHTML = '';

        if (order.items && order.items.length > 0) {
          order.items.forEach((item, index) => {
            const row = document.createElement('tr');
            // Show 'x' if prices are paused globally
            const priceDisplay = window.pricesPausedGlobal ? 'x' : formatNumber(item.price || 0);
            const subtotalDisplay = window.pricesPausedGlobal ? 'x' : formatNumber((item.price || 0) * (item.quantity || 0));

            row.innerHTML = `
              <td>${item.articulo || '-'}</td>
              <td>${item.description || '-'}</td>
              <td style="text-align: center;">${item.quantity || 0}</td>
              <td style="text-align: right;">${window.pricesPausedGlobal ? priceDisplay : '$' + priceDisplay}</td>
              <td style="text-align: right;">${window.pricesPausedGlobal ? subtotalDisplay : '$' + subtotalDisplay}</td>
            `;
            itemsTableBody.appendChild(row);
          });
        } else {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="5" style="text-align: center;">No hay items</td>`;
          itemsTableBody.appendChild(row);
        }

        // Mostrar total - Show 'x' if prices are paused globally
        const totalDisplay = window.pricesPausedGlobal ? 'x' : '$' + formatNumber(order.total || order.montoTotal || 0);
        document.getElementById('detailOrderTotal').textContent = totalDisplay;

        // Hide admin-only controls for non-admin users
        document.getElementById('detailSaveOrderContainer').style.display = 'none';
        document.getElementById('detailSendWhatsAppContainer').style.display = 'none';
        document.getElementById('detailCopyOppenContainer').style.display = 'none';
        document.getElementById('detailEditOrderContainer').style.display = 'none';

        // Show modal
        document.getElementById('orderDetailsModal').style.display = 'block';

      } catch (error) {
        console.error('❌ Error showing order details:', error);
        alert('Error al cargar detalles de la orden');
      }
    };

    // Show admin order details in modal with editable quantities
    window.adminEditOrder = async function(orderId) {
      if (!window.isUserAdmin) {
        alert('⚠️ No tienes permisos para editar órdenes');
        return;
      }

      try {
        console.log('📋 Mostrando detalles de orden:', orderId);

        const { doc, getDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', orderId);
        const orderDoc = await getDoc(orderRef);

        if (!orderDoc.exists()) {
          alert('❌ Orden no encontrada');
          return;
        }

        const order = { id: orderDoc.id, ...orderDoc.data() };

        // Mapeo de estados
        const stateLabels = {
          borrador: 'Borrador',
          revision: 'En Revisión',
          aprobada: 'Aprobada',
          preparacion: 'En Preparación',
          listo: 'Listo para Retiro/Despacho',
          despachada: 'Despachada',
          entregada: 'Entregada',
          cerrada: 'Cerrada',
          cancelada: 'Cancelada'
        };

        // Llenar información general
        let orderNumberText = `#${order.manualOrderNumber || order.numeroOrden || order.id.slice(-6)}`;
        if (order.editadaPor && order.editadaPorNombre) {
          orderNumberText += ` <span style="color: #FF9800; font-size: 0.85em;">(editada por ${order.editadaPorNombre})</span>`;
        }
        document.getElementById('detailOrderNumber').innerHTML = orderNumberText;
        // Formato: Cliente NOMBRE, CODIGO XXX, EMAIL: usuario@email.com
        // SIEMPRE mostrar el cliente real (clienteEmail), no el admin (usuarioEmail)
        const emailUsuario = order.clienteEmail || order.usuarioEmail;
        const infoCliente = order.clienteNombre || order.clienteEmail || order.usuarioEmail || '-';
        const codigoCliente = order.clienteCodigo ? `, CODIGO ${order.clienteCodigo}` : '';

        // Agregar botón para cambiar cliente
        const clientNameElement = document.getElementById('detailClientName');
        clientNameElement.innerHTML = `
          <span>${infoCliente}${codigoCliente}</span>
          <button onclick="event.stopPropagation(); editOrderClient('${order.id}')"
                  class="mdc-button mdc-button--outlined"
                  style="margin-left: 12px; padding: 4px 12px; font-size: 12px; height: auto; min-height: 28px;">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" style="font-size: 16px;">swap_horiz</i>
            <span class="mdc-button__label">Cambiar Cliente</span>
          </button>
        `;

        document.getElementById('detailClientEmail').textContent = emailUsuario || '-';
        document.getElementById('detailOrderDate').textContent = order.fechaLocal || '-';
        document.getElementById('detailOrderState').textContent = stateLabels[order.logisticsState] || order.logisticsState || 'Sin estado';

        // Mostrar si fue creada por admin
        if (order.creadoPorAdmin) {
          document.getElementById('detailAdminCreatedContainer').style.display = 'grid';
          document.getElementById('detailAdminCreated').textContent = order.usuarioEmail || '-';
        } else {
          document.getElementById('detailAdminCreatedContainer').style.display = 'none';
        }

        // Mostrar foto y peso de preparación para todos los usuarios
        const photoWeightContainer = document.getElementById('detailPhotoWeightContainer');
        const photoContainer = document.getElementById('detailPhotoContainer');
        const weightContainer = document.getElementById('detailWeightContainer');
        const noPhotoWeight = document.getElementById('detailNoPhotoWeight');
        const photoImg = document.getElementById('detailPhotoImg');
        const photoDate = document.getElementById('detailPhotoDate');
        const weightSpan = document.getElementById('detailWeight');

        let hasPhotoOrWeight = false;

        // Mostrar foto si existe
        if (order.fotoPreparacion) {
          photoImg.src = order.fotoPreparacion;

          // Mostrar fecha de actualización si existe
          if (order.fotoPreparacionUpdatedAt) {
            const fecha = new Date(order.fotoPreparacionUpdatedAt.seconds * 1000);
            photoDate.textContent = `Subida el: ${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString()}`;
          } else {
            photoDate.textContent = '';
          }

          photoContainer.style.display = 'grid';
          hasPhotoOrWeight = true;
        } else {
          photoContainer.style.display = 'none';
        }

        // Mostrar peso si existe
        if (order.pesoPreparacion) {
          weightSpan.textContent = `${order.pesoPreparacion} kg`;
          weightContainer.style.display = 'grid';
          hasPhotoOrWeight = true;
        } else {
          weightContainer.style.display = 'none';
        }

        // Mostrar la sección completa si hay foto o peso
        if (hasPhotoOrWeight) {
          photoWeightContainer.style.display = 'block';
          noPhotoWeight.style.display = 'none';
        } else {
          // Mostrar mensaje si no hay foto ni peso
          photoWeightContainer.style.display = 'block';
          noPhotoWeight.style.display = 'block';
        }

        // Llenar tabla de items con campos editables
        const itemsTableBody = document.getElementById('detailOrderItems');
        itemsTableBody.innerHTML = '';

        let hasChanges = false;

        if (order.items && order.items.length > 0) {
          order.items.forEach((item, index) => {
            const row = document.createElement('tr');
            row.setAttribute('data-item-index', index);
            row.innerHTML = `
              <td>${item.articulo || '-'}</td>
              <td>${item.description || '-'}</td>
              <td style="text-align: center;">
                <input type="number"
                       class="editable-quantity"
                       value="${item.quantity || 0}"
                       min="0"
                       data-item-index="${index}"
                       style="width: 70px; padding: 4px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
              </td>
              <td style="text-align: right;">
                $<input type="number"
                       class="editable-price"
                       value="${(item.price || 0).toFixed(2)}"
                       min="0"
                       step="0.01"
                       data-item-index="${index}"
                       style="width: 80px; padding: 4px; text-align: right; border: 1px solid #ddd; border-radius: 4px;">
              </td>
              <td class="item-subtotal" style="text-align: right;">$${(item.subtotal || 0).toFixed(2)}</td>
            `;
            itemsTableBody.appendChild(row);
          });

          // Función para recalcular subtotal y total
          const updateSubtotalAndTotal = (row, index) => {
            const quantityInput = row.querySelector('.editable-quantity');
            const priceInput = row.querySelector('.editable-price');
            const quantity = parseInt(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const subtotal = price * quantity;

            // Actualizar el item en el array
            order.items[index].quantity = quantity;
            order.items[index].price = price;
            order.items[index].subtotal = subtotal;

            // Actualizar subtotal en la fila
            const subtotalCell = row.querySelector('.item-subtotal');
            subtotalCell.textContent = `$${subtotal.toFixed(2)}`;

            // Recalcular total
            const newTotal = order.items.reduce((sum, item) => sum + (item.subtotal || 0), 0);
            order.total = newTotal;
            document.getElementById('detailOrderTotal').textContent = `$${newTotal.toFixed(2)}`;

            // Detectar si hubo cambios
            hasChanges = true;
            const saveContainer = document.getElementById('detailSaveOrderContainer');
            if (saveContainer) {
              saveContainer.style.display = 'block';
            }
          };

          // Agregar event listeners para cantidad
          const quantityInputs = itemsTableBody.querySelectorAll('.editable-quantity');
          quantityInputs.forEach(input => {
            input.addEventListener('change', function() {
              const row = this.closest('tr');
              const index = parseInt(this.getAttribute('data-item-index'));
              updateSubtotalAndTotal(row, index);
            });
          });

          // Agregar event listeners para precio
          const priceInputs = itemsTableBody.querySelectorAll('.editable-price');
          priceInputs.forEach(input => {
            input.addEventListener('change', function() {
              const row = this.closest('tr');
              const index = parseInt(this.getAttribute('data-item-index'));
              console.log('💰 Precio cambiado en modal para item', index, ':', this.value);
              updateSubtotalAndTotal(row, index);
            });
          });
        } else {
          itemsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay items</td></tr>';
        }

        // Mostrar total
        document.getElementById('detailOrderTotal').textContent = `$${(order.total || 0).toFixed(2)}`;

        // Configurar botón Guardar
        const saveOrderContainer = document.getElementById('detailSaveOrderContainer');
        const saveOrderBtn = document.getElementById('detailSaveOrderBtn');

        // Mostrar botón Guardar siempre (no esperar a que haya cambios)
        if (saveOrderContainer) {
          saveOrderContainer.style.display = 'block';
        }

        // Remover event listeners previos del botón Guardar
        if (saveOrderBtn) {
          const newSaveBtn = saveOrderBtn.cloneNode(true);
          saveOrderBtn.parentNode.replaceChild(newSaveBtn, saveOrderBtn);

          // Agregar nuevo event listener para Guardar
          newSaveBtn.addEventListener('click', async () => {
            try {
              console.log('💾 Guardando cambios en la orden...');

              const currentUser = firebase.auth().currentUser;
              if (!currentUser) {
                alert('❌ Debes estar autenticado para guardar cambios');
                return;
              }

              // Obtener email y nombre del usuario actual
              const userEmail = currentUser.email;
              let userName = userEmail;

              // Intentar obtener el nombre del vendedor desde Firestore
              try {
                const { doc, getDoc } = firebase.firestoreHelpers;
                const db = firebase.firestore();
                const userRef = doc(db, 'usuarios', currentUser.uid);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                  const userData = userDoc.data();
                  userName = userData.nombre || userData.email || userEmail;
                }
              } catch (e) {
                console.warn('⚠️ No se pudo obtener nombre de usuario:', e);
              }

              // Limpiar y validar items antes de guardar
              const cleanedItems = order.items.map(item => ({
                articulo: item.articulo || '',
                description: item.description || '',
                quantity: parseInt(item.quantity) || 0,
                price: parseFloat(item.price) || 0,
                subtotal: parseFloat(item.subtotal) || 0
              }));

              // Validar total
              const cleanedTotal = parseFloat(order.total) || 0;

              console.log('📦 Items a guardar:', cleanedItems);
              console.log('💰 Total a guardar:', cleanedTotal);

              // Actualizar orden en Firebase con información de quién editó
              const { doc, updateDoc } = firebase.firestoreHelpers;
              const db = firebase.firestore();
              const orderRef = doc(db, 'pedidos', order.id);

              await updateDoc(orderRef, {
                items: cleanedItems,
                total: cleanedTotal,
                montoTotal: cleanedTotal, // Agregar también montoTotal para compatibilidad
                editadaPor: currentUser.uid,
                editadaPorEmail: userEmail,
                editadaPorNombre: userName,
                fechaEdicion: new Date().toISOString(),
                fechaEdicionLocal: new Date().toLocaleString('es-AR')
              });

              console.log('✅ Orden guardada exitosamente en Firebase');

              // Actualizar orden local
              order.items = cleanedItems;
              order.total = cleanedTotal;

              // Enviar WhatsApp al vendedor (si no hay vendedor, se usa Santiago por defecto)
              console.log('📱 Preparando WhatsApp para vendedor:', order.vendedorId || 'Santiago (por defecto)');
              const updatedOrderData = {
                ...order,
                editadaPorNombre: userName,
                cantidadItems: order.items?.length || 0
              };
              await sendOrderToSellerWhatsApp(updatedOrderData, order.manualOrderNumber || order.numeroOrden, order.clienteNombre || order.clienteEmail || order.usuarioEmail);

              // Actualizar el número de orden con el indicador de edición
              let orderNumberText = `#${order.manualOrderNumber || order.numeroOrden || order.id.slice(-6)}`;
              orderNumberText += ` <span style="color: #FF9800; font-size: 0.85em;">(editada por ${userName})</span>`;
              document.getElementById('detailOrderNumber').innerHTML = orderNumberText;

              // Mantener botón Guardar visible
              hasChanges = false;

              // Recargar órdenes para reflejar cambios
              await loadOrders();

              alert('✅ Cambios guardados exitosamente');
            } catch (error) {
              console.error('❌ Error guardando cambios:', error);
              console.error('❌ Detalles del error:', {
                message: error.message,
                code: error.code,
                stack: error.stack
              });

              let errorMessage = 'Error al guardar cambios. ';
              if (error.code === 'permission-denied') {
                errorMessage += 'No tienes permisos para realizar esta acción.';
              } else if (error.code === 'unavailable') {
                errorMessage += 'Firestore no está disponible. Verifica tu conexión a internet.';
              } else if (error.message) {
                errorMessage += error.message;
              } else {
                errorMessage += 'Por favor intenta nuevamente.';
              }

              alert('❌ ' + errorMessage);
            }
          });
        }

        // Configurar botón "Seguir Comprando / Editar Orden"
        const editOrderContainer = document.getElementById('detailEditOrderContainer');
        const editOrderBtn = document.getElementById('detailEditOrderBtn');

        // Siempre mostrar el botón
        editOrderContainer.style.display = 'block';

        // Remover event listeners previos
        const newEditBtn = editOrderBtn.cloneNode(true);
        editOrderBtn.parentNode.replaceChild(newEditBtn, editOrderBtn);

        // Agregar nuevo event listener
        newEditBtn.addEventListener('click', () => {
          // Guardar orden en localStorage y redirigir a marketplace
          const cartItems = order.items.map(item => ({
            item: item.articulo,
            description: item.description,
            price: item.price,
            quantity: item.quantity
          }));
          localStorage.setItem('cart', JSON.stringify(cartItems));
          localStorage.setItem('editingOrderId', order.id);

          // Guardar datos del cliente de la orden para edición
          const clienteData = {
            nombre: order.clienteNombre || order.clienteEmail || order.usuarioEmail,
            email: order.clienteEmail || order.usuarioEmail,
            codigo: order.clienteCodigo || '',
            vendedorId: order.vendedorId || null
          };
          localStorage.setItem('editingOrderClienteData', JSON.stringify(clienteData));

          console.log('📦 Orden guardada en localStorage, redirigiendo a marketplace...');
          console.log('👤 Cliente de la orden:', clienteData);
          window.location.href = 'marketplace.html';
        });

        // Configurar botón "Enviar WhatsApp" (siempre visible, usa Santiago si no hay vendedor)
        const whatsAppContainer = document.getElementById('detailSendWhatsAppContainer');
        const whatsAppBtn = document.getElementById('detailSendWhatsAppBtn');

        if (whatsAppContainer && whatsAppBtn) {
          whatsAppContainer.style.display = 'block';

          // Remover event listeners previos
          const newWhatsAppBtn = whatsAppBtn.cloneNode(true);
          whatsAppBtn.parentNode.replaceChild(newWhatsAppBtn, whatsAppBtn);

          // Agregar event listener para enviar WhatsApp
          newWhatsAppBtn.addEventListener('click', async () => {
            console.log('📱 [Manual] Enviando WhatsApp...');
            const orderData = {
              ...order,
              cantidadItems: order.items?.length || 0
            };
            await sendOrderToSellerWhatsApp(orderData, order.manualOrderNumber || order.numeroOrden, order.clienteNombre || order.clienteEmail || order.usuarioEmail);
          });
        } else {
          console.warn('⚠️ Elementos de WhatsApp no encontrados en el DOM');
        }

        // Configurar botón "Copiar a Oppen"
        const copyOppenContainer = document.getElementById('detailCopyOppenContainer');
        const copyOppenBtn = document.getElementById('detailCopyOppenBtn');

        if (copyOppenContainer && copyOppenBtn) {
          copyOppenContainer.style.display = 'block';

          // Remover event listeners previos
          const newCopyOppenBtn = copyOppenBtn.cloneNode(true);
          copyOppenBtn.parentNode.replaceChild(newCopyOppenBtn, copyOppenBtn);

          // Agregar event listener para copiar a Oppen
          newCopyOppenBtn.addEventListener('click', async () => {
            try {
              console.log('📋 Copiando orden a formato Oppen...');

              // Construir texto en formato de tabla con tabulaciones
              // Formato: CODIGO [TAB] DESCRIPCION [TAB] [VACIO] [TAB] CANTIDAD [TAB] UNI [TAB] [VACIO] [TAB] PRECIO
              let clipboardText = '';

              order.items.forEach(item => {
                const codigo = item.articulo || '';
                const descripcion = item.description || '';
                const cantidad = item.quantity || 0;
                const precioSinSigno = (item.price || 0).toFixed(2);

                // Agregar fila con tabulaciones
                // CODIGO [TAB] DESCRIPCION [TAB] [TAB] CANTIDAD [TAB] UNI [TAB] [TAB] PRECIO
                clipboardText += `${codigo}\t${descripcion}\t\t${cantidad}\tUNI\t\t${precioSinSigno}\n`;
              });

              // Copiar al portapapeles
              await navigator.clipboard.writeText(clipboardText);

              console.log('✅ Orden copiada al portapapeles');
              alert('✅ Orden copiada exitosamente. Ahora puedes pegarla en Oppen.');
            } catch (error) {
              console.error('❌ Error copiando a Oppen:', error);
              alert('❌ Error al copiar. Por favor intenta nuevamente.');
            }
          });
        } else {
          console.warn('⚠️ Elementos de Copiar a Oppen no encontrados en el DOM');
        }

        // Mostrar modal
        document.getElementById('orderDetailsModal').style.display = 'block';

      } catch (error) {
        console.error('❌ Error mostrando detalles de orden:', error);
        alert('Error al cargar detalles de la orden');
      }
    };

    window.adminMoveOrder = adminMoveOrder;

    // Update order statistics
    function updateOrderStats() {
      if (!window.orders) return;

      console.log('📊 [MASTER] Actualizando estadísticas KPI...');

      const totalOrders = window.orders.length;
      const borradorOrders = window.orders.filter(o => o.logisticsState === 'borrador').length;
      const revisionOrders = window.orders.filter(o => o.logisticsState === 'revision').length;
      const aprobadaOrders = window.orders.filter(o => o.logisticsState === 'aprobada').length;
      const preparacionOrders = window.orders.filter(o => o.logisticsState === 'preparacion').length;
      const listoOrders = window.orders.filter(o => o.logisticsState === 'listo').length;
      const despachadaOrders = window.orders.filter(o => o.logisticsState === 'despachada').length;
      const entregadaOrders = window.orders.filter(o => o.logisticsState === 'entregada').length;
      const cerradaOrders = window.orders.filter(o => o.logisticsState === 'cerrada').length;
      const canceladaOrders = window.orders.filter(o => o.logisticsState === 'cancelada').length;

      console.log('📊 [MASTER] KPI:', {
        total: totalOrders,
        borrador: borradorOrders,
        revision: revisionOrders,
        aprobada: aprobadaOrders,
        preparacion: preparacionOrders,
        listo: listoOrders,
        despachada: despachadaOrders,
        entregada: entregadaOrders,
        cerrada: cerradaOrders,
        cancelada: canceladaOrders
      });

      // Actualizar los elementos del DOM
      const totalEl = document.getElementById('totalOrders');
      const borradorEl = document.getElementById('borradorOrders');
      const revisionEl = document.getElementById('revisionOrders');
      const aprobadaEl = document.getElementById('aprobadaOrders');
      const preparacionEl = document.getElementById('preparacionOrders');
      const listoEl = document.getElementById('listoOrders');
      const despachadaEl = document.getElementById('despachadaOrders');
      const entregadaEl = document.getElementById('entregadaOrders');
      const cerradaEl = document.getElementById('cerradaOrders');
      const canceladaEl = document.getElementById('canceladaOrders');

      if (totalEl) totalEl.textContent = totalOrders;
      if (borradorEl) borradorEl.textContent = borradorOrders;
      if (revisionEl) revisionEl.textContent = revisionOrders;
      if (aprobadaEl) aprobadaEl.textContent = aprobadaOrders;
      if (preparacionEl) preparacionEl.textContent = preparacionOrders;
      if (listoEl) listoEl.textContent = listoOrders;
      if (despachadaEl) despachadaEl.textContent = despachadaOrders;
      if (entregadaEl) entregadaEl.textContent = entregadaOrders;
      if (cerradaEl) cerradaEl.textContent = cerradaOrders;
      if (canceladaEl) canceladaEl.textContent = canceladaOrders;

      console.log('✅ [MASTER] Estadísticas KPI actualizadas');
    }

    // Export orders to Excel
    async function exportOrders() {
      if (!window.orders || window.orders.length === 0) {
        alert('⚠️ No hay órdenes para exportar');
        return;
      }

      try {
        console.log('📤 Exportando órdenes a Excel...');

        const stateLabels = {
          borrador: 'Borrador',
          revision: 'En Revisión',
          aprobada: 'Aprobada',
          preparacion: 'En Preparación',
          listo: 'Listo para Retiro/Despacho',
          despachada: 'Despachada',
          entregada: 'Entregada',
          cerrada: 'Cerrada',
          cancelada: 'Cancelada'
        };

        // Preparar datos para Excel
        const ordersData = window.orders.map(order => {
          // Calcular cantidad total de items
          const totalItems = order.items ? order.items.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0;

          return {
            'Número de Orden': order.manualOrderNumber || order.numeroOrden || order.id.slice(-6),
            'Fecha': order.fechaLocal || order.fecha || '',
            'Cliente': order.clienteNombre || order.usuarioEmail || '',
            'Email': order.clienteEmail || order.usuarioEmail || '',
            'Estado': stateLabels[order.logisticsState] || order.logisticsState || '',
            'Cantidad Items': order.cantidadItems || totalItems,
            'Total': order.total || order.montoTotal || 0,
            'Creada por Admin': order.creadoPorAdmin ? 'Sí' : 'No',
            'Vendedor': order.usuarioEmail || '',
            'Editada por': order.editadaPorNombre || '',
            'Fecha Edición': order.fechaEdicionLocal || ''
          };
        });

        // Crear libro de Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(ordersData);

        // Ajustar ancho de columnas
        const colWidths = [
          { wch: 15 }, // Número de Orden
          { wch: 20 }, // Fecha
          { wch: 30 }, // Cliente
          { wch: 30 }, // Email
          { wch: 25 }, // Estado
          { wch: 12 }, // Cantidad Items
          { wch: 15 }, // Total
          { wch: 15 }, // Creada por Admin
          { wch: 30 }, // Vendedor
          { wch: 25 }, // Editada por
          { wch: 20 }  // Fecha Edición
        ];
        ws['!cols'] = colWidths;

        XLSX.utils.book_append_sheet(wb, ws, 'Órdenes');

        // Generar nombre de archivo con fecha
        const fecha = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `Ordenes_${fecha}.xlsx`);

        console.log(`✅ Exportadas ${ordersData.length} órdenes a Excel`);
        alert(`✅ Exportadas ${ordersData.length} órdenes correctamente`);

      } catch (error) {
        console.error('❌ Error exportando órdenes:', error);
        alert('❌ Error exportando órdenes: ' + error.message);
      }
    }

    // Expose functions globally
    window.loadOrders = loadOrders;
    window.exportOrders = exportOrders;


    });
  </script>

  <!-- Pause/Unpause Prices Functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const togglePauseBtn = document.getElementById('togglePauseBtn');
      const pauseBtnLabel = document.getElementById('pauseBtnLabel');
      const pauseIcon = document.getElementById('pauseIcon');
      const pauseStatusIndicator = document.getElementById('pauseStatusIndicator');
      const pauseConfirmModal = document.getElementById('pauseConfirmModal');
      const closePauseModal = document.getElementById('closePauseModal');
      const cancelPauseBtn = document.getElementById('cancelPauseBtn');
      const confirmPauseBtn = document.getElementById('confirmPauseBtn');

      // Firebase functions for global price pause state
      async function getPricePauseState() {
        try {
          const { doc, getDoc } = firebase.firestoreHelpers;
          const db = firebase.firestore();
          const settingsRef = doc(db, 'settings', 'pricesPaused');
          const settingsDoc = await getDoc(settingsRef);

          if (settingsDoc.exists()) {
            return settingsDoc.data().paused === true;
          }
          return false;
        } catch (error) {
          console.error('Error reading price pause state from Firebase:', error);
          return false;
        }
      }

      async function setPricePauseState(paused) {
        try {
          const { doc, setDoc } = firebase.firestoreHelpers;
          const db = firebase.firestore();
          const settingsRef = doc(db, 'settings', 'pricesPaused');
          await setDoc(settingsRef, {
            paused: paused,
            updatedAt: new Date().toISOString(),
            updatedBy: window.currentUserEmail || 'unknown'
          });
          console.log('✅ Price pause state saved to Firebase:', paused);
          return true;
        } catch (error) {
          console.error('❌ Error saving price pause state to Firebase:', error);
          return false;
        }
      }

      // Check initial pause state
      async function updatePauseUI() {
        const isPaused = await getPricePauseState();

        if (isPaused) {
          pauseBtnLabel.textContent = 'DESPAUSAR PRECIOS';
          pauseIcon.textContent = 'play_circle';
          togglePauseBtn.style.background = '#4CAF50';
          pauseStatusIndicator.textContent = '⏸️ PRECIOS PAUSADOS (GLOBAL)';
          pauseStatusIndicator.style.background = '#FF9800';
          pauseStatusIndicator.style.color = 'white';
        } else {
          pauseBtnLabel.textContent = 'PAUSAR PRECIOS';
          pauseIcon.textContent = 'pause_circle';
          togglePauseBtn.style.background = '#FF9800';
          pauseStatusIndicator.textContent = '▶️ PRECIOS ACTIVOS (GLOBAL)';
          pauseStatusIndicator.style.background = '#4CAF50';
          pauseStatusIndicator.style.color = 'white';
        }
      }

      // Initialize UI
      updatePauseUI();

      // Toggle pause button click
      togglePauseBtn.addEventListener('click', async function() {
        const isPaused = await getPricePauseState();

        if (isPaused) {
          // Unpause directly without confirmation
          await unpausePrices();
        } else {
          // Show confirmation modal for pausing
          pauseConfirmModal.classList.remove('hidden');
        }
      });

      // Close modal handlers
      closePauseModal.addEventListener('click', function() {
        pauseConfirmModal.classList.add('hidden');
      });

      cancelPauseBtn.addEventListener('click', function() {
        pauseConfirmModal.classList.add('hidden');
      });

      // Confirm pause
      confirmPauseBtn.addEventListener('click', async function() {
        await pausePrices();
        pauseConfirmModal.classList.add('hidden');
      });

      // Force sync button - for troubleshooting state issues
      const forceSyncPauseBtn = document.getElementById('forceSyncPauseBtn');
      if (forceSyncPauseBtn) {
        forceSyncPauseBtn.addEventListener('click', async function() {
          console.log('🔄 Forzando sincronización del estado de pausa...');

          // Get fresh state from Firebase
          const freshState = await getPricePauseState();

          // Update global variable
          window.pricesPausedGlobal = freshState;
          console.log('✅ Estado sincronizado desde Firebase:', freshState);

          // Update UI
          await updatePauseUI();

          // Reload products
          if (window.loadProducts) {
            window.loadProducts();
          }

          // Show confirmation
          alert('✅ Sincronización completada.\nEstado actual: ' + (freshState ? 'PAUSADO' : 'ACTIVO'));
        });
      }

      // Pause prices function
      async function pausePrices() {
        console.log('⏸️ Pausando precios globalmente...');

        // Save pause state to Firebase (global for all users)
        const success = await setPricePauseState(true);

        if (success) {
          // Update global variable immediately
          window.pricesPausedGlobal = true;

          // Update UI
          await updatePauseUI();

          // Reload products to apply changes
          if (window.loadProducts) {
            window.loadProducts();
          }

          console.log('✅ Precios pausados GLOBALMENTE - Todos los usuarios verán "x"');
        } else {
          console.error('❌ Error al pausar precios');
          alert('Error al pausar precios. Por favor intenta de nuevo.');
        }
      }

      // Unpause prices function
      async function unpausePrices() {
        console.log('▶️ Despausando precios globalmente...');

        // Remove pause flag from Firebase (global for all users)
        const success = await setPricePauseState(false);

        if (success) {
          // Update global variable immediately
          window.pricesPausedGlobal = false;

          // Update UI
          await updatePauseUI();

          // Reload products to restore prices
          if (window.loadProducts) {
            window.loadProducts();
          }

          console.log('✅ Precios despausados GLOBALMENTE - Todos los usuarios verán precios normales');
        } else {
          console.error('❌ Error al despausar precios');
          alert('Error al despausar precios. Por favor intenta de nuevo.');
        }
      }

      // Close modal when clicking outside
      pauseConfirmModal.addEventListener('click', function(e) {
        if (e.target === pauseConfirmModal) {
          pauseConfirmModal.classList.add('hidden');
        }
      });
    });
  </script>

  <!-- Chatbot JavaScript REMOVIDO (ahora en ayuda.html) -->
</body>
</html>
