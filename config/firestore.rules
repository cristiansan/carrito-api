rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Función helper para verificar si el usuario es admin
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.admin == true;
    }

    // NUEVA SECCIÓN - Counters collection para números de orden
    match /counters/{counterId} {
      allow read, write: if request.auth != null;
    }

    // Permitir lectura de precios para todos (autenticados y no autenticados)
    match /precios/{document=**} {
      allow read: if true;  // Permitir lectura pública
      allow write: if isAdmin();
    }

    // Otras colecciones requieren autenticación
    match /stock/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // REGLAS ACTUALIZADAS PARA USUARIOS - Permitir que admins lean todos los usuarios
    match /usuarios/{userId} {
      // Permitir lectura a usuarios autenticados de su propio documento
      allow read: if request.auth != null && request.auth.uid == userId;

      // Permitir lectura a admins de todos los usuarios (para sección ADMISIONES)
      allow read: if isAdmin();

      // Permitir crear documento al registrarse
      allow create: if request.auth != null && request.auth.uid == userId;

      // Permitir actualización a usuarios de su propio perfil Y a admins de cualquier usuario
      allow update: if (request.auth != null && request.auth.uid == userId) || isAdmin();

      // Permitir eliminar solo a admins
      allow delete: if isAdmin();
    }

    match /pedidos/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    match /clientes/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /vendedores/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /ordenes/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /config/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // REGLAS PARA EMAILS BLOQUEADOS - Solo admins pueden leer y escribir
    match /blockedEmails/{email} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // REGLAS PARA CHATBOT INTERACTIONS - Guardar y exportar preguntas
    match /chatbot_interactions/{interactionId} {
      allow read: if request.auth != null;  // Usuarios autenticados pueden leer
      allow write: if request.auth != null; // Usuarios autenticados pueden escribir
    }

    // REGLAS PARA ERROR LOGS - Sistema de logging de errores
    match /error_logs/{logId} {
      allow read: if isAdmin();  // Solo admins pueden leer logs
      allow create: if request.auth != null;  // Cualquier usuario autenticado puede crear logs (registrar errores)
      allow update: if isAdmin();  // Solo admins pueden actualizar logs (agregar savedDate)
      allow delete: if isAdmin();  // Solo admins pueden eliminar logs
    }
  }
}
