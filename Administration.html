<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Administration - South Traders</title>

  <!-- Material Design CSS -->
  <link href="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif;
      color-scheme: dark;
      --mdc-theme-primary: #4CAF50;
      --mdc-theme-secondary: #2a2a33;
      --mdc-theme-surface: #1e1e24;
      --mdc-theme-background: #0f0f10;
      --mdc-theme-on-primary: #ffffff;
      --mdc-theme-on-secondary: #ffffff;
      --mdc-theme-on-surface: #f1f1f1;
      --mdc-theme-on-background: #f1f1f1;
    }

    /* Material Design custom overrides */
    .mdc-tab {
      color: #d0d0d0 !important;
      background-color: #1b1b1f !important;
      border-radius: 6px 6px 0 0 !important;
      border: 1px solid #2a2a2a !important;
      border-bottom: none !important;
      margin-right: 4px !important;
    }

    .mdc-tab--active {
      color: #ffffff !important;
      background-color: #23232a !important;
      font-weight: 600 !important;
    }

    .mdc-tab:hover:not(.mdc-tab--active) {
      color: #e8e8e8 !important;
      background-color: #2a2a2f !important;
    }

    .mdc-tab-indicator__content--underline {
      border-color: #4CAF50 !important;
      border-width: 3px !important;
    }

    /* Fix for all text elements */
    .mdc-tab__text-label,
    .mdc-button__label,
    .mdc-floating-label,
    .mdc-text-field__input,
    .mdc-form-field > label,
    span, p, div, h1, h2, h3, h4, h5, h6 {
      color: inherit !important;
    }

    /* Button improvements */
    .mdc-button {
      color: #f1f1f1 !important;
    }

    .mdc-button--raised {
      background-color: #4CAF50 !important;
      color: #ffffff !important;
    }

    .mdc-button--outlined {
      border-color: #3a3a44 !important;
      color: #f1f1f1 !important;
    }

    .mdc-button--outlined:hover {
      background-color: #2a2a33 !important;
      border-color: #4CAF50 !important;
    }

    body {
      margin: 0;
      padding: 0;
      background: #0f0f10;
      color: #f1f1f1;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    header {
      padding: 16px;
      border-bottom: 1px solid #2a2a2a;
      background: #121214;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-logo {
      height: auto;
      max-width: 150px;
      width: 100%;
      object-fit: contain;
    }

    h1 {
      margin: 0;
      font-size: 20px;
      color: #fafafa;
    }

    .back-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #2a2a33;
      color: #f1f1f1;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #3a3a44;
      transition: background-color 0.2s;
      text-decoration: none;
    }

    .back-btn:hover {
      background: #3a3a44;
      color: #f1f1f1;
    }

    .container {
      padding: 16px;
      width: 100%;
      box-sizing: border-box;
    }

    .tab-content {
      background: #1e1e24;
      border-radius: 8px;
      padding: 24px;
      margin-top: 16px;
      border: 1px solid #2a2a2a;
    }

    .tab-content h2 {
      color: #4CAF50;
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .content-placeholder {
      color: #b5b5b5;
      font-style: italic;
      text-align: center;
      padding: 60px 20px;
      font-size: 16px;
    }

    .admin-section {
      background: #15151a;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #2a2a2a;
    }

    .admin-section h3 {
      color: #4CAF50;
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 18px;
    }

    .sellers-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .sellers-header h3 {
      margin: 0;
    }

    .add-seller-btn {
      background-color: #4CAF50 !important;
    }

    .seller-card {
      background: #2a2a33;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #3a3a44;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
    }

    .seller-card:hover {
      background: #2f2f3a;
      border-color: #4CAF50;
    }

    .seller-info {
      flex: 1;
    }

    .seller-name {
      font-size: 16px;
      font-weight: 600;
      color: #f1f1f1;
      margin-bottom: 4px;
    }

    .seller-details {
      font-size: 13px;
      color: #b5b5b5;
    }

    .seller-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 12px;
      font-weight: 500;
    }

    .status-active {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }

    .status-inactive {
      background: rgba(158, 158, 158, 0.2);
      color: #9e9e9e;
    }

    .seller-actions {
      display: flex;
      gap: 8px;
      margin-left: 12px;
    }

    .delete-seller-btn {
      background: #f44336 !important;
      color: white !important;
      min-width: auto !important;
      padding: 8px !important;
    }

    .edit-seller-btn {
      background: #FF9800 !important;
      color: white !important;
      min-width: auto !important;
      padding: 8px !important;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .stat-item {
      text-align: center;
      background: #2a2a33;
      padding: 16px;
      border-radius: 6px;
      border: 1px solid #3a3a44;
    }

    .stat-number {
      display: block;
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: #b5b5b5;
      text-transform: uppercase;
    }

    .loading-sellers {
      text-align: center;
      color: #b5b5b5;
      padding: 40px;
      font-style: italic;
    }

    .no-sellers {
      text-align: center;
      color: #b5b5b5;
      padding: 40px;
      font-style: italic;
    }

    /* Modal styles for add/edit seller */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal:not(.hidden) {
      display: flex;
    }

    .modal-content {
      background-color: #1e1e24;
      margin: auto;
      padding: 20px;
      border: 1px solid #2a2a2a;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      position: relative;
      color: #f1f1f1;
    }

    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 20px;
      cursor: pointer;
    }

    .close-button:hover {
      color: #f1f1f1;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #f1f1f1;
      font-weight: 500;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      background: #2a2a33;
      color: #f1f1f1;
      box-sizing: border-box;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: #4CAF50;
      outline: none;
    }

    /* Client-specific styles */
    .clients-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .clients-header h3 {
      margin: 0;
    }

    .add-client-btn {
      background-color: #2196F3 !important;
    }

    .client-card {
      background: #2a2a33;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #3a3a44;
      transition: all 0.2s ease;
    }

    .client-card:hover {
      background: #2f2f3a;
      border-color: #2196F3;
    }

    .client-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .client-main-info {
      flex: 1;
    }

    .client-number {
      font-size: 12px;
      color: #2196F3;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .client-name {
      font-size: 16px;
      font-weight: 600;
      color: #f1f1f1;
      margin-bottom: 4px;
    }

    .client-price-list {
      font-size: 13px;
      color: #FF9800;
      margin-bottom: 8px;
    }

    .client-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .client-detail-item {
      font-size: 13px;
      color: #b5b5b5;
      display: flex;
      justify-content: space-between;
    }

    .client-detail-label {
      font-weight: 500;
    }

    .client-detail-value {
      color: #f1f1f1;
    }

    .client-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .client-link {
      color: #2196F3;
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
    }

    .client-link:hover {
      text-decoration: underline;
    }

    .loading-clients, .no-clients {
      text-align: center;
      color: #b5b5b5;
      padding: 40px;
      font-style: italic;
    }

    /* Clientes header with buttons */
    .clientes-header {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    /* Clientes table container with scrollbar */
    .clientes-table-container {
      max-height: 60vh;
      overflow: auto;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
    }

    .clientes-table-container::-webkit-scrollbar {
      width: 14px;
      height: 14px;
    }

    .clientes-table-container::-webkit-scrollbar-track {
      background: #1e1e24;
      border-radius: 6px;
    }

    .clientes-table-container::-webkit-scrollbar-thumb {
      background: #4CAF50;
      border-radius: 6px;
      border: 2px solid #1e1e24;
    }

    .clientes-table-container::-webkit-scrollbar-thumb:hover {
      background: #45a049;
    }

    .clientes-table-container {
      scrollbar-width: auto;
      scrollbar-color: #4CAF50 #1e1e24;
    }

    /* Clientes table styles */
    .clientes-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .clientes-table th {
      position: sticky;
      top: 0;
      background: #2a2a33;
      color: #f1f1f1;
      padding: 10px 8px;
      text-align: left;
      border-bottom: 2px solid #4CAF50;
      font-weight: 600;
      white-space: nowrap;
      z-index: 10;
    }

    .clientes-table td {
      padding: 8px;
      border-bottom: 1px solid #2a2a2a;
      color: #f1f1f1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    .clientes-table tr:hover {
      background: #2f2f3a;
    }

    .edit-client-btn, .delete-client-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .edit-client-btn:hover {
      background: #2a2a33;
    }

    .delete-client-btn:hover {
      background: #d32f2f;
    }

    /* Form specific styles for clients */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-row-triple {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 768px) {
      .form-row, .form-row-triple {
        grid-template-columns: 1fr;
      }

      .client-details-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Prevent any black text */
    * {
      color: inherit;
    }

    .mdc-tab *,
    .mdc-button *,
    .mdc-text-field *,
    .mdc-form-field * {
      color: inherit !important;
    }

    /* Product pricing table styles */
    .prices-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .prices-header h3 {
      margin: 0;
    }

    .prices-actions-buttons {
      display: flex;
      gap: 12px;
    }

    .products-table {
      width: 100%;
      border-collapse: collapse;
      background: #2a2a33;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .products-table thead {
      background: #1e1e24;
    }

    .products-table th {
      padding: 12px 16px;
      text-align: left;
      color: #4CAF50;
      font-weight: 600;
      border-bottom: 2px solid #3a3a44;
      font-size: 14px;
    }

    .products-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #3a3a44;
      color: #f1f1f1;
    }

    .products-table tr:hover {
      background: #2f2f3a;
    }

    .products-table tbody tr:last-child td {
      border-bottom: none;
    }

    .product-code {
      font-family: monospace;
      color: #2196F3;
      font-weight: 600;
      font-size: 13px;
    }

    .product-description {
      color: #f1f1f1;
      font-size: 14px;
    }

    .price-input {
      width: 100px;
      padding: 6px 8px;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      background: #1e1e24;
      color: #f1f1f1;
      text-align: right;
      font-family: monospace;
      font-size: 13px;
    }

    .price-input:focus {
      border-color: #4CAF50;
      outline: none;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }

    .price-input:hover {
      border-color: #4a4a54;
    }

    .price-input.modified {
      border-color: #FF9800;
      background: rgba(255, 152, 0, 0.1);
    }

    .loading-products, .no-products {
      text-align: center;
      color: #b5b5b5;
      padding: 40px;
      font-style: italic;
    }

    /* Loading spinner animation */
    .loading-spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #3a3a44;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .price-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      align-items: center;
    }

    .price-stats {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #b5b5b5;
    }

    .price-stat {
      background: #2a2a33;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #3a3a44;
    }

    .price-stat-number {
      color: #4CAF50;
      font-weight: 600;
      margin-left: 4px;
    }

    /* Responsive table */
    @media (max-width: 1024px) {
      .products-table {
        font-size: 12px;
      }

      .products-table th,
      .products-table td {
        padding: 8px 10px;
      }

      .price-input {
        width: 80px;
        font-size: 12px;
      }
    }

    @media (max-width: 768px) {
      .prices-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .products-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      .price-actions {
        justify-content: center;
      }
    }

    /* Order management table styles */
    .orders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .orders-header h3 {
      margin: 0;
    }

    .orders-table {
      width: 100%;
      border-collapse: collapse;
      background: #2a2a33;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .orders-table thead {
      background: #1e1e24;
    }

    .orders-table th {
      padding: 10px 12px;
      text-align: left;
      color: #4CAF50;
      font-weight: 600;
      border-bottom: 2px solid #3a3a44;
      font-size: 12px;
      white-space: nowrap;
    }

    .orders-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #3a3a44;
      color: #f1f1f1;
      vertical-align: middle;
    }

    .orders-table tr:hover {
      background: #2f2f3a;
    }

    .orders-table tbody tr:last-child td {
      border-bottom: none;
    }

    .order-input {
      width: 100%;
      min-width: 80px;
      padding: 4px 6px;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      background: #1e1e24;
      color: #f1f1f1;
      font-size: 12px;
      font-family: inherit;
    }

    .order-input:focus {
      border-color: #4CAF50;
      outline: none;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }

    .order-input:hover {
      border-color: #4a4a54;
    }

    .order-input.modified {
      border-color: #FF9800;
      background: rgba(255, 152, 0, 0.1);
    }

    .order-date-input {
      width: 110px;
    }

    .order-number-input {
      width: 100px;
      text-align: center;
      font-family: monospace;
    }

    .order-client-input {
      width: 80px;
      text-align: center;
    }

    .order-name-input {
      min-width: 150px;
    }

    .order-amount-input {
      width: 100px;
      text-align: right;
      font-family: monospace;
    }

    .order-select {
      width: 100%;
      min-width: 120px;
      padding: 4px 6px;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      background: #1e1e24;
      color: #f1f1f1;
      font-size: 12px;
      font-family: inherit;
      cursor: pointer;
    }

    .order-select:focus {
      border-color: #4CAF50;
      outline: none;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }

    .order-select:hover {
      border-color: #4a4a54;
    }

    .order-select.modified {
      border-color: #FF9800;
      background: rgba(255, 152, 0, 0.1);
    }

    .status-badge {
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
      min-width: 80px;
      text-align: center;
    }

    .status-a-confirmar {
      background: rgba(158, 158, 158, 0.2);
      color: #9e9e9e;
    }

    .status-confirmado {
      background: rgba(33, 150, 243, 0.2);
      color: #2196F3;
    }

    .status-confirmado-modificaciones {
      background: rgba(255, 152, 0, 0.2);
      color: #FF9800;
    }

    .status-en-preparacion {
      background: rgba(156, 39, 176, 0.2);
      color: #9C27B0;
    }

    .status-en-camino {
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
    }

    .status-entregado {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }

    .loading-orders, .no-orders {
      text-align: center;
      color: #b5b5b5;
      padding: 40px;
      font-style: italic;
    }

    .order-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .order-stats {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #b5b5b5;
    }

    .order-stat {
      background: #2a2a33;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #3a3a44;
    }

    .order-stat-number {
      color: #4CAF50;
      font-weight: 600;
      margin-left: 4px;
    }

    /* Responsive orders table */
    @media (max-width: 1200px) {
      .orders-table {
        font-size: 11px;
      }

      .orders-table th,
      .orders-table td {
        padding: 8px 6px;
      }

      .order-input,
      .order-select {
        font-size: 11px;
        padding: 3px 4px;
      }

      .order-name-input {
        min-width: 120px;
      }
    }

    @media (max-width: 768px) {
      .orders-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .orders-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      .order-actions {
        justify-content: center;
      }
    }

    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }
      h1 {
        font-size: 18px;
      }
      .container {
        padding: 8px;
      }
      .header {
        padding: 12px;
      }
      .tab-content {
        padding: 16px;
      }
    }

    /* Logistics/Orders Section Styles */
    .logistics-content {
      max-height: 70vh;
      overflow-y: auto;
    }

    .logistics-section {
      margin-bottom: 24px;
      padding: 16px;
      background: #15151a;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
    }

    .logistics-section h4 {
      margin: 0 0 12px 0;
      color: #4CAF50;
      font-size: 16px;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 8px;
    }

    .logistics-orders {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .no-orders {
      color: #b5b5b5;
      font-style: italic;
      text-align: center;
      padding: 20px;
      margin: 0;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2a2a33;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #4CAF50;
    }

    .order-info {
      flex: 1;
    }

    .order-number {
      font-weight: 600;
      color: #4CAF50;
      margin-bottom: 4px;
    }

    .order-details {
      font-size: 12px;
      color: #b5b5b5;
    }

    .order-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .move-order-btn {
      background: #4CAF50;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .move-order-btn:hover {
      background: #45a049;
      transform: translateY(-2px);
    }

    .move-order-btn-up {
      background: #FF9800;
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
    }

    .move-order-btn-up:hover {
      background: #F57C00;
      transform: translateY(-2px);
    }

    .cancel-order-btn {
      background: #F44336;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .cancel-order-btn:hover {
      background: #d32f2f;
    }

    .edit-order-btn {
      background: #FF9800;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .edit-order-btn:hover {
      background: #F57C00;
    }

    .delivered-status {
      color: #4CAF50;
      font-size: 12px;
      font-weight: bold;
    }

    .closed-status {
      color: #9E9E9E;
      font-size: 12px;
      font-weight: bold;
    }

    .cancelled-status {
      color: #F44336;
      font-size: 12px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" class="header-logo">
    <h1>Administration Panel</h1>
    <a href="marketplace.html" class="back-btn">‚Üê Back to Marketplace</a>
  </header>

  <div class="container">
    <div class="mdc-tab-bar" role="tablist" id="tabs">
      <div class="mdc-tab-scroller">
        <div class="mdc-tab-scroller__scroll-area">
          <div class="mdc-tab-scroller__scroll-content">
            <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true" tabindex="0" data-tab="precios">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Precios</span>
              </span>
              <span class="mdc-tab-indicator mdc-tab-indicator--active">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-tab="clientes">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Clientes</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-tab="vendedor">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Vendedor</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-tab="master">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Master</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Contents -->
    <div id="precios-content" class="tab-content">
      <h2>üí∞ Gesti√≥n de Precios</h2>
      <div class="admin-section">
        <div class="prices-header">
          <h3>Lista de Productos y Precios</h3>
          <div class="prices-actions-buttons">
            <button class="mdc-button mdc-button--outlined" id="importPricesBtn">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">upload_file</i>
              <span class="mdc-button__label">Importar Precios</span>
            </button>
            <button class="mdc-button mdc-button--outlined" id="exportCsvBtn">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
              <span class="mdc-button__label">Exportar CSV</span>
            </button>
            <button class="mdc-button mdc-button--outlined" id="exportExcelBtn">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
              <span class="mdc-button__label">Exportar Excel</span>
            </button>
            <button class="mdc-button mdc-button--raised" id="saveAllPricesBtn" style="display: none;">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">save</i>
              <span class="mdc-button__label">Guardar Todos los Precios</span>
            </button>
            <button class="mdc-button mdc-button--outlined" id="loadProductsBtn">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">refresh</i>
              <span class="mdc-button__label">Actualizar Productos</span>
            </button>
          </div>
          <input type="file" id="pricesFileInput" accept=".csv,.xlsx,.xls" style="display: none;">
        </div>

        <div id="productsContainer">
          <div class="loading-products">
            <div class="loading-content">
              <div class="loading-spinner"></div>
              <p>Cargando productos...</p>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div id="clientes-content" class="tab-content" style="display: none;">
      <h2>üë• Gesti√≥n de Clientes</h2>

      <!-- Estad√≠sticas resumen -->
      <div class="admin-section">
        <h3>Resumen</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-number" id="totalClients">0</span>
            <span class="stat-label">Total Clientes</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="totalBalance">$0</span>
            <span class="stat-label">Saldo Cr√©dito Total</span>
          </div>
        </div>
      </div>

      <!-- Tabla de clientes -->
      <div class="admin-section">
        <div class="clientes-header">
          <button class="mdc-button mdc-button--outlined" id="importClientesBtn">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">upload</i>
            <span class="mdc-button__label">Importar Excel</span>
          </button>
          <button class="mdc-button mdc-button--outlined" id="exportClientesBtn">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
            <span class="mdc-button__label">Exportar Excel</span>
          </button>
          <button class="mdc-button mdc-button--raised" id="addClientBtn">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">person_add</i>
            <span class="mdc-button__label">Agregar Cliente</span>
          </button>
          <input type="file" id="excelFileInput" accept=".xls,.xlsx" style="display: none;">
        </div>

        <!-- Campo de b√∫squeda de clientes -->
        <div style="margin-bottom: 15px;">
          <label class="mdc-text-field mdc-text-field--outlined" style="width: 100%; max-width: 400px;">
            <span class="mdc-notched-outline">
              <span class="mdc-notched-outline__leading"></span>
              <span class="mdc-notched-outline__notch">
                <span class="mdc-floating-label" id="clientSearchLabel">Buscar cliente</span>
              </span>
              <span class="mdc-notched-outline__trailing"></span>
            </span>
            <input type="text"
                   class="mdc-text-field__input"
                   id="clientSearchInput"
                   placeholder="Buscar por c√≥digo, nombre, email, tel√©fono..."
                   style="color: #f1f1f1;">
            <i class="material-icons" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #4CAF50; pointer-events: none;">search</i>
          </label>
          <div style="margin-top: 8px; color: #b5b5b5; font-size: 12px;">
            <span id="clientSearchResults">Mostrando todos los clientes</span>
          </div>
        </div>

        <div class="clientes-table-container">
          <table class="clientes-table">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Nombre</th>
                <th>Nombre Comercial</th>
                <th>Grupo</th>
                <th>Departamento</th>
                <th>Inscripci√≥n</th>
                <th>Nro Documento</th>
                <th>Direcci√≥n</th>
                <th>Ciudad</th>
                <th>Provincia</th>
                <th>Pa√≠s</th>
                <th>Tel√©fono</th>
                <th>Email</th>
                <th>Vendedor</th>
                <th>Saldo Cr√©dito</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="clientesTableBody">
              <tr>
                <td colspan="16" style="text-align: center; padding: 20px;">
                  Cargando clientes...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="vendedor-content" class="tab-content" style="display: none;">
      <h2>ü§ù Gesti√≥n de Vendedores</h2>

      <div class="admin-section">
        <div class="sellers-header">
          <h3>Lista de Vendedores</h3>
          <button class="mdc-button mdc-button--raised add-seller-btn" id="addSellerBtn">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">person_add</i>
            <span class="mdc-button__label">Agregar Vendedor</span>
          </button>
        </div>

        <div id="sellersContainer">
          <div class="loading-sellers">
            <p>Cargando vendedores...</p>
          </div>
        </div>
      </div>

      <div class="admin-section">
        <h3>Estad√≠sticas</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-number" id="totalSellers">0</span>
            <span class="stat-label">Total Vendedores</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="activeSellers">0</span>
            <span class="stat-label">Activos</span>
          </div>
        </div>
      </div>
    </div>

    <div id="master-content" class="tab-content" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">üìã Seguimiento de Pedidos - Admin</h2>
        <div style="display: flex; gap: 10px;">
          <button class="mdc-button mdc-button--outlined" id="refreshOrdersBtn">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">refresh</i>
            <span class="mdc-button__label">Actualizar</span>
          </button>
          <button class="mdc-button mdc-button--outlined" id="deleteAllOrdersBtn" style="background-color: #F44336; color: white;">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">delete_forever</i>
            <span class="mdc-button__label">Borrar Todas las √ìrdenes</span>
          </button>
        </div>
      </div>

      <div class="stats-grid" style="margin-bottom: 24px;">
        <div class="stat-item">
          <span class="stat-number" id="totalOrders">0</span>
          <span class="stat-label">Total √ìrdenes</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="borradorOrders">0</span>
          <span class="stat-label">Borrador</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="revisionOrders">0</span>
          <span class="stat-label">En Revisi√≥n</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="aprobadaOrders">0</span>
          <span class="stat-label">Aprobadas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="preparacionOrders">0</span>
          <span class="stat-label">En Preparaci√≥n</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="listoOrders">0</span>
          <span class="stat-label">Listo para Despacho</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="despachadaOrders">0</span>
          <span class="stat-label">Despachadas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="entregadaOrders">0</span>
          <span class="stat-label">Entregadas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="cerradaOrders">0</span>
          <span class="stat-label">Cerradas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="canceladaOrders">0</span>
          <span class="stat-label">Canceladas</span>
        </div>
      </div>

      <div class="logistics-content">
        <div class="logistics-section">
          <h4>üìù Borrador</h4>
          <div class="logistics-orders" id="admin-borradorOrders">
            <p class="no-orders">No hay pedidos en borrador</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>üîç En Revisi√≥n</h4>
          <div class="logistics-orders" id="admin-revisionOrders">
            <p class="no-orders">No hay pedidos en revisi√≥n</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>‚úÖ Aprobada</h4>
          <div class="logistics-orders" id="admin-aprobadaOrders">
            <p class="no-orders">No hay pedidos aprobados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>üì¶ En Preparaci√≥n</h4>
          <div class="logistics-orders" id="admin-preparacionOrders">
            <p class="no-orders">No hay pedidos en preparaci√≥n</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>üöö Listo para Retiro/Despacho</h4>
          <div class="logistics-orders" id="admin-listoOrders">
            <p class="no-orders">No hay pedidos listos</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>üöõ Despachada</h4>
          <div class="logistics-orders" id="admin-despachadaOrders">
            <p class="no-orders">No hay pedidos despachados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>‚úÖ Entregada</h4>
          <div class="logistics-orders" id="admin-entregadaOrders">
            <p class="no-orders">No hay pedidos entregados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>üîí Cerrada</h4>
          <div class="logistics-orders" id="admin-cerradaOrders">
            <p class="no-orders">No hay pedidos cerrados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>‚ùå Cancelada</h4>
          <div class="logistics-orders" id="admin-canceladaOrders">
            <p class="no-orders">No hay pedidos cancelados</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Seller Modal -->
  <div id="sellerModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button" id="closeSellerModal">&times;</span>
      <h2 id="sellerModalTitle">Agregar Vendedor</h2>

      <form id="sellerForm">
        <div class="form-group">
          <label for="sellerName">Nombre Completo *</label>
          <input type="text" id="sellerName" name="name" required>
        </div>

        <div class="form-group">
          <label for="sellerEmail">Email</label>
          <input type="email" id="sellerEmail" name="email">
        </div>

        <div class="form-group">
          <label for="sellerPhone">Tel√©fono</label>
          <input type="tel" id="sellerPhone" name="phone">
        </div>

        <div class="form-group">
          <label for="sellerTerritory">Territorio</label>
          <input type="text" id="sellerTerritory" name="territory" placeholder="Ej: Zona Norte, Centro, etc.">
        </div>

        <div class="form-group">
          <label for="sellerCommission">Comisi√≥n (%)</label>
          <input type="number" id="sellerCommission" name="commission" min="0" max="100" step="0.1">
        </div>

        <div class="form-group">
          <label for="sellerStatus">Estado</label>
          <select id="sellerStatus" name="status">
            <option value="active">Activo</option>
            <option value="inactive">Inactivo</option>
          </select>
        </div>

        <div class="form-group">
          <label for="sellerNotes">Notas</label>
          <textarea id="sellerNotes" name="notes" rows="3" placeholder="Informaci√≥n adicional..."></textarea>
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
          <button type="button" class="mdc-button mdc-button--outlined" id="cancelSellerBtn">
            <span class="mdc-button__label">Cancelar</span>
          </button>
          <button type="submit" class="mdc-button mdc-button--raised" id="saveSellerBtn">
            <span class="mdc-button__label">Guardar</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Client Modal -->
  <div id="clientModal" class="modal hidden">
    <div class="modal-content" style="max-width: 700px;">
      <span class="close-button" id="closeClientModal">&times;</span>
      <h2 id="clientModalTitle">‚ûï Agregar Cliente</h2>

      <form id="clientForm">
        <div class="form-row">
          <div class="form-group">
            <label for="clientCodigo">C√≥digo *</label>
            <input type="text" id="clientCodigo" required>
          </div>
          <div class="form-group">
            <label for="clientGrupo">Grupo</label>
            <input type="text" id="clientGrupo">
          </div>
        </div>

        <div class="form-group">
          <label for="clientNombre">Nombre *</label>
          <input type="text" id="clientNombre" required>
        </div>

        <div class="form-group">
          <label for="clientNombreComercial">Nombre Comercial</label>
          <input type="text" id="clientNombreComercial">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="clientInscripcion">Inscripci√≥n</label>
            <input type="text" id="clientInscripcion">
          </div>
          <div class="form-group">
            <label for="clientNroDocumento">Nro Documento</label>
            <input type="text" id="clientNroDocumento">
          </div>
        </div>

        <div class="form-group">
          <label for="clientDireccion">Direcci√≥n</label>
          <input type="text" id="clientDireccion">
        </div>

        <div class="form-row-triple">
          <div class="form-group">
            <label for="clientCiudad">Ciudad</label>
            <input type="text" id="clientCiudad">
          </div>
          <div class="form-group">
            <label for="clientProvincia">Provincia</label>
            <input type="text" id="clientProvincia">
          </div>
          <div class="form-group">
            <label for="clientPais">Pa√≠s</label>
            <input type="text" id="clientPais">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="clientTelefono">Tel√©fono</label>
            <input type="text" id="clientTelefono">
          </div>
          <div class="form-group">
            <label for="clientEmail">Email</label>
            <input type="email" id="clientEmail">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="clientDepartamento">Departamento</label>
            <input type="text" id="clientDepartamento">
          </div>
          <div class="form-group">
            <label for="clientSaldoCredito">Saldo Cr√©dito</label>
            <input type="number" id="clientSaldoCredito" step="0.01" placeholder="0.00">
          </div>
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
          <button type="button" class="mdc-button mdc-button--outlined" id="cancelClientBtn">
            <span class="mdc-button__label">Cancelar</span>
          </button>
          <button type="submit" class="mdc-button mdc-button--raised" id="saveClientBtn">
            <span class="mdc-button__label">Guardar</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal hidden">
    <div class="modal-content" style="max-width: 400px;">
      <span class="close-button" id="closeConfirmModal">&times;</span>
      <h2>Confirmar Eliminaci√≥n</h2>
      <p id="confirmMessage">¬øEst√°s seguro de que deseas eliminar este registro?</p>
      <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
        <button type="button" class="mdc-button mdc-button--outlined" id="cancelDeleteBtn">
          <span class="mdc-button__label">Cancelar</span>
        </button>
        <button type="button" class="mdc-button mdc-button--raised delete-seller-btn" id="confirmDeleteBtn">
          <span class="mdc-button__label">Eliminar</span>
        </button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
  <!-- SheetJS library for Excel file support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script type="module">
    // === FIREBASE CONFIGURATION ===
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc, collection, query, orderBy, getDocs, where, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCXjSGtVGfQas_cEyjmI0RTaeEl94jdp6g",
      authDomain: "carrito-138c3.firebaseapp.com",
      projectId: "carrito-138c3",
      storageBucket: "carrito-138c3.appspot.com",
      messagingSenderId: "579670725719",
      appId: "1:579670725719:web:carrito138c3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // === EXPOSAR FIREBASE EN WINDOW PARA COMPATIBILIDAD ===
    window.firebase = {
      app: () => app,
      auth: () => auth,
      firestore: () => db,
      firestoreHelpers: {
        doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc, collection, query, orderBy, getDocs, where, writeBatch
      },
      authHelpers: {
        onAuthStateChanged, signOut
      }
    };

    // === ADMIN ACCESS CONTROL ===
    // Variable global para almacenar el estado de admin
    let isUserAdmin = false;

    async function checkAdminAccess(user) {
      try {
        console.log('üîê Verificando acceso admin para:', user.email);

        // Usar el mismo patr√≥n que marketplace.html
        if (typeof firebase !== 'undefined' && firebase.firestoreHelpers) {
          const { doc, getDoc } = firebase.firestoreHelpers;
          const userRef = doc(firebase.firestore(), 'usuarios', user.uid);
          const userDoc = await getDoc(userRef);

          let isAdmin = false;
          if (userDoc.exists()) {
            const userData = userDoc.data();
            isAdmin = userData.admin === true;
            isUserAdmin = isAdmin; // Guardar en variable global
            console.log('üë§ Usuario encontrado:', userData);
            console.log('üîê Es admin:', isAdmin);

            if (!isAdmin) {
              console.log('‚ÑπÔ∏è Usuario no es admin, acceso de solo lectura');
              // No redirigir, solo mostrar con permisos de solo lectura
            } else {
              console.log('‚úÖ Acceso admin confirmado para:', user.email);
            }

            return true; // Permitir acceso a todos los usuarios autenticados
          } else {
            console.log('‚ö†Ô∏è Usuario no encontrado en Firestore');
            isUserAdmin = false;
            return true; // Permitir acceso de solo lectura
          }
        } else {
          console.log('‚ö†Ô∏è Firebase helpers not available, waiting...');
          // Retry after a short delay
          setTimeout(() => {
            if (user) checkAdminAccess(user);
          }, 1000);
          return false;
        }
      } catch (error) {
        console.error('‚ùå Error verificando acceso admin:', error);
        isUserAdmin = false;
        return true; // Permitir acceso de solo lectura en caso de error
      }
    }

    // === AUTH STATE LISTENER (Mismo patr√≥n que marketplace.html) ===
    // Usar setTimeout para esperar que Firebase est√© completamente cargado
    setTimeout(() => {
      if (window.firebase && window.firebase.firestoreHelpers) {
        firebase.auth().onAuthStateChanged(async function(user) {
          if (user) {
            console.log('üë§ Usuario autenticado en Administration.html:', user.email);
            console.log('üîç UID del usuario:', user.uid);

            const hasAccess = await checkAdminAccess(user);
            if (hasAccess) {
              console.log('‚úÖ Usuario admin confirmado, mostrando p√°gina');
            }
          } else {
            console.log('üë§ Usuario no autenticado, redirigiendo a login...');
            window.location.href = 'login.html';
          }
        });
      } else {
        console.log('‚ö†Ô∏è Firebase not ready, retrying...');
        // Retry if Firebase not ready
        setTimeout(arguments.callee, 500);
      }
    }, 1000); // Mismo delay que marketplace.html

    console.log('‚úÖ Firebase inicializado en Administration.html');

    // === SELLER MANAGEMENT FUNCTIONS ===

    // Load sellers from Firebase
    async function loadSellers() {
      try {
        if (!window.firebase || !firebase.firestoreHelpers) {
          console.log('‚ö†Ô∏è Firebase not ready for sellers, waiting...');
          setTimeout(loadSellers, 1000);
          return;
        }

        const { collection, getDocs, orderBy, query, addDoc, deleteDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        console.log('üìã Cargando vendedores...');

        const sellersCollection = collection(db, 'vendedores');
        const q = query(sellersCollection, orderBy('name', 'asc'));
        const querySnapshot = await getDocs(q);

        window.sellers = [];
        querySnapshot.forEach((doc) => {
          window.sellers.push({
            id: doc.id,
            ...doc.data()
          });
        });

        console.log('‚úÖ Vendedores cargados:', window.sellers.length);
        displaySellers();
        updateStats();

      } catch (error) {
        console.error('‚ùå Error cargando vendedores:', error);
        document.getElementById('sellersContainer').innerHTML = `
          <div class="no-sellers">
            Error cargando vendedores. Int√©ntalo de nuevo.
          </div>
        `;
      }
    }

    // Display sellers in the UI
    function displaySellers() {
      const container = document.getElementById('sellersContainer');

      if (window.sellers.length === 0) {
        container.innerHTML = `
          <div class="no-sellers">
            No hay vendedores registrados. Haz clic en "Agregar Vendedor" para crear uno.
          </div>
        `;
        return;
      }

      const sellersHTML = window.sellers.map(seller => `
        <div class="seller-card" data-seller-id="${seller.id}">
          <div class="seller-info">
            <div class="seller-name">${seller.name}</div>
            <div class="seller-details">
              ${seller.email}${seller.phone ? ' ‚Ä¢ ' + seller.phone : ''}
              ${seller.territory ? ' ‚Ä¢ ' + seller.territory : ''}
              ${seller.commission ? ' ‚Ä¢ ' + seller.commission + '% comisi√≥n' : ''}
            </div>
          </div>
          <span class="seller-status ${seller.status === 'active' ? 'status-active' : 'status-inactive'}">
            ${seller.status === 'active' ? 'Activo' : 'Inactivo'}
          </span>
          <div class="seller-actions">
            <button class="mdc-button edit-seller-btn" onclick="editSeller('${seller.id}')">
              <i class="material-icons">edit</i>
            </button>
            <button class="mdc-button delete-seller-btn" onclick="confirmDeleteSeller('${seller.id}', '${seller.name}')">
              <i class="material-icons">delete</i>
            </button>
          </div>
        </div>
      `).join('');

      container.innerHTML = sellersHTML;

      // Initialize button ripples
      const buttons = container.querySelectorAll('.mdc-button');
      buttons.forEach(button => {
        if (!button._mdcRipple) {
          mdc.ripple.MDCRipple.attachTo(button);
        }
      });
    }

    // Update statistics
    function updateStats() {
      const totalSellers = window.sellers.length;
      const activeSellers = window.sellers.filter(s => s.status === 'active').length;

      document.getElementById('totalSellers').textContent = totalSellers;
      document.getElementById('activeSellers').textContent = activeSellers;
    }

    // Add or update seller
    async function saveSeller(sellerData) {
      try {
        if (!window.firebase || !firebase.firestoreHelpers) {
          throw new Error('Firebase not available');
        }

        const { collection, addDoc, updateDoc, doc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        if (window.currentEditingSellerId) {
          // Update existing seller
          const sellerRef = doc(db, 'vendedores', window.currentEditingSellerId);
          await updateDoc(sellerRef, {
            ...sellerData,
            updatedAt: new Date()
          });
          console.log('‚úÖ Vendedor actualizado:', window.currentEditingSellerId);
        } else {
          // Add new seller
          const sellersCollection = collection(db, 'vendedores');
          const docRef = await addDoc(sellersCollection, {
            ...sellerData,
            createdAt: new Date(),
            updatedAt: new Date()
          });
          console.log('‚úÖ Vendedor agregado:', docRef.id);
        }

        // Reload sellers
        await loadSellers();
        closeSellerModal();

      } catch (error) {
        console.error('‚ùå Error guardando vendedor:', error);
        alert('Error guardando vendedor. Int√©ntalo de nuevo.');
      }
    }

    // Delete seller
    async function deleteSeller(sellerId) {
      try {
        if (!window.firebase || !firebase.firestoreHelpers) {
          throw new Error('Firebase not available');
        }

        const { doc, deleteDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const sellerRef = doc(db, 'vendedores', sellerId);
        await deleteDoc(sellerRef);

        console.log('‚úÖ Vendedor eliminado:', sellerId);
        await loadSellers();

      } catch (error) {
        console.error('‚ùå Error eliminando vendedor:', error);
        alert('Error eliminando vendedor. Int√©ntalo de nuevo.');
      }
    }

    // === PRODUCT PRICING FUNCTIONS ===

    // Load products from API (same endpoint as used in main.js)
    async function loadProducts() {
      console.log('üöÄ loadProducts called');
      try {
        // Check if we're already loading
        if (window.productsLoading) {
          console.log('‚è≥ Products already loading, skipping...');
          return;
        }

        window.productsLoading = true;

        if (!window.firebase || !firebase.firestoreHelpers) {
          console.log('‚ö†Ô∏è Firebase not ready for products, waiting...');
          window.productsLoading = false;
          setTimeout(() => {
            console.log('üîÑ Retrying loadProducts after Firebase delay');
            loadProducts();
          }, 1000);
          return;
        }

        console.log('üì¶ Cargando productos desde API...');

        // Show loading state in button
        const loadBtn = document.getElementById('loadProductsBtn');
        const originalLoadText = loadBtn ? loadBtn.querySelector('.mdc-button__label').textContent : '';
        if (loadBtn) {
          loadBtn.querySelector('.mdc-button__label').innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin-right: 8px;"></div>Cargando...';
          loadBtn.disabled = true;
        }

        // Show loading state
        const container = document.getElementById('productsContainer');
        container.innerHTML = `
          <div class="loading-products">
            <div class="loading-content">
              <div class="loading-spinner"></div>
              <p>Cargando productos desde la API...</p>
            </div>
          </div>
        `;

        // Use same API configuration as main.js
        const API_BASE = '/api';
        const AUTH_URL = `${API_BASE}/authenticate`;
        const STOCK_URL = `${API_BASE}/stock`;

        const CREDENTIALS = {
          username: 'Api',
          md5password: 'e10adc3949ba59abbe56e057f20f883e'
        };

        // Authenticate
        const authResp = await fetch(AUTH_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(CREDENTIALS)
        });

        if (!authResp.ok) {
          throw new Error(`Authentication failed (${authResp.status})`);
        }

        const authData = await authResp.json();
        if (!authData.ok || !authData.token) {
          throw new Error('Invalid authentication response');
        }

        // Fetch stock data
        const query = new URLSearchParams({ format: 'JSON', ViewOption: 0 }).toString();
        const stockResp = await fetch(`${STOCK_URL}?${query}`, {
          headers: { Authorization: `Bearer ${authData.token}` }
        });

        if (!stockResp.ok) {
          throw new Error(`Error fetching stock (${stockResp.status})`);
        }

        const stockData = await stockResp.json();
        const products = Array.isArray(stockData) ? stockData : (stockData.data || stockData.list || []);

        // Process and store products with existing prices
        window.products = await processProductsWithPrices(products);

        console.log('‚úÖ Productos cargados:', window.products.length);
        displayProducts();

        // Restore button state
        if (loadBtn) {
          loadBtn.querySelector('.mdc-button__label').textContent = originalLoadText;
          loadBtn.disabled = false;
        }

        // Reset loading flag
        window.productsLoading = false;

      } catch (error) {
        console.error('‚ùå Error cargando productos:', error);

        // Restore button state on error
        const loadBtn = document.getElementById('loadProductsBtn');
        const originalLoadText = loadBtn ? loadBtn.querySelector('.mdc-button__label').textContent.replace(/.*Cargando.../, 'Actualizar Productos') : 'Actualizar Productos';
        if (loadBtn) {
          loadBtn.querySelector('.mdc-button__label').textContent = originalLoadText;
          loadBtn.disabled = false;
        }

        // Reset loading flag
        window.productsLoading = false;

        document.getElementById('productsContainer').innerHTML = `
          <div class="no-products">
            Error cargando productos: ${error.message}
            <br><br>
            <button class="mdc-button mdc-button--outlined" onclick="loadProducts()">
              <span class="mdc-button__label">Reintentar</span>
            </button>
          </div>
        `;
      }
    }

    // Process products and merge with existing price data from Firebase
    async function processProductsWithPrices(rawProducts) {
      const { collection, getDocs } = firebase.firestoreHelpers;
      const db = firebase.firestore();

      // Load existing prices from Firebase
      const pricesCollection = collection(db, 'precios');
      const pricesSnapshot = await getDocs(pricesCollection);

      const existingPrices = new Map();
      pricesSnapshot.forEach((doc) => {
        const data = doc.data();
        existingPrices.set(data.articulo, {
          id: doc.id,
          precio1: data.precio1 || 0,
          precio2: data.precio2 || 0,
          precio3: data.precio3 || 0,
          precio4: data.precio4 || 0
        });
      });

      // Process and normalize product data
      return rawProducts.map(raw => {
        // Extract articulo and description using same logic as main.js
        const articulo = getFirstExisting(raw, ['Art√≠culo', 'Articulo', 'item', 'Item', 'Codigo', 'C√≥digo']) || '';
        const description = getFirstExisting(raw, ['Descripci√≥n', 'Descripcion', 'description', 'Description', 'Detalle']) || '';

        // Get existing prices or set defaults
        const prices = existingPrices.get(articulo) || {
          precio1: 0,
          precio2: 0,
          precio3: 0,
          precio4: 0
        };

        return {
          articulo,
          description,
          ...prices,
          modified: false
        };
      }).filter(product => product.articulo && product.description); // Only include products with both fields
    }

    // Helper function from main.js for extracting fields
    function normalizeKey(key) {
      return String(key)
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // quitar acentos
        .replace(/[^a-z0-9]/g, '');
    }

    function getFirstExisting(row, candidateKeys) {
      const normalizedMap = new Map();
      for (const k of Object.keys(row || {})) {
        normalizedMap.set(normalizeKey(k), k);
      }
      for (const c of candidateKeys) {
        const nk = normalizeKey(c);
        if (normalizedMap.has(nk)) {
          const originalKey = normalizedMap.get(nk);
          return row[originalKey];
        }
      }
      return undefined;
    }

    // Display products in pricing table
    function displayProducts() {
      const container = document.getElementById('productsContainer');

      if (!window.products || window.products.length === 0) {
        container.innerHTML = `
          <div class="no-products">
            No se encontraron productos.
            <br><br>
            <button class="mdc-button mdc-button--outlined" onclick="loadProducts()">
              <span class="mdc-button__label">Cargar Productos</span>
            </button>
          </div>
        `;
        return;
      }

      const productsHTML = `
        <div class="price-stats">
          <div class="price-stat">
            Total productos: <span class="price-stat-number">${window.products.length}</span>
          </div>
          <div class="price-stat">
            Con precios: <span class="price-stat-number">${window.products.filter(p => p.precio1 > 0 || p.precio2 > 0 || p.precio3 > 0 || p.precio4 > 0).length}</span>
          </div>
        </div>

        <table class="products-table">
          <thead>
            <tr>
              <th>Art√≠culo</th>
              <th>Descripci√≥n</th>
              <th>Precio 1</th>
              <th>Precio 2</th>
              <th>Precio 3</th>
              <th>Precio 4</th>
            </tr>
          </thead>
          <tbody>
            ${window.products.map(product => `
              <tr data-articulo="${product.articulo}">
                <td>
                  <span class="product-code">${product.articulo}</span>
                </td>
                <td>
                  <span class="product-description">${product.description}</span>
                </td>
                <td>
                  <input type="number"
                         class="price-input"
                         data-articulo="${product.articulo}"
                         data-price="precio1"
                         value="${product.precio1}"
                         step="0.01"
                         min="0"
                         placeholder="0.00">
                </td>
                <td>
                  <input type="number"
                         class="price-input"
                         data-articulo="${product.articulo}"
                         data-price="precio2"
                         value="${product.precio2}"
                         step="0.01"
                         min="0"
                         placeholder="0.00">
                </td>
                <td>
                  <input type="number"
                         class="price-input"
                         data-articulo="${product.articulo}"
                         data-price="precio3"
                         value="${product.precio3}"
                         step="0.01"
                         min="0"
                         placeholder="0.00">
                </td>
                <td>
                  <input type="number"
                         class="price-input"
                         data-articulo="${product.articulo}"
                         data-price="precio4"
                         value="${product.precio4}"
                         step="0.01"
                         min="0"
                         placeholder="0.00">
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = productsHTML;

      // Show save button
      const saveBtn = document.getElementById('saveAllPricesBtn');
      if (saveBtn) {
        saveBtn.style.display = 'inline-flex';
      }

      // Add event listeners to price inputs
      setupPriceInputListeners();
    }

    // Setup event listeners for price inputs
    function setupPriceInputListeners() {
      const priceInputs = document.querySelectorAll('.price-input');
      priceInputs.forEach(input => {
        input.addEventListener('input', function() {
          const articulo = this.dataset.articulo;
          const priceField = this.dataset.price;
          const value = parseFloat(this.value) || 0;

          // Find and update the product in memory
          const product = window.products.find(p => p.articulo === articulo);
          if (product) {
            product[priceField] = value;
            product.modified = true;
            this.classList.add('modified');
          }
        });

        input.addEventListener('blur', function() {
          // Format the value on blur
          const value = parseFloat(this.value) || 0;
          this.value = value.toFixed(2);
        });
      });
    }

    // Save all prices to Firebase
    async function saveAllPrices() {
      try {
        if (!window.firebase || !firebase.firestoreHelpers) {
          throw new Error('Firebase not available');
        }

        if (!window.products) {
          throw new Error('No products loaded');
        }

        const { collection, doc, setDoc, updateDoc, addDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();
        const pricesCollection = collection(db, 'precios');

        console.log('üíæ Guardando precios...');

        // Show saving indicator
        const saveBtn = document.getElementById('saveAllPricesBtn');
        const originalText = saveBtn.querySelector('.mdc-button__label').textContent;
        saveBtn.querySelector('.mdc-button__label').innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin-right: 8px;"></div>Guardando...';
        saveBtn.disabled = true;

        let savedCount = 0;

        for (const product of window.products) {
          const priceData = {
            articulo: product.articulo,
            description: product.description,
            precio1: product.precio1 || 0,
            precio2: product.precio2 || 0,
            precio3: product.precio3 || 0,
            precio4: product.precio4 || 0,
            updatedAt: new Date()
          };

          if (product.id) {
            // Update existing price record
            const priceRef = doc(db, 'precios', product.id);
            await updateDoc(priceRef, priceData);
          } else {
            // Create new price record
            const docRef = await addDoc(pricesCollection, {
              ...priceData,
              createdAt: new Date()
            });
            product.id = docRef.id;
          }

          product.modified = false;
          savedCount++;
        }

        // Remove modified styling from all inputs
        document.querySelectorAll('.price-input.modified').forEach(input => {
          input.classList.remove('modified');
        });

        console.log(`‚úÖ Precios guardados: ${savedCount} productos`);
        alert(`Precios guardados exitosamente para ${savedCount} productos`);

        // Restore button
        saveBtn.querySelector('.mdc-button__label').textContent = originalText;
        saveBtn.disabled = false;

      } catch (error) {
        console.error('‚ùå Error guardando precios:', error);
        alert('Error guardando precios. Int√©ntalo de nuevo.');

        // Restore button
        const saveBtn = document.getElementById('saveAllPricesBtn');
        saveBtn.querySelector('.mdc-button__label').textContent = 'Guardar Todos los Precios';
        saveBtn.disabled = false;
      }
    }

    // Import prices from CSV/Excel file
    async function importPrices() {
      const fileInput = document.getElementById('pricesFileInput');
      fileInput.click();
    }

    // Process imported price file
    async function processPriceFile(file) {
      try {
        console.log('üìÅ Procesando archivo de precios:', file.name);

        let data;
        const fileName = file.name.toLowerCase();

        if (fileName.endsWith('.csv')) {
          data = await parseCSV(file);
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
          data = await parseExcel(file);
        } else {
          throw new Error('Formato de archivo no soportado. Use CSV (.csv) o Excel (.xlsx, .xls)');
        }

        // Validate and process data
        const processedPrices = validateAndProcessPriceData(data);

        if (processedPrices.length === 0) {
          throw new Error('No se encontraron datos v√°lidos en el archivo');
        }

        // Show preview and confirm import
        const confirmMessage = `¬øDesea importar ${processedPrices.length} precios desde el archivo "${file.name}"?\n\nPrimeros 3 registros:\n${processedPrices.slice(0, 3).map(p => `‚Ä¢ ${p.articulo}: ${p.description} (Precios: ${p.precio1}, ${p.precio2}, ${p.precio3}, ${p.precio4})`).join('\n')}`;

        if (confirm(confirmMessage)) {
          // Show progress
          const container = document.getElementById('productsContainer');
          container.innerHTML = `
            <div class="loading-products">
              <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>Importando ${processedPrices.length} precios...</p>
              </div>
            </div>
          `;

          await importPriceData(processedPrices);
          alert(`‚úÖ Precios importados exitosamente: ${processedPrices.length} registros`);

          // Reload products to show updated prices (with small delay to ensure Firebase propagation)
          setTimeout(() => {
            if (window.loadProducts) {
              console.log('üîÑ Reloading products after import...');
              window.loadProducts();
            }
          }, 500);
        }

      } catch (error) {
        console.error('‚ùå Error importando precios:', error);
        alert(`Error importando precios: ${error.message}`);
      }
    }

    // Parse CSV file
    function parseCSV(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const text = e.target.result;
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

            const data = [];
            for (let i = 1; i < lines.length; i++) {
              const line = lines[i].trim();
              if (!line) continue;

              const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
              const row = {};
              headers.forEach((header, index) => {
                row[header] = values[index] || '';
              });
              data.push(row);
            }
            resolve(data);
          } catch (error) {
            reject(new Error('Error parsing CSV: ' + error.message));
          }
        };
        reader.onerror = () => reject(new Error('Error reading file'));
        reader.readAsText(file, 'UTF-8');
      });
    }

    // Parse Excel file using SheetJS
    function parseExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            // Check if XLSX library is loaded
            if (typeof XLSX === 'undefined') {
              throw new Error('SheetJS library not loaded. Please refresh the page and try again.');
            }

            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            // Get first worksheet
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            // Convert to JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {
              header: 1, // Use first row as header
              defval: '' // Default value for empty cells
            });

            if (jsonData.length < 2) {
              throw new Error('El archivo Excel debe tener al menos una fila de encabezados y una fila de datos');
            }

            // Convert to same format as CSV parser
            const headers = jsonData[0].map(h => String(h).trim());
            const processedData = [];

            for (let i = 1; i < jsonData.length; i++) {
              const row = jsonData[i];
              const rowObj = {};

              headers.forEach((header, index) => {
                rowObj[header] = row[index] ? String(row[index]).trim() : '';
              });

              // Skip empty rows
              const hasData = Object.values(rowObj).some(value => value && value.trim());
              if (hasData) {
                processedData.push(rowObj);
              }
            }

            console.log(`üìä Excel procesado: ${processedData.length} filas, Columnas: ${headers.join(', ')}`);
            resolve(processedData);

          } catch (error) {
            reject(new Error('Error parsing Excel file: ' + error.message));
          }
        };

        reader.onerror = () => reject(new Error('Error reading Excel file'));
        reader.readAsArrayBuffer(file);
      });
    }

    // Validate and process price data
    function validateAndProcessPriceData(data) {
      const processedPrices = [];

      for (const row of data) {
        // Look for common column names (case insensitive)
        const articulo = findColumnValue(row, ['articulo', 'codigo', 'item', 'article', 'code']);
        const description = findColumnValue(row, ['descripcion', 'description', 'detalle', 'nombre', 'name']);
        const precio1 = parseFloat(findColumnValue(row, ['precio1', 'precio_1', 'price1', 'price_1']) || 0);
        const precio2 = parseFloat(findColumnValue(row, ['precio2', 'precio_2', 'price2', 'price_2']) || 0);
        const precio3 = parseFloat(findColumnValue(row, ['precio3', 'precio_3', 'price3', 'price_3']) || 0);
        const precio4 = parseFloat(findColumnValue(row, ['precio4', 'precio_4', 'price4', 'price_4']) || 0);

        if (articulo && articulo.trim()) {
          processedPrices.push({
            articulo: articulo.trim(),
            description: description ? description.trim() : '',
            precio1,
            precio2,
            precio3,
            precio4
          });
        }
      }

      return processedPrices;
    }

    // Helper function to find column value by different possible names
    function findColumnValue(row, possibleNames) {
      for (const name of possibleNames) {
        for (const key in row) {
          if (key.toLowerCase().includes(name.toLowerCase())) {
            return row[key];
          }
        }
      }
      return null;
    }

    // Import price data to Firebase
    async function importPriceData(pricesData) {
      if (!window.firebase || !firebase.firestoreHelpers) {
        throw new Error('Firebase not available');
      }

      const { collection, doc, setDoc, addDoc, getDocs, query, where } = firebase.firestoreHelpers;
      const db = firebase.firestore();
      const pricesCollection = collection(db, 'precios');

      let importedCount = 0;
      let updatedCount = 0;

      for (const priceData of pricesData) {
        try {
          // Check if price record already exists
          const q = query(pricesCollection, where('articulo', '==', priceData.articulo));
          const existingDocs = await getDocs(q);

          const dataToSave = {
            articulo: priceData.articulo,
            description: priceData.description,
            precio1: priceData.precio1 || 0,
            precio2: priceData.precio2 || 0,
            precio3: priceData.precio3 || 0,
            precio4: priceData.precio4 || 0,
            updatedAt: new Date()
          };

          if (existingDocs.empty) {
            // Create new price record
            await addDoc(pricesCollection, {
              ...dataToSave,
              createdAt: new Date()
            });
            importedCount++;
            console.log(`‚úÖ Created price for: ${priceData.articulo}`);
          } else {
            // Update existing price record
            const existingDoc = existingDocs.docs[0];
            const priceRef = doc(db, 'precios', existingDoc.id);
            await updateDoc(priceRef, dataToSave);
            updatedCount++;
            console.log(`‚úÖ Updated price for: ${priceData.articulo}`);
          }
        } catch (error) {
          console.warn('Error importing price for', priceData.articulo, error);
        }
      }

      console.log(`‚úÖ Importaci√≥n completada: ${importedCount} nuevos, ${updatedCount} actualizados`);
    }

    // Export prices to CSV
    function exportPricesToCSV() {
      try {
        if (!window.products || window.products.length === 0) {
          alert('No hay productos cargados para exportar');
          return;
        }

        // Prepare CSV data
        const headers = ['Articulo', 'Descripcion', 'Precio1', 'Precio2', 'Precio3', 'Precio4'];
        const csvData = [headers];

        // Add product data
        window.products.forEach(product => {
          csvData.push([
            product.articulo || '',
            product.description || '',
            product.precio1 || 0,
            product.precio2 || 0,
            product.precio3 || 0,
            product.precio4 || 0
          ]);
        });

        // Convert to CSV string
        const csvContent = csvData.map(row =>
          row.map(field => `"${String(field).replace(/"/g, '""')}"`)
             .join(',')
        ).join('\n');

        // Create and download file
        const fileName = `precios_${getCurrentDateString()}.csv`;
        downloadFile(csvContent, fileName, 'text/csv;charset=utf-8;');

        console.log(`‚úÖ CSV exportado: ${window.products.length} productos`);
        alert(`CSV exportado exitosamente: ${window.products.length} productos`);

      } catch (error) {
        console.error('‚ùå Error exportando CSV:', error);
        alert('Error exportando CSV: ' + error.message);
      }
    }

    // Export prices to Excel
    function exportPricesToExcel() {
      try {
        if (!window.products || window.products.length === 0) {
          alert('No hay productos cargados para exportar');
          return;
        }

        // Check if XLSX library is loaded
        if (typeof XLSX === 'undefined') {
          alert('SheetJS library not loaded. Please refresh the page and try again.');
          return;
        }

        // Prepare Excel data
        const headers = ['Articulo', 'Descripcion', 'Precio1', 'Precio2', 'Precio3', 'Precio4'];
        const excelData = [headers];

        // Add product data
        window.products.forEach(product => {
          excelData.push([
            product.articulo || '',
            product.description || '',
            product.precio1 || 0,
            product.precio2 || 0,
            product.precio3 || 0,
            product.precio4 || 0
          ]);
        });

        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);

        // Set column widths
        ws['!cols'] = [
          { width: 15 }, // Articulo
          { width: 40 }, // Descripcion
          { width: 12 }, // Precio1
          { width: 12 }, // Precio2
          { width: 12 }, // Precio3
          { width: 12 }  // Precio4
        ];

        // Format header row
        const headerStyle = {
          font: { bold: true, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "4CAF50" } },
          alignment: { horizontal: "center", vertical: "center" }
        };

        // Apply header style
        for (let col = 0; col < headers.length; col++) {
          const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
          if (!ws[cellRef]) ws[cellRef] = { t: 's', v: '' };
          ws[cellRef].s = headerStyle;
        }

        // Format price columns as currency
        for (let row = 1; row <= window.products.length; row++) {
          for (let col = 2; col < 6; col++) { // Columns C to F (Precio1-4)
            const cellRef = XLSX.utils.encode_cell({ r: row, c: col });
            if (ws[cellRef]) {
              ws[cellRef].z = '#,##0.00';
              ws[cellRef].t = 'n';
            }
          }
        }

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Precios');

        // Generate and download file
        const fileName = `precios_${getCurrentDateString()}.xlsx`;
        XLSX.writeFile(wb, fileName);

        console.log(`‚úÖ Excel exportado: ${window.products.length} productos`);
        alert(`Excel exportado exitosamente: ${window.products.length} productos`);

      } catch (error) {
        console.error('‚ùå Error exportando Excel:', error);
        alert('Error exportando Excel: ' + error.message);
      }
    }

    // Helper function to get current date string
    function getCurrentDateString() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      return `${year}${month}${day}_${hours}${minutes}`;
    }

    // Helper function to download file
    function downloadFile(content, fileName, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    // Expose functions globally
    window.loadProducts = loadProducts;
    window.saveAllPrices = saveAllPrices;
    window.importPrices = importPrices;
    window.processPriceFile = processPriceFile;
    window.exportPricesToCSV = exportPricesToCSV;
    window.exportPricesToExcel = exportPricesToExcel;

    // === ORDER MANAGEMENT FUNCTIONS ===

    // Order status options - Sincronizado con SEGUIMIENTO
    const ORDER_STATUS_OPTIONS = [
      { value: 'borrador', label: 'BORRADOR', class: 'status-borrador' },
      { value: 'revision', label: 'EN REVISI√ìN', class: 'status-revision' },
      { value: 'aprobada', label: 'APROBADA', class: 'status-aprobada' },
      { value: 'preparacion', label: 'EN PREPARACI√ìN', class: 'status-preparacion' },
      { value: 'listo', label: 'LISTO PARA RETIRO/DESPACHO', class: 'status-listo' },
      { value: 'despachada', label: 'DESPACHADA', class: 'status-despachada' },
      { value: 'entregada', label: 'ENTREGADA', class: 'status-entregada' },
      { value: 'cerrada', label: 'CERRADA', class: 'status-cerrada' },
      { value: 'cancelada', label: 'CANCELADA', class: 'status-cancelada' }
    ];

    // Load orders from Firebase
    async function loadOrders() {
      try {
        console.log('üîÑ [MASTER] loadOrders() called');

        if (!window.firebase || !firebase.firestoreHelpers) {
          console.log('‚ö†Ô∏è Firebase not ready for orders, waiting...');
          setTimeout(loadOrders, 1000);
          return;
        }

        const { collection, getDocs, orderBy, query, updateDoc, doc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        console.log('üìã [MASTER] Cargando √≥rdenes desde colecci√≥n "pedidos"...');

        const pedidosCollection = collection(db, 'pedidos');
        const q = query(pedidosCollection, orderBy('timestamp', 'desc'));
        const querySnapshot = await getDocs(q);

        console.log(`üì¶ [MASTER] Query ejecutada, documentos encontrados: ${querySnapshot.size}`);

        window.orders = [];
        const updatePromises = [];

        querySnapshot.forEach((docSnapshot) => {
          const data = docSnapshot.data();
          console.log(`üìÑ [MASTER] Procesando orden ${docSnapshot.id}:`, {
            logisticsState: data.logisticsState,
            numeroOrden: data.numeroOrden,
            total: data.total
          });

          // Check if logisticsState exists, if not, set it to 'borrador'
          if (!data.logisticsState) {
            console.log(`üîÑ Setting logisticsState to 'borrador' for order ${docSnapshot.id}`);
            const orderRef = doc(db, 'pedidos', docSnapshot.id);
            updatePromises.push(updateDoc(orderRef, { logisticsState: 'borrador' }));
          }

          window.orders.push({
            id: docSnapshot.id,
            ...data,
            logisticsState: data.logisticsState || 'borrador', // Default state
            // Convert timestamp to date string
            fechaLocal: data.fechaLocal || (data.timestamp && data.timestamp.toDate ?
              data.timestamp.toDate().toLocaleDateString('es-AR') : 'No date'),
            fecha: data.fecha && data.fecha.toDate ? data.fecha.toDate().toISOString().split('T')[0] :
                   data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().toISOString().split('T')[0] :
                   (data.fecha || new Date().toISOString().split('T')[0]),
            modified: false
          });
        });

        // Update orders that don't have logisticsState
        if (updatePromises.length > 0) {
          await Promise.all(updatePromises);
          console.log(`‚úÖ Updated ${updatePromises.length} orders with logisticsState`);
        }

        console.log('‚úÖ [MASTER] √ìrdenes cargadas desde pedidos:', window.orders.length);
        console.log('üìä [MASTER] Desglose por estado:', {
          borrador: window.orders.filter(o => o.logisticsState === 'borrador').length,
          revision: window.orders.filter(o => o.logisticsState === 'revision').length,
          aprobada: window.orders.filter(o => o.logisticsState === 'aprobada').length,
          preparacion: window.orders.filter(o => o.logisticsState === 'preparacion').length,
          listo: window.orders.filter(o => o.logisticsState === 'listo').length,
          despachada: window.orders.filter(o => o.logisticsState === 'despachada').length,
          entregada: window.orders.filter(o => o.logisticsState === 'entregada').length,
          cerrada: window.orders.filter(o => o.logisticsState === 'cerrada').length,
          cancelada: window.orders.filter(o => o.logisticsState === 'cancelada').length
        });

        console.log('üé® [MASTER] Llamando a displayOrders()...');
        displayOrders();

        console.log('üìä [MASTER] Llamando a updateOrderStats()...');
        updateOrderStats();

      } catch (error) {
        console.error('‚ùå [MASTER] Error cargando √≥rdenes:', error);
        const borradorContainer = document.getElementById('admin-borradorOrders');
        if (borradorContainer) {
          borradorContainer.innerHTML = `
            <div class="no-orders">
              Error cargando √≥rdenes: ${error.message}
            </div>
          `;
        }
      }
    }

    // Display orders in their respective sections (same as SEGUIMIENTO)
    function displayOrders() {
      console.log('üé® [MASTER] displayOrders() called with', window.orders?.length || 0, 'orders');

      const containers = {
        borrador: document.getElementById('admin-borradorOrders'),
        revision: document.getElementById('admin-revisionOrders'),
        aprobada: document.getElementById('admin-aprobadaOrders'),
        preparacion: document.getElementById('admin-preparacionOrders'),
        listo: document.getElementById('admin-listoOrders'),
        despachada: document.getElementById('admin-despachadaOrders'),
        entregada: document.getElementById('admin-entregadaOrders'),
        cerrada: document.getElementById('admin-cerradaOrders'),
        cancelada: document.getElementById('admin-canceladaOrders')
      };

      // Check if all containers exist
      const missingContainers = Object.entries(containers).filter(([key, val]) => !val).map(([key]) => key);
      if (missingContainers.length > 0) {
        console.error('‚ùå [MASTER] Admin MASTER containers not found:', missingContainers);
        return;
      }

      console.log('‚úÖ [MASTER] Todos los contenedores encontrados');

      // Define state flow: bidirectional movement with prev and next
      const stateFlow = {
        borrador: { next: 'revision', prev: null },
        revision: { next: 'aprobada', prev: 'borrador' },
        aprobada: { next: 'preparacion', prev: 'revision' },
        preparacion: { next: 'listo', prev: 'aprobada' },
        listo: { next: 'despachada', prev: 'preparacion' },
        despachada: { next: 'entregada', prev: 'listo' },
        entregada: { next: 'cerrada', prev: 'despachada' },
        cerrada: { next: null, prev: 'entregada' },
        cancelada: { next: null, prev: null }
      };

      // Separate orders by state
      const ordersByState = {
        borrador: window.orders.filter(order => order.logisticsState === 'borrador'),
        revision: window.orders.filter(order => order.logisticsState === 'revision'),
        aprobada: window.orders.filter(order => order.logisticsState === 'aprobada'),
        preparacion: window.orders.filter(order => order.logisticsState === 'preparacion'),
        listo: window.orders.filter(order => order.logisticsState === 'listo'),
        despachada: window.orders.filter(order => order.logisticsState === 'despachada'),
        entregada: window.orders.filter(order => order.logisticsState === 'entregada'),
        cerrada: window.orders.filter(order => order.logisticsState === 'cerrada'),
        cancelada: window.orders.filter(order => order.logisticsState === 'cancelada')
      };

      console.log('üìä [MASTER] √ìrdenes por estado:', {
        borrador: ordersByState.borrador.length,
        revision: ordersByState.revision.length,
        aprobada: ordersByState.aprobada.length,
        preparacion: ordersByState.preparacion.length,
        listo: ordersByState.listo.length,
        despachada: ordersByState.despachada.length,
        entregada: ordersByState.entregada.length,
        cerrada: ordersByState.cerrada.length,
        cancelada: ordersByState.cancelada.length
      });

      // Display orders in each section
      Object.entries(ordersByState).forEach(([state, stateOrders]) => {
        const container = containers[state];
        const currentFlow = stateFlow[state];

        console.log(`üé® [MASTER] Renderizando ${stateOrders.length} √≥rdenes para estado "${state}"`);

        if (stateOrders.length > 0) {
          const html = stateOrders.map(order => createAdminOrderHTML(order, currentFlow, state)).join('');
          console.log(`üìù [MASTER] HTML generado para ${state}:`, html.substring(0, 100) + '...');
          container.innerHTML = html;
        } else {
          const messages = {
            borrador: 'No hay pedidos en borrador',
            revision: 'No hay pedidos en revisi√≥n',
            aprobada: 'No hay pedidos aprobados',
            preparacion: 'No hay pedidos en preparaci√≥n',
            listo: 'No hay pedidos listos',
            despachada: 'No hay pedidos despachados',
            entregada: 'No hay pedidos entregados',
            cerrada: 'No hay pedidos cerrados',
            cancelada: 'No hay pedidos cancelados'
          };
          container.innerHTML = `<p class="no-orders">${messages[state]}</p>`;
        }
      });

      console.log('‚úÖ [MASTER] displayOrders() completado');
    }

    // Create HTML for an order item (admin version with edit capabilities)
    function createAdminOrderHTML(order, currentFlow, currentState) {
      const canEdit = isUserAdmin;
      const hasNext = currentFlow && currentFlow.next !== null;
      const hasPrev = currentFlow && currentFlow.prev !== null;
      let buttonHtml = '';

      const stateLabels = {
        borrador: 'Borrador',
        revision: 'En Revisi√≥n',
        aprobada: 'Aprobada',
        preparacion: 'En Preparaci√≥n',
        listo: 'Listo para Retiro/Despacho',
        despachada: 'Despachada',
        entregada: 'Entregada',
        cerrada: 'Cerrada',
        cancelada: 'Cancelada'
      };

      // Admin can move orders and has additional controls
      if (canEdit) {
        // Flecha hacia arriba (volver al estado anterior)
        if (hasPrev) {
          const prevStateLabel = stateLabels[currentFlow.prev] || currentFlow.prev;
          buttonHtml += `<button class="move-order-btn-up" onclick="adminMoveOrder('${order.id}', '${currentFlow.prev}')" title="Volver a ${prevStateLabel}">‚Üë</button>`;
        }

        // Flecha hacia abajo (avanzar al siguiente estado)
        if (hasNext) {
          const nextStateLabel = stateLabels[currentFlow.next] || currentFlow.next;
          buttonHtml += `
            <button class="move-order-btn" onclick="adminMoveOrder('${order.id}', '${currentFlow.next}')" title="Mover a ${nextStateLabel}">
              ‚Üì ${nextStateLabel}
            </button>
          `;
        }

        // Add cancel button for non-cancelled orders
        if (currentState !== 'cancelada' && currentState !== 'cerrada') {
          buttonHtml += `
            <button class="cancel-order-btn" onclick="adminMoveOrder('${order.id}', 'cancelada')" title="Cancelar pedido">
              ‚ùå Cancelar
            </button>
          `;
        }
      }

      // Final states display
      if (!hasNext && !hasPrev) {
        // Final states (cerrada, cancelada)
        if (currentState === 'entregada') {
          buttonHtml = `<span class="delivered-status">‚úì Entregada</span>`;
        } else if (currentState === 'cerrada') {
          buttonHtml = `<span class="closed-status">üîí Cerrada</span>`;
        } else if (currentState === 'cancelada') {
          buttonHtml = `<span class="cancelled-status">‚ùå Cancelada</span>`;
        }
      }

      // Add edit button for admin
      if (canEdit) {
        buttonHtml += `
          <button class="edit-order-btn" onclick="adminEditOrder('${order.id}')" title="Editar orden">
            ‚úèÔ∏è Editar
          </button>
        `;
      }

      return `
        <div class="order-item" data-order-id="${order.id}">
          <div class="order-info">
            <div class="order-number">#${order.numeroOrden || order.id.slice(-6)}</div>
            <div class="order-details">
              ${order.fechaLocal || order.fecha || 'No date'} ‚Ä¢ ${order.cantidadItems || order.items?.length || 0} items ‚Ä¢ $${formatNumber(order.total || order.montoTotal || 0)}
              ${order.cliente ? '<br>' + order.cliente : ''}
            </div>
          </div>
          <div class="order-actions">
            ${buttonHtml}
          </div>
        </div>
      `;
    }

    // Helper function to format numbers
    function formatNumber(num) {
      return Number(num).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Admin move order to next state
    async function adminMoveOrder(orderId, nextState) {
      if (!isUserAdmin) {
        alert('‚ö†Ô∏è No tienes permisos para cambiar el estado de las √≥rdenes');
        return;
      }

      if (!firebase || !firebase.firestore) {
        console.error('‚ùå Firebase not available');
        return;
      }

      try {
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', orderId);
        await updateDoc(orderRef, {
          logisticsState: nextState,
          lastStateUpdate: new Date()
        });

        console.log(`‚úÖ Order ${orderId} moved to ${nextState}`);

        // Reload orders to reflect changes
        await loadOrders();

      } catch (error) {
        console.error('‚ùå Error moving order:', error);
        alert('Error al cambiar el estado de la orden');
      }
    }

    // Admin edit order function - redirect to marketplace with order items
    async function adminEditOrder(orderId) {
      if (!isUserAdmin) {
        alert('‚ö†Ô∏è No tienes permisos para editar √≥rdenes');
        return;
      }

      try {
        const { doc, getDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', orderId);
        const orderDoc = await getDoc(orderRef);

        if (!orderDoc.exists()) {
          alert('‚ùå Orden no encontrada');
          return;
        }

        const order = orderDoc.data();

        // Save order items to localStorage for marketplace to load
        if (order.items && order.items.length > 0) {
          const cartItems = order.items.map(item => ({
            item: item.articulo || item.item,
            description: item.description,
            price: item.price,
            quantity: item.quantity
          }));

          localStorage.setItem('cart', JSON.stringify(cartItems));
          localStorage.setItem('editingOrderId', orderId);

          console.log('üì¶ Orden guardada en localStorage, redirigiendo a marketplace...');
          console.log('üì¶ Items:', cartItems);

          // Redirect to marketplace
          window.location.href = 'marketplace.html';
        } else {
          alert('‚ö†Ô∏è Esta orden no tiene productos para editar');
        }

      } catch (error) {
        console.error('‚ùå Error loading order:', error);
        alert('‚ùå Error al cargar la orden');
      }
    }

    window.adminMoveOrder = adminMoveOrder;
    window.adminEditOrder = adminEditOrder;

    // Delete all orders from Firebase
    async function deleteAllOrders() {
      if (!isUserAdmin) {
        alert('‚ö†Ô∏è No tienes permisos para eliminar √≥rdenes');
        return;
      }

      const confirmMsg = '‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nEsto eliminar√° TODAS las √≥rdenes de la base de datos de forma PERMANENTE.\n\nEsta acci√≥n NO se puede deshacer.\n\nEscribe "BORRAR TODO" para confirmar:';
      const userInput = prompt(confirmMsg);

      if (userInput !== 'BORRAR TODO') {
        alert('‚ùå Operaci√≥n cancelada');
        return;
      }

      try {
        console.log('üóëÔ∏è [MASTER] Eliminando todas las √≥rdenes...');

        const { collection, getDocs, deleteDoc, doc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        // Get all orders
        const pedidosCollection = collection(db, 'pedidos');
        const querySnapshot = await getDocs(pedidosCollection);

        console.log(`üì¶ [MASTER] Encontradas ${querySnapshot.size} √≥rdenes para eliminar`);

        const deletePromises = [];
        querySnapshot.forEach((docSnapshot) => {
          const orderRef = doc(db, 'pedidos', docSnapshot.id);
          deletePromises.push(deleteDoc(orderRef));
        });

        await Promise.all(deletePromises);

        console.log(`‚úÖ [MASTER] ${querySnapshot.size} √≥rdenes eliminadas`);
        alert(`‚úÖ ${querySnapshot.size} √≥rdenes eliminadas correctamente`);

        // Clear local data and reload
        window.orders = [];
        await loadOrders();

      } catch (error) {
        console.error('‚ùå [MASTER] Error eliminando √≥rdenes:', error);
        alert('‚ùå Error: ' + error.message);
      }
    }

    window.deleteAllOrders = deleteAllOrders;

    // Update order statistics
    function updateOrderStats() {
      if (!window.orders) return;

      console.log('üìä [MASTER] Actualizando estad√≠sticas KPI...');

      const totalOrders = window.orders.length;
      const borradorOrders = window.orders.filter(o => o.logisticsState === 'borrador').length;
      const revisionOrders = window.orders.filter(o => o.logisticsState === 'revision').length;
      const aprobadaOrders = window.orders.filter(o => o.logisticsState === 'aprobada').length;
      const preparacionOrders = window.orders.filter(o => o.logisticsState === 'preparacion').length;
      const listoOrders = window.orders.filter(o => o.logisticsState === 'listo').length;
      const despachadaOrders = window.orders.filter(o => o.logisticsState === 'despachada').length;
      const entregadaOrders = window.orders.filter(o => o.logisticsState === 'entregada').length;
      const cerradaOrders = window.orders.filter(o => o.logisticsState === 'cerrada').length;
      const canceladaOrders = window.orders.filter(o => o.logisticsState === 'cancelada').length;

      console.log('üìä [MASTER] KPI:', {
        total: totalOrders,
        borrador: borradorOrders,
        revision: revisionOrders,
        aprobada: aprobadaOrders,
        preparacion: preparacionOrders,
        listo: listoOrders,
        despachada: despachadaOrders,
        entregada: entregadaOrders,
        cerrada: cerradaOrders,
        cancelada: canceladaOrders
      });

      // Actualizar los elementos del DOM
      const totalEl = document.getElementById('totalOrders');
      const borradorEl = document.getElementById('borradorOrders');
      const revisionEl = document.getElementById('revisionOrders');
      const aprobadaEl = document.getElementById('aprobadaOrders');
      const preparacionEl = document.getElementById('preparacionOrders');
      const listoEl = document.getElementById('listoOrders');
      const despachadaEl = document.getElementById('despachadaOrders');
      const entregadaEl = document.getElementById('entregadaOrders');
      const cerradaEl = document.getElementById('cerradaOrders');
      const canceladaEl = document.getElementById('canceladaOrders');

      if (totalEl) totalEl.textContent = totalOrders;
      if (borradorEl) borradorEl.textContent = borradorOrders;
      if (revisionEl) revisionEl.textContent = revisionOrders;
      if (aprobadaEl) aprobadaEl.textContent = aprobadaOrders;
      if (preparacionEl) preparacionEl.textContent = preparacionOrders;
      if (listoEl) listoEl.textContent = listoOrders;
      if (despachadaEl) despachadaEl.textContent = despachadaOrders;
      if (entregadaEl) entregadaEl.textContent = entregadaOrders;
      if (cerradaEl) cerradaEl.textContent = cerradaOrders;
      if (canceladaEl) canceladaEl.textContent = canceladaOrders;

      console.log('‚úÖ [MASTER] Estad√≠sticas KPI actualizadas');
    }

    // Expose functions globally
    window.loadOrders = loadOrders;

    // === CLIENT MANAGEMENT FUNCTIONS ===

    // Load clients from Firebase
    async function loadClients() {
      const tableBody = document.getElementById('clientesTableBody');

      if (!tableBody) {
        console.warn('‚ö†Ô∏è Elemento clientesTableBody no encontrado');
        return;
      }

      if (!firebase || !firebase.firestore) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="16" style="text-align: center; padding: 20px;">
              ‚ùå Firebase no est√° disponible
            </td>
          </tr>
        `;
        return;
      }

      try {
        console.log('üë• Cargando clientes desde Firebase...');

        const { collection, getDocs, query, orderBy } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clientesCollection = collection(db, 'clientes');
        const q = query(clientesCollection, orderBy('codigo', 'asc'));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="16" style="text-align: center; padding: 20px;">
                üìù No hay clientes registrados
              </td>
            </tr>
          `;
          updateClientStats();
          return;
        }

        const clientes = [];
        querySnapshot.forEach(doc => {
          clientes.push({
            id: doc.id,
            ...doc.data()
          });
        });

        console.log(`‚úÖ Cargados ${clientes.length} clientes desde Firebase`);

        // Guardar clientes globalmente para b√∫squeda
        window.clients = clientes;
        window.allClients = clientes; // Copia para filtrado

        // Mostrar todos los clientes inicialmente
        displayClients(clientes);
        updateClientStats();

      } catch (error) {
        console.error('‚ùå Error cargando clientes:', error);
        tableBody.innerHTML = `
          <tr>
            <td colspan="16" style="text-align: center; padding: 20px;">
              ‚ùå Error cargando clientes
            </td>
          </tr>
        `;
      }
    }

    // Display clients in the table
    function displayClients(clientes) {
      const tableBody = document.getElementById('clientesTableBody');

      if (!tableBody) {
        console.warn('‚ö†Ô∏è Elemento clientesTableBody no encontrado');
        return;
      }

      if (!clientes || clientes.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="16" style="text-align: center; padding: 20px;">
              üìù No se encontraron clientes
            </td>
          </tr>
        `;
        return;
      }

      tableBody.innerHTML = clientes.map(cliente => `
        <tr>
          <td>${cliente.codigo || ''}</td>
          <td>${cliente.nombre || ''}</td>
          <td>${cliente.nombreComercial || ''}</td>
          <td>${cliente.grupo || ''}</td>
          <td>${cliente.departamento || ''}</td>
          <td>${cliente.inscripcion || ''}</td>
          <td>${cliente.nroDocumento || ''}</td>
          <td>${cliente.direccion || ''}</td>
          <td>${cliente.ciudad || ''}</td>
          <td>${cliente.provincia || ''}</td>
          <td>${cliente.pais || ''}</td>
          <td>${cliente.telefono || ''}</td>
          <td>${cliente.email || ''}</td>
          <td>
            <select class="client-seller-select"
                    data-client-id="${cliente.id}"
                    onchange="updateClientSeller('${cliente.id}', this.value)"
                    style="padding: 4px 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0; min-width: 120px;">
              <option value="">Sin asignar</option>
              ${(window.sellers || []).map(seller => `
                <option value="${seller.id}" ${(cliente.vendedorId || cliente.vendedor) === seller.id ? 'selected' : ''}>
                  ${seller.name}
                </option>
              `).join('')}
            </select>
          </td>
          <td style="text-align: right;">${cliente.saldoCredito ? parseFloat(cliente.saldoCredito).toFixed(2) : '0.00'}</td>
          <td>
            <button class="edit-client-btn" onclick="editClient('${cliente.id}')">‚úèÔ∏è</button>
            <button class="delete-client-btn" onclick="deleteCliente('${cliente.id}')">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }

    // Search/filter clients
    function searchClients(searchTerm) {
      if (!window.allClients) {
        console.warn('‚ö†Ô∏è No hay clientes cargados para buscar');
        return;
      }

      const term = searchTerm.toLowerCase().trim();
      const resultsSpan = document.getElementById('clientSearchResults');

      // Si no hay t√©rmino de b√∫squeda, mostrar todos
      if (!term) {
        displayClients(window.allClients);
        window.clients = window.allClients;
        if (resultsSpan) {
          resultsSpan.textContent = `Mostrando todos los clientes (${window.allClients.length})`;
        }
        updateClientStats();
        return;
      }

      // Filtrar clientes por m√∫ltiples campos
      const filteredClientes = window.allClients.filter(cliente => {
        return (
          (cliente.codigo && cliente.codigo.toLowerCase().includes(term)) ||
          (cliente.nombre && cliente.nombre.toLowerCase().includes(term)) ||
          (cliente.nombreComercial && cliente.nombreComercial.toLowerCase().includes(term)) ||
          (cliente.grupo && cliente.grupo.toLowerCase().includes(term)) ||
          (cliente.email && cliente.email.toLowerCase().includes(term)) ||
          (cliente.telefono && cliente.telefono.toLowerCase().includes(term)) ||
          (cliente.nroDocumento && cliente.nroDocumento.toLowerCase().includes(term)) ||
          (cliente.ciudad && cliente.ciudad.toLowerCase().includes(term)) ||
          (cliente.direccion && cliente.direccion.toLowerCase().includes(term))
        );
      });

      // Mostrar resultados filtrados
      displayClients(filteredClientes);
      window.clients = filteredClientes;

      // Actualizar mensaje de resultados
      if (resultsSpan) {
        if (filteredClientes.length === 0) {
          resultsSpan.textContent = `No se encontraron clientes con "${searchTerm}"`;
          resultsSpan.style.color = '#ff9800';
        } else {
          resultsSpan.textContent = `Mostrando ${filteredClientes.length} de ${window.allClients.length} clientes`;
          resultsSpan.style.color = '#4CAF50';
        }
      }

      updateClientStats();
    }

    // Update client statistics
    function updateClientStats() {
      const totalClients = window.clients ? window.clients.length : 0;
      const totalBalance = window.clients ? window.clients.reduce((sum, c) => sum + (parseFloat(c.saldoCredito) || 0), 0) : 0;

      document.getElementById('totalClients').textContent = totalClients;
      document.getElementById('totalBalance').textContent = '$' + formatNumber(totalBalance);
    }

    // Import clients from Excel
    async function importClientes() {
      const fileInput = document.getElementById('excelFileInput');
      fileInput.click();
    }

    async function handleExcelImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!firebase || !firebase.firestore) {
        alert('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        console.log('üì• Importando archivo Excel:', file.name);

        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            console.log('üìä Datos le√≠dos del Excel:', jsonData.length, 'filas');

            const { collection, doc, setDoc } = firebase.firestoreHelpers;
            const db = firebase.firestore();

            let importados = 0;
            let saltados = 0;

            for (const row of jsonData) {
              let codigo = row['C√≥digo'] || row['Codigo'] || '';
              if (codigo !== null && codigo !== undefined) {
                codigo = String(codigo).trim();
              }

              if (!codigo || codigo === '' || codigo === 'null' || codigo === 'undefined') {
                console.log('‚ö†Ô∏è Saltando fila sin c√≥digo v√°lido:', row);
                saltados++;
                continue;
              }

              const saldoCredito = row['Saldo Cr√©dito'] || row['Saldo Credito'] || row['SaldoCredito'] || 0;

              const clienteData = {
                codigo: codigo,
                nombre: String(row['Nombre'] || '').trim(),
                nombreComercial: String(row['Nombre Comercial'] || '').trim(),
                grupo: String(row['Grupo de Clientes'] || row['Grupo'] || '').trim(),
                departamento: String(row['Departamento'] || '').trim(),
                inscripcion: String(row['Inscripci√≥n'] || row['Inscripcion'] || '').trim(),
                nroDocumento: String(row['Nro Documento'] || '').trim(),
                direccion: String(row['Direcci√≥n'] || row['Direccion'] || '').trim(),
                ciudad: String(row['Nombre (Ciudad)'] || row['Ciudad'] || '').trim(),
                provincia: String(row['Provincia'] || '').trim(),
                pais: String(row['Pa√≠s'] || row['Pais'] || '').trim(),
                telefono: String(row['Tel√©fono'] || row['Telefono'] || '').trim(),
                email: String(row['Email'] || '').trim(),
                saldoCredito: parseFloat(saldoCredito) || 0
              };

              const clienteRef = doc(db, 'clientes', clienteData.codigo);
              await setDoc(clienteRef, clienteData);
              importados++;

              if (importados % 50 === 0) {
                console.log(`üìä Progreso: ${importados} clientes importados...`);
              }
            }

            console.log(`‚úÖ Importaci√≥n completada: ${importados} clientes importados, ${saltados} filas saltadas`);
            alert(`‚úÖ Importados ${importados} clientes correctamente${saltados > 0 ? `\n‚ö†Ô∏è ${saltados} filas saltadas por falta de c√≥digo` : ''}`);

            loadClients();

          } catch (error) {
            console.error('‚ùå Error procesando Excel:', error);
            alert('‚ùå Error procesando archivo Excel: ' + error.message);
          }
        };

        reader.readAsArrayBuffer(file);

      } catch (error) {
        console.error('‚ùå Error importando clientes:', error);
        alert('‚ùå Error importando clientes: ' + error.message);
      }

      event.target.value = '';
    }

    // Export clients to Excel
    async function exportClientes() {
      if (!firebase || !firebase.firestore) {
        alert('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        console.log('üì§ Exportando clientes a Excel...');

        const { collection, getDocs, query, orderBy } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clientesCollection = collection(db, 'clientes');
        const q = query(clientesCollection, orderBy('codigo', 'asc'));
        const querySnapshot = await getDocs(q);

        const clientes = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          clientes.push({
            'C√≥digo': data.codigo || '',
            'Nombre': data.nombre || '',
            'Nombre Comercial': data.nombreComercial || '',
            'Grupo de Clientes': data.grupo || '',
            'Departamento': data.departamento || '',
            'Inscripci√≥n': data.inscripcion || '',
            'Nro Documento': data.nroDocumento || '',
            'Direcci√≥n': data.direccion || '',
            'Nombre (Ciudad)': data.ciudad || '',
            'Provincia': data.provincia || '',
            'Pa√≠s': data.pais || '',
            'Tel√©fono': data.telefono || '',
            'Email': data.email || '',
            'Saldo Cr√©dito': data.saldoCredito || 0
          });
        });

        if (clientes.length === 0) {
          alert('‚ö†Ô∏è No hay clientes para exportar');
          return;
        }

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(clientes);
        XLSX.utils.book_append_sheet(wb, ws, 'Clientes');

        const fecha = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `Listado_de_Clientes_${fecha}.xlsx`);

        console.log(`‚úÖ Exportados ${clientes.length} clientes a Excel`);
        alert(`‚úÖ Exportados ${clientes.length} clientes correctamente`);

      } catch (error) {
        console.error('‚ùå Error exportando clientes:', error);
        alert('‚ùå Error exportando clientes: ' + error.message);
      }
    }

    // Update client seller assignment
    async function updateClientSeller(clienteId, sellerId) {
      if (!firebase || !firebase.firestore) {
        alert('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clienteId);
        await updateDoc(clienteRef, {
          vendedorId: sellerId
        });

        console.log(`‚úÖ Vendedor actualizado para cliente ${clienteId}: ${sellerId}`);

        // Actualizar en la copia local
        if (window.allClients) {
          const cliente = window.allClients.find(c => c.id === clienteId);
          if (cliente) {
            cliente.vendedorId = sellerId;
          }
        }

        if (window.clients) {
          const cliente = window.clients.find(c => c.id === clienteId);
          if (cliente) {
            cliente.vendedorId = sellerId;
          }
        }

      } catch (error) {
        console.error('‚ùå Error actualizando vendedor:', error);
        alert('‚ùå Error actualizando vendedor: ' + error.message);
      }
    }

    // Assign default seller (Santiago) to all clients without a seller
    async function assignDefaultSellerToAllClients() {
      if (!firebase || !firebase.firestore) {
        console.error('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        // Find Santiago in the sellers list
        const santiago = window.sellers?.find(s => s.name.toLowerCase().includes('santiago') || s.name.toLowerCase().includes('santi'));

        if (!santiago) {
          console.warn('‚ö†Ô∏è No se encontr√≥ el vendedor Santiago/Santi');
          return;
        }

        console.log(`üîÑ Asignando vendedor por defecto (${santiago.name}) a clientes sin vendedor...`);

        const { collection, getDocs, doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        // Get all clients
        const clientesCollection = collection(db, 'clientes');
        const querySnapshot = await getDocs(clientesCollection);

        let updatedCount = 0;
        const updatePromises = [];

        querySnapshot.forEach((docSnapshot) => {
          const data = docSnapshot.data();
          // Si no tiene vendedor asignado, asignar Santiago
          if (!data.vendedorId && !data.vendedor) {
            const clientRef = doc(db, 'clientes', docSnapshot.id);
            updatePromises.push(updateDoc(clientRef, { vendedorId: santiago.id }));
            updatedCount++;
          }
        });

        if (updatedCount > 0) {
          await Promise.all(updatePromises);
          console.log(`‚úÖ ${updatedCount} clientes actualizados con vendedor por defecto: ${santiago.name}`);

          // Reload clients to show the changes
          loadClients();
        } else {
          console.log('‚ÑπÔ∏è Todos los clientes ya tienen vendedor asignado');
        }

      } catch (error) {
        console.error('‚ùå Error asignando vendedor por defecto:', error);
      }
    }

    // Assign Santiago to ALL clients (regardless if they have a seller or not)
    async function assignSantiagoToAllClients() {
      if (!firebase || !firebase.firestore) {
        console.error('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        // Find Santiago/Santi in the sellers list
        const santiago = window.sellers?.find(s =>
          s.name.toLowerCase().includes('santiago') ||
          s.name.toLowerCase().includes('santi')
        );

        if (!santiago) {
          console.warn('‚ö†Ô∏è No se encontr√≥ el vendedor Santiago/Santi');
          alert('‚ö†Ô∏è No se encontr√≥ el vendedor Santiago en la lista de vendedores');
          return;
        }

        const confirmMsg = `¬øEst√°s seguro de que quieres asignar a ${santiago.name} como vendedor para TODOS los clientes?`;
        if (!confirm(confirmMsg)) {
          return;
        }

        console.log(`üîÑ Asignando ${santiago.name} a TODOS los clientes...`);

        const { collection, getDocs, doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        // Get all clients
        const clientesCollection = collection(db, 'clientes');
        const querySnapshot = await getDocs(clientesCollection);

        let updatedCount = 0;
        const updatePromises = [];

        querySnapshot.forEach((docSnapshot) => {
          const clientRef = doc(db, 'clientes', docSnapshot.id);
          updatePromises.push(updateDoc(clientRef, { vendedorId: santiago.id }));
          updatedCount++;
        });

        if (updatedCount > 0) {
          await Promise.all(updatePromises);
          console.log(`‚úÖ ${updatedCount} clientes actualizados con vendedor: ${santiago.name}`);
          alert(`‚úÖ ${updatedCount} clientes asignados a ${santiago.name}`);

          // Reload clients to show the changes
          loadClients();
        }

      } catch (error) {
        console.error('‚ùå Error asignando vendedor a todos los clientes:', error);
        alert('‚ùå Error: ' + error.message);
      }
    }

    window.assignSantiagoToAllClients = assignSantiagoToAllClients;

    // Delete cliente
    async function deleteCliente(clienteId) {
      if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar este cliente?')) {
        return;
      }

      if (!firebase || !firebase.firestore) {
        alert('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        const { doc, deleteDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clienteId);
        await deleteDoc(clienteRef);

        console.log(`‚úÖ Cliente ${clienteId} eliminado`);
        alert('‚úÖ Cliente eliminado correctamente');

        loadClients();

      } catch (error) {
        console.error('‚ùå Error eliminando cliente:', error);
        alert('‚ùå Error eliminando cliente: ' + error.message);
      }
    }

    // Expose functions globally
    window.loadSellers = loadSellers;
    window.loadClients = loadClients;
    window.displayClients = displayClients;
    window.searchClients = searchClients;
    window.updateClientSeller = updateClientSeller;
    window.assignDefaultSellerToAllClients = assignDefaultSellerToAllClients;
    window.importClientes = importClientes;
    window.handleExcelImport = handleExcelImport;
    window.exportClientes = exportClientes;
    window.deleteCliente = deleteCliente;

  </script>

  <script>
    // Limpiar consola al cargar la p√°gina
    console.clear();
    console.log('üöÄ Administration cargado - Consola limpiada');

    // === GLOBAL MANAGEMENT VARIABLES ===
    window.sellers = [];
    window.clients = [];
    window.orders = [];
    window.currentEditingSellerId = null;
    window.currentEditingClientId = null;
    window.sellerToDelete = null;
    window.clientToDelete = null;

    // === MODAL FUNCTIONS (Available immediately) ===
    window.openSellerModal = function() {
      document.getElementById('sellerModal').classList.remove('hidden');
    };

    window.closeSellerModal = function() {
      document.getElementById('sellerModal').classList.add('hidden');
      document.getElementById('sellerForm').reset();
      window.currentEditingSellerId = null;
      document.getElementById('sellerModalTitle').textContent = 'Agregar Vendedor';
    };

    window.openConfirmModal = function() {
      document.getElementById('confirmModal').classList.remove('hidden');
    };

    window.closeConfirmModal = function() {
      document.getElementById('confirmModal').classList.add('hidden');
      window.sellerToDelete = null;
    };

    // === SELLER ACTION FUNCTIONS ===
    window.editSeller = function(sellerId) {
      const seller = window.sellers.find(s => s.id === sellerId);
      if (!seller) return;

      window.currentEditingSellerId = sellerId;

      document.getElementById('sellerModalTitle').textContent = 'Editar Vendedor';
      document.getElementById('sellerName').value = seller.name || '';
      document.getElementById('sellerEmail').value = seller.email || '';
      document.getElementById('sellerPhone').value = seller.phone || '';
      document.getElementById('sellerTerritory').value = seller.territory || '';
      document.getElementById('sellerCommission').value = seller.commission || '';
      document.getElementById('sellerStatus').value = seller.status || 'active';
      document.getElementById('sellerNotes').value = seller.notes || '';

      window.openSellerModal();
    };

    window.confirmDeleteSeller = function(sellerId, sellerName) {
      window.sellerToDelete = sellerId;
      window.clientToDelete = null;
      document.getElementById('confirmMessage').textContent =
        `¬øEst√°s seguro de que deseas eliminar al vendedor "${sellerName}"?`;
      window.openConfirmModal();
    };

    // === CLIENT MODAL FUNCTIONS ===
    window.openClientModal = function() {
      document.getElementById('clientModal').classList.remove('hidden');
      populateVendorDropdown();
    };

    window.closeClientModal = function() {
      document.getElementById('clientModal').classList.add('hidden');
      document.getElementById('clientForm').reset();
      window.currentEditingClientId = null;
      document.getElementById('clientModalTitle').textContent = 'Agregar Cliente';
    };

    // === CLIENT ACTION FUNCTIONS ===
    window.editClient = async function(clientId) {
      if (!firebase || !firebase.firestore) {
        alert('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        const { doc, getDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clientId);
        const clienteDoc = await getDoc(clienteRef);

        if (!clienteDoc.exists()) {
          alert('‚ùå Cliente no encontrado');
          return;
        }

        const cliente = clienteDoc.data();

        window.currentEditingClientId = clientId;
        document.getElementById('clientModalTitle').textContent = '‚úèÔ∏è Editar Cliente';

        document.getElementById('clientCodigo').value = cliente.codigo || '';
        document.getElementById('clientCodigo').disabled = true;
        document.getElementById('clientNombre').value = cliente.nombre || '';
        document.getElementById('clientNombreComercial').value = cliente.nombreComercial || '';
        document.getElementById('clientGrupo').value = cliente.grupo || '';
        document.getElementById('clientDepartamento').value = cliente.departamento || '';
        document.getElementById('clientInscripcion').value = cliente.inscripcion || '';
        document.getElementById('clientNroDocumento').value = cliente.nroDocumento || '';
        document.getElementById('clientDireccion').value = cliente.direccion || '';
        document.getElementById('clientCiudad').value = cliente.ciudad || '';
        document.getElementById('clientProvincia').value = cliente.provincia || '';
        document.getElementById('clientPais').value = cliente.pais || '';
        document.getElementById('clientTelefono').value = cliente.telefono || '';
        document.getElementById('clientEmail').value = cliente.email || '';
        document.getElementById('clientSaldoCredito').value = cliente.saldoCredito || 0;

        window.openClientModal();

      } catch (error) {
        console.error('‚ùå Error cargando cliente:', error);
        alert('‚ùå Error cargando cliente: ' + error.message);
      }
    };

    window.confirmDeleteClient = function(clientId, clientName) {
      window.clientToDelete = clientId;
      window.sellerToDelete = null;
      document.getElementById('confirmMessage').textContent =
        `¬øEst√°s seguro de que deseas eliminar al cliente "${clientName}"?`;
      window.openConfirmModal();
    };

    function populateVendorDropdown() {
      const vendorSelect = document.getElementById('clientVendor');
      if (!vendorSelect) return;

      // Clear existing options except the first one
      vendorSelect.innerHTML = '<option value="">Seleccionar vendedor...</option>';

      // Add vendors from sellers list
      if (window.sellers && window.sellers.length > 0) {
        window.sellers
          .filter(seller => seller.status === 'active')
          .forEach(seller => {
            const option = document.createElement('option');
            option.value = seller.id;
            option.textContent = seller.name;
            vendorSelect.appendChild(option);
          });
      }
    }

    // Initialize Material Design Components
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize all buttons
      const buttons = document.querySelectorAll('.mdc-button');
      buttons.forEach(button => mdc.ripple.MDCRipple.attachTo(button));

      // Initialize tab bar
      const tabBar = document.querySelector('.mdc-tab-bar');
      if (tabBar) {
        const mdcTabBar = mdc.tabBar.MDCTabBar.attachTo(tabBar);

        // Handle tab activation
        mdcTabBar.listen('MDCTabBar:activated', (event) => {
          const tab = tabBar.querySelectorAll('.mdc-tab')[event.detail.index];
          const tabId = tab.getAttribute('data-tab');

          // Hide all tab contents
          const allTabContents = document.querySelectorAll('.tab-content');
          allTabContents.forEach(content => {
            content.style.display = 'none';
          });

          // Show selected tab content
          const selectedContent = document.getElementById(tabId + '-content');
          if (selectedContent) {
            selectedContent.style.display = 'block';
          }

          console.log('üìã Tab switched to:', tabId);

          // Load data when switching tabs
          if (tabId === 'precios') {
            console.log('üìã Switching to precios tab');
            setTimeout(() => {
              if (window.loadProducts) {
                console.log('üì¶ Calling loadProducts from tab switch');
                window.loadProducts();
              } else {
                console.warn('‚ö†Ô∏è loadProducts not available, retrying...');
                // Retry a few times in case loadProducts isn't ready yet
                let retries = 0;
                const retryLoad = () => {
                  retries++;
                  if (window.loadProducts && retries <= 5) {
                    console.log('üì¶ Retry successful, calling loadProducts');
                    window.loadProducts();
                  } else if (retries <= 5) {
                    setTimeout(retryLoad, 500);
                  } else {
                    console.error('‚ùå Failed to load products after multiple retries');
                  }
                };
                setTimeout(retryLoad, 500);
              }
            }, 100);
          } else if (tabId === 'vendedor') {
            setTimeout(() => {
              if (window.loadSellers) {
                window.loadSellers();
              }
            }, 100);
          } else if (tabId === 'clientes') {
            setTimeout(() => {
              // Load sellers first to populate dropdown, then load clients
              if (window.loadSellers && window.loadClients) {
                window.loadSellers().then(() => {
                  // Assign default seller to clients without one
                  if (window.assignDefaultSellerToAllClients) {
                    window.assignDefaultSellerToAllClients();
                  }
                  window.loadClients();
                });
              }
            }, 100);
          } else if (tabId === 'master') {
            setTimeout(() => {
              // Load sellers first to populate dropdown, then load orders
              if (window.loadSellers && window.loadOrders) {
                window.loadSellers().then(() => {
                  window.loadOrders();
                });
              }
            }, 100);
          }
        });
      }

      // === PRODUCT PRICING EVENT LISTENERS ===

      // Load Products button
      const loadProductsBtn = document.getElementById('loadProductsBtn');
      if (loadProductsBtn) {
        loadProductsBtn.addEventListener('click', function() {
          if (window.loadProducts) {
            window.loadProducts();
          }
        });
      }

      // Save All Prices button
      const saveAllPricesBtn = document.getElementById('saveAllPricesBtn');
      if (saveAllPricesBtn) {
        saveAllPricesBtn.addEventListener('click', function() {
          if (window.saveAllPrices) {
            window.saveAllPrices();
          }
        });
      }

      // Import Prices button
      const importPricesBtn = document.getElementById('importPricesBtn');
      if (importPricesBtn) {
        importPricesBtn.addEventListener('click', function() {
          if (window.importPrices) {
            window.importPrices();
          }
        });
      }

      // File input for prices import
      const pricesFileInput = document.getElementById('pricesFileInput');
      if (pricesFileInput) {
        pricesFileInput.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (file && window.processPriceFile) {
            window.processPriceFile(file);
          }
          // Clear the input so the same file can be selected again
          event.target.value = '';
        });
      }

      // Export CSV button
      const exportCsvBtn = document.getElementById('exportCsvBtn');
      if (exportCsvBtn) {
        exportCsvBtn.addEventListener('click', function() {
          if (window.exportPricesToCSV) {
            window.exportPricesToCSV();
          }
        });
      }

      // Export Excel button
      const exportExcelBtn = document.getElementById('exportExcelBtn');
      if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', function() {
          if (window.exportPricesToExcel) {
            window.exportPricesToExcel();
          }
        });
      }

      // === ORDER MANAGEMENT EVENT LISTENERS ===

      // Refresh Orders button
      const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
      if (refreshOrdersBtn) {
        refreshOrdersBtn.addEventListener('click', async function() {
          console.log('üîÑ Refrescando √≥rdenes manualmente...');

          // Clear current orders
          window.orders = [];

          // Reload orders from Firebase
          if (window.loadOrders) {
            await window.loadOrders();
          }

          console.log('‚úÖ √ìrdenes actualizadas');
        });
      }

      // Delete All Orders button
      const deleteAllOrdersBtn = document.getElementById('deleteAllOrdersBtn');
      if (deleteAllOrdersBtn) {
        deleteAllOrdersBtn.addEventListener('click', function() {
          if (window.deleteAllOrders) {
            window.deleteAllOrders();
          }
        });
      }

      // === SELLER MANAGEMENT EVENT LISTENERS ===

      // Add Seller button
      const addSellerBtn = document.getElementById('addSellerBtn');
      if (addSellerBtn) {
        addSellerBtn.addEventListener('click', function() {
          window.currentEditingSellerId = null;
          document.getElementById('sellerModalTitle').textContent = 'Agregar Vendedor';
          document.getElementById('sellerForm').reset();
          window.openSellerModal();
        });
      }

      // === CLIENT MANAGEMENT EVENT LISTENERS ===

      // Add Client button
      const addClientBtn = document.getElementById('addClientBtn');
      if (addClientBtn) {
        addClientBtn.addEventListener('click', function() {
          window.currentEditingClientId = null;
          document.getElementById('clientModalTitle').textContent = '‚ûï Agregar Cliente';
          document.getElementById('clientForm').reset();
          document.getElementById('clientCodigo').disabled = false;
          window.openClientModal();
        });
      }

      // Client search input
      const clientSearchInput = document.getElementById('clientSearchInput');
      if (clientSearchInput) {
        // B√∫squeda en tiempo real con debounce
        let searchTimeout;
        clientSearchInput.addEventListener('input', function(e) {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            searchClients(e.target.value);
          }, 300); // Esperar 300ms despu√©s de que el usuario deje de escribir
        });

        // Tambi√©n buscar al presionar Enter
        clientSearchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            searchClients(e.target.value);
          }
        });
      }

      // Import/Export clients buttons
      const importClientesBtn = document.getElementById('importClientesBtn');
      if (importClientesBtn) {
        importClientesBtn.addEventListener('click', function() {
          if (window.importClientes) {
            window.importClientes();
          }
        });
      }

      const exportClientesBtn = document.getElementById('exportClientesBtn');
      if (exportClientesBtn) {
        exportClientesBtn.addEventListener('click', function() {
          if (window.exportClientes) {
            window.exportClientes();
          }
        });
      }

      const excelFileInput = document.getElementById('excelFileInput');
      if (excelFileInput) {
        excelFileInput.addEventListener('change', function(e) {
          if (window.handleExcelImport) {
            window.handleExcelImport(e);
          }
        });
      }

      // Close client modal buttons
      const closeClientModal = document.getElementById('closeClientModal');
      const cancelClientBtn = document.getElementById('cancelClientBtn');
      if (closeClientModal) {
        closeClientModal.addEventListener('click', window.closeClientModal);
      }
      if (cancelClientBtn) {
        cancelClientBtn.addEventListener('click', window.closeClientModal);
      }

      // Close seller modal buttons
      const closeSellerModal = document.getElementById('closeSellerModal');
      const cancelSellerBtn = document.getElementById('cancelSellerBtn');
      if (closeSellerModal) {
        closeSellerModal.addEventListener('click', window.closeSellerModal);
      }
      if (cancelSellerBtn) {
        cancelSellerBtn.addEventListener('click', window.closeSellerModal);
      }

      // Close confirm modal buttons
      const closeConfirmModal = document.getElementById('closeConfirmModal');
      const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
      if (closeConfirmModal) {
        closeConfirmModal.addEventListener('click', window.closeConfirmModal);
      }
      if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', window.closeConfirmModal);
      }

      // Confirm delete button
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', async function() {
          const { doc, deleteDoc } = window.firebase.firestoreHelpers;
          const db = window.firebase.firestore();

          try {
            if (window.sellerToDelete) {
              // Delete seller
              const sellerRef = doc(db, 'vendedores', window.sellerToDelete);
              await deleteDoc(sellerRef);
              console.log('‚úÖ Vendedor eliminado:', window.sellerToDelete);
              window.closeConfirmModal();
              if (window.loadSellers) window.loadSellers();
            } else if (window.clientToDelete) {
              // Delete client
              const clientRef = doc(db, 'clientes', window.clientToDelete);
              await deleteDoc(clientRef);
              console.log('‚úÖ Cliente eliminado:', window.clientToDelete);
              window.closeConfirmModal();
              if (window.loadClients) window.loadClients();
            }
          } catch (error) {
            console.error('‚ùå Error eliminando registro:', error);
            alert('Error eliminando registro. Int√©ntalo de nuevo.');
          }
        });
      }

      // Seller form submission
      const sellerForm = document.getElementById('sellerForm');
      if (sellerForm) {
        sellerForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          // Wait for Firebase to be ready if needed
          let retries = 0;
          while ((!window.firebase || !window.firebase.firestoreHelpers) && retries < 10) {
            console.log('‚è≥ Waiting for Firebase to be ready...');
            await new Promise(resolve => setTimeout(resolve, 500));
            retries++;
          }

          const formData = new FormData(sellerForm);
          const sellerData = {
            name: formData.get('name'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            territory: formData.get('territory'),
            commission: formData.get('commission') ? parseFloat(formData.get('commission')) : null,
            status: formData.get('status'),
            notes: formData.get('notes')
          };

          // Validate required fields
          if (!sellerData.name) {
            alert('Por favor completa el campo obligatorio: Nombre');
            return;
          }

          try {
            if (!window.firebase || !window.firebase.firestoreHelpers) {
              throw new Error('Firebase not available');
            }

            console.log('üî• Firebase helpers available:', Object.keys(window.firebase.firestoreHelpers));

            const { collection, addDoc, updateDoc, doc } = window.firebase.firestoreHelpers;

            if (!addDoc) {
              throw new Error('addDoc function not available');
            }
            if (!updateDoc) {
              throw new Error('updateDoc function not available');
            }
            const db = window.firebase.firestore();

            if (window.currentEditingSellerId) {
              // Update existing seller
              const sellerRef = doc(db, 'vendedores', window.currentEditingSellerId);
              await updateDoc(sellerRef, {
                ...sellerData,
                updatedAt: new Date()
              });
              console.log('‚úÖ Vendedor actualizado:', window.currentEditingSellerId);
            } else {
              // Add new seller
              const sellersCollection = collection(db, 'vendedores');
              const docRef = await addDoc(sellersCollection, {
                ...sellerData,
                createdAt: new Date(),
                updatedAt: new Date()
              });
              console.log('‚úÖ Vendedor agregado:', docRef.id);
            }

            window.closeSellerModal();
            if (window.loadSellers) window.loadSellers();

          } catch (error) {
            console.error('‚ùå Error guardando vendedor:', error);
            alert('Error guardando vendedor. Int√©ntalo de nuevo.');
          }
        });
      }

      // Client form submission
      const clientForm = document.getElementById('clientForm');
      if (clientForm) {
        clientForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          if (!firebase || !firebase.firestore) {
            alert('‚ùå Firebase no est√° disponible');
            return;
          }

          try {
            const saldoCreditoValue = document.getElementById('clientSaldoCredito').value.trim();

            const clienteData = {
              codigo: document.getElementById('clientCodigo').value.trim(),
              nombre: document.getElementById('clientNombre').value.trim(),
              nombreComercial: document.getElementById('clientNombreComercial').value.trim(),
              grupo: document.getElementById('clientGrupo').value.trim(),
              departamento: document.getElementById('clientDepartamento').value.trim(),
              inscripcion: document.getElementById('clientInscripcion').value.trim(),
              nroDocumento: document.getElementById('clientNroDocumento').value.trim(),
              direccion: document.getElementById('clientDireccion').value.trim(),
              ciudad: document.getElementById('clientCiudad').value.trim(),
              provincia: document.getElementById('clientProvincia').value.trim(),
              pais: document.getElementById('clientPais').value.trim(),
              telefono: document.getElementById('clientTelefono').value.trim(),
              email: document.getElementById('clientEmail').value.trim(),
              saldoCredito: saldoCreditoValue ? parseFloat(saldoCreditoValue) : 0
            };

            if (!clienteData.codigo) {
              alert('‚ö†Ô∏è El c√≥digo es requerido');
              return;
            }

            if (!clienteData.nombre) {
              alert('‚ö†Ô∏è El nombre es requerido');
              return;
            }

            const { doc, setDoc } = firebase.firestoreHelpers;
            const db = firebase.firestore();

            const clienteRef = doc(db, 'clientes', clienteData.codigo);
            await setDoc(clienteRef, clienteData);

            console.log(`‚úÖ Cliente ${clienteData.codigo} guardado`);
            alert(window.currentEditingClientId ? '‚úÖ Cliente actualizado correctamente' : '‚úÖ Cliente agregado correctamente');

            window.closeClientModal();
            loadClients();

          } catch (error) {
            console.error('‚ùå Error guardando cliente:', error);
            alert('‚ùå Error guardando cliente: ' + error.message);
          }
        });
      }

      // Close modals when clicking outside
      window.addEventListener('click', function(event) {
        const sellerModal = document.getElementById('sellerModal');
        const clientModal = document.getElementById('clientModal');
        const confirmModal = document.getElementById('confirmModal');

        if (event.target === sellerModal) {
          window.closeSellerModal();
        }
        if (event.target === clientModal) {
          window.closeClientModal();
        }
        if (event.target === confirmModal) {
          window.closeConfirmModal();
        }
      });

      console.log('‚úÖ Administration page initialized');

      // Auto-load precios if it's the active tab
      setTimeout(() => {
        const activeTab = document.querySelector('.mdc-tab--active');
        if (activeTab && activeTab.getAttribute('data-tab') === 'precios') {
          console.log('üéØ Precios tab is active by default, auto-loading products');
          if (window.loadProducts) {
            window.loadProducts();
          } else {
            console.log('‚ö†Ô∏è loadProducts not ready, will retry...');
            // Retry with increasing delays
            let attempts = 0;
            const tryLoad = () => {
              attempts++;
              if (window.loadProducts) {
                console.log('‚úÖ loadProducts ready, loading now');
                window.loadProducts();
              } else if (attempts < 10) {
                setTimeout(tryLoad, attempts * 500);
              } else {
                console.error('‚ùå Failed to auto-load products after 10 attempts');
              }
            };
            setTimeout(tryLoad, 500);
          }
        }
      }, 2000); // Give everything time to initialize
    });
  </script>
</body>
</html>