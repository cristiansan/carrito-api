<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Administration - South Traders</title>

  <!-- Material Design CSS -->
  <link href="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif;
      color-scheme: dark;
      --mdc-theme-primary: #4CAF50;
      --mdc-theme-secondary: #2a2a33;
      --mdc-theme-surface: #1e1e24;
      --mdc-theme-background: #0f0f10;
      --mdc-theme-on-primary: #ffffff;
      --mdc-theme-on-secondary: #ffffff;
      --mdc-theme-on-surface: #f1f1f1;
      --mdc-theme-on-background: #f1f1f1;
    }

    /* Material Design custom overrides */
    .mdc-tab {
      color: #d0d0d0 !important;
      background-color: #1b1b1f !important;
      border-radius: 6px 6px 0 0 !important;
      border: 1px solid #2a2a2a !important;
      border-bottom: none !important;
      margin-right: 4px !important;
    }

    .mdc-tab--active {
      color: #ffffff !important;
      background-color: #23232a !important;
      font-weight: 600 !important;
    }

    .mdc-tab:hover:not(.mdc-tab--active) {
      color: #e8e8e8 !important;
      background-color: #2a2a2f !important;
    }

    .mdc-tab-indicator__content--underline {
      border-color: #4CAF50 !important;
      border-width: 3px !important;
    }

    /* Fix for all text elements */
    .mdc-tab__text-label,
    .mdc-button__label,
    .mdc-floating-label,
    .mdc-text-field__input,
    .mdc-form-field > label,
    span, p, div, h1, h2, h3, h4, h5, h6 {
      color: inherit !important;
    }

    /* Button improvements */
    .mdc-button {
      color: #f1f1f1 !important;
    }

    .mdc-button--raised {
      background-color: #4CAF50 !important;
      color: #ffffff !important;
    }

    .mdc-button--outlined {
      border-color: #3a3a44 !important;
      color: #f1f1f1 !important;
    }

    .mdc-button--outlined:hover {
      background-color: #2a2a33 !important;
      border-color: #4CAF50 !important;
    }

    body {
      margin: 0;
      padding: 0;
      background: #0f0f10;
      color: #f1f1f1;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    header {
      padding: 16px;
      border-bottom: 1px solid #2a2a2a;
      background: #121214;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-logo {
      height: auto;
      max-width: 150px;
      width: 100%;
      object-fit: contain;
    }

    h1 {
      margin: 0;
      font-size: 20px;
      color: #fafafa;
    }

    .back-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #2a2a33;
      color: #f1f1f1;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #3a3a44;
      transition: background-color 0.2s;
      text-decoration: none;
    }

    .back-btn:hover {
      background: #3a3a44;
      color: #f1f1f1;
    }

    .container {
      padding: 16px;
      width: 100%;
      box-sizing: border-box;
    }

    .tab-content {
      background: #1e1e24;
      border-radius: 8px;
      padding: 24px;
      margin-top: 16px;
      border: 1px solid #2a2a2a;
    }

    .tab-content h2 {
      color: #4CAF50;
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .content-placeholder {
      color: #b5b5b5;
      font-style: italic;
      text-align: center;
      padding: 60px 20px;
      font-size: 16px;
    }

    .admin-section {
      background: #15151a;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #2a2a2a;
    }

    .admin-section h3 {
      color: #4CAF50;
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 18px;
    }

    .sellers-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .sellers-header h3 {
      margin: 0;
    }

    .add-seller-btn {
      background-color: #4CAF50 !important;
    }

    .seller-card {
      background: #2a2a33;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #3a3a44;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
    }

    .seller-card:hover {
      background: #2f2f3a;
      border-color: #4CAF50;
    }

    .seller-info {
      flex: 1;
    }

    .seller-name {
      font-size: 16px;
      font-weight: 600;
      color: #f1f1f1;
      margin-bottom: 4px;
    }

    .seller-details {
      font-size: 13px;
      color: #b5b5b5;
    }

    .seller-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 12px;
      font-weight: 500;
    }

    .status-active {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }

    .status-inactive {
      background: rgba(158, 158, 158, 0.2);
      color: #9e9e9e;
    }

    .seller-actions {
      display: flex;
      gap: 8px;
      margin-left: 12px;
    }

    .delete-seller-btn {
      background: #f44336 !important;
      color: white !important;
      min-width: auto !important;
      padding: 8px !important;
    }

    .edit-seller-btn {
      background: #FF9800 !important;
      color: white !important;
      min-width: auto !important;
      padding: 8px !important;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .stat-item {
      text-align: center;
      background: #2a2a33;
      padding: 16px;
      border-radius: 6px;
      border: 1px solid #3a3a44;
    }

    .stat-number {
      display: block;
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: #b5b5b5;
      text-transform: uppercase;
    }

    .loading-sellers {
      text-align: center;
      color: #b5b5b5;
      padding: 40px;
      font-style: italic;
    }

    .no-sellers {
      text-align: center;
      color: #b5b5b5;
      padding: 40px;
      font-style: italic;
    }

    /* Modal styles for add/edit seller */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal:not(.hidden) {
      display: flex;
    }

    .modal-content {
      background-color: #1e1e24;
      margin: auto;
      padding: 20px;
      border: 1px solid #2a2a2a;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      position: relative;
      color: #f1f1f1;
    }

    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 20px;
      cursor: pointer;
    }

    .close-button:hover {
      color: #f1f1f1;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #f1f1f1;
      font-weight: 500;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      background: #2a2a33;
      color: #f1f1f1;
      box-sizing: border-box;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: #4CAF50;
      outline: none;
    }

    /* Fix para visibilidad de texto en selects - previene texto blanco/invisible */
    select, select option {
      -webkit-text-fill-color: currentColor !important;
      color: inherit !important;
    }

    /* Estilos finales para dropdowns de admisiones */
    #admisiones-content select {
      -webkit-text-fill-color: #000 !important;
      color: #000 !important;
      opacity: 1 !important;
      background: #f0f0f0 !important;
      font-weight: 600 !important;
      font-size: 16px !important;
    }

    #admisiones-content select option {
      -webkit-text-fill-color: #000 !important;
      color: #000 !important;
      opacity: 1 !important;
      background: #f0f0f0 !important;
    }

    /* Client-specific styles */
    .clients-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .clients-header h3 {
      margin: 0;
    }

    .add-client-btn {
      background-color: #2196F3 !important;
    }

    .client-card {
      background: #2a2a33;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #3a3a44;
      transition: all 0.2s ease;
    }

    .client-card:hover {
      background: #2f2f3a;
      border-color: #2196F3;
    }

    .client-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .client-main-info {
      flex: 1;
    }

    .client-number {
      font-size: 12px;
      color: #2196F3;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .client-name {
      font-size: 16px;
      font-weight: 600;
      color: #f1f1f1;
      margin-bottom: 4px;
    }

    .client-price-list {
      font-size: 13px;
      color: #FF9800;
      margin-bottom: 8px;
    }

    .client-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .client-detail-item {
      font-size: 13px;
      color: #b5b5b5;
      display: flex;
      justify-content: space-between;
    }

    .client-detail-label {
      font-weight: 500;
    }

    .client-detail-value {
      color: #f1f1f1;
    }

    .client-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .client-link {
      color: #2196F3;
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
    }

    .client-link:hover {
      text-decoration: underline;
    }

    .loading-clients, .no-clients {
      text-align: center;
      color: #b5b5b5;
      padding: 40px;
      font-style: italic;
    }

    /* Clientes header with buttons */
    .clientes-header {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    /* Clientes table container with scrollbar */
    .clientes-table-container {
      max-height: 60vh;
      overflow: auto;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
    }

    .clientes-table-container::-webkit-scrollbar {
      width: 14px;
      height: 14px;
    }

    .clientes-table-container::-webkit-scrollbar-track {
      background: #1e1e24;
      border-radius: 6px;
    }

    .clientes-table-container::-webkit-scrollbar-thumb {
      background: #4CAF50;
      border-radius: 6px;
      border: 2px solid #1e1e24;
    }

    .clientes-table-container::-webkit-scrollbar-thumb:hover {
      background: #45a049;
    }

    .clientes-table-container {
      scrollbar-width: auto;
      scrollbar-color: #4CAF50 #1e1e24;
    }

    /* Clientes table styles */
    .clientes-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .clientes-table th {
      position: sticky;
      top: 0;
      background: #2a2a33;
      color: #f1f1f1;
      padding: 10px 8px;
      text-align: left;
      border-bottom: 2px solid #4CAF50;
      font-weight: 600;
      white-space: nowrap;
      z-index: 10;
    }

    .clientes-table td {
      padding: 8px;
      border-bottom: 1px solid #2a2a2a;
      color: #f1f1f1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    .clientes-table tr:hover {
      background: #2f2f3a;
    }

    /* Usuario asignado - color diferenciado */
    .clientes-table tr.usuario-asignado-row {
      background: rgba(76, 175, 80, 0.12);
      border-left: 3px solid #4CAF50;
    }

    .clientes-table tr.usuario-asignado-row:hover {
      background: rgba(76, 175, 80, 0.18);
    }

    /* Sortable columns */
    .clientes-table th.sortable {
      cursor: pointer;
      user-select: none;
    }

    .clientes-table th.sortable:hover {
      background-color: #353545;
    }

    .clientes-table th.sortable .sort-indicator {
      margin-left: 4px;
      font-size: 0.9em;
      color: #888;
    }

    .clientes-table th.sortable.sorted .sort-indicator {
      color: #4CAF50;
    }

    .edit-client-btn, .delete-client-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .edit-client-btn:hover {
      background: #2a2a33;
    }

    .delete-client-btn:hover {
      background: #d32f2f;
    }

    /* Column toggle buttons */
    .column-toggle-btn {
      background: none;
      border: none;
      color: #4CAF50;
      cursor: pointer;
      font-size: 14px;
      padding: 0 4px;
      margin-left: 4px;
      font-weight: bold;
      transition: all 0.2s ease;
      vertical-align: middle;
    }

    .column-toggle-btn:hover {
      color: #45a049;
      transform: scale(1.2);
    }

    /* Botones de control global de columnas (v0.35)
     * collapse-all-btn: Bot√≥n "‚àí" minimiza todas las columnas de una vez
     * expand-all-btn: Bot√≥n "+" maximiza todas las columnas de una vez
     * Ubicados en columna "Acciones" junto a botones de edici√≥n/eliminaci√≥n
     */
    .collapse-all-btn,
    .expand-all-btn {
      background: none;
      border: 1px solid #4CAF50;
      color: #4CAF50;
      cursor: pointer;
      font-size: 12px;
      padding: 2px 6px;
      margin-left: 6px;
      font-weight: bold;
      border-radius: 3px;
      transition: all 0.2s ease;
      vertical-align: middle;
    }

    /* Hover effect: Fondo verde con texto oscuro y leve agrandamiento */
    .collapse-all-btn:hover,
    .expand-all-btn:hover {
      background: #4CAF50;
      color: #1e1e1e;
      transform: scale(1.05);
    }

    .clientes-table th.column-collapsed {
      max-width: 30px;
      width: 30px;
      min-width: 30px;
      padding: 4px 2px;
      text-align: center;
    }

    .clientes-table td.column-collapsed {
      max-width: 30px;
      width: 30px;
      min-width: 30px;
      padding: 4px 2px;
      text-align: center;
      font-size: 11px;
      overflow: hidden;
      text-overflow: clip;
      white-space: nowrap;
    }

    .clientes-table td.column-collapsed::before {
      content: attr(data-first-letter);
      display: inline-block;
    }

    .clientes-table td.column-collapsed > * {
      display: none;
    }

    .column-label {
      display: inline;
    }

    .column-collapsed .column-label {
      display: none;
    }

    /* Form specific styles for clients */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-row-triple {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 768px) {
      .form-row, .form-row-triple {
        grid-template-columns: 1fr;
      }

      .client-details-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Prevent any black text */
    * {
      color: inherit;
    }

    .mdc-tab *,
    .mdc-button *,
    .mdc-text-field *,
    .mdc-form-field * {
      color: inherit !important;
    }

    /* Product pricing table styles */
    .prices-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .prices-header h3 {
      margin: 0;
    }

    .prices-actions-buttons {
      display: flex;
      gap: 12px;
    }

    .products-table {
      width: 100%;
      border-collapse: collapse;
      background: #2a2a33;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .products-table thead {
      background: #1e1e24;
    }

    .products-table th {
      padding: 12px 16px;
      text-align: left;
      color: #4CAF50;
      font-weight: 600;
      border-bottom: 2px solid #3a3a44;
      font-size: 14px;
    }

    .products-table th.sortable {
      cursor: pointer;
      user-select: none;
    }

    .products-table th.sortable:hover {
      background-color: #2a2a33;
    }

    .products-table th.sorted {
      background-color: #3a3a44;
      color: #4a9eff;
    }

    .products-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #3a3a44;
      color: #f1f1f1;
    }

    .products-table tr:hover {
      background: #2f2f3a;
    }

    .products-table tbody tr:last-child td {
      border-bottom: none;
    }

    .product-code {
      font-family: monospace;
      color: #2196F3;
      font-weight: 600;
      font-size: 13px;
    }

    .product-description {
      color: #f1f1f1;
      font-size: 14px;
    }

    .price-input {
      width: 100px;
      padding: 6px 8px;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      background: #1e1e24;
      color: #f1f1f1;
      text-align: right;
      font-family: monospace;
      font-size: 13px;
    }

    .price-input:focus {
      border-color: #4CAF50;
      outline: none;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }

    .price-input:hover {
      border-color: #4a4a54;
    }

    .price-input.modified {
      border-color: #FF9800;
      background: rgba(255, 152, 0, 0.1);
    }

    .loading-products, .no-products {
      text-align: center;
      color: #b5b5b5;
      padding: 40px;
      font-style: italic;
    }

    /* Loading spinner animation */
    .loading-spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #3a3a44;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .price-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      align-items: center;
    }

    .price-stats {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #b5b5b5;
    }

    .price-stat {
      background: #2a2a33;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #3a3a44;
    }

    .price-stat-number {
      color: #4CAF50;
      font-weight: 600;
      margin-left: 4px;
    }

    /* Responsive table */
    @media (max-width: 1024px) {
      .products-table {
        font-size: 12px;
      }

      .products-table th,
      .products-table td {
        padding: 8px 10px;
      }

      .price-input {
        width: 80px;
        font-size: 12px;
      }
    }

    @media (max-width: 768px) {
      .prices-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .products-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      .price-actions {
        justify-content: center;
      }
    }

    /* Order management table styles */
    .orders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .orders-header h3 {
      margin: 0;
    }

    .orders-table {
      width: 100%;
      border-collapse: collapse;
      background: #2a2a33;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .orders-table thead {
      background: #1e1e24;
    }

    .orders-table th {
      padding: 10px 12px;
      text-align: left;
      color: #4CAF50;
      font-weight: 600;
      border-bottom: 2px solid #3a3a44;
      font-size: 12px;
      white-space: nowrap;
    }

    .orders-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #3a3a44;
      color: #f1f1f1;
      vertical-align: middle;
    }

    .orders-table tr:hover {
      background: #2f2f3a;
    }

    .orders-table tbody tr:last-child td {
      border-bottom: none;
    }

    .order-input {
      width: 100%;
      min-width: 80px;
      padding: 4px 6px;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      background: #1e1e24;
      color: #f1f1f1;
      font-size: 12px;
      font-family: inherit;
    }

    .order-input:focus {
      border-color: #4CAF50;
      outline: none;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }

    .order-input:hover {
      border-color: #4a4a54;
    }

    .order-input.modified {
      border-color: #FF9800;
      background: rgba(255, 152, 0, 0.1);
    }

    .order-date-input {
      width: 110px;
    }

    .order-number-input {
      width: 100px;
      text-align: center;
      font-family: monospace;
    }

    .order-client-input {
      width: 80px;
      text-align: center;
    }

    .order-name-input {
      min-width: 150px;
    }

    .order-amount-input {
      width: 100px;
      text-align: right;
      font-family: monospace;
    }

    .order-select {
      width: 100%;
      min-width: 120px;
      padding: 4px 6px;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      background: #1e1e24;
      color: #f1f1f1;
      font-size: 12px;
      font-family: inherit;
      cursor: pointer;
    }

    .order-select:focus {
      border-color: #4CAF50;
      outline: none;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }

    .order-select:hover {
      border-color: #4a4a54;
    }

    .order-select.modified {
      border-color: #FF9800;
      background: rgba(255, 152, 0, 0.1);
    }

    .status-badge {
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
      min-width: 80px;
      text-align: center;
    }

    .status-a-confirmar {
      background: rgba(158, 158, 158, 0.2);
      color: #9e9e9e;
    }

    .status-confirmado {
      background: rgba(33, 150, 243, 0.2);
      color: #2196F3;
    }

    .status-confirmado-modificaciones {
      background: rgba(255, 152, 0, 0.2);
      color: #FF9800;
    }

    .status-en-preparacion {
      background: rgba(156, 39, 176, 0.2);
      color: #9C27B0;
    }

    .status-en-camino {
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
    }

    .status-entregado {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }

    .loading-orders, .no-orders {
      text-align: center;
      color: #b5b5b5;
      padding: 40px;
      font-style: italic;
    }

    .order-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .order-stats {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #b5b5b5;
    }

    .order-stat {
      background: #2a2a33;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #3a3a44;
    }

    .order-stat-number {
      color: #4CAF50;
      font-weight: 600;
      margin-left: 4px;
    }

    /* Responsive orders table */
    @media (max-width: 1200px) {
      .orders-table {
        font-size: 11px;
      }

      .orders-table th,
      .orders-table td {
        padding: 8px 6px;
      }

      .order-input,
      .order-select {
        font-size: 11px;
        padding: 3px 4px;
      }

      .order-name-input {
        min-width: 120px;
      }
    }

    @media (max-width: 768px) {
      .orders-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .orders-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      .order-actions {
        justify-content: center;
      }
    }

    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }
      h1 {
        font-size: 18px;
      }
      .container {
        padding: 8px;
      }
      .header {
        padding: 12px;
      }
      .tab-content {
        padding: 16px;
      }
    }

    /* Logistics/Orders Section Styles */
    .logistics-content {
      max-height: 70vh;
      overflow-y: auto;
    }

    .logistics-section {
      margin-bottom: 24px;
      padding: 16px;
      background: #15151a;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
    }

    .logistics-section h4 {
      margin: 0 0 12px 0;
      color: #4CAF50;
      font-size: 16px;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 8px;
    }

    .logistics-orders {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .no-orders {
      color: #b5b5b5;
      font-style: italic;
      text-align: center;
      padding: 20px;
      margin: 0;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2a2a33;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #4CAF50;
    }

    .order-info {
      flex: 1;
    }

    .order-number {
      font-weight: 600;
      color: #4CAF50;
      margin-bottom: 4px;
    }

    .order-details {
      font-size: 12px;
      color: #b5b5b5;
    }

    .order-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .move-order-btn {
      background: #4CAF50;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .move-order-btn:hover {
      background: #45a049;
      transform: translateY(-2px);
    }

    .move-order-btn-up {
      background: #FF9800;
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
    }

    .move-order-btn-up:hover {
      background: #F57C00;
      transform: translateY(-2px);
    }

    .cancel-order-btn {
      background: #F44336;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .cancel-order-btn:hover {
      background: #d32f2f;
    }

    .edit-order-btn {
      background: #FF9800;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .edit-order-btn:hover {
      background: #F57C00;
    }

    .delivered-status {
      color: #4CAF50;
      font-size: 12px;
      font-weight: bold;
    }

    .closed-status {
      color: #9E9E9E;
      font-size: 12px;
      font-weight: bold;
    }

    .cancelled-status {
      color: #F44336;
      font-size: 12px;
      font-weight: bold;
    }

    /* Order Details Modal */
    .order-details-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      overflow-y: auto;
    }

    .order-details-modal-content {
      background-color: #1e1e24;
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 700px;
      border: 2px solid #4CAF50;
      position: relative;
    }

    .order-details-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 20px;
    }

    .order-details-close:hover,
    .order-details-close:focus {
      color: #f1f1f1;
    }

    .order-details-header {
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }

    .order-details-title {
      font-size: 24px;
      color: #4CAF50;
      font-weight: 600;
      margin: 0;
    }

    .order-details-section {
      margin-bottom: 20px;
    }

    .order-details-section h3 {
      color: #4CAF50;
      font-size: 16px;
      margin-bottom: 10px;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 5px;
    }

    .order-details-info {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .order-details-label {
      color: #b5b5b5;
      font-weight: 500;
    }

    .order-details-value {
      color: #f1f1f1;
    }

    .order-items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .order-items-table th {
      background: #2a2a33;
      color: #ffffff;
      padding: 10px;
      text-align: left;
      font-size: 14px;
    }

    .order-items-table td {
      padding: 10px;
      border-bottom: 1px solid #2a2a2a;
      color: #f1f1f1;
    }

    .order-items-table tr:last-child td {
      border-bottom: none;
    }

    .order-total {
      text-align: right;
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #4CAF50;
    }

    /* Editable quantity input in modal */
    .editable-quantity {
      width: 60px;
      padding: 4px 8px;
      border: 1px solid #444;
      background: #2a2a34;
      color: white;
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
    }

    .editable-quantity:focus {
      outline: none;
      border-color: #00BCD4;
    }

    /* Ocultar logo en dispositivos m√≥viles */
    @media (max-width: 768px) {
      .header-logo {
        display: none;
      }
    }

    /* Estilos para selects de Admisiones - asegurar texto visible */
    /* Sobrescribir herencia de color para selects espec√≠ficamente */
    select.mdc-text-field__input,
    select.mdc-text-field__input:focus,
    select.mdc-text-field__input:active,
    select.mdc-text-field__input:hover {
      color: #333 !important;
      background-color: #fff !important;
      -webkit-text-fill-color: #333 !important; /* Para Safari/Chrome */
    }

    select.mdc-text-field__input option {
      color: #333 !important;
      background-color: #fff !important;
      -webkit-text-fill-color: #333 !important;
    }

    select.mdc-text-field__input option[value=""] {
      color: #999 !important;
      -webkit-text-fill-color: #999 !important;
    }

    /* Asegurar que el texto seleccionado sea visible en todos los estados */
    #pendingUsersList select.mdc-text-field__input {
      color: #333 !important;
      background-color: #fff !important;
      -webkit-text-fill-color: #333 !important;
      -webkit-appearance: menulist;
      -moz-appearance: menulist;
      appearance: menulist;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" class="header-logo">
    <h1>Administration Panel</h1>
    <a href="marketplace.html" class="back-btn">‚Üê Back to Marketplace</a>
  </header>

  <div class="container">
    <div class="mdc-tab-bar" role="tablist" id="tabs">
      <div class="mdc-tab-scroller">
        <div class="mdc-tab-scroller__scroll-area">
          <div class="mdc-tab-scroller__scroll-content">
            <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true" tabindex="0" data-tab="precios">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Precios</span>
              </span>
              <span class="mdc-tab-indicator mdc-tab-indicator--active">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-tab="clientes">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Clientes</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-tab="vendedor">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Vendedor</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-tab="master">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Master</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
            <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" data-tab="admisiones">
              <span class="mdc-tab__content">
                <span class="mdc-tab__text-label">Admisiones</span>
              </span>
              <span class="mdc-tab-indicator">
                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
              </span>
              <span class="mdc-tab__ripple"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Contents -->
    <div id="precios-content" class="tab-content">
      <h2>üí∞ Gesti√≥n de Precios</h2>
      <div class="admin-section">
        <div class="prices-header">
          <h3>Lista de Productos y Precios</h3>
          <div class="prices-actions-buttons">
            <button class="mdc-button mdc-button--outlined" id="importPricesBtn">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">upload_file</i>
              <span class="mdc-button__label">Importar Precios</span>
            </button>
            <button class="mdc-button mdc-button--outlined" id="exportCsvBtn">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
              <span class="mdc-button__label">Exportar CSV</span>
            </button>
            <button class="mdc-button mdc-button--outlined" id="exportExcelBtn">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
              <span class="mdc-button__label">Exportar Excel</span>
            </button>
            <button class="mdc-button mdc-button--raised" id="saveAllPricesBtn" style="display: none;">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">save</i>
              <span class="mdc-button__label">Guardar Todos los Precios</span>
            </button>
            <button class="mdc-button mdc-button--outlined" id="loadProductsBtn">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">refresh</i>
              <span class="mdc-button__label">Actualizar Productos</span>
            </button>
          </div>
          <input type="file" id="pricesFileInput" accept=".csv,.xlsx,.xls" style="display: none;">
        </div>

        <div id="productsContainer">
          <div class="loading-products">
            <div class="loading-content">
              <div class="loading-spinner"></div>
              <p>Cargando productos...</p>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div id="clientes-content" class="tab-content" style="display: none;">
      <h2>üë• Gesti√≥n de Clientes</h2>

      <!-- Estad√≠sticas resumen -->
      <div class="admin-section">
        <h3>Resumen</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-number" id="totalClients">0</span>
            <span class="stat-label">Total Clientes</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="totalBalance">$0</span>
            <span class="stat-label">Saldo Cr√©dito Total</span>
          </div>
        </div>
      </div>

      <!-- Tabla de clientes -->
      <div class="admin-section">
        <div class="clientes-header">
          <button class="mdc-button mdc-button--outlined" id="importClientesBtn">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">upload</i>
            <span class="mdc-button__label">Importar Excel</span>
          </button>
          <button class="mdc-button mdc-button--outlined" id="exportClientesBtn">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
            <span class="mdc-button__label">Exportar Excel</span>
          </button>
          <button class="mdc-button mdc-button--raised" id="addClientBtn">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">person_add</i>
            <span class="mdc-button__label">Agregar Cliente</span>
          </button>
          <input type="file" id="excelFileInput" accept=".xls,.xlsx" style="display: none;">
        </div>

        <!-- Campo de b√∫squeda de clientes -->
        <div style="margin-bottom: 15px;">
          <label class="mdc-text-field mdc-text-field--outlined" style="width: 100%; max-width: 400px;">
            <span class="mdc-notched-outline">
              <span class="mdc-notched-outline__leading"></span>
              <span class="mdc-notched-outline__notch">
                <span class="mdc-floating-label" id="clientSearchLabel">Buscar cliente</span>
              </span>
              <span class="mdc-notched-outline__trailing"></span>
            </span>
            <input type="text"
                   class="mdc-text-field__input"
                   id="clientSearchInput"
                   placeholder="Buscar por c√≥digo, nombre, email, tel√©fono..."
                   style="color: #f1f1f1;">
            <i class="material-icons" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #4CAF50; pointer-events: none;">search</i>
          </label>
          <div style="margin-top: 8px; color: #b5b5b5; font-size: 12px;">
            <span id="clientSearchResults">Mostrando todos los clientes</span>
          </div>
        </div>

        <div class="clientes-table-container">
          <table class="clientes-table">
            <thead>
              <tr>
                <th data-column="codigo" class="sortable" data-sort="codigo"><span class="column-label">C√≥digo<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="codigo" title="Ocultar columna">‚àí</button></th>
                <th data-column="nombre" class="sortable" data-sort="nombre"><span class="column-label">Nombre<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="nombre" title="Ocultar columna">‚àí</button></th>
                <th data-column="nombreComercial" class="sortable" data-sort="nombreComercial"><span class="column-label">Nombre Comercial<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="nombreComercial" title="Ocultar columna">‚àí</button></th>
                <th data-column="grupo" class="sortable" data-sort="grupo"><span class="column-label">Grupo<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="grupo" title="Ocultar columna">‚àí</button></th>
                <th data-column="departamento" class="sortable" data-sort="departamento"><span class="column-label">Departamento<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="departamento" title="Ocultar columna">‚àí</button></th>
                <th data-column="inscripcion" class="sortable" data-sort="inscripcion"><span class="column-label">Inscripci√≥n<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="inscripcion" title="Ocultar columna">‚àí</button></th>
                <th data-column="nroDocumento" class="sortable" data-sort="nroDocumento"><span class="column-label">Nro Documento<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="nroDocumento" title="Ocultar columna">‚àí</button></th>
                <th data-column="direccion" class="sortable" data-sort="direccion"><span class="column-label">Direcci√≥n<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="direccion" title="Ocultar columna">‚àí</button></th>
                <th data-column="ciudad" class="sortable" data-sort="ciudad"><span class="column-label">Ciudad<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="ciudad" title="Ocultar columna">‚àí</button></th>
                <th data-column="provincia" class="sortable" data-sort="provincia"><span class="column-label">Provincia<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="provincia" title="Ocultar columna">‚àí</button></th>
                <th data-column="pais" class="sortable" data-sort="pais"><span class="column-label">Pa√≠s<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="pais" title="Ocultar columna">‚àí</button></th>
                <th data-column="telefono" class="sortable" data-sort="telefono"><span class="column-label">Tel√©fono<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="telefono" title="Ocultar columna">‚àí</button></th>
                <th data-column="email" class="sortable" data-sort="email"><span class="column-label">Email<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="email" title="Ocultar columna">‚àí</button></th>
                <th data-column="vendedor" class="sortable" data-sort="vendedor"><span class="column-label">Vendedor<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="vendedor" title="Ocultar columna">‚àí</button></th>
                <th data-column="listaPrecio" class="sortable" data-sort="listaPrecio"><span class="column-label">Lista<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="listaPrecio" title="Ocultar columna">‚àí</button></th>
                <th data-column="saldoCredito" class="sortable" data-sort="saldoCredito"><span class="column-label">Saldo Cr√©dito<span class="sort-indicator"></span></span><button class="column-toggle-btn" data-column="saldoCredito" title="Ocultar columna">‚àí</button></th>
                <!-- Columna Acciones: Botones de edici√≥n/eliminaci√≥n + controles globales de columnas (v0.35) -->
                <th>
                  Acciones
                  <!-- Bot√≥n '‚àí': Minimiza TODAS las columnas de una vez. √ötil para crear vista personalizada -->
                  <button class="collapse-all-btn" id="collapseAllColumnsBtn" title="Minimizar todas las columnas">‚àí</button>
                  <!-- Bot√≥n '+': Maximiza TODAS las columnas de una vez. Restaura vista completa -->
                  <button class="expand-all-btn" id="expandAllColumnsBtn" title="Maximizar todas las columnas">+</button>
                </th>
              </tr>
            </thead>
            <tbody id="clientesTableBody">
              <tr>
                <td colspan="17" style="text-align: center; padding: 20px;">
                  Cargando clientes...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="vendedor-content" class="tab-content" style="display: none;">
      <h2>ü§ù Gesti√≥n de Vendedores</h2>

      <div class="admin-section">
        <div class="sellers-header">
          <h3>Lista de Vendedores</h3>
          <button class="mdc-button mdc-button--raised add-seller-btn" id="addSellerBtn">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">person_add</i>
            <span class="mdc-button__label">Agregar Vendedor</span>
          </button>
        </div>

        <div id="sellersContainer">
          <div class="loading-sellers">
            <p>Cargando vendedores...</p>
          </div>
        </div>
      </div>

      <div class="admin-section">
        <h3>Estad√≠sticas</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-number" id="totalSellers">0</span>
            <span class="stat-label">Total Vendedores</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="activeSellers">0</span>
            <span class="stat-label">Activos</span>
          </div>
        </div>
      </div>
    </div>

    <div id="master-content" class="tab-content" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">üìã Seguimiento de Pedidos - Admin</h2>
        <div style="display: flex; gap: 10px;">
          <button class="mdc-button mdc-button--outlined" id="refreshOrdersBtn">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">refresh</i>
            <span class="mdc-button__label">Actualizar</span>
          </button>
          <button class="mdc-button mdc-button--outlined" id="exportOrdersBtn" style="background-color: #4CAF50; color: white;">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
            <span class="mdc-button__label">Exportar Excel</span>
          </button>
        </div>
      </div>

      <!-- Search Box -->
      <div style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; align-items: center; background: #2a2a32; padding: 15px; border-radius: 8px;">
          <i class="material-icons" style="color: #4CAF50;">search</i>
          <input
            type="text"
            id="orderSearchInput"
            placeholder="Buscar por n√∫mero de orden, n√∫mero de cliente o nombre de cliente..."
            style="flex: 1; background: #1e1e24; border: 1px solid #3a3a42; color: #fff; padding: 12px; border-radius: 4px; font-size: 14px; outline: none;"
          />
          <button
            id="clearSearchBtn"
            class="mdc-button mdc-button--outlined"
            style="display: none; min-width: auto; padding: 8px 16px;"
          >
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">clear</i>
            <span class="mdc-button__label">Limpiar</span>
          </button>
        </div>
        <div id="searchResultsCount" style="margin-top: 8px; color: #888; font-size: 13px; display: none;"></div>
      </div>

      <div class="stats-grid" style="margin-bottom: 24px;">
        <div class="stat-item">
          <span class="stat-number" id="totalOrders">0</span>
          <span class="stat-label">Total √ìrdenes</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="borradorOrders">0</span>
          <span class="stat-label">Borrador</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="revisionOrders">0</span>
          <span class="stat-label">En Revisi√≥n</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="aprobadaOrders">0</span>
          <span class="stat-label">Aprobadas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="preparacionOrders">0</span>
          <span class="stat-label">En Preparaci√≥n</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="listoOrders">0</span>
          <span class="stat-label">Listo para Despacho</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="despachadaOrders">0</span>
          <span class="stat-label">Despachadas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="entregadaOrders">0</span>
          <span class="stat-label">Entregadas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="cerradaOrders">0</span>
          <span class="stat-label">Cerradas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="canceladaOrders">0</span>
          <span class="stat-label">Canceladas</span>
        </div>
      </div>

      <div class="logistics-content">
        <div class="logistics-section">
          <h4>üìù Borrador</h4>
          <div class="logistics-orders" id="admin-borradorOrders">
            <p class="no-orders">No hay pedidos en borrador</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>üîç En Revisi√≥n</h4>
          <div class="logistics-orders" id="admin-revisionOrders">
            <p class="no-orders">No hay pedidos en revisi√≥n</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>‚úÖ Aprobada</h4>
          <div class="logistics-orders" id="admin-aprobadaOrders">
            <p class="no-orders">No hay pedidos aprobados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>üì¶ En Preparaci√≥n</h4>
          <div class="logistics-orders" id="admin-preparacionOrders">
            <p class="no-orders">No hay pedidos en preparaci√≥n</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>üöö Listo para Retiro/Despacho</h4>
          <div class="logistics-orders" id="admin-listoOrders">
            <p class="no-orders">No hay pedidos listos</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>üöõ Despachada</h4>
          <div class="logistics-orders" id="admin-despachadaOrders">
            <p class="no-orders">No hay pedidos despachados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>‚úÖ Entregada</h4>
          <div class="logistics-orders" id="admin-entregadaOrders">
            <p class="no-orders">No hay pedidos entregados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>üîí Cerrada</h4>
          <div class="logistics-orders" id="admin-cerradaOrders">
            <p class="no-orders">No hay pedidos cerrados</p>
          </div>
        </div>

        <div class="logistics-section">
          <h4>‚ùå Cancelada</h4>
          <div class="logistics-orders" id="admin-canceladaOrders">
            <p class="no-orders">No hay pedidos cancelados</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admisiones Content -->
  <div id="admisiones-content" class="tab-content" style="display: none;">
    <h2>üë• Gesti√≥n de Admisiones</h2>
    <div class="admin-section">
      <p style="color: #888; margin-bottom: 20px;">Usuarios pendientes de aprobaci√≥n. Aprueba usuarios y asigna roles.</p>

      <div id="pendingUsersContainer">
        <div id="pendingUsersList"></div>
        <div id="noPendingUsers" style="display: none; text-align: center; padding: 40px; color: #666;">
          <i class="material-icons" style="font-size: 64px; opacity: 0.3;">check_circle</i>
          <p>No hay usuarios pendientes de aprobaci√≥n</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Seller Modal -->
  <div id="sellerModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button" id="closeSellerModal">&times;</span>
      <h2 id="sellerModalTitle">Agregar Vendedor</h2>

      <form id="sellerForm">
        <div class="form-group">
          <label for="sellerName">Nombre Completo *</label>
          <input type="text" id="sellerName" name="name" required>
        </div>

        <div class="form-group">
          <label for="sellerEmail">Email</label>
          <input type="email" id="sellerEmail" name="email">
        </div>

        <div class="form-group">
          <label for="sellerPhone">Tel√©fono</label>
          <input type="tel" id="sellerPhone" name="phone">
        </div>

        <div class="form-group">
          <label for="sellerPhone2">Tel√©fono 2</label>
          <input type="tel" id="sellerPhone2" name="phone2">
        </div>

        <div class="form-group">
          <label for="sellerTerritory">Territorio</label>
          <input type="text" id="sellerTerritory" name="territory" placeholder="Ej: Zona Norte, Centro, etc.">
        </div>

        <div class="form-group">
          <label for="sellerCommission">Comisi√≥n (%)</label>
          <input type="number" id="sellerCommission" name="commission" min="0" max="100" step="0.1">
        </div>

        <div class="form-group">
          <label for="sellerStatus">Estado</label>
          <select id="sellerStatus" name="status">
            <option value="active">Activo</option>
            <option value="inactive">Inactivo</option>
          </select>
        </div>

        <div class="form-group">
          <label for="sellerNotes">Notas</label>
          <textarea id="sellerNotes" name="notes" rows="3" placeholder="Informaci√≥n adicional..."></textarea>
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
          <button type="button" class="mdc-button mdc-button--outlined" id="cancelSellerBtn">
            <span class="mdc-button__label">Cancelar</span>
          </button>
          <button type="submit" class="mdc-button mdc-button--raised" id="saveSellerBtn">
            <span class="mdc-button__label">Guardar</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Client Modal -->
  <div id="clientModal" class="modal hidden">
    <div class="modal-content" style="max-width: 700px;">
      <span class="close-button" id="closeClientModal">&times;</span>
      <h2 id="clientModalTitle">‚ûï Agregar Cliente</h2>

      <form id="clientForm">
        <div class="form-row">
          <div class="form-group">
            <label for="clientCodigo">C√≥digo *</label>
            <input type="text" id="clientCodigo" required>
          </div>
          <div class="form-group">
            <label for="clientGrupo">Grupo</label>
            <input type="text" id="clientGrupo">
          </div>
        </div>

        <div class="form-group">
          <label for="clientNombre">Nombre *</label>
          <input type="text" id="clientNombre" required>
        </div>

        <div class="form-group">
          <label for="clientNombreComercial">Nombre Comercial</label>
          <input type="text" id="clientNombreComercial">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="clientInscripcion">Inscripci√≥n</label>
            <input type="text" id="clientInscripcion">
          </div>
          <div class="form-group">
            <label for="clientNroDocumento">Nro Documento</label>
            <input type="text" id="clientNroDocumento">
          </div>
        </div>

        <div class="form-group">
          <label for="clientDireccion">Direcci√≥n</label>
          <input type="text" id="clientDireccion">
        </div>

        <div class="form-row-triple">
          <div class="form-group">
            <label for="clientCiudad">Ciudad</label>
            <input type="text" id="clientCiudad">
          </div>
          <div class="form-group">
            <label for="clientProvincia">Provincia</label>
            <input type="text" id="clientProvincia">
          </div>
          <div class="form-group">
            <label for="clientPais">Pa√≠s</label>
            <input type="text" id="clientPais">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="clientTelefono">Tel√©fono</label>
            <input type="text" id="clientTelefono">
          </div>
          <div class="form-group">
            <label for="clientEmail">Email</label>
            <input type="email" id="clientEmail">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="clientDepartamento">Departamento</label>
            <input type="text" id="clientDepartamento">
          </div>
          <div class="form-group">
            <label for="clientSaldoCredito">Saldo Cr√©dito</label>
            <input type="number" id="clientSaldoCredito" step="0.01" placeholder="0.00">
          </div>
        </div>

        <div class="form-group">
          <label for="clientListaPrecio">Lista de Precios</label>
          <select id="clientListaPrecio" style="padding: 10px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0; width: 100%; font-size: 14px;">
            <option value="precios1">Precios 1 (Por defecto)</option>
            <option value="precios2">Precios 2</option>
            <option value="precios3">Precios 3</option>
            <option value="precios4">Precios 4</option>
            <option value="precios5">Precios 5</option>
          </select>
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
          <button type="button" class="mdc-button mdc-button--outlined" id="cancelClientBtn">
            <span class="mdc-button__label">Cancelar</span>
          </button>
          <button type="submit" class="mdc-button mdc-button--raised" id="saveClientBtn">
            <span class="mdc-button__label">Guardar</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal hidden">
    <div class="modal-content" style="max-width: 400px;">
      <span class="close-button" id="closeConfirmModal">&times;</span>
      <h2>Confirmar Eliminaci√≥n</h2>
      <p id="confirmMessage">¬øEst√°s seguro de que deseas eliminar este registro?</p>
      <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
        <button type="button" class="mdc-button mdc-button--outlined" id="cancelDeleteBtn">
          <span class="mdc-button__label">Cancelar</span>
        </button>
        <button type="button" class="mdc-button mdc-button--raised delete-seller-btn" id="confirmDeleteBtn">
          <span class="mdc-button__label">Eliminar</span>
        </button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
  <!-- SheetJS library for Excel file support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script type="module">
    // === FIREBASE CONFIGURATION ===
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc, collection, query, orderBy, getDocs, where, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCXjSGtVGfQas_cEyjmI0RTaeEl94jdp6g",
      authDomain: "carrito-138c3.firebaseapp.com",
      projectId: "carrito-138c3",
      storageBucket: "carrito-138c3.appspot.com",
      messagingSenderId: "579670725719",
      appId: "1:579670725719:web:carrito138c3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // === EXPOSAR FIREBASE EN WINDOW PARA COMPATIBILIDAD ===
    window.firebase = {
      app: () => app,
      auth: () => auth,
      firestore: () => db,
      storage: () => storage,
      firestoreHelpers: {
        doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc, collection, query, orderBy, getDocs, where, writeBatch
      },
      storageHelpers: {
        ref, uploadBytes, getDownloadURL
      },
      authHelpers: {
        onAuthStateChanged, signOut
      }
    };

    // === ADMIN ACCESS CONTROL ===
    // Variable global para almacenar el estado de admin
    let isUserAdmin = false;

    // === PRICE TABLE SORTING STATE ===
    let priceTableSort = {
      column: 'articulo',
      direction: 'asc'
    };

    let clientTableSort = {
      column: 'codigo',
      direction: 'asc'
    };

    async function checkAdminAccess(user) {
      try {
        console.log('üîê Verificando acceso admin para:', user.email);

        // Usar el mismo patr√≥n que marketplace.html
        if (typeof firebase !== 'undefined' && firebase.firestoreHelpers) {
          const { doc, getDoc } = firebase.firestoreHelpers;
          const userRef = doc(firebase.firestore(), 'usuarios', user.uid);
          const userDoc = await getDoc(userRef);

          let isAdmin = false;
          if (userDoc.exists()) {
            const userData = userDoc.data();
            isAdmin = userData.admin === true;
            isUserAdmin = isAdmin; // Guardar en variable global
            console.log('üë§ Usuario encontrado:', userData);
            console.log('üîê Es admin:', isAdmin);

            if (!isAdmin) {
              console.log('‚ÑπÔ∏è Usuario no es admin, acceso de solo lectura');
              // No redirigir, solo mostrar con permisos de solo lectura
            } else {
              console.log('‚úÖ Acceso admin confirmado para:', user.email);
            }

            return true; // Permitir acceso a todos los usuarios autenticados
          } else {
            console.log('‚ö†Ô∏è Usuario no encontrado en Firestore');
            isUserAdmin = false;
            return true; // Permitir acceso de solo lectura
          }
        } else {
          console.log('‚ö†Ô∏è Firebase helpers not available, waiting...');
          // Retry after a short delay
          setTimeout(() => {
            if (user) checkAdminAccess(user);
          }, 1000);
          return false;
        }
      } catch (error) {
        console.error('‚ùå Error verificando acceso admin:', error);
        isUserAdmin = false;
        return true; // Permitir acceso de solo lectura en caso de error
      }
    }

    // === AUTH STATE LISTENER (Mismo patr√≥n que marketplace.html) ===
    // Usar setTimeout para esperar que Firebase est√© completamente cargado
    setTimeout(() => {
      if (window.firebase && window.firebase.firestoreHelpers) {
        firebase.auth().onAuthStateChanged(async function(user) {
          if (user) {
            console.log('üë§ Usuario autenticado en Administration.html:', user.email);
            console.log('üîç UID del usuario:', user.uid);

            const hasAccess = await checkAdminAccess(user);
            if (hasAccess) {
              console.log('‚úÖ Usuario admin confirmado, mostrando p√°gina');
            }
          } else {
            console.log('üë§ Usuario no autenticado, redirigiendo a login...');
            window.location.href = 'login.html';
          }
        });
      } else {
        console.log('‚ö†Ô∏è Firebase not ready, retrying...');
        // Retry if Firebase not ready
        setTimeout(arguments.callee, 500);
      }
    }, 1000); // Mismo delay que marketplace.html

    console.log('‚úÖ Firebase inicializado en Administration.html');

    // === SELLER MANAGEMENT FUNCTIONS ===

    // Load sellers from Firebase
    async function loadSellers() {
      try {
        if (!window.firebase || !firebase.firestoreHelpers) {
          console.log('‚ö†Ô∏è Firebase not ready for sellers, waiting...');
          setTimeout(loadSellers, 1000);
          return;
        }

        const { collection, getDocs, orderBy, query, addDoc, deleteDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        console.log('üìã Cargando vendedores...');

        const sellersCollection = collection(db, 'vendedores');
        const q = query(sellersCollection, orderBy('name', 'asc'));
        const querySnapshot = await getDocs(q);

        window.sellers = [];
        querySnapshot.forEach((doc) => {
          window.sellers.push({
            id: doc.id,
            ...doc.data()
          });
        });

        console.log('‚úÖ Vendedores cargados:', window.sellers.length);
        displaySellers();
        updateStats();

      } catch (error) {
        console.error('‚ùå Error cargando vendedores:', error);
        document.getElementById('sellersContainer').innerHTML = `
          <div class="no-sellers">
            Error cargando vendedores. Int√©ntalo de nuevo.
          </div>
        `;
      }
    }

    // Display sellers in the UI
    function displaySellers() {
      const container = document.getElementById('sellersContainer');

      if (window.sellers.length === 0) {
        container.innerHTML = `
          <div class="no-sellers">
            No hay vendedores registrados. Haz clic en "Agregar Vendedor" para crear uno.
          </div>
        `;
        return;
      }

      const sellersHTML = window.sellers.map(seller => `
        <div class="seller-card" data-seller-id="${seller.id}">
          <div class="seller-info">
            <div class="seller-name">${seller.name}</div>
            <div class="seller-details">
              ${seller.email}${seller.phone ? ' ‚Ä¢ ' + seller.phone : ''}${seller.phone2 ? ' ‚Ä¢ ' + seller.phone2 : ''}
              ${seller.territory ? ' ‚Ä¢ ' + seller.territory : ''}
              ${seller.commission ? ' ‚Ä¢ ' + seller.commission + '% comisi√≥n' : ''}
            </div>
          </div>
          <span class="seller-status ${seller.status === 'active' ? 'status-active' : 'status-inactive'}">
            ${seller.status === 'active' ? 'Activo' : 'Inactivo'}
          </span>
          <div class="seller-actions">
            <button class="mdc-button edit-seller-btn" onclick="editSeller('${seller.id}')">
              <i class="material-icons">edit</i>
            </button>
            <button class="mdc-button delete-seller-btn" onclick="confirmDeleteSeller('${seller.id}', '${seller.name}')">
              <i class="material-icons">delete</i>
            </button>
          </div>
        </div>
      `).join('');

      container.innerHTML = sellersHTML;

      // Initialize button ripples
      const buttons = container.querySelectorAll('.mdc-button');
      buttons.forEach(button => {
        if (!button._mdcRipple) {
          mdc.ripple.MDCRipple.attachTo(button);
        }
      });
    }

    // Update statistics
    function updateStats() {
      const totalSellers = window.sellers.length;
      const activeSellers = window.sellers.filter(s => s.status === 'active').length;

      document.getElementById('totalSellers').textContent = totalSellers;
      document.getElementById('activeSellers').textContent = activeSellers;
    }

    // Add or update seller
    async function saveSeller(sellerData) {
      try {
        if (!window.firebase || !firebase.firestoreHelpers) {
          throw new Error('Firebase not available');
        }

        const { collection, addDoc, updateDoc, doc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        if (window.currentEditingSellerId) {
          // Update existing seller
          const sellerRef = doc(db, 'vendedores', window.currentEditingSellerId);
          await updateDoc(sellerRef, {
            ...sellerData,
            updatedAt: new Date()
          });
          console.log('‚úÖ Vendedor actualizado:', window.currentEditingSellerId);
        } else {
          // Add new seller
          const sellersCollection = collection(db, 'vendedores');
          const docRef = await addDoc(sellersCollection, {
            ...sellerData,
            createdAt: new Date(),
            updatedAt: new Date()
          });
          console.log('‚úÖ Vendedor agregado:', docRef.id);
        }

        // Reload sellers
        await loadSellers();
        closeSellerModal();

      } catch (error) {
        console.error('‚ùå Error guardando vendedor:', error);
        alert('Error guardando vendedor. Int√©ntalo de nuevo.');
      }
    }

    // Delete seller
    async function deleteSeller(sellerId) {
      try {
        if (!window.firebase || !firebase.firestoreHelpers) {
          throw new Error('Firebase not available');
        }

        const { doc, deleteDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const sellerRef = doc(db, 'vendedores', sellerId);
        await deleteDoc(sellerRef);

        console.log('‚úÖ Vendedor eliminado:', sellerId);
        await loadSellers();

      } catch (error) {
        console.error('‚ùå Error eliminando vendedor:', error);
        alert('Error eliminando vendedor. Int√©ntalo de nuevo.');
      }
    }

    // === PRODUCT PRICING FUNCTIONS ===

    // Load products from API (same endpoint as used in main.js)
    async function loadProducts() {
      console.log('üöÄ loadProducts called');
      try {
        // Check if we're already loading
        if (window.productsLoading) {
          console.log('‚è≥ Products already loading, skipping...');
          return;
        }

        window.productsLoading = true;

        if (!window.firebase || !firebase.firestoreHelpers) {
          console.log('‚ö†Ô∏è Firebase not ready for products, waiting...');
          window.productsLoading = false;
          setTimeout(() => {
            console.log('üîÑ Retrying loadProducts after Firebase delay');
            loadProducts();
          }, 1000);
          return;
        }

        console.log('üì¶ Cargando productos desde API...');

        // Show loading state in button
        const loadBtn = document.getElementById('loadProductsBtn');
        const originalLoadText = loadBtn ? loadBtn.querySelector('.mdc-button__label').textContent : '';
        if (loadBtn) {
          loadBtn.querySelector('.mdc-button__label').innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin-right: 8px;"></div>Cargando...';
          loadBtn.disabled = true;
        }

        // Show loading state
        const container = document.getElementById('productsContainer');
        container.innerHTML = `
          <div class="loading-products">
            <div class="loading-content">
              <div class="loading-spinner"></div>
              <p>Cargando productos desde la API...</p>
            </div>
          </div>
        `;

        // Use same API configuration as main.js
        const API_BASE = '/api';
        const AUTH_URL = `${API_BASE}/authenticate`;
        const STOCK_URL = `${API_BASE}/stock`;

        const CREDENTIALS = {
          username: 'Api',
          md5password: 'e10adc3949ba59abbe56e057f20f883e'
        };

        // Authenticate
        const authResp = await fetch(AUTH_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(CREDENTIALS)
        });

        if (!authResp.ok) {
          throw new Error(`Authentication failed (${authResp.status})`);
        }

        const authData = await authResp.json();
        if (!authData.ok || !authData.token) {
          throw new Error('Invalid authentication response');
        }

        // Fetch stock data
        const query = new URLSearchParams({ format: 'JSON', ViewOption: 0 }).toString();
        const stockResp = await fetch(`${STOCK_URL}?${query}`, {
          headers: { Authorization: `Bearer ${authData.token}` }
        });

        if (!stockResp.ok) {
          throw new Error(`Error fetching stock (${stockResp.status})`);
        }

        const stockData = await stockResp.json();
        const products = Array.isArray(stockData) ? stockData : (stockData.data || stockData.list || []);

        // Process and store products with existing prices
        window.products = await processProductsWithPrices(products);

        console.log('‚úÖ Productos cargados:', window.products.length);
        displayProducts();

        // Restore button state
        if (loadBtn) {
          loadBtn.querySelector('.mdc-button__label').textContent = originalLoadText;
          loadBtn.disabled = false;
        }

        // Reset loading flag
        window.productsLoading = false;

      } catch (error) {
        console.error('‚ùå Error cargando productos:', error);

        // Restore button state on error
        const loadBtn = document.getElementById('loadProductsBtn');
        const originalLoadText = loadBtn ? loadBtn.querySelector('.mdc-button__label').textContent.replace(/.*Cargando.../, 'Actualizar Productos') : 'Actualizar Productos';
        if (loadBtn) {
          loadBtn.querySelector('.mdc-button__label').textContent = originalLoadText;
          loadBtn.disabled = false;
        }

        // Reset loading flag
        window.productsLoading = false;

        document.getElementById('productsContainer').innerHTML = `
          <div class="no-products">
            Error cargando productos: ${error.message}
            <br><br>
            <button class="mdc-button mdc-button--outlined" onclick="loadProducts()">
              <span class="mdc-button__label">Reintentar</span>
            </button>
          </div>
        `;
      }
    }

    // Process products and merge with existing price data from Firebase
    async function processProductsWithPrices(rawProducts) {
      const { collection, getDocs } = firebase.firestoreHelpers;
      const db = firebase.firestore();

      // Load existing prices from Firebase
      const pricesCollection = collection(db, 'precios');
      const pricesSnapshot = await getDocs(pricesCollection);

      const existingPrices = new Map();
      pricesSnapshot.forEach((doc) => {
        const data = doc.data();
        existingPrices.set(data.articulo, {
          id: doc.id,
          precio1: data.precio1 || 0,
          precio2: data.precio2 || 0,
          precio3: data.precio3 || 0,
          precio4: data.precio4 || 0
        });
      });

      // Process and normalize product data
      return rawProducts.map(raw => {
        // Extract articulo and description using same logic as main.js
        const articulo = getFirstExisting(raw, ['Art√≠culo', 'Articulo', 'item', 'Item', 'Codigo', 'C√≥digo']) || '';
        const description = getFirstExisting(raw, ['Descripci√≥n', 'Descripcion', 'description', 'Description', 'Detalle']) || '';

        // Get existing prices or set defaults
        const prices = existingPrices.get(articulo) || {
          precio1: 0,
          precio2: 0,
          precio3: 0,
          precio4: 0
        };

        return {
          articulo,
          description,
          ...prices,
          modified: false
        };
      }).filter(product => product.articulo && product.description); // Only include products with both fields
    }

    // Helper function from main.js for extracting fields
    function normalizeKey(key) {
      return String(key)
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // quitar acentos
        .replace(/[^a-z0-9]/g, '');
    }

    function getFirstExisting(row, candidateKeys) {
      const normalizedMap = new Map();
      for (const k of Object.keys(row || {})) {
        normalizedMap.set(normalizeKey(k), k);
      }
      for (const c of candidateKeys) {
        const nk = normalizeKey(c);
        if (normalizedMap.has(nk)) {
          const originalKey = normalizedMap.get(nk);
          return row[originalKey];
        }
      }
      return undefined;
    }

    // Display products in pricing table
    function displayProducts() {
      const container = document.getElementById('productsContainer');

      if (!window.products || window.products.length === 0) {
        container.innerHTML = `
          <div class="no-products">
            No se encontraron productos.
            <br><br>
            <button class="mdc-button mdc-button--outlined" onclick="loadProducts()">
              <span class="mdc-button__label">Cargar Productos</span>
            </button>
          </div>
        `;
        return;
      }

      // Sort products based on current sort state
      const sortedProducts = [...window.products].sort((a, b) => {
        const col = priceTableSort.column;
        const dir = priceTableSort.direction === 'asc' ? 1 : -1;
        let aVal = a[col];
        let bVal = b[col];

        // Handle null/undefined values - push them to the end
        if (aVal === null || aVal === undefined) return 1;
        if (bVal === null || bVal === undefined) return -1;

        if (typeof aVal === 'string' && typeof bVal === 'string') {
          return aVal.localeCompare(bVal, 'es', { numeric: true, sensitivity: 'base' }) * dir;
        }

        // Numeric comparison
        const aNum = Number(aVal);
        const bNum = Number(bVal);
        return (aNum - bNum) * dir;
      });

      // Helper function to generate sort indicator
      const getSortIndicator = (columnId) => {
        if (priceTableSort.column === columnId) {
          return priceTableSort.direction === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
        }
        return ' ‚áÖ';
      };

      // Helper function to get sorted class
      const getSortedClass = (columnId) => {
        return priceTableSort.column === columnId ? 'sorted' : '';
      };

      const productsHTML = `
        <div class="price-stats">
          <div class="price-stat">
            Total productos: <span class="price-stat-number">${window.products.length}</span>
          </div>
          <div class="price-stat">
            Con precios: <span class="price-stat-number">${window.products.filter(p => p.precio1 > 0 || p.precio2 > 0 || p.precio3 > 0 || p.precio4 > 0).length}</span>
          </div>
        </div>

        <table class="products-table">
          <thead>
            <tr>
              <th class="sortable ${getSortedClass('articulo')}" data-sort="articulo">Art√≠culo${getSortIndicator('articulo')}</th>
              <th class="sortable ${getSortedClass('description')}" data-sort="description">Descripci√≥n${getSortIndicator('description')}</th>
              <th class="sortable ${getSortedClass('precio1')}" data-sort="precio1">Precio 1${getSortIndicator('precio1')}</th>
              <th class="sortable ${getSortedClass('precio2')}" data-sort="precio2">Precio 2${getSortIndicator('precio2')}</th>
              <th class="sortable ${getSortedClass('precio3')}" data-sort="precio3">Precio 3${getSortIndicator('precio3')}</th>
              <th class="sortable ${getSortedClass('precio4')}" data-sort="precio4">Precio 4${getSortIndicator('precio4')}</th>
            </tr>
          </thead>
          <tbody>
            ${sortedProducts.map(product => `
              <tr data-articulo="${product.articulo}">
                <td>
                  <span class="product-code">${product.articulo}</span>
                </td>
                <td>
                  <span class="product-description">${product.description}</span>
                </td>
                <td>
                  <input type="number"
                         class="price-input"
                         data-articulo="${product.articulo}"
                         data-price="precio1"
                         value="${product.precio1}"
                         step="0.01"
                         min="0"
                         placeholder="0.00">
                </td>
                <td>
                  <input type="number"
                         class="price-input"
                         data-articulo="${product.articulo}"
                         data-price="precio2"
                         value="${product.precio2}"
                         step="0.01"
                         min="0"
                         placeholder="0.00">
                </td>
                <td>
                  <input type="number"
                         class="price-input"
                         data-articulo="${product.articulo}"
                         data-price="precio3"
                         value="${product.precio3}"
                         step="0.01"
                         min="0"
                         placeholder="0.00">
                </td>
                <td>
                  <input type="number"
                         class="price-input"
                         data-articulo="${product.articulo}"
                         data-price="precio4"
                         value="${product.precio4}"
                         step="0.01"
                         min="0"
                         placeholder="0.00">
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = productsHTML;

      // Show save button
      const saveBtn = document.getElementById('saveAllPricesBtn');
      if (saveBtn) {
        saveBtn.style.display = 'inline-flex';
      }

      // Add event listeners to price inputs
      setupPriceInputListeners();

      // Add event listeners to sortable headers
      setupSortableHeaders();
    }

    // Setup event listeners for sortable table headers
    function setupSortableHeaders() {
      const sortableHeaders = document.querySelectorAll('.products-table th.sortable');
      sortableHeaders.forEach(th => {
        th.addEventListener('click', function() {
          const column = this.dataset.sort;

          if (priceTableSort.column === column) {
            // Toggle direction if same column clicked
            priceTableSort.direction = priceTableSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            // Set new column and default to ascending
            priceTableSort.column = column;
            priceTableSort.direction = 'asc';
          }

          // Re-render the table with new sort
          displayProducts();
        });
      });
    }

    // Setup event listeners for price inputs
    function setupPriceInputListeners() {
      const priceInputs = document.querySelectorAll('.price-input');
      priceInputs.forEach(input => {
        input.addEventListener('input', function() {
          const articulo = this.dataset.articulo;
          const priceField = this.dataset.price;
          const value = parseFloat(this.value) || 0;

          // Find and update the product in memory
          const product = window.products.find(p => p.articulo === articulo);
          if (product) {
            product[priceField] = value;
            product.modified = true;
            this.classList.add('modified');
          }
        });

        input.addEventListener('blur', function() {
          // Format the value on blur
          const value = parseFloat(this.value) || 0;
          this.value = value.toFixed(2);
        });
      });
    }

    // Save all prices to Firebase
    async function saveAllPrices() {
      try {
        if (!window.firebase || !firebase.firestoreHelpers) {
          throw new Error('Firebase not available');
        }

        if (!window.products) {
          throw new Error('No products loaded');
        }

        const { collection, doc, setDoc, updateDoc, addDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();
        const pricesCollection = collection(db, 'precios');

        console.log('üíæ Guardando precios...');

        // Show saving indicator
        const saveBtn = document.getElementById('saveAllPricesBtn');
        const originalText = saveBtn.querySelector('.mdc-button__label').textContent;
        saveBtn.querySelector('.mdc-button__label').innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin-right: 8px;"></div>Guardando...';
        saveBtn.disabled = true;

        let savedCount = 0;

        for (const product of window.products) {
          const priceData = {
            articulo: product.articulo,
            description: product.description,
            precio1: product.precio1 || 0,
            precio2: product.precio2 || 0,
            precio3: product.precio3 || 0,
            precio4: product.precio4 || 0,
            updatedAt: new Date()
          };

          if (product.id) {
            // Update existing price record
            const priceRef = doc(db, 'precios', product.id);
            await updateDoc(priceRef, priceData);
          } else {
            // Create new price record
            const docRef = await addDoc(pricesCollection, {
              ...priceData,
              createdAt: new Date()
            });
            product.id = docRef.id;
          }

          product.modified = false;
          savedCount++;
        }

        // Remove modified styling from all inputs
        document.querySelectorAll('.price-input.modified').forEach(input => {
          input.classList.remove('modified');
        });

        console.log(`‚úÖ Precios guardados: ${savedCount} productos`);
        alert(`Precios guardados exitosamente para ${savedCount} productos`);

        // Restore button
        saveBtn.querySelector('.mdc-button__label').textContent = originalText;
        saveBtn.disabled = false;

      } catch (error) {
        console.error('‚ùå Error guardando precios:', error);
        alert('Error guardando precios. Int√©ntalo de nuevo.');

        // Restore button
        const saveBtn = document.getElementById('saveAllPricesBtn');
        saveBtn.querySelector('.mdc-button__label').textContent = 'Guardar Todos los Precios';
        saveBtn.disabled = false;
      }
    }

    // Import prices from CSV/Excel file
    async function importPrices() {
      const fileInput = document.getElementById('pricesFileInput');
      fileInput.click();
    }

    // Process imported price file
    async function processPriceFile(file) {
      try {
        console.log('üìÅ Procesando archivo de precios:', file.name);

        let data;
        const fileName = file.name.toLowerCase();

        if (fileName.endsWith('.csv')) {
          data = await parseCSV(file);
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
          data = await parseExcel(file);
        } else {
          throw new Error('Formato de archivo no soportado. Use CSV (.csv) o Excel (.xlsx, .xls)');
        }

        // Validate and process data
        const processedPrices = validateAndProcessPriceData(data);

        if (processedPrices.length === 0) {
          throw new Error('No se encontraron datos v√°lidos en el archivo');
        }

        // Show preview and confirm import
        const confirmMessage = `¬øDesea importar ${processedPrices.length} precios desde el archivo "${file.name}"?\n\nPrimeros 3 registros:\n${processedPrices.slice(0, 3).map(p => `‚Ä¢ ${p.articulo}: ${p.description} (Precios: ${p.precio1}, ${p.precio2}, ${p.precio3}, ${p.precio4})`).join('\n')}`;

        if (confirm(confirmMessage)) {
          // Show progress
          const container = document.getElementById('productsContainer');
          container.innerHTML = `
            <div class="loading-products">
              <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>Importando ${processedPrices.length} precios...</p>
              </div>
            </div>
          `;

          await importPriceData(processedPrices);
          alert(`‚úÖ Precios importados exitosamente: ${processedPrices.length} registros`);

          // Reload products to show updated prices (with small delay to ensure Firebase propagation)
          setTimeout(() => {
            if (window.loadProducts) {
              console.log('üîÑ Reloading products after import...');
              window.loadProducts();
            }
          }, 500);
        }

      } catch (error) {
        console.error('‚ùå Error importando precios:', error);
        alert(`Error importando precios: ${error.message}`);
      }
    }

    // Parse CSV file
    function parseCSV(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const text = e.target.result;
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

            const data = [];
            for (let i = 1; i < lines.length; i++) {
              const line = lines[i].trim();
              if (!line) continue;

              const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
              const row = {};
              headers.forEach((header, index) => {
                row[header] = values[index] || '';
              });
              data.push(row);
            }
            resolve(data);
          } catch (error) {
            reject(new Error('Error parsing CSV: ' + error.message));
          }
        };
        reader.onerror = () => reject(new Error('Error reading file'));
        reader.readAsText(file, 'UTF-8');
      });
    }

    // Parse Excel file using SheetJS
    function parseExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            // Check if XLSX library is loaded
            if (typeof XLSX === 'undefined') {
              throw new Error('SheetJS library not loaded. Please refresh the page and try again.');
            }

            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            // Get first worksheet
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            // Convert to JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {
              header: 1, // Use first row as header
              defval: '' // Default value for empty cells
            });

            if (jsonData.length < 2) {
              throw new Error('El archivo Excel debe tener al menos una fila de encabezados y una fila de datos');
            }

            // Convert to same format as CSV parser
            const headers = jsonData[0].map(h => String(h).trim());
            const processedData = [];

            for (let i = 1; i < jsonData.length; i++) {
              const row = jsonData[i];
              const rowObj = {};

              headers.forEach((header, index) => {
                rowObj[header] = row[index] ? String(row[index]).trim() : '';
              });

              // Skip empty rows
              const hasData = Object.values(rowObj).some(value => value && value.trim());
              if (hasData) {
                processedData.push(rowObj);
              }
            }

            console.log(`üìä Excel procesado: ${processedData.length} filas, Columnas: ${headers.join(', ')}`);
            resolve(processedData);

          } catch (error) {
            reject(new Error('Error parsing Excel file: ' + error.message));
          }
        };

        reader.onerror = () => reject(new Error('Error reading Excel file'));
        reader.readAsArrayBuffer(file);
      });
    }

    // Validate and process price data
    function validateAndProcessPriceData(data) {
      const processedPrices = [];

      for (const row of data) {
        // Look for common column names (case insensitive)
        const articulo = findColumnValue(row, ['articulo', 'codigo', 'item', 'article', 'code']);
        const description = findColumnValue(row, ['descripcion', 'description', 'detalle', 'nombre', 'name']);
        const precio1 = parseFloat(findColumnValue(row, ['precio1', 'precio_1', 'price1', 'price_1']) || 0);
        const precio2 = parseFloat(findColumnValue(row, ['precio2', 'precio_2', 'price2', 'price_2']) || 0);
        const precio3 = parseFloat(findColumnValue(row, ['precio3', 'precio_3', 'price3', 'price_3']) || 0);
        const precio4 = parseFloat(findColumnValue(row, ['precio4', 'precio_4', 'price4', 'price_4']) || 0);

        if (articulo && articulo.trim()) {
          processedPrices.push({
            articulo: articulo.trim(),
            description: description ? description.trim() : '',
            precio1,
            precio2,
            precio3,
            precio4
          });
        }
      }

      return processedPrices;
    }

    // Helper function to find column value by different possible names
    function findColumnValue(row, possibleNames) {
      for (const name of possibleNames) {
        for (const key in row) {
          if (key.toLowerCase().includes(name.toLowerCase())) {
            return row[key];
          }
        }
      }
      return null;
    }

    // Import price data to Firebase
    async function importPriceData(pricesData) {
      if (!window.firebase || !firebase.firestoreHelpers) {
        throw new Error('Firebase not available');
      }

      const { collection, doc, setDoc, addDoc, getDocs, query, where } = firebase.firestoreHelpers;
      const db = firebase.firestore();
      const pricesCollection = collection(db, 'precios');

      let importedCount = 0;
      let updatedCount = 0;

      for (const priceData of pricesData) {
        try {
          // Check if price record already exists
          const q = query(pricesCollection, where('articulo', '==', priceData.articulo));
          const existingDocs = await getDocs(q);

          const dataToSave = {
            articulo: priceData.articulo,
            description: priceData.description,
            precio1: priceData.precio1 || 0,
            precio2: priceData.precio2 || 0,
            precio3: priceData.precio3 || 0,
            precio4: priceData.precio4 || 0,
            updatedAt: new Date()
          };

          if (existingDocs.empty) {
            // Create new price record
            await addDoc(pricesCollection, {
              ...dataToSave,
              createdAt: new Date()
            });
            importedCount++;
            console.log(`‚úÖ Created price for: ${priceData.articulo}`);
          } else {
            // Update existing price record
            const existingDoc = existingDocs.docs[0];
            const priceRef = doc(db, 'precios', existingDoc.id);
            await updateDoc(priceRef, dataToSave);
            updatedCount++;
            console.log(`‚úÖ Updated price for: ${priceData.articulo}`);
          }
        } catch (error) {
          console.warn('Error importing price for', priceData.articulo, error);
        }
      }

      console.log(`‚úÖ Importaci√≥n completada: ${importedCount} nuevos, ${updatedCount} actualizados`);
    }

    // Export prices to CSV
    function exportPricesToCSV() {
      try {
        if (!window.products || window.products.length === 0) {
          alert('No hay productos cargados para exportar');
          return;
        }

        // Prepare CSV data
        const headers = ['Articulo', 'Descripcion', 'Precio1', 'Precio2', 'Precio3', 'Precio4'];
        const csvData = [headers];

        // Add product data
        window.products.forEach(product => {
          csvData.push([
            product.articulo || '',
            product.description || '',
            product.precio1 || 0,
            product.precio2 || 0,
            product.precio3 || 0,
            product.precio4 || 0
          ]);
        });

        // Convert to CSV string
        const csvContent = csvData.map(row =>
          row.map(field => `"${String(field).replace(/"/g, '""')}"`)
             .join(',')
        ).join('\n');

        // Create and download file
        const fileName = `precios_${getCurrentDateString()}.csv`;
        downloadFile(csvContent, fileName, 'text/csv;charset=utf-8;');

        console.log(`‚úÖ CSV exportado: ${window.products.length} productos`);
        alert(`CSV exportado exitosamente: ${window.products.length} productos`);

      } catch (error) {
        console.error('‚ùå Error exportando CSV:', error);
        alert('Error exportando CSV: ' + error.message);
      }
    }

    // Export prices to Excel
    function exportPricesToExcel() {
      try {
        if (!window.products || window.products.length === 0) {
          alert('No hay productos cargados para exportar');
          return;
        }

        // Check if XLSX library is loaded
        if (typeof XLSX === 'undefined') {
          alert('SheetJS library not loaded. Please refresh the page and try again.');
          return;
        }

        // Prepare Excel data
        const headers = ['Articulo', 'Descripcion', 'Precio1', 'Precio2', 'Precio3', 'Precio4'];
        const excelData = [headers];

        // Add product data
        window.products.forEach(product => {
          excelData.push([
            product.articulo || '',
            product.description || '',
            product.precio1 || 0,
            product.precio2 || 0,
            product.precio3 || 0,
            product.precio4 || 0
          ]);
        });

        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);

        // Set column widths
        ws['!cols'] = [
          { width: 15 }, // Articulo
          { width: 40 }, // Descripcion
          { width: 12 }, // Precio1
          { width: 12 }, // Precio2
          { width: 12 }, // Precio3
          { width: 12 }  // Precio4
        ];

        // Format header row
        const headerStyle = {
          font: { bold: true, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "4CAF50" } },
          alignment: { horizontal: "center", vertical: "center" }
        };

        // Apply header style
        for (let col = 0; col < headers.length; col++) {
          const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
          if (!ws[cellRef]) ws[cellRef] = { t: 's', v: '' };
          ws[cellRef].s = headerStyle;
        }

        // Format price columns as currency
        for (let row = 1; row <= window.products.length; row++) {
          for (let col = 2; col < 6; col++) { // Columns C to F (Precio1-4)
            const cellRef = XLSX.utils.encode_cell({ r: row, c: col });
            if (ws[cellRef]) {
              ws[cellRef].z = '#,##0.00';
              ws[cellRef].t = 'n';
            }
          }
        }

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Precios');

        // Generate and download file
        const fileName = `precios_${getCurrentDateString()}.xlsx`;
        XLSX.writeFile(wb, fileName);

        console.log(`‚úÖ Excel exportado: ${window.products.length} productos`);
        alert(`Excel exportado exitosamente: ${window.products.length} productos`);

      } catch (error) {
        console.error('‚ùå Error exportando Excel:', error);
        alert('Error exportando Excel: ' + error.message);
      }
    }

    // Helper function to get current date string
    function getCurrentDateString() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      return `${year}${month}${day}_${hours}${minutes}`;
    }

    // Helper function to download file
    function downloadFile(content, fileName, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    // Expose functions globally
    window.loadProducts = loadProducts;
    window.saveAllPrices = saveAllPrices;
    window.importPrices = importPrices;
    window.processPriceFile = processPriceFile;
    window.exportPricesToCSV = exportPricesToCSV;
    window.exportPricesToExcel = exportPricesToExcel;

    // === ORDER MANAGEMENT FUNCTIONS ===

    // Order status options - Sincronizado con SEGUIMIENTO
    const ORDER_STATUS_OPTIONS = [
      { value: 'borrador', label: 'BORRADOR', class: 'status-borrador' },
      { value: 'revision', label: 'EN REVISI√ìN', class: 'status-revision' },
      { value: 'aprobada', label: 'APROBADA', class: 'status-aprobada' },
      { value: 'preparacion', label: 'EN PREPARACI√ìN', class: 'status-preparacion' },
      { value: 'listo', label: 'LISTO PARA RETIRO/DESPACHO', class: 'status-listo' },
      { value: 'despachada', label: 'DESPACHADA', class: 'status-despachada' },
      { value: 'entregada', label: 'ENTREGADA', class: 'status-entregada' },
      { value: 'cerrada', label: 'CERRADA', class: 'status-cerrada' },
      { value: 'cancelada', label: 'CANCELADA', class: 'status-cancelada' }
    ];

    // Load orders from Firebase
    async function loadOrders() {
      try {
        console.log('üîÑ [MASTER] loadOrders() called');

        if (!window.firebase || !firebase.firestoreHelpers) {
          console.log('‚ö†Ô∏è Firebase not ready for orders, waiting...');
          setTimeout(loadOrders, 1000);
          return;
        }

        const { collection, getDocs, orderBy, query, updateDoc, doc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        console.log('üìã [MASTER] Cargando √≥rdenes desde colecci√≥n "pedidos"...');

        const pedidosCollection = collection(db, 'pedidos');
        const q = query(pedidosCollection, orderBy('timestamp', 'desc'));
        const querySnapshot = await getDocs(q);

        console.log(`üì¶ [MASTER] Query ejecutada, documentos encontrados: ${querySnapshot.size}`);

        window.orders = [];
        const updatePromises = [];

        querySnapshot.forEach((docSnapshot) => {
          const data = docSnapshot.data();
          console.log(`üìÑ [MASTER] Procesando orden ${docSnapshot.id}:`, {
            logisticsState: data.logisticsState,
            numeroOrden: data.numeroOrden,
            total: data.total
          });

          // Check if logisticsState exists, if not, set it to 'borrador'
          if (!data.logisticsState) {
            console.log(`üîÑ Setting logisticsState to 'borrador' for order ${docSnapshot.id}`);
            const orderRef = doc(db, 'pedidos', docSnapshot.id);
            updatePromises.push(updateDoc(orderRef, { logisticsState: 'borrador' }));
          }

          window.orders.push({
            id: docSnapshot.id,
            ...data,
            logisticsState: data.logisticsState || 'borrador', // Default state
            // Convert timestamp to date string
            fechaLocal: data.fechaLocal || (data.timestamp && data.timestamp.toDate ?
              data.timestamp.toDate().toLocaleDateString('es-AR') : 'No date'),
            fecha: data.fecha && data.fecha.toDate ? data.fecha.toDate().toISOString().split('T')[0] :
                   data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().toISOString().split('T')[0] :
                   (data.fecha || new Date().toISOString().split('T')[0]),
            modified: false
          });
        });

        // Update orders that don't have logisticsState
        if (updatePromises.length > 0) {
          await Promise.all(updatePromises);
          console.log(`‚úÖ Updated ${updatePromises.length} orders with logisticsState`);
        }

        console.log('‚úÖ [MASTER] √ìrdenes cargadas desde pedidos:', window.orders.length);
        console.log('üìä [MASTER] Desglose por estado:', {
          borrador: window.orders.filter(o => o.logisticsState === 'borrador').length,
          revision: window.orders.filter(o => o.logisticsState === 'revision').length,
          aprobada: window.orders.filter(o => o.logisticsState === 'aprobada').length,
          preparacion: window.orders.filter(o => o.logisticsState === 'preparacion').length,
          listo: window.orders.filter(o => o.logisticsState === 'listo').length,
          despachada: window.orders.filter(o => o.logisticsState === 'despachada').length,
          entregada: window.orders.filter(o => o.logisticsState === 'entregada').length,
          cerrada: window.orders.filter(o => o.logisticsState === 'cerrada').length,
          cancelada: window.orders.filter(o => o.logisticsState === 'cancelada').length
        });

        console.log('üé® [MASTER] Llamando a displayOrders()...');
        displayOrders();

        console.log('üìä [MASTER] Llamando a updateOrderStats()...');
        updateOrderStats();

      } catch (error) {
        console.error('‚ùå [MASTER] Error cargando √≥rdenes:', error);
        const borradorContainer = document.getElementById('admin-borradorOrders');
        if (borradorContainer) {
          borradorContainer.innerHTML = `
            <div class="no-orders">
              Error cargando √≥rdenes: ${error.message}
            </div>
          `;
        }
      }
    }

    // Display orders in their respective sections (same as SEGUIMIENTO)
    function displayOrders(searchTerm = '') {
      console.log('üé® [MASTER] displayOrders() called with', window.orders?.length || 0, 'orders', searchTerm ? `(searching: "${searchTerm}")` : '');

      const containers = {
        borrador: document.getElementById('admin-borradorOrders'),
        revision: document.getElementById('admin-revisionOrders'),
        aprobada: document.getElementById('admin-aprobadaOrders'),
        preparacion: document.getElementById('admin-preparacionOrders'),
        listo: document.getElementById('admin-listoOrders'),
        despachada: document.getElementById('admin-despachadaOrders'),
        entregada: document.getElementById('admin-entregadaOrders'),
        cerrada: document.getElementById('admin-cerradaOrders'),
        cancelada: document.getElementById('admin-canceladaOrders')
      };

      // Check if all containers exist
      const missingContainers = Object.entries(containers).filter(([key, val]) => !val).map(([key]) => key);
      if (missingContainers.length > 0) {
        console.error('‚ùå [MASTER] Admin MASTER containers not found:', missingContainers);
        return;
      }

      console.log('‚úÖ [MASTER] Todos los contenedores encontrados');

      // Define state flow: bidirectional movement with prev and next
      const stateFlow = {
        borrador: { next: 'revision', prev: null },
        revision: { next: 'aprobada', prev: 'borrador' },
        aprobada: { next: 'preparacion', prev: 'revision' },
        preparacion: { next: 'listo', prev: 'aprobada' },
        listo: { next: 'despachada', prev: 'preparacion' },
        despachada: { next: 'entregada', prev: 'listo' },
        entregada: { next: 'cerrada', prev: 'despachada' },
        cerrada: { next: null, prev: 'entregada' },
        cancelada: { next: null, prev: null }
      };

      // Filter orders by search term if provided
      let filteredOrders = window.orders;
      if (searchTerm && searchTerm.trim()) {
        const search = searchTerm.trim().toLowerCase();
        filteredOrders = window.orders.filter(order => {
          // Search by order number
          const orderNumber = String(order.numeroOrden || '').toLowerCase();
          if (orderNumber.includes(search)) return true;

          // Search by client name
          const clientName = String(order.clienteNombre || '').toLowerCase();
          if (clientName.includes(search)) return true;

          // Search by client email (could contain client number)
          const clientEmail = String(order.clienteEmail || '').toLowerCase();
          if (clientEmail.includes(search)) return true;

          // Search by user email
          const userEmail = String(order.usuarioEmail || '').toLowerCase();
          if (userEmail.includes(search)) return true;

          // Search by client code (assuming it's in clienteData)
          const clientCode = String(order.clienteData?.codigo || order.codigo || '').toLowerCase();
          if (clientCode.includes(search)) return true;

          return false;
        });

        // Update search results count
        const searchResultsCount = document.getElementById('searchResultsCount');
        if (searchResultsCount) {
          searchResultsCount.style.display = 'block';
          searchResultsCount.textContent = `üìä Mostrando ${filteredOrders.length} de ${window.orders.length} √≥rdenes`;
        }

        // Show clear button
        const clearBtn = document.getElementById('clearSearchBtn');
        if (clearBtn) clearBtn.style.display = 'flex';
      } else {
        // Hide search results count and clear button
        const searchResultsCount = document.getElementById('searchResultsCount');
        if (searchResultsCount) searchResultsCount.style.display = 'none';

        const clearBtn = document.getElementById('clearSearchBtn');
        if (clearBtn) clearBtn.style.display = 'none';
      }

      // Separate orders by state
      const ordersByState = {
        borrador: filteredOrders.filter(order => order.logisticsState === 'borrador'),
        revision: filteredOrders.filter(order => order.logisticsState === 'revision'),
        aprobada: filteredOrders.filter(order => order.logisticsState === 'aprobada'),
        preparacion: filteredOrders.filter(order => order.logisticsState === 'preparacion'),
        listo: filteredOrders.filter(order => order.logisticsState === 'listo'),
        despachada: filteredOrders.filter(order => order.logisticsState === 'despachada'),
        entregada: filteredOrders.filter(order => order.logisticsState === 'entregada'),
        cerrada: filteredOrders.filter(order => order.logisticsState === 'cerrada'),
        cancelada: filteredOrders.filter(order => order.logisticsState === 'cancelada')
      };

      console.log('üìä [MASTER] √ìrdenes por estado:', {
        borrador: ordersByState.borrador.length,
        revision: ordersByState.revision.length,
        aprobada: ordersByState.aprobada.length,
        preparacion: ordersByState.preparacion.length,
        listo: ordersByState.listo.length,
        despachada: ordersByState.despachada.length,
        entregada: ordersByState.entregada.length,
        cerrada: ordersByState.cerrada.length,
        cancelada: ordersByState.cancelada.length
      });

      // Display orders in each section
      Object.entries(ordersByState).forEach(([state, stateOrders]) => {
        const container = containers[state];
        const currentFlow = stateFlow[state];

        console.log(`üé® [MASTER] Renderizando ${stateOrders.length} √≥rdenes para estado "${state}"`);

        if (stateOrders.length > 0) {
          const html = stateOrders.map(order => createAdminOrderHTML(order, currentFlow, state)).join('');
          console.log(`üìù [MASTER] HTML generado para ${state}:`, html.substring(0, 100) + '...');
          container.innerHTML = html;
        } else {
          const messages = {
            borrador: 'No hay pedidos en borrador',
            revision: 'No hay pedidos en revisi√≥n',
            aprobada: 'No hay pedidos aprobados',
            preparacion: 'No hay pedidos en preparaci√≥n',
            listo: 'No hay pedidos listos',
            despachada: 'No hay pedidos despachados',
            entregada: 'No hay pedidos entregados',
            cerrada: 'No hay pedidos cerrados',
            cancelada: 'No hay pedidos cancelados'
          };
          container.innerHTML = `<p class="no-orders">${messages[state]}</p>`;
        }
      });

      console.log('‚úÖ [MASTER] displayOrders() completado');
    }

    // Create HTML for an order item (admin version with edit capabilities)
    function createAdminOrderHTML(order, currentFlow, currentState) {
      const canEdit = isUserAdmin;
      const hasNext = currentFlow && currentFlow.next !== null;
      const hasPrev = currentFlow && currentFlow.prev !== null;
      let buttonHtml = '';

      const stateLabels = {
        borrador: 'Borrador',
        revision: 'En Revisi√≥n',
        aprobada: 'Aprobada',
        preparacion: 'En Preparaci√≥n',
        listo: 'Listo para Retiro/Despacho',
        despachada: 'Despachada',
        entregada: 'Entregada',
        cerrada: 'Cerrada',
        cancelada: 'Cancelada'
      };

      // Admin can move orders and has additional controls
      if (canEdit) {
        // Flecha hacia arriba (volver al estado anterior) - solo permitido en estado "revision"
        if (hasPrev && currentState === 'revision') {
          const prevStateLabel = stateLabels[currentFlow.prev] || currentFlow.prev;
          buttonHtml += `<button class="move-order-btn-up" onclick="adminMoveOrder('${order.id}', '${currentFlow.prev}')" title="Volver a ${prevStateLabel}">‚Üë</button>`;
        }

        // Flecha hacia abajo (avanzar al siguiente estado)
        if (hasNext) {
          const nextStateLabel = stateLabels[currentFlow.next] || currentFlow.next;
          buttonHtml += `
            <button class="move-order-btn" onclick="adminMoveOrder('${order.id}', '${currentFlow.next}')" title="Mover a ${nextStateLabel}">
              ‚Üì ${nextStateLabel}
            </button>
          `;
        }

        // Add cancel button for non-cancelled orders
        if (currentState !== 'cancelada' && currentState !== 'cerrada') {
          buttonHtml += `
            <button class="cancel-order-btn" onclick="adminMoveOrder('${order.id}', 'cancelada')" title="Cancelar pedido">
              ‚ùå Cancelar
            </button>
          `;
        }
      }

      // Final states display
      if (!hasNext && !hasPrev) {
        // Final states (cerrada, cancelada)
        if (currentState === 'entregada') {
          buttonHtml = `<span class="delivered-status">‚úì Entregada</span>`;
        } else if (currentState === 'cerrada') {
          buttonHtml = `<span class="closed-status">üîí Cerrada</span>`;
        } else if (currentState === 'cancelada') {
          buttonHtml = `<span class="cancelled-status">‚ùå Cancelada</span>`;
        }
      }

      // Add edit button for admin
      if (canEdit) {
        buttonHtml += `
          <button class="edit-order-btn" onclick="adminEditOrder('${order.id}')" title="Editar orden">
            ‚úèÔ∏è Editar
          </button>
        `;
      }

      return `
        <div class="order-item" data-order-id="${order.id}">
          <div class="order-info">
            <div class="order-number">#${order.numeroOrden || order.id.slice(-6)}</div>
            <div class="order-details">
              ${order.fechaLocal || order.fecha || 'No date'} ‚Ä¢ ${order.cantidadItems || order.items?.length || 0} items ‚Ä¢ $${formatNumber(order.total || order.montoTotal || 0)}
              ${order.cliente ? '<br>' + order.cliente : ''}
            </div>
          </div>
          <div class="order-actions">
            ${buttonHtml}
          </div>
        </div>
      `;
    }

    // Helper function to format numbers
    function formatNumber(num) {
      return Number(num).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Generar PDF de la orden
    async function generateOrderPDF(orderData, orderNumber, clienteNombre) {
      try {
        console.log('üìÑ [PDF] Generando PDF para orden #', orderNumber);

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Colores
        const primaryColor = [76, 175, 80]; // Verde
        const textColor = [51, 51, 51]; // Gris oscuro
        const lightGray = [240, 240, 240];

        // Header con fondo verde
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 40, 'F');

        // Logo (cargar desde la URL del sitio)
        try {
          const logoUrl = window.location.origin + '/logo.png';
          doc.addImage(logoUrl, 'PNG', 14, 12, 15, 12.5);
        } catch (error) {
          console.warn('‚ö†Ô∏è No se pudo cargar el logo:', error);
        }

        // T√≠tulo
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont(undefined, 'bold');
        doc.text('ORDEN DE COMPRA', 105, 18, { align: 'center' });

        doc.setFontSize(18);
        doc.text(`#${orderNumber}`, 105, 28, { align: 'center' });

        // Informaci√≥n del cliente
        let yPos = 50;
        doc.setTextColor(...textColor);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('INFORMACI√ìN DEL CLIENTE', 14, yPos);

        yPos += 8;
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        // Formato: Cliente NOMBRE, CODIGO XXX
        const clienteTexto = orderData.clienteCodigo ? `${clienteNombre}, CODIGO ${orderData.clienteCodigo}` : clienteNombre;
        doc.text(`Cliente: ${clienteTexto}`, 14, yPos);
        yPos += 6;
        // Mostrar email del usuario que hizo la orden
        const emailUsuario = orderData.creadoPorAdmin ? orderData.usuarioEmail : (orderData.clienteEmail || orderData.usuarioEmail);
        doc.text(`Email: ${emailUsuario}`, 14, yPos);
        yPos += 6;
        doc.text(`Fecha: ${orderData.fechaLocal || orderData.fechaEdicionLocal || new Date().toLocaleString('es-AR')}`, 14, yPos);

        if (orderData.creadoPorAdmin) {
          yPos += 6;
          doc.setTextColor(255, 152, 0); // Naranja
          doc.text(`Creada por: ${orderData.usuarioEmail} (Admin)`, 14, yPos);
          doc.setTextColor(...textColor);
        }

        if (orderData.editadaPorNombre) {
          yPos += 6;
          doc.setTextColor(255, 152, 0); // Naranja
          doc.text(`Modificada por: ${orderData.editadaPorNombre}`, 14, yPos);
          doc.setTextColor(...textColor);
        }

        // Tabla de productos
        yPos += 12;

        const tableData = orderData.items.map((item, index) => [
          index + 1,
          item.articulo || '',
          item.description || '',
          item.quantity,
          '$' + formatNumber(item.price),
          '$' + formatNumber(item.quantity * item.price)
        ]);

        doc.autoTable({
          startY: yPos,
          head: [['#', 'C√≥digo', 'Descripci√≥n', 'Cant.', 'Precio Unit.', 'Subtotal']],
          body: tableData,
          theme: 'grid',
          headStyles: {
            fillColor: primaryColor,
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            halign: 'center'
          },
          columnStyles: {
            0: { halign: 'center', cellWidth: 10 },
            1: { halign: 'left', cellWidth: 25 },
            2: { halign: 'left', cellWidth: 80 },
            3: { halign: 'center', cellWidth: 20 },
            4: { halign: 'right', cellWidth: 30 },
            5: { halign: 'right', cellWidth: 30 }
          },
          styles: {
            fontSize: 9,
            cellPadding: 3
          }
        });

        // Total
        const finalY = doc.lastAutoTable.finalY || yPos;
        yPos = finalY + 10;

        doc.setFillColor(...lightGray);
        doc.rect(125, yPos - 5, 71, 12, 'F');

        doc.setFont(undefined, 'bold');
        doc.setFontSize(14);
        doc.setTextColor(...textColor);
        doc.text('TOTAL:', 130, yPos + 2);
        doc.setFontSize(16);
        doc.setTextColor(...primaryColor);
        doc.text('$' + formatNumber(orderData.total), 191, yPos + 2, { align: 'right' });

        // Footer
        doc.setTextColor(150, 150, 150);
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        doc.text('Generado autom√°ticamente por el sistema', 105, 285, { align: 'center' });
        doc.text(new Date().toLocaleString('es-AR'), 105, 290, { align: 'center' });

        console.log('‚úÖ [PDF] PDF generado exitosamente');
        return doc;

      } catch (error) {
        console.error('‚ùå [PDF] Error generando PDF:', error);
        throw error;
      }
    }

    // Subir PDF a Firebase Storage y obtener URL
    async function uploadOrderPDF(pdfDoc, orderNumber) {
      try {
        // Detectar si estamos en localhost
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        if (isLocalhost) {
          console.log('‚ö†Ô∏è [Storage] Detectado localhost - Descargando PDF localmente (CORS bloqueado)');

          // Descargar PDF directamente
          pdfDoc.save(`orden-${orderNumber}.pdf`);

          // Retornar URL placeholder
          return `[PDF descargado localmente - orden-${orderNumber}.pdf]`;
        }

        console.log('‚òÅÔ∏è [Storage] Subiendo PDF a Firebase Storage...');

        const { ref, uploadBytes, getDownloadURL } = window.firebase.storageHelpers;
        const storage = window.firebase.storage();

        // Convertir PDF a blob
        const pdfBlob = pdfDoc.output('blob');

        // Crear referencia en Storage
        const fileName = `orders/orden-${orderNumber}-${Date.now()}.pdf`;
        const storageRef = ref(storage, fileName);

        // Subir archivo
        const snapshot = await uploadBytes(storageRef, pdfBlob, {
          contentType: 'application/pdf'
        });

        console.log('‚úÖ [Storage] PDF subido exitosamente');

        // Obtener URL de descarga
        const downloadURL = await getDownloadURL(snapshot.ref);
        console.log('‚úÖ [Storage] URL de descarga obtenida:', downloadURL);

        return downloadURL;

      } catch (error) {
        console.error('‚ùå [Storage] Error subiendo PDF:', error);
        throw error;
      }
    }

    // Enviar orden al vendedor por WhatsApp
    async function sendOrderToSellerWhatsApp(orderData, orderNumber, clienteNombre) {
      try {
        console.log('üì± [WhatsApp] Iniciando env√≠o...');
        console.log('üì± [WhatsApp] orderData.vendedorId:', orderData.vendedorId);
        console.log('üì± [WhatsApp] orderNumber:', orderNumber);
        console.log('üì± [WhatsApp] clienteNombre:', clienteNombre);

        const { doc, getDoc, collection, query, where, getDocs } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();

        let vendedorData = null;
        let vendedorId = orderData.vendedorId;

        // Si no hay vendedor asignado, buscar a Santiago como vendedor por defecto
        if (!vendedorId) {
          console.log('‚ö†Ô∏è [WhatsApp] No hay vendedor asignado, buscando a Santiago Fernandez...');
          const vendedoresRef = collection(db, 'vendedores');
          const q = query(vendedoresRef, where('email', '==', 'santifn.axp@gmail.com'));
          const querySnapshot = await getDocs(q);

          if (!querySnapshot.empty) {
            const santiagoDoc = querySnapshot.docs[0];
            vendedorId = santiagoDoc.id;
            vendedorData = santiagoDoc.data();
            console.log('‚úÖ [WhatsApp] Santiago Fernandez encontrado como vendedor por defecto:', vendedorId);
          } else {
            console.log('‚ùå [WhatsApp] No se encontr√≥ a Santiago Fernandez (santifn.axp@gmail.com) en la BD');
            return;
          }
        } else {
          console.log('üì± [WhatsApp] Buscando vendedor:', vendedorId);
          const vendedorRef = doc(db, 'vendedores', vendedorId);
          const vendedorDoc = await getDoc(vendedorRef);

          if (!vendedorDoc.exists()) {
            console.log('‚ö†Ô∏è [WhatsApp] Vendedor no encontrado en BD');
            return;
          }

          vendedorData = vendedorDoc.data();
        }

        console.log('üì± [WhatsApp] Vendedor encontrado:', vendedorData.name);
        console.log('üì± [WhatsApp] Tel√©fonos:', { phone: vendedorData.phone, phone2: vendedorData.phone2 });

        // Obtener ambos tel√©fonos del vendedor
        const phones = [];
        if (vendedorData.phone || vendedorData.telefono) {
          phones.push((vendedorData.phone || vendedorData.telefono).replace(/\D/g, ''));
        }
        if (vendedorData.phone2) {
          phones.push(vendedorData.phone2.replace(/\D/g, ''));
        }

        console.log('üì± [WhatsApp] Tel√©fonos procesados:', phones);

        if (phones.length === 0) {
          console.log('‚ö†Ô∏è [WhatsApp] Vendedor sin tel√©fono v√°lido');
          return;
        }

        // Generar PDF
        console.log('üìÑ [WhatsApp] Generando PDF de la orden...');
        const pdfDoc = await generateOrderPDF(orderData, orderNumber, clienteNombre);

        // Subir PDF a Firebase Storage
        console.log('‚òÅÔ∏è [WhatsApp] Subiendo PDF a Firebase Storage...');
        const pdfUrl = await uploadOrderPDF(pdfDoc, orderNumber);

        // Detectar si estamos en localhost
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // Construir mensaje con enlace al PDF
        let mensaje = `üîÑ *ORDEN MODIFICADA #${orderNumber}*\n\n`;

        if (isLocalhost) {
          mensaje += `‚ö†Ô∏è *MODO DESARROLLO (localhost)*\n`;
          mensaje += `üìã PDF descargado localmente: ${pdfUrl}\n`;
          mensaje += `‚ÑπÔ∏è En producci√≥n se enviar√° el enlace al PDF\n\n`;
        } else {
          mensaje += `üìã *Ver detalle completo en PDF:*\n`;
          mensaje += `${pdfUrl}\n\n`;
        }
        // Formato: Cliente NOMBRE, CODIGO XXX, EMAIL: usuario@email.com
        const clienteTexto = orderData.clienteCodigo ? `${clienteNombre}, CODIGO ${orderData.clienteCodigo}` : clienteNombre;
        const emailUsuario = orderData.creadoPorAdmin ? orderData.usuarioEmail : (orderData.clienteEmail || orderData.usuarioEmail);
        mensaje += `üë§ *Cliente:* ${clienteTexto}\n`;
        mensaje += `üìß *Email:* ${emailUsuario}\n`;
        if (orderData.editadaPorNombre) {
          mensaje += `‚úèÔ∏è *Modificada por:* ${orderData.editadaPorNombre}\n`;
        }
        mensaje += `üìÖ *Fecha:* ${orderData.fechaLocal || new Date().toLocaleString('es-AR')}\n\n`;
        mensaje += `üì¶ *Productos:* ${orderData.cantidadItems || orderData.items?.length || 0} items\n`;
        mensaje += `üí∞ *TOTAL: $${formatNumber(orderData.total)}*\n\n`;
        mensaje += `‚úÖ Descarg√° el PDF para ver el detalle completo`;

        // Enviar WhatsApp a todos los tel√©fonos del vendedor
        console.log('üì± [WhatsApp] Preparando para enviar a', phones.length, 'tel√©fono(s)');

        phones.forEach((phone, index) => {
          const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(mensaje)}`;
          console.log(`üì± [WhatsApp] URL ${index + 1}:`, whatsappUrl.substring(0, 100) + '...');

          // Peque√±o delay entre aperturas para evitar que se bloqueen
          setTimeout(() => {
            console.log(`üì± [WhatsApp] Abriendo ventana ${index + 1}/${phones.length} para ${phone}`);
            window.open(whatsappUrl, '_blank');
            console.log(`‚úÖ [WhatsApp] Ventana ${index + 1}/${phones.length} abierta para ${phone}`);
          }, index * 500);
        });

        console.log(`‚úÖ [WhatsApp] Proceso completado - ${phones.length} tel√©fono(s)`);

      } catch (error) {
        console.error('‚ùå Error enviando WhatsApp:', error);
      }
    }

    // Admin move order to next state
    async function adminMoveOrder(orderId, nextState) {
      if (!isUserAdmin) {
        alert('‚ö†Ô∏è No tienes permisos para cambiar el estado de las √≥rdenes');
        return;
      }

      if (!firebase || !firebase.firestore) {
        console.error('‚ùå Firebase not available');
        return;
      }

      try {
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', orderId);
        await updateDoc(orderRef, {
          logisticsState: nextState,
          lastStateUpdate: new Date()
        });

        console.log(`‚úÖ Order ${orderId} moved to ${nextState}`);

        // Reload orders to reflect changes
        await loadOrders();

      } catch (error) {
        console.error('‚ùå Error moving order:', error);
        alert('Error al cambiar el estado de la orden');
      }
    }

    // Show admin order details in modal with editable quantities
    async function adminEditOrder(orderId) {
      if (!isUserAdmin) {
        alert('‚ö†Ô∏è No tienes permisos para editar √≥rdenes');
        return;
      }

      try {
        console.log('üìã Mostrando detalles de orden:', orderId);

        const { doc, getDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const orderRef = doc(db, 'pedidos', orderId);
        const orderDoc = await getDoc(orderRef);

        if (!orderDoc.exists()) {
          alert('‚ùå Orden no encontrada');
          return;
        }

        const order = { id: orderDoc.id, ...orderDoc.data() };

        // Mapeo de estados
        const stateLabels = {
          borrador: 'Borrador',
          revision: 'En Revisi√≥n',
          aprobada: 'Aprobada',
          preparacion: 'En Preparaci√≥n',
          listo: 'Listo para Retiro/Despacho',
          despachada: 'Despachada',
          entregada: 'Entregada',
          cerrada: 'Cerrada',
          cancelada: 'Cancelada'
        };

        // Llenar informaci√≥n general
        let orderNumberText = `#${order.numeroOrden || order.id.slice(-6)}`;
        if (order.editadaPor && order.editadaPorNombre) {
          orderNumberText += ` <span style="color: #FF9800; font-size: 0.85em;">(editada por ${order.editadaPorNombre})</span>`;
        }
        document.getElementById('detailOrderNumber').innerHTML = orderNumberText;
        // Formato: Cliente NOMBRE, CODIGO XXX, EMAIL: usuario@email.com
        const emailUsuario = order.creadoPorAdmin ? order.usuarioEmail : (order.clienteEmail || order.usuarioEmail);
        const infoCliente = order.clienteNombre || order.usuarioEmail || '-';
        const codigoCliente = order.clienteCodigo ? `, CODIGO ${order.clienteCodigo}` : '';
        document.getElementById('detailClientName').textContent = `${infoCliente}${codigoCliente}`;
        document.getElementById('detailClientEmail').textContent = emailUsuario || '-';
        document.getElementById('detailOrderDate').textContent = order.fechaLocal || '-';
        document.getElementById('detailOrderState').textContent = stateLabels[order.logisticsState] || order.logisticsState || 'Sin estado';

        // Mostrar si fue creada por admin
        if (order.creadoPorAdmin) {
          document.getElementById('detailAdminCreatedContainer').style.display = 'grid';
          document.getElementById('detailAdminCreated').textContent = order.usuarioEmail || '-';
        } else {
          document.getElementById('detailAdminCreatedContainer').style.display = 'none';
        }

        // Llenar tabla de items con campos editables
        const itemsTableBody = document.getElementById('detailOrderItems');
        itemsTableBody.innerHTML = '';

        let hasChanges = false;

        if (order.items && order.items.length > 0) {
          order.items.forEach((item, index) => {
            const row = document.createElement('tr');
            row.setAttribute('data-item-index', index);
            row.innerHTML = `
              <td>${item.articulo || '-'}</td>
              <td>${item.description || '-'}</td>
              <td style="text-align: center;">
                <input type="number"
                       class="editable-quantity"
                       value="${item.quantity || 0}"
                       min="0"
                       data-item-index="${index}"
                       data-price="${item.price || 0}">
              </td>
              <td style="text-align: right;">$${(item.price || 0).toFixed(2)}</td>
              <td class="item-subtotal" style="text-align: right;">$${(item.subtotal || 0).toFixed(2)}</td>
            `;
            itemsTableBody.appendChild(row);
          });

          // Agregar event listeners para actualizar subtotales y detectar cambios
          const quantityInputs = itemsTableBody.querySelectorAll('.editable-quantity');
          quantityInputs.forEach(input => {
            input.addEventListener('change', function() {
              const index = parseInt(this.getAttribute('data-item-index'));
              const price = parseFloat(this.getAttribute('data-price'));
              const quantity = parseInt(this.value) || 0;
              const subtotal = price * quantity;

              // Actualizar el item en el array
              order.items[index].quantity = quantity;
              order.items[index].subtotal = subtotal;

              // Actualizar subtotal en la fila
              const row = this.closest('tr');
              const subtotalCell = row.querySelector('.item-subtotal');
              subtotalCell.textContent = `$${subtotal.toFixed(2)}`;

              // Recalcular total
              const newTotal = order.items.reduce((sum, item) => sum + (item.subtotal || 0), 0);
              order.total = newTotal;
              document.getElementById('detailOrderTotal').textContent = `$${newTotal.toFixed(2)}`;

              // Detectar si hubo cambios
              hasChanges = true;
              const saveContainer = document.getElementById('detailSaveOrderContainer');
              if (saveContainer) {
                saveContainer.style.display = 'block';
              }
            });
          });
        } else {
          itemsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay items</td></tr>';
        }

        // Mostrar total
        document.getElementById('detailOrderTotal').textContent = `$${(order.total || 0).toFixed(2)}`;

        // Configurar bot√≥n Guardar
        const saveOrderContainer = document.getElementById('detailSaveOrderContainer');
        const saveOrderBtn = document.getElementById('detailSaveOrderBtn');

        // Mostrar bot√≥n Guardar siempre (no esperar a que haya cambios)
        if (saveOrderContainer) {
          saveOrderContainer.style.display = 'block';
        }

        // Remover event listeners previos del bot√≥n Guardar
        if (saveOrderBtn) {
          const newSaveBtn = saveOrderBtn.cloneNode(true);
          saveOrderBtn.parentNode.replaceChild(newSaveBtn, saveOrderBtn);

          // Agregar nuevo event listener para Guardar
          newSaveBtn.addEventListener('click', async () => {
            try {
              console.log('üíæ Guardando cambios en la orden...');

              const currentUser = firebase.auth().currentUser;
              if (!currentUser) {
                alert('‚ùå Debes estar autenticado para guardar cambios');
                return;
              }

              // Obtener email y nombre del usuario actual
              const userEmail = currentUser.email;
              let userName = userEmail;

              // Intentar obtener el nombre del vendedor desde Firestore
              try {
                const { doc, getDoc } = firebase.firestoreHelpers;
                const db = firebase.firestore();
                const userRef = doc(db, 'usuarios', currentUser.uid);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                  const userData = userDoc.data();
                  userName = userData.nombre || userData.email || userEmail;
                }
              } catch (e) {
                console.warn('‚ö†Ô∏è No se pudo obtener nombre de usuario:', e);
              }

              // Actualizar orden en Firebase con informaci√≥n de qui√©n edit√≥
              const { doc, updateDoc } = firebase.firestoreHelpers;
              const db = firebase.firestore();
              const orderRef = doc(db, 'pedidos', order.id);

              await updateDoc(orderRef, {
                items: order.items,
                total: order.total,
                editadaPor: currentUser.uid,
                editadaPorEmail: userEmail,
                editadaPorNombre: userName,
                fechaEdicion: new Date().toISOString(),
                fechaEdicionLocal: new Date().toLocaleString('es-AR')
              });

              console.log('‚úÖ Orden guardada exitosamente');

              // Enviar WhatsApp al vendedor (si no hay vendedor, se usa Santiago por defecto)
              console.log('üì± Preparando WhatsApp para vendedor:', order.vendedorId || 'Santiago (por defecto)');
              const updatedOrderData = {
                ...order,
                editadaPorNombre: userName,
                cantidadItems: order.items?.length || 0
              };
              await sendOrderToSellerWhatsApp(updatedOrderData, order.numeroOrden, order.clienteNombre || order.clienteEmail || order.usuarioEmail);

              // Actualizar el n√∫mero de orden con el indicador de edici√≥n
              let orderNumberText = `#${order.numeroOrden || order.id.slice(-6)}`;
              orderNumberText += ` <span style="color: #FF9800; font-size: 0.85em;">(editada por ${userName})</span>`;
              document.getElementById('detailOrderNumber').innerHTML = orderNumberText;

              // Mantener bot√≥n Guardar visible
              hasChanges = false;

              // Recargar √≥rdenes para reflejar cambios
              await loadOrders();

              alert('‚úÖ Cambios guardados exitosamente');
            } catch (error) {
              console.error('‚ùå Error guardando cambios:', error);
              alert('‚ùå Error al guardar cambios. Por favor intenta nuevamente.');
            }
          });
        }

        // Configurar bot√≥n "Seguir Comprando / Editar Orden"
        const editOrderContainer = document.getElementById('detailEditOrderContainer');
        const editOrderBtn = document.getElementById('detailEditOrderBtn');

        // Siempre mostrar el bot√≥n
        editOrderContainer.style.display = 'block';

        // Remover event listeners previos
        const newEditBtn = editOrderBtn.cloneNode(true);
        editOrderBtn.parentNode.replaceChild(newEditBtn, editOrderBtn);

        // Agregar nuevo event listener
        newEditBtn.addEventListener('click', () => {
          // Guardar orden en localStorage y redirigir a marketplace
          const cartItems = order.items.map(item => ({
            item: item.articulo,
            description: item.description,
            price: item.price,
            quantity: item.quantity
          }));
          localStorage.setItem('cart', JSON.stringify(cartItems));
          localStorage.setItem('editingOrderId', order.id);
          console.log('üì¶ Orden guardada en localStorage, redirigiendo a marketplace...');
          window.location.href = 'marketplace.html';
        });

        // Configurar bot√≥n "Enviar WhatsApp" (siempre visible, usa Santiago si no hay vendedor)
        const whatsAppContainer = document.getElementById('detailSendWhatsAppContainer');
        const whatsAppBtn = document.getElementById('detailSendWhatsAppBtn');

        whatsAppContainer.style.display = 'block';

        // Remover event listeners previos
        const newWhatsAppBtn = whatsAppBtn.cloneNode(true);
        whatsAppBtn.parentNode.replaceChild(newWhatsAppBtn, whatsAppBtn);

        // Agregar event listener para enviar WhatsApp
        newWhatsAppBtn.addEventListener('click', async () => {
          console.log('üì± [Manual] Enviando WhatsApp...');
          const orderData = {
            ...order,
            cantidadItems: order.items?.length || 0
          };
          await sendOrderToSellerWhatsApp(orderData, order.numeroOrden, order.clienteNombre || order.clienteEmail || order.usuarioEmail);
        });

        // Mostrar modal
        document.getElementById('orderDetailsModal').style.display = 'block';

      } catch (error) {
        console.error('‚ùå Error mostrando detalles de orden:', error);
        alert('Error al cargar detalles de la orden');
      }
    }

    window.adminMoveOrder = adminMoveOrder;
    window.adminEditOrder = adminEditOrder;

    // Update order statistics
    function updateOrderStats() {
      if (!window.orders) return;

      console.log('üìä [MASTER] Actualizando estad√≠sticas KPI...');

      const totalOrders = window.orders.length;
      const borradorOrders = window.orders.filter(o => o.logisticsState === 'borrador').length;
      const revisionOrders = window.orders.filter(o => o.logisticsState === 'revision').length;
      const aprobadaOrders = window.orders.filter(o => o.logisticsState === 'aprobada').length;
      const preparacionOrders = window.orders.filter(o => o.logisticsState === 'preparacion').length;
      const listoOrders = window.orders.filter(o => o.logisticsState === 'listo').length;
      const despachadaOrders = window.orders.filter(o => o.logisticsState === 'despachada').length;
      const entregadaOrders = window.orders.filter(o => o.logisticsState === 'entregada').length;
      const cerradaOrders = window.orders.filter(o => o.logisticsState === 'cerrada').length;
      const canceladaOrders = window.orders.filter(o => o.logisticsState === 'cancelada').length;

      console.log('üìä [MASTER] KPI:', {
        total: totalOrders,
        borrador: borradorOrders,
        revision: revisionOrders,
        aprobada: aprobadaOrders,
        preparacion: preparacionOrders,
        listo: listoOrders,
        despachada: despachadaOrders,
        entregada: entregadaOrders,
        cerrada: cerradaOrders,
        cancelada: canceladaOrders
      });

      // Actualizar los elementos del DOM
      const totalEl = document.getElementById('totalOrders');
      const borradorEl = document.getElementById('borradorOrders');
      const revisionEl = document.getElementById('revisionOrders');
      const aprobadaEl = document.getElementById('aprobadaOrders');
      const preparacionEl = document.getElementById('preparacionOrders');
      const listoEl = document.getElementById('listoOrders');
      const despachadaEl = document.getElementById('despachadaOrders');
      const entregadaEl = document.getElementById('entregadaOrders');
      const cerradaEl = document.getElementById('cerradaOrders');
      const canceladaEl = document.getElementById('canceladaOrders');

      if (totalEl) totalEl.textContent = totalOrders;
      if (borradorEl) borradorEl.textContent = borradorOrders;
      if (revisionEl) revisionEl.textContent = revisionOrders;
      if (aprobadaEl) aprobadaEl.textContent = aprobadaOrders;
      if (preparacionEl) preparacionEl.textContent = preparacionOrders;
      if (listoEl) listoEl.textContent = listoOrders;
      if (despachadaEl) despachadaEl.textContent = despachadaOrders;
      if (entregadaEl) entregadaEl.textContent = entregadaOrders;
      if (cerradaEl) cerradaEl.textContent = cerradaOrders;
      if (canceladaEl) canceladaEl.textContent = canceladaOrders;

      console.log('‚úÖ [MASTER] Estad√≠sticas KPI actualizadas');
    }

    // Export orders to Excel
    async function exportOrders() {
      if (!window.orders || window.orders.length === 0) {
        alert('‚ö†Ô∏è No hay √≥rdenes para exportar');
        return;
      }

      try {
        console.log('üì§ Exportando √≥rdenes a Excel...');

        const stateLabels = {
          borrador: 'Borrador',
          revision: 'En Revisi√≥n',
          aprobada: 'Aprobada',
          preparacion: 'En Preparaci√≥n',
          listo: 'Listo para Retiro/Despacho',
          despachada: 'Despachada',
          entregada: 'Entregada',
          cerrada: 'Cerrada',
          cancelada: 'Cancelada'
        };

        // Preparar datos para Excel
        const ordersData = window.orders.map(order => {
          // Calcular cantidad total de items
          const totalItems = order.items ? order.items.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0;

          return {
            'N√∫mero de Orden': order.numeroOrden || order.id.slice(-6),
            'Fecha': order.fechaLocal || order.fecha || '',
            'Cliente': order.clienteNombre || order.usuarioEmail || '',
            'Email': order.clienteEmail || order.usuarioEmail || '',
            'Estado': stateLabels[order.logisticsState] || order.logisticsState || '',
            'Cantidad Items': order.cantidadItems || totalItems,
            'Total': order.total || order.montoTotal || 0,
            'Creada por Admin': order.creadoPorAdmin ? 'S√≠' : 'No',
            'Vendedor': order.usuarioEmail || '',
            'Editada por': order.editadaPorNombre || '',
            'Fecha Edici√≥n': order.fechaEdicionLocal || ''
          };
        });

        // Crear libro de Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(ordersData);

        // Ajustar ancho de columnas
        const colWidths = [
          { wch: 15 }, // N√∫mero de Orden
          { wch: 20 }, // Fecha
          { wch: 30 }, // Cliente
          { wch: 30 }, // Email
          { wch: 25 }, // Estado
          { wch: 12 }, // Cantidad Items
          { wch: 15 }, // Total
          { wch: 15 }, // Creada por Admin
          { wch: 30 }, // Vendedor
          { wch: 25 }, // Editada por
          { wch: 20 }  // Fecha Edici√≥n
        ];
        ws['!cols'] = colWidths;

        XLSX.utils.book_append_sheet(wb, ws, '√ìrdenes');

        // Generar nombre de archivo con fecha
        const fecha = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `Ordenes_${fecha}.xlsx`);

        console.log(`‚úÖ Exportadas ${ordersData.length} √≥rdenes a Excel`);
        alert(`‚úÖ Exportadas ${ordersData.length} √≥rdenes correctamente`);

      } catch (error) {
        console.error('‚ùå Error exportando √≥rdenes:', error);
        alert('‚ùå Error exportando √≥rdenes: ' + error.message);
      }
    }

    // Expose functions globally
    window.loadOrders = loadOrders;
    window.exportOrders = exportOrders;

    // === CLIENT MANAGEMENT FUNCTIONS ===

    // Load clients from Firebase
    async function loadClients() {
      const tableBody = document.getElementById('clientesTableBody');

      if (!tableBody) {
        console.warn('‚ö†Ô∏è Elemento clientesTableBody no encontrado');
        return;
      }

      if (!firebase || !firebase.firestore) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="17" style="text-align: center; padding: 20px;">
              ‚ùå Firebase no est√° disponible
            </td>
          </tr>
        `;
        return;
      }

      try {
        console.log('üë• Cargando clientes desde Firebase...');

        const { collection, getDocs, query, orderBy } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clientesCollection = collection(db, 'clientes');
        const q = query(clientesCollection, orderBy('codigo', 'asc'));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="17" style="text-align: center; padding: 20px;">
                üìù No hay clientes registrados
              </td>
            </tr>
          `;
          updateClientStats();
          return;
        }

        const clientes = [];
        querySnapshot.forEach(doc => {
          clientes.push({
            id: doc.id,
            ...doc.data()
          });
        });

        console.log(`‚úÖ Cargados ${clientes.length} clientes desde Firebase`);

        // Guardar clientes globalmente para b√∫squeda
        window.clients = clientes;
        window.allClients = clientes; // Copia para filtrado

        // Mostrar todos los clientes inicialmente
        displayClients(clientes);
        updateClientStats();

        // Setup sortable headers - solo una vez despu√©s de la primera carga
        setupClientSortableHeaders();

      } catch (error) {
        console.error('‚ùå Error cargando clientes:', error);
        tableBody.innerHTML = `
          <tr>
            <td colspan="16" style="text-align: center; padding: 20px;">
              ‚ùå Error cargando clientes
            </td>
          </tr>
        `;
      }
    }

    // Helper functions for client table sorting
    const getClientSortIndicator = (columnId) => {
      if (clientTableSort.column === columnId) {
        return clientTableSort.direction === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
      }
      return ' ‚áÖ';
    };

    const getClientSortedClass = (columnId) => {
      return clientTableSort.column === columnId ? 'sorted' : '';
    };

    // Display clients in the table
    function displayClients(clientes) {
      const tableBody = document.getElementById('clientesTableBody');

      if (!tableBody) {
        console.warn('‚ö†Ô∏è Elemento clientesTableBody no encontrado');
        return;
      }

      if (!clientes || clientes.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="17" style="text-align: center; padding: 20px;">
              üìù No se encontraron clientes
            </td>
          </tr>
        `;
        return;
      }

      // Sort clients based on current sort state
      const sortedClientes = [...clientes].sort((a, b) => {
        const col = clientTableSort.column;
        const dir = clientTableSort.direction === 'asc' ? 1 : -1;
        let aVal = a[col];
        let bVal = b[col];

        // Handle null/undefined values - push them to the end
        if (aVal === null || aVal === undefined || aVal === '-') return 1;
        if (bVal === null || bVal === undefined || bVal === '-') return -1;

        // Convert to string for comparison if needed
        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();

        if (aVal < bVal) return -1 * dir;
        if (aVal > bVal) return 1 * dir;
        return 0;
      });

      tableBody.innerHTML = sortedClientes.map(cliente => {
        // Identificar si es un usuario asignado (creado desde admisiones)
        const esUsuarioAsignado = cliente.creadoDesdeAdmision === true;
        const rowClass = esUsuarioAsignado ? 'usuario-asignado-row' : '';

        // Si es usuario asignado, solo mostrar email y lista de precios
        if (esUsuarioAsignado) {
          return `
          <tr class="${rowClass}">
            <td data-column="codigo">-</td>
            <td data-column="nombre">-</td>
            <td data-column="nombreComercial">-</td>
            <td data-column="grupo">-</td>
            <td data-column="departamento">-</td>
            <td data-column="inscripcion">-</td>
            <td data-column="nroDocumento">-</td>
            <td data-column="direccion">-</td>
            <td data-column="ciudad">-</td>
            <td data-column="provincia">-</td>
            <td data-column="pais">-</td>
            <td data-column="telefono">-</td>
            <td data-column="email">${cliente.email || ''}</td>
            <td data-column="vendedor">-</td>
            <td data-column="listaPrecio">
              <select class="client-price-list-select"
                      data-client-id="${cliente.id}"
                      onchange="updateClientPriceList('${cliente.id}', this.value)"
                      style="padding: 4px 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0; min-width: 100px;">
                <option value="precios1" ${(cliente.listaPrecio || 'precios1') === 'precios1' ? 'selected' : ''}>Precios 1</option>
                <option value="precios2" ${cliente.listaPrecio === 'precios2' ? 'selected' : ''}>Precios 2</option>
                <option value="precios3" ${cliente.listaPrecio === 'precios3' ? 'selected' : ''}>Precios 3</option>
                <option value="precios4" ${cliente.listaPrecio === 'precios4' ? 'selected' : ''}>Precios 4</option>
                <option value="precios5" ${cliente.listaPrecio === 'precios5' ? 'selected' : ''}>Precios 5</option>
              </select>
            </td>
            <td data-column="saldoCredito" style="text-align: right;">-</td>
            <td>
              <button class="edit-client-btn" onclick="editClient('${cliente.id}')">‚úèÔ∏è</button>
              <button class="delete-client-btn" onclick="deleteCliente('${cliente.id}')">üóëÔ∏è</button>
            </td>
          </tr>
        `;
        }

        // Cliente principal: mostrar todos los datos
        return `
        <tr class="${rowClass}">
          <td data-column="codigo">${cliente.codigo || ''}</td>
          <td data-column="nombre">${cliente.nombre || ''}</td>
          <td data-column="nombreComercial">${cliente.nombreComercial || ''}</td>
          <td data-column="grupo">${cliente.grupo || ''}</td>
          <td data-column="departamento">${cliente.departamento || ''}</td>
          <td data-column="inscripcion">${cliente.inscripcion || ''}</td>
          <td data-column="nroDocumento">${cliente.nroDocumento || ''}</td>
          <td data-column="direccion">${cliente.direccion || ''}</td>
          <td data-column="ciudad">${cliente.ciudad || ''}</td>
          <td data-column="provincia">${cliente.provincia || ''}</td>
          <td data-column="pais">${cliente.pais || ''}</td>
          <td data-column="telefono">${cliente.telefono || ''}</td>
          <td data-column="email">${cliente.email || ''}</td>
          <td data-column="vendedor">
            <select class="client-seller-select"
                    data-client-id="${cliente.id}"
                    onchange="updateClientSeller('${cliente.id}', this.value)"
                    style="padding: 4px 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0; min-width: 120px;">
              <option value="">Sin asignar</option>
              ${(window.sellers || []).map(seller => `
                <option value="${seller.id}" ${(cliente.vendedorId || cliente.vendedor) === seller.id ? 'selected' : ''}>
                  ${seller.name}
                </option>
              `).join('')}
            </select>
          </td>
          <td data-column="listaPrecio">
            <select class="client-price-list-select"
                    data-client-id="${cliente.id}"
                    onchange="updateClientPriceList('${cliente.id}', this.value)"
                    style="padding: 4px 8px; border: 1px solid #3a3a44; border-radius: 4px; background: #1b1b1f; color: #f0f0f0; min-width: 100px;">
              <option value="precios1" ${(cliente.listaPrecio || 'precios1') === 'precios1' ? 'selected' : ''}>Precios 1</option>
              <option value="precios2" ${cliente.listaPrecio === 'precios2' ? 'selected' : ''}>Precios 2</option>
              <option value="precios3" ${cliente.listaPrecio === 'precios3' ? 'selected' : ''}>Precios 3</option>
              <option value="precios4" ${cliente.listaPrecio === 'precios4' ? 'selected' : ''}>Precios 4</option>
              <option value="precios5" ${cliente.listaPrecio === 'precios5' ? 'selected' : ''}>Precios 5</option>
            </select>
          </td>
          <td data-column="saldoCredito" style="text-align: right;">${cliente.saldoCredito ? parseFloat(cliente.saldoCredito).toFixed(2) : '0.00'}</td>
          <td>
            <button class="edit-client-btn" onclick="editClient('${cliente.id}')">‚úèÔ∏è</button>
            <button class="delete-client-btn" onclick="deleteCliente('${cliente.id}')">üóëÔ∏è</button>
          </td>
        </tr>
      `;
      }).join('');

      // Update sort indicators in headers
      document.querySelectorAll('.clientes-table th.sortable').forEach(th => {
        const column = th.dataset.sort;
        const indicator = th.querySelector('.sort-indicator');
        if (indicator) {
          indicator.textContent = getClientSortIndicator(column);
        }
        // Add/remove sorted class
        if (getClientSortedClass(column)) {
          th.classList.add('sorted');
        } else {
          th.classList.remove('sorted');
        }
      });

      // Aplicar preferencias de columnas guardadas
      applyColumnPreferences();
    }

    // Setup event listeners for sortable table headers
    function setupClientSortableHeaders() {
      const sortableHeaders = document.querySelectorAll('.clientes-table th.sortable');
      sortableHeaders.forEach(th => {
        th.addEventListener('click', function() {
          const column = this.dataset.sort;

          if (clientTableSort.column === column) {
            // Toggle direction if same column clicked
            clientTableSort.direction = clientTableSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            // Set new column and default to ascending
            clientTableSort.column = column;
            clientTableSort.direction = 'asc';
          }

          // Re-render the table with new sort
          displayClients(window.allClients);
        });
      });
    }

    // Column toggle functionality
    function getColumnPreferencesKey() {
      const currentUser = firebase.auth().currentUser;
      if (!currentUser) return null;
      return `clientColumns_${currentUser.uid}`;
    }

    function loadColumnPreferences() {
      const key = getColumnPreferencesKey();
      if (!key) return {};

      try {
        const saved = localStorage.getItem(key);
        return saved ? JSON.parse(saved) : {};
      } catch (e) {
        console.error('Error loading column preferences:', e);
        return {};
      }
    }

    function saveColumnPreferences(preferences) {
      const key = getColumnPreferencesKey();
      if (!key) return;

      try {
        localStorage.setItem(key, JSON.stringify(preferences));
      } catch (e) {
        console.error('Error saving column preferences:', e);
      }
    }

    function toggleColumn(columnName) {
      const table = document.querySelector('.clientes-table');
      if (!table) return;

      // Get all TH and TD elements for this column
      const headers = table.querySelectorAll(`th[data-column="${columnName}"]`);
      const cells = table.querySelectorAll(`td[data-column="${columnName}"]`);
      const toggleBtn = table.querySelector(`.column-toggle-btn[data-column="${columnName}"]`);

      if (!headers.length) return;

      const isCollapsed = headers[0].classList.contains('column-collapsed');

      headers.forEach(header => {
        if (isCollapsed) {
          header.classList.remove('column-collapsed');
        } else {
          header.classList.add('column-collapsed');
        }
      });

      cells.forEach(cell => {
        if (isCollapsed) {
          cell.classList.remove('column-collapsed');
          cell.removeAttribute('data-first-letter');
        } else {
          cell.classList.add('column-collapsed');
          // Obtener la primera letra del contenido de la celda
          const text = cell.textContent.trim();
          const firstLetter = text.charAt(0) || '';
          cell.setAttribute('data-first-letter', firstLetter);
        }
      });

      if (toggleBtn) {
        toggleBtn.textContent = isCollapsed ? '‚àí' : '+';
        toggleBtn.title = isCollapsed ? 'Ocultar columna' : 'Mostrar columna';
      }

      // Save preference
      const preferences = loadColumnPreferences();
      preferences[columnName] = !isCollapsed; // true = collapsed, false = expanded
      saveColumnPreferences(preferences);
    }

    function applyColumnPreferences() {
      const preferences = loadColumnPreferences();

      Object.keys(preferences).forEach(columnName => {
        if (preferences[columnName]) { // if collapsed
          const table = document.querySelector('.clientes-table');
          if (!table) return;

          const headers = table.querySelectorAll(`th[data-column="${columnName}"]`);
          const cells = table.querySelectorAll(`td[data-column="${columnName}"]`);
          const toggleBtn = table.querySelector(`.column-toggle-btn[data-column="${columnName}"]`);

          headers.forEach(header => header.classList.add('column-collapsed'));
          cells.forEach(cell => {
            cell.classList.add('column-collapsed');
            // Obtener la primera letra del contenido de la celda
            const text = cell.textContent.trim();
            const firstLetter = text.charAt(0) || '';
            cell.setAttribute('data-first-letter', firstLetter);
          });

          if (toggleBtn) {
            toggleBtn.textContent = '+';
            toggleBtn.title = 'Mostrar columna';
          }
        }
      });
    }

    /**
     * Collapse all columns at once
     *
     * Minimiza todas las columnas de la tabla de clientes con un solo click.
     * √ötil para crear una vista personalizada: minimizar todo y luego expandir
     * solo las columnas necesarias usando los botones individuales (+).
     *
     * Funcionalidad:
     * - Aplica clase 'column-collapsed' a headers y cells
     * - Muestra solo la primera letra en cada celda
     * - Cambia botones individuales de ‚àí a +
     * - Guarda preferencias en localStorage para persistencia
     *
     * @version 0.35
     */
    function collapseAllColumns() {
      const table = document.querySelector('.clientes-table');
      if (!table) return;

      // Lista de todas las columnas con data-column attribute (16 columnas totales)
      const allColumns = ['codigo', 'nombre', 'nombreComercial', 'grupo', 'departamento',
                          'inscripcion', 'nroDocumento', 'direccion', 'ciudad', 'provincia',
                          'pais', 'telefono', 'email', 'vendedor', 'listaPrecio', 'saldoCredito'];

      allColumns.forEach(columnName => {
        const headers = table.querySelectorAll(`th[data-column="${columnName}"]`);
        const cells = table.querySelectorAll(`td[data-column="${columnName}"]`);
        const toggleBtn = table.querySelector(`.column-toggle-btn[data-column="${columnName}"]`);

        // Solo colapsar si no est√° ya colapsada (evita trabajo innecesario)
        const isCollapsed = headers[0]?.classList.contains('column-collapsed');
        if (!isCollapsed) {
          // Colapsar headers
          headers.forEach(header => header.classList.add('column-collapsed'));

          // Colapsar cells y extraer primera letra para mostrar
          cells.forEach(cell => {
            cell.classList.add('column-collapsed');
            const text = cell.textContent.trim();
            const firstLetter = text.charAt(0) || '';
            cell.setAttribute('data-first-letter', firstLetter);
          });

          // Actualizar bot√≥n individual para reflejar estado colapsado
          if (toggleBtn) {
            toggleBtn.textContent = '+';
            toggleBtn.title = 'Mostrar columna';
          }
        }
      });

      // Guardar todas las columnas como colapsadas en localStorage
      const preferences = {};
      allColumns.forEach(col => preferences[col] = true);
      saveColumnPreferences(preferences);
    }

    /**
     * Expand all columns at once
     *
     * Maximiza todas las columnas de la tabla de clientes con un solo click.
     * Restaura la vista completa de la tabla mostrando todos los datos.
     *
     * Funcionalidad:
     * - Remueve clase 'column-collapsed' de headers y cells
     * - Muestra contenido completo en cada celda
     * - Cambia botones individuales de + a ‚àí
     * - Limpia preferencias en localStorage (estado por defecto = expandido)
     *
     * @version 0.35
     */
    function expandAllColumns() {
      const table = document.querySelector('.clientes-table');
      if (!table) return;

      // Lista de todas las columnas con data-column attribute (16 columnas totales)
      const allColumns = ['codigo', 'nombre', 'nombreComercial', 'grupo', 'departamento',
                          'inscripcion', 'nroDocumento', 'direccion', 'ciudad', 'provincia',
                          'pais', 'telefono', 'email', 'vendedor', 'listaPrecio', 'saldoCredito'];

      allColumns.forEach(columnName => {
        const headers = table.querySelectorAll(`th[data-column="${columnName}"]`);
        const cells = table.querySelectorAll(`td[data-column="${columnName}"]`);
        const toggleBtn = table.querySelector(`.column-toggle-btn[data-column="${columnName}"]`);

        // Solo expandir si est√° actualmente colapsada (evita trabajo innecesario)
        const isCollapsed = headers[0]?.classList.contains('column-collapsed');
        if (isCollapsed) {
          // Expandir headers
          headers.forEach(header => header.classList.remove('column-collapsed'));

          // Expandir cells y remover atributo de primera letra
          cells.forEach(cell => {
            cell.classList.remove('column-collapsed');
            cell.removeAttribute('data-first-letter');
          });

          // Actualizar bot√≥n individual para reflejar estado expandido
          if (toggleBtn) {
            toggleBtn.textContent = '‚àí';
            toggleBtn.title = 'Ocultar columna';
          }
        }
      });

      // Limpiar todas las preferencias de columnas (estado por defecto = todas expandidas)
      saveColumnPreferences({});
    }

    // Make column functions globally accessible
    window.toggleColumn = toggleColumn;
    window.collapseAllColumns = collapseAllColumns;
    window.expandAllColumns = expandAllColumns;
    window.loadColumnPreferences = loadColumnPreferences;
    window.saveColumnPreferences = saveColumnPreferences;
    window.applyColumnPreferences = applyColumnPreferences;

    // Search/filter clients
    function searchClients(searchTerm) {
      if (!window.allClients) {
        console.warn('‚ö†Ô∏è No hay clientes cargados para buscar');
        return;
      }

      const term = searchTerm.toLowerCase().trim();
      const resultsSpan = document.getElementById('clientSearchResults');

      // Si no hay t√©rmino de b√∫squeda, mostrar todos
      if (!term) {
        displayClients(window.allClients);
        window.clients = window.allClients;
        if (resultsSpan) {
          resultsSpan.textContent = `Mostrando todos los clientes (${window.allClients.length})`;
        }
        updateClientStats();
        return;
      }

      // Filtrar clientes por m√∫ltiples campos
      const filteredClientes = window.allClients.filter(cliente => {
        return (
          (cliente.codigo && cliente.codigo.toLowerCase().includes(term)) ||
          (cliente.nombre && cliente.nombre.toLowerCase().includes(term)) ||
          (cliente.nombreComercial && cliente.nombreComercial.toLowerCase().includes(term)) ||
          (cliente.grupo && cliente.grupo.toLowerCase().includes(term)) ||
          (cliente.email && cliente.email.toLowerCase().includes(term)) ||
          (cliente.telefono && cliente.telefono.toLowerCase().includes(term)) ||
          (cliente.nroDocumento && cliente.nroDocumento.toLowerCase().includes(term)) ||
          (cliente.ciudad && cliente.ciudad.toLowerCase().includes(term)) ||
          (cliente.direccion && cliente.direccion.toLowerCase().includes(term))
        );
      });

      // Mostrar resultados filtrados
      displayClients(filteredClientes);
      window.clients = filteredClientes;

      // Actualizar mensaje de resultados
      if (resultsSpan) {
        if (filteredClientes.length === 0) {
          resultsSpan.textContent = `No se encontraron clientes con "${searchTerm}"`;
          resultsSpan.style.color = '#ff9800';
        } else {
          resultsSpan.textContent = `Mostrando ${filteredClientes.length} de ${window.allClients.length} clientes`;
          resultsSpan.style.color = '#4CAF50';
        }
      }

      updateClientStats();
    }

    // Update client statistics
    function updateClientStats() {
      const totalClients = window.clients ? window.clients.length : 0;
      const totalBalance = window.clients ? window.clients.reduce((sum, c) => sum + (parseFloat(c.saldoCredito) || 0), 0) : 0;

      document.getElementById('totalClients').textContent = totalClients;
      document.getElementById('totalBalance').textContent = '$' + formatNumber(totalBalance);
    }

    // Import clients from Excel
    async function importClientes() {
      const fileInput = document.getElementById('excelFileInput');
      fileInput.click();
    }

    async function handleExcelImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!firebase || !firebase.firestore) {
        alert('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        console.log('üì• Importando archivo Excel:', file.name);

        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            console.log('üìä Datos le√≠dos del Excel:', jsonData.length, 'filas');

            const { collection, doc, setDoc } = firebase.firestoreHelpers;
            const db = firebase.firestore();

            let importados = 0;
            let saltados = 0;

            for (const row of jsonData) {
              let codigo = row['C√≥digo'] || row['Codigo'] || '';
              if (codigo !== null && codigo !== undefined) {
                codigo = String(codigo).trim();
              }

              if (!codigo || codigo === '' || codigo === 'null' || codigo === 'undefined') {
                console.log('‚ö†Ô∏è Saltando fila sin c√≥digo v√°lido:', row);
                saltados++;
                continue;
              }

              const saldoCredito = row['Saldo Cr√©dito'] || row['Saldo Credito'] || row['SaldoCredito'] || 0;

              const clienteData = {
                codigo: codigo,
                nombre: String(row['Nombre'] || '').trim(),
                nombreComercial: String(row['Nombre Comercial'] || '').trim(),
                grupo: String(row['Grupo de Clientes'] || row['Grupo'] || '').trim(),
                departamento: String(row['Departamento'] || '').trim(),
                inscripcion: String(row['Inscripci√≥n'] || row['Inscripcion'] || '').trim(),
                nroDocumento: String(row['Nro Documento'] || '').trim(),
                direccion: String(row['Direcci√≥n'] || row['Direccion'] || '').trim(),
                ciudad: String(row['Nombre (Ciudad)'] || row['Ciudad'] || '').trim(),
                provincia: String(row['Provincia'] || '').trim(),
                pais: String(row['Pa√≠s'] || row['Pais'] || '').trim(),
                telefono: String(row['Tel√©fono'] || row['Telefono'] || '').trim(),
                email: String(row['Email'] || '').trim(),
                saldoCredito: parseFloat(saldoCredito) || 0
              };

              const clienteRef = doc(db, 'clientes', clienteData.codigo);
              await setDoc(clienteRef, clienteData);
              importados++;

              if (importados % 50 === 0) {
                console.log(`üìä Progreso: ${importados} clientes importados...`);
              }
            }

            console.log(`‚úÖ Importaci√≥n completada: ${importados} clientes importados, ${saltados} filas saltadas`);
            alert(`‚úÖ Importados ${importados} clientes correctamente${saltados > 0 ? `\n‚ö†Ô∏è ${saltados} filas saltadas por falta de c√≥digo` : ''}`);

            loadClients();

          } catch (error) {
            console.error('‚ùå Error procesando Excel:', error);
            alert('‚ùå Error procesando archivo Excel: ' + error.message);
          }
        };

        reader.readAsArrayBuffer(file);

      } catch (error) {
        console.error('‚ùå Error importando clientes:', error);
        alert('‚ùå Error importando clientes: ' + error.message);
      }

      event.target.value = '';
    }

    // Export clients to Excel
    async function exportClientes() {
      if (!firebase || !firebase.firestore) {
        alert('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        console.log('üì§ Exportando clientes a Excel...');

        const { collection, getDocs, query, orderBy } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clientesCollection = collection(db, 'clientes');
        const q = query(clientesCollection, orderBy('codigo', 'asc'));
        const querySnapshot = await getDocs(q);

        const clientes = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          clientes.push({
            'C√≥digo': data.codigo || '',
            'Nombre': data.nombre || '',
            'Nombre Comercial': data.nombreComercial || '',
            'Grupo de Clientes': data.grupo || '',
            'Departamento': data.departamento || '',
            'Inscripci√≥n': data.inscripcion || '',
            'Nro Documento': data.nroDocumento || '',
            'Direcci√≥n': data.direccion || '',
            'Nombre (Ciudad)': data.ciudad || '',
            'Provincia': data.provincia || '',
            'Pa√≠s': data.pais || '',
            'Tel√©fono': data.telefono || '',
            'Email': data.email || '',
            'Saldo Cr√©dito': data.saldoCredito || 0
          });
        });

        if (clientes.length === 0) {
          alert('‚ö†Ô∏è No hay clientes para exportar');
          return;
        }

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(clientes);
        XLSX.utils.book_append_sheet(wb, ws, 'Clientes');

        const fecha = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `Listado_de_Clientes_${fecha}.xlsx`);

        console.log(`‚úÖ Exportados ${clientes.length} clientes a Excel`);
        alert(`‚úÖ Exportados ${clientes.length} clientes correctamente`);

      } catch (error) {
        console.error('‚ùå Error exportando clientes:', error);
        alert('‚ùå Error exportando clientes: ' + error.message);
      }
    }

    // Update client seller assignment
    async function updateClientSeller(clienteId, sellerId) {
      if (!firebase || !firebase.firestore) {
        alert('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clienteId);
        await updateDoc(clienteRef, {
          vendedorId: sellerId
        });

        console.log(`‚úÖ Vendedor actualizado para cliente ${clienteId}: ${sellerId}`);

        // Actualizar en la copia local
        if (window.allClients) {
          const cliente = window.allClients.find(c => c.id === clienteId);
          if (cliente) {
            cliente.vendedorId = sellerId;
          }
        }

        if (window.clients) {
          const cliente = window.clients.find(c => c.id === clienteId);
          if (cliente) {
            cliente.vendedorId = sellerId;
          }
        }
      } catch (error) {
        console.error('‚ùå Error actualizando vendedor:', error);
        alert('‚ùå Error actualizando vendedor: ' + error.message);
      }
    }

    // Update client price list
    async function updateClientPriceList(clienteId, listaPrecio) {
      if (!firebase || !firebase.firestore) {
        alert('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        const { doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clienteId);
        await updateDoc(clienteRef, {
          listaPrecio: listaPrecio
        });

        console.log(`‚úÖ Lista de precios actualizada para cliente ${clienteId}: ${listaPrecio}`);

        // Actualizar en la copia local
        if (window.allClients) {
          const cliente = window.allClients.find(c => c.id === clienteId);
          if (cliente) {
            cliente.listaPrecio = listaPrecio;
          }
        }

        if (window.clients) {
          const cliente = window.clients.find(c => c.id === clienteId);
          if (cliente) {
            cliente.listaPrecio = listaPrecio;
          }
        }

      } catch (error) {
        console.error('‚ùå Error actualizando vendedor:', error);
        alert('‚ùå Error actualizando vendedor: ' + error.message);
      }
    }

    // Assign default seller (Santiago) to all clients without a seller
    async function assignDefaultSellerToAllClients() {
      if (!firebase || !firebase.firestore) {
        console.error('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        // Find Santiago in the sellers list
        const santiago = window.sellers?.find(s => s.name.toLowerCase().includes('santiago') || s.name.toLowerCase().includes('santi'));

        if (!santiago) {
          console.warn('‚ö†Ô∏è No se encontr√≥ el vendedor Santiago/Santi');
          return;
        }

        console.log(`üîÑ Asignando vendedor por defecto (${santiago.name}) a clientes sin vendedor...`);

        const { collection, getDocs, doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        // Get all clients
        const clientesCollection = collection(db, 'clientes');
        const querySnapshot = await getDocs(clientesCollection);

        let updatedCount = 0;
        const updatePromises = [];

        querySnapshot.forEach((docSnapshot) => {
          const data = docSnapshot.data();
          // Si no tiene vendedor asignado, asignar Santiago
          if (!data.vendedorId && !data.vendedor) {
            const clientRef = doc(db, 'clientes', docSnapshot.id);
            updatePromises.push(updateDoc(clientRef, { vendedorId: santiago.id }));
            updatedCount++;
          }
        });

        if (updatedCount > 0) {
          await Promise.all(updatePromises);
          console.log(`‚úÖ ${updatedCount} clientes actualizados con vendedor por defecto: ${santiago.name}`);

          // Reload clients to show the changes
          loadClients();
        } else {
          console.log('‚ÑπÔ∏è Todos los clientes ya tienen vendedor asignado');
        }

      } catch (error) {
        console.error('‚ùå Error asignando vendedor por defecto:', error);
      }
    }

    // Assign Santiago to ALL clients (regardless if they have a seller or not)
    async function assignSantiagoToAllClients() {
      if (!firebase || !firebase.firestore) {
        console.error('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        // Find Santiago/Santi in the sellers list
        const santiago = window.sellers?.find(s =>
          s.name.toLowerCase().includes('santiago') ||
          s.name.toLowerCase().includes('santi')
        );

        if (!santiago) {
          console.warn('‚ö†Ô∏è No se encontr√≥ el vendedor Santiago/Santi');
          alert('‚ö†Ô∏è No se encontr√≥ el vendedor Santiago en la lista de vendedores');
          return;
        }

        const confirmMsg = `¬øEst√°s seguro de que quieres asignar a ${santiago.name} como vendedor para TODOS los clientes?`;
        if (!confirm(confirmMsg)) {
          return;
        }

        console.log(`üîÑ Asignando ${santiago.name} a TODOS los clientes...`);

        const { collection, getDocs, doc, updateDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        // Get all clients
        const clientesCollection = collection(db, 'clientes');
        const querySnapshot = await getDocs(clientesCollection);

        let updatedCount = 0;
        const updatePromises = [];

        querySnapshot.forEach((docSnapshot) => {
          const clientRef = doc(db, 'clientes', docSnapshot.id);
          updatePromises.push(updateDoc(clientRef, { vendedorId: santiago.id }));
          updatedCount++;
        });

        if (updatedCount > 0) {
          await Promise.all(updatePromises);
          console.log(`‚úÖ ${updatedCount} clientes actualizados con vendedor: ${santiago.name}`);
          alert(`‚úÖ ${updatedCount} clientes asignados a ${santiago.name}`);

          // Reload clients to show the changes
          loadClients();
        }

      } catch (error) {
        console.error('‚ùå Error asignando vendedor a todos los clientes:', error);
        alert('‚ùå Error: ' + error.message);
      }
    }

    window.assignSantiagoToAllClients = assignSantiagoToAllClients;

    // Delete cliente
    async function deleteCliente(clienteId) {
      if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar este cliente?')) {
        return;
      }

      if (!firebase || !firebase.firestore) {
        alert('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        const { doc, deleteDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clienteId);
        await deleteDoc(clienteRef);

        console.log(`‚úÖ Cliente ${clienteId} eliminado`);
        alert('‚úÖ Cliente eliminado correctamente');

        loadClients();

      } catch (error) {
        console.error('‚ùå Error eliminando cliente:', error);
        alert('‚ùå Error eliminando cliente: ' + error.message);
      }
    }

    // Expose functions globally
    window.loadSellers = loadSellers;
    window.loadClients = loadClients;
    window.displayClients = displayClients;
    window.searchClients = searchClients;
    window.updateClientSeller = updateClientSeller;
    window.updateClientPriceList = updateClientPriceList;
    window.assignDefaultSellerToAllClients = assignDefaultSellerToAllClients;
    window.importClientes = importClientes;
    window.handleExcelImport = handleExcelImport;
    window.exportClientes = exportClientes;
    window.deleteCliente = deleteCliente;

  </script>

  <script>
    // Limpiar consola al cargar la p√°gina
    console.clear();
    console.log('üöÄ Administration cargado - Consola limpiada');

    // === GLOBAL MANAGEMENT VARIABLES ===
    window.sellers = [];
    window.clients = [];
    window.orders = [];
    window.currentEditingSellerId = null;
    window.currentEditingClientId = null;
    window.sellerToDelete = null;
    window.clientToDelete = null;

    // === MODAL FUNCTIONS (Available immediately) ===
    window.openSellerModal = function() {
      document.getElementById('sellerModal').classList.remove('hidden');
    };

    window.closeSellerModal = function() {
      document.getElementById('sellerModal').classList.add('hidden');
      document.getElementById('sellerForm').reset();
      window.currentEditingSellerId = null;
      document.getElementById('sellerModalTitle').textContent = 'Agregar Vendedor';
    };

    window.openConfirmModal = function() {
      document.getElementById('confirmModal').classList.remove('hidden');
    };

    window.closeConfirmModal = function() {
      document.getElementById('confirmModal').classList.add('hidden');
      window.sellerToDelete = null;
    };

    // === SELLER ACTION FUNCTIONS ===
    window.editSeller = function(sellerId) {
      const seller = window.sellers.find(s => s.id === sellerId);
      if (!seller) return;

      window.currentEditingSellerId = sellerId;

      document.getElementById('sellerModalTitle').textContent = 'Editar Vendedor';
      document.getElementById('sellerName').value = seller.name || '';
      document.getElementById('sellerEmail').value = seller.email || '';
      document.getElementById('sellerPhone').value = seller.phone || '';
      document.getElementById('sellerPhone2').value = seller.phone2 || '';
      document.getElementById('sellerTerritory').value = seller.territory || '';
      document.getElementById('sellerCommission').value = seller.commission || '';
      document.getElementById('sellerStatus').value = seller.status || 'active';
      document.getElementById('sellerNotes').value = seller.notes || '';

      window.openSellerModal();
    };

    window.confirmDeleteSeller = function(sellerId, sellerName) {
      window.sellerToDelete = sellerId;
      window.clientToDelete = null;
      document.getElementById('confirmMessage').textContent =
        `¬øEst√°s seguro de que deseas eliminar al vendedor "${sellerName}"?`;
      window.openConfirmModal();
    };

    // === CLIENT MODAL FUNCTIONS ===
    window.openClientModal = function() {
      document.getElementById('clientModal').classList.remove('hidden');
      populateVendorDropdown();
    };

    window.closeClientModal = function() {
      document.getElementById('clientModal').classList.add('hidden');
      document.getElementById('clientForm').reset();
      window.currentEditingClientId = null;
      document.getElementById('clientModalTitle').textContent = 'Agregar Cliente';
    };

    // === CLIENT ACTION FUNCTIONS ===
    window.editClient = async function(clientId) {
      if (!firebase || !firebase.firestore) {
        alert('‚ùå Firebase no est√° disponible');
        return;
      }

      try {
        const { doc, getDoc } = firebase.firestoreHelpers;
        const db = firebase.firestore();

        const clienteRef = doc(db, 'clientes', clientId);
        const clienteDoc = await getDoc(clienteRef);

        if (!clienteDoc.exists()) {
          alert('‚ùå Cliente no encontrado');
          return;
        }

        const cliente = clienteDoc.data();

        window.currentEditingClientId = clientId;
        document.getElementById('clientModalTitle').textContent = '‚úèÔ∏è Editar Cliente';

        document.getElementById('clientCodigo').value = cliente.codigo || '';
        document.getElementById('clientCodigo').disabled = true;
        document.getElementById('clientNombre').value = cliente.nombre || '';
        document.getElementById('clientNombreComercial').value = cliente.nombreComercial || '';
        document.getElementById('clientGrupo').value = cliente.grupo || '';
        document.getElementById('clientDepartamento').value = cliente.departamento || '';
        document.getElementById('clientInscripcion').value = cliente.inscripcion || '';
        document.getElementById('clientNroDocumento').value = cliente.nroDocumento || '';
        document.getElementById('clientDireccion').value = cliente.direccion || '';
        document.getElementById('clientCiudad').value = cliente.ciudad || '';
        document.getElementById('clientProvincia').value = cliente.provincia || '';
        document.getElementById('clientPais').value = cliente.pais || '';
        document.getElementById('clientTelefono').value = cliente.telefono || '';
        document.getElementById('clientEmail').value = cliente.email || '';
        document.getElementById('clientSaldoCredito').value = cliente.saldoCredito || 0;
        document.getElementById('clientListaPrecio').value = cliente.listaPrecio || 'precios1';

        window.openClientModal();

      } catch (error) {
        console.error('‚ùå Error cargando cliente:', error);
        alert('‚ùå Error cargando cliente: ' + error.message);
      }
    };

    window.confirmDeleteClient = function(clientId, clientName) {
      window.clientToDelete = clientId;
      window.sellerToDelete = null;
      document.getElementById('confirmMessage').textContent =
        `¬øEst√°s seguro de que deseas eliminar al cliente "${clientName}"?`;
      window.openConfirmModal();
    };

    function populateVendorDropdown() {
      const vendorSelect = document.getElementById('clientVendor');
      if (!vendorSelect) return;

      // Clear existing options except the first one
      vendorSelect.innerHTML = '<option value="">Seleccionar vendedor...</option>';

      // Add vendors from sellers list
      if (window.sellers && window.sellers.length > 0) {
        window.sellers
          .filter(seller => seller.status === 'active')
          .forEach(seller => {
            const option = document.createElement('option');
            option.value = seller.id;
            option.textContent = seller.name;
            vendorSelect.appendChild(option);
          });
      }
    }

    // Initialize Material Design Components
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize all buttons
      const buttons = document.querySelectorAll('.mdc-button');
      buttons.forEach(button => mdc.ripple.MDCRipple.attachTo(button));

      // === ADMISIONES FUNCTIONS ===

      // Load pending users from Firestore
      async function loadPendingUsers() {
        console.log('üë• Loading pending users...');

        try {
          // Asegurarse de que los clientes est√©n cargados primero
          if (!window.allClients) {
            console.log('üìã Cargando clientes primero...');
            await loadClients();
          }

          const { collection, getDocs } = firebase.firestoreHelpers;
          const db = firebase.firestore();

          const usuariosRef = collection(db, 'usuarios');
          const querySnapshot = await getDocs(usuariosRef);

          const pendingUsersList = document.getElementById('pendingUsersList');
          const noPendingUsers = document.getElementById('noPendingUsers');

          // Filter pending users on client side
          const pendingUsers = [];
          querySnapshot.forEach((doc) => {
            const user = doc.data();
            if (user.approved === false || user.role === 'pending') {
              pendingUsers.push({ id: doc.id, ...user });
            }
          });

          // Sort by creation date (newest first)
          pendingUsers.sort((a, b) => {
            const dateA = a.createdAt?.toDate?.() || new Date(0);
            const dateB = b.createdAt?.toDate?.() || new Date(0);
            return dateB - dateA;
          });

          if (pendingUsers.length === 0) {
            pendingUsersList.innerHTML = '';
            noPendingUsers.style.display = 'block';
            console.log('‚úÖ No hay usuarios pendientes');
            return;
          }

          noPendingUsers.style.display = 'none';

          let html = '';
          pendingUsers.forEach((user) => {
            const userId = user.id;
            const createdAt = user.createdAt?.toDate?.() || new Date();
            const formattedDate = createdAt.toLocaleDateString('es-AR', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });

            html += `
              <div class="admin-section" style="margin-bottom: 20px; border-left: 4px solid #FF9800;">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px;">
                  <div style="flex: 1;">
                    <h3 style="margin: 0 0 10px 0;">
                      <i class="material-icons" style="vertical-align: middle; color: #666;">person</i>
                      ${user.displayName || 'Usuario sin nombre'}
                    </h3>
                    <p style="margin: 5px 0; color: #666;">
                      <i class="material-icons" style="vertical-align: middle; font-size: 18px;">email</i>
                      <strong>Email:</strong> ${user.email}
                    </p>
                    <p style="margin: 5px 0; color: #666;">
                      <i class="material-icons" style="vertical-align: middle; font-size: 18px;">access_time</i>
                      <strong>Fecha registro:</strong> ${formattedDate}
                    </p>
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 15px; min-width: 300px;">
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">Seleccionar Rol *</label>
                      <select id="role-${userId}" style="padding: 14px 12px; border: 2px solid #999 !important; border-radius: 4px; font-size: 16px !important; width: 100%; color: #000 !important; background: #f0f0f0 !important; -webkit-text-fill-color: #000 !important; opacity: 1 !important; font-weight: 600 !important; z-index: 1; -webkit-appearance: none; appearance: none;">
                        <option value="" style="color: #666 !important; background: #f0f0f0 !important;">-- Seleccionar rol --</option>
                        <option value="vendedor" style="color: #000 !important; background: #f0f0f0 !important;">ü§ù Vendedor</option>
                        <option value="cliente" style="color: #000 !important; background: #f0f0f0 !important;">üë§ Cliente</option>
                        <option value="admin" style="color: #000 !important; background: #f0f0f0 !important;">üëë Administrador</option>
                      </select>
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">Lista de Precios *</label>
                      <select id="priceList-${userId}" style="padding: 14px 12px; border: 2px solid #999 !important; border-radius: 4px; font-size: 16px !important; width: 100%; color: #000 !important; background: #f0f0f0 !important; -webkit-text-fill-color: #000 !important; opacity: 1 !important; font-weight: 600 !important; z-index: 1; -webkit-appearance: none; appearance: none;">
                        <option value="precios1" selected style="color: #000 !important; background: #f0f0f0 !important;">üí∞ Lista de Precios 1</option>
                        <option value="precios2" style="color: #000 !important; background: #f0f0f0 !important;">üí∞ Lista de Precios 2</option>
                        <option value="precios3" style="color: #000 !important; background: #f0f0f0 !important;">üí∞ Lista de Precios 3</option>
                      </select>
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">Cliente Asignado *</label>
                      <select id="client-${userId}" style="padding: 14px 12px; border: 2px solid #999 !important; border-radius: 4px; font-size: 16px !important; width: 100%; color: #000 !important; background: #f0f0f0 !important; -webkit-text-fill-color: #000 !important; opacity: 1 !important; font-weight: 600 !important; z-index: 1; -webkit-appearance: none; appearance: none;">
                        <option value="" style="color: #666 !important; background: #f0f0f0 !important;">-- Seleccionar cliente --</option>
                        ${window.allClients ? window.allClients
                          .filter((c, index, self) => {
                            const cod = c.codigo || c.numero;
                            return cod && index === self.findIndex(t => (t.codigo || t.numero) === cod);
                          })
                          .map(c => {
                            const cod = c.codigo || c.numero || 'SIN-CODIGO';
                            return `<option value="${cod}" style="color: #000 !important; background: #f0f0f0 !important;">${cod} - ${c.nombre || 'Sin nombre'}</option>`;
                          })
                          .join('') : ''}
                      </select>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                      <button class="mdc-button mdc-button--raised" onclick="approveUser('${userId}')" style="background-color: #4CAF50 !important; flex: 1;">
                        <span class="mdc-button__ripple"></span>
                        <i class="material-icons mdc-button__icon" aria-hidden="true">check_circle</i>
                        <span class="mdc-button__label">Aprobar Usuario</span>
                      </button>
                      <button class="mdc-button mdc-button--raised" onclick="ignoreUser('${userId}', '${user.email}')" style="background-color: #757575 !important; flex: 1;">
                        <span class="mdc-button__ripple"></span>
                        <i class="material-icons mdc-button__icon" aria-hidden="true">block</i>
                        <span class="mdc-button__label">Ignorar y Bloquear</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            `;
          });

          pendingUsersList.innerHTML = html;
          console.log(`‚úÖ ${pendingUsers.length} usuarios pendientes cargados`);

          // Agregar event listeners para forzar visibilidad del texto seleccionado
          pendingUsers.forEach(user => {
            const userId = user.id;
            const roleSelect = document.getElementById(`role-${userId}`);
            const priceListSelect = document.getElementById(`priceList-${userId}`);
            const clientSelect = document.getElementById(`client-${userId}`);

            // Funci√≥n para forzar la visualizaci√≥n del texto seleccionado
            const forceTextVisibility = (select) => {
              if (select) {
                select.addEventListener('change', function() {
                  // Usar setProperty con !important para sobrescribir TODO
                  this.style.setProperty('color', '#000', 'important');
                  this.style.setProperty('-webkit-text-fill-color', '#000', 'important');
                  this.style.setProperty('opacity', '1', 'important');
                  this.style.setProperty('background', '#f0f0f0', 'important');
                  this.style.setProperty('font-weight', '600', 'important');
                  this.style.setProperty('font-size', '16px', 'important');
                  console.log(`‚úÖ Dropdown ${this.id} cambiado a: ${this.value}`);
                });

                // Tambi√©n aplicar al cargar si ya tiene un valor
                if (select.value) {
                  select.style.setProperty('color', '#000', 'important');
                  select.style.setProperty('-webkit-text-fill-color', '#000', 'important');
                  select.style.setProperty('opacity', '1', 'important');
                  select.style.setProperty('background', '#f0f0f0', 'important');
                  select.style.setProperty('font-weight', '600', 'important');
                  select.style.setProperty('font-size', '16px', 'important');
                }
              }
            };

            forceTextVisibility(roleSelect);
            forceTextVisibility(priceListSelect);
            forceTextVisibility(clientSelect);
          });

        } catch (error) {
          console.error('‚ùå Error loading pending users:', error);
          alert('Error al cargar usuarios pendientes: ' + error.message);
        }
      }

      // Approve user and assign role
      async function approveUser(userId) {
        console.log('‚úÖ Approving user:', userId);

        try {
          const roleSelect = document.getElementById(`role-${userId}`);
          const priceListSelect = document.getElementById(`priceList-${userId}`);
          const clientSelect = document.getElementById(`client-${userId}`);
          const selectedRole = roleSelect.value;
          const selectedPriceList = priceListSelect.value;
          const selectedClientCode = clientSelect.value;

          if (!selectedRole) {
            alert('‚ö†Ô∏è Por favor selecciona un rol antes de aprobar');
            return;
          }

          if (!selectedClientCode) {
            alert('‚ö†Ô∏è Por favor selecciona un cliente antes de aprobar');
            return;
          }

          const { doc, updateDoc, setDoc, collection, getDocs, query, where } = firebase.firestoreHelpers;
          const db = firebase.firestore();

          // Buscar el cliente original
          const clienteOriginal = window.allClients?.find(c => {
            const cod = c.codigo || c.numero;
            return cod === selectedClientCode;
          });

          if (!clienteOriginal) {
            alert('‚ö†Ô∏è Error: Cliente no encontrado');
            return;
          }

          // Determinar el c√≥digo a usar (priorizar codigo, sino usar numero)
          const codigoCliente = clienteOriginal.codigo || clienteOriginal.numero;

          // Obtener datos del usuario
          const usuariosRef = collection(db, 'usuarios');
          const userQuery = query(usuariosRef, where('__name__', '==', userId));
          const userSnapshot = await getDocs(userQuery);

          let userData = null;
          userSnapshot.forEach(doc => {
            userData = doc.data();
          });

          if (!userData) {
            alert('‚ö†Ô∏è Error: Usuario no encontrado');
            return;
          }

          // Actualizar el usuario
          const userRef = doc(db, 'usuarios', userId);
          await updateDoc(userRef, {
            approved: true,
            role: selectedRole,
            admin: selectedRole === 'admin',
            listaPrecio: selectedPriceList,
            clienteCodigo: codigoCliente,
            clienteNombre: clienteOriginal.nombre
          });

          // Crear un nuevo cliente en la colecci√≥n de clientes con el mismo c√≥digo
          // pero con datos del usuario aprobado
          const nuevoClienteId = `${codigoCliente}_${userId.substring(0, 8)}`;
          const nuevoClienteRef = doc(db, 'clientes', nuevoClienteId);

          const nuevoClienteData = {
            codigo: codigoCliente, // Mismo c√≥digo que el cliente original
            nombre: userData.displayName || userData.email,
            nombreComercial: clienteOriginal.nombreComercial || '',
            grupo: clienteOriginal.grupo || '',
            departamento: clienteOriginal.departamento || '',
            inscripcion: clienteOriginal.inscripcion || '',
            nroDocumento: clienteOriginal.nroDocumento || '',
            direccion: clienteOriginal.direccion || '',
            ciudad: clienteOriginal.ciudad || '',
            provincia: clienteOriginal.provincia || '',
            pais: clienteOriginal.pais || '',
            telefono: clienteOriginal.telefono || '',
            email: userData.email,
            saldoCredito: 0,
            listaPrecio: selectedPriceList,
            usuarioId: userId,
            creadoDesdeAdmision: true,
            fechaCreacion: new Date()
          };

          await setDoc(nuevoClienteRef, nuevoClienteData);

          console.log(`‚úÖ Usuario ${userId} aprobado con rol: ${selectedRole}, lista de precios: ${selectedPriceList}, cliente: ${codigoCliente}`);
          console.log(`‚úÖ Nuevo cliente creado en listado: ${nuevoClienteId}`);

          // Enviar email de bienvenida
          try {
            const emailResponse = await fetch('/api/send-welcome-email', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                email: userData.email,
                nombre: userData.displayName || userData.email.split('@')[0],
                rol: selectedRole,
                clienteNombre: clienteOriginal.nombre
              })
            });

            if (emailResponse.ok) {
              console.log(`‚úÖ Email de bienvenida enviado a: ${userData.email}`);
            } else {
              console.warn(`‚ö†Ô∏è No se pudo enviar email de bienvenida a: ${userData.email}`);
            }
          } catch (emailError) {
            console.error('‚ö†Ô∏è Error enviando email de bienvenida:', emailError);
            // No mostramos error al usuario, el email es secundario
          }

          alert(`‚úÖ Usuario aprobado exitosamente como ${selectedRole}\n‚úÖ Cliente agregado al listado con c√≥digo ${codigoCliente}\nüìß Email de bienvenida enviado`);

          // Reload pending users list and clients
          await loadPendingUsers();
          if (window.loadClients) {
            await window.loadClients();
          }

        } catch (error) {
          console.error('‚ùå Error approving user:', error);
          alert('‚ùå Error al aprobar usuario: ' + error.message);
        }
      }

      /**
       * Ignora un usuario y bloquea su email permanentemente
       * @param {string} userId - ID del usuario en Firestore
       * @param {string} email - Email del usuario a bloquear
       * @version 0.38
       */
      async function ignoreUser(userId, email) {
        // Confirmaci√≥n con el usuario
        const confirmed = confirm(
          `‚ö†Ô∏è ¬øEst√°s seguro de que deseas IGNORAR y BLOQUEAR este usuario?\n\n` +
          `Email: ${email}\n\n` +
          `Esta acci√≥n:\n` +
          `- Eliminar√° al usuario de admisiones\n` +
          `- Bloquear√° permanentemente este email\n` +
          `- No se podr√° deshacer\n\n` +
          `¬øDeseas continuar?`
        );

        if (!confirmed) {
          console.log('üö´ Ignorar usuario cancelado por el administrador');
          return;
        }

        try {
          const { doc, setDoc, deleteDoc, serverTimestamp } = firebase.firestoreHelpers;
          const db = firebase.firestore();
          const currentUser = firebase.auth().currentUser;

          // 1. Agregar email a la colecci√≥n blockedEmails
          console.log(`üö´ Bloqueando email: ${email}`);
          const blockedEmailRef = doc(db, 'blockedEmails', email);
          await setDoc(blockedEmailRef, {
            email: email,
            blockedAt: serverTimestamp(),
            blockedBy: currentUser?.uid || 'admin',
            blockedByEmail: currentUser?.email || 'admin',
            userId: userId,
            reason: 'Ignorado desde panel de admisiones'
          });

          // 2. Eliminar usuario de la colecci√≥n usuarios
          console.log(`üóëÔ∏è Eliminando usuario: ${userId}`);
          const userRef = doc(db, 'usuarios', userId);
          await deleteDoc(userRef);

          console.log(`‚úÖ Usuario ${userId} (${email}) ignorado y bloqueado exitosamente`);
          alert(
            `‚úÖ Usuario ignorado exitosamente\n\n` +
            `üö´ Email ${email} bloqueado permanentemente\n\n` +
            `Este email no podr√° registrarse nuevamente.`
          );

          // 3. Recargar lista de usuarios pendientes
          await loadPendingUsers();

        } catch (error) {
          console.error('‚ùå Error al ignorar usuario:', error);
          alert('‚ùå Error al ignorar usuario: ' + error.message);
        }
      }

      // Make functions globally accessible
      window.loadPendingUsers = loadPendingUsers;
      window.approveUser = approveUser;
      window.ignoreUser = ignoreUser;

      // Initialize tab bar
      const tabBar = document.querySelector('.mdc-tab-bar');
      if (tabBar) {
        const mdcTabBar = mdc.tabBar.MDCTabBar.attachTo(tabBar);

        // Handle tab activation
        mdcTabBar.listen('MDCTabBar:activated', (event) => {
          const tab = tabBar.querySelectorAll('.mdc-tab')[event.detail.index];
          const tabId = tab.getAttribute('data-tab');

          // Hide all tab contents
          const allTabContents = document.querySelectorAll('.tab-content');
          allTabContents.forEach(content => {
            content.style.display = 'none';
          });

          // Show selected tab content
          const selectedContent = document.getElementById(tabId + '-content');
          if (selectedContent) {
            selectedContent.style.display = 'block';
          }

          console.log('üìã Tab switched to:', tabId);

          // Load data when switching tabs
          if (tabId === 'precios') {
            console.log('üìã Switching to precios tab');
            setTimeout(() => {
              if (window.loadProducts) {
                console.log('üì¶ Calling loadProducts from tab switch');
                window.loadProducts();
              } else {
                console.warn('‚ö†Ô∏è loadProducts not available, retrying...');
                // Retry a few times in case loadProducts isn't ready yet
                let retries = 0;
                const retryLoad = () => {
                  retries++;
                  if (window.loadProducts && retries <= 5) {
                    console.log('üì¶ Retry successful, calling loadProducts');
                    window.loadProducts();
                  } else if (retries <= 5) {
                    setTimeout(retryLoad, 500);
                  } else {
                    console.error('‚ùå Failed to load products after multiple retries');
                  }
                };
                setTimeout(retryLoad, 500);
              }
            }, 100);
          } else if (tabId === 'vendedor') {
            setTimeout(() => {
              if (window.loadSellers) {
                window.loadSellers();
              }
            }, 100);
          } else if (tabId === 'clientes') {
            setTimeout(() => {
              // Load sellers first to populate dropdown, then load clients
              if (window.loadSellers && window.loadClients) {
                window.loadSellers().then(() => {
                  // Assign default seller to clients without one
                  if (window.assignDefaultSellerToAllClients) {
                    window.assignDefaultSellerToAllClients();
                  }
                  window.loadClients();
                });
              }
            }, 100);
          } else if (tabId === 'master') {
            setTimeout(() => {
              // Load sellers first to populate dropdown, then load orders
              if (window.loadSellers && window.loadOrders) {
                window.loadSellers().then(() => {
                  window.loadOrders();
                });
              }
            }, 100);
          } else if (tabId === 'admisiones') {
            setTimeout(() => {
              if (window.loadPendingUsers) {
                window.loadPendingUsers();
              }
            }, 100);
          }
        });
      }

      // === PRODUCT PRICING EVENT LISTENERS ===

      // Load Products button
      const loadProductsBtn = document.getElementById('loadProductsBtn');
      if (loadProductsBtn) {
        loadProductsBtn.addEventListener('click', function() {
          if (window.loadProducts) {
            window.loadProducts();
          }
        });
      }

      // Save All Prices button
      const saveAllPricesBtn = document.getElementById('saveAllPricesBtn');
      if (saveAllPricesBtn) {
        saveAllPricesBtn.addEventListener('click', function() {
          if (window.saveAllPrices) {
            window.saveAllPrices();
          }
        });
      }

      // Import Prices button
      const importPricesBtn = document.getElementById('importPricesBtn');
      if (importPricesBtn) {
        importPricesBtn.addEventListener('click', function() {
          if (window.importPrices) {
            window.importPrices();
          }
        });
      }

      // File input for prices import
      const pricesFileInput = document.getElementById('pricesFileInput');
      if (pricesFileInput) {
        pricesFileInput.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (file && window.processPriceFile) {
            window.processPriceFile(file);
          }
          // Clear the input so the same file can be selected again
          event.target.value = '';
        });
      }

      // Export CSV button
      const exportCsvBtn = document.getElementById('exportCsvBtn');
      if (exportCsvBtn) {
        exportCsvBtn.addEventListener('click', function() {
          if (window.exportPricesToCSV) {
            window.exportPricesToCSV();
          }
        });
      }

      // Export Excel button
      const exportExcelBtn = document.getElementById('exportExcelBtn');
      if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', function() {
          if (window.exportPricesToExcel) {
            window.exportPricesToExcel();
          }
        });
      }

      // === ORDER MANAGEMENT EVENT LISTENERS ===

      // Refresh Orders button
      const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
      if (refreshOrdersBtn) {
        refreshOrdersBtn.addEventListener('click', async function() {
          console.log('üîÑ Refrescando √≥rdenes manualmente...');

          // Clear current orders
          window.orders = [];

          // Reload orders from Firebase
          if (window.loadOrders) {
            await window.loadOrders();
          }

          console.log('‚úÖ √ìrdenes actualizadas');
        });
      }

      // Export Orders button
      const exportOrdersBtn = document.getElementById('exportOrdersBtn');
      if (exportOrdersBtn) {
        exportOrdersBtn.addEventListener('click', function() {
          if (window.exportOrders) {
            window.exportOrders();
          }
        });
      }

      // Search Orders
      const orderSearchInput = document.getElementById('orderSearchInput');
      if (orderSearchInput) {
        // Search as user types (with debounce)
        let searchTimeout;
        orderSearchInput.addEventListener('input', function(e) {
          clearTimeout(searchTimeout);
          const searchTerm = e.target.value;

          searchTimeout = setTimeout(() => {
            if (window.displayOrders) {
              window.displayOrders(searchTerm);
            }
          }, 300); // Wait 300ms after user stops typing
        });

        // Also search on Enter key
        orderSearchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            if (window.displayOrders) {
              window.displayOrders(e.target.value);
            }
          }
        });
      }

      // Clear Search button
      const clearSearchBtn = document.getElementById('clearSearchBtn');
      if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', function() {
          const searchInput = document.getElementById('orderSearchInput');
          if (searchInput) {
            searchInput.value = '';
            if (window.displayOrders) {
              window.displayOrders('');
            }
          }
        });
      }

      // === SELLER MANAGEMENT EVENT LISTENERS ===

      // Add Seller button
      const addSellerBtn = document.getElementById('addSellerBtn');
      if (addSellerBtn) {
        addSellerBtn.addEventListener('click', function() {
          window.currentEditingSellerId = null;
          document.getElementById('sellerModalTitle').textContent = 'Agregar Vendedor';
          document.getElementById('sellerForm').reset();
          window.openSellerModal();
        });
      }

      // === CLIENT MANAGEMENT EVENT LISTENERS ===

      // Column toggle buttons
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('column-toggle-btn')) {
          const columnName = e.target.getAttribute('data-column');
          if (columnName) {
            toggleColumn(columnName);
          }
        }
      });

      /**
       * Event listeners para botones de control global de columnas (v0.35)
       *
       * Bot√≥n "‚àí" (Collapse All): Minimiza todas las columnas simult√°neamente
       * Bot√≥n "+" (Expand All): Maximiza todas las columnas simult√°neamente
       *
       * Nota: e.stopPropagation() previene que se active el ordenamiento de la columna
       * ya que estos botones est√°n dentro del <th> de "Acciones"
       */
      const collapseAllBtn = document.getElementById('collapseAllColumnsBtn');
      if (collapseAllBtn) {
        collapseAllBtn.addEventListener('click', function(e) {
          e.stopPropagation(); // Evitar que se active el sorting de la columna
          collapseAllColumns();
        });
      }

      const expandAllBtn = document.getElementById('expandAllColumnsBtn');
      if (expandAllBtn) {
        expandAllBtn.addEventListener('click', function(e) {
          e.stopPropagation(); // Evitar que se active el sorting de la columna
          expandAllColumns();
        });
      }

      // Add Client button
      const addClientBtn = document.getElementById('addClientBtn');
      if (addClientBtn) {
        addClientBtn.addEventListener('click', function() {
          window.currentEditingClientId = null;
          document.getElementById('clientModalTitle').textContent = '‚ûï Agregar Cliente';
          document.getElementById('clientForm').reset();
          document.getElementById('clientCodigo').disabled = false;
          window.openClientModal();
        });
      }

      // Client search input
      const clientSearchInput = document.getElementById('clientSearchInput');
      const clientSearchLabel = document.getElementById('clientSearchLabel');
      if (clientSearchInput) {
        // Controlar la visibilidad del floating label
        const updateLabelVisibility = () => {
          if (clientSearchInput.value.trim().length > 0) {
            clientSearchLabel.classList.add('mdc-floating-label--float-above');
          } else {
            clientSearchLabel.classList.remove('mdc-floating-label--float-above');
          }
        };

        // B√∫squeda en tiempo real con debounce
        let searchTimeout;
        clientSearchInput.addEventListener('input', function(e) {
          updateLabelVisibility();
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            searchClients(e.target.value);
          }, 300); // Esperar 300ms despu√©s de que el usuario deje de escribir
        });

        // Tambi√©n buscar al presionar Enter
        clientSearchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            searchClients(e.target.value);
          }
        });

        // Manejar foco y blur
        clientSearchInput.addEventListener('focus', updateLabelVisibility);
        clientSearchInput.addEventListener('blur', updateLabelVisibility);
      }

      // Import/Export clients buttons
      const importClientesBtn = document.getElementById('importClientesBtn');
      if (importClientesBtn) {
        importClientesBtn.addEventListener('click', function() {
          if (window.importClientes) {
            window.importClientes();
          }
        });
      }

      const exportClientesBtn = document.getElementById('exportClientesBtn');
      if (exportClientesBtn) {
        exportClientesBtn.addEventListener('click', function() {
          if (window.exportClientes) {
            window.exportClientes();
          }
        });
      }

      const excelFileInput = document.getElementById('excelFileInput');
      if (excelFileInput) {
        excelFileInput.addEventListener('change', function(e) {
          if (window.handleExcelImport) {
            window.handleExcelImport(e);
          }
        });
      }

      // Close client modal buttons
      const closeClientModal = document.getElementById('closeClientModal');
      const cancelClientBtn = document.getElementById('cancelClientBtn');
      if (closeClientModal) {
        closeClientModal.addEventListener('click', window.closeClientModal);
      }
      if (cancelClientBtn) {
        cancelClientBtn.addEventListener('click', window.closeClientModal);
      }

      // Close seller modal buttons
      const closeSellerModal = document.getElementById('closeSellerModal');
      const cancelSellerBtn = document.getElementById('cancelSellerBtn');
      if (closeSellerModal) {
        closeSellerModal.addEventListener('click', window.closeSellerModal);
      }
      if (cancelSellerBtn) {
        cancelSellerBtn.addEventListener('click', window.closeSellerModal);
      }

      // Close confirm modal buttons
      const closeConfirmModal = document.getElementById('closeConfirmModal');
      const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
      if (closeConfirmModal) {
        closeConfirmModal.addEventListener('click', window.closeConfirmModal);
      }
      if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', window.closeConfirmModal);
      }

      // Confirm delete button
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', async function() {
          const { doc, deleteDoc } = window.firebase.firestoreHelpers;
          const db = window.firebase.firestore();

          try {
            if (window.sellerToDelete) {
              // Delete seller
              const sellerRef = doc(db, 'vendedores', window.sellerToDelete);
              await deleteDoc(sellerRef);
              console.log('‚úÖ Vendedor eliminado:', window.sellerToDelete);
              window.closeConfirmModal();
              if (window.loadSellers) window.loadSellers();
            } else if (window.clientToDelete) {
              // Delete client
              const clientRef = doc(db, 'clientes', window.clientToDelete);
              await deleteDoc(clientRef);
              console.log('‚úÖ Cliente eliminado:', window.clientToDelete);
              window.closeConfirmModal();
              if (window.loadClients) window.loadClients();
            }
          } catch (error) {
            console.error('‚ùå Error eliminando registro:', error);
            alert('Error eliminando registro. Int√©ntalo de nuevo.');
          }
        });
      }

      // Seller form submission
      const sellerForm = document.getElementById('sellerForm');
      if (sellerForm) {
        sellerForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          // Wait for Firebase to be ready if needed
          let retries = 0;
          while ((!window.firebase || !window.firebase.firestoreHelpers) && retries < 10) {
            console.log('‚è≥ Waiting for Firebase to be ready...');
            await new Promise(resolve => setTimeout(resolve, 500));
            retries++;
          }

          const formData = new FormData(sellerForm);
          const sellerData = {
            name: formData.get('name'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            phone2: formData.get('phone2'),
            territory: formData.get('territory'),
            commission: formData.get('commission') ? parseFloat(formData.get('commission')) : null,
            status: formData.get('status'),
            notes: formData.get('notes')
          };

          // Validate required fields
          if (!sellerData.name) {
            alert('Por favor completa el campo obligatorio: Nombre');
            return;
          }

          try {
            if (!window.firebase || !window.firebase.firestoreHelpers) {
              throw new Error('Firebase not available');
            }

            console.log('üî• Firebase helpers available:', Object.keys(window.firebase.firestoreHelpers));

            const { collection, addDoc, updateDoc, doc } = window.firebase.firestoreHelpers;

            if (!addDoc) {
              throw new Error('addDoc function not available');
            }
            if (!updateDoc) {
              throw new Error('updateDoc function not available');
            }
            const db = window.firebase.firestore();

            if (window.currentEditingSellerId) {
              // Update existing seller
              const sellerRef = doc(db, 'vendedores', window.currentEditingSellerId);
              await updateDoc(sellerRef, {
                ...sellerData,
                updatedAt: new Date()
              });
              console.log('‚úÖ Vendedor actualizado:', window.currentEditingSellerId);
            } else {
              // Add new seller
              const sellersCollection = collection(db, 'vendedores');
              const docRef = await addDoc(sellersCollection, {
                ...sellerData,
                createdAt: new Date(),
                updatedAt: new Date()
              });
              console.log('‚úÖ Vendedor agregado:', docRef.id);
            }

            window.closeSellerModal();
            if (window.loadSellers) window.loadSellers();

          } catch (error) {
            console.error('‚ùå Error guardando vendedor:', error);
            alert('Error guardando vendedor. Int√©ntalo de nuevo.');
          }
        });
      }

      // Client form submission
      const clientForm = document.getElementById('clientForm');
      if (clientForm) {
        clientForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          if (!firebase || !firebase.firestore) {
            alert('‚ùå Firebase no est√° disponible');
            return;
          }

          try {
            const saldoCreditoValue = document.getElementById('clientSaldoCredito').value.trim();

            const clienteData = {
              codigo: document.getElementById('clientCodigo').value.trim(),
              nombre: document.getElementById('clientNombre').value.trim(),
              nombreComercial: document.getElementById('clientNombreComercial').value.trim(),
              grupo: document.getElementById('clientGrupo').value.trim(),
              departamento: document.getElementById('clientDepartamento').value.trim(),
              inscripcion: document.getElementById('clientInscripcion').value.trim(),
              nroDocumento: document.getElementById('clientNroDocumento').value.trim(),
              direccion: document.getElementById('clientDireccion').value.trim(),
              ciudad: document.getElementById('clientCiudad').value.trim(),
              provincia: document.getElementById('clientProvincia').value.trim(),
              pais: document.getElementById('clientPais').value.trim(),
              telefono: document.getElementById('clientTelefono').value.trim(),
              email: document.getElementById('clientEmail').value.trim(),
              saldoCredito: saldoCreditoValue ? parseFloat(saldoCreditoValue) : 0,
              listaPrecio: document.getElementById('clientListaPrecio').value || 'precios1'
            };

            if (!clienteData.codigo) {
              alert('‚ö†Ô∏è El c√≥digo es requerido');
              return;
            }

            if (!clienteData.nombre) {
              alert('‚ö†Ô∏è El nombre es requerido');
              return;
            }

            const { doc, setDoc } = firebase.firestoreHelpers;
            const db = firebase.firestore();

            const clienteRef = doc(db, 'clientes', clienteData.codigo);
            await setDoc(clienteRef, clienteData);

            console.log(`‚úÖ Cliente ${clienteData.codigo} guardado`);
            alert(window.currentEditingClientId ? '‚úÖ Cliente actualizado correctamente' : '‚úÖ Cliente agregado correctamente');

            window.closeClientModal();
            loadClients();

          } catch (error) {
            console.error('‚ùå Error guardando cliente:', error);
            alert('‚ùå Error guardando cliente: ' + error.message);
          }
        });
      }

      // Close modals when clicking outside
      window.addEventListener('click', function(event) {
        const sellerModal = document.getElementById('sellerModal');
        const clientModal = document.getElementById('clientModal');
        const confirmModal = document.getElementById('confirmModal');

        if (event.target === sellerModal) {
          window.closeSellerModal();
        }
        if (event.target === clientModal) {
          window.closeClientModal();
        }
        if (event.target === confirmModal) {
          window.closeConfirmModal();
        }
      });

      console.log('‚úÖ Administration page initialized');

      // Auto-load precios if it's the active tab
      setTimeout(() => {
        const activeTab = document.querySelector('.mdc-tab--active');
        if (activeTab && activeTab.getAttribute('data-tab') === 'precios') {
          console.log('üéØ Precios tab is active by default, auto-loading products');
          if (window.loadProducts) {
            window.loadProducts();
          } else {
            console.log('‚ö†Ô∏è loadProducts not ready, will retry...');
            // Retry with increasing delays
            let attempts = 0;
            const tryLoad = () => {
              attempts++;
              if (window.loadProducts) {
                console.log('‚úÖ loadProducts ready, loading now');
                window.loadProducts();
              } else if (attempts < 10) {
                setTimeout(tryLoad, attempts * 500);
              } else {
                console.error('‚ùå Failed to auto-load products after 10 attempts');
              }
            };
            setTimeout(tryLoad, 500);
          }
        }
      }, 2000); // Give everything time to initialize

      // Close order details modal when clicking on X or outside
      const orderDetailsModal = document.getElementById('orderDetailsModal');
      const orderDetailsClose = document.querySelector('.order-details-close');

      if (orderDetailsClose) {
        orderDetailsClose.addEventListener('click', () => {
          orderDetailsModal.style.display = 'none';
        });
      }

      window.addEventListener('click', (event) => {
        if (event.target === orderDetailsModal) {
          orderDetailsModal.style.display = 'none';
        }
      });
    });
  </script>

  <!-- Order Details Modal -->
  <div id="orderDetailsModal" class="order-details-modal">
    <div class="order-details-modal-content">
      <span class="order-details-close">&times;</span>

      <div class="order-details-header">
        <h2 class="order-details-title" id="orderDetailsTitle">Detalles de la Orden</h2>
      </div>

      <div class="order-details-section">
        <h3>üìã Informaci√≥n General</h3>
        <div class="order-details-info">
          <span class="order-details-label">N√∫mero de Orden:</span>
          <span class="order-details-value" id="detailOrderNumber">-</span>
        </div>
        <div class="order-details-info">
          <span class="order-details-label">Cliente:</span>
          <span class="order-details-value" id="detailClientName">-</span>
        </div>
        <div class="order-details-info">
          <span class="order-details-label">Email:</span>
          <span class="order-details-value" id="detailClientEmail">-</span>
        </div>
        <div class="order-details-info">
          <span class="order-details-label">Fecha:</span>
          <span class="order-details-value" id="detailOrderDate">-</span>
        </div>
        <div class="order-details-info">
          <span class="order-details-label">Estado:</span>
          <span class="order-details-value" id="detailOrderState">-</span>
        </div>
        <div class="order-details-info" id="detailAdminCreatedContainer" style="display: none;">
          <span class="order-details-label">Creada por (Admin):</span>
          <span class="order-details-value" id="detailAdminCreated">-</span>
        </div>
      </div>

      <div class="order-details-section">
        <h3>üõí Productos</h3>
        <table class="order-items-table" id="detailOrderTable">
          <thead>
            <tr>
              <th>Art√≠culo</th>
              <th>Descripci√≥n</th>
              <th style="text-align: center;">Cantidad</th>
              <th style="text-align: right;">Precio Unit.</th>
              <th style="text-align: right;">Subtotal</th>
            </tr>
          </thead>
          <tbody id="detailOrderItems">
            <tr>
              <td colspan="5" style="text-align: center;">No hay items</td>
            </tr>
          </tbody>
        </table>
        <div class="order-total">
          <span>TOTAL: </span>
          <span id="detailOrderTotal">$0.00</span>
        </div>
      </div>

      <div class="order-details-section" id="detailSaveOrderContainer" style="display: none;">
        <button class="mdc-button mdc-button--raised" id="detailSaveOrderBtn" style="width: 100%; background-color: #FF9800 !important;">
          <span class="mdc-button__ripple"></span>
          <i class="material-icons mdc-button__icon" aria-hidden="true">save</i>
          <span class="mdc-button__label">Guardar Cambios</span>
        </button>
      </div>

      <div class="order-details-section" id="detailSendWhatsAppContainer" style="display: none;">
        <button class="mdc-button mdc-button--raised" id="detailSendWhatsAppBtn" style="width: 100%; background-color: #25D366 !important;">
          <span class="mdc-button__ripple"></span>
          <i class="material-icons mdc-button__icon" aria-hidden="true">send</i>
          <span class="mdc-button__label">Enviar WhatsApp al Vendedor</span>
        </button>
      </div>

      <div class="order-details-section" id="detailEditOrderContainer" style="display: none;">
        <button class="mdc-button mdc-button--raised" id="detailEditOrderBtn" style="width: 100%; background-color: #4CAF50 !important;">
          <span class="mdc-button__ripple"></span>
          <i class="material-icons mdc-button__icon" aria-hidden="true">shopping_cart</i>
          <span class="mdc-button__label">Seguir Comprando / Editar Orden</span>
        </button>
      </div>
    </div>
  </div>
</body>
</html>