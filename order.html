<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>South Traders</title>
  
  <!-- Material Design CSS -->
  <link href="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { 
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; 
      color-scheme: dark;
      --mdc-theme-primary: #4CAF50;
      --mdc-theme-secondary: #2a2a33;
      --mdc-theme-surface: #1e1e24;
      --mdc-theme-background: #0f0f10;
      --mdc-theme-on-primary: #ffffff;
      --mdc-theme-on-secondary: #ffffff;
      --mdc-theme-on-surface: #f1f1f1;
      --mdc-theme-on-background: #f1f1f1;
    }
    
    /* Material Design custom overrides for better visibility */
    .mdc-tab {
      color: #d0d0d0 !important; /* Color m√°s claro para tabs no seleccionados */
      background-color: #1b1b1f !important;
      border-radius: 6px 6px 0 0 !important;
      border: 1px solid #2a2a2a !important;
      border-bottom: none !important;
      margin-right: 4px !important;
    }
    
    .mdc-tab--active {
      color: #ffffff !important; /* Color para tab seleccionado */
      background-color: #23232a !important;
      font-weight: 600 !important;
    }
    
    .mdc-tab:hover:not(.mdc-tab--active) {
      color: #e8e8e8 !important; /* Color en hover para mejor visibilidad */
      background-color: #2a2a2f !important;
    }
    
    .mdc-tab-indicator__content--underline {
      border-color: #4CAF50 !important;
      border-width: 3px !important;
    }
    
    /* Fix for all text elements that might appear black */
    .mdc-tab__text-label,
    .mdc-button__label,
    .mdc-floating-label,
    .mdc-text-field__input,
    .mdc-form-field > label,
    .mdc-checkbox ~ label,
    span, p, div, h1, h2, h3, h4, h5, h6 {
      color: inherit !important;
    }
    
    /* Specific overrides for Material components */
    .mdc-tab__text-label {
      color: inherit !important;
    }
    
    .mdc-button__label {
      color: inherit !important;
    }
    
    /* Text field improvements */
    .mdc-text-field--outlined {
      background-color: #1b1b1f !important;
      box-shadow: none !important; /* Eliminar cualquier sombra por defecto */
    }
    
    .mdc-text-field--outlined .mdc-notched-outline__leading,
    .mdc-text-field--outlined .mdc-notched-outline__notch,
    .mdc-text-field--outlined .mdc-notched-outline__trailing {
      border-color: #3a3a44 !important;
    }
    
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__leading,
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__notch,
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__trailing {
      border-color: #4CAF50 !important;
    }
    
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__leading,
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__notch,
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__trailing {
      border-color: #4CAF50 !important;
      border-width: 2px !important;
    }
    
    .mdc-text-field__input {
      color: #f1f1f1 !important;
    }
    
    .mdc-floating-label {
      color: #d0d0d0 !important; /* Gris m√°s claro */
    }
    
    .mdc-text-field--focused .mdc-floating-label {
      color: #4CAF50 !important;
    }
    
    /* Button improvements */
    .mdc-button {
      color: #f1f1f1 !important;
    }
    
    .mdc-button--raised {
      background-color: #4CAF50 !important;
      color: #ffffff !important;
    }
    
    .mdc-button--outlined {
      border-color: #3a3a44 !important;
      color: #f1f1f1 !important;
    }
    
    .mdc-button--outlined:hover {
      background-color: #2a2a33 !important;
      border-color: #4CAF50 !important;
    }
    
    /* Checkbox improvements */
    .mdc-checkbox__native-control:enabled:checked ~ .mdc-checkbox__background {
      background-color: #4CAF50 !important;
      border-color: #4CAF50 !important;
    }
    
    .mdc-checkbox__background {
      border-color: #3a3a44 !important;
    }
    
    .mdc-form-field > label {
      color: #f1f1f1 !important;
    }
    
    /* General text color fixes */
    .status {
      color: #d0d0d0 !important;
    }
    
    /* Prevent any black text */
    * {
      color: inherit;
    }
    
    /* Ensure all Material Design components inherit proper colors */
    .mdc-tab *, 
    .mdc-button *, 
    .mdc-text-field *, 
    .mdc-checkbox *,
    .mdc-form-field * {
      color: inherit !important;
    }
    
    body { margin: 0; padding: 20px; background: #0f0f10; color: #f1f1f1; min-height: 100vh; width: 100%; max-width: 100%; overflow-x: hidden; box-sizing: border-box; }
    .order-container { 
      background: #1e1e24; 
      padding: 40px; 
      border-radius: 8px; 
      position: relative; 
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }
    .header { text-align: center; margin-bottom: 30px; }
    .logo { height: auto; margin-bottom: 20px; max-width: 200px; width: 100%; object-fit: contain; }
    h1 { margin-bottom: 10px; color: #4CAF50; }
    .subtitle { color: #b5b5b5; margin-bottom: 30px; }
    
    .order-summary {
      background: #2a2a2f;
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid #3a3a3f;
    }
    
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #3a3a3f;
    }
    
    .summary-title {
      font-size: 20px;
      font-weight: 600;
      color: #4CAF50;
    }
    
    .order-date {
      color: #b5b5b5;
      font-size: 14px;
    }
    
    .products-list {
      margin-bottom: 20px;
    }
    
    .product-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #2a2a2f;
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .product-info {
      flex: 1;
      text-align: left;
    }
    
    .product-name {
      font-weight: 500;
      margin-bottom: 5px;
    }
    
    .product-code {
      color: #b5b5b5;
      font-size: 12px;
      font-family: monospace;
    }
    
    .product-quantity {
      color: #4CAF50;
      font-weight: 500;
      margin: 0 20px;
    }
    
    .product-price {
      color: #f1f1f1;
      font-weight: 500;
      min-width: 80px;
      text-align: right;
    }
    
    .total-section {
      background: #1a1a1f;
      border-radius: 6px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .total-row:last-child {
      margin-bottom: 0;
      padding-top: 15px;
      border-top: 1px solid #3a3a3f;
      font-size: 18px;
      font-weight: 600;
      color: #4CAF50;
    }
    
    .share-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      width: 100%;
    }
    
    .share-btn {
      padding: 15px 25px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s ease;
      text-align: center;
      width: 100%;
      max-width: 300px;
    }
    
    .whatsapp-btn {
      background: #25D366;
      color: white;
    }
    
    .whatsapp-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);
    }
    
    .confirm-order-btn {
      background: #4CAF50;
      color: white;
    }

    .confirm-order-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
    }
    
    .continue-btn {
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
      padding: 15px 25px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .continue-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
    }
    
    .empty-cart {
      text-align: center;
      padding: 40px 20px;
      color: #b5b5b5;
    }
    
    .empty-cart-icon {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    /* === HAMBURGER MENU === */
    .hamburger-btn {
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      z-index: 1001 !important;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #4CAF50, #45a049) !important;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex !important;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    .hamburger-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }
    
    .hamburger-line {
      width: 20px;
      height: 2px;
      background: white !important;
      border-radius: 1px;
      transition: all 0.3s ease;
      display: block !important;
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(1) {
      transform: rotate(45deg) translate(6px, 6px);
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(2) {
      opacity: 0;
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }
    
    /* === SLIDE MENU === */
    .slide-menu {
      position: fixed !important;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      z-index: 1000 !important;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }
    
    .slide-menu.active {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    
    .slide-menu-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
    }
    
    .slide-menu-content {
      position: absolute;
      top: 0;
      right: 0;
      width: 400px;
      height: 100%;
      background: #1e1e24;
      border-left: 1px solid #3a3a3f;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .slide-menu.active .slide-menu-content {
      transform: translateX(0);
    }
    
    .slide-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #3a3a3f;
    }
    
    .slide-menu-header h3 {
      margin: 0;
      color: #4CAF50;
      font-size: 20px;
    }
    
    .close-menu-btn {
      background: none;
      border: none;
      color: #b5b5b5;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      transition: color 0.3s ease;
    }
    
    .close-menu-btn:hover {
      color: #f1f1f1;
    }
    
    /* === MENU TABS === */
    .menu-sections {
      display: flex;
      margin-bottom: 25px;
      border-radius: 8px;
      background: #2a2a2f;
      overflow: hidden;
    }
    
    .menu-btn {
      width: 100%;
      padding: 16px 20px;
      border: none;
      background: #2a2a33;
      color: #f0f0f0;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      margin-bottom: 8px;
      border-radius: 6px;
    }
    
    .menu-btn:hover {
      background: #4CAF50;
      color: white;
      transform: translateX(4px);
    }

    .menu-sections {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 0;
    }

    /* Historial Modal Styles */
    .historial-content {
      max-height: 60vh;
      overflow-y: auto;
    }

    .historial-header {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: flex-end;
    }

    .clear-historial-btn,
    .export-historial-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .clear-historial-btn {
      background: #f44336;
      color: white;
    }

    .clear-historial-btn:hover {
      background: #d32f2f;
    }

    .export-historial-btn {
      background: #4CAF50;
      color: white;
    }

    .export-historial-btn:hover {
      background: #45a049;
    }

    .historial-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .no-historial {
      text-align: center;
      padding: 40px 20px;
      color: #b5b5b5;
    }

    .no-historial p {
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .no-historial small {
      font-size: 12px;
      color: #888;
    }

    .historial-item {
      background: #2a2a33;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .historial-item:hover {
      background: #3a3a44;
      transform: translateX(4px);
    }

    .historial-items-preview {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #3a3a44;
      color: #b5b5b5;
    }

    .historial-items-preview small {
      margin-right: 8px;
    }

    .historial-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .historial-date {
      font-size: 12px;
      color: #b5b5b5;
    }

    .historial-method {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      background: #4CAF50;
      color: white;
    }

    .historial-summary {
      font-size: 14px;
      color: #f0f0f0;
    }

    .historial-user {
      font-size: 12px;
      color: #4CAF50;
      margin-top: 4px;
      font-weight: 500;
    }
    
    .menu-icon {
      font-size: 16px;
    }
    
    /* Logistics Modal Styles */
    .logistics-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .logistics-section {
      background: #2a2a33;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #3a3a44;
    }

    .logistics-section h4 {
      margin: 0 0 12px 0;
      color: #4CAF50;
      font-size: 16px;
    }

    .logistics-info {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .logistics-info p {
      margin: 0;
      color: #b5b5b5;
      line-height: 1.4;
    }

    .logistics-btn {
      padding: 10px 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
      align-self: flex-start;
    }

    .logistics-btn:hover {
      background: #45a049;
      transform: translateY(-1px);
    }
    
    /* === CONFIG SECTION === */
    .menu-content h4 {
      color: #4CAF50;
      margin: 20px 0 15px 0;
      font-size: 16px;
      border-bottom: 1px solid #3a3a3f;
      padding-bottom: 8px;
    }
    
    .config-group {
      margin-bottom: 20px;
    }
    
    .config-group label {
      display: block;
      color: #f1f1f1;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .config-group input,
    .config-group select {
      width: 100%;
      padding: 12px;
      background: #2a2a2f;
      border: 1px solid #3a3a3f;
      border-radius: 6px;
      color: #f1f1f1;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    
    .config-group input:focus,
    .config-group select:focus {
      outline: none;
      border-color: #4CAF50;
    }
    
    .config-group small {
      color: #b5b5b5;
      font-size: 12px;
      margin-top: 4px;
      display: block;
    }
    
    .refresh-input-group {
      display: flex;
      gap: 10px;
    }
    
    .refresh-input-group input {
      flex: 1;
    }
    
    .refresh-input-group select {
      flex: 1;
    }
    
    .config-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 30px;
    }
    
    .save-config-btn,
    .reset-config-btn,
    .refresh-stats-btn,
    .clear-stats-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .save-config-btn {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
    }
    
    .save-config-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    
    .reset-config-btn {
      background: #6c757d;
      color: white;
    }
    
    .reset-config-btn:hover {
      background: #5a6268;
    }
    
    /* === STATS SECTION === */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .stat-item {
      background: #2a2a2f;
      padding: 15px;
      border-radius: 6px;
      border-left: 3px solid #4CAF50;
    }
    
    .stat-label {
      color: #b5b5b5;
      font-size: 12px;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      color: #f1f1f1;
      font-size: 18px;
      font-weight: 600;
    }
    
    .stats-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .refresh-stats-btn {
      background: linear-gradient(135deg, #2196F3, #1976D2);
      color: white;
    }
    
    .refresh-stats-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }
    
    .clear-stats-btn {
      background: #dc3545;
      color: white;
    }
    
    .clear-stats-btn:hover {
      background: #c82333;
    }
    
    /* === MOBILE RESPONSIVE STYLES === */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .order-container {
        padding: 20px 15px;
        margin: 0;
      }

      .logo {
        max-width: 150px;
      }

      h1 {
        font-size: 22px;
      }

      .subtitle {
        font-size: 14px;
      }

      .order-summary {
        padding: 20px 15px;
      }

      .summary-title {
        font-size: 18px;
      }

      .order-date {
        font-size: 12px;
      }

      .share-section {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .share-btn {
        padding: 12px 20px;
        font-size: 14px;
        max-width: 100%;
      }

      .continue-btn {
        padding: 12px 20px;
        font-size: 14px;
        max-width: 100%;
      }

      .product-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        padding: 15px 0;
      }

      .product-name {
        font-size: 14px;
      }

      .product-code {
        font-size: 11px;
      }

      .product-quantity,
      .product-price {
        margin: 0;
        align-self: flex-end;
        font-size: 14px;
      }

      .total-section {
        padding: 15px;
      }

      .total-row {
        font-size: 14px;
      }

      .total-row:last-child {
        font-size: 16px;
      }

      .hamburger-btn {
        top: 15px;
        right: 15px;
        width: 45px;
        height: 45px;
      }

      .slide-menu-content {
        width: 85%;
        max-width: 350px;
      }

      .modal-content {
        width: 90%;
        padding: 15px;
      }

      .version-btn {
        top: 10px;
        right: 10px;
        font-size: 11px;
        padding: 3px 6px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 5px;
      }

      .order-container {
        padding: 15px 10px;
      }

      .logo {
        max-width: 120px;
      }

      h1 {
        font-size: 20px;
      }

      .subtitle {
        font-size: 13px;
      }

      .order-summary {
        padding: 15px 12px;
      }

      .summary-title {
        font-size: 16px;
      }

      .product-item {
        padding: 12px 0;
      }

      .product-name {
        font-size: 13px;
      }

      .product-code {
        font-size: 10px;
      }

      .product-quantity,
      .product-price {
        font-size: 13px;
      }

      .total-section {
        padding: 12px;
      }

      .total-row {
        font-size: 13px;
      }

      .total-row:last-child {
        font-size: 15px;
      }

      .share-btn,
      .continue-btn {
        padding: 10px 15px;
        font-size: 13px;
      }

      .hamburger-btn {
        width: 42px;
        height: 42px;
      }

      .slide-menu-content {
        width: 90%;
      }

      .modal-content {
        width: 95%;
        padding: 12px;
      }

      .empty-cart-icon {
        font-size: 36px;
      }

      .empty-cart {
        padding: 30px 15px;
        font-size: 14px;
      }
    }
    
    .version-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #2a2a33;
      color: #f1f1f1;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid #3a3a44;
      transition: background-color 0.2s;
    }
    
    .version-btn:hover {
      background: #3a3a44;
    }
    
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    .modal:not(.hidden) {
      display: flex;
    }
    
    .modal-content {
      background-color: #1e1e24;
      margin: auto;
      padding: 20px;
      border: 1px solid #2a2a2a;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
      position: relative;
      color: #f1f1f1;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 20px;
      cursor: pointer;
    }
    
    .close-button:hover {
      color: #f1f1f1;
    }
    
    .version-section {
      margin-bottom: 24px;
      padding: 16px;
      background: #15151a;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
    }
    
    .version-section h3 {
      margin: 0 0 12px 0;
      color: #4CAF50;
      font-size: 16px;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 8px;
    }
    
    .version-section ul {
      margin: 0;
      padding-left: 20px;
      color: #e6e6e6;
    }
    
    .version-section li {
      margin-bottom: 8px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="order-container">
    <span id="versionBtn" class="version-btn">v0.15</span>
    
    <div class="header">
      <img src="logo.png" alt="Logo" class="logo">
            <p class="subtitle">Revisa tu pedido y env√≠a los detalles</p>
    </div>
    
    <div class="order-summary" id="orderSummary">
      <div class="summary-header">
        <div class="summary-title">üõí Tu Pedido</div>
        <div class="order-date" id="orderDate"></div>
      </div>
      
      <div class="products-list" id="productsList">
        <!-- Los productos se cargar√°n din√°micamente -->
      </div>
      
      <div class="total-section" id="totalSection">
        <!-- Los totales se cargar√°n din√°micamente -->
      </div>
    </div>
    
    <div class="share-section">
      <button class="share-btn confirm-order-btn" id="confirmOrderBtn">
        <span style="font-size: 20px;">‚úÖ</span>
        Confirmar Orden
      </button>
    </div>
    
    <a href="marketplace.html" class="continue-btn">üõí Seguir Comprando</a>
  </div>

  <!-- Hamburger Menu Button (outside container) -->
  <button class="hamburger-btn" id="hamburgerBtn">
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
  </button>

  <!-- Slide-in Menu -->
  <div class="slide-menu" id="slideMenu">
    <div class="slide-menu-overlay" id="slideMenuOverlay"></div>
    <div class="slide-menu-content">
      <div class="slide-menu-header">
        <h3>‚öôÔ∏è Menu</h3>
        <button class="close-menu-btn" id="closeMenuBtn">&times;</button>
      </div>
      
      <div class="menu-sections">
        <button class="menu-btn" id="configModalBtn">
          <span class="menu-icon">üîß</span>
          CONFIG
        </button>
        <button class="menu-btn" id="statsModalBtn">
          <span class="menu-icon">üìä</span>
          STATS
        </button>
        <button class="menu-btn" id="profileModalBtn">
          <span class="menu-icon">üë§</span>
          PROFILE
        </button>
        <button class="menu-btn" id="historialModalBtn">
          <span class="menu-icon">üìã</span>
          HISTORIAL
        </button>
        <button class="menu-btn" id="logisticsModalBtn">
          <span class="menu-icon">üöö</span>
          LOGISTICS
        </button>
      </div>
      
    </div>
  </div>

  <div id="changelogModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Changelog - Historial de Versiones</h2>
      <div id="changelogContent">

        <div class="version-section">
          <h3>v0.15 - Actual</h3>
          <ul>
            <li>‚öôÔ∏è <strong>P√°gina de Administraci√≥n completamente funcional</strong></li>
            <li>üí∞ <strong>Gesti√≥n de Precios:</strong> Listado completo de productos con 4 precios editables</li>
            <li>üì§ <strong>Importar Precios:</strong> Soporte para archivos CSV y Excel (.xlsx/.xls)</li>
            <li>üì• <strong>Exportar Precios:</strong> Descarga en formato CSV y Excel con formato profesional</li>
            <li>üíæ <strong>Guardado Autom√°tico:</strong> Los precios se guardan en Firebase instant√°neamente</li>
            <li>üìã <strong>Gesti√≥n de √ìrdenes Master:</strong> Sistema completo de seguimiento de √≥rdenes</li>
            <li>üîÑ <strong>Estados de Orden:</strong> A Confirmar ‚Üí En Preparaci√≥n ‚Üí En Camino ‚Üí Entregado</li>
            <li>üë• <strong>Gesti√≥n de Vendedores:</strong> Sistema completo de alta, edici√≥n y eliminaci√≥n</li>
            <li>üè¢ <strong>Gesti√≥n de Clientes:</strong> Administraci√≥n de clientes con asignaci√≥n de vendedores</li>
            <li>üé® <strong>Animaciones de Carga:</strong> Spinners elegantes durante procesos largos</li>
            <li>üîÑ <strong>Auto-carga Inteligente:</strong> Datos se cargan autom√°ticamente al cambiar pesta√±as</li>
            <li>üìä <strong>Estad√≠sticas en Tiempo Real:</strong> Contadores autom√°ticos por cada secci√≥n</li>
            <li>üõ°Ô∏è <strong>Manejo Robusto de Errores:</strong> Validaciones y recuperaci√≥n autom√°tica</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.11</h3>
          <ul>
            <li>üõí <strong>Sistema de confirmaci√≥n de √≥rdenes implementado</strong></li>
            <li>üìß Eliminados botones de env√≠o por WhatsApp y Email</li>
            <li>‚úÖ Nuevo bot√≥n √∫nico "Confirmar Orden" con numeraci√≥n autom√°tica</li>
            <li>üî¢ Numeraci√≥n de √≥rdenes comenzando desde #10000, #10001, etc.</li>
            <li>üìã Historial mejorado con n√∫meros de orden y informaci√≥n del usuario</li>
            <li>üë§ Visualizaci√≥n de qui√©n realiz√≥ cada orden en el historial</li>
            <li>üîß Campo de cantidad editable manualmente en marketplace</li>
            <li>‚å®Ô∏è Input num√©rico para ingresar cantidades altas (50, 100, etc.)</li>
            <li>üîÑ Compatibilidad mejorada entre Firebase v10 modular y compat SDK</li>
            <li>üóëÔ∏è Funciones de limpiar y exportar historial completamente implementadas</li>
            <li>üìä Exportaci√≥n a CSV con datos completos de √≥rdenes</li>
            <li>üõ°Ô∏è Manejo de errores robusto para evitar bloqueos de interfaz</li>
            <li>üéØ Flujo simplificado: confirmar ‚Üí n√∫mero √∫nico ‚Üí historial ‚Üí redirect</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.10 - Sistema de Permisos</h3>
          <ul>
            <li>üîê <strong>Sistema de permisos de usuario implementado</strong></li>
            <li>üë§ Control de acceso basado en Firebase (campo admin)</li>
            <li>üöö Bot√≥n LOGISTICS agregado al men√∫ hamburguesa</li>
            <li>üì¶ Modal de logistics con 3 secciones: Shipping, Inventory, Routes</li>
            <li>üö´ Usuarios no-admin: solo acceso a HISTORIAL y LOGISTICS</li>
            <li>‚úÖ Usuarios admin: acceso completo a CONFIG, STATS, HISTORIAL, LOGISTICS</li>
            <li>üõ°Ô∏è Manejo de errores con permisos restrictivos por seguridad</li>
            <li>üìã Logging detallado para debugging de permisos</li>
            <li>üéØ Consistencia con marketplace.html e index.html</li>
            <li>‚öôÔ∏è Integraci√≥n autom√°tica con onAuthStateChanged</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.9 - Men√∫ Administrativo</h3>
          <ul>
            <li>üçî <strong>Men√∫ hamburguesa deslizante implementado</strong></li>
            <li>‚öôÔ∏è Secci√≥n CONFIG para configurar WhatsApp, Email y empresa</li>
            <li>üîÑ Configuraci√≥n de tiempo de refresco (segundos/minutos/horas)</li>
            <li>üìä Secci√≥n STATS con estad√≠sticas del sistema en tiempo real</li>
            <li>üíæ Persistencia de configuraci√≥n con localStorage</li>
            <li>üéõÔ∏è Validaciones y mensajes de confirmaci√≥n mejorados</li>
            <li>üì± Animaciones suaves y dise√±o responsive del men√∫</li>
            <li>üîÑ Bot√≥n "Restaurar" y "Limpiar Datos" para gesti√≥n</li>
            <li>‚å®Ô∏è Cerrar men√∫ con tecla Escape</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.8 - Resumen de Orden</h3>
          <ul>
            <li>üîÑ Redise√±o completo de la p√°gina de orden</li>
            <li>‚ùå Eliminado sistema de pago crypto y QR codes</li>
            <li>üìã Nuevo resumen detallado de productos del carrito</li>
            <li>üí¨ Bot√≥n "Enviar por WhatsApp" con mensaje formateado</li>
            <li>üìß Bot√≥n "Enviar por Email" con orden completa</li>
            <li>üõí Carga autom√°tica de productos desde localStorage</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.7 - Sistema de Pago Crypto (Discontinuado)</h3>
          <ul>
            <li>üí∞ Sistema de pago crypto implementado</li>
            <li>üîó QR code con address USDT (BSC) para pagos</li>
            <li>üìù Campo para hash de transacci√≥n con validaci√≥n</li>
            <li>üìã Funci√≥n de copia de address al clipboard</li>
            <li>üéØ Validaci√≥n autom√°tica de formato de hash</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.6 - Marketplace Mejorado</h3>
          <ul>
            <li>üö™ Bot√≥n Logout funcional en marketplace</li>
            <li>üî¥ Valores en 0 mostrados en color rojo</li>
            <li>üìä KPIs integrados en marketplace (Total Productos, Stock, Transit)</li>
            <li>üé® Botones Add to Cart din√°micos (blanco‚Üírojo con cantidad)</li>
            <li>0Ô∏è‚É£ Quantity por defecto en 0 en lugar de 1</li>
            <li>üîß L√≥gica mejorada para actualizaci√≥n visual de botones</li>
            <li>üéØ Estilos consistentes entre p√°ginas</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.5 - Identidad Visual</h3>
          <ul>
            <li>üé® Logo unificado (logo.png) en todas las p√°ginas</li>
            <li>üñºÔ∏è Tama√±o natural del logo sin restricciones</li>
            <li>‚öñÔ∏è Comparaci√≥n visual de logos implementada</li>
            <li>üîÑ Dise√±o consistente en headers y p√°ginas centradas</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.4 - Autenticaci√≥n Firebase</h3>
          <ul>
            <li>üîê Integraci√≥n completa con Firebase Authentication</li>
            <li>üìß Login con email/password</li>
            <li>üåê Login con Google (OAuth)</li>
            <li>üë§ Registro de nuevos usuarios</li>
            <li>üîí Manejo de sesiones con localStorage</li>
            <li>üö® Manejo avanzado de errores en espa√±ol</li>
            <li>üîÑ Redirecciones autom√°ticas post-autenticaci√≥n</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.3 - Funcionalidades Base</h3>
          <ul>
            <li>üì§ Funcionalidad de exportaci√≥n a Excel</li>
            <li>üîÑ Auto-refresh cada 90 segundos</li>
            <li>üåô Tema oscuro mejorado</li>
            <li>üîç Sistema de filtros por columnas</li>
            <li>üì± Optimizaci√≥n responsive</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.2 - Estructura Inicial</h3>
          <ul>
            <li>üîê Sistema de autenticaci√≥n b√°sico</li>
            <li>üìã Tabs de categor√≠as (All, iPhone, MacBooks, Samsung)</li>
            <li>üîç B√∫squeda por modelo</li>
            <li>üìä Tabla de inventario estructurada</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>v0.1 - Primera Versi√≥n</h3>
          <ul>
            <li>üéâ Lanzamiento inicial del sistema</li>
            <li>üìä Interfaz b√°sica de inventario</li>
            <li>üåô Dise√±o con tema oscuro</li>
            <li>üì± Responsividad b√°sica</li>
          </ul>
        </div>

      </div>
    </div>
  </div>

  <!-- CONFIG Modal -->
  <div id="configModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>üîß Configuraci√≥n</h2>
      
      <h4>üìû Configuraci√≥n de Contactos</h4>
      
      <div class="config-group">
        <label for="whatsappInput">WhatsApp (con c√≥digo de pa√≠s)</label>
        <input type="tel" id="whatsappInput" placeholder="Ej: 5491123456789" maxlength="15">
        <small>Sin +, espacios o guiones</small>
      </div>
      
      <div class="config-group">
        <label for="emailInput">Email para Pedidos</label>
        <input type="email" id="emailInput" placeholder="ventas@empresa.com">
      </div>
      
      <div class="config-group">
        <label for="companyInput">Nombre de Empresa</label>
        <input type="text" id="companyInput" placeholder="Mi Empresa">
      </div>
      
      <h4>üîÑ Configuraci√≥n de Refresco</h4>
      
      <div class="config-group">
        <label for="refreshTime">Tiempo de Auto-refresco</label>
        <div class="refresh-input-group">
          <input type="number" id="refreshValue" min="1" max="999" value="30">
          <select id="refreshUnit">
            <option value="seconds">Segundos</option>
            <option value="minutes">Minutos</option>
            <option value="hours">Horas</option>
          </select>
        </div>
      </div>
      
      <div class="config-actions">
        <button class="save-config-btn" id="saveConfigBtn">üíæ Guardar Configuraci√≥n</button>
        <button class="reset-config-btn" id="resetConfigBtn">üîÑ Restaurar</button>
      </div>
    </div>
  </div>

  <!-- STATS Modal -->
  <div id="statsModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>üìä Estad√≠sticas</h2>
      
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">√öltimo refresco</div>
          <div class="stat-value" id="lastRefreshStat">-</div>
        </div>
        
        <div class="stat-item">
          <div class="stat-label">Total productos cargados</div>
          <div class="stat-value" id="totalProductsStat">0</div>
        </div>
        
        <div class="stat-item">
          <div class="stat-label">Items en carrito</div>
          <div class="stat-value" id="cartItemsStat">0</div>
        </div>
        
        <div class="stat-item">
          <div class="stat-label">Valor total carrito</div>
          <div class="stat-value" id="cartValueStat">$0</div>
        </div>
        
        <div class="stat-item">
          <div class="stat-label">Tiempo de refresco</div>
          <div class="stat-value" id="refreshTimeStat">90s</div>
        </div>
        
        <div class="stat-item">
          <div class="stat-label">Configuraci√≥n guardada</div>
          <div class="stat-value" id="configSavedStat">‚ùå</div>
        </div>
      </div>
      
      <div class="stats-actions">
        <button class="refresh-stats-btn" id="refreshStatsBtn">üîÑ Actualizar Stats</button>
        <button class="clear-stats-btn" id="clearStatsBtn">üóëÔ∏è Limpiar Datos</button>
      </div>
    </div>
  </div>

  <!-- HISTORIAL Modal -->
  <div id="historialModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>üìã Historial de Pedidos</h2>
      
      <div class="historial-content">
        <div class="historial-header">
          <button class="clear-historial-btn" id="clearHistorialBtn">üóëÔ∏è Limpiar Historial</button>
          <button class="export-historial-btn" id="exportHistorialBtn">üì§ Exportar</button>
        </div>
        
        <div class="historial-list" id="historialList">
          <div class="no-historial">
            <p>üìù No hay pedidos en el historial</p>
            <small>Los pedidos enviados por WhatsApp/Email aparecer√°n aqu√≠</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGISTICS Modal -->
  <div id="logisticsModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>üöö Logistics</h2>
      
      <div class="logistics-content">
        <div class="logistics-section">
          <h4>Shipping Status</h4>
          <div class="logistics-info">
            <p>Track and manage shipping information for orders.</p>
            <button class="logistics-btn" id="trackOrdersBtn">Track Orders</button>
          </div>
        </div>
        
        <div class="logistics-section">
          <h4>Inventory Management</h4>
          <div class="logistics-info">
            <p>Manage stock levels and inventory updates.</p>
            <button class="logistics-btn" id="inventoryBtn">Manage Inventory</button>
          </div>
        </div>
        
        <div class="logistics-section">
          <h4>Delivery Routes</h4>
          <div class="logistics-info">
            <p>Optimize delivery routes and schedules.</p>
            <button class="logistics-btn" id="routesBtn">View Routes</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script>
    // ==========================================
    // üî• INICIALIZACI√ìN DE FIREBASE
    // ==========================================
    
    // Configuraci√≥n de Firebase (debe coincidir con marketplace.html)
    const firebaseConfig = {
      apiKey: "AIzaSyCXjSGtVGfQas_cEyjmI0RTaeEl94jdp6g",
      authDomain: "carrito-138c3.firebaseapp.com",
      projectId: "carrito-138c3",
      storageBucket: "carrito-138c3.appspot.com",
      messagingSenderId: "579670725719",
      appId: "1:579670725719:web:carrito138c3"
    };

    // Inicializar Firebase usando el SDK de compatibilidad
    if (typeof firebase !== 'undefined') {
      firebase.initializeApp(firebaseConfig);
      console.log('üî• Firebase inicializado correctamente en order.html');
      
      // Configurar Firestore settings si es necesario
      if (firebase.firestore) {
        firebase.firestore().settings({
          cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
        });
      }
    } else {
      console.error('‚ùå Firebase SDK no est√° cargado');
    }
  </script>
  
  <script src="main.js"></script>
  <script>
    // ==========================================
    // üîß CONFIGURACI√ìN DE CONTACTOS
    // ==========================================
    // Cambia estos valores para precargar los contactos:
    
    const CONTACT_CONFIG = {
      // WhatsApp: n√∫mero con c√≥digo de pa√≠s (sin +, sin espacios, sin guiones)
      // Ejemplos:
      // Argentina: '5491123456789'  
      // Espa√±a: '34612345678'
      // M√©xico: '521234567890' 
      // USA: '15551234567'
      whatsappNumber: '1234567890', // ‚ö†Ô∏è CAMBIAR POR N√öMERO REAL
      
      // Email: direcci√≥n de email de destino  
      email: 'ventas@empresa.com', // ‚ö†Ô∏è CAMBIAR POR EMAIL REAL
      
      // Nombre de la empresa (opcional, aparece en los mensajes)
      companyName: '√ñppen Store'
    };
    
    // ==========================================
    // ‚úÖ Una vez configurado, los botones enviar√°n
    //    directamente sin pedir confirmaci√≥n
    // ==========================================

    // ==========================================
    // üî• CONFIGURACI√ìN DE FIREBASE
    // ==========================================
    
    // Verificar que Firebase est√© disponible (ya fue inicializado arriba)
    if (typeof firebase === 'undefined') {
      console.error('‚ùå Firebase no est√° cargado');
    } else {
      console.log('‚úÖ Firebase disponible y configurado');
    }

    // Usuario actual (se obtiene del authentication)
    let currentUser = null;

    // Verificar autenticaci√≥n al cargar la p√°gina
    if (firebase.auth) {
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          currentUser = user;
          console.log('‚úÖ Usuario autenticado:', user.email);
        } else {
          console.warn('‚ö†Ô∏è Usuario no autenticado');
          currentUser = null;
        }
      });
    }

    // === CONFIGURACI√ìN CON LOCALSTORAGE ===
    let APP_CONFIG = {
      whatsappNumber: '1234567890',
      email: 'ventas@empresa.com', 
      companyName: '√ñppen Store',
      refreshTime: 30,
      refreshUnit: 'seconds'
    };

    // Cargar configuraci√≥n desde Firebase
    async function loadConfigFromFirebase() {
      try {
        if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
          const user = firebase.auth().currentUser;
          const configDoc = await firebase.firestore()
            .collection('configuracion')
            .doc(user.uid)
            .get();
          
          if (configDoc.exists) {
            const firebaseConfig = configDoc.data();
            APP_CONFIG = { ...APP_CONFIG, ...firebaseConfig };
            
            console.log('‚úÖ Configuraci√≥n cargada desde Firebase:', APP_CONFIG);
            
            // Actualizar CONTACT_CONFIG con los nuevos datos
            updateContactConfig();
            
            // Actualizar labels de botones
            updateButtonLabels();
            
            return true;
          } else {
            console.log('‚ö†Ô∏è No se encontr√≥ configuraci√≥n en Firebase para el usuario');
          }
        }
      } catch (error) {
        console.error('‚ùå Error cargando configuraci√≥n desde Firebase:', error);
      }
      
      return false;
    }

    // Cargar configuraci√≥n desde localStorage
    function loadAppConfig() {
      const savedConfig = localStorage.getItem('appConfig');
      if (savedConfig) {
        try {
          const parsed = JSON.parse(savedConfig);
          APP_CONFIG = { ...APP_CONFIG, ...parsed };
          console.log('Configuraci√≥n cargada:', APP_CONFIG);
        } catch (error) {
          console.error('Error loading config:', error);
        }
      }
      updateContactConfig();
    }

    // Guardar configuraci√≥n en localStorage
    function saveAppConfig() {
      localStorage.setItem('appConfig', JSON.stringify(APP_CONFIG));
      console.log('Configuraci√≥n guardada:', APP_CONFIG);
    }

    // Actualizar CONTACT_CONFIG con la nueva configuraci√≥n
    function updateContactConfig() {
      CONTACT_CONFIG.whatsappNumber = APP_CONFIG.whatsappNumber;
      CONTACT_CONFIG.email = APP_CONFIG.email;
      CONTACT_CONFIG.companyName = APP_CONFIG.companyName;
    }

    // Actualizar labels de botones con la configuraci√≥n
    function updateButtonLabels() {
      // Esta funci√≥n puede ser expandida en el futuro si se requiere
      // actualizar din√°micamente los labels de los botones
      console.log('üìù Labels de botones actualizados');
    }

    // Calcular tiempo de refresco en milisegundos
    function getRefreshTimeMs() {
      let time = APP_CONFIG.refreshTime;
      switch (APP_CONFIG.refreshUnit) {
        case 'minutes':
          return time * 60 * 1000;
        case 'hours':
          return time * 60 * 60 * 1000;
        default: // seconds
          return time * 1000;
      }
    }

    // === HAMBURGER MENU FUNCTIONALITY ===
    let menuOpen = false;

    function toggleMenu() {
      const slideMenu = document.getElementById('slideMenu');
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      
      menuOpen = !menuOpen;
      
      if (menuOpen) {
        slideMenu.classList.add('active');
        hamburgerBtn.classList.add('active');
        updateConfigInputs();
        updateStats();
      } else {
        slideMenu.classList.remove('active');
        hamburgerBtn.classList.remove('active');
      }
    }

    function closeMenu() {
      if (menuOpen) {
        toggleMenu();
      }
    }

    // Funciones para abrir modales
    function openModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
      if (modalId === 'statsModal') {
        updateStats();
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    function closeAllModals() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.add('hidden');
      });
    }

    // Actualizar inputs de configuraci√≥n con valores actuales
    function updateConfigInputs() {
      document.getElementById('whatsappInput').value = APP_CONFIG.whatsappNumber;
      document.getElementById('emailInput').value = APP_CONFIG.email;
      document.getElementById('companyInput').value = APP_CONFIG.companyName;
      document.getElementById('refreshValue').value = APP_CONFIG.refreshTime;
      document.getElementById('refreshUnit').value = APP_CONFIG.refreshUnit;
    }

    // Guardar configuraci√≥n desde inputs
    function saveConfigFromInputs() {
      const whatsapp = document.getElementById('whatsappInput').value.trim();
      const email = document.getElementById('emailInput').value.trim();
      const company = document.getElementById('companyInput').value.trim();
      const refreshValue = parseInt(document.getElementById('refreshValue').value);
      const refreshUnit = document.getElementById('refreshUnit').value;
      
      // Validaciones b√°sicas
      if (whatsapp && !/^\d{10,15}$/.test(whatsapp)) {
        alert('‚ö†Ô∏è El n√∫mero de WhatsApp debe tener entre 10-15 d√≠gitos (solo n√∫meros)');
        return;
      }
      
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        alert('‚ö†Ô∏è Por favor ingresa un email v√°lido');
        return;
      }
      
      if (!refreshValue || refreshValue < 1 || refreshValue > 999) {
        alert('‚ö†Ô∏è El tiempo de refresco debe ser entre 1 y 999');
        return;
      }
      
      // Actualizar configuraci√≥n
      APP_CONFIG.whatsappNumber = whatsapp || APP_CONFIG.whatsappNumber;
      APP_CONFIG.email = email || APP_CONFIG.email;
      APP_CONFIG.companyName = company || APP_CONFIG.companyName;
      APP_CONFIG.refreshTime = refreshValue;
      APP_CONFIG.refreshUnit = refreshUnit;
      
      // Guardar y aplicar
      saveAppConfig();
      updateContactConfig();
      updateButtonLabels();
      
      // Mensaje de confirmaci√≥n
      const saveBtn = document.getElementById('saveConfigBtn');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = '‚úÖ ¬°Guardado!';
      saveBtn.style.background = '#28a745';
      
      setTimeout(() => {
        saveBtn.textContent = originalText;
        saveBtn.style.background = '';
      }, 2000);
      
      console.log('Configuraci√≥n actualizada:', APP_CONFIG);
    }

    // Restaurar configuraci√≥n por defecto
    function resetConfig() {
      if (confirm('¬øEst√°s seguro de que quieres restaurar la configuraci√≥n por defecto?')) {
        APP_CONFIG = {
          whatsappNumber: '1234567890',
          email: 'ventas@empresa.com',
          companyName: '√ñppen Store',
          refreshTime: 30,
          refreshUnit: 'seconds'
        };
        
        saveAppConfig();
        updateContactConfig();
        updateConfigInputs();
        updateButtonLabels();
        
        alert('‚úÖ Configuraci√≥n restaurada');
      }
    }

    // Actualizar estad√≠sticas
    function updateStats() {
      // √öltimo refresco
      const lastRefresh = localStorage.getItem('lastRefreshTime');
      document.getElementById('lastRefreshStat').textContent = lastRefresh ? 
        new Date(lastRefresh).toLocaleTimeString() : 'Nunca';
      
      // Total productos (esto se actualizar√≠a desde main.js)
      document.getElementById('totalProductsStat').textContent = '0'; // Placeholder
      
      // Items en carrito
      const cartData = localStorage.getItem('cart');
      let cartItems = 0;
      let cartValue = 0;
      
      if (cartData) {
        try {
          const cart = JSON.parse(cartData);
          cartItems = cart.reduce((sum, item) => sum + item.quantity, 0);
          cartValue = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        } catch (e) {
          console.error('Error parsing cart:', e);
        }
      }
      
      document.getElementById('cartItemsStat').textContent = cartItems;
      document.getElementById('cartValueStat').textContent = '$' + formatNumber(cartValue);
      
      // Tiempo de refresco
      const refreshTimeMs = getRefreshTimeMs();
      let refreshDisplay = '';
      if (refreshTimeMs < 60000) {
        refreshDisplay = (refreshTimeMs / 1000) + 's';
      } else if (refreshTimeMs < 3600000) {
        refreshDisplay = (refreshTimeMs / 60000) + 'm';
      } else {
        refreshDisplay = (refreshTimeMs / 3600000) + 'h';
      }
      document.getElementById('refreshTimeStat').textContent = refreshDisplay;
      
      // Configuraci√≥n guardada
      const hasConfig = localStorage.getItem('appConfig');
      document.getElementById('configSavedStat').textContent = hasConfig ? '‚úÖ' : '‚ùå';
    }

    // Limpiar datos del sistema
    function clearSystemData() {
      if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres limpiar TODOS los datos guardados?\n\nEsto incluye:\n- Configuraci√≥n\n- Carrito de compras\n- Estad√≠sticas')) {
        localStorage.clear();
        
        // Restaurar configuraci√≥n por defecto
        APP_CONFIG = {
          whatsappNumber: '1234567890',
          email: 'ventas@empresa.com',
          companyName: '√ñppen Store',
          refreshTime: 30,
          refreshUnit: 'seconds'
        };
        
        updateContactConfig();
        updateConfigInputs();
        updateButtonLabels();
        updateStats();
        
        alert('üóëÔ∏è Todos los datos han sido eliminados');
      }
    }

    // ==========================================
    // üìã FUNCIONES DE HISTORIAL CON FIREBASE
    // ==========================================

    // Generar n√∫mero de orden √∫nico
    function generateOrderNumber() {
      const lastOrderNumber = localStorage.getItem('lastOrderNumber');
      let orderNumber;

      if (lastOrderNumber) {
        orderNumber = parseInt(lastOrderNumber) + 1;
      } else {
        orderNumber = 10000; // Starting from 10000
      }

      localStorage.setItem('lastOrderNumber', orderNumber.toString());
      return orderNumber;
    }

    // Enviar orden al vendedor por WhatsApp
    async function sendOrderToSellerWhatsApp(orderData, orderNumber) {
      try {
        console.log('üì± Buscando vendedor para enviar WhatsApp...');

        if (!currentUser || !currentUser.email) {
          console.warn('‚ö†Ô∏è No hay usuario autenticado para buscar vendedor');
          return;
        }

        // 1. Buscar el cliente por email del usuario
        const clientesSnapshot = await firebase.firestore()
          .collection('clientes')
          .where('email', '==', currentUser.email)
          .limit(1)
          .get();

        if (clientesSnapshot.empty) {
          console.warn('‚ö†Ô∏è No se encontr√≥ cliente asociado al email:', currentUser.email);
          return;
        }

        const clienteData = clientesSnapshot.docs[0].data();
        const vendedorId = clienteData.vendedorId || clienteData.vendedor;

        if (!vendedorId) {
          console.warn('‚ö†Ô∏è Cliente no tiene vendedor asignado');
          return;
        }

        console.log('üë§ Cliente encontrado, vendedor ID:', vendedorId);

        // 2. Buscar el vendedor
        const vendedorDoc = await firebase.firestore()
          .collection('vendedores')
          .doc(vendedorId)
          .get();

        if (!vendedorDoc.exists) {
          console.warn('‚ö†Ô∏è No se encontr√≥ el vendedor con ID:', vendedorId);
          return;
        }

        const vendedorData = vendedorDoc.data();
        let vendedorPhone = vendedorData.phone || vendedorData.telefono;

        if (!vendedorPhone) {
          console.warn('‚ö†Ô∏è Vendedor no tiene tel√©fono configurado');
          return;
        }

        // Limpiar el n√∫mero de tel√©fono (remover espacios, guiones, etc)
        vendedorPhone = vendedorPhone.replace(/\D/g, '');

        console.log('üìû Vendedor encontrado:', vendedorData.name, '- Tel√©fono:', vendedorPhone);

        // 3. Construir el mensaje de WhatsApp
        const clienteNombre = clienteData.nombre || clienteData.nombreComercial || currentUser.displayName || currentUser.email;

        let mensaje = `üõí *NUEVA ORDEN #${orderNumber}*\n\n`;
        mensaje += `üë§ *Cliente:* ${clienteNombre}\n`;
        mensaje += `üìß *Email:* ${currentUser.email}\n`;
        mensaje += `üìÖ *Fecha:* ${orderData.fechaLocal}\n\n`;
        mensaje += `üì¶ *Productos (${orderData.cantidadItems}):*\n`;

        orderData.items.forEach((item, index) => {
          mensaje += `${index + 1}. ${item.description || item.articulo}\n`;
          mensaje += `   Cantidad: ${item.quantity} x $${formatNumber(item.price)}\n`;
        });

        mensaje += `\nüí∞ *TOTAL: $${formatNumber(orderData.total)}*\n\n`;
        mensaje += `üè¢ ${orderData.empresa || 'South Traders'}`;

        // 4. Abrir WhatsApp
        const whatsappUrl = `https://wa.me/${vendedorPhone}?text=${encodeURIComponent(mensaje)}`;

        console.log('‚úÖ Abriendo WhatsApp para vendedor...');
        window.open(whatsappUrl, '_blank');

      } catch (error) {
        console.error('‚ùå Error enviando mensaje al vendedor:', error);
        // No detener el proceso si falla el WhatsApp
      }
    }

    // Guardar pedido completo en Firebase con n√∫mero de orden
    async function saveOrderToFirebase(orderData, orderNumber) {
      if (!currentUser) {
        console.warn('‚ö†Ô∏è No se puede guardar en Firebase: usuario no autenticado');
        return false;
      }

      if (!firebase.firestore) {
        console.error('‚ùå Firestore no est√° disponible');
        return false;
      }

      try {
        const orderToSave = {
          numeroOrden: orderNumber,
          userId: currentUser.uid,
          userEmail: currentUser.email,
          userDisplayName: currentUser.displayName || currentUser.email,
          fecha: firebase.firestore.Timestamp.now(),
          fechaLocal: new Date().toLocaleString('es-ES'),
          estado: 'Confirmada',
          items: orderData.items,
          total: orderData.total,
          cantidadItems: orderData.items.length,
          resumen: `Orden #${orderNumber} - ${orderData.items.length} productos - Total: $${formatNumber(orderData.total)}`,
          empresa: CONTACT_CONFIG.companyName,
          timestamp: Date.now()
        };

        console.log('üíæ Guardando pedido en Firebase:', orderToSave);

        const docRef = await firebase.firestore()
          .collection('pedidos')
          .add(orderToSave);

        console.log('‚úÖ Pedido guardado con ID:', docRef.id);
        console.log('üìã Datos guardados:', orderToSave);

        // Verificar inmediatamente que se guard√≥
        const savedDoc = await docRef.get();
        if (savedDoc.exists) {
          console.log('‚úÖ Verificaci√≥n: Documento existe en Firebase');
        } else {
          console.error('‚ùå Verificaci√≥n: Documento NO existe en Firebase');
        }

        // Enviar notificaci√≥n al vendedor por WhatsApp
        await sendOrderToSellerWhatsApp(orderToSave, orderNumber);

        return true;
      } catch (error) {
        console.error('‚ùå Error guardando pedido en Firebase:', error);
        return false;
      }
    }

    // Cargar historial de pedidos desde Firebase
    async function loadHistorial() {
      const historialList = document.getElementById('historialList');

      if (!historialList) {
        console.warn('‚ö†Ô∏è Elemento historialList no encontrado');
        return;
      }

      if (!currentUser) {
        historialList.innerHTML = `
          <div class="no-historial">
            <p>üîê Necesitas estar autenticado</p>
            <small>Inicia sesi√≥n para ver el historial de pedidos</small>
          </div>
        `;
        return;
      }

      if (!firebase.firestore) {
        console.error('‚ùå Firestore no est√° disponible');
        historialList.innerHTML = `
          <div class="no-historial">
            <p>‚ùå Error de conexi√≥n</p>
            <small>No se puede conectar con Firebase</small>
          </div>
        `;
        return;
      }

      try {
        console.log('üìã Cargando historial desde Firebase...');
        console.log('üë§ Usuario actual:', currentUser.uid, currentUser.email);

        // Opci√≥n 1: Query sin orderBy para evitar √≠ndice compuesto
        const querySnapshot = await firebase.firestore()
          .collection('pedidos')
          .where('userId', '==', currentUser.uid)
          .limit(50)
          .get();

        console.log('üìä Resultado de query:', {
          empty: querySnapshot.empty,
          size: querySnapshot.size,
          docs: querySnapshot.docs.length
        });

        if (querySnapshot.empty) {
          historialList.innerHTML = `
            <div class="no-historial">
              <p>üìù No hay pedidos en el historial</p>
              <small>Los pedidos enviados por WhatsApp/Email aparecer√°n aqu√≠</small>
            </div>
          `;
          return;
        }

        const pedidos = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          pedidos.push({
            id: doc.id,
            ...data
          });
        });

        // Ordenar por fecha en JavaScript (m√°s recientes primero)
        pedidos.sort((a, b) => {
          // Si hay timestamp, usarlo, sino usar fecha de Firestore
          if (a.timestamp && b.timestamp) {
            return b.timestamp - a.timestamp;
          } else if (a.fecha && b.fecha) {
            return b.fecha.toMillis() - a.fecha.toMillis();
          }
          return 0;
        });

        console.log(`‚úÖ Cargados y ordenados ${pedidos.length} pedidos desde Firebase`);
        
        historialList.innerHTML = pedidos.map(pedido => `
          <div class="historial-item" onclick="showOrderDetails('${pedido.id}')">
            <div class="historial-item-header">
              <div class="historial-date">${pedido.fechaLocal}</div>
              <div class="historial-method">${pedido.numeroOrden ? `#${pedido.numeroOrden}` : (pedido.metodo || 'Confirmada')}</div>
            </div>
            <div class="historial-summary">${pedido.resumen}</div>
            ${pedido.userDisplayName || pedido.userEmail ? `<div class="historial-user">üë§ ${pedido.userDisplayName || pedido.userEmail}</div>` : ''}
            <div class="historial-items-preview">
              ${pedido.items.slice(0, 2).map(item => `<small>${item.description}</small>`).join(' ‚Ä¢ ')}
              ${pedido.items.length > 2 ? `<small>... +${pedido.items.length - 2} m√°s</small>` : ''}
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('‚ùå Error cargando historial:', error);

        if (historialList) {
          historialList.innerHTML = `
            <div class="no-historial">
              <p>‚ùå Error cargando historial</p>
              <small>Intenta recargar la p√°gina</small>
            </div>
          `;
        }

        // No relanzar el error para evitar romper el flujo
        return;
      }
    }

    // Mostrar detalles de un pedido
    async function showOrderDetails(orderId) {
      if (!firebase || !firebase.firestore) {
        console.error('‚ùå Firebase no est√° disponible para mostrar detalles');
        alert('‚ùå Error: Firebase no est√° disponible');
        return;
      }

      try {
        const doc = await firebase.firestore()
          .collection('pedidos')
          .doc(orderId)
          .get();

        if (!doc.exists) {
          alert('‚ùå Pedido no encontrado');
          return;
        }

        const orderData = doc.data();
        
        const detailsHtml = `
          <h3>üìã Detalles de la Orden ${orderData.numeroOrden ? `#${orderData.numeroOrden}` : ''}</h3>
          <p><strong>Fecha:</strong> ${orderData.fechaLocal}</p>
          <p><strong>Estado:</strong> ${orderData.estado || 'Confirmada'}</p>
          ${orderData.userDisplayName || orderData.userEmail ? `<p><strong>Usuario:</strong> ${orderData.userDisplayName || orderData.userEmail}</p>` : ''}
          <p><strong>Total:</strong> $${formatNumber(orderData.total)}</p>

          <h4>üõí Productos (${orderData.items.length}):</h4>
          <div style="max-height: 200px; overflow-y: auto;">
            ${orderData.items.map(item => `
              <div style="padding: 8px; border-bottom: 1px solid #3a3a44;">
                <strong>${item.description}</strong><br>
                <small>Cantidad: ${item.quantity} | Precio: $${formatNumber(item.price)}</small>
              </div>
            `).join('')}
          </div>

          ${orderData.empresa ? `<h4>üè¢ Empresa:</h4><p><small>${orderData.empresa}</small></p>` : ''}
        `;
        
        // Crear modal temporal para mostrar detalles
        const detailModal = document.createElement('div');
        detailModal.className = 'modal';
        detailModal.innerHTML = `
          <div class="modal-content">
            <span class="close-button">&times;</span>
            ${detailsHtml}
          </div>
        `;
        
        document.body.appendChild(detailModal);
        detailModal.classList.remove('hidden');
        
        // Event listener para cerrar
        detailModal.querySelector('.close-button').addEventListener('click', () => {
          document.body.removeChild(detailModal);
        });
        
        detailModal.addEventListener('click', (e) => {
          if (e.target === detailModal) {
            document.body.removeChild(detailModal);
          }
        });
        
      } catch (error) {
        console.error('‚ùå Error cargando detalles:', error);
        alert('‚ùå Error cargando detalles del pedido');
        // No relanzar el error para evitar romper el flujo
        return;
      }
    }

    // Agregar pedido al historial (mantener localStorage como fallback)
    function addToHistorial(method, summary) {
      const historial = JSON.parse(localStorage.getItem('pedidosHistorial') || '[]');
      const nuevoPedido = {
        fecha: new Date().toLocaleString('es-ES'),
        metodo: method,
        resumen: summary,
        timestamp: Date.now()
      };
      
      historial.unshift(nuevoPedido);
      
      if (historial.length > 50) {
        historial.splice(50);
      }
      
      localStorage.setItem('pedidosHistorial', JSON.stringify(historial));
    }

    // Limpiar historial (Firebase + localStorage)
    async function clearHistorial() {
      if (!confirm('¬øEst√°s seguro de que quieres eliminar todo el historial de pedidos?')) {
        return;
      }
      
      try {
        // Limpiar Firebase si el usuario est√° autenticado
        if (currentUser && firebase.firestore) {
          console.log('üóëÔ∏è Eliminando pedidos de Firebase...');
          
          const querySnapshot = await firebase.firestore()
            .collection('pedidos')
            .where('userId', '==', currentUser.uid)
            .get();
            
          const batch = firebase.firestore().batch();
          querySnapshot.forEach(doc => {
            batch.delete(doc.ref);
          });
          
          await batch.commit();
          console.log(`‚úÖ Eliminados ${querySnapshot.size} pedidos de Firebase`);
        }
        
        // Limpiar localStorage como fallback
        localStorage.removeItem('pedidosHistorial');
        
        loadHistorial();
        alert('üóëÔ∏è Historial eliminado completamente');
        
      } catch (error) {
        console.error('‚ùå Error eliminando historial:', error);
        alert('‚ùå Error eliminando historial. Intenta de nuevo.');
      }
    }

    // Exportar historial (desde Firebase)
    async function exportHistorial() {
      try {
        let pedidos = [];
        
        // Intentar cargar desde Firebase primero
        if (currentUser && firebase.firestore) {
          console.log('üìä Exportando desde Firebase...');
          
          const querySnapshot = await firebase.firestore()
            .collection('pedidos')
            .where('userId', '==', currentUser.uid)
            .get();
            
          querySnapshot.forEach(doc => {
            const data = doc.data();
            pedidos.push({
              fecha: data.fechaLocal,
              metodo: data.metodo,
              resumen: data.resumen,
              total: data.total,
              items: data.cantidadItems,
              empresa: data.contactoUsado?.empresa || '',
              timestamp: data.timestamp,
              fechaFirestore: data.fecha
            });
          });
          
          // Ordenar por fecha (m√°s recientes primero)
          pedidos.sort((a, b) => {
            if (a.timestamp && b.timestamp) {
              return b.timestamp - a.timestamp;
            } else if (a.fechaFirestore && b.fechaFirestore) {
              return b.fechaFirestore.toMillis() - a.fechaFirestore.toMillis();
            }
            return 0;
          });
        } else {
          // Fallback a localStorage
          console.log('üìä Exportando desde localStorage...');
          const historialLocal = JSON.parse(localStorage.getItem('pedidosHistorial') || '[]');
          pedidos = historialLocal.map(pedido => ({
            fecha: pedido.fecha,
            metodo: pedido.metodo,
            resumen: pedido.resumen,
            total: '',
            items: '',
            empresa: ''
          }));
        }
        
        if (pedidos.length === 0) {
          alert('üìã No hay pedidos para exportar');
          return;
        }
        
        const csvContent = 'Fecha,M√©todo,Resumen,Total,Items,Empresa\\n' + 
          pedidos.map(pedido => 
            `"${pedido.fecha}","${pedido.metodo}","${pedido.resumen.replace(/"/g, '""')}","${pedido.total}","${pedido.items}","${pedido.empresa}"`
          ).join('\\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `historial_pedidos_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
        
        console.log(`‚úÖ Exportados ${pedidos.length} pedidos`);
        
      } catch (error) {
        console.error('‚ùå Error exportando historial:', error);
        alert('‚ùå Error exportando historial. Intenta de nuevo.');
      }
    }

    // Datos de la orden
    let orderData = {
      items: [],
      total: 0,
      date: new Date().toLocaleString('es-ES')
    };

    // Cargar datos del carrito desde localStorage
    function loadCartData() {
      try {
        const cartData = localStorage.getItem('cart');
        if (cartData) {
          const parsedCart = JSON.parse(cartData);
          console.log('Cart data loaded:', parsedCart);
          
          if (Array.isArray(parsedCart) && parsedCart.length > 0) {
            orderData.items = parsedCart;
            orderData.total = parsedCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            displayOrder();
          } else {
            showEmptyCart();
          }
        } else {
          showEmptyCart();
        }
      } catch (error) {
        console.error('Error loading cart data:', error);
        showEmptyCart();
      }
    }

    // Mostrar carrito vac√≠o
    function showEmptyCart() {
      const orderSummary = document.getElementById('orderSummary');
      orderSummary.innerHTML = `
        <div class="empty-cart">
          <div class="empty-cart-icon">üõí</div>
          <h3>Tu carrito est√° vac√≠o</h3>
          <p>Agrega productos desde el marketplace para ver tu resumen de orden</p>
        </div>
      `;
      
      // Deshabilitar bot√≥n de confirmar
      document.getElementById('confirmOrderBtn').disabled = true;
    }

    // Mostrar la orden
    function displayOrder() {
      // Actualizar fecha
      document.getElementById('orderDate').textContent = orderData.date;
      
      // Renderizar productos
      const productsList = document.getElementById('productsList');
      productsList.innerHTML = '';
      
      orderData.items.forEach(item => {
        const productItem = document.createElement('div');
        productItem.className = 'product-item';
        
        const itemTotal = item.price * item.quantity;
        
        productItem.innerHTML = `
          <div class="product-info">
            <div class="product-name">${item.description || 'Producto sin descripci√≥n'}</div>
            <div class="product-code">${item.item || 'N/A'}</div>
          </div>
          <div class="product-quantity">x${item.quantity}</div>
          <div class="product-price">$${formatNumber(itemTotal)}</div>
        `;
        
        productsList.appendChild(productItem);
      });
      
      // Renderizar totales
      const totalSection = document.getElementById('totalSection');
      const itemCount = orderData.items.reduce((sum, item) => sum + item.quantity, 0);
      
      totalSection.innerHTML = `
        <div class="total-row">
          <span>Productos (${itemCount} items):</span>
          <span>$${formatNumber(orderData.total)}</span>
        </div>
        <div class="total-row">
          <span>Env√≠o:</span>
          <span>A coordinar</span>
        </div>
        <div class="total-row">
          <strong>Total:</strong>
          <strong>$${formatNumber(orderData.total)}</strong>
        </div>
      `;
    }

    // Generar texto de orden para compartir
    function generateOrderText(isWhatsApp = false) {
      if (orderData.items.length === 0) {
        return 'No hay productos en la orden.';
      }
      
      let text = '';
      
      if (isWhatsApp) {
        text += `¬°Hola! üëã Quiero hacer un pedido en *${CONTACT_CONFIG.companyName}*\n\n`;
        text += `üõí *ORDEN DE COMPRA*\n`;
      } else {
        text += `ORDEN DE COMPRA - ${CONTACT_CONFIG.companyName}\n`;
      }
      
      text += `üìÖ Fecha: ${orderData.date}\n\n`;
      text += `üìã ${isWhatsApp ? '*' : ''}PRODUCTOS:${isWhatsApp ? '*' : ''}\n`;
      
      orderData.items.forEach((item, index) => {
        const itemTotal = item.price * item.quantity;
        text += `${index + 1}. ${item.description || 'Producto'}\n`;
        text += `   üì± C√≥digo: ${item.item || 'N/A'}\n`;
        text += `   üì¶ Cantidad: ${item.quantity}\n`;
        text += `   üí∞ Precio: $${formatNumber(item.price)} c/u\n`;
        text += `   üíµ Subtotal: $${formatNumber(itemTotal)}\n\n`;
      });
      
      const itemCount = orderData.items.reduce((sum, item) => sum + item.quantity, 0);
      text += `üìä ${isWhatsApp ? '*' : ''}RESUMEN:${isWhatsApp ? '*' : ''}\n`;
      text += `‚Ä¢ Total de productos: ${itemCount}\n`;
      text += `‚Ä¢ ${isWhatsApp ? '*' : ''}TOTAL A PAGAR: $${formatNumber(orderData.total)}${isWhatsApp ? '*' : ''}\n\n`;
      
      if (isWhatsApp) {
        text += `üìû Por favor confirma la disponibilidad y coordina el env√≠o.\n`;
        text += `¬°Gracias! üôè`;
      } else {
        text += `Por favor confirma la disponibilidad y coordina el envio.\n`;
        text += `Gracias por tu compra.`;
      }
      
      return text;
    }

    // Confirmar Orden
    async function confirmOrder() {
      if (orderData.items.length === 0) {
        alert('No hay productos para confirmar');
        return;
      }

      if (!currentUser) {
        alert('‚ö†Ô∏è Debes estar autenticado para confirmar una orden');
        return;
      }

      try {
        // Generar n√∫mero de orden √∫nico
        const orderNumber = generateOrderNumber();

        console.log('üîÑ Confirmando orden #' + orderNumber);

        // Guardar en Firebase con n√∫mero de orden
        const saveSuccess = await saveOrderToFirebase(orderData, orderNumber);

        if (saveSuccess) {
          // Limpiar carrito despu√©s de confirmar
          localStorage.removeItem('cart');

          // Mostrar confirmaci√≥n con n√∫mero de orden
          alert(`‚úÖ Tu orden fue enviada con √©xito, un vendedor se contactar√° con vos en los pr√≥ximos minutos.\n\nN√∫mero de Orden: #${orderNumber}\nTotal: $${formatNumber(orderData.total)}`);

          // Redirigir a marketplace inmediatamente
          window.location.href = 'marketplace.html';
        } else {
          // Fallback a localStorage si Firebase falla
          console.warn('‚ö†Ô∏è Usando localStorage como fallback');
          const orderForStorage = {
            numeroOrden: orderNumber,
            fecha: new Date().toLocaleString('es-ES'),
            resumen: `Orden #${orderNumber} - ${orderData.items.length} productos - Total: $${formatNumber(orderData.total)}`,
            userEmail: currentUser.email,
            userDisplayName: currentUser.displayName || currentUser.email,
            timestamp: Date.now()
          };

          addToHistorial('Confirmada', orderForStorage.resumen);

          alert(`‚úÖ Tu orden fue enviada con √©xito, un vendedor se contactar√° con vos en los pr√≥ximos minutos.\n\nN√∫mero de Orden: #${orderNumber}\nTotal: $${formatNumber(orderData.total)}`);

          // Limpiar carrito y redirigir
          localStorage.removeItem('cart');
          window.location.href = 'marketplace.html';
        }

      } catch (error) {
        console.error('‚ùå Error confirmando orden:', error);
        alert('‚ùå Error confirmando la orden. Intenta de nuevo.');
      }
    }


    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Cargar configuraci√≥n primero
      loadAppConfig();
      
      // Cargar datos del carrito
      loadCartData();
      
      // === USER PERMISSIONS CHECK ===
      async function checkUserPermissions(user) {
        try {
          console.log('üîê Verificando permisos para usuario en order.html:', user.email);
          
          const userDoc = await firebase.firestore()
            .collection('usuarios')
            .doc(user.uid)
            .get();
          
          let isAdmin = false;
          if (userDoc.exists) {
            const userData = userDoc.data();
            isAdmin = userData.admin === true;
            console.log('üë§ Usuario encontrado:', userData);
            console.log('üîê Es admin:', isAdmin);
          } else {
            console.log('‚ö†Ô∏è Usuario no encontrado en Firestore, asumiendo no-admin');
          }
          
          // Funci√≥n para aplicar visibilidad de controles del men√∫
          const applyMenuVisibility = () => {
            const configModalBtn = document.getElementById('configModalBtn');
            const statsModalBtn = document.getElementById('statsModalBtn');
            const historialModalBtn = document.getElementById('historialModalBtn');
            const logisticsModalBtn = document.getElementById('logisticsModalBtn');
            
            console.log('üîç Elementos del men√∫ encontrados:');
            console.log('- configModalBtn:', !!configModalBtn);
            console.log('- statsModalBtn:', !!statsModalBtn);
            console.log('- historialModalBtn:', !!historialModalBtn);
            console.log('- logisticsModalBtn:', !!logisticsModalBtn);
            
            if (!isAdmin) {
              console.log('üö´ Usuario NO-ADMIN: ocultando CONFIG y STATS');

              // Ocultar opciones administrativas
              if (configModalBtn) {
                configModalBtn.style.display = 'none';
                console.log('‚úÖ CONFIG ocultado');
              }
              if (statsModalBtn) {
                statsModalBtn.style.display = 'none';
                console.log('‚úÖ STATS ocultado');
              }

              // Mostrar opciones b√°sicas
              if (historialModalBtn) {
                historialModalBtn.style.display = 'block';
                console.log('‚úÖ HISTORIAL visible para usuario no-admin');
              }
              if (logisticsModalBtn) {
                logisticsModalBtn.style.display = 'block';
                console.log('‚úÖ LOGISTICS visible para usuario no-admin');
              }

              // Ocultar bot√≥n de limpiar historial para usuarios no-admin
              const clearHistorialBtn = document.getElementById('clearHistorialBtn');
              if (clearHistorialBtn) {
                clearHistorialBtn.style.display = 'none';
                console.log('üö´ Bot√≥n "Limpiar Historial" ocultado para usuario no-admin');
              }

            } else {
              console.log('‚úÖ Usuario ADMIN: mostrando todas las opciones del men√∫');

              // Mostrar todas las opciones
              if (configModalBtn) {
                configModalBtn.style.display = 'block';
                console.log('‚úÖ CONFIG visible');
              }
              if (statsModalBtn) {
                statsModalBtn.style.display = 'block';
                console.log('‚úÖ STATS visible');
              }
              if (historialModalBtn) {
                historialModalBtn.style.display = 'block';
                console.log('‚úÖ HISTORIAL visible');
              }
              if (logisticsModalBtn) {
                logisticsModalBtn.style.display = 'block';
                console.log('‚úÖ LOGISTICS visible');
              }

              // Mostrar bot√≥n de limpiar historial para usuarios admin
              const clearHistorialBtn = document.getElementById('clearHistorialBtn');
              if (clearHistorialBtn) {
                clearHistorialBtn.style.display = 'block';
                console.log('‚úÖ Bot√≥n "Limpiar Historial" visible para usuario admin');
              }
            }
          };
          
          // Aplicar inmediatamente
          applyMenuVisibility();
          
          // Tambi√©n aplicar despu√©s de un peque√±o delay para asegurar que el DOM est√© listo
          setTimeout(applyMenuVisibility, 500);
          
        } catch (error) {
          console.error('‚ùå Error verificando permisos de usuario en order.html:', error);
          // Por seguridad, mostrar solo historial y logistics si hay error
          const configModalBtn = document.getElementById('configModalBtn');
          const statsModalBtn = document.getElementById('statsModalBtn');
          const historialModalBtn = document.getElementById('historialModalBtn');
          const logisticsModalBtn = document.getElementById('logisticsModalBtn');
          
          if (configModalBtn) configModalBtn.style.display = 'none';
          if (statsModalBtn) statsModalBtn.style.display = 'none';
          if (historialModalBtn) historialModalBtn.style.display = 'block';
          if (logisticsModalBtn) logisticsModalBtn.style.display = 'block';
          
          console.log('üö´ Error en verificaci√≥n: mostrando solo historial y logistics por seguridad');
        }
      }
      
      // Cargar configuraci√≥n desde Firebase cuando el usuario se autentique
      if (typeof firebase !== 'undefined' && firebase.auth) {
        firebase.auth().onAuthStateChanged(async function(user) {
          if (user) {
            console.log('üë§ Usuario autenticado en order.html, verificando permisos...');
            await checkUserPermissions(user);
            
            console.log('üë§ Cargando configuraci√≥n...');
            const configLoaded = await loadConfigFromFirebase();
            
            if (configLoaded) {
              console.log('üéØ Configuraci√≥n cargada desde Firebase');
            } else {
              console.log('üìã Usando configuraci√≥n por defecto, no se encontr√≥ en Firebase');
            }
          }
        });
      } else {
        console.log('‚ö†Ô∏è Firebase no disponible en order.html');
      }

      // Bot√≥n Confirmar Orden
      document.getElementById('confirmOrderBtn').addEventListener('click', confirmOrder);
      
      // === HAMBURGER MENU EVENT LISTENERS ===
      
      // Debug: Verificar si el bot√≥n existe
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      console.log('Hamburger button found:', hamburgerBtn);
      
      if (hamburgerBtn) {
        console.log('Adding click listener to hamburger button');
        hamburgerBtn.addEventListener('click', toggleMenu);
        
        // Hacer el bot√≥n m√°s visible temporalmente
        hamburgerBtn.style.backgroundColor = '#ff0000';
        hamburgerBtn.style.border = '3px solid #ffffff';
        console.log('Hamburger button styled for debugging');
      } else {
        console.error('Hamburger button not found!');
      }
      
      // Cerrar men√∫
      document.getElementById('closeMenuBtn').addEventListener('click', closeMenu);
      
      // Cerrar men√∫ al hacer click en overlay
      document.getElementById('slideMenuOverlay').addEventListener('click', closeMenu);
      
      // Botones del men√∫ para abrir modales
      document.getElementById('configModalBtn').addEventListener('click', function() {
        closeMenu();
        openModal('configModal');
      });
      
      document.getElementById('statsModalBtn').addEventListener('click', function() {
        closeMenu();
        openModal('statsModal');
      });
      
      document.getElementById('historialModalBtn').addEventListener('click', function() {
        closeMenu();
        openModal('historialModal');
        loadHistorial();
      });
      
      document.getElementById('logisticsModalBtn').addEventListener('click', function() {
        closeMenu();
        openModal('logisticsModal');
      });
      
      // Cerrar modales con bot√≥n X
      document.querySelectorAll('.close-button').forEach(button => {
        button.addEventListener('click', function() {
          this.closest('.modal').classList.add('hidden');
        });
      });
      
      // Cerrar modales al hacer click fuera
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.classList.add('hidden');
          }
        });
      });
      
      // Cerrar modales con tecla Escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeAllModals();
        }
      });
      
      // Botones de configuraci√≥n
      document.getElementById('saveConfigBtn').addEventListener('click', saveConfigFromInputs);
      document.getElementById('resetConfigBtn').addEventListener('click', resetConfig);
      
      // Botones de estad√≠sticas
      document.getElementById('refreshStatsBtn').addEventListener('click', updateStats);
      document.getElementById('clearStatsBtn').addEventListener('click', clearSystemData);
      
      // Botones de historial
      document.getElementById('clearHistorialBtn').addEventListener('click', clearHistorial);
      document.getElementById('exportHistorialBtn').addEventListener('click', exportHistorial);
      
      // Cerrar men√∫ con Escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && menuOpen) {
          closeMenu();
        }
      });
    });
    
    // Version button functionality
    document.getElementById('versionBtn').addEventListener('click', function() {
      const modal = document.getElementById('changelogModal');
      modal.classList.remove('hidden');
    });
    
    // Close changelog modal
    document.querySelectorAll('.close-button').forEach(button => {
      button.addEventListener('click', function() {
        const modal = this.closest('.modal');
        modal.classList.add('hidden');
      });
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('changelogModal');
      if (event.target === modal) {
        modal.classList.add('hidden');
      }
    });
  </script>
  
  <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
  <script>
    // Initialize Material Design Components
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize all buttons
      const buttons = document.querySelectorAll('.mdc-button');
      buttons.forEach(button => mdc.ripple.MDCRipple.attachTo(button));
      
      // Initialize text fields
      const textFields = document.querySelectorAll('.mdc-text-field');
      textFields.forEach(textField => mdc.textField.MDCTextField.attachTo(textField));
    });
  </script>
  
</body>
</html>
