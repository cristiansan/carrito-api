<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>South Traders</title>
  
  <!-- Material Design CSS -->
  <link href="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { 
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; 
      color-scheme: dark;
      --mdc-theme-primary: #4CAF50;
      --mdc-theme-secondary: #2a2a33;
      --mdc-theme-surface: #1e1e24;
      --mdc-theme-background: #0f0f10;
      --mdc-theme-on-primary: #ffffff;
      --mdc-theme-on-secondary: #ffffff;
      --mdc-theme-on-surface: #f1f1f1;
      --mdc-theme-on-background: #f1f1f1;
    }
    
    /* Material Design custom overrides for better visibility */
    .mdc-tab {
      color: #d0d0d0 !important; /* Color más claro para tabs no seleccionados */
      background-color: #1b1b1f !important;
      border-radius: 6px 6px 0 0 !important;
      border: 1px solid #2a2a2a !important;
      border-bottom: none !important;
      margin-right: 4px !important;
    }
    
    .mdc-tab--active {
      color: #ffffff !important; /* Color para tab seleccionado */
      background-color: #23232a !important;
      font-weight: 600 !important;
    }
    
    .mdc-tab:hover:not(.mdc-tab--active) {
      color: #e8e8e8 !important; /* Color en hover para mejor visibilidad */
      background-color: #2a2a2f !important;
    }
    
    .mdc-tab-indicator__content--underline {
      border-color: #4CAF50 !important;
      border-width: 3px !important;
    }
    
    /* Fix for all text elements that might appear black */
    .mdc-tab__text-label,
    .mdc-button__label,
    .mdc-floating-label,
    .mdc-text-field__input,
    .mdc-form-field > label,
    .mdc-checkbox ~ label,
    span, p, div, h1, h2, h3, h4, h5, h6 {
      color: inherit !important;
    }
    
    /* Specific overrides for Material components */
    .mdc-tab__text-label {
      color: inherit !important;
    }
    
    .mdc-button__label {
      color: inherit !important;
    }
    
    /* Text field improvements */
    .mdc-text-field--outlined {
      background-color: #1b1b1f !important;
      box-shadow: none !important; /* Eliminar cualquier sombra por defecto */
    }
    
    .mdc-text-field--outlined .mdc-notched-outline__leading,
    .mdc-text-field--outlined .mdc-notched-outline__notch,
    .mdc-text-field--outlined .mdc-notched-outline__trailing {
      border-color: #3a3a44 !important;
    }
    
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__leading,
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__notch,
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__trailing {
      border-color: #4CAF50 !important;
    }
    
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__leading,
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__notch,
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__trailing {
      border-color: #4CAF50 !important;
      border-width: 2px !important;
    }
    
    .mdc-text-field__input {
      color: #f1f1f1 !important;
    }
    
    .mdc-floating-label {
      color: #d0d0d0 !important; /* Gris más claro */
    }
    
    .mdc-text-field--focused .mdc-floating-label {
      color: #4CAF50 !important;
    }
    
    /* Button improvements */
    .mdc-button {
      color: #f1f1f1 !important;
    }
    
    .mdc-button--raised {
      background-color: #4CAF50 !important;
      color: #ffffff !important;
    }
    
    .mdc-button--outlined {
      border-color: #3a3a44 !important;
      color: #f1f1f1 !important;
    }
    
    .mdc-button--outlined:hover {
      background-color: #2a2a33 !important;
      border-color: #4CAF50 !important;
    }
    
    /* Checkbox improvements */
    .mdc-checkbox__native-control:enabled:checked ~ .mdc-checkbox__background {
      background-color: #4CAF50 !important;
      border-color: #4CAF50 !important;
    }
    
    .mdc-checkbox__background {
      border-color: #3a3a44 !important;
    }
    
    .mdc-form-field > label {
      color: #f1f1f1 !important;
    }
    
    /* General text color fixes */
    .status {
      color: #d0d0d0 !important;
    }
    
    /* Prevent any black text */
    * {
      color: inherit;
    }
    
    /* Ensure all Material Design components inherit proper colors */
    .mdc-tab *, 
    .mdc-button *, 
    .mdc-text-field *, 
    .mdc-checkbox *,
    .mdc-form-field * {
      color: inherit !important;
    }
    
    body { margin: 0; padding: 0; background: #0f0f10; color: #f1f1f1; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100%; max-width: 100%; overflow-x: hidden; box-sizing: border-box; }
    .login-container { background: #1e1e24; padding: 40px; border-radius: 8px; text-align: center; width: 100%; max-width: 400px; box-sizing: border-box; margin: 0 20px; }
    .logo { height: auto; margin-bottom: 20px; max-width: 200px; width: 100%; object-fit: contain; }
    h1 { margin-bottom: 20px; }
    input { display: block; width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #3a3a44; background: #1b1b1f; color: #f0f0f0; }
    button { width: 100%; padding: 10px; border-radius: 4px; border: none; background: #4CAF50; color: white; cursor: pointer; }
    .google-btn { background: #fff; color: #333; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }
    .google-btn:hover { background: #f5f5f5; }
    .separator { margin: 15px 0; color: #666; font-size: 14px; }
    .links { margin-top: 20px; }
    a { color: #4CAF50; text-decoration: none; cursor: pointer; }
    
    /* Modal styles */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #1e1e24; padding: 40px; border-radius: 8px; width: 400px; max-width: 90%; position: relative; }
    .close { position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
    .close:hover { color: #f1f1f1; }
    #errorMessage { color: #ff6b6b; margin-top: 10px; font-size: 14px; }
    
    /* Disclaimer styles */
    .disclaimer-section {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #3a3a44;
    }
    
    .disclaimer-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 10px;
      text-align: left;
    }
    
    .disclaimer-checkbox input[type="checkbox"] {
      width: auto;
      margin: 0;
      margin-top: 2px;
    }
    
    .disclaimer-text {
      font-size: 14px;
      line-height: 1.4;
      color: #b5b5b5;
    }
    
    .disclaimer-link {
      color: #4CAF50;
      text-decoration: underline;
      cursor: pointer;
    }
    
    .disclaimer-link:hover {
      color: #45a049;
    }
    
    .disclaimer-error {
      color: #ff6b6b;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    
    .terms-modal .modal-content {
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .terms-content {
      text-align: left;
      line-height: 1.6;
      color: #e6e6e6;
    }
    
    .terms-content h3 {
      color: #4CAF50;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    
    .terms-content p {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <img src="logo.png" alt="Logo" class="logo">
    
    <div class="mdc-text-field mdc-text-field--outlined" style="width: 100%; margin-bottom: 16px;">
      <input class="mdc-text-field__input" type="email" id="email" aria-describedby="email-helper-text">
      <div class="mdc-notched-outline">
        <div class="mdc-notched-outline__leading"></div>
        <div class="mdc-notched-outline__notch">
          <label for="email" class="mdc-floating-label">Email</label>
        </div>
        <div class="mdc-notched-outline__trailing"></div>
      </div>
    </div>
    
    <div class="mdc-text-field mdc-text-field--outlined" style="width: 100%; margin-bottom: 20px;">
      <input class="mdc-text-field__input" type="password" id="password" aria-describedby="password-helper-text">
      <div class="mdc-notched-outline">
        <div class="mdc-notched-outline__leading"></div>
        <div class="mdc-notched-outline__notch">
          <label for="password" class="mdc-floating-label">Password</label>
        </div>
        <div class="mdc-notched-outline__trailing"></div>
      </div>
    </div>
    
    <button class="mdc-button mdc-button--raised" id="loginBtn" style="width: 100%;">
      <span class="mdc-button__ripple"></span>
      <i class="material-icons mdc-button__icon" aria-hidden="true">login</i>
      <span class="mdc-button__label">Login</span>
    </button>
    <div class="separator">o</div>
    <button id="googleBtn" class="google-btn">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
      </svg>
      Continuar con Google
    </button>
    
    <!-- Disclaimer Section -->
    <div class="disclaimer-section">
      <div class="disclaimer-checkbox">
        <input type="checkbox" id="termsCheckbox" checked>
        <div class="disclaimer-text">
          Acepto los <span class="disclaimer-link" id="termsLink">términos y condiciones</span> de uso del servicio.
        </div>
      </div>
      <div class="disclaimer-error" id="termsError">
        Debes aceptar los términos y condiciones para continuar.
      </div>
    </div>
    
    <div class="links">
      <a href="#" id="registerLink">Register</a> | <a href="#">Forgot Password?</a>
    </div>
  </div>

  <!-- Modal de Registro -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Crear Cuenta</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Contraseña (mínimo 6 caracteres)">
      <input type="password" id="confirmPassword" placeholder="Confirmar Contraseña">
      <button id="registerBtn">Crear Cuenta</button>
      <div id="registerError"></div>
    </div>
  </div>
  
  <!-- Modal de Términos y Condiciones -->
  <div id="termsModal" class="modal terms-modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Términos y Condiciones</h2>
      <div class="terms-content">
        <h3>1. Aceptación de los Términos</h3>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
        
        <h3>2. Uso del Servicio</h3>
        <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        
        <h3>3. Privacidad y Datos</h3>
        <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
        
        <h3>4. Responsabilidades del Usuario</h3>
        <p>Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt.</p>
        
        <h3>5. Limitación de Responsabilidad</h3>
        <p>Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem.</p>
        
        <h3>6. Modificaciones</h3>
        <p>Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur? Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur.</p>
        
        <h3>7. Contacto</h3>
        <p>Si tienes preguntas sobre estos términos y condiciones, puedes contactarnos a través de nuestros canales oficiales de comunicación.</p>
      </div>
    </div>
  </div>
  
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCXjSGtVGfQas_cEyjmI0RTaeEl94jdp6g",
      authDomain: "carrito-138c3.firebaseapp.com",
      projectId: "carrito-138c3",
      storageBucket: "carrito-138c3.appspot.com",
      messagingSenderId: "579670725719",
      appId: "1:579670725719:web:carrito138c3"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Función para crear o actualizar documento del usuario en Firestore
    async function createOrUpdateUserDocument(user) {
      try {
        const { doc, getDoc, setDoc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        
        const userRef = doc(db, 'usuarios', user.uid);
        const userDoc = await getDoc(userRef);
        
        const userData = {
          email: user.email,
          displayName: user.displayName || user.email.split('@')[0],
          photoURL: user.photoURL || null,
          lastLogin: serverTimestamp(),
          provider: user.providerData.length > 0 ? user.providerData[0].providerId : 'email'
        };
        
        if (!userDoc.exists()) {
          // Usuario nuevo - crear documento pendiente de aprobación
          userData.admin = false;
          userData.approved = false;  // Pendiente de aprobación por admin
          userData.role = 'pending';  // pending, usuario, vendedor, admin
          userData.createdAt = serverTimestamp();
          await setDoc(userRef, userData);
          console.log('New user document created (pending approval):', user.uid, user.email);
        } else {
          // Usuario existente - solo actualizar datos básicos, preservar admin
          await updateDoc(userRef, {
            email: userData.email,
            displayName: userData.displayName,
            photoURL: userData.photoURL,
            lastLogin: userData.lastLogin,
            provider: userData.provider
          });
          console.log('User document updated:', user.uid, user.email);
        }
        
        return true;
      } catch (error) {
        console.error('Error creating/updating user document:', error);
        return false;
      }
    }
    const googleProvider = new GoogleAuthProvider();

    // Elementos del DOM - Login
    const usernameInput = document.querySelector('input[type="email"]');
    const passwordInput = document.querySelector('input[type="password"]');
    const loginBtn = document.getElementById('loginBtn');
    const googleBtn = document.getElementById('googleBtn');
    const errorDiv = document.createElement('div');
    errorDiv.id = 'errorMessage';
    errorDiv.style.color = '#ff6b6b';
    errorDiv.style.marginTop = '10px';
    errorDiv.style.fontSize = '14px';
    document.querySelector('.login-container').appendChild(errorDiv);

    // Elementos del DOM - Registro
    const registerLink = document.getElementById('registerLink');
    const registerModal = document.getElementById('registerModal');
    const closeModal = document.querySelector('.close');
    const registerEmailInput = document.getElementById('registerEmail');
    const registerPasswordInput = document.getElementById('registerPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const registerBtn = document.getElementById('registerBtn');
    const registerErrorDiv = document.getElementById('registerError');

    // Función de login
    loginBtn.addEventListener('click', async () => {
      const email = usernameInput.value;
      const password = passwordInput.value;
      
      if (!email || !password) {
        showError('Por favor completa todos los campos');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Iniciando sesión...';
      
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        console.log('Usuario autenticado:', userCredential.user);

        // Crear o actualizar documento en Firestore
        await createOrUpdateUserDocument(userCredential.user);

        // Verificar si el usuario está aprobado
        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const userRef = doc(db, 'usuarios', userCredential.user.uid);
        const userDoc = await getDoc(userRef);

        if (userDoc.exists()) {
          const userData = userDoc.data();
          if (userData.approved === false || userData.role === 'pending') {
            await auth.signOut();
            showError('⏳ Tu cuenta está pendiente de aprobación por un administrador.\n\nRecibirás un email cuando sea aprobada.');
            loginBtn.disabled = false;
            loginBtn.textContent = 'INGRESAR';
            return;
          }
        }

        // Guardar estado de autenticación
        localStorage.setItem('userAuthenticated', 'true');
        localStorage.setItem('userEmail', email);

        // Redirigir al marketplace
        window.location.href = 'marketplace.html';
        
      } catch (error) {
        console.error('Error en login:', error);
        let errorMessage = 'Error al iniciar sesión';
        
        switch (error.code) {
          case 'auth/user-not-found':
            errorMessage = 'Usuario no encontrado';
            break;
          case 'auth/wrong-password':
            errorMessage = 'Contraseña incorrecta';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Email inválido';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Demasiados intentos. Intenta más tarde';
            break;
        }
        
        showError(errorMessage);
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    });

    function showError(message) {
      errorDiv.textContent = message;
      setTimeout(() => {
        errorDiv.textContent = '';
      }, 5000);
    }

    function showRegisterError(message) {
      registerErrorDiv.textContent = message;
      registerErrorDiv.style.color = '#ff6b6b';
      registerErrorDiv.style.marginTop = '10px';
      registerErrorDiv.style.fontSize = '14px';
      setTimeout(() => {
        registerErrorDiv.textContent = '';
      }, 5000);
    }

    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function validatePassword(password) {
      return password.length >= 6;
    }

    // Eventos del modal de registro
    registerLink.addEventListener('click', (e) => {
      e.preventDefault();
      registerModal.classList.add('show');
    });

    closeModal.addEventListener('click', () => {
      registerModal.classList.remove('show');
      clearRegisterForm();
    });

    registerModal.addEventListener('click', (e) => {
      if (e.target === registerModal) {
        registerModal.classList.remove('show');
        clearRegisterForm();
      }
    });

    function clearRegisterForm() {
      registerEmailInput.value = '';
      registerPasswordInput.value = '';
      confirmPasswordInput.value = '';
      registerErrorDiv.textContent = '';
    }

    // Función de registro
    registerBtn.addEventListener('click', async () => {
      const email = registerEmailInput.value.trim();
      const password = registerPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      // Validaciones
      if (!email || !password || !confirmPassword) {
        showRegisterError('Por favor completa todos los campos');
        return;
      }

      if (!validateEmail(email)) {
        showRegisterError('Por favor ingresa un email válido');
        return;
      }

      if (!validatePassword(password)) {
        showRegisterError('La contraseña debe tener al menos 6 caracteres');
        return;
      }

      if (password !== confirmPassword) {
        showRegisterError('Las contraseñas no coinciden');
        return;
      }

      registerBtn.disabled = true;
      registerBtn.textContent = 'Creando cuenta...';

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        console.log('Usuario registrado:', userCredential.user);

        // Crear documento en Firestore para el nuevo usuario
        await createOrUpdateUserDocument(userCredential.user);

        // Guardar estado de autenticación
        localStorage.setItem('userAuthenticated', 'true');
        localStorage.setItem('userEmail', email);

        // Cerrar modal y mostrar mensaje de pendiente
        registerModal.classList.remove('show');
        alert('✅ Cuenta creada exitosamente!\n\n⏳ Tu cuenta está pendiente de aprobación por un administrador.\n\nRecibirás un email cuando tu cuenta sea aprobada.');

        // Cerrar sesión hasta que sea aprobado
        await auth.signOut();
        localStorage.removeItem('userAuthenticated');
        localStorage.removeItem('userEmail');
        
      } catch (error) {
        console.error('Error en registro:', error);
        let errorMessage = 'Error al crear la cuenta';
        
        switch (error.code) {
          case 'auth/email-already-in-use':
            errorMessage = 'Este email ya está registrado';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Email inválido';
            break;
          case 'auth/operation-not-allowed':
            errorMessage = 'Registro deshabilitado';
            break;
          case 'auth/weak-password':
            errorMessage = 'La contraseña es muy débil';
            break;
        }
        
        showRegisterError(errorMessage);
      } finally {
        registerBtn.disabled = false;
        registerBtn.textContent = 'Crear Cuenta';
      }
    });


    // === DISCLAIMER FUNCTIONALITY ===
    const termsLink = document.getElementById('termsLink');
    const termsModal = document.getElementById('termsModal');
    const termsCheckbox = document.getElementById('termsCheckbox');
    const termsError = document.getElementById('termsError');
    
    // Abrir modal de términos y condiciones
    termsLink.addEventListener('click', (e) => {
      e.preventDefault();
      termsModal.classList.add('show');
    });
    
    // Cerrar modal de términos
    termsModal.querySelector('.close').addEventListener('click', () => {
      termsModal.classList.remove('show');
    });
    
    // Cerrar modal haciendo click fuera del contenido
    termsModal.addEventListener('click', (e) => {
      if (e.target === termsModal) {
        termsModal.classList.remove('show');
      }
    });
    
    // Función para validar términos y condiciones
    function validateTerms() {
      if (!termsCheckbox.checked) {
        termsError.style.display = 'block';
        termsCheckbox.focus();
        return false;
      } else {
        termsError.style.display = 'none';
        return true;
      }
    }
    
    // Ocultar error cuando se marca el checkbox
    termsCheckbox.addEventListener('change', () => {
      if (termsCheckbox.checked) {
        termsError.style.display = 'none';
      }
    });
    
    // Modificar las funciones de login para validar términos
    const originalLoginHandler = loginBtn.onclick;
    
    // Sobrescribir el evento de login normal
    loginBtn.removeEventListener('click', originalLoginHandler);
    loginBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!validateTerms()) {
        return;
      }
      // Ejecutar login original si los términos están aceptados
      await handleLogin();
    });
    
    // Sobrescribir el evento de Google login
    googleBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!validateTerms()) {
        return;
      }
      // Ejecutar Google login original si los términos están aceptados
      await handleGoogleLogin();
    });
    
    // Función de login normal extraída
    async function handleLogin() {
      const email = document.querySelector('input[type="email"]').value;
      const password = document.querySelector('input[type="password"]').value;
      
      if (!email || !password) {
        showError('Por favor completa todos los campos');
        return;
      }
      
      if (!email.includes('@')) {
        showError('Por favor ingresa un email válido');
        return;
      }
      
      loginBtn.disabled = true;
      loginBtn.textContent = 'Iniciando sesión...';
      
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        console.log('Usuario autenticado:', user);

        await createOrUpdateUserDocument(user);

        // Verificar si el usuario está aprobado
        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const userRef = doc(db, 'usuarios', user.uid);
        const userDoc = await getDoc(userRef);

        if (userDoc.exists()) {
          const userData = userDoc.data();
          if (userData.approved === false || userData.role === 'pending') {
            await auth.signOut();
            showError('⏳ Tu cuenta está pendiente de aprobación por un administrador.\n\nRecibirás un email cuando sea aprobada.');
            loginBtn.disabled = false;
            loginBtn.textContent = 'INGRESAR';
            return;
          }
        }

        localStorage.setItem('userAuthenticated', 'true');
        localStorage.setItem('userEmail', user.email);
        localStorage.setItem('userDisplayName', user.displayName || user.email.split('@')[0]);
        localStorage.setItem('userPhotoURL', user.photoURL || '');

        window.location.href = 'marketplace.html';
        
      } catch (error) {
        console.error('Error en login:', error);
        let errorMessage = 'Error al iniciar sesión';
        
        switch (error.code) {
          case 'auth/user-not-found':
            errorMessage = 'Usuario no encontrado';
            break;
          case 'auth/wrong-password':
            errorMessage = 'Contraseña incorrecta';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Email inválido';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Demasiados intentos fallidos. Intenta más tarde.';
            break;
        }
        
        showError(errorMessage);
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    }
    
    // Función de Google login extraída
    async function handleGoogleLogin() {
      googleBtn.disabled = true;
      googleBtn.textContent = 'Iniciando con Google...';
      
      try {
        const result = await signInWithPopup(auth, googleProvider);
        const user = result.user;
        console.log('Usuario autenticado con Google:', user);

        await createOrUpdateUserDocument(user);

        // Verificar si el usuario está aprobado
        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const userRef = doc(db, 'usuarios', user.uid);
        const userDoc = await getDoc(userRef);

        if (userDoc.exists()) {
          const userData = userDoc.data();
          if (userData.approved === false || userData.role === 'pending') {
            await auth.signOut();
            showError('⏳ Tu cuenta está pendiente de aprobación por un administrador.\n\nRecibirás un email cuando sea aprobada.');
            googleBtn.disabled = false;
            googleBtn.textContent = 'Continuar con Google';
            return;
          }
        }

        localStorage.setItem('userAuthenticated', 'true');
        localStorage.setItem('userEmail', user.email);
        localStorage.setItem('userDisplayName', user.displayName);
        localStorage.setItem('userPhotoURL', user.photoURL);

        window.location.href = 'marketplace.html';
        
      } catch (error) {
        console.error('Error en login con Google:', error);
        let errorMessage = 'Error al iniciar sesión con Google';
        
        switch (error.code) {
          case 'auth/popup-closed-by-user':
            errorMessage = 'Ventana cerrada por el usuario';
            break;
          case 'auth/popup-blocked':
            errorMessage = 'Popup bloqueado por el navegador';
            break;
          case 'auth/cancelled-popup-request':
            errorMessage = 'Solicitud cancelada';
            break;
          case 'auth/operation-not-allowed':
            errorMessage = 'Login con Google deshabilitado';
            break;
        }
        
        showError(errorMessage);
      } finally {
        googleBtn.disabled = false;
        googleBtn.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          Continuar con Google
        `;
      }
    }
  </script>
  
  <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
  <script>
    // Initialize Material Design Components
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize all buttons
      const buttons = document.querySelectorAll('.mdc-button');
      buttons.forEach(button => mdc.ripple.MDCRipple.attachTo(button));
      
      // Initialize text fields
      const textFields = document.querySelectorAll('.mdc-text-field');
      textFields.forEach(textField => mdc.textField.MDCTextField.attachTo(textField));
    });
  </script>
</body>
</html>
