<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>South Traders</title>
  
  <!-- Material Design CSS -->
  <link href="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { 
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; 
      color-scheme: dark;
      --mdc-theme-primary: #4CAF50;
      --mdc-theme-secondary: #2a2a33;
      --mdc-theme-surface: #1e1e24;
      --mdc-theme-background: #0f0f10;
      --mdc-theme-on-primary: #ffffff;
      --mdc-theme-on-secondary: #ffffff;
      --mdc-theme-on-surface: #f1f1f1;
      --mdc-theme-on-background: #f1f1f1;
    }
    
    /* Material Design custom overrides for better visibility */
    .mdc-tab {
      color: #d0d0d0 !important; /* Color m√°s claro para tabs no seleccionados */
      background-color: #1b1b1f !important;
      border-radius: 6px 6px 0 0 !important;
      border: 1px solid #2a2a2a !important;
      border-bottom: none !important;
      margin-right: 4px !important;
    }
    
    .mdc-tab--active {
      color: #ffffff !important; /* Color para tab seleccionado */
      background-color: #23232a !important;
      font-weight: 600 !important;
    }
    
    .mdc-tab:hover:not(.mdc-tab--active) {
      color: #e8e8e8 !important; /* Color en hover para mejor visibilidad */
      background-color: #2a2a2f !important;
    }
    
    .mdc-tab-indicator__content--underline {
      border-color: #4CAF50 !important;
      border-width: 3px !important;
    }
    
    /* Fix for all text elements that might appear black */
    .mdc-tab__text-label,
    .mdc-button__label,
    .mdc-floating-label,
    .mdc-text-field__input,
    .mdc-form-field > label,
    .mdc-checkbox ~ label,
    span, p, div, h1, h2, h3, h4, h5, h6 {
      color: inherit !important;
    }
    
    /* Specific overrides for Material components */
    .mdc-tab__text-label {
      color: inherit !important;
    }
    
    .mdc-button__label {
      color: inherit !important;
    }
    
    /* Text field improvements */
    .mdc-text-field--outlined {
      background-color: #1b1b1f !important;
      box-shadow: none !important; /* Eliminar cualquier sombra por defecto */
    }
    
    .mdc-text-field--outlined .mdc-notched-outline__leading,
    .mdc-text-field--outlined .mdc-notched-outline__notch,
    .mdc-text-field--outlined .mdc-notched-outline__trailing {
      border-color: #3a3a44 !important;
    }
    
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__leading,
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__notch,
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__trailing {
      border-color: #4CAF50 !important;
    }
    
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__leading,
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__notch,
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__trailing {
      border-color: #4CAF50 !important;
      border-width: 2px !important;
    }
    
    .mdc-text-field__input {
      color: #f1f1f1 !important;
    }
    
    .mdc-floating-label {
      color: #d0d0d0 !important; /* Gris m√°s claro */
    }
    
    .mdc-text-field--focused .mdc-floating-label {
      color: #4CAF50 !important;
    }
    
    /* Button improvements */
    .mdc-button {
      color: #f1f1f1 !important;
    }
    
    .mdc-button--raised {
      background-color: #4CAF50 !important;
      color: #ffffff !important;
    }
    
    .mdc-button--outlined {
      border-color: #3a3a44 !important;
      color: #f1f1f1 !important;
    }
    
    .mdc-button--outlined:hover {
      background-color: #2a2a33 !important;
      border-color: #4CAF50 !important;
    }
    
    /* Checkbox improvements */
    .mdc-checkbox__native-control:enabled:checked ~ .mdc-checkbox__background {
      background-color: #4CAF50 !important;
      border-color: #4CAF50 !important;
    }
    
    .mdc-checkbox__background {
      border-color: #3a3a44 !important;
    }
    
    .mdc-form-field > label {
      color: #f1f1f1 !important;
    }
    
    /* General text color fixes */
    .status {
      color: #d0d0d0 !important;
    }
    
    /* Prevent any black text */
    * {
      color: inherit;
    }
    
    /* Ensure all Material Design components inherit proper colors */
    .mdc-tab *, 
    .mdc-button *, 
    .mdc-text-field *, 
    .mdc-checkbox *,
    .mdc-form-field * {
      color: inherit !important;
    }
    
    body { 
      margin: 0; 
      padding: 0; 
      background: #0f0f10; 
      color: #f1f1f1; 
      min-height: 100vh;
      width: 100%; 
      max-width: 100%; 
      overflow-x: hidden; 
      box-sizing: border-box;
    }
    header {
      padding: 16px;
      border-bottom: 1px solid #2a2a2a;
      background: #121214;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-logo { height: auto; max-width: 150px; width: 100%; object-fit: contain; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    h1 { 
      margin: 0; 
      font-size: 24px;
      color: #fafafa; 
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .cart-container { 
      background: #1e1e24; 
      padding: 30px; 
      border-radius: 8px; 
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #2a2a2a;
    }
    th {
      background: #23232a;
      color: #ffffff;
      font-weight: 600;
    }
    tr:hover {
      background-color: #2a2a33;
    }
    .btn {
      padding: 10px 20px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    .btn-primary:hover {
      background: #45a049;
    }
    .btn-secondary {
      background: #2a2a33;
      color: #f1f1f1;
      border: 1px solid #3a3a44;
    }
    .btn-secondary:hover {
      background: #34343c;
    }
    .text-right {
      text-align: right;
    }
    .empty-cart {
      text-align: center;
      padding: 40px 0;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }
    .total-row {
      font-weight: bold;
      font-size: 1.1em;
    }
    th.sortable {
      cursor: pointer;
      user-select: none;
    }
    th.sortable:hover {
      background-color: #2a2a33;
    }
    th.sortable::after {
      content: ' ‚Üï';
      opacity: 0.5;
      font-size: 12px;
    }
    th.sortable.asc::after {
      content: ' ‚Üë';
      opacity: 1;
    }
    th.sortable.desc::after {
      content: ' ‚Üì';
      opacity: 1;
    }
    .quantity-input {
      width: 60px;
      padding: 5px;
      text-align: center;
      background: #2a2a33;
      color: #f1f1f1;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      font-size: 14px;
    }
    .quantity-input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    /* Modal de √©xito */
    .success-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      animation: fadeIn 0.3s;
    }
    .success-modal-content {
      background-color: #1e1e24;
      margin: 10% auto;
      padding: 40px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      animation: slideDown 0.3s;
      border: 2px solid #4CAF50;
    }
    .success-icon {
      font-size: 80px;
      color: #4CAF50;
      margin-bottom: 20px;
    }
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #3a3a44;
      border-top: 6px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .success-title {
      font-size: 28px;
      color: #4CAF50;
      margin-bottom: 15px;
      font-weight: 600;
    }
    .success-message {
      font-size: 16px;
      color: #d0d0d0;
      margin-bottom: 10px;
      line-height: 1.6;
    }
    .order-number {
      font-size: 24px;
      color: #4CAF50;
      font-weight: 700;
      margin: 20px 0;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideDown {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Client selector for admin */
    .client-selector-container {
      margin-top: 20px;
      padding: 20px;
      background: #15151a;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
    }
    .client-selector-label {
      display: block;
      margin-bottom: 10px;
      color: #4CAF50;
      font-weight: 600;
      font-size: 14px;
    }
    .client-selector {
      width: 100%;
      padding: 10px;
      background: #2a2a33;
      color: #f1f1f1;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    .client-selector:focus {
      outline: none;
      border-color: #4CAF50;
    }
    .client-selector option {
      background: #2a2a33;
      color: #f1f1f1;
    }

    /* Ocultar logo en dispositivos m√≥viles */
    @media (max-width: 768px) {
      .header-logo {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <img src="logo.png" alt="Logo" class="header-logo">
      <h1>Carrito de Compras</h1>
    </div>
    <a href="marketplace.html" class="mdc-button mdc-button--outlined" style="text-decoration: none;">
      <span class="mdc-button__ripple"></span>
      <i class="material-icons mdc-button__icon" aria-hidden="true">arrow_back</i>
      <span class="mdc-button__label">Volver al Cat√°logo</span>
    </a>
  </header>
  
  <div class="container">
    <div class="cart-container">
      <div id="cartSummary">
        <div class="empty-cart">
          <p>Tu carrito est√° vac√≠o</p>
          <a href="marketplace.html" class="btn btn-primary" style="margin-top: 15px;">
            Seguir Comprando
          </a>
        </div>
      </div>

      <!-- Contenedor para selector de clientes (solo admin) -->
      <div id="clientSelectorContainer" class="client-selector-container" style="display: none;"></div>
    </div>
  </div>

  <!-- Modal de √©xito -->
  <!-- Loading Modal -->
  <div id="loadingModal" class="success-modal" style="display: none;">
    <div class="success-modal-content">
      <div class="loading-spinner"></div>
      <h2 class="success-title">Procesando orden...</h2>
      <p class="success-message" id="loadingMessage">Generando PDF y enviando WhatsApp</p>
    </div>
  </div>

  <div id="successModal" class="success-modal">
    <div class="success-modal-content">
      <div class="success-icon">‚úì</div>
      <h2 class="success-title">¬°Orden Confirmada!</h2>
      <p class="success-message">Tu orden ha sido enviada exitosamente</p>
      <div class="order-number" id="orderNumberDisplay"></div>
      <p class="success-message">Se ha notificado a tu vendedor por WhatsApp</p>
      <button class="mdc-button mdc-button--raised" onclick="window.location.href='marketplace.html'" style="margin-top: 20px;">
        <span class="mdc-button__ripple"></span>
        <span class="mdc-button__label">Volver al Cat√°logo</span>
      </button>
    </div>
  </div>

  <!-- Firebase -->
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, query, orderBy, getDocs, where, limit, runTransaction, Timestamp, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import ErrorLogger from './error-logger.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCXjSGtVGfQas_cEyjmI0RTaeEl94jdp6g",
      authDomain: "carrito-138c3.firebaseapp.com",
      projectId: "carrito-138c3",
      storageBucket: "carrito-138c3.firebasestorage.app",
      messagingSenderId: "579670725719",
      appId: "1:579670725719:web:carrito138c3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Inicializar sistema de logging de errores
    const errorLogger = new ErrorLogger(app);
    window.errorLogger = errorLogger;

    // Hacer Firebase accesible globalmente
    window.firebase = {
      app: () => app,
      auth: () => auth,
      firestore: () => db,
      storage: () => storage,
      storageHelpers: {
        ref, uploadBytes, getDownloadURL
      },
      firestoreHelpers: {
        doc, getDoc, setDoc, addDoc, updateDoc, collection, query, orderBy, getDocs, where, limit, runTransaction, Timestamp, serverTimestamp
      }
    };

    // Verificar autenticaci√≥n y permisos admin
    let authCheckTimeout;
    window.isUserAdmin = false;

    onAuthStateChanged(auth, async (user) => {
      // Limpiar timeout previo
      if (authCheckTimeout) {
        clearTimeout(authCheckTimeout);
      }

      window.currentUser = user;
      errorLogger.setCurrentUser(user); // Actualizar usuario en error logger
      if (user) {
        console.log('‚úÖ Usuario autenticado:', user.email);

        // Verificar si es admin
        try {
          const userRef = doc(db, 'usuarios', user.uid);
          const userDoc = await getDoc(userRef);

          if (userDoc.exists()) {
            const userData = userDoc.data();
            window.isUserAdmin = userData.admin === true;
            console.log('üîê Usuario es admin:', window.isUserAdmin);

            // Si es admin, cargar dropdown de clientes
            if (window.isUserAdmin) {
              await loadClientesDropdown();
              // Re-renderizar el carrito con las opciones de admin
              initCart();
            }
          }
        } catch (error) {
          console.error('‚ùå Error verificando permisos:', error);
          window.isUserAdmin = false;
        }
      } else {
        // Dar 3 segundos para que Firebase cargue la sesi√≥n
        authCheckTimeout = setTimeout(() => {
          if (!window.currentUser) {
            console.log('‚ö†Ô∏è Usuario no autenticado despu√©s de esperar, redirigiendo a login...');
            alert('Debes iniciar sesi√≥n para acceder al carrito');
            window.location.href = 'login.html';
          }
        }, 3000);
      }
    });
  </script>

  <script>
    // Variable global para almacenar cliente seleccionado
    window.selectedClienteData = null;

    // Cargar dropdown de clientes para admin
    async function loadClientesDropdown() {
      try {
        console.log('üìã Cargando clientes para dropdown admin...');

        const { collection, getDocs } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();

        const clientesRef = collection(db, 'clientes');
        const clientesSnapshot = await getDocs(clientesRef);

        const clientes = [];
        clientesSnapshot.forEach(doc => {
          const data = doc.data();

          // Filtrar clientes creados desde admisiones (solo mostrar clientes principales)
          if (data.creadoDesdeAdmision === true) {
            console.log(`‚è≠Ô∏è Ignorando cliente creado desde admisi√≥n: ${doc.id}`);
            return;
          }

          // Prioridad: nombreComercial > nombre > name > email
          let displayName = data.nombreComercial || data.nombre || data.name || data.email || 'Sin nombre';

          // Si tiene nombreComercial y nombre, mostrar ambos
          if (data.nombreComercial && data.nombre && data.nombreComercial !== data.nombre) {
            displayName = `${data.nombreComercial} - ${data.nombre}`;
          }

          clientes.push({
            id: doc.id,
            nombre: displayName,
            codigo: data.codigo || '',
            email: data.email || '',
            vendedorId: data.vendedorId || data.vendedor || null
          });
        });

        // Ordenar por c√≥digo num√©rico
        clientes.sort((a, b) => {
          const codigoA = parseInt(a.codigo) || 0;
          const codigoB = parseInt(b.codigo) || 0;
          return codigoA - codigoB;
        });

        console.log(`‚úÖ ${clientes.length} clientes cargados`);

        // Buscar el contenedor del dropdown
        const dropdownContainer = document.getElementById('clientSelectorContainer');
        if (!dropdownContainer) {
          console.warn('‚ö†Ô∏è Container para dropdown de clientes no encontrado');
          return;
        }

        // Crear el HTML del dropdown
        let html = `
          <label class="client-selector-label">
            üë• Seleccionar Cliente (Admin):
          </label>
          <select id="clientSelector" class="client-selector">
            <option value="">-- Usar mi usuario (${window.currentUser.email}) --</option>
        `;

        clientes.forEach(cliente => {
          // Mostrar: [Codigo] Nombre (email) si tiene c√≥digo, sino solo Nombre (email)
          const displayText = cliente.codigo
            ? `[${cliente.codigo}] ${cliente.nombre}${cliente.email ? ' (' + cliente.email + ')' : ''}`
            : `${cliente.nombre}${cliente.email ? ' (' + cliente.email + ')' : ''}`;

          html += `<option value="${cliente.id}" data-email="${cliente.email}" data-vendedor="${cliente.vendedorId || ''}">${displayText}</option>`;
        });

        html += `</select>`;

        dropdownContainer.innerHTML = html;
        dropdownContainer.style.display = 'block';

        // Agregar event listener al selector
        const selector = document.getElementById('clientSelector');
        if (selector) {
          selector.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (this.value) {
              window.selectedClienteData = {
                id: this.value,
                email: selectedOption.getAttribute('data-email'),
                nombre: selectedOption.textContent.split(' (')[0],
                vendedorId: selectedOption.getAttribute('data-vendedor') || null,
                codigo: selectedOption.textContent.match(/\[(\d+)\]/)?.[1] || ''
              };
              console.log('üë§ Cliente seleccionado:', window.selectedClienteData);
            } else {
              window.selectedClienteData = null;
              console.log('üë§ Usando usuario actual');
            }

            // Actualizar el display en el carrito si existe
            const displayElement = document.getElementById('selectedClienteDisplay');
            if (displayElement) {
              const nombre = window.selectedClienteData?.nombre || window.currentUser?.email || 'No seleccionado';
              const codigo = window.selectedClienteData?.codigo || '';
              displayElement.textContent = codigo ? `[${codigo}] ${nombre}` : nombre;
            }
          });
        }

        console.log('‚úÖ Dropdown de clientes creado');

      } catch (error) {
        console.error('‚ùå Error cargando clientes:', error);
      }
    }

    // Esperar a que Firebase est√© listo
    function initCart() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const container = document.getElementById('cartSummary');
      const editingOrderId = localStorage.getItem('editingOrderId');

      if (!container) return;

      if (cart.length === 0) {
        // Limpiar editingOrderId si el carrito est√° vac√≠o
        localStorage.removeItem('editingOrderId');

        // Mostrar mensaje de carrito vac√≠o
        container.innerHTML = `
          <div class="empty-cart">
            <p>Tu carrito est√° vac√≠o</p>
            <a href="marketplace.html" class="mdc-button mdc-button--raised" style="margin-top: 15px; text-decoration: none;">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">shopping_cart</i>
              <span class="mdc-button__label">Seguir Comprando</span>
            </a>
          </div>
        `;
        return;
      }

      let total = 0;
      let totalItems = 0;

      // Mostrar indicador si se est√° editando una orden
      let editingIndicator = '';
      if (editingOrderId) {
        editingIndicator = `
          <div style="background: #2a2a33; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #FFC107;">
            <span style="color: #FFC107; font-weight: 600;">‚úèÔ∏è Editando Orden</span>
            <p style="margin: 5px 0 0 0; color: #b5b5b5; font-size: 14px;">
              Est√°s modificando una orden existente. Al confirmar se actualizar√° la orden original.
            </p>
          </div>
        `;
      }

      // Selector de cliente para admin
      let clienteSelector = '';
      if (window.isUserAdmin) {
        const currentClienteName = window.selectedClienteData?.nombre || window.currentUser?.email || 'No seleccionado';
        const currentClienteCodigo = window.selectedClienteData?.codigo || '';
        const displayText = currentClienteCodigo ? `[${currentClienteCodigo}] ${currentClienteName}` : currentClienteName;

        clienteSelector = `
          <div style="background: #2a2a33; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4CAF50; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
              <div style="flex: 1; min-width: 200px;">
                <div style="font-weight: 600; color: #4CAF50; font-size: 16px; margin-bottom: 8px;">
                  üë§ CLIENTE DE ESTA ORDEN
                </div>
                <div style="color: #ffffff; font-size: 18px; font-weight: 500;" id="selectedClienteDisplay">
                  ${displayText}
                </div>
                <div style="color: #b5b5b5; font-size: 13px; margin-top: 4px;">
                  Haz clic en "Cambiar Cliente" para asignar esta orden a otro cliente
                </div>
              </div>
              <button id="changeClienteBtn" class="mdc-button mdc-button--raised" style="background-color: #4CAF50; color: white; padding: 10px 20px;">
                <span class="mdc-button__ripple"></span>
                <i class="material-icons mdc-button__icon" style="font-size: 20px;">swap_horiz</i>
                <span class="mdc-button__label" style="font-size: 14px;">Cambiar Cliente</span>
              </button>
            </div>
          </div>
        `;
      }

      let html = editingIndicator + clienteSelector + `
        <table id="cartTable">
          <thead>
            <tr>
              <th class="sortable" data-sort="item">Item</th>
              <th class="sortable" data-sort="description">Descripci√≥n</th>
              <th class="sortable text-right" data-sort="price">Precio Unit.</th>
              <th class="sortable text-right" data-sort="quantity">Cantidad</th>
              <th class="sortable text-right" data-sort="total">Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
      `;

      cart.forEach((item, index) => {
        const rowTotal = item.price * item.quantity;
        total += rowTotal;
        totalItems += item.quantity;

        // Admin puede editar precio
        const priceCell = window.isUserAdmin
          ? `<td class="text-right">
               $<input type="number"
                      class="price-input"
                      data-index="${index}"
                      value="${item.price.toFixed(2)}"
                      min="0"
                      step="0.01"
                      style="width: 80px; padding: 4px; text-align: right; border: 1px solid #ddd; border-radius: 4px;">
             </td>`
          : `<td class="text-right">$${item.price.toFixed(2)}</td>`;

        html += `
          <tr data-item-id="${item.item}">
            <td>${item.item}</td>
            <td>${item.description}</td>
            ${priceCell}
            <td class="text-right">
              <input type="number"
                     class="quantity-input"
                     data-index="${index}"
                     value="${item.quantity}"
                     min="1"
                     max="9999">
            </td>
            <td class="text-right" id="row-total-${index}">$${rowTotal.toFixed(2)}</td>
            <td class="text-right">
              <button class="mdc-button mdc-button--outlined remove-item" data-index="${index}" style="padding: 5px 10px; font-size: 12px;">
                <span class="mdc-button__ripple"></span>
                <i class="material-icons mdc-button__icon" aria-hidden="true">delete</i>
                <span class="mdc-button__label">Eliminar</span>
              </button>
            </td>
          </tr>
        `;
      });

      html += `
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-right"><strong>Total Items:</strong></td>
              <td class="text-right"><strong>${totalItems}</strong></td>
              <td colspan="2"></td>
            </tr>
            <tr class="total-row">
              <td colspan="4" class="text-right"><strong>Total:</strong></td>
              <td class="text-right"><strong>$${total.toFixed(2)}</strong></td>
              <td></td>
            </tr>
          </tfoot>
        </table>

        <div class="actions">
          <a href="marketplace.html" class="mdc-button mdc-button--outlined" style="text-decoration: none;">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">arrow_back</i>
            <span class="mdc-button__label">Seguir Comprando</span>
          </a>
          <button id="checkoutBtn" class="mdc-button mdc-button--raised">
            <span class="mdc-button__ripple"></span>
            <span class="mdc-button__label">${editingOrderId ? 'ACTUALIZAR ORDEN' : 'CONFIRMAR ORDEN'}</span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">${editingOrderId ? 'update' : 'check_circle'}</i>
          </button>
        </div>
      `;
      
      container.innerHTML = html;
      
      // Agregar manejadores de eventos para los botones de eliminar
      document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          removeItemFromCart(index);
        });
      });

      // Agregar manejadores para los inputs de cantidad
      document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', function() {
          const index = parseInt(this.getAttribute('data-index'));
          const newQuantity = parseInt(this.value);
          updateItemQuantity(index, newQuantity);
        });
      });

      // Agregar manejadores para los inputs de precio (solo admin)
      document.querySelectorAll('.price-input').forEach(input => {
        input.addEventListener('change', function() {
          const index = parseInt(this.getAttribute('data-index'));
          const newPrice = parseFloat(this.value);
          updateItemPrice(index, newPrice);
        });
      });

      // Manejador para el bot√≥n de cambiar cliente (solo admin)
      const changeClienteBtn = document.getElementById('changeClienteBtn');
      if (changeClienteBtn && window.isUserAdmin) {
        changeClienteBtn.addEventListener('click', function() {
          // Abrir modal de selecci√≥n de cliente (el mismo que ya existe)
          openClienteSelectionModal();
        });
      }

      // Manejador para el bot√≥n de confirmar orden
      const checkoutBtn = document.getElementById('checkoutBtn');
      if (checkoutBtn) {
        checkoutBtn.addEventListener('click', async function() {
          await confirmOrder();
        });
      }
    }

    // Funci√≥n para abrir modal de selecci√≥n de cliente
    function openClienteSelectionModal() {
      // Hacer scroll hasta el dropdown de clientes
      const clientSelector = document.getElementById('clientSelectorContainer');
      if (clientSelector) {
        clientSelector.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Resaltar brevemente el selector
        const selector = document.getElementById('clientSelector');
        if (selector) {
          selector.style.transition = 'all 0.3s';
          selector.style.border = '2px solid #4CAF50';
          selector.style.boxShadow = '0 0 10px rgba(76, 175, 80, 0.5)';
          selector.focus();

          setTimeout(() => {
            selector.style.border = '';
            selector.style.boxShadow = '';
          }, 2000);
        }
      }
    }

    // Sorting state
    let currentSort = {
      column: null,
      direction: 'asc'
    };

    // Handle column sorting
    function handleSortClick(e) {
      const th = e.target.closest('th.sortable');
      if (!th) return;

      const column = th.getAttribute('data-sort');
      if (currentSort.column === column) {
        // Toggle direction if same column clicked
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        // Set new column and default to ascending
        currentSort.column = column;
        currentSort.direction = 'asc';
      }

      // Update visual indicators
      document.querySelectorAll('th.sortable').forEach(header => {
        header.classList.remove('asc', 'desc');
      });
      th.classList.add(currentSort.direction);

      // Sort and re-render
      sortAndRenderCart();
    }

    function sortAndRenderCart() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');

      if (cart.length === 0 || !currentSort.column) {
        initCart();
        return;
      }

      // Sort the cart array
      cart.sort((a, b) => {
        let aVal, bVal;

        switch(currentSort.column) {
          case 'item':
            aVal = a.item || '';
            bVal = b.item || '';
            break;
          case 'description':
            aVal = a.description || '';
            bVal = b.description || '';
            break;
          case 'price':
            aVal = a.price || 0;
            bVal = b.price || 0;
            break;
          case 'quantity':
            aVal = a.quantity || 0;
            bVal = b.quantity || 0;
            break;
          case 'total':
            aVal = (a.price || 0) * (a.quantity || 0);
            bVal = (b.price || 0) * (b.quantity || 0);
            break;
          default:
            return 0;
        }

        const dir = currentSort.direction === 'asc' ? 1 : -1;

        if (typeof aVal === 'string') {
          return aVal.localeCompare(bVal) * dir;
        }
        return (aVal - bVal) * dir;
      });

      // Save sorted cart back to localStorage
      localStorage.setItem('cart', JSON.stringify(cart));

      // Re-render
      initCart();

      // Re-attach sort event listeners after render
      attachSortListeners();
    }

    function attachSortListeners() {
      const sortableHeaders = document.querySelectorAll('th.sortable');
      sortableHeaders.forEach(th => {
        th.addEventListener('click', handleSortClick);
      });

      // Restore visual indicators
      if (currentSort.column) {
        const activeHeader = document.querySelector(`th.sortable[data-sort="${currentSort.column}"]`);
        if (activeHeader) {
          activeHeader.classList.add(currentSort.direction);
        }
      }
    }

    // Inicializar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', () => {
      initCart();
      attachSortListeners();
    });

    function removeItemFromCart(index) {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      if (index >= 0 && index < cart.length) {
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        // Recargar la p√°gina para actualizar la vista
        window.location.reload();
      }
    }

    function updateItemQuantity(index, newQuantity) {
      if (newQuantity < 1) newQuantity = 1;
      if (newQuantity > 9999) newQuantity = 9999;

      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      if (index >= 0 && index < cart.length) {
        cart[index].quantity = newQuantity;
        localStorage.setItem('cart', JSON.stringify(cart));
        // Recargar la p√°gina para actualizar los totales
        window.location.reload();
      }
    }

    // Funci√≥n para actualizar el precio de un item (solo admin)
    function updateItemPrice(index, newPrice) {
      if (!window.isUserAdmin) {
        console.warn('Solo administradores pueden editar precios');
        return;
      }

      if (newPrice < 0) newPrice = 0;

      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      if (index >= 0 && index < cart.length) {
        cart[index].price = newPrice;
        localStorage.setItem('cart', JSON.stringify(cart));
        // Recargar la p√°gina para actualizar los totales
        window.location.reload();
      }
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    async function getNextOrderNumber() {
      try {
        const { doc, runTransaction, collection, query, orderBy, limit, getDocs } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();

        // Usar un documento contador para generar n√∫meros secuenciales √∫nicos
        const counterRef = doc(db, 'counters', 'orderNumber');

        const newOrderNumber = await runTransaction(db, async (transaction) => {
          const counterDoc = await transaction.get(counterRef);

          let nextNumber;
          if (!counterDoc.exists()) {
            // Primera vez: buscar el √∫ltimo n√∫mero en la BD
            console.log('üîÑ Inicializando contador de √≥rdenes...');
            const pedidosRef = collection(db, 'pedidos');
            const q = query(pedidosRef, orderBy('numeroOrden', 'desc'), limit(1));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
              nextNumber = 10000;
            } else {
              const lastOrder = querySnapshot.docs[0].data();
              nextNumber = (lastOrder.numeroOrden || 10000) + 1;
            }

            // Crear el contador
            transaction.set(counterRef, { value: nextNumber });
          } else {
            // Incrementar el contador existente
            const currentValue = counterDoc.data().value || 10000;
            nextNumber = currentValue + 1;
            transaction.update(counterRef, { value: nextNumber });
          }

          return nextNumber;
        });

        console.log('‚úÖ Nuevo n√∫mero de orden generado:', newOrderNumber);
        return newOrderNumber;

      } catch (error) {
        console.error('‚ùå Error obteniendo siguiente n√∫mero de orden:', error);

        // Fallback: intentar obtener de la BD directamente (sin transacci√≥n)
        try {
          const { collection, query, orderBy, limit, getDocs } = window.firebase.firestoreHelpers;
          const db = window.firebase.firestore();

          const pedidosRef = collection(db, 'pedidos');
          const q = query(pedidosRef, orderBy('numeroOrden', 'desc'), limit(1));
          const querySnapshot = await getDocs(q);

          if (querySnapshot.empty) {
            return 10000;
          } else {
            const lastOrder = querySnapshot.docs[0].data();
            return (lastOrder.numeroOrden || 10000) + 1;
          }
        } catch (fallbackError) {
          console.error('‚ùå Error en fallback:', fallbackError);
          // √öltimo recurso: usar timestamp para minimizar colisiones
          return 10000 + (Date.now() % 90000);
        }
      }
    }

    async function confirmOrder() {
      try {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        if (cart.length === 0) {
          alert('El carrito est√° vac√≠o');
          return;
        }

        // Esperar un momento para que Firebase termine de inicializar
        let attempts = 0;
        while (!window.currentUser && attempts < 20) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }

        if (!window.currentUser) {
          alert('Debes iniciar sesi√≥n para confirmar la orden');
          window.location.href = 'login.html';
          return;
        }

        // Verificar que Firebase est√© correctamente inicializado
        if (!window.firebase || !window.firebase.firestoreHelpers) {
          console.error('‚ùå Firebase no est√° inicializado correctamente');
          alert('Error: El sistema no est√° listo. Por favor recarga la p√°gina.');
          return;
        }

        console.log('‚úÖ Usuario autenticado:', window.currentUser.email);
        console.log('‚úÖ Firebase inicializado correctamente');

        // Verificar que el usuario est√© aprobado
        try {
          const { doc, getDoc } = window.firebase.firestoreHelpers;
          const db = window.firebase.firestore();
          const userRef = doc(db, 'usuarios', window.currentUser.uid);
          const userDoc = await getDoc(userRef);

          if (!userDoc.exists()) {
            console.error('‚ùå Usuario no tiene documento en Firestore');
            alert('Error: Tu perfil no est√° configurado correctamente.\n\nPor favor contacta al administrador.');
            return;
          }

          const userData = userDoc.data();
          console.log('üë§ Datos del usuario:', userData);

          if (userData.approved === false || userData.role === 'pending') {
            console.warn('‚ö†Ô∏è Usuario no aprobado:', userData);
            alert('‚è≥ Tu cuenta est√° pendiente de aprobaci√≥n.\n\nNo puedes crear √≥rdenes hasta que un administrador apruebe tu cuenta.\n\nRecibir√°s un email cuando sea aprobada.');
            return;
          }

          console.log('‚úÖ Usuario aprobado, puede crear √≥rdenes');
        } catch (userCheckError) {
          console.error('‚ùå Error al verificar estado del usuario:', userCheckError);

          // Registrar error
          errorLogger.logError({
            errorMessage: 'Error al verificar tu cuenta',
            stackTrace: userCheckError.stack || '',
            errorType: 'user_verification_error',
            additionalData: {
              originalError: userCheckError.message,
              errorName: userCheckError.name
            }
          });

          alert('Error al verificar tu cuenta. Por favor intenta de nuevo o contacta al administrador.');
          return;
        }

        const editingOrderId = localStorage.getItem('editingOrderId');
        let isEditing = !!editingOrderId;

        console.log(isEditing ? 'üìù Verificando orden existente...' : 'üì¶ Confirmando orden nueva...');

        // Obtener n√∫mero de orden (solo si es nueva, si se est√° editando usar el existente)
        let orderNumber;
        let existingOrderData = null;

        if (isEditing) {
          // Obtener datos de la orden existente
          const { doc, getDoc } = window.firebase.firestoreHelpers;
          const db = window.firebase.firestore();
          const orderRef = doc(db, 'pedidos', editingOrderId);
          const orderDoc = await getDoc(orderRef);

          if (orderDoc.exists()) {
            existingOrderData = orderDoc.data();
            orderNumber = existingOrderData.numeroOrden;
            console.log('üìã Actualizando orden existente #', orderNumber);
          } else {
            console.warn('‚ö†Ô∏è La orden a editar no existe. Limpiando editingOrderId y creando nueva orden.');
            localStorage.removeItem('editingOrderId');
            // Cambiar a modo crear nueva orden
            isEditing = false;
            orderNumber = await getNextOrderNumber();
            console.log('üìã N√∫mero de orden nueva:', orderNumber);
          }
        } else {
          orderNumber = await getNextOrderNumber();
          console.log('üìã N√∫mero de orden nueva:', orderNumber);
        }

        // Buscar datos del cliente
        const db = window.firebase.firestore();
        const { collection, query, where, limit, getDocs, doc, getDoc, addDoc, updateDoc, serverTimestamp } = window.firebase.firestoreHelpers;

        let clienteNombre = window.currentUser.email;
        let clienteEmail = window.currentUser.email;
        let clienteCodigo = '';
        let vendedorId = null;

        // Si estamos editando, usar los datos de la orden existente primero
        if (isEditing && existingOrderData) {
          clienteNombre = existingOrderData.clienteNombre || window.currentUser.email;
          clienteEmail = existingOrderData.clienteEmail || window.currentUser.email;
          clienteCodigo = existingOrderData.clienteCodigo || '';
          vendedorId = existingOrderData.vendedorId;
          console.log('üìã Usando datos de orden existente - Vendedor:', vendedorId);
        }
        // Si es admin y seleccion√≥ un cliente, usar ese cliente
        else if (window.isUserAdmin && window.selectedClienteData) {
          console.log('üë§ Admin cargando orden para cliente:', window.selectedClienteData.nombre);
          clienteNombre = window.selectedClienteData.nombre;
          clienteEmail = window.selectedClienteData.email;
          clienteCodigo = window.selectedClienteData.codigo || window.selectedClienteData.numero || '';
          vendedorId = window.selectedClienteData.vendedorId;
        } else {
          // Usuario normal o admin sin cliente seleccionado: usar su propio email
          const clientesRef = collection(db, 'clientes');
          const clientesQuery = query(clientesRef, where('email', '==', window.currentUser.email), limit(1));
          const clientesSnapshot = await getDocs(clientesQuery);

          if (!clientesSnapshot.empty) {
            const clienteData = clientesSnapshot.docs[0].data();
            clienteNombre = clienteData.nombre || clienteData.name || window.currentUser.email;
            clienteCodigo = clienteData.codigo || clienteData.numero || '';
            vendedorId = clienteData.vendedorId || clienteData.vendedor;
          }
        }

        // Preparar datos de la orden
        const now = new Date();
        const timestampNow = serverTimestamp(); // Usar serverTimestamp de Firestore (m√°s confiable)
        const fechaLocal = now.toLocaleDateString('es-AR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        let total = 0;
        let cantidadItems = 0;
        const items = cart.map(item => {
          const subtotal = item.price * item.quantity;
          total += subtotal;
          cantidadItems += item.quantity;
          return {
            articulo: item.item,
            description: item.description,
            quantity: item.quantity,
            price: item.price,
            subtotal: subtotal
          };
        });

        const orderToSave = {
          numeroOrden: orderNumber,
          usuarioEmail: window.currentUser.email, // Email del usuario que cre√≥ la orden
          usuarioUid: window.currentUser.uid,
          clienteEmail: clienteEmail, // Email del cliente (puede ser diferente si admin carga para otro)
          clienteNombre: clienteNombre,
          clienteCodigo: clienteCodigo || '', // C√≥digo del cliente (string vac√≠o si no existe)
          vendedorId: vendedorId || null, // null si no tiene vendedor asignado
          items: items,
          total: total,
          cantidadItems: cantidadItems,
          fecha: timestampNow, // Usar Timestamp de Firestore
          timestamp: timestampNow, // Para ordenar en marketplace.html
          fechaLocal: fechaLocal,
          logisticsState: isEditing ? (existingOrderData.logisticsState || 'borrador') : 'borrador',
          estado: isEditing ? (existingOrderData.estado || 'pendiente') : 'pendiente',
          creadoPorAdmin: window.isUserAdmin && window.selectedClienteData ? true : false
        };

        // Solo agregar campos de modificaci√≥n si estamos editando
        if (isEditing) {
          orderToSave.ultimaModificacion = timestampNow; // Usar Timestamp
          orderToSave.fechaUltimaModificacion = fechaLocal;
        }

        // Guardar o actualizar en Firebase
        console.log('üíæ Guardando orden en Firebase...', {
          numeroOrden: orderNumber,
          isEditing: isEditing,
          usuarioEmail: window.currentUser.email,
          clienteNombre: clienteNombre,
          total: total,
          cantidadItems: cantidadItems
        });

        try {
          if (isEditing) {
            // Actualizar orden existente
            const orderRef = doc(db, 'pedidos', editingOrderId);
            await updateDoc(orderRef, orderToSave);
            console.log('‚úÖ Orden actualizada en Firebase');
          } else {
            // Crear nueva orden
            const pedidosRef = collection(db, 'pedidos');
            const docRef = await addDoc(pedidosRef, orderToSave);
            console.log('‚úÖ Orden guardada en Firebase con ID:', docRef.id);
          }
        } catch (firebaseError) {
          console.error('‚ùå Error espec√≠fico al guardar en Firebase:', firebaseError);
          throw new Error(`Error al guardar en Firebase: ${firebaseError.message}`);
        }

        // Mostrar loading modal
        document.getElementById('loadingModal').style.display = 'block';
        document.getElementById('loadingMessage').textContent = 'Generando PDF y enviando WhatsApp...';

        // Enviar WhatsApp al vendedor (si no hay vendedor, se usa Santiago por defecto)
        console.log('üì± Preparando WhatsApp para vendedor:', vendedorId || 'Santiago (por defecto)');
        try {
          await sendOrderToSellerWhatsApp(orderToSave, orderNumber, clienteNombre);
          console.log('‚úÖ WhatsApp enviado correctamente');
        } catch (whatsappError) {
          console.error('‚ö†Ô∏è Error al enviar WhatsApp (no cr√≠tico):', whatsappError);
          // No lanzar error aqu√≠, el WhatsApp es opcional
        }

        // Ocultar loading modal
        document.getElementById('loadingModal').style.display = 'none';

        // Mostrar modal de √©xito
        document.getElementById('orderNumberDisplay').textContent = `Orden #${orderNumber}`;

        // Cambiar mensaje seg√∫n si es nueva o actualizaci√≥n
        const successMessage = document.querySelector('.success-title');
        if (isEditing) {
          successMessage.textContent = '¬°Orden Actualizada!';
        } else {
          successMessage.textContent = '¬°Orden Confirmada!';
        }

        document.getElementById('successModal').style.display = 'block';

        // Limpiar carrito y editingOrderId
        localStorage.removeItem('cart');
        localStorage.removeItem('editingOrderId');

      } catch (error) {
        console.error('‚ùå Error confirmando orden:', error);
        console.error('‚ùå Detalles del error:', error.message, error.stack);

        // Ocultar loading modal si est√° visible
        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal) {
          loadingModal.style.display = 'none';
        }

        // Mensaje de error m√°s detallado
        let errorMessage = 'Hubo un error al confirmar la orden.';

        if (error.message) {
          if (error.message.includes('permission') || error.message.includes('denied')) {
            errorMessage = 'No tienes permisos para crear √≥rdenes. Por favor contacta al administrador.';
          } else if (error.message.includes('network') || error.message.includes('fetch')) {
            errorMessage = 'Error de conexi√≥n. Verifica tu internet e intenta de nuevo.';
          } else if (error.message.includes('firebase') || error.message.includes('firestore')) {
            errorMessage = 'Error al guardar en la base de datos. Intenta de nuevo.';
          } else {
            errorMessage = `Error: ${error.message}`;
          }
        }

        // Registrar error antes de mostrar al usuario
        errorLogger.logError({
          errorMessage: errorMessage,
          stackTrace: error.stack || '',
          errorType: 'order_confirmation_error',
          additionalData: {
            originalError: error.message,
            errorName: error.name,
            action: 'confirmOrder'
          }
        });

        alert(errorMessage + '\n\nSi el problema persiste, contacta al administrador.');
      }
    }

    // Generar PDF de la orden
    async function generateOrderPDF(orderData, orderNumber, clienteNombre) {
      try {
        console.log('üìÑ [PDF] Generando PDF para orden #', orderNumber);

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Colores
        const primaryColor = [76, 175, 80]; // Verde
        const textColor = [51, 51, 51]; // Gris oscuro
        const lightGray = [240, 240, 240];

        // Header con fondo verde
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 40, 'F');

        // Logo (cargar desde la URL del sitio)
        try {
          const logoUrl = window.location.origin + '/logo.png';
          doc.addImage(logoUrl, 'PNG', 14, 12, 15, 12.5); // x, y, width, height (50% m√°s peque√±o)
        } catch (error) {
          console.warn('‚ö†Ô∏è No se pudo cargar el logo:', error);
        }

        // T√≠tulo a la derecha del logo
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont(undefined, 'bold');
        doc.text('ORDEN DE COMPRA', 105, 18, { align: 'center' });

        doc.setFontSize(18);
        doc.text(`#${orderNumber}`, 105, 28, { align: 'center' });

        // Informaci√≥n del cliente
        let yPos = 50;
        doc.setTextColor(...textColor);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('INFORMACI√ìN DEL CLIENTE', 14, yPos);

        yPos += 8;
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        // Formato: Cliente NOMBRE, CODIGO XXX
        const clienteTexto = orderData.clienteCodigo ? `${clienteNombre}, CODIGO ${orderData.clienteCodigo}` : clienteNombre;
        doc.text(`Cliente: ${clienteTexto}`, 14, yPos);
        yPos += 6;
        // Mostrar email del usuario que hizo la orden
        const emailUsuario = orderData.creadoPorAdmin ? orderData.usuarioEmail : (orderData.clienteEmail || orderData.usuarioEmail);
        doc.text(`Email: ${emailUsuario}`, 14, yPos);
        yPos += 6;
        doc.text(`Fecha: ${orderData.fechaLocal}`, 14, yPos);

        if (orderData.creadoPorAdmin) {
          yPos += 6;
          doc.setTextColor(255, 152, 0); // Naranja
          doc.text(`Creada por: ${orderData.usuarioEmail} (Admin)`, 14, yPos);
          doc.setTextColor(...textColor);
        }

        // Tabla de productos
        yPos += 12;

        const tableData = orderData.items.map((item, index) => [
          index + 1,
          item.articulo || '',
          item.description || '',
          item.quantity,
          '$' + formatNumber(item.price),
          '$' + formatNumber(item.quantity * item.price)
        ]);

        doc.autoTable({
          startY: yPos,
          head: [['#', 'C√≥digo', 'Descripci√≥n', 'Cant.', 'Precio Unit.', 'Subtotal']],
          body: tableData,
          theme: 'grid',
          headStyles: {
            fillColor: primaryColor,
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            halign: 'center'
          },
          columnStyles: {
            0: { halign: 'center', cellWidth: 10 },
            1: { halign: 'left', cellWidth: 25 },
            2: { halign: 'left', cellWidth: 80 },
            3: { halign: 'center', cellWidth: 20 },
            4: { halign: 'right', cellWidth: 30 },
            5: { halign: 'right', cellWidth: 30 }
          },
          styles: {
            fontSize: 9,
            cellPadding: 3
          }
        });

        // Total
        const finalY = doc.lastAutoTable.finalY || yPos;
        yPos = finalY + 10;

        doc.setFillColor(...lightGray);
        doc.rect(125, yPos - 5, 71, 12, 'F');

        doc.setFont(undefined, 'bold');
        doc.setFontSize(14);
        doc.setTextColor(...textColor);
        doc.text('TOTAL:', 130, yPos + 2);
        doc.setFontSize(16);
        doc.setTextColor(...primaryColor);
        doc.text('$' + formatNumber(orderData.total), 191, yPos + 2, { align: 'right' });

        // Footer
        doc.setTextColor(150, 150, 150);
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        doc.text('Generado autom√°ticamente por el sistema', 105, 285, { align: 'center' });
        doc.text(new Date().toLocaleString('es-AR'), 105, 290, { align: 'center' });

        console.log('‚úÖ [PDF] PDF generado exitosamente');
        return doc;

      } catch (error) {
        console.error('‚ùå [PDF] Error generando PDF:', error);
        throw error;
      }
    }

    // Subir PDF a Firebase Storage y obtener URL
    async function uploadOrderPDF(pdfDoc, orderNumber) {
      try {
        console.log('‚òÅÔ∏è [Storage] Subiendo PDF a Firebase Storage...');

        const { ref, uploadBytes, getDownloadURL } = window.firebase.storageHelpers;
        const storage = window.firebase.storage();

        // Convertir PDF a blob
        const pdfBlob = pdfDoc.output('blob');

        // Crear referencia en Storage
        const fileName = `orders/orden-${orderNumber}-${Date.now()}.pdf`;
        const storageRef = ref(storage, fileName);

        // Subir archivo
        const snapshot = await uploadBytes(storageRef, pdfBlob, {
          contentType: 'application/pdf'
        });

        console.log('‚úÖ [Storage] PDF subido exitosamente');

        // Obtener URL de descarga
        const downloadURL = await getDownloadURL(snapshot.ref);
        console.log('‚úÖ [Storage] URL de descarga obtenida:', downloadURL);

        return downloadURL;

      } catch (error) {
        console.error('‚ùå [Storage] Error subiendo PDF:', error);
        throw error;
      }
    }

    async function sendOrderToSellerWhatsApp(orderData, orderNumber, clienteNombre) {
      try {
        console.log('üì± [WhatsApp] Iniciando env√≠o...');
        console.log('üì± [WhatsApp] orderData.vendedorId:', orderData.vendedorId);
        console.log('üì± [WhatsApp] orderNumber:', orderNumber);
        console.log('üì± [WhatsApp] clienteNombre:', clienteNombre);

        const { doc, getDoc, collection, query, where, getDocs } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();

        let vendedorData = null;
        let vendedorId = orderData.vendedorId;

        // Si no hay vendedor asignado, buscar a Santiago como vendedor por defecto
        if (!vendedorId) {
          console.log('‚ö†Ô∏è [WhatsApp] No hay vendedor asignado, buscando a Santiago Fernandez...');
          const vendedoresRef = collection(db, 'vendedores');
          const q = query(vendedoresRef, where('email', '==', 'santifn.axp@gmail.com'));
          const querySnapshot = await getDocs(q);

          if (!querySnapshot.empty) {
            const santiagoDoc = querySnapshot.docs[0];
            vendedorId = santiagoDoc.id;
            vendedorData = santiagoDoc.data();
            console.log('‚úÖ [WhatsApp] Santiago Fernandez encontrado como vendedor por defecto:', vendedorId);
          } else {
            console.log('‚ùå [WhatsApp] No se encontr√≥ a Santiago Fernandez (santifn.axp@gmail.com) en la BD');
            return;
          }
        } else {
          console.log('üì± [WhatsApp] Buscando vendedor:', vendedorId);
          const vendedorRef = doc(db, 'vendedores', vendedorId);
          const vendedorDoc = await getDoc(vendedorRef);

          if (!vendedorDoc.exists()) {
            console.log('‚ö†Ô∏è [WhatsApp] Vendedor no encontrado en BD');
            return;
          }

          vendedorData = vendedorDoc.data();
        }

        console.log('üì± [WhatsApp] Vendedor encontrado:', vendedorData.name);
        console.log('üì± [WhatsApp] Tel√©fono principal:', vendedorData.phone || vendedorData.telefono);

        // Obtener solo el tel√©fono principal del vendedor
        let vendedorPhone = null;
        if (vendedorData.phone || vendedorData.telefono) {
          vendedorPhone = (vendedorData.phone || vendedorData.telefono).replace(/\D/g, '');
        }

        if (!vendedorPhone) {
          console.log('‚ö†Ô∏è [WhatsApp] Vendedor sin tel√©fono v√°lido');
          return;
        }

        console.log('üì± [WhatsApp] Tel√©fono del vendedor procesado:', vendedorPhone);

        // Generar PDF
        console.log('üìÑ [WhatsApp] Generando PDF de la orden...');
        const pdfDoc = await generateOrderPDF(orderData, orderNumber, clienteNombre);

        // Subir PDF a Firebase Storage
        console.log('‚òÅÔ∏è [WhatsApp] Subiendo PDF a Firebase Storage...');
        const pdfUrl = await uploadOrderPDF(pdfDoc, orderNumber);

        // Construir mensaje con enlace al PDF
        let mensaje = `üõí *NUEVA ORDEN #${orderNumber}*\n\n`;
        mensaje += `üìã *Ver detalle completo en PDF:*\n`;
        mensaje += `${pdfUrl}\n\n`;
        // Formato: Cliente NOMBRE, CODIGO XXX, EMAIL: usuario@email.com
        const clienteTexto = orderData.clienteCodigo ? `${clienteNombre}, CODIGO ${orderData.clienteCodigo}` : clienteNombre;
        const emailUsuario = orderData.creadoPorAdmin ? orderData.usuarioEmail : (orderData.clienteEmail || orderData.usuarioEmail);
        mensaje += `üë§ *Cliente:* ${clienteTexto}\n`;
        mensaje += `üìß *Email:* ${emailUsuario}\n`;
        if (orderData.creadoPorAdmin) {
          mensaje += `üë®‚Äçüíº *Creada por:* ${orderData.usuarioEmail} (Admin)\n`;
        }
        mensaje += `üìÖ *Fecha:* ${orderData.fechaLocal}\n\n`;
        mensaje += `üì¶ *Productos:* ${orderData.cantidadItems} items\n`;
        mensaje += `üí∞ *TOTAL: $${formatNumber(orderData.total)}*\n\n`;
        mensaje += `‚úÖ Descarg√° el PDF para ver el detalle completo`;

        // Enviar WhatsApp solo al vendedor
        const whatsappUrl = `https://wa.me/${vendedorPhone}?text=${encodeURIComponent(mensaje)}`;
        console.log('üì± [WhatsApp] URL generada:', whatsappUrl.substring(0, 100) + '...');

        // Abrir WhatsApp
        console.log('üì± [WhatsApp] Abriendo WhatsApp para vendedor:', vendedorPhone);
        window.open(whatsappUrl, '_blank');
        console.log('‚úÖ [WhatsApp] Proceso completado - WhatsApp enviado al vendedor');

      } catch (error) {
        console.error('‚ùå Error enviando WhatsApp:', error);
      }
    }
  </script>
  
  <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
  <script>
    // Initialize Material Design Components
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize all buttons
      const buttons = document.querySelectorAll('.mdc-button');
      buttons.forEach(button => mdc.ripple.MDCRipple.attachTo(button));
    });
  </script>
</body>
</html>
