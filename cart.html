<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>South Traders</title>
  
  <!-- Material Design CSS -->
  <link href="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { 
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; 
      color-scheme: dark;
      --mdc-theme-primary: #4CAF50;
      --mdc-theme-secondary: #2a2a33;
      --mdc-theme-surface: #1e1e24;
      --mdc-theme-background: #0f0f10;
      --mdc-theme-on-primary: #ffffff;
      --mdc-theme-on-secondary: #ffffff;
      --mdc-theme-on-surface: #f1f1f1;
      --mdc-theme-on-background: #f1f1f1;
    }
    
    /* Material Design custom overrides for better visibility */
    .mdc-tab {
      color: #d0d0d0 !important; /* Color m√°s claro para tabs no seleccionados */
      background-color: #1b1b1f !important;
      border-radius: 6px 6px 0 0 !important;
      border: 1px solid #2a2a2a !important;
      border-bottom: none !important;
      margin-right: 4px !important;
    }
    
    .mdc-tab--active {
      color: #ffffff !important; /* Color para tab seleccionado */
      background-color: #23232a !important;
      font-weight: 600 !important;
    }
    
    .mdc-tab:hover:not(.mdc-tab--active) {
      color: #e8e8e8 !important; /* Color en hover para mejor visibilidad */
      background-color: #2a2a2f !important;
    }
    
    .mdc-tab-indicator__content--underline {
      border-color: #4CAF50 !important;
      border-width: 3px !important;
    }
    
    /* Fix for all text elements that might appear black */
    .mdc-tab__text-label,
    .mdc-button__label,
    .mdc-floating-label,
    .mdc-text-field__input,
    .mdc-form-field > label,
    .mdc-checkbox ~ label,
    span, p, div, h1, h2, h3, h4, h5, h6 {
      color: inherit !important;
    }
    
    /* Specific overrides for Material components */
    .mdc-tab__text-label {
      color: inherit !important;
    }
    
    .mdc-button__label {
      color: inherit !important;
    }
    
    /* Text field improvements */
    .mdc-text-field--outlined {
      background-color: #1b1b1f !important;
      box-shadow: none !important; /* Eliminar cualquier sombra por defecto */
    }
    
    .mdc-text-field--outlined .mdc-notched-outline__leading,
    .mdc-text-field--outlined .mdc-notched-outline__notch,
    .mdc-text-field--outlined .mdc-notched-outline__trailing {
      border-color: #3a3a44 !important;
    }
    
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__leading,
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__notch,
    .mdc-text-field--outlined:not(.mdc-text-field--disabled):hover .mdc-notched-outline__trailing {
      border-color: #4CAF50 !important;
    }
    
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__leading,
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__notch,
    .mdc-text-field--outlined.mdc-text-field--focused .mdc-notched-outline__trailing {
      border-color: #4CAF50 !important;
      border-width: 2px !important;
    }
    
    .mdc-text-field__input {
      color: #f1f1f1 !important;
    }
    
    .mdc-floating-label {
      color: #d0d0d0 !important; /* Gris m√°s claro */
    }
    
    .mdc-text-field--focused .mdc-floating-label {
      color: #4CAF50 !important;
    }
    
    /* Button improvements */
    .mdc-button {
      color: #f1f1f1 !important;
    }
    
    .mdc-button--raised {
      background-color: #4CAF50 !important;
      color: #ffffff !important;
    }
    
    .mdc-button--outlined {
      border-color: #3a3a44 !important;
      color: #f1f1f1 !important;
    }
    
    .mdc-button--outlined:hover {
      background-color: #2a2a33 !important;
      border-color: #4CAF50 !important;
    }
    
    /* Checkbox improvements */
    .mdc-checkbox__native-control:enabled:checked ~ .mdc-checkbox__background {
      background-color: #4CAF50 !important;
      border-color: #4CAF50 !important;
    }
    
    .mdc-checkbox__background {
      border-color: #3a3a44 !important;
    }
    
    .mdc-form-field > label {
      color: #f1f1f1 !important;
    }
    
    /* General text color fixes */
    .status {
      color: #d0d0d0 !important;
    }
    
    /* Prevent any black text */
    * {
      color: inherit;
    }
    
    /* Ensure all Material Design components inherit proper colors */
    .mdc-tab *, 
    .mdc-button *, 
    .mdc-text-field *, 
    .mdc-checkbox *,
    .mdc-form-field * {
      color: inherit !important;
    }
    
    body { 
      margin: 0; 
      padding: 0; 
      background: #0f0f10; 
      color: #f1f1f1; 
      min-height: 100vh;
      width: 100%; 
      max-width: 100%; 
      overflow-x: hidden; 
      box-sizing: border-box;
    }
    header {
      padding: 16px;
      border-bottom: 1px solid #2a2a2a;
      background: #121214;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-logo { height: auto; max-width: 150px; width: 100%; object-fit: contain; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    h1 { 
      margin: 0; 
      font-size: 24px;
      color: #fafafa; 
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .cart-container { 
      background: #1e1e24; 
      padding: 30px; 
      border-radius: 8px; 
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #2a2a2a;
    }
    th {
      background: #23232a;
      color: #ffffff;
      font-weight: 600;
    }
    tr:hover {
      background-color: #2a2a33;
    }
    .btn {
      padding: 10px 20px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    .btn-primary:hover {
      background: #45a049;
    }
    .btn-secondary {
      background: #2a2a33;
      color: #f1f1f1;
      border: 1px solid #3a3a44;
    }
    .btn-secondary:hover {
      background: #34343c;
    }
    .text-right {
      text-align: right;
    }
    .empty-cart {
      text-align: center;
      padding: 40px 0;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }
    .total-row {
      font-weight: bold;
      font-size: 1.1em;
    }
    th.sortable {
      cursor: pointer;
      user-select: none;
    }
    th.sortable:hover {
      background-color: #2a2a33;
    }
    th.sortable::after {
      content: ' ‚Üï';
      opacity: 0.5;
      font-size: 12px;
    }
    th.sortable.asc::after {
      content: ' ‚Üë';
      opacity: 1;
    }
    th.sortable.desc::after {
      content: ' ‚Üì';
      opacity: 1;
    }
    .quantity-input {
      width: 60px;
      padding: 5px;
      text-align: center;
      background: #2a2a33;
      color: #f1f1f1;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      font-size: 14px;
    }
    .quantity-input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    /* Modal de √©xito */
    .success-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      animation: fadeIn 0.3s;
    }
    .success-modal-content {
      background-color: #1e1e24;
      margin: 10% auto;
      padding: 40px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      animation: slideDown 0.3s;
      border: 2px solid #4CAF50;
    }
    .success-icon {
      font-size: 80px;
      color: #4CAF50;
      margin-bottom: 20px;
    }
    .success-title {
      font-size: 28px;
      color: #4CAF50;
      margin-bottom: 15px;
      font-weight: 600;
    }
    .success-message {
      font-size: 16px;
      color: #d0d0d0;
      margin-bottom: 10px;
      line-height: 1.6;
    }
    .order-number {
      font-size: 24px;
      color: #4CAF50;
      font-weight: 700;
      margin: 20px 0;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideDown {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Client selector for admin */
    .client-selector-container {
      margin-top: 20px;
      padding: 20px;
      background: #15151a;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
    }
    .client-selector-label {
      display: block;
      margin-bottom: 10px;
      color: #4CAF50;
      font-weight: 600;
      font-size: 14px;
    }
    .client-selector {
      width: 100%;
      padding: 10px;
      background: #2a2a33;
      color: #f1f1f1;
      border: 1px solid #3a3a44;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    .client-selector:focus {
      outline: none;
      border-color: #4CAF50;
    }
    .client-selector option {
      background: #2a2a33;
      color: #f1f1f1;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <img src="logo.png" alt="Logo" class="header-logo">
      <h1>Carrito de Compras</h1>
    </div>
    <a href="marketplace.html" class="mdc-button mdc-button--outlined" style="text-decoration: none;">
      <span class="mdc-button__ripple"></span>
      <i class="material-icons mdc-button__icon" aria-hidden="true">arrow_back</i>
      <span class="mdc-button__label">Volver al Cat√°logo</span>
    </a>
  </header>
  
  <div class="container">
    <div class="cart-container">
      <div id="cartSummary">
        <div class="empty-cart">
          <p>Tu carrito est√° vac√≠o</p>
          <a href="marketplace.html" class="btn btn-primary" style="margin-top: 15px;">
            Seguir Comprando
          </a>
        </div>
      </div>

      <!-- Contenedor para selector de clientes (solo admin) -->
      <div id="clientSelectorContainer" class="client-selector-container" style="display: none;"></div>
    </div>
  </div>

  <!-- Modal de √©xito -->
  <div id="successModal" class="success-modal">
    <div class="success-modal-content">
      <div class="success-icon">‚úì</div>
      <h2 class="success-title">¬°Orden Confirmada!</h2>
      <p class="success-message">Tu orden ha sido enviada exitosamente</p>
      <div class="order-number" id="orderNumberDisplay"></div>
      <p class="success-message">Se ha notificado a tu vendedor por WhatsApp</p>
      <button class="mdc-button mdc-button--raised" onclick="window.location.href='marketplace.html'" style="margin-top: 20px;">
        <span class="mdc-button__ripple"></span>
        <span class="mdc-button__label">Volver al Cat√°logo</span>
      </button>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, query, orderBy, getDocs, where, limit, runTransaction } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCXjSGtVGfQas_cEyjmI0RTaeEl94jdp6g",
      authDomain: "carrito-138c3.firebaseapp.com",
      projectId: "carrito-138c3",
      storageBucket: "carrito-138c3.appspot.com",
      messagingSenderId: "579670725719",
      appId: "1:579670725719:web:carrito138c3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Hacer Firebase accesible globalmente
    window.firebase = {
      app: () => app,
      auth: () => auth,
      firestore: () => db,
      firestoreHelpers: {
        doc, getDoc, setDoc, addDoc, updateDoc, collection, query, orderBy, getDocs, where, limit, runTransaction
      }
    };

    // Verificar autenticaci√≥n y permisos admin
    let authCheckTimeout;
    window.isUserAdmin = false;

    onAuthStateChanged(auth, async (user) => {
      // Limpiar timeout previo
      if (authCheckTimeout) {
        clearTimeout(authCheckTimeout);
      }

      window.currentUser = user;
      if (user) {
        console.log('‚úÖ Usuario autenticado:', user.email);

        // Verificar si es admin
        try {
          const userRef = doc(db, 'usuarios', user.uid);
          const userDoc = await getDoc(userRef);

          if (userDoc.exists()) {
            const userData = userDoc.data();
            window.isUserAdmin = userData.admin === true;
            console.log('üîê Usuario es admin:', window.isUserAdmin);

            // Si es admin, cargar dropdown de clientes
            if (window.isUserAdmin) {
              await loadClientesDropdown();
            }
          }
        } catch (error) {
          console.error('‚ùå Error verificando permisos:', error);
          window.isUserAdmin = false;
        }
      } else {
        // Dar 3 segundos para que Firebase cargue la sesi√≥n
        authCheckTimeout = setTimeout(() => {
          if (!window.currentUser) {
            console.log('‚ö†Ô∏è Usuario no autenticado despu√©s de esperar, redirigiendo a login...');
            alert('Debes iniciar sesi√≥n para acceder al carrito');
            window.location.href = 'login.html';
          }
        }, 3000);
      }
    });
  </script>

  <script>
    // Variable global para almacenar cliente seleccionado
    window.selectedClienteData = null;

    // Cargar dropdown de clientes para admin
    async function loadClientesDropdown() {
      try {
        console.log('üìã Cargando clientes para dropdown admin...');

        const { collection, getDocs } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();

        const clientesRef = collection(db, 'clientes');
        const clientesSnapshot = await getDocs(clientesRef);

        const clientes = [];
        clientesSnapshot.forEach(doc => {
          const data = doc.data();

          // Prioridad: nombreComercial > nombre > name > email
          let displayName = data.nombreComercial || data.nombre || data.name || data.email || 'Sin nombre';

          // Si tiene nombreComercial y nombre, mostrar ambos
          if (data.nombreComercial && data.nombre && data.nombreComercial !== data.nombre) {
            displayName = `${data.nombreComercial} - ${data.nombre}`;
          }

          clientes.push({
            id: doc.id,
            nombre: displayName,
            codigo: data.codigo || '',
            email: data.email || '',
            vendedorId: data.vendedorId || data.vendedor || null
          });
        });

        // Ordenar por c√≥digo num√©rico
        clientes.sort((a, b) => {
          const codigoA = parseInt(a.codigo) || 0;
          const codigoB = parseInt(b.codigo) || 0;
          return codigoA - codigoB;
        });

        console.log(`‚úÖ ${clientes.length} clientes cargados`);

        // Buscar el contenedor del dropdown
        const dropdownContainer = document.getElementById('clientSelectorContainer');
        if (!dropdownContainer) {
          console.warn('‚ö†Ô∏è Container para dropdown de clientes no encontrado');
          return;
        }

        // Crear el HTML del dropdown
        let html = `
          <label class="client-selector-label">
            üë• Seleccionar Cliente (Admin):
          </label>
          <select id="clientSelector" class="client-selector">
            <option value="">-- Usar mi usuario (${window.currentUser.email}) --</option>
        `;

        clientes.forEach(cliente => {
          // Mostrar: [Codigo] Nombre (email) si tiene c√≥digo, sino solo Nombre (email)
          const displayText = cliente.codigo
            ? `[${cliente.codigo}] ${cliente.nombre}${cliente.email ? ' (' + cliente.email + ')' : ''}`
            : `${cliente.nombre}${cliente.email ? ' (' + cliente.email + ')' : ''}`;

          html += `<option value="${cliente.id}" data-email="${cliente.email}" data-vendedor="${cliente.vendedorId || ''}">${displayText}</option>`;
        });

        html += `</select>`;

        dropdownContainer.innerHTML = html;
        dropdownContainer.style.display = 'block';

        // Agregar event listener al selector
        const selector = document.getElementById('clientSelector');
        if (selector) {
          selector.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (this.value) {
              window.selectedClienteData = {
                id: this.value,
                email: selectedOption.getAttribute('data-email'),
                nombre: selectedOption.textContent.split(' (')[0],
                vendedorId: selectedOption.getAttribute('data-vendedor') || null
              };
              console.log('üë§ Cliente seleccionado:', window.selectedClienteData);
            } else {
              window.selectedClienteData = null;
              console.log('üë§ Usando usuario actual');
            }
          });
        }

        console.log('‚úÖ Dropdown de clientes creado');

      } catch (error) {
        console.error('‚ùå Error cargando clientes:', error);
      }
    }

    // Esperar a que Firebase est√© listo
    function initCart() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const container = document.getElementById('cartSummary');
      const editingOrderId = localStorage.getItem('editingOrderId');

      if (!container) return;

      if (cart.length === 0) {
        // Limpiar editingOrderId si el carrito est√° vac√≠o
        localStorage.removeItem('editingOrderId');

        // Mostrar mensaje de carrito vac√≠o
        container.innerHTML = `
          <div class="empty-cart">
            <p>Tu carrito est√° vac√≠o</p>
            <a href="marketplace.html" class="mdc-button mdc-button--raised" style="margin-top: 15px; text-decoration: none;">
              <span class="mdc-button__ripple"></span>
              <i class="material-icons mdc-button__icon" aria-hidden="true">shopping_cart</i>
              <span class="mdc-button__label">Seguir Comprando</span>
            </a>
          </div>
        `;
        return;
      }

      let total = 0;
      let totalItems = 0;

      // Mostrar indicador si se est√° editando una orden
      let editingIndicator = '';
      if (editingOrderId) {
        editingIndicator = `
          <div style="background: #2a2a33; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #FFC107;">
            <span style="color: #FFC107; font-weight: 600;">‚úèÔ∏è Editando Orden</span>
            <p style="margin: 5px 0 0 0; color: #b5b5b5; font-size: 14px;">
              Est√°s modificando una orden existente. Al confirmar se actualizar√° la orden original.
            </p>
          </div>
        `;
      }

      let html = editingIndicator + `
        <table id="cartTable">
          <thead>
            <tr>
              <th class="sortable" data-sort="item">Item</th>
              <th class="sortable" data-sort="description">Descripci√≥n</th>
              <th class="sortable text-right" data-sort="price">Precio Unit.</th>
              <th class="sortable text-right" data-sort="quantity">Cantidad</th>
              <th class="sortable text-right" data-sort="total">Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
      `;

      cart.forEach((item, index) => {
        const rowTotal = item.price * item.quantity;
        total += rowTotal;
        totalItems += item.quantity;

        html += `
          <tr data-item-id="${item.item}">
            <td>${item.item}</td>
            <td>${item.description}</td>
            <td class="text-right">$${item.price.toFixed(2)}</td>
            <td class="text-right">
              <input type="number"
                     class="quantity-input"
                     data-index="${index}"
                     value="${item.quantity}"
                     min="1"
                     max="9999">
            </td>
            <td class="text-right" id="row-total-${index}">$${rowTotal.toFixed(2)}</td>
            <td class="text-right">
              <button class="mdc-button mdc-button--outlined remove-item" data-index="${index}" style="padding: 5px 10px; font-size: 12px;">
                <span class="mdc-button__ripple"></span>
                <i class="material-icons mdc-button__icon" aria-hidden="true">delete</i>
                <span class="mdc-button__label">Eliminar</span>
              </button>
            </td>
          </tr>
        `;
      });

      html += `
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-right"><strong>Total Items:</strong></td>
              <td class="text-right"><strong>${totalItems}</strong></td>
              <td colspan="2"></td>
            </tr>
            <tr class="total-row">
              <td colspan="4" class="text-right"><strong>Total:</strong></td>
              <td class="text-right"><strong>$${total.toFixed(2)}</strong></td>
              <td></td>
            </tr>
          </tfoot>
        </table>

        <div class="actions">
          <a href="marketplace.html" class="mdc-button mdc-button--outlined" style="text-decoration: none;">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">arrow_back</i>
            <span class="mdc-button__label">Seguir Comprando</span>
          </a>
          <button id="checkoutBtn" class="mdc-button mdc-button--raised">
            <span class="mdc-button__ripple"></span>
            <span class="mdc-button__label">${editingOrderId ? 'ACTUALIZAR ORDEN' : 'CONFIRMAR ORDEN'}</span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">${editingOrderId ? 'update' : 'check_circle'}</i>
          </button>
        </div>
      `;
      
      container.innerHTML = html;
      
      // Agregar manejadores de eventos para los botones de eliminar
      document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          removeItemFromCart(index);
        });
      });

      // Agregar manejadores para los inputs de cantidad
      document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', function() {
          const index = parseInt(this.getAttribute('data-index'));
          const newQuantity = parseInt(this.value);
          updateItemQuantity(index, newQuantity);
        });
      });

      // Manejador para el bot√≥n de confirmar orden
      const checkoutBtn = document.getElementById('checkoutBtn');
      if (checkoutBtn) {
        checkoutBtn.addEventListener('click', async function() {
          await confirmOrder();
        });
      }
    }

    // Sorting state
    let currentSort = {
      column: null,
      direction: 'asc'
    };

    // Handle column sorting
    function handleSortClick(e) {
      const th = e.target.closest('th.sortable');
      if (!th) return;

      const column = th.getAttribute('data-sort');
      if (currentSort.column === column) {
        // Toggle direction if same column clicked
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        // Set new column and default to ascending
        currentSort.column = column;
        currentSort.direction = 'asc';
      }

      // Update visual indicators
      document.querySelectorAll('th.sortable').forEach(header => {
        header.classList.remove('asc', 'desc');
      });
      th.classList.add(currentSort.direction);

      // Sort and re-render
      sortAndRenderCart();
    }

    function sortAndRenderCart() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');

      if (cart.length === 0 || !currentSort.column) {
        initCart();
        return;
      }

      // Sort the cart array
      cart.sort((a, b) => {
        let aVal, bVal;

        switch(currentSort.column) {
          case 'item':
            aVal = a.item || '';
            bVal = b.item || '';
            break;
          case 'description':
            aVal = a.description || '';
            bVal = b.description || '';
            break;
          case 'price':
            aVal = a.price || 0;
            bVal = b.price || 0;
            break;
          case 'quantity':
            aVal = a.quantity || 0;
            bVal = b.quantity || 0;
            break;
          case 'total':
            aVal = (a.price || 0) * (a.quantity || 0);
            bVal = (b.price || 0) * (b.quantity || 0);
            break;
          default:
            return 0;
        }

        const dir = currentSort.direction === 'asc' ? 1 : -1;

        if (typeof aVal === 'string') {
          return aVal.localeCompare(bVal) * dir;
        }
        return (aVal - bVal) * dir;
      });

      // Save sorted cart back to localStorage
      localStorage.setItem('cart', JSON.stringify(cart));

      // Re-render
      initCart();

      // Re-attach sort event listeners after render
      attachSortListeners();
    }

    function attachSortListeners() {
      const sortableHeaders = document.querySelectorAll('th.sortable');
      sortableHeaders.forEach(th => {
        th.addEventListener('click', handleSortClick);
      });

      // Restore visual indicators
      if (currentSort.column) {
        const activeHeader = document.querySelector(`th.sortable[data-sort="${currentSort.column}"]`);
        if (activeHeader) {
          activeHeader.classList.add(currentSort.direction);
        }
      }
    }

    // Inicializar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', () => {
      initCart();
      attachSortListeners();
    });

    function removeItemFromCart(index) {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      if (index >= 0 && index < cart.length) {
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        // Recargar la p√°gina para actualizar la vista
        window.location.reload();
      }
    }

    function updateItemQuantity(index, newQuantity) {
      if (newQuantity < 1) newQuantity = 1;
      if (newQuantity > 9999) newQuantity = 9999;

      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      if (index >= 0 && index < cart.length) {
        cart[index].quantity = newQuantity;
        localStorage.setItem('cart', JSON.stringify(cart));
        // Recargar la p√°gina para actualizar los totales
        window.location.reload();
      }
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('es-AR', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2
      }).format(num);
    }

    async function getNextOrderNumber() {
      try {
        const { doc, runTransaction, collection, query, orderBy, limit, getDocs } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();

        // Usar un documento contador para generar n√∫meros secuenciales √∫nicos
        const counterRef = doc(db, 'counters', 'orderNumber');

        const newOrderNumber = await runTransaction(db, async (transaction) => {
          const counterDoc = await transaction.get(counterRef);

          let nextNumber;
          if (!counterDoc.exists()) {
            // Primera vez: buscar el √∫ltimo n√∫mero en la BD
            console.log('üîÑ Inicializando contador de √≥rdenes...');
            const pedidosRef = collection(db, 'pedidos');
            const q = query(pedidosRef, orderBy('numeroOrden', 'desc'), limit(1));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
              nextNumber = 10000;
            } else {
              const lastOrder = querySnapshot.docs[0].data();
              nextNumber = (lastOrder.numeroOrden || 10000) + 1;
            }

            // Crear el contador
            transaction.set(counterRef, { value: nextNumber });
          } else {
            // Incrementar el contador existente
            const currentValue = counterDoc.data().value || 10000;
            nextNumber = currentValue + 1;
            transaction.update(counterRef, { value: nextNumber });
          }

          return nextNumber;
        });

        console.log('‚úÖ Nuevo n√∫mero de orden generado:', newOrderNumber);
        return newOrderNumber;

      } catch (error) {
        console.error('‚ùå Error obteniendo siguiente n√∫mero de orden:', error);

        // Fallback: intentar obtener de la BD directamente (sin transacci√≥n)
        try {
          const { collection, query, orderBy, limit, getDocs } = window.firebase.firestoreHelpers;
          const db = window.firebase.firestore();

          const pedidosRef = collection(db, 'pedidos');
          const q = query(pedidosRef, orderBy('numeroOrden', 'desc'), limit(1));
          const querySnapshot = await getDocs(q);

          if (querySnapshot.empty) {
            return 10000;
          } else {
            const lastOrder = querySnapshot.docs[0].data();
            return (lastOrder.numeroOrden || 10000) + 1;
          }
        } catch (fallbackError) {
          console.error('‚ùå Error en fallback:', fallbackError);
          // √öltimo recurso: usar timestamp para minimizar colisiones
          return 10000 + (Date.now() % 90000);
        }
      }
    }

    async function confirmOrder() {
      try {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        if (cart.length === 0) {
          alert('El carrito est√° vac√≠o');
          return;
        }

        // Esperar un momento para que Firebase termine de inicializar
        let attempts = 0;
        while (!window.currentUser && attempts < 20) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }

        if (!window.currentUser) {
          alert('Debes iniciar sesi√≥n para confirmar la orden');
          window.location.href = 'login.html';
          return;
        }

        const editingOrderId = localStorage.getItem('editingOrderId');
        const isEditing = !!editingOrderId;

        console.log(isEditing ? 'üìù Actualizando orden existente...' : 'üì¶ Confirmando orden nueva...');

        // Obtener n√∫mero de orden (solo si es nueva, si se est√° editando usar el existente)
        let orderNumber;
        let existingOrderData = null;

        if (isEditing) {
          // Obtener datos de la orden existente
          const { doc, getDoc } = window.firebase.firestoreHelpers;
          const db = window.firebase.firestore();
          const orderRef = doc(db, 'pedidos', editingOrderId);
          const orderDoc = await getDoc(orderRef);

          if (orderDoc.exists()) {
            existingOrderData = orderDoc.data();
            orderNumber = existingOrderData.numeroOrden;
            console.log('üìã Actualizando orden existente #', orderNumber);
          } else {
            alert('No se encontr√≥ la orden a editar');
            return;
          }
        } else {
          orderNumber = await getNextOrderNumber();
          console.log('üìã N√∫mero de orden nueva:', orderNumber);
        }

        // Buscar datos del cliente
        const { collection, query, where, limit, getDocs, doc, getDoc, addDoc, updateDoc } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();

        let clienteNombre = window.currentUser.email;
        let clienteEmail = window.currentUser.email;
        let vendedorId = null;

        // Si estamos editando, usar los datos de la orden existente primero
        if (isEditing && existingOrderData) {
          clienteNombre = existingOrderData.clienteNombre || window.currentUser.email;
          clienteEmail = existingOrderData.clienteEmail || window.currentUser.email;
          vendedorId = existingOrderData.vendedorId;
          console.log('üìã Usando datos de orden existente - Vendedor:', vendedorId);
        }
        // Si es admin y seleccion√≥ un cliente, usar ese cliente
        else if (window.isUserAdmin && window.selectedClienteData) {
          console.log('üë§ Admin cargando orden para cliente:', window.selectedClienteData.nombre);
          clienteNombre = window.selectedClienteData.nombre;
          clienteEmail = window.selectedClienteData.email;
          vendedorId = window.selectedClienteData.vendedorId;
        } else {
          // Usuario normal o admin sin cliente seleccionado: usar su propio email
          const clientesRef = collection(db, 'clientes');
          const clientesQuery = query(clientesRef, where('email', '==', window.currentUser.email), limit(1));
          const clientesSnapshot = await getDocs(clientesQuery);

          if (!clientesSnapshot.empty) {
            const clienteData = clientesSnapshot.docs[0].data();
            clienteNombre = clienteData.nombre || clienteData.name || window.currentUser.email;
            vendedorId = clienteData.vendedorId || clienteData.vendedor;
          }
        }

        // Preparar datos de la orden
        const now = new Date();
        const fechaLocal = now.toLocaleDateString('es-AR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        let total = 0;
        let cantidadItems = 0;
        const items = cart.map(item => {
          const subtotal = item.price * item.quantity;
          total += subtotal;
          cantidadItems += item.quantity;
          return {
            articulo: item.item,
            description: item.description,
            quantity: item.quantity,
            price: item.price,
            subtotal: subtotal
          };
        });

        const orderToSave = {
          numeroOrden: orderNumber,
          usuarioEmail: window.currentUser.email, // Email del usuario que cre√≥ la orden
          usuarioUid: window.currentUser.uid,
          clienteEmail: clienteEmail, // Email del cliente (puede ser diferente si admin carga para otro)
          clienteNombre: clienteNombre,
          vendedorId: vendedorId,
          items: items,
          total: total,
          cantidadItems: cantidadItems,
          fecha: now,
          timestamp: now, // Para ordenar en marketplace.html
          fechaLocal: fechaLocal,
          logisticsState: isEditing ? (existingOrderData.logisticsState || 'borrador') : 'borrador',
          estado: isEditing ? (existingOrderData.estado || 'pendiente') : 'pendiente',
          creadoPorAdmin: window.isUserAdmin && window.selectedClienteData ? true : false
        };

        // Solo agregar campos de modificaci√≥n si estamos editando
        if (isEditing) {
          orderToSave.ultimaModificacion = now;
          orderToSave.fechaUltimaModificacion = fechaLocal;
        }

        // Guardar o actualizar en Firebase
        if (isEditing) {
          // Actualizar orden existente
          const orderRef = doc(db, 'pedidos', editingOrderId);
          await updateDoc(orderRef, orderToSave);
          console.log('‚úÖ Orden actualizada en Firebase');
        } else {
          // Crear nueva orden
          const pedidosRef = collection(db, 'pedidos');
          await addDoc(pedidosRef, orderToSave);
          console.log('‚úÖ Orden guardada en Firebase');
        }

        // Enviar WhatsApp al vendedor
        if (vendedorId) {
          console.log('üì± Preparando WhatsApp para vendedor:', vendedorId);
          await sendOrderToSellerWhatsApp(orderToSave, orderNumber, clienteNombre);
        } else {
          console.log('‚ö†Ô∏è No se envi√≥ WhatsApp - No hay vendedor asignado');
        }

        // Mostrar modal de √©xito
        document.getElementById('orderNumberDisplay').textContent = `Orden #${orderNumber}`;

        // Cambiar mensaje seg√∫n si es nueva o actualizaci√≥n
        const successMessage = document.querySelector('.success-title');
        if (isEditing) {
          successMessage.textContent = '¬°Orden Actualizada!';
        } else {
          successMessage.textContent = '¬°Orden Confirmada!';
        }

        document.getElementById('successModal').style.display = 'block';

        // Limpiar carrito y editingOrderId
        localStorage.removeItem('cart');
        localStorage.removeItem('editingOrderId');

      } catch (error) {
        console.error('‚ùå Error confirmando orden:', error);
        alert('Hubo un error al confirmar la orden. Por favor intenta de nuevo.');
      }
    }

    async function sendOrderToSellerWhatsApp(orderData, orderNumber, clienteNombre) {
      try {
        console.log('üì± Enviando WhatsApp al vendedor...');

        if (!orderData.vendedorId) {
          console.log('‚ö†Ô∏è No hay vendedor asignado');
          return;
        }

        const { doc, getDoc } = window.firebase.firestoreHelpers;
        const db = window.firebase.firestore();

        const vendedorRef = doc(db, 'vendedores', orderData.vendedorId);
        const vendedorDoc = await getDoc(vendedorRef);

        if (!vendedorDoc.exists()) {
          console.log('‚ö†Ô∏è Vendedor no encontrado');
          return;
        }

        const vendedorData = vendedorDoc.data();

        // Obtener ambos tel√©fonos del vendedor
        const phones = [];
        if (vendedorData.phone || vendedorData.telefono) {
          phones.push((vendedorData.phone || vendedorData.telefono).replace(/\D/g, ''));
        }
        if (vendedorData.phone2) {
          phones.push(vendedorData.phone2.replace(/\D/g, ''));
        }

        if (phones.length === 0) {
          console.log('‚ö†Ô∏è Vendedor sin tel√©fono');
          return;
        }

        // Construir mensaje
        let mensaje = `üõí *NUEVA ORDEN #${orderNumber}*\n\n`;
        mensaje += `üë§ *Cliente:* ${clienteNombre}\n`;
        mensaje += `üìß *Email:* ${orderData.clienteEmail || orderData.usuarioEmail}\n`;
        if (orderData.creadoPorAdmin) {
          mensaje += `üë®‚Äçüíº *Creada por:* ${orderData.usuarioEmail} (Admin)\n`;
        }
        mensaje += `üìÖ *Fecha:* ${orderData.fechaLocal}\n\n`;
        mensaje += `üì¶ *Productos (${orderData.cantidadItems}):*\n`;

        orderData.items.forEach((item, index) => {
          mensaje += `${index + 1}. ${item.description || item.articulo}\n`;
          mensaje += `   Cantidad: ${item.quantity} x ${formatNumber(item.price)}\n`;
        });

        mensaje += `\nüí∞ *TOTAL: ${formatNumber(orderData.total)}*\n\n`;

        // Enviar WhatsApp a todos los tel√©fonos del vendedor
        phones.forEach((phone, index) => {
          const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(mensaje)}`;

          // Peque√±o delay entre aperturas para evitar que se bloqueen
          setTimeout(() => {
            window.open(whatsappUrl, '_blank');
            console.log(`‚úÖ WhatsApp ${index + 1}/${phones.length} enviado a ${phone}`);
          }, index * 500);
        });

        console.log(`‚úÖ WhatsApp enviado a ${phones.length} tel√©fono(s)`);

      } catch (error) {
        console.error('‚ùå Error enviando WhatsApp:', error);
      }
    }
  </script>
  
  <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
  <script>
    // Initialize Material Design Components
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize all buttons
      const buttons = document.querySelectorAll('.mdc-button');
      buttons.forEach(button => mdc.ripple.MDCRipple.attachTo(button));
    });
  </script>
</body>
</html>
